import React, { useState, useCallback, useEffect, useMemo, useRef } from 'react';
import { createClient } from '@supabase/supabase-js';
import { Upload, DollarSign, TrendingUp, TrendingDown, Package, ShoppingCart, BarChart3, Download, Calendar, ChevronLeft, ChevronRight, ChevronDown, Trash2, FileSpreadsheet, Check, Database, AlertTriangle, AlertCircle, CheckCircle, Clock, Boxes, RefreshCw, Layers, CalendarRange, Settings, ArrowUpRight, ArrowDownRight, Minus, GitCompare, Trophy, Target, PieChart, Zap, Star, Eye, ShoppingBag, Award, Flame, Snowflake, Truck, FileText, MessageSquare, Send, X, Move, EyeOff, Bell, BellOff, Calculator, StickyNote, Sun, Moon, Palette, FileDown, GitCompareArrows, Smartphone, Cloud, Plus, Store, Loader2, HelpCircle, Brain, Landmark, Wallet, CreditCard, Building, ArrowUp, ArrowDown, User } from 'lucide-react';

// Dynamically load SheetJS from CDN (avoids npm vulnerability)
let XLSX = null;
const loadXLSX = async () => {
  if (XLSX) return XLSX;
  if (window.XLSX) { XLSX = window.XLSX; return XLSX; }
  
  const loadScript = (src, integrity = null) => new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.crossOrigin = 'anonymous';
    if (integrity) script.integrity = integrity;
    script.onload = () => { XLSX = window.XLSX; resolve(XLSX); };
    script.onerror = reject;
    document.head.appendChild(script);
  });
  
  // Try primary CDN first, fallback to secondary
  try {
    return await loadScript(
      'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js'
    );
  } catch {
    // Fallback to cdnjs if primary fails
    return await loadScript(
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
      'sha512-5qGFH9V9GqAH7BTKxqDBFQQj7DrHLRddBHPpHEHMDvO7L7NxBPjL7Wd7Mt981LVs9F/VGBI4RlnGJbxPzRIGlA=='
    );
  }
};

const parseCSV = (text) => {
  // Normalize line endings (CRLF â†’ LF) and remove BOM
  const normalized = text.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const lines = normalized.split('\n').filter(line => line.trim());
  if (lines.length === 0) return [];
  const headers = parseCSVLine(lines[0]);
  return lines.slice(1).map(line => {
    const values = parseCSVLine(line);
    const obj = {};
    headers.forEach((header, i) => { obj[header.trim()] = values[i]?.trim() || ''; });
    return obj;
  });
};

const parseCSVLine = (line) => {
  const result = []; 
  let current = '', inQuotes = false, i = 0;
  while (i < line.length) {
    const char = line[i];
    if (inQuotes) {
      if (char === '"') {
        // Check for escaped quote ("")
        if (line[i + 1] === '"') {
          current += '"';
          i += 2;
          continue;
        } else {
          inQuotes = false;
        }
      } else {
        current += char;
      }
    } else {
      if (char === '"') {
        inQuotes = true;
      } else if (char === ',') {
        result.push(current);
        current = '';
      } else {
        current += char;
      }
    }
    i++;
  }
  result.push(current);
  return result;
};

// Parse QBO Transaction Detail CSV
const parseQBOTransactions = (content, categoryOverrides = {}) => {
  const lines = content.split(/\r?\n/).filter(l => l.trim());
  const transactions = [];
  const accounts = {};
  const categories = {};
  let currentAccount = null;
  let currentAccountType = 'checking';
  
  // First pass: Find account totals from "Total for [Account]" lines
  const accountTotals = {};
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.startsWith('Total for ')) {
      const cols = parseCSVLine(line);
      const match = cols[0].match(/Total for (.+)/);
      if (match) {
        const accountName = match[1].trim();
        // Parse the total amount (usually in column 8 or 9)
        let totalStr = (cols[9] || cols[8] || cols[7] || '').replace(/[$,"\s]/g, '');
        const total = parseFloat(totalStr) || 0;
        accountTotals[accountName] = total;
      }
    }
  }
  
  // Skip header rows
  let dataStartIndex = 0;
  for (let i = 0; i < Math.min(10, lines.length); i++) {
    if (lines[i].includes('Transaction date') || lines[i].includes('transaction date')) {
      dataStartIndex = i + 1;
      break;
    }
  }
  
  // Bank account patterns - must have account number pattern like (5983), (1003), (1009)
  const isBankAccount = (name) => {
    // Must have account number in parentheses pattern at end
    const hasAccountNumber = /\(\d{4}\)\s*-\s*\d+$/.test(name);
    if (!hasAccountNumber) return false;
    
    // Must NOT contain quotes (sign of corrupted multi-line CSV parsing)
    if (name.includes('"')) return false;
    
    // Must be reasonably short (account names are typically < 50 chars)
    if (name.length > 60) return false;
    
    // Must start with a letter (not a continuation of a memo)
    if (!/^[A-Za-z]/.test(name.trim())) return false;
    
    const lower = name.toLowerCase();
    return (
      lower.includes('checking') ||
      lower.includes('savings') ||
      lower.includes('operations') ||
      lower.includes('card') ||
      lower.includes('credit') ||
      lower.includes('amex') ||
      lower.includes('visa') ||
      lower.includes('mastercard') ||
      lower.includes('platinum') ||
      lower.includes('(5983)') ||
      lower.includes('(1003)') ||
      lower.includes('(1009)')
    );
  };
  
  // Non-cash/asset patterns to skip
  const isNonCashAccount = (name) => {
    const lower = name.toLowerCase();
    return (
      lower.includes('depreciation') ||
      lower.includes('accumulated') ||
      lower.includes('asset') ||
      lower.includes('vehicle') ||
      lower.includes('equipment') ||
      lower.includes('tundra') ||
      lower.includes('furniture') ||
      lower.includes('inventory asset')
    );
  };
  
  for (let i = dataStartIndex; i < lines.length; i++) {
    const line = lines[i];
    if (!line.trim()) continue;
    
    const cols = parseCSVLine(line);
    
    // Check for account section headers
    if (cols[0] && cols[0].trim() && !cols[1]?.trim() && !cols[0].startsWith('Total for') && !cols[0].includes(',TOTAL')) {
      const potentialAccount = cols[0].trim();
      
      // Skip non-bank accounts
      if (isNonCashAccount(potentialAccount)) {
        currentAccount = null;
        continue;
      }
      
      // Only track real bank accounts
      if (isBankAccount(potentialAccount)) {
        currentAccount = potentialAccount;
        const lowerName = potentialAccount.toLowerCase();
        currentAccountType = (lowerName.includes('card') || 
                             lowerName.includes('credit') ||
                             lowerName.includes('amex') ||
                             lowerName.includes('platinum') ||
                             lowerName.includes('1003') ||
                             lowerName.includes('1009')) ? 'credit_card' : 'checking';
        
        if (!accounts[currentAccount]) {
          // Get balance from totals we found earlier
          const balance = accountTotals[currentAccount] || 0;
          accounts[currentAccount] = { 
            name: currentAccount, 
            type: currentAccountType, 
            transactions: 0, 
            totalIn: 0, 
            totalOut: 0,
            balance: balance
          };
        }
      } else {
        currentAccount = null;
      }
      continue;
    }
    
    // Skip if we're not in a valid bank account
    if (!currentAccount) continue;
    
    // Skip total rows and metadata rows
    if (cols[0]?.startsWith('Total for') || cols[0]?.includes(',TOTAL') || cols[0]?.includes('Cash Basis')) continue;
    
    // Parse transaction row
    const dateStr = cols[1]?.trim();
    if (!dateStr || !dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) continue;
    
    const txnType = cols[2]?.trim() || '';
    const vendorName = cols[4]?.trim() || '';
    const memo = cols[6]?.trim() || '';
    const category = cols[7]?.trim() || 'Uncategorized';
    
    let amountStr = cols[8]?.trim().replace(/,/g, '').replace(/"/g, '') || '0';
    const amount = parseFloat(amountStr) || 0;
    
    // Parse date
    const dateParts = dateStr.split('/');
    const dateKey = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;
    
    const txnId = `${dateKey}-${currentAccount?.slice(0,10)}-${amount}-${memo.slice(0,15)}`.replace(/[^a-zA-Z0-9-]/g, '');
    
    // Skip transfers and non-cash items
    if (txnType === 'Credit Card Payment') continue;
    if (txnType === 'Journal Entry') continue;
    
    const categoryLower = category.toLowerCase();
    const memoLower = memo.toLowerCase();
    if (categoryLower.includes('depreciation') || categoryLower.includes('amortization') ||
        categoryLower.includes('accumulated') || categoryLower.includes('unrealized') ||
        memoLower.includes('depreciation') || memoLower.includes('amortization')) {
      continue;
    }
    
    // Determine income vs expense
    let isIncome = false;
    let isExpense = false;
    
    if (currentAccountType === 'credit_card') {
      if (txnType === 'Expense' && amount > 0) isExpense = true;
    } else {
      if (txnType === 'Deposit' && amount > 0) isIncome = true;
      else if ((txnType === 'Expense' || txnType === 'Check') && amount < 0) isExpense = true;
      else if (txnType === 'Transfer' && amount > 0) isIncome = true;
      else if (txnType === 'Payroll Check') isExpense = true;
    }
    
    if (!isIncome && !isExpense) continue;
    
    const finalCategory = categoryOverrides[txnId] || category;
    const topCategory = finalCategory.split(':')[0].trim();
    const subCategory = finalCategory.includes(':') ? finalCategory.split(':').slice(1).join(':').trim() : '';
    
    // Extract vendor
    let vendor = vendorName;
    if (!vendor && memo) {
      const memoUpper = memo.toUpperCase();
      if (memoUpper.includes('AMAZON')) vendor = 'Amazon';
      else if (memoUpper.includes('SHOPIFY')) vendor = 'Shopify';
      else if (memoUpper.includes('GOOGLE')) vendor = 'Google';
      else if (memoUpper.includes('META') || memoUpper.includes('FACEBOOK')) vendor = 'Meta';
      else vendor = memo.split(' ')[0] || 'Unknown';
    }
    if (!vendor) vendor = 'Unknown';
    
    const txn = {
      id: txnId,
      date: dateKey,
      dateDisplay: dateStr,
      type: txnType,
      vendor,
      memo,
      category: finalCategory,
      originalCategory: category,
      topCategory,
      subCategory,
      amount: Math.abs(amount),
      isIncome,
      isExpense,
      account: currentAccount,
      accountType: currentAccountType,
    };
    
    transactions.push(txn);
    
    if (accounts[currentAccount]) {
      accounts[currentAccount].transactions++;
      if (txn.isIncome) accounts[currentAccount].totalIn += txn.amount;
      if (txn.isExpense) accounts[currentAccount].totalOut += txn.amount;
    }
    
    // Category stats
    if (!categories[topCategory]) {
      categories[topCategory] = { name: topCategory, count: 0, totalIn: 0, totalOut: 0, subCategories: {} };
    }
    categories[topCategory].count++;
    if (txn.isIncome) categories[topCategory].totalIn += txn.amount;
    if (txn.isExpense) categories[topCategory].totalOut += txn.amount;
    
    if (subCategory) {
      if (!categories[topCategory].subCategories[subCategory]) {
        categories[topCategory].subCategories[subCategory] = { count: 0, totalIn: 0, totalOut: 0 };
      }
      categories[topCategory].subCategories[subCategory].count++;
      if (txn.isIncome) categories[topCategory].subCategories[subCategory].totalIn += txn.amount;
      if (txn.isExpense) categories[topCategory].subCategories[subCategory].totalOut += txn.amount;
    }
  }
  
  // Sort by date
  transactions.sort((a, b) => a.date.localeCompare(b.date));
  
  // Generate monthly snapshots
  const monthlySnapshots = {};
  transactions.forEach(txn => {
    const monthKey = txn.date.substring(0, 7);
    if (!monthlySnapshots[monthKey]) {
      monthlySnapshots[monthKey] = { income: 0, expenses: 0, transactions: 0, byCategory: {} };
    }
    monthlySnapshots[monthKey].transactions++;
    if (txn.isIncome) monthlySnapshots[monthKey].income += txn.amount;
    if (txn.isExpense) monthlySnapshots[monthKey].expenses += txn.amount;
    
    if (!monthlySnapshots[monthKey].byCategory[txn.topCategory]) {
      monthlySnapshots[monthKey].byCategory[txn.topCategory] = { income: 0, expenses: 0 };
    }
    if (txn.isIncome) monthlySnapshots[monthKey].byCategory[txn.topCategory].income += txn.amount;
    if (txn.isExpense) monthlySnapshots[monthKey].byCategory[txn.topCategory].expenses += txn.amount;
  });
  
  Object.keys(monthlySnapshots).forEach(m => {
    monthlySnapshots[m].net = monthlySnapshots[m].income - monthlySnapshots[m].expenses;
  });
  
  return {
    transactions,
    accounts,
    categories,
    monthlySnapshots,
    dateRange: transactions.length > 0 ? {
      start: transactions[0].date,
      end: transactions[transactions.length - 1].date
    } : null,
    transactionCount: transactions.length,
  };
};

const formatCurrency = (num) => {
  if (num === null || num === undefined || isNaN(num)) return '$0.00';
  return (num < 0 ? '-' : '') + '$' + Math.abs(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};
const formatPercent = (num) => (num === null || num === undefined || isNaN(num)) ? '0.0%' : num.toFixed(1) + '%';
const formatNumber = (num) => (num === null || num === undefined || isNaN(num)) ? '0' : Math.round(num).toLocaleString('en-US');

// Helper: Check if a day has REAL sales data (not just Google/Meta Ads data)
// Real daily data has revenue > 0 from actual sales uploads
// Ads-only data may have total/shopify objects but with no revenue
const hasDailySalesData = (dayData) => {
  if (!dayData) return false;
  // Check for actual revenue - ads-only days have total/shopify but revenue is 0 or undefined
  const totalRevenue = dayData.total?.revenue || 0;
  const shopifyRevenue = dayData.shopify?.revenue || 0;
  const amazonRevenue = dayData.amazon?.revenue || 0;
  return totalRevenue > 0 || shopifyRevenue > 0 || amazonRevenue > 0;
};

// Helper: Format date to YYYY-MM-DD without timezone issues
const formatDateKey = (date) => {
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
};

const getSunday = (date) => {
  const d = new Date(date);
  d.setDate(d.getDate() + (7 - d.getDay()) % 7);
  return formatDateKey(d);
};

const STORAGE_KEY = 'ecommerce_dashboard_v5';
const INVENTORY_KEY = 'ecommerce_inventory_v5';
const COGS_KEY = 'ecommerce_cogs_v1';
const STORE_KEY = 'ecommerce_store_name_v1';
const GOALS_KEY = 'ecommerce_goals_v1';
const PERIODS_KEY = 'ecommerce_periods_v1';
const SALES_TAX_KEY = 'ecommerce_sales_tax_v1';
const PRODUCT_NAMES_KEY = 'ecommerce_product_names_v1';
const SETTINGS_KEY = 'ecommerce_settings_v1';
const NOTES_KEY = 'ecommerce_notes_v1';
const WIDGET_KEY = 'ecommerce_widgets_v1';
const THEME_KEY = 'ecommerce_theme_v1';
const INVOICES_KEY = 'ecommerce_invoices_v1';
const AMAZON_FORECAST_KEY = 'ecommerce_amazon_forecast_v1';
const THREEPL_LEDGER_KEY = 'ecommerce_3pl_ledger_v1';
const WEEKLY_REPORTS_KEY = 'ecommerce_weekly_reports_v1';
const FORECAST_ACCURACY_KEY = 'ecommerce_forecast_accuracy_v1';
const FORECAST_CORRECTIONS_KEY = 'ecommerce_forecast_corrections_v1';

// Supabase (cloud auth + storage)
// Create a .env.local file in your Vite project with:
//   VITE_SUPABASE_URL=...
//   VITE_SUPABASE_ANON_KEY=...
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;
const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY)
  ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
      },
    })
  : null;

// ============ LOCALSTORAGE COMPRESSION ============
// Simple LZW-based compression for localStorage (handles large datasets efficiently)
const LZCompress = {
  compress: (str) => {
    if (!str || str.length < 1000) return str; // Don't compress small strings
    try {
      const dict = new Map();
      let dictSize = 256;
      for (let i = 0; i < 256; i++) dict.set(String.fromCharCode(i), i);
      
      let w = '';
      const result = [];
      for (const c of str) {
        const wc = w + c;
        if (dict.has(wc)) {
          w = wc;
        } else {
          result.push(dict.get(w));
          dict.set(wc, dictSize++);
          w = c;
        }
      }
      if (w) result.push(dict.get(w));
      
      // Convert to base64-safe string with marker
      return 'LZ1:' + result.map(n => String.fromCharCode(n + 32)).join('');
    } catch (e) {
      console.warn('LZCompress: compression failed, storing uncompressed', e);
      return str; // Return uncompressed on error
    }
  },
  decompress: (compressed) => {
    if (!compressed || !compressed.startsWith('LZ1:')) return compressed;
    try {
      const str = compressed.slice(4);
      const codes = [...str].map(c => c.charCodeAt(0) - 32);
      
      const dict = new Map();
      let dictSize = 256;
      for (let i = 0; i < 256; i++) dict.set(i, String.fromCharCode(i));
      
      let w = String.fromCharCode(codes[0]);
      let result = w;
      for (let i = 1; i < codes.length; i++) {
        const k = codes[i];
        let entry;
        if (dict.has(k)) {
          entry = dict.get(k);
        } else if (k === dictSize) {
          entry = w + w[0];
        } else {
          console.warn('LZCompress: invalid dictionary entry, returning raw data');
          return compressed.slice(4); // Invalid, return as-is minus marker
        }
        result += entry;
        dict.set(dictSize++, w + entry[0]);
        w = entry;
      }
      return result;
    } catch (e) {
      console.warn('LZCompress: decompression failed, returning raw data', e);
      return compressed.slice(4); // Return without marker on error
    }
  }
};

// Keys that benefit from compression (large JSON data)
const COMPRESSED_KEYS = [
  'ecommerce_sales_data_v2',
  'ecommerce_daily_sales_v1', 
  'ecommerce_inventory_v1',
  'ecommerce_periods_v1',
  'ecommerce_3pl_ledger_v1',
  'ecommerce_banking_v1',
  'ecommerce_ai_chat_history_v1',
];

const lsGet = (key) => {
  try { 
    const raw = localStorage.getItem(key);
    if (COMPRESSED_KEYS.includes(key) && raw?.startsWith('LZ1:')) {
      return LZCompress.decompress(raw);
    }
    return raw; 
  } catch { return null; }
};

const lsSet = (key, value) => {
  try { 
    // Compress large data for specific keys
    const toStore = COMPRESSED_KEYS.includes(key) ? LZCompress.compress(value) : value;
    localStorage.setItem(key, toStore);
  } catch (e) {
    // Handle quota exceeded
    if (e.name === 'QuotaExceededError') {
      console.warn(`localStorage quota exceeded for ${key}. Attempting cleanup...`);
      // Try to clear old chat history to make room
      try {
        const chatKey = 'ecommerce_ai_chat_history_v1';
        const chat = localStorage.getItem(chatKey);
        if (chat) {
          const messages = JSON.parse(LZCompress.decompress(chat) || chat);
          if (messages.length > 50) {
            localStorage.setItem(chatKey, LZCompress.compress(JSON.stringify(messages.slice(-50))));
          }
        }
        // Retry the save
        const toStore = COMPRESSED_KEYS.includes(key) ? LZCompress.compress(value) : value;
        localStorage.setItem(key, toStore);
      } catch {
        console.error('Failed to save to localStorage even after cleanup');
      }
    }
  }
};

// Enhanced 3PL parsing - extracts detailed metrics from 3PL CSV files
const parse3PLData = (threeplFiles) => {
  const breakdown = { storage: 0, shipping: 0, pickFees: 0, boxCharges: 0, receiving: 0, other: 0 };
  const metrics = {
    totalCost: 0,
    orderCount: 0,
    totalUnits: 0,
    avgShippingCost: 0,
    avgPickCost: 0,
    avgPackagingCost: 0,
    avgCostPerOrder: 0,
    avgUnitsPerOrder: 0,
    shippingCount: 0,
    firstPickCount: 0,
    additionalPickCount: 0,
  };
  
  if (!threeplFiles) return { breakdown, metrics };
  
  // Normalize to array of file data arrays
  // threeplFiles could be:
  // 1. null/undefined -> return empty
  // 2. Array of row objects (single file): [{Charge: x}, {Charge: y}] 
  // 3. Array of arrays (multiple files): [[{row1}, {row2}], [{row1}, {row2}]]
  let filesArray;
  if (Array.isArray(threeplFiles)) {
    // Check if first element is an array (multiple files) or an object (single file's rows)
    if (threeplFiles.length > 0 && Array.isArray(threeplFiles[0])) {
      // Multiple files: [[rows], [rows]]
      filesArray = threeplFiles;
    } else {
      // Single file: [rows] - wrap it
      filesArray = [threeplFiles];
    }
  } else {
    // Single non-array item (shouldn't happen but handle it)
    filesArray = [[threeplFiles]];
  }
  
  filesArray.forEach(fileData => {
    if (!fileData || !Array.isArray(fileData)) return;
    fileData.forEach(r => {
      if (!r || typeof r !== 'object') return;
      const charge = r['Charge On Invoice'] || '';
      const amount = parseFloat(r['Amount Total ($)'] || 0);
      const count = parseInt(r['Count Total'] || 0);
      const avg = parseFloat(r['Average ($)'] || 0);
      const chargeLower = charge.toLowerCase();
      
      metrics.totalCost += amount;
      
      if (chargeLower.includes('storage')) {
        breakdown.storage += amount;
      } else if (chargeLower.includes('shipping')) {
        breakdown.shipping += amount;
        metrics.shippingCount += count;
        metrics.avgShippingCost = avg; // Use the average from the row
      } else if (chargeLower.includes('first pick')) {
        breakdown.pickFees += amount;
        metrics.firstPickCount += count;
        metrics.orderCount += count; // First pick count = order count
      } else if (chargeLower.includes('additional pick')) {
        breakdown.pickFees += amount;
        metrics.additionalPickCount += count;
      } else if (chargeLower.includes('pick')) {
        breakdown.pickFees += amount;
      } else if (chargeLower.includes('box') || chargeLower.includes('mailer')) {
        breakdown.boxCharges += amount;
      } else if (chargeLower.includes('receiving')) {
        breakdown.receiving += amount;
      } else {
        breakdown.other += amount;
      }
    });
  });
  
  // Calculate derived metrics
  metrics.totalUnits = metrics.firstPickCount + metrics.additionalPickCount;
  
  if (metrics.orderCount > 0) {
    metrics.avgPickCost = breakdown.pickFees / metrics.orderCount;
    metrics.avgPackagingCost = breakdown.boxCharges / metrics.orderCount;
    // Fulfillment cost = everything except storage
    const fulfillmentCost = metrics.totalCost - breakdown.storage;
    metrics.avgCostPerOrder = fulfillmentCost / metrics.orderCount;
    metrics.avgUnitsPerOrder = metrics.totalUnits / metrics.orderCount;
  }
  
  return { breakdown, metrics };
};

// Parse Excel file for 3PL bulk upload - extracts Summary and Detail sheets
const parse3PLExcel = async (file) => {
  // Load SheetJS from CDN if not already loaded
  const xlsx = await loadXLSX();
  
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = xlsx.read(data, { type: 'array' });
        
        const result = {
          fileName: file.name,
          summary: [],
          detail: [],
          invoiceLevel: [],
          dateRange: { start: null, end: null },
          orders: [],
          nonOrderCharges: [],
          format: 'unknown',
        };
        
        // Detect format based on sheet names
        const sheetNames = workbook.SheetNames;
        const hasDetailSheet = sheetNames.includes('Detail');
        const hasSummarySheet = sheetNames.includes('Summary');
        const hasShipmentsSheet = sheetNames.some(s => s.toLowerCase().includes('shipment'));
        const hasPackagingSheet = sheetNames.includes('Packaging');
        
        // FORMAT 1: Packiyo Invoice Format (Summary, Detail, Invoice Level sheets)
        if (hasDetailSheet && hasSummarySheet) {
          result.format = 'packiyo-invoice';
          
          // Parse Summary sheet
          const summarySheet = workbook.Sheets['Summary'];
          result.summary = xlsx.utils.sheet_to_json(summarySheet);
          
          // Parse Detail sheet
          const detailSheet = workbook.Sheets['Detail'];
          const detailRows = xlsx.utils.sheet_to_json(detailSheet);
          result.detail = detailRows;
          
          // Extract orders with dates
          detailRows.forEach(row => {
            const shipDateStr = row['Ship Datetime'] || row['Order Datetime'];
            if (!shipDateStr) return;
            
            // Parse date (format: "2025-10-19 04:58:32 PM" or "2025-09-16 08:53:45 AM")
            const dateStr = shipDateStr.toString().split(' ')[0];
            const shipDate = new Date(dateStr + 'T00:00:00');
            if (isNaN(shipDate)) return;
            
            const orderNumber = (row['Order Number'] || '').toString();
            const trackingNumber = (row['Tracking Number'] || '').toString();
            const uniqueKey = `${orderNumber}-${trackingNumber}`;
            const weekKey = getSunday(shipDate);
            
            // Update date range
            if (!result.dateRange.start || shipDate < new Date(result.dateRange.start)) {
              result.dateRange.start = shipDate.toISOString().split('T')[0];
            }
            if (!result.dateRange.end || shipDate > new Date(result.dateRange.end)) {
              result.dateRange.end = shipDate.toISOString().split('T')[0];
            }
            
            result.orders.push({
              uniqueKey,
              orderNumber,
              trackingNumber,
              shipDate: shipDate.toISOString().split('T')[0],
              weekKey,
              carrier: (row['Carrier Name'] || '').toString(),
              serviceLevel: (row['Service Level Name'] || '').toString(),
              state: (row['Ship Recipient Address State'] || '').toString(),
              postalCode: (row['Ship Recipient Address Postal Code'] || '').toString(),
              weight: parseFloat(row['Weight Value'] || 0),
              weightUnit: (row['Weight Unit'] || 'oz').toString(),
              packageType: (row['Package Type Name'] || '').toString(),
              charges: {
                additionalPick: parseFloat(row['Additional Pick Fee - Amount ($)'] || 0),
                additionalPickQty: parseInt(row['Additional Pick Fee - Quantity'] || 0),
                firstPick: parseFloat(row['First Pick Fee - Amount ($)'] || 0),
                firstPickQty: parseInt(row['First Pick Fee - Quantity'] || 0),
                box: parseFloat(row['Box Charge - Amount ($)'] || 0),
                boxQty: parseInt(row['Box Charge - Quantity'] || 0),
                reBoxing: parseFloat(row['Re-Boxing Fee - Amount ($)'] || 0),
                fbaForwarding: parseFloat(row['Fba Forwarding - Amount ($)'] || 0),
              },
            });
          });
          
          // Parse Invoice Level for non-order charges
          if (sheetNames.includes('Invoice Level')) {
            const invoiceSheet = workbook.Sheets['Invoice Level'];
            result.invoiceLevel = xlsx.utils.sheet_to_json(invoiceSheet);
          }
          
          // Extract non-order charges from Summary
          result.summary.forEach(row => {
            const charge = (row['Charge On Invoice'] || '').toString();
            const chargeLower = charge.toLowerCase();
            const amount = parseFloat(row['Amount Total ($)'] || 0);
            const count = parseInt(row['Count Total'] || 0);
            
            if (chargeLower.includes('storage') || chargeLower.includes('receiving') || 
                chargeLower.includes('shipping') || chargeLower.includes('credit') ||
                chargeLower.includes('special project')) {
              result.nonOrderCharges.push({
                chargeType: charge,
                amount,
                count,
                average: parseFloat(row['Average ($)'] || 0),
              });
            }
          });
        }
        
        // FORMAT 2: Packiyo Shipments Export (Shipments sheet with order/shipment_date columns)
        else if (hasShipmentsSheet) {
          result.format = 'packiyo-shipments';
          
          // Find the shipments sheet
          const shipmentsSheetName = sheetNames.find(s => s.toLowerCase().includes('shipment'));
          const shipmentsSheet = workbook.Sheets[shipmentsSheetName];
          const rows = xlsx.utils.sheet_to_json(shipmentsSheet);
          
          // Parse packaging costs if available
          let packagingCosts = {};
          if (hasPackagingSheet) {
            const packagingSheet = workbook.Sheets['Packaging'];
            const packagingRows = xlsx.utils.sheet_to_json(packagingSheet);
            packagingRows.forEach(row => {
              const type = (row['Type of Packaging'] || '').toString();
              const cost = parseFloat(row['Packaging Cost'] || 0);
              if (type && cost > 0) packagingCosts[type.toLowerCase()] = cost;
            });
          }
          
          rows.forEach(row => {
            // Try different column name variations
            const shipDateStr = row['shipment_date'] || row['Shipment Date'] || row['ship_date'] || row['order_date'] || row['Order Date'];
            if (!shipDateStr) return;
            
            // Parse date (format: "2025-07-31 21:25:24")
            const dateStr = shipDateStr.toString().split(' ')[0];
            const shipDate = new Date(dateStr + 'T00:00:00');
            if (isNaN(shipDate)) return;
            
            const orderNumber = (row['order'] || row['Order'] || row['order_number'] || row['Order Number'] || '').toString();
            const trackingNumber = (row['tracking_number'] || row['Tracking Number'] || '').toString();
            // Extract just the tracking number if it's a URL
            const trackingClean = trackingNumber.includes('http') ? trackingNumber.split('/').pop() : trackingNumber;
            const uniqueKey = `${orderNumber}-${trackingClean || shipDate.toISOString()}`;
            const weekKey = getSunday(shipDate);
            
            // Update date range
            if (!result.dateRange.start || shipDate < new Date(result.dateRange.start)) {
              result.dateRange.start = shipDate.toISOString().split('T')[0];
            }
            if (!result.dateRange.end || shipDate > new Date(result.dateRange.end)) {
              result.dateRange.end = shipDate.toISOString().split('T')[0];
            }
            
            // Try to estimate costs from packaging info
            let packagingCost = 0;
            const packaging = (row['packaging'] || row['Packaging'] || row['package_type'] || '').toString().toLowerCase();
            if (packaging && packagingCosts[packaging]) {
              packagingCost = packagingCosts[packaging];
            }
            
            result.orders.push({
              uniqueKey,
              orderNumber,
              trackingNumber: trackingClean,
              shipDate: shipDate.toISOString().split('T')[0],
              weekKey,
              carrier: (row['shipping_carrier'] || row['Shipping Carrier'] || row['user_defined_shipping_carrier'] || '').toString(),
              serviceLevel: (row['shipping_method'] || row['Shipping Method'] || '').toString(),
              state: (row['state'] || row['State'] || '').toString(),
              postalCode: (row['zip'] || row['Zip'] || row['postal_code'] || '').toString(),
              weight: parseFloat(row['weight'] || row['Weight'] || 0),
              weightUnit: 'oz',
              packageType: packaging,
              charges: {
                // This format doesn't have per-order charges, use packaging costs
                additionalPick: 0,
                additionalPickQty: 0,
                firstPick: 2.50, // Default pick fee estimate
                firstPickQty: 1,
                box: packagingCost,
                boxQty: packagingCost > 0 ? 1 : 0,
                reBoxing: 0,
                fbaForwarding: 0,
              },
            });
          });
        }
        
        // FORMAT 3: Simple summary sheet - try to extract what we can
        else {
          result.format = 'simple-summary';
          
          // Try first sheet
          const firstSheet = workbook.Sheets[sheetNames[0]];
          const rows = xlsx.utils.sheet_to_json(firstSheet, { header: 1 });
          
          // Look for any date info in filename
          const fileNameMatch = file.name.match(/(\d{1,2})[_-](\d{1,2})[_-]?(\d{1,2})?[_-]?(\d{1,2})?/);
          if (fileNameMatch) {
            // Try to parse date range from filename like "8_1-8_31" or "9_1-9_30"
            const month1 = parseInt(fileNameMatch[1]);
            const day1 = parseInt(fileNameMatch[2]);
            const month2 = fileNameMatch[3] ? parseInt(fileNameMatch[3]) : month1;
            const day2 = fileNameMatch[4] ? parseInt(fileNameMatch[4]) : 28;
            const year = 2025; // Default year
            
            result.dateRange.start = `${year}-${String(month1).padStart(2, '0')}-${String(day1).padStart(2, '0')}`;
            result.dateRange.end = `${year}-${String(month2).padStart(2, '0')}-${String(day2).padStart(2, '0')}`;
          }
          
          // Try to extract order count from content
          rows.forEach(row => {
            if (Array.isArray(row)) {
              const text = row.join(' ').toLowerCase();
              if (text.includes('order') && row[1]) {
                const count = parseInt(row[1]) || 0;
                if (count > 0 && count < 10000) {
                  // Create placeholder orders based on count
                  // This is imprecise but better than nothing
                }
              }
            }
          });
        }
        
        resolve(result);
      } catch (err) {
        console.error('Error parsing 3PL file:', err);
        reject(err);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
};

// Helper to get 3PL data for a specific week from the ledger
const get3PLForWeek = (ledger, weekKey) => {
  if (!ledger) return null;
  
  // Convert weekKey to date for fuzzy matching
  const targetDate = new Date(weekKey + 'T00:00:00');
  const targetStart = new Date(targetDate);
  targetStart.setDate(targetDate.getDate() - 6); // Start of week (7 days before)
  const targetEnd = new Date(targetDate);
  targetEnd.setDate(targetDate.getDate() + 1); // Include day after for timezone tolerance
  
  // Find orders that match this week (fuzzy match within 2 days of week boundary)
  const weekOrders = ledger.orders ? Object.values(ledger.orders).filter(o => {
    // Try exact match first
    if (o.weekKey === weekKey) return true;
    
    // Try fuzzy match - check if order's weekKey is within 2 days of target
    if (o.weekKey) {
      const orderWeekDate = new Date(o.weekKey + 'T00:00:00');
      const diffDays = Math.abs((orderWeekDate - targetDate) / (1000 * 60 * 60 * 24));
      if (diffDays <= 2) return true;
    }
    
    // Also try matching by shipDate
    if (o.shipDate) {
      const shipDate = new Date(o.shipDate + 'T00:00:00');
      return shipDate >= targetStart && shipDate <= targetEnd;
    }
    
    return false;
  }) : [];
  
  const breakdown = { storage: 0, shipping: 0, pickFees: 0, boxCharges: 0, receiving: 0, other: 0 };
  const metrics = {
    totalCost: 0,
    orderCount: weekOrders.length,
    totalUnits: 0,
    avgShippingCost: 0,
    avgPickCost: 0,
    avgPackagingCost: 0,
    avgCostPerOrder: 0,
    avgUnitsPerOrder: 0,
    shippingCount: 0,
    firstPickCount: 0,
    additionalPickCount: 0,
    carrierBreakdown: {},
    stateBreakdown: {},
  };
  
  let totalShipping = 0;
  
  weekOrders.forEach(order => {
    const c = order.charges || {};
    breakdown.pickFees += (c.firstPick || 0) + (c.additionalPick || 0);
    breakdown.boxCharges += c.box || 0;
    breakdown.other += (c.reBoxing || 0) + (c.fbaForwarding || 0);
    
    metrics.firstPickCount += c.firstPickQty || 0;
    metrics.additionalPickCount += c.additionalPickQty || 0;
    
    // Track by carrier
    if (order.carrier) {
      if (!metrics.carrierBreakdown[order.carrier]) metrics.carrierBreakdown[order.carrier] = { orders: 0, cost: 0 };
      metrics.carrierBreakdown[order.carrier].orders++;
    }
    
    // Track by state
    if (order.state) {
      if (!metrics.stateBreakdown[order.state]) metrics.stateBreakdown[order.state] = 0;
      metrics.stateBreakdown[order.state]++;
    }
  });
  
  // Add non-order charges allocated to this week (fuzzy match)
  Object.values(ledger.summaryCharges || {}).forEach(charge => {
    const chargeWeekDate = new Date((charge.weekKey || '') + 'T00:00:00');
    const diffDays = Math.abs((chargeWeekDate - targetDate) / (1000 * 60 * 60 * 24));
    
    if (charge.weekKey === weekKey || diffDays <= 2) {
      const chargeLower = (charge.chargeType || '').toLowerCase();
      if (chargeLower.includes('storage')) breakdown.storage += charge.amount || 0;
      else if (chargeLower.includes('shipping')) {
        breakdown.shipping += charge.amount || 0;
        totalShipping += charge.amount || 0;
        metrics.shippingCount += charge.count || 0;
      }
      else if (chargeLower.includes('receiving')) breakdown.receiving += charge.amount || 0;
      else breakdown.other += charge.amount || 0;
    }
  });
  
  metrics.totalUnits = metrics.firstPickCount + metrics.additionalPickCount;
  metrics.totalCost = breakdown.storage + breakdown.shipping + breakdown.pickFees + breakdown.boxCharges + breakdown.receiving + breakdown.other;
  
  // Return null if no data found (no orders and no costs)
  if (metrics.orderCount === 0 && metrics.totalCost === 0) return null;
  
  if (metrics.orderCount > 0) {
    metrics.avgPickCost = breakdown.pickFees / metrics.orderCount;
    metrics.avgPackagingCost = breakdown.boxCharges / metrics.orderCount;
    const fulfillmentCost = metrics.totalCost - breakdown.storage;
    metrics.avgCostPerOrder = fulfillmentCost / metrics.orderCount;
    metrics.avgUnitsPerOrder = metrics.totalUnits / metrics.orderCount;
    if (metrics.shippingCount > 0) metrics.avgShippingCost = totalShipping / metrics.shippingCount;
  }
  
  return { breakdown, metrics };
};

// Get 3PL data for a specific day by filtering ledger orders by shipDate
// NOTE: Storage is excluded as it's a weekly/monthly aggregate, not per-shipment
const get3PLForDay = (ledger, dayKey) => {
  if (!ledger || !ledger.orders) return null;
  
  // Find orders that shipped on this specific day
  const dayOrders = Object.values(ledger.orders).filter(o => o.shipDate === dayKey);
  
  if (dayOrders.length === 0) return null;
  
  const breakdown = { storage: 0, shipping: 0, pickFees: 0, boxCharges: 0, receiving: 0, other: 0 };
  const metrics = {
    totalCost: 0,
    orderCount: dayOrders.length,
    totalUnits: 0,
    avgShippingCost: 0,
    avgPickCost: 0,
    avgPackagingCost: 0,
    avgCostPerOrder: 0,
    avgUnitsPerOrder: 0,
    shippingCount: 0,
    firstPickCount: 0,
    additionalPickCount: 0,
    carrierBreakdown: {},
    stateBreakdown: {},
  };
  
  let totalShipping = 0;
  
  dayOrders.forEach(order => {
    const c = order.charges || {};
    breakdown.pickFees += (c.firstPick || 0) + (c.additionalPick || 0);
    breakdown.boxCharges += c.box || 0;
    breakdown.other += (c.reBoxing || 0) + (c.fbaForwarding || 0);
    
    metrics.firstPickCount += c.firstPickQty || 0;
    metrics.additionalPickCount += c.additionalPickQty || 0;
    
    // Track by carrier
    if (order.carrier) {
      if (!metrics.carrierBreakdown[order.carrier]) metrics.carrierBreakdown[order.carrier] = { orders: 0, cost: 0 };
      metrics.carrierBreakdown[order.carrier].orders++;
    }
    
    // Track by state
    if (order.state) {
      if (!metrics.stateBreakdown[order.state]) metrics.stateBreakdown[order.state] = 0;
      metrics.stateBreakdown[order.state]++;
    }
  });
  
  // Storage is NOT included in daily - it's a weekly/monthly aggregate charge
  // Only order-level charges (pick fees, box charges, etc.) are included
  
  metrics.totalUnits = metrics.firstPickCount + metrics.additionalPickCount;
  metrics.totalCost = breakdown.pickFees + breakdown.boxCharges + breakdown.other; // No storage
  
  if (metrics.orderCount > 0) {
    metrics.avgPickCost = breakdown.pickFees / metrics.orderCount;
    metrics.avgPackagingCost = breakdown.boxCharges / metrics.orderCount;
    metrics.avgCostPerOrder = metrics.totalCost / metrics.orderCount;
    metrics.avgUnitsPerOrder = metrics.totalUnits / metrics.orderCount;
  }
  
  return { breakdown, metrics };
};

// Get 3PL data for a period (month/quarter/year) by aggregating from ledger
const get3PLForPeriod = (ledger, periodKey) => {
  if (!ledger || !ledger.orders) return null;
  
  // Parse period key to determine date range
  let startDate, endDate;
  
  if (periodKey.match(/^\d{4}$/)) {
    // Year: "2025"
    startDate = new Date(parseInt(periodKey), 0, 1);
    endDate = new Date(parseInt(periodKey), 11, 31);
  } else if (periodKey.match(/^Q[1-4] \d{4}$/)) {
    // Quarter: "Q3 2024"
    const [q, year] = periodKey.split(' ');
    const quarter = parseInt(q[1]) - 1;
    startDate = new Date(parseInt(year), quarter * 3, 1);
    endDate = new Date(parseInt(year), quarter * 3 + 3, 0);
  } else if (periodKey.match(/^[A-Za-z]+ \d{4}$/)) {
    // Month: "September 2025"
    const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                    'july', 'august', 'september', 'october', 'november', 'december'];
    const parts = periodKey.split(' ');
    const monthIdx = months.indexOf(parts[0].toLowerCase());
    const year = parseInt(parts[1]);
    if (monthIdx >= 0) {
      startDate = new Date(year, monthIdx, 1);
      endDate = new Date(year, monthIdx + 1, 0);
    }
  }
  
  if (!startDate || !endDate) return null;
  
  // Filter orders within date range
  const periodOrders = Object.values(ledger.orders).filter(o => {
    const orderDate = new Date(o.shipDate + 'T00:00:00');
    return orderDate >= startDate && orderDate <= endDate;
  });
  
  if (periodOrders.length === 0) return null;
  
  const breakdown = { storage: 0, shipping: 0, pickFees: 0, boxCharges: 0, receiving: 0, other: 0 };
  const metrics = {
    totalCost: 0,
    orderCount: periodOrders.length,
    totalUnits: 0,
    avgCostPerOrder: 0,
    avgUnitsPerOrder: 0,
  };
  
  periodOrders.forEach(order => {
    const c = order.charges || {};
    breakdown.pickFees += (c.firstPick || 0) + (c.additionalPick || 0);
    breakdown.boxCharges += c.box || 0;
    breakdown.other += (c.reBoxing || 0) + (c.fbaForwarding || 0);
    metrics.totalUnits += (c.firstPickQty || 0) + (c.additionalPickQty || 0);
  });
  
  // Add summary charges within date range
  Object.values(ledger.summaryCharges || {}).forEach(charge => {
    const chargeDate = new Date((charge.weekKey || '') + 'T00:00:00');
    if (chargeDate >= startDate && chargeDate <= endDate) {
      const chargeLower = (charge.chargeType || '').toLowerCase();
      if (chargeLower.includes('storage')) breakdown.storage += charge.amount || 0;
      else if (chargeLower.includes('shipping')) breakdown.shipping += charge.amount || 0;
      else if (chargeLower.includes('receiving')) breakdown.receiving += charge.amount || 0;
      else breakdown.other += charge.amount || 0;
    }
  });
  
  metrics.totalCost = breakdown.storage + breakdown.shipping + breakdown.pickFees + breakdown.boxCharges + breakdown.receiving + breakdown.other;
  if (metrics.orderCount > 0) {
    metrics.avgCostPerOrder = (metrics.totalCost - breakdown.storage) / metrics.orderCount;
    metrics.avgUnitsPerOrder = metrics.totalUnits / metrics.orderCount;
  }
  
  return { breakdown, metrics };
};

export default function Dashboard() {
  const [view, setView] = useState('dashboard'); // Start with dashboard
  const [weekEnding, setWeekEnding] = useState('');
  const [files, setFiles] = useState({ amazon: null, shopify: null, cogs: null, threepl: [] }); // threepl is now array
  const [fileNames, setFileNames] = useState({ amazon: '', shopify: '', cogs: '', threepl: [] }); // threepl names array
  const [adSpend, setAdSpend] = useState({ meta: '', google: '' });
  const [allWeeksData, setAllWeeksData] = useState({});
  const [allDaysData, setAllDaysData] = useState({}); // Daily data keyed by date YYYY-MM-DD
  const [selectedWeek, setSelectedWeek] = useState(null);
  const [selectedDay, setSelectedDay] = useState(null); // For daily upload
  const [viewingDayDetails, setViewingDayDetails] = useState(null); // For viewing day data details (date string)
  const [selectedMonth, setSelectedMonth] = useState(null);
  const [selectedYear, setSelectedYear] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [showSaveConfirm, setShowSaveConfirm] = useState(false);
  const [toast, setToast] = useState(null); // { message: string, type: 'success' | 'error' }
  
  // Settings tab state
  const [settingsTab, setSettingsTab] = useState(() => {
    try { return localStorage.getItem('ecommerce_settings_tab') || 'general'; } catch { return 'general'; }
  }); // 'general' | 'integrations' | 'thresholds' | 'display' | 'data' | 'account'
  
  // Persist settings tab selection
  useEffect(() => {
    try { localStorage.setItem('ecommerce_settings_tab', settingsTab); } catch {}
  }, [settingsTab]);
  
  // Undo deletion state - stores recently deleted items for 10-second undo window
  const [deletedItems, setDeletedItems] = useState([]); // Array of { type, key, data, expiry, undoTimer }
  
  const [reprocessPeriod, setReprocessPeriod] = useState(null); // For period reprocessing
  const [threeplTimeView, setThreeplTimeView] = useState('weekly'); // For 3PL analytics view
  const [threeplDateRange, setThreeplDateRange] = useState('all'); // 'week' | '4weeks' | 'month' | 'quarter' | 'year' | 'all' | 'custom'
  const [threeplCustomStart, setThreeplCustomStart] = useState('');
  const [threeplCustomEnd, setThreeplCustomEnd] = useState('');
  const [uploadTab, setUploadTab] = useState('weekly'); // For upload view tabs: 'daily' | 'weekly' | 'period'
  const [dashboardRange, setDashboardRange] = useState('month'); // 'yesterday' | 'week' | 'month' | 'quarter' | 'year'
  const [trendsTab, setTrendsTab] = useState('daily'); // 'daily' | 'weekly' | 'monthly' | 'yearly' for trends view
  const [trendsChannel, setTrendsChannel] = useState('combined'); // 'amazon' | 'shopify' | 'combined' for trends filtering
  const [trendsDateRange, setTrendsDateRange] = useState({ start: null, end: null, preset: 'all' }); // Date range filter for trends
  const [profitPeriodIndex, setProfitPeriodIndex] = useState(-1); // -1 = most recent, 0+ = index from end of available periods
  const [dailyFiles, setDailyFiles] = useState({ amazon: null, shopify: null }); // Daily upload files
  const [dailyAdSpend, setDailyAdSpend] = useState({ meta: '', google: '' }); // Daily ad spend inputs
  const [calendarMonth, setCalendarMonth] = useState(null); // null = auto (latest data), or { year, month }
  
  // Amazon Campaign Data
  const [amazonCampaigns, setAmazonCampaigns] = useState(() => {
    try { return JSON.parse(localStorage.getItem('ecommerce_amazon_campaigns_v1')) || { campaigns: [], lastUpdated: null, history: [] }; }
    catch { return { campaigns: [], lastUpdated: null, history: [] }; }
  });
  const [amazonCampaignSort, setAmazonCampaignSort] = useState({ field: 'spend', dir: 'desc' });
  const [amazonCampaignFilter, setAmazonCampaignFilter] = useState({ status: 'all', type: 'all', search: '' });

  // Weekly Intelligence Reports
  const [weeklyReports, setWeeklyReports] = useState(() => {
    try { 
      const stored = JSON.parse(localStorage.getItem(WEEKLY_REPORTS_KEY));
      return {
        weekly: stored?.weekly || { reports: [], lastGenerated: null },
        monthly: stored?.monthly || { reports: [], lastGenerated: null },
        quarterly: stored?.quarterly || { reports: [], lastGenerated: null },
        annual: stored?.annual || { reports: [], lastGenerated: null },
        preferences: stored?.preferences || { autoGenerate: true, emailDelivery: false, emailAddress: '' },
      }; 
    } catch { 
      return { 
        weekly: { reports: [], lastGenerated: null },
        monthly: { reports: [], lastGenerated: null },
        quarterly: { reports: [], lastGenerated: null },
        annual: { reports: [], lastGenerated: null },
        preferences: { autoGenerate: true, emailDelivery: false, emailAddress: '' }, 
      }; 
    }
  });
  const [showWeeklyReport, setShowWeeklyReport] = useState(false);
  const [currentReport, setCurrentReport] = useState(null);
  const [generatingReport, setGeneratingReport] = useState(false);
  const [reportError, setReportError] = useState(null);
  const [reportType, setReportType] = useState('weekly');

  const [storeName, setStoreName] = useState('');
  const [storeLogo, setStoreLogo] = useState(() => localStorage.getItem('ecommerce_store_logo') || null);
  
  // Shopify Integration
  const [shopifyCredentials, setShopifyCredentials] = useState({ storeUrl: '', clientId: '', clientSecret: '', connected: false, lastSync: null });
  const [shopifySyncStatus, setShopifySyncStatus] = useState({ loading: false, error: null, progress: '' });
  const [shopifySyncRange, setShopifySyncRange] = useState({ start: '', end: '' });
  const [shopifySyncPreview, setShopifySyncPreview] = useState(null);
  const [shopifyInventoryStatus, setShopifyInventoryStatus] = useState({ loading: false, error: null, lastSync: null });
  const [shopifyInventoryPreview, setShopifyInventoryPreview] = useState(null);
  const [shopifySmartSync, setShopifySmartSync] = useState({ enabled: true, missingDays: [], existingDays: [] });
  
  // Sales Tax Period Calculator
  const [taxPeriodType, setTaxPeriodType] = useState('month');
  const [taxPeriodValue, setTaxPeriodValue] = useState(() => {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  });

  // Goals & Targets
  const [goals, setGoals] = useState({ weeklyRevenue: 0, weeklyProfit: 0, monthlyRevenue: 0, monthlyProfit: 0 });
  const [showGoalsModal, setShowGoalsModal] = useState(false);

// Auth + cloud sync
const [session, setSession] = useState(null);
const [authEmail, setAuthEmail] = useState('');
const [authPassword, setAuthPassword] = useState('');
const [authMode, setAuthMode] = useState('sign_in'); // sign_in | sign_up
const [authError, setAuthError] = useState('');
const [cloudStatus, setCloudStatus] = useState('');
const [isAuthReady, setIsAuthReady] = useState(false);
const lastSavedRef = useRef(0);
const saveTimerRef = useRef(null);
const isLoadingDataRef = useRef(false);

// Multi-store support
const [stores, setStores] = useState([]); // List of { id, name, createdAt }
const [activeStoreId, setActiveStoreId] = useState(null);
const [showStoreSelector, setShowStoreSelector] = useState(false); // Header dropdown
const [showStoreModal, setShowStoreModal] = useState(false); // Full modal for create/manage
const [newStoreName, setNewStoreName] = useState('');

// Auto-lock (idle timeout)
const LOCK_MS = 10 * 60 * 1000; // 10 minutes
const ACTIVITY_KEY = "ecomm_last_activity_v1";
const [isLocked, setIsLocked] = useState(false);
const [unlockPassword, setUnlockPassword] = useState("");
const [unlockError, setUnlockError] = useState("");
const lastActivityRef = useRef(Date.now());

const markActivity = useCallback(() => {
  const now = Date.now();
  lastActivityRef.current = now;
  lsSet(ACTIVITY_KEY, String(now));
}, []);

const handleAuth = async (e) => {
  e.preventDefault();
  setAuthError('');
  if (!supabase) { setAuthError('Supabase is not configured. Add VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY.'); return; }
  try {
    if (authMode === 'sign_up') {
      const { error } = await supabase.auth.signUp({ email: authEmail, password: authPassword });
      if (error) throw error;
      setAuthError('Account created. You can sign in now.');
      setAuthMode('sign_in');
    } else {
      const { error } = await supabase.auth.signInWithPassword({ email: authEmail, password: authPassword });
      if (error) throw error;
    }
  } catch (err) {
    setAuthError(err?.message || 'Login failed');
  }
};

const handleLogout = async () => {
  if (!supabase) return;
  await supabase.auth.signOut();
  setSession(null);
  // Clear any locked state
  setIsLocked(false);
};

  
  const [savedCogs, setSavedCogs] = useState({});
  const [savedProductNames, setSavedProductNames] = useState({}); // SKU -> Product Name mapping
  const [cogsLastUpdated, setCogsLastUpdated] = useState(null);
  const [showCogsManager, setShowCogsManager] = useState(false);
  const [showProductCatalog, setShowProductCatalog] = useState(false);
  const [productCatalogFile, setProductCatalogFile] = useState(null);
  const [productCatalogFileName, setProductCatalogFileName] = useState('');
  
  const [bulkImportResult, setBulkImportResult] = useState(null);
  const [customStartDate, setCustomStartDate] = useState('');
  const [customEndDate, setCustomEndDate] = useState('');
  const [customPeriodData, setCustomPeriodData] = useState(null);

  const [invFiles, setInvFiles] = useState({ amazon: null, threepl: null, cogs: null });
  const [invFileNames, setInvFileNames] = useState({ amazon: '', threepl: '', cogs: '' });
  const [invHistory, setInvHistory] = useState({});
  const [selectedInvDate, setSelectedInvDate] = useState(null);
  const [invSnapshotDate, setInvSnapshotDate] = useState('');
  
  const [showEditAdSpend, setShowEditAdSpend] = useState(false);
  const [editAdSpend, setEditAdSpend] = useState({ meta: '', google: '' });
  const [showEdit3PL, setShowEdit3PL] = useState(false);
  const [edit3PLCost, setEdit3PLCost] = useState('');
  const [lastBackupDate, setLastBackupDate] = useState(() => localStorage.getItem('ecommerce_last_backup') || null);
  const [lastSyncDate, setLastSyncDate] = useState(null);
  
  // Bulk Ad Upload state
  const [bulkAdPlatform, setBulkAdPlatform] = useState('google'); // 'google' | 'meta'
  const [bulkAdFiles, setBulkAdFiles] = useState([]); // Array of { name, content, parsed }
  const [bulkAdParsed, setBulkAdParsed] = useState(null); // Combined: { dailyData, weeklyData, totalSpend, error, dateRange }
  const [bulkAdProcessing, setBulkAdProcessing] = useState(false); // Processing multiple files
  
  const [showReprocess, setShowReprocess] = useState(false);
  const [reprocessFiles, setReprocessFiles] = useState({ amazon: null, shopify: null, threepl: null });
  const [reprocessFileNames, setReprocessFileNames] = useState({ amazon: '', shopify: '', threepl: '' });
  const [reprocessAdSpend, setReprocessAdSpend] = useState({ meta: '', google: '' });

  // Period uploads (monthly/yearly totals without weekly breakdown)
  const [periodFiles, setPeriodFiles] = useState({ amazon: null, shopify: null, threepl: [] }); // threepl is array
  const [periodFileNames, setPeriodFileNames] = useState({ amazon: '', shopify: '', threepl: [] }); // threepl names array
  const [periodAdSpend, setPeriodAdSpend] = useState({ meta: '', google: '' });
  const [periodLabel, setPeriodLabel] = useState('');
  const [allPeriodsData, setAllPeriodsData] = useState({});
  const [selectedPeriod, setSelectedPeriod] = useState(null);
  const [periodAnalyticsView, setPeriodAnalyticsView] = useState(null); // 'skus' | 'profit' | 'ads' | '3pl' | null
  
  // 3PL Ledger - stores all 3PL orders with dates for deduplication
  const [threeplLedger, setThreeplLedger] = useState({
    orders: {}, // { uniqueKey: { orderNumber, trackingNumber, shipDate, weekKey, charges: {}, carrier, serviceLevel, state, weight, ... } }
    summaryCharges: {}, // { uniqueKey: { date, chargeType, amount, count, ... } } - for non-order charges like storage, receiving
    importedFiles: [], // Track which files have been imported
  });
  const [show3PLBulkUpload, setShow3PLBulkUpload] = useState(false);
  const [threeplUploadStatus, setThreeplUploadStatus] = useState(null); // { processing: bool, results: [] }
  const [threeplSelectedFiles, setThreeplSelectedFiles] = useState([]);
  const [threeplProcessing, setThreeplProcessing] = useState(null); // null or { current: number, total: number, fileName: string }
  const [threeplResults, setThreeplResults] = useState(null);
  
  // Ads Bulk Upload (Meta & Google)
  const [showAdsBulkUpload, setShowAdsBulkUpload] = useState(false);
  const [adsSelectedFiles, setAdsSelectedFiles] = useState([]);
  const [adsProcessing, setAdsProcessing] = useState(null); // null or { current: number, total: number, fileName: string }
  const [adsResults, setAdsResults] = useState(null);
  
  // Banking Module - QBO Transaction Data
  const [bankingData, setBankingData] = useState(() => {
    try { 
      const stored = JSON.parse(localStorage.getItem('ecommerce_banking_v1'));
      return stored || { 
        transactions: [], 
        lastUpload: null, 
        accounts: {},
        categories: {},
        monthlySnapshots: {},
        categoryOverrides: {},
        settings: { reminderEnabled: true, reminderTime: '09:00' }
      }; 
    } catch { 
      return { 
        transactions: [], 
        lastUpload: null, 
        accounts: {},
        categories: {},
        monthlySnapshots: {},
        categoryOverrides: {},
        settings: { reminderEnabled: true, reminderTime: '09:00' }
      }; 
    }
  });
  const [bankingFile, setBankingFile] = useState(null);
  const [bankingProcessing, setBankingProcessing] = useState(false);
  const [bankingDateRange, setBankingDateRange] = useState('month'); // 'week' | 'month' | 'quarter' | 'year' | 'all' | 'ytd'
  const [bankingTab, setBankingTab] = useState('overview'); // 'overview' | 'income' | 'expenses' | 'accounts' | 'trends' | 'ai' | 'cfo' | 'cards'
  const [bankingCategoryFilter, setBankingCategoryFilter] = useState('all');
  const [showBankingUpload, setShowBankingUpload] = useState(false);
  const [editingTransaction, setEditingTransaction] = useState(null); // Transaction being edited
  const [bankingDrilldown, setBankingDrilldown] = useState(null); // { category: string, type: 'expense'|'income' } for drill-down view
  const [editingAccountBalance, setEditingAccountBalance] = useState(null); // { name: string, balance: number } for manual balance edit
  const [confirmedRecurring, setConfirmedRecurring] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem('ecommerce_recurring_v1')) || {};
    } catch { return {}; }
  });
  const [showAddRecurring, setShowAddRecurring] = useState(false);
  const [recurringForm, setRecurringForm] = useState({ vendor: '', category: '', amount: '', notes: '' });
  const [skuDateRange, setSkuDateRange] = useState('all'); // 'all' | '4weeks' | 'ytd' | '2025' | '2024'
  
  // Save confirmed recurring to localStorage
  useEffect(() => {
    localStorage.setItem('ecommerce_recurring_v1', JSON.stringify(confirmedRecurring));
  }, [confirmedRecurring]);
  
  // Sales Tax Management
  const [salesTaxConfig, setSalesTaxConfig] = useState({
    nexusStates: {}, // { stateCode: { hasNexus: true, frequency: 'monthly', registrationId: '', portalUrl: '', customFilings: [], notes: '' } }
    filingHistory: {}, // { stateCode: { 'YYYY-MM' or 'YYYY-QN': { filed: true, paidDate: '', amount: 0, confirmationNum: '', reportData: {} } } }
    hiddenStates: [], // states user wants to hide from view
  });
  const [selectedTaxState, setSelectedTaxState] = useState(null);
  const [taxReportFile, setTaxReportFile] = useState(null);
  const [taxReportFileName, setTaxReportFileName] = useState('');
  const [parsedTaxReport, setParsedTaxReport] = useState(null);
  const [showTaxStateConfig, setShowTaxStateConfig] = useState(false);
  const [taxConfigState, setTaxConfigState] = useState(null); // state being configured
  const [showHiddenStates, setShowHiddenStates] = useState(false);
  const [taxFilterStatus, setTaxFilterStatus] = useState('all'); // 'all' | 'due' | 'upcoming'
  
  // Local state for tax config form (to prevent re-render on each keystroke)
  const [taxFormRegistrationId, setTaxFormRegistrationId] = useState('');
  const [taxFormNotes, setTaxFormNotes] = useState('');
  
  // Initialize tax form fields when modal opens
  useEffect(() => {
    if (showTaxStateConfig && taxConfigState) {
      const config = salesTaxConfig.nexusStates?.[taxConfigState] || {};
      setTaxFormRegistrationId(config.registrationId || '');
      setTaxFormNotes(config.notes || '');
    }
  }, [showTaxStateConfig, taxConfigState, salesTaxConfig.nexusStates]);
  
  // Settings view state
  const [localSettings, setLocalSettings] = useState(null);
  const [showResetConfirm, setShowResetConfirm] = useState(false);
  
  // Sales tax modal state
  const [newCustomFiling, setNewCustomFiling] = useState({ name: '', frequency: 'annual', dueMonth: 1, dueDay: 15, amount: '' });
  const [taxFilingConfirmNum, setTaxFilingConfirmNum] = useState('');
  const [taxFilingPaidAmount, setTaxFilingPaidAmount] = useState('');
  const [taxFilingNotes, setTaxFilingNotes] = useState('');
  const [viewingStateHistory, setViewingStateHistory] = useState(null); // state code to view history for
  const [taxViewTab, setTaxViewTab] = useState('states'); // 'states' | 'history' | 'nexus-info'
  const [filingDetailState, setFilingDetailState] = useState(null); // { stateCode, data } for filing format modal
  const [editingPortalUrl, setEditingPortalUrl] = useState(null); // stateCode being edited
  const [editPortalUrlValue, setEditPortalUrlValue] = useState('');
  
  // AI Chatbot state
  const [showAIChat, setShowAIChat] = useState(false);
  const [aiMessages, setAiMessages] = useState(() => {
    try { return JSON.parse(localStorage.getItem('ecommerce_ai_chat_history_v1')) || []; } catch { return []; }
  });
  const [aiInput, setAiInput] = useState('');
  const [aiLoading, setAiLoading] = useState(false);
  
  // AI Ads Insights Chat (separate from main AI chat)
  const [showAdsAIChat, setShowAdsAIChat] = useState(false);
  const [adsAiMessages, setAdsAiMessages] = useState([]);
  const [adsAiInput, setAdsAiInput] = useState('');
  const [adsAiLoading, setAdsAiLoading] = useState(false);
  
  // Help modal
  const [showUploadHelp, setShowUploadHelp] = useState(false);
  
  // NEW FEATURES STATE
  // 1. Dashboard Widget Customization
  const [widgetConfig, setWidgetConfig] = useState(() => {
    try { return JSON.parse(localStorage.getItem(WIDGET_KEY)) || null; } catch { return null; }
  });
  const [editingWidgets, setEditingWidgets] = useState(false);
  
  // Production Pipeline
  const PRODUCTION_KEY = 'ecommerce_production_v1';
  const [productionPipeline, setProductionPipeline] = useState(() => {
    try { return JSON.parse(localStorage.getItem('ecommerce_production_v1')) || []; } catch { return []; }
  });
  const [showAddProduction, setShowAddProduction] = useState(false);
  const [editingProduction, setEditingProduction] = useState(null);
  const [productionForm, setProductionForm] = useState({ 
    // Legacy single-item fields (kept for backwards compatibility)
    sku: '', 
    productName: '', 
    quantity: '', 
    expectedDate: '', 
    notes: '',
    // Enhanced PO fields
    poNumber: '',
    vendor: '',
    unitCost: '',
    paymentTerms: '50-50', // '30-70-ship' | '50-50' | 'net30' | 'custom'
    depositPercent: 50,
    depositPaid: false,
    depositPaidDate: '',
    balancePaid: false,
    balancePaidDate: '',
    shipments: [], // [{ date, units, paid }]
    // Net terms
    depositNetDays: 0, // Days after PO to pay deposit (0 = immediate)
    balanceNetDays: 0, // Days after shipment to pay balance (0 = on shipment)
    // Cure time (for soaps)
    cureTimeDays: 0, // Days product needs before sellable
    // Multi-SKU line items
    lineItems: [], // [{ sku, productName, quantity, unitCost }]
  });
  const [productionFile, setProductionFile] = useState(null);
  const [productionFileName, setProductionFileName] = useState('');
  const [extractingProduction, setExtractingProduction] = useState(false);
  const [showAddShipment, setShowAddShipment] = useState(null); // PO id for adding shipment
  const [shipmentForm, setShipmentForm] = useState({ date: '', units: '', notes: '' });
  
  // Lead Time Settings
  const [leadTimeSettings, setLeadTimeSettings] = useState(() => {
    try { 
      return JSON.parse(localStorage.getItem('ecommerce_lead_times_v1')) || {
        defaultLeadTimeDays: 14,
        skuLeadTimes: {}, // { sku: days }
        reorderBuffer: 7, // Extra days buffer for reorder alerts
      }; 
    } catch { 
      return { defaultLeadTimeDays: 14, skuLeadTimes: {}, reorderBuffer: 7 }; 
    }
  });
  
  // Save lead time settings
  useEffect(() => {
    localStorage.setItem('ecommerce_lead_times_v1', JSON.stringify(leadTimeSettings));
  }, [leadTimeSettings]);
  
  // Modular AI Forecasts State
  const [aiForecastModule, setAiForecastModule] = useState({
    sales: null,        // { tomorrow, week, month, quarter }
    inventory: null,    // { recommendations, alerts }
    amazon: null,       // Amazon channel specific
    shopify: null,      // Shopify channel specific
    comparison: null,   // AI vs Amazon comparison
    loading: null,      // Which module is loading
    lastUpdated: null,
  });
  
  // AI Learning Data - tracks all predictions vs actuals
  const [aiLearningHistory, setAiLearningHistory] = useState(() => {
    try { return JSON.parse(localStorage.getItem('ecommerce_ai_learning_v1')) || { predictions: [], accuracy: {} }; } 
    catch { return { predictions: [], accuracy: {} }; }
  });
  
  // ============ UNIFIED AI MODEL ============
  // Single source of truth for all AI learning - combines forecasts, patterns, and corrections
  const [unifiedAIModel, setUnifiedAIModel] = useState(() => {
    try { 
      return JSON.parse(localStorage.getItem('ecommerce_unified_ai_v1')) || {
        version: '1.0',
        lastUpdated: null,
        
        // Data availability tracking - knows what data exists for each channel/period
        dataAvailability: {
          amazon: { daily: [], weekly: [], periods: [] },  // Dates/periods with data
          shopify: { daily: [], weekly: [], periods: [] },
          lastScanned: null,
        },
        
        // Learned correction factors (from forecast vs actual comparisons)
        corrections: {
          overall: { revenue: 1, units: 1, profit: 1 },
          byChannel: { amazon: { revenue: 1, units: 1 }, shopify: { revenue: 1, units: 1 } },
          bySku: {},      // { [sku]: { units: 1.05, samples: 5 } }
          byMonth: {},    // { [1-12]: { revenue: 0.95, samples: 3 } } - seasonality
          byQuarter: {},  // { [1-4]: { revenue: 1.1, samples: 2 } }
          byDayOfWeek: {}, // { 'Monday': { revenue: 0.85 }, ... }
        },
        
        // Signal weights - learned weights for different forecast inputs
        signalWeights: {
          dailyTrend: 0.4,      // Weight for recent daily trends
          weeklyAverage: 0.25,  // Weight for weekly averages
          amazonForecast: 0.15, // Weight for Amazon's forecasts (if available)
          seasonality: 0.1,     // Weight for seasonal patterns
          momentum: 0.1,        // Weight for momentum (acceleration/deceleration)
        },
        
        // Learned patterns
        patterns: {
          bestDays: [],         // ['Friday', 'Saturday'] - highest revenue days
          worstDays: [],        // ['Tuesday'] - lowest revenue days
          peakHours: [],        // If we ever get hourly data
          seasonalPeaks: [],    // ['November', 'December']
          skuVelocity: {},      // { [sku]: { avgUnitsPerWeek: 10, trend: 'growing' } }
        },
        
        // Prediction history with outcomes
        predictions: [],  // { id, date, type, predicted, actual, error, context }
        
        // Model accuracy metrics
        accuracy: {
          overall: null,        // Overall accuracy %
          last30Days: null,     // Recent accuracy
          byType: {},           // { 'daily': 85, 'weekly': 78, 'monthly': 82 }
          trend: 'stable',      // 'improving', 'declining', 'stable'
        },
        
        // Confidence levels based on data quality
        confidence: {
          amazon: 0,    // 0-100 based on data completeness
          shopify: 0,
          overall: 0,
        },
      }; 
    } catch { 
      return { version: '1.0', lastUpdated: null, dataAvailability: {}, corrections: {}, signalWeights: {}, patterns: {}, predictions: [], accuracy: {}, confidence: {} }; 
    }
  });
  
  // Persist unified AI model
  useEffect(() => {
    if (unifiedAIModel.lastUpdated) {
      localStorage.setItem('ecommerce_unified_ai_v1', JSON.stringify(unifiedAIModel));
    }
  }, [unifiedAIModel]);
  
  useEffect(() => {
    localStorage.setItem('ecommerce_ai_learning_v1', JSON.stringify(aiLearningHistory));
  }, [aiLearningHistory]);
  
  // Save AI chat history to localStorage
  useEffect(() => {
    if (aiMessages.length > 0) {
      // Keep last 100 messages to avoid localStorage bloat
      const messagesToSave = aiMessages.slice(-100);
      localStorage.setItem('ecommerce_ai_chat_history_v1', JSON.stringify(messagesToSave));
    }
  }, [aiMessages]);
  
  // 4. Browser Notifications
  const [notificationsEnabled, setNotificationsEnabled] = useState(false);
  
  // 5. Forecasting
  const [showForecast, setShowForecast] = useState(false);
  
  // 7. Break-Even Calculator
  const [showBreakEven, setShowBreakEven] = useState(false);
  const [breakEvenInputs, setBreakEvenInputs] = useState({ adSpend: '', cogs: '', price: '', conversionRate: 2 });
  
  // 8. Notes/Journal
  const [weekNotes, setWeekNotes] = useState(() => {
    try { return JSON.parse(localStorage.getItem(NOTES_KEY)) || {}; } catch { return {}; }
  });
  const [editingNote, setEditingNote] = useState(null); // week key being edited
  const [noteText, setNoteText] = useState('');
  
  // 9. Theme Customization
  const [theme, setTheme] = useState(() => {
    try { return JSON.parse(localStorage.getItem(THEME_KEY)) || { mode: 'dark', accent: 'violet' }; } catch { return { mode: 'dark', accent: 'violet' }; }
  });
  
  // 10. CSV Export modal
  const [showExportModal, setShowExportModal] = useState(false);
  
  // 12. Comparison Mode
  const [compareMode, setCompareMode] = useState(false);
  const [compareItems, setCompareItems] = useState([]); // Array of week keys or SKUs to compare
  
  // Analytics view state
  const [analyticsTab, setAnalyticsTab] = useState('forecast');
  const [selectedSkusToCompare, setSelectedSkusToCompare] = useState([]);
  const [selectedWeeksToCompare, setSelectedWeeksToCompare] = useState([]);
  const [adsTimeTab, setAdsTimeTab] = useState('monthly'); // 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'yearly'
  const [adsYear, setAdsYear] = useState(new Date().getFullYear()); // Selected year
  const [adsMonth, setAdsMonth] = useState(new Date().getMonth()); // Selected month (0-11)
  const [adsQuarter, setAdsQuarter] = useState(Math.floor(new Date().getMonth() / 3) + 1); // 1-4
  const [adsSelectedWeek, setAdsSelectedWeek] = useState(null); // Selected week ending date for weekly comparison
  const [adsViewMode, setAdsViewMode] = useState('performance'); // 'performance' | 'campaigns' for ads tab
  
  // Forecast view state
  const [forecastSort, setForecastSort] = useState({ field: 'totalSales', dir: 'desc' });
  const [forecastFilter, setForecastFilter] = useState('');
  const [forecastPeriodView, setForecastPeriodView] = useState('monthly'); // 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'yearly'
  const [forecastTab, setForecastTab] = useState('sales'); // sales, amazon, shopify, inventory, comparison, settings
  const [forecastPeriod, setForecastPeriod] = useState('week'); // tomorrow, week, month, quarter
  
  // 3. Mobile view detection
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  
  // Upcoming Invoices/Bills
  const [invoices, setInvoices] = useState(() => {
    try { return JSON.parse(localStorage.getItem(INVOICES_KEY)) || []; } catch { return []; }
  });
  const [showInvoiceModal, setShowInvoiceModal] = useState(false);
  const [editingInvoice, setEditingInvoice] = useState(null);
  const [invoiceForm, setInvoiceForm] = useState({ vendor: '', description: '', amount: '', dueDate: '', recurring: false, frequency: 'monthly', category: 'operations' });
  const [processingPdf, setProcessingPdf] = useState(false);
  
  // Data Validation
  const [dataValidationWarnings, setDataValidationWarnings] = useState([]);
  const [showValidationModal, setShowValidationModal] = useState(false);
  const [pendingProcessAction, setPendingProcessAction] = useState(null);
  
  // Amazon Forecasts (from Amazon's SKU Economics forecast reports)
  const [amazonForecasts, setAmazonForecasts] = useState(() => {
    try { return JSON.parse(localStorage.getItem(AMAZON_FORECAST_KEY)) || {}; } catch { return {}; }
  });
  
  // Forecast upload tracking - tracks when each type was last uploaded
  const [forecastMeta, setForecastMeta] = useState(() => {
    try { 
      return JSON.parse(localStorage.getItem('ecommerce_forecast_meta')) || {
        lastUploads: {
          '7day': null,   // Date string of last 7-day forecast upload
          '30day': null,  // Date string of last 30-day forecast upload
          '60day': null,  // Date string of last 60-day forecast upload
        },
        history: [], // Array of { type, uploadedAt, periodStart, periodEnd, totalSales, totalProceeds, accuracy: null }
      }; 
    } catch { 
      return { lastUploads: { '7day': null, '30day': null, '60day': null }, history: [] }; 
    }
  });
  
  // Save forecast meta to localStorage
  useEffect(() => {
    localStorage.setItem('ecommerce_forecast_meta', JSON.stringify(forecastMeta));
  }, [forecastMeta]);
  
  // ============ SELF-LEARNING FORECAST SYSTEM ============
  // Forecast accuracy history - persists learning over time
  const [forecastAccuracyHistory, setForecastAccuracyHistory] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem(FORECAST_ACCURACY_KEY)) || {
        records: [],
        lastUpdated: null,
        modelVersion: 1
      };
    } catch { return { records: [], lastUpdated: null, modelVersion: 1 }; }
  });

  // Learned correction factors per SKU and overall
  const [forecastCorrections, setForecastCorrections] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem(FORECAST_CORRECTIONS_KEY)) || {
        overall: { revenue: 1.0, units: 1.0, profit: 1.0 },
        bySku: {},
        byMonth: {},
        byQuarter: {},
        confidence: 0,
        samplesUsed: 0,
        lastUpdated: null
      };
    } catch { 
      return { 
        overall: { revenue: 1.0, units: 1.0, profit: 1.0 },
        bySku: {},
        byMonth: {},
        byQuarter: {},
        confidence: 0,
        samplesUsed: 0,
        lastUpdated: null
      }; 
    }
  });

  // AI insights state
  const [aiInsights, setAiInsights] = useState(null);
  const [aiInsightsLoading, setAiInsightsLoading] = useState(false);

  // AI-powered forecasting state
  const [aiForecasts, setAiForecasts] = useState(() => {
    try { return JSON.parse(localStorage.getItem('ecommerce_ai_forecasts_v1')) || null; }
    catch { return null; }
  });
  const [aiForecastLoading, setAiForecastLoading] = useState(false);

  // Save AI forecasts to localStorage
  useEffect(() => {
    if (aiForecasts) {
      localStorage.setItem('ecommerce_ai_forecasts_v1', JSON.stringify(aiForecasts));
    }
  }, [aiForecasts]);

  // Save forecast accuracy history to localStorage
  useEffect(() => {
    localStorage.setItem(FORECAST_ACCURACY_KEY, JSON.stringify(forecastAccuracyHistory));
  }, [forecastAccuracyHistory]);

  // Save forecast corrections to localStorage
  useEffect(() => {
    localStorage.setItem(FORECAST_CORRECTIONS_KEY, JSON.stringify(forecastCorrections));
  }, [forecastCorrections]);
  // ============ END SELF-LEARNING FORECAST SYSTEM STATE ============
  
  // Calculate forecast alerts
  const forecastAlerts = useMemo(() => {
    const alerts = [];
    const now = new Date();
    
    const checkForecastAge = (type, days, label) => {
      const lastUpload = forecastMeta.lastUploads?.[type];
      if (!lastUpload) {
        alerts.push({ type, severity: 'warning', message: `No ${label} Amazon forecast uploaded yet`, action: 'upload' });
      } else {
        const uploadDate = new Date(lastUpload);
        const daysSince = Math.floor((now - uploadDate) / (1000 * 60 * 60 * 24));
        if (daysSince >= days) {
          alerts.push({ type, severity: 'warning', message: `${label} forecast is ${daysSince} days old (refresh every ${days} days)`, action: 'refresh' });
        } else {
          const daysUntil = days - daysSince;
          if (daysUntil <= 2) {
            alerts.push({ type, severity: 'info', message: `${label} forecast due for refresh in ${daysUntil} day(s)`, action: 'upcoming' });
          }
        }
      }
    };
    
    checkForecastAge('7day', 7, '7-day');
    checkForecastAge('30day', 30, '30-day');
    checkForecastAge('60day', 60, '60-day');
    
    // Check Amazon Campaign data freshness (weekly upload reminder)
    if (amazonCampaigns.lastUpdated) {
      const lastUpdate = new Date(amazonCampaigns.lastUpdated);
      const daysSince = Math.floor((now - lastUpdate) / (1000 * 60 * 60 * 24));
      if (daysSince >= 7) {
        alerts.push({ type: 'amazonCampaigns', severity: 'warning', message: `Amazon Campaign data is ${daysSince} days old (upload weekly)`, action: 'refresh' });
      } else if (daysSince >= 5) {
        alerts.push({ type: 'amazonCampaigns', severity: 'info', message: `Amazon Campaign refresh due in ${7 - daysSince} day(s)`, action: 'upcoming' });
      }
    } else {
      alerts.push({ type: 'amazonCampaigns', severity: 'info', message: 'Upload Amazon Campaign data for PPC analysis', action: 'upload' });
    }
    
    return alerts;
  }, [forecastMeta, amazonCampaigns.lastUpdated]);
  
  // ============ COMPREHENSIVE DATA STATUS DASHBOARD ============
  // Shows all uploaded data, what's feeding into predictions, and what's needed
  const dataStatus = useMemo(() => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    
    // === FORECAST STATUS ===
    const forecastStatus = {
      '7day': {
        type: '7-day',
        lastUpload: forecastMeta.lastUploads?.['7day'],
        refreshDays: 7,
        daysUntilExpiry: null,
        status: 'missing',
        weeksCovered: [],
      },
      '30day': {
        type: '30-day', 
        lastUpload: forecastMeta.lastUploads?.['30day'],
        refreshDays: 30,
        daysUntilExpiry: null,
        status: 'missing',
        weeksCovered: [],
      },
      '60day': {
        type: '60-day',
        lastUpload: forecastMeta.lastUploads?.['60day'],
        refreshDays: 60,
        daysUntilExpiry: null,
        status: 'missing',
        weeksCovered: [],
      },
    };
    
    // Calculate expiry status for each forecast
    Object.keys(forecastStatus).forEach(key => {
      const f = forecastStatus[key];
      if (f.lastUpload) {
        const uploadDate = new Date(f.lastUpload);
        const daysSince = Math.floor((now - uploadDate) / (1000 * 60 * 60 * 24));
        f.daysUntilExpiry = f.refreshDays - daysSince;
        f.daysSinceUpload = daysSince;
        
        if (f.daysUntilExpiry <= 0) {
          f.status = 'expired';
        } else if (f.daysUntilExpiry <= 2) {
          f.status = 'expiring';
        } else {
          f.status = 'active';
        }
      }
    });
    
    // Get weeks covered by Amazon forecasts
    const forecastWeeks = Object.keys(amazonForecasts).sort();
    
    // === DAILY DATA STATUS ===
    const dailyDates = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort();
    const last14Days = [];
    for (let i = 0; i < 14; i++) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const dateStr = formatDateKey(d);
      last14Days.push({
        date: dateStr,
        hasData: hasDailySalesData(allDaysData[dateStr]),
        hasAdsOnly: !!allDaysData[dateStr] && !hasDailySalesData(allDaysData[dateStr]),
        data: allDaysData[dateStr] || null,
        dayOfWeek: d.toLocaleDateString('en-US', { weekday: 'short' }),
      });
    }
    last14Days.reverse(); // Oldest first
    
    // Calculate consecutive day streak (from today backwards)
    let streak = 0;
    for (let i = 1; i <= 30; i++) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const dateStr = formatDateKey(d);
      if (hasDailySalesData(allDaysData[dateStr])) {
        streak++;
      } else {
        break;
      }
    }
    
    // === WEEKLY DATA STATUS ===
    const weeklyDates = Object.keys(allWeeksData).sort();
    const recentWeeks = weeklyDates.slice(-8).map(w => ({
      weekEnding: w,
      data: allWeeksData[w],
      hasForecast: !!amazonForecasts[w],
      hasComparison: false, // Will be calculated later
    }));
    
    // === LEARNING DATA STATUS ===
    // Calculate comparisons inline to avoid circular dependency
    const matchedWeeks = new Set();
    Object.keys(amazonForecasts).forEach(forecastWeek => {
      if (allWeeksData[forecastWeek]) {
        matchedWeeks.add(forecastWeek);
      }
    });
    
    const pendingForecastWeeks = Object.keys(amazonForecasts).filter(w => {
      const weekDate = new Date(w + 'T00:00:00');
      return weekDate < now && !matchedWeeks.has(w);
    });
    
    // === DATA FLOW ANALYSIS ===
    const dataFlow = {
      // Forecasts â†’ Learning: How many forecasts have matching actuals?
      forecastsWithActuals: matchedWeeks.size,
      forecastsAwaitingActuals: pendingForecastWeeks.length,
      
      // Daily â†’ Weekly: How many days can be aggregated?
      dailyDaysAvailable: dailyDates.length,
      weeksFromDaily: new Set(dailyDates.map(d => {
        const date = new Date(d + 'T12:00:00');
        const dayOfWeek = date.getDay();
        const weekEnd = new Date(date);
        // Move to Sunday (week ending day): if already Sunday add 0, else add days to reach Sunday
        weekEnd.setDate(date.getDate() + (dayOfWeek === 0 ? 0 : 7 - dayOfWeek));
        return formatDateKey(weekEnd);
      })).size,
      
      // Weekly â†’ Inventory: How many weeks feed velocity?
      weeksForVelocity: Math.min(4, weeklyDates.length),
      
      // Learning â†’ Predictions: Is learning active?
      learningActive: forecastCorrections.confidence >= 30,
      learningConfidence: forecastCorrections.confidence,
      learningSamples: forecastCorrections.samplesUsed,
    };
    
    // === NEXT ACTIONS ===
    const nextActions = [];
    
    // Check forecast status
    Object.entries(forecastStatus).forEach(([key, f]) => {
      if (f.status === 'expired') {
        nextActions.push({
          priority: 'high',
          type: 'forecast',
          message: `${f.type} forecast expired! Upload new forecast now.`,
          action: 'upload-forecast',
        });
      } else if (f.status === 'expiring') {
        nextActions.push({
          priority: 'medium',
          type: 'forecast',
          message: `${f.type} forecast expires in ${f.daysUntilExpiry} day(s)`,
          action: 'upload-forecast',
        });
      } else if (f.status === 'missing') {
        nextActions.push({
          priority: 'low',
          type: 'forecast',
          message: `No ${f.type} forecast uploaded yet`,
          action: 'upload-forecast',
        });
      }
    });
    
    // Check for pending actuals (forecasts awaiting actual data)
    if (pendingForecastWeeks.length > 0) {
      const oldestPending = pendingForecastWeeks.sort()[0];
      nextActions.push({
        priority: 'high',
        type: 'actuals',
        message: `${pendingForecastWeeks.length} week(s) have forecasts but no actuals (oldest: ${oldestPending})`,
        action: 'upload-weekly',
      });
    }
    
    // Check daily data freshness
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = formatDateKey(yesterday);
    if (!hasDailySalesData(allDaysData[yesterdayStr])) {
      nextActions.push({
        priority: 'medium',
        type: 'daily',
        message: `Yesterday's data (${yesterday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}) not uploaded`,
        action: 'upload-daily',
      });
    }
    
    // Check if daily data can be aggregated
    const dailyNotInWeekly = dailyDates.filter(d => {
      const date = new Date(d + 'T12:00:00');
      const dayOfWeek = date.getDay();
      const weekEnd = new Date(date);
      // Move to Sunday (week ending day)
      weekEnd.setDate(date.getDate() + (dayOfWeek === 0 ? 0 : 7 - dayOfWeek));
      const weekKey = formatDateKey(weekEnd);
      return weekEnd <= now && (!allWeeksData[weekKey] || !allWeeksData[weekKey].aggregatedFrom);
    });
    
    // === AGGREGATION STATUS ===
    // Group daily data by week and check completeness
    const weekGroups = {};
    dailyDates.forEach(dayKey => {
      const date = new Date(dayKey + 'T12:00:00');
      const dayOfWeek = date.getDay();
      const weekEnd = new Date(date);
      weekEnd.setDate(date.getDate() + (dayOfWeek === 0 ? 0 : 7 - dayOfWeek));
      const weekKey = formatDateKey(weekEnd);
      
      if (!weekGroups[weekKey]) {
        weekGroups[weekKey] = { weekEnding: weekKey, days: [], missingDays: [] };
      }
      weekGroups[weekKey].days.push(dayKey);
    });
    
    // Calculate missing days for each week
    Object.values(weekGroups).forEach(week => {
      const weekEndDate = new Date(week.weekEnding + 'T12:00:00');
      for (let i = 6; i >= 0; i--) {
        const d = new Date(weekEndDate);
        d.setDate(weekEndDate.getDate() - i);
        const dayKey = formatDateKey(d);
        if (!week.days.includes(dayKey)) {
          week.missingDays.push({
            date: dayKey,
            dayName: d.toLocaleDateString('en-US', { weekday: 'short' }),
            display: d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
          });
        }
      }
      week.isComplete = week.missingDays.length === 0;
    });
    
    const completeWeeks = Object.values(weekGroups).filter(w => w.isComplete && !allWeeksData[w.weekEnding]);
    const incompleteWeeks = Object.values(weekGroups).filter(w => !w.isComplete);
    
    // Add aggregate action if there are complete weeks ready
    if (completeWeeks.length > 0) {
      const totalDaysInCompleteWeeks = completeWeeks.reduce((sum, w) => sum + w.days.length, 0);
      nextActions.push({
        priority: 'medium',
        type: 'aggregate',
        message: `${completeWeeks.length} complete week${completeWeeks.length !== 1 ? 's' : ''} ready to aggregate (${totalDaysInCompleteWeeks} days)`,
        action: 'aggregate-daily',
      });
    }
    
    const aggregationStatus = {
      completeWeeks: completeWeeks.length,
      incompleteWeeks: incompleteWeeks.length,
      weekDetails: Object.values(weekGroups).sort((a, b) => b.weekEnding.localeCompare(a.weekEnding)),
    };
    
    return {
      forecastStatus,
      forecastWeeks,
      aggregationStatus,
      dailyStatus: {
        totalDays: dailyDates.length,
        last14Days,
        streak,
        oldestDate: dailyDates[0] || null,
        newestDate: dailyDates[dailyDates.length - 1] || null,
      },
      weeklyStatus: {
        totalWeeks: weeklyDates.length,
        recentWeeks,
        oldestWeek: weeklyDates[0] || null,
        newestWeek: weeklyDates[weeklyDates.length - 1] || null,
      },
      learningStatus: {
        active: forecastCorrections.confidence >= 30,
        confidence: forecastCorrections.confidence,
        samples: forecastCorrections.samplesUsed,
        comparisons: matchedWeeks.size,
        pendingComparisons: pendingForecastWeeks.length,
        skusTracked: Object.keys(forecastCorrections.bySku).length,
        lastUpdated: forecastCorrections.lastUpdated,
      },
      dataFlow,
      nextActions: nextActions.sort((a, b) => {
        const priorityOrder = { high: 0, medium: 1, low: 2 };
        return priorityOrder[a.priority] - priorityOrder[b.priority];
      }),
    };
  }, [forecastMeta, amazonForecasts, allDaysData, allWeeksData, forecastCorrections]);
  // ============ END DATA STATUS DASHBOARD ============
  
  // Save Amazon forecasts to localStorage and cloud
  useEffect(() => {
    localStorage.setItem(AMAZON_FORECAST_KEY, JSON.stringify(amazonForecasts));
  }, [amazonForecasts]);
  
  // Save invoices to localStorage and cloud
  useEffect(() => {
    localStorage.setItem(INVOICES_KEY, JSON.stringify(invoices));
    // Sync to cloud when invoices change
    if (invoices.length > 0 || localStorage.getItem(INVOICES_KEY)) {
      queueCloudSave({ ...combinedData, invoices });
    }
  }, [invoices]);
  
  // Save notes to localStorage and cloud
  useEffect(() => {
    localStorage.setItem(NOTES_KEY, JSON.stringify(weekNotes));
  }, [weekNotes]);
  
  // Save goals to localStorage
  useEffect(() => {
    localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
  }, [goals]);
  
  // Save product names to localStorage
  useEffect(() => {
    localStorage.setItem(PRODUCT_NAMES_KEY, JSON.stringify(savedProductNames));
  }, [savedProductNames]);
  
  // Save production pipeline to localStorage
  useEffect(() => {
    localStorage.setItem('ecommerce_production_v1', JSON.stringify(productionPipeline));
  }, [productionPipeline]);
  
  // Save widget config to localStorage
  useEffect(() => {
    if (widgetConfig) localStorage.setItem(WIDGET_KEY, JSON.stringify(widgetConfig));
  }, [widgetConfig]);
  
  // Save theme to localStorage
  useEffect(() => {
    localStorage.setItem(THEME_KEY, JSON.stringify(theme));
  }, [theme]);
  
  // Save logo to localStorage
  useEffect(() => {
    if (storeLogo) {
      localStorage.setItem('ecommerce_store_logo', storeLogo);
    } else {
      localStorage.removeItem('ecommerce_store_logo');
    }
  }, [storeLogo]);
  
  // Mobile detection
  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  
  // Request notification permission
  const requestNotifications = async () => {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      setNotificationsEnabled(permission === 'granted');
    }
  };
  
  // Send browser notification
  const sendNotification = (title, body) => {
    if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
      new Notification(title, { body, icon: '/favicon.ico' });
    }
  };
  
  // App Settings
  const [appSettings, setAppSettings] = useState({
    // Inventory thresholds
    inventoryDaysOptimal: 60, // Days of inventory considered optimal
    inventoryDaysLow: 30, // Days of inventory considered low
    inventoryDaysCritical: 14, // Days of inventory considered critical
    
    // Ad performance thresholds
    tacosOptimal: 15, // TACOS % considered optimal
    tacosWarning: 25, // TACOS % that triggers warning
    tacosMax: 35, // TACOS % considered too high
    roasTarget: 3.0, // Target ROAS
    
    // Profit thresholds
    marginTarget: 25, // Target net margin %
    marginWarning: 15, // Margin % that triggers warning
    
    // Module visibility
    modulesEnabled: {
      weeklyTracking: true,
      periodTracking: true,
      inventory: true,
      trends: true,
      yoy: true,
      skus: true,
      profitability: true,
      ads: true,
      threepl: true,
      salesTax: true,
    },
    
    // Dashboard preferences
    dashboardDefaultRange: 'month', // Default time range for dashboard
    showWeeklyGoals: true,
    showMonthlyGoals: true,
    
    // Alerts preferences
    alertSalesTaxDays: 7, // Days before due date to show alert
    alertInventoryEnabled: true,
    alertGoalsEnabled: true,
    alertSalesTaxEnabled: true,
    
    // Display preferences
    currencySymbol: '$',
    dateFormat: 'US', // 'US' (MM/DD/YYYY) or 'EU' (DD/MM/YYYY)
  });
  
  const clearPeriod3PLFiles = useCallback(() => {
    setPeriodFiles(p => ({ ...p, threepl: [] }));
    setPeriodFileNames(p => ({ ...p, threepl: [] }));
  }, []);

// US States with sales tax info - comprehensive list with economic nexus thresholds
const US_STATES_TAX_INFO = {
  AL: { name: 'Alabama', hasStateTax: true, stateRate: 0.04, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 250000, transactions: null }, marketplaceFacilitator: true, sst: true, note: 'Simplified Seller Use Tax (SSUT) program available' },
  AK: { name: 'Alaska', hasStateTax: false, stateRate: 0, filingTypes: ['local'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: false, note: 'No state tax, but must collect for ARSSTC member localities' },
  AZ: { name: 'Arizona', hasStateTax: true, stateRate: 0.056, filingTypes: ['state', 'county', 'city'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: false, note: 'TPT license required' },
  AR: { name: 'Arkansas', hasStateTax: true, stateRate: 0.065, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  CA: { name: 'California', hasStateTax: true, stateRate: 0.0725, filingTypes: ['state', 'district'], reportFormat: 'district', nexusThreshold: { sales: 500000, transactions: null }, marketplaceFacilitator: true, sst: false, note: 'Highest threshold - $500K sales required' },
  CO: { name: 'Colorado', hasStateTax: true, stateRate: 0.029, filingTypes: ['state', 'county', 'city', 'special'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: false, note: 'Home rule cities (Denver, Aurora, etc.) require separate registration' },
  CT: { name: 'Connecticut', hasStateTax: true, stateRate: 0.0635, shippingTaxable: true, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: false },
  DE: { name: 'Delaware', hasStateTax: false, stateRate: 0, filingTypes: [], reportFormat: 'none', nexusThreshold: null, marketplaceFacilitator: false, sst: false, note: 'No sales tax' },
  FL: { name: 'Florida', hasStateTax: true, stateRate: 0.06, filingTypes: ['state', 'county'], reportFormat: 'county', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: false },
  GA: { name: 'Georgia', hasStateTax: true, stateRate: 0.04, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  HI: { name: 'Hawaii', hasStateTax: true, stateRate: 0.04, shippingTaxable: true, filingTypes: ['state', 'county'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: false, note: 'GET (Gross Excise Tax) not traditional sales tax - applies to seller' },
  ID: { name: 'Idaho', hasStateTax: true, stateRate: 0.06, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: true },
  IL: { name: 'Illinois', hasStateTax: true, stateRate: 0.0625, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: false, note: 'ROT (Retailers Occupation Tax) - multiple local taxes' },
  IN: { name: 'Indiana', hasStateTax: true, stateRate: 0.07, shippingTaxable: true, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  IA: { name: 'Iowa', hasStateTax: true, stateRate: 0.06, filingTypes: ['state', 'local'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: true },
  KS: { name: 'Kansas', hasStateTax: true, stateRate: 0.065, shippingTaxable: true, filingTypes: ['state', 'county', 'city'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: true },
  KY: { name: 'Kentucky', hasStateTax: true, stateRate: 0.06, shippingTaxable: true, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  LA: { name: 'Louisiana', hasStateTax: true, stateRate: 0.0445, filingTypes: ['state', 'parish'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: false, note: 'Parish taxes filed through Louisiana Sales Tax Commission' },
  ME: { name: 'Maine', hasStateTax: true, stateRate: 0.055, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: false },
  MD: { name: 'Maryland', hasStateTax: true, stateRate: 0.06, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: false, note: 'Annual report & LLC fees required separately' },
  MA: { name: 'Massachusetts', hasStateTax: true, stateRate: 0.0625, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: false },
  MI: { name: 'Michigan', hasStateTax: true, stateRate: 0.06, shippingTaxable: true, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  MN: { name: 'Minnesota', hasStateTax: true, stateRate: 0.06875, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  MS: { name: 'Mississippi', hasStateTax: true, stateRate: 0.07, shippingTaxable: true, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 250000, transactions: null }, marketplaceFacilitator: true, sst: false },
  MO: { name: 'Missouri', hasStateTax: true, stateRate: 0.04225, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: false },
  MT: { name: 'Montana', hasStateTax: false, stateRate: 0, filingTypes: [], reportFormat: 'none', nexusThreshold: null, marketplaceFacilitator: false, sst: false, note: 'No sales tax' },
  NE: { name: 'Nebraska', hasStateTax: true, stateRate: 0.055, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  NV: { name: 'Nevada', hasStateTax: true, stateRate: 0.0685, filingTypes: ['state', 'county'], reportFormat: 'county', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  NH: { name: 'New Hampshire', hasStateTax: false, stateRate: 0, filingTypes: [], reportFormat: 'none', nexusThreshold: null, marketplaceFacilitator: false, sst: false, note: 'No sales tax' },
  NJ: { name: 'New Jersey', hasStateTax: true, stateRate: 0.06625, shippingTaxable: true, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  NM: { name: 'New Mexico', hasStateTax: true, stateRate: 0.05125, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: false, note: 'Gross Receipts Tax (GRT) - not traditional sales tax' },
  NY: { name: 'New York', hasStateTax: true, stateRate: 0.04, shippingTaxable: true, filingTypes: ['state', 'county', 'city'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 500000, transactions: 100 }, marketplaceFacilitator: true, sst: false, note: 'High threshold - $500K AND 100+ transactions required' },
  NC: { name: 'North Carolina', hasStateTax: true, stateRate: 0.0475, shippingTaxable: true, filingTypes: ['state', 'county'], reportFormat: 'county', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  ND: { name: 'North Dakota', hasStateTax: true, stateRate: 0.05, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: true },
  OH: { name: 'Ohio', hasStateTax: true, stateRate: 0.0575, shippingTaxable: true, filingTypes: ['state', 'county'], reportFormat: 'county', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  OK: { name: 'Oklahoma', hasStateTax: true, stateRate: 0.045, filingTypes: ['state', 'county', 'city'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: true },
  OR: { name: 'Oregon', hasStateTax: false, stateRate: 0, filingTypes: [], reportFormat: 'none', nexusThreshold: null, marketplaceFacilitator: false, sst: false, note: 'No sales tax' },
  PA: { name: 'Pennsylvania', hasStateTax: true, stateRate: 0.06, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: false, note: 'Philadelphia & Allegheny County have additional local taxes' },
  RI: { name: 'Rhode Island', hasStateTax: true, stateRate: 0.07, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  SC: { name: 'South Carolina', hasStateTax: true, stateRate: 0.06, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: true },
  SD: { name: 'South Dakota', hasStateTax: true, stateRate: 0.045, shippingTaxable: true, filingTypes: ['state', 'municipal'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true, note: 'Origin of Wayfair decision' },
  TN: { name: 'Tennessee', hasStateTax: true, stateRate: 0.07, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: true },
  TX: { name: 'Texas', hasStateTax: true, stateRate: 0.0625, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 500000, transactions: null }, marketplaceFacilitator: true, sst: false, note: 'High threshold - $500K sales required' },
  UT: { name: 'Utah', hasStateTax: true, stateRate: 0.0485, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  VT: { name: 'Vermont', hasStateTax: true, stateRate: 0.06, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  VA: { name: 'Virginia', hasStateTax: true, stateRate: 0.043, filingTypes: ['state', 'local'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: false },
  WA: { name: 'Washington', hasStateTax: true, stateRate: 0.065, shippingTaxable: true, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: true, note: 'B&O tax also applies to some sellers' },
  WV: { name: 'West Virginia', hasStateTax: true, stateRate: 0.06, shippingTaxable: true, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  WI: { name: 'Wisconsin', hasStateTax: true, stateRate: 0.05, shippingTaxable: true, filingTypes: ['state', 'county'], reportFormat: 'county', nexusThreshold: { sales: 100000, transactions: null }, marketplaceFacilitator: true, sst: true },
  WY: { name: 'Wyoming', hasStateTax: true, stateRate: 0.04, filingTypes: ['state', 'local'], reportFormat: 'jurisdiction', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: true },
  DC: { name: 'District of Columbia', hasStateTax: true, stateRate: 0.06, shippingTaxable: true, filingTypes: ['state'], reportFormat: 'standard', nexusThreshold: { sales: 100000, transactions: 200 }, marketplaceFacilitator: true, sst: false },
};

// State-specific filing formats - defines exact fields needed for each state's return
// Based on actual state filing requirements as of 2025
const STATE_FILING_FORMATS = {
  WV: {
    name: 'West Virginia',
    formName: 'WV/CST-200CU (Combined Sales & Use Tax Return)',
    website: 'https://mytaxes.wvtax.gov/',
    fields: [
      { name: 'Line 1 - Gross Sales', key: 'grossSales', description: 'Total gross receipts/sales' },
      { name: 'Line 2 - Deductions', key: 'deductions', description: 'Non-taxable sales, exemptions' },
      { name: 'Line 3 - Net Taxable Sales', key: 'taxableSales', description: 'Line 1 minus Line 2' },
      { name: 'Line 4 - Tax Rate', key: 'taxRate', description: '6.0%' },
      { name: 'Line 5 - Tax Due', key: 'taxDue', description: 'Line 3 Ã— 0.06' },
      { name: 'Line 6 - Tax Collected', key: 'taxCollected', description: 'Actual tax collected from customers' },
    ],
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      deductions: 0,
      taxableSales: data.totalSales || data.sales || 0,
      taxRate: '6.0%',
      taxDue: (data.totalSales || data.sales || 0) * 0.06,
      taxCollected: data.taxOwed || data.tax || 0,
    }),
  },
  PA: {
    name: 'Pennsylvania',
    formName: 'PA-100 Sales, Use and Hotel Occupancy Tax Return',
    website: 'https://www.revenue.pa.gov/OnlineServices/myPATH/',
    fields: [
      { name: 'Line 1 - Gross Sales', key: 'grossSales', description: 'Total sales price of taxable goods' },
      { name: 'Line 2 - Sales Not Subject to Tax', key: 'exemptSales', description: 'Exempt sales (resale, manufacturing, etc.)' },
      { name: 'Line 3 - Net Taxable Sales', key: 'taxableSales', description: 'Line 1 minus Line 2' },
      { name: 'Line 4 - State Tax (6%)', key: 'stateTax', description: 'Line 3 Ã— 0.06' },
      { name: 'Line 5 - Local Tax (if applicable)', key: 'localTax', description: 'Philadelphia 2%, Allegheny 1%' },
      { name: 'Line 6 - Total Tax Due', key: 'totalTax', description: 'Line 4 + Line 5' },
    ],
    note: 'Philadelphia adds 2% local tax, Allegheny County (Pittsburgh) adds 1%. Most remote sellers only owe state 6%.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      exemptSales: 0,
      taxableSales: data.totalSales || data.sales || 0,
      stateTax: (data.totalSales || data.sales || 0) * 0.06,
      localTax: 0,
      totalTax: data.taxOwed || data.tax || 0,
    }),
  },
  MD: {
    name: 'Maryland',
    formName: 'Form 202 - Sales and Use Tax Return',
    website: 'https://interactive.marylandtaxes.gov/',
    fields: [
      { name: 'Line 1 - Gross Sales', key: 'grossSales', description: 'Total sales of tangible personal property' },
      { name: 'Line 2 - Exempt Sales', key: 'exemptSales', description: 'Sales for resale, exempt organizations' },
      { name: 'Line 3 - Net Taxable Sales', key: 'taxableSales', description: 'Line 1 minus Line 2' },
      { name: 'Line 4 - Tax Collected (6%)', key: 'taxCollected', description: 'Tax collected from customers' },
    ],
    note: 'Maryland has a single 6% rate statewide. No local taxes for remote sellers.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      exemptSales: 0,
      taxableSales: data.totalSales || data.sales || 0,
      taxCollected: data.taxOwed || data.tax || 0,
    }),
  },
  VA: {
    name: 'Virginia',
    formName: 'Form ST-9 - Retail Sales and Use Tax Return',
    website: 'https://www.tax.virginia.gov/',
    fields: [
      { name: 'Line 1 - Gross Sales', key: 'grossSales', description: 'Total gross sales' },
      { name: 'Line 2 - Deductions', key: 'deductions', description: 'Exempt sales, sales for resale' },
      { name: 'Line 3 - Taxable Sales', key: 'taxableSales', description: 'Line 1 minus Line 2' },
      { name: 'Line 4a - State Tax (4.3%)', key: 'stateTax', description: 'Line 3 Ã— 0.043' },
      { name: 'Line 4b - Local Tax (1%)', key: 'localTax', description: 'Line 3 Ã— 0.01' },
      { name: 'Line 5 - Total Tax (5.3%)', key: 'totalTax', description: 'Line 4a + Line 4b' },
    ],
    note: 'Virginia has combined 5.3% rate (4.3% state + 1% local). Some areas have additional regional taxes.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      deductions: 0,
      taxableSales: data.totalSales || data.sales || 0,
      stateTax: (data.totalSales || data.sales || 0) * 0.043,
      localTax: (data.totalSales || data.sales || 0) * 0.01,
      totalTax: data.taxOwed || data.tax || 0,
    }),
  },
  TX: {
    name: 'Texas',
    formName: 'Form 01-117 - Texas Sales and Use Tax Return',
    website: 'https://comptroller.texas.gov/taxes/sales/',
    fields: [
      { name: 'Item 1 - Total Sales', key: 'totalSales', description: 'Total receipts from all sales' },
      { name: 'Item 2 - Taxable Sales', key: 'taxableSales', description: 'Sales subject to sales tax' },
      { name: 'Item 3 - Taxable Purchases', key: 'taxablePurchases', description: 'Use tax on purchases (usually $0)' },
      { name: 'Item 4 - Total Tax Due', key: 'totalTax', description: 'State (6.25%) + Local taxes' },
    ],
    note: 'Texas has 6.25% state rate. Local taxes vary by location (up to 2% additional). Report location of delivery for local tax.',
    calculate: (data) => ({
      totalSales: data.totalSales || data.sales || 0,
      taxableSales: data.totalSales || data.sales || 0,
      taxablePurchases: 0,
      totalTax: data.taxOwed || data.tax || 0,
    }),
  },
  FL: {
    name: 'Florida',
    formName: 'Form DR-15 - Sales and Use Tax Return',
    website: 'https://floridarevenue.com/taxes/taxesfees/Pages/sales_tax.aspx',
    fields: [
      { name: 'Line 1 - Gross Sales', key: 'grossSales', description: 'Total gross sales' },
      { name: 'Line 2 - Exempt Sales', key: 'exemptSales', description: 'Tax-exempt sales' },
      { name: 'Line 3 - Taxable Amount', key: 'taxableSales', description: 'Line 1 minus Line 2' },
      { name: 'Line 4 - State Tax (6%)', key: 'stateTax', description: 'Line 3 Ã— 0.06' },
      { name: 'Line 5 - County Surtax', key: 'surtax', description: 'Discretionary sales surtax (varies by county)' },
      { name: 'Line 6 - Total Tax Due', key: 'totalTax', description: 'Line 4 + Line 5' },
    ],
    note: 'Florida has 6% state rate plus county surtax (0-2.5%). Use customer shipping address to determine county.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      exemptSales: 0,
      taxableSales: data.totalSales || data.sales || 0,
      stateTax: (data.totalSales || data.sales || 0) * 0.06,
      surtax: 0,
      totalTax: data.taxOwed || data.tax || 0,
    }),
  },
  CA: {
    name: 'California',
    formName: 'CDTFA-401 - State, Local, and District Sales and Use Tax Return',
    website: 'https://onlineservices.cdtfa.ca.gov/',
    fields: [
      { name: 'Line 1 - Total Gross Sales', key: 'grossSales', description: 'Total of all sales' },
      { name: 'Line 2 - Purchases Subject to Use Tax', key: 'useTaxPurchases', description: 'Usually $0 for sellers' },
      { name: 'Line 3 - Total', key: 'totalSubject', description: 'Line 1 + Line 2' },
      { name: 'Line 4 - Deductions', key: 'deductions', description: 'Nontaxable sales, exempt sales' },
      { name: 'Line 5 - Total Taxable', key: 'taxableSales', description: 'Line 3 minus Line 4' },
      { name: 'Line 6 - Tax Due', key: 'taxDue', description: 'Based on district tax rates' },
    ],
    note: 'CA requires district-level reporting. Base rate is 7.25% but varies by district (7.25%-10.75%). Use CDTFA online system.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      useTaxPurchases: 0,
      totalSubject: data.totalSales || data.sales || 0,
      deductions: 0,
      taxableSales: data.totalSales || data.sales || 0,
      taxDue: data.taxOwed || data.tax || 0,
    }),
  },
  NY: {
    name: 'New York',
    formName: 'Form ST-100 - New York State and Local Sales and Use Tax Return',
    website: 'https://www.tax.ny.gov/bus/st/stidx.htm',
    fields: [
      { name: 'Part 1 - Gross Sales', key: 'grossSales', description: 'Gross sales and services' },
      { name: 'Part 1 - Non-Taxable Sales', key: 'nonTaxable', description: 'Exempt sales, clothing under $110' },
      { name: 'Part 1 - Taxable Sales', key: 'taxableSales', description: 'Gross minus non-taxable' },
      { name: 'Part 2 - State Tax (4%)', key: 'stateTax', description: 'Taxable Ã— 0.04' },
      { name: 'Part 2 - Local Tax', key: 'localTax', description: 'Varies by jurisdiction (0-4.875%)' },
      { name: 'Total Tax Due', key: 'totalTax', description: 'State + Local' },
    ],
    note: 'NY exempts clothing/footwear under $110. NYC has 4.5% local tax. Use Schedule H for jurisdiction breakdown.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      nonTaxable: 0,
      taxableSales: data.totalSales || data.sales || 0,
      stateTax: (data.totalSales || data.sales || 0) * 0.04,
      localTax: 0,
      totalTax: data.taxOwed || data.tax || 0,
    }),
  },
  OH: {
    name: 'Ohio',
    formName: 'UST 1 - Universal Sales Tax Return',
    website: 'https://tax.ohio.gov/sales_and_use.aspx',
    fields: [
      { name: 'Line 1 - Gross Receipts', key: 'grossSales', description: 'Total gross receipts' },
      { name: 'Line 2 - Exempt Sales', key: 'exemptSales', description: 'Non-taxable transactions' },
      { name: 'Line 3 - Net Taxable Sales', key: 'taxableSales', description: 'Line 1 minus Line 2' },
      { name: 'Line 4 - Tax Collected', key: 'taxCollected', description: 'Total tax collected' },
    ],
    note: 'Ohio has 5.75% state rate plus county taxes (0.75%-2.25%). Use county of delivery.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      exemptSales: 0,
      taxableSales: data.totalSales || data.sales || 0,
      taxCollected: data.taxOwed || data.tax || 0,
    }),
  },
  NC: {
    name: 'North Carolina',
    formName: 'Form E-500 - Sales and Use Tax Return',
    website: 'https://www.ncdor.gov/taxes-forms/sales-and-use-tax',
    fields: [
      { name: 'Line 1 - Gross Receipts', key: 'grossSales', description: 'Total gross receipts' },
      { name: 'Line 2 - Exempt Receipts', key: 'exemptSales', description: 'Tax-exempt sales' },
      { name: 'Line 3 - Net Taxable Sales', key: 'taxableSales', description: 'Line 1 minus Line 2' },
      { name: 'Line 4 - State Tax (4.75%)', key: 'stateTax', description: 'Line 3 Ã— 0.0475' },
      { name: 'Line 5 - Local Tax (2-2.75%)', key: 'localTax', description: 'County tax rate varies' },
      { name: 'Line 6 - Total Tax', key: 'totalTax', description: 'Line 4 + Line 5' },
    ],
    note: 'NC has 4.75% state + 2-2.75% county. Combined rates range 6.75%-7.5%. Use destination county.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      exemptSales: 0,
      taxableSales: data.totalSales || data.sales || 0,
      stateTax: (data.totalSales || data.sales || 0) * 0.0475,
      localTax: 0,
      totalTax: data.taxOwed || data.tax || 0,
    }),
  },
  GA: {
    name: 'Georgia',
    formName: 'Form ST-3 - Sales and Use Tax Return',
    website: 'https://gtc.dor.ga.gov/',
    fields: [
      { name: 'Line 1 - Gross Sales', key: 'grossSales', description: 'Gross sales, use, and withdrawals' },
      { name: 'Line 2 - Deductions', key: 'deductions', description: 'Exempt and non-taxable sales' },
      { name: 'Line 3 - Taxable Sales', key: 'taxableSales', description: 'Line 1 minus Line 2' },
      { name: 'Line 4 - State Tax (4%)', key: 'stateTax', description: 'Line 3 Ã— 0.04' },
      { name: 'Line 5 - Local Tax', key: 'localTax', description: 'LOST/SPLOST varies by jurisdiction' },
      { name: 'Line 6 - Total Tax', key: 'totalTax', description: 'Line 4 + Line 5' },
    ],
    note: 'GA has 4% state rate + 3-4% local option taxes. Combined rates 7-9%. File through Georgia Tax Center.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      deductions: 0,
      taxableSales: data.totalSales || data.sales || 0,
      stateTax: (data.totalSales || data.sales || 0) * 0.04,
      localTax: 0,
      totalTax: data.taxOwed || data.tax || 0,
    }),
  },
  NJ: {
    name: 'New Jersey',
    formName: 'Form ST-50 - Sales and Use Tax Return',
    website: 'https://www.state.nj.us/treasury/taxation/su.shtml',
    fields: [
      { name: 'Line 1 - Gross Receipts', key: 'grossSales', description: 'Total gross receipts' },
      { name: 'Line 2 - Non-Taxable Sales', key: 'exemptSales', description: 'Exempt sales' },
      { name: 'Line 3 - Taxable Sales', key: 'taxableSales', description: 'Line 1 minus Line 2' },
      { name: 'Line 4 - Tax Due (6.625%)', key: 'taxDue', description: 'Line 3 Ã— 0.06625' },
    ],
    note: 'NJ has single statewide 6.625% rate. No local taxes. Urban Enterprise Zones may have reduced rates.',
    calculate: (data) => ({
      grossSales: data.totalSales || data.sales || 0,
      exemptSales: 0,
      taxableSales: data.totalSales || data.sales || 0,
      taxDue: data.taxOwed || data.tax || 0,
    }),
  },
  // Generic format for states without specific config
  OK: {
    name: 'Oklahoma',
    formName: 'Form STS 20002 - Sales Tax Return',
    website: 'https://oktap.tax.ok.gov/',
    requiresJurisdictions: true,  // Flag for jurisdiction-level reporting
    jurisdictionType: 'county',
    fields: [
      { name: 'State Tax (4.5%)', key: 'stateTax', description: 'Total state tax collected' },
      { name: 'County/City Taxes', key: 'localTax', description: 'Breakdown by jurisdiction required' },
      { name: 'Total Tax Due', key: 'totalTax', description: 'State + Local' },
    ],
    note: 'Oklahoma requires county/city breakdown. Use OkTAP portal to report by jurisdiction. Local rates vary (0-6.5% additional).',
    calculate: (data, stateInfo) => ({
      stateTax: (data.totalSales || data.sales || 0) * 0.045,
      localTax: (data.taxOwed || data.tax || 0) - ((data.totalSales || data.sales || 0) * 0.045),
      totalTax: data.taxOwed || data.tax || 0,
    }),
    exportFormat: 'jurisdiction', // Triggers jurisdiction-level CSV export
  },
  CO: {
    name: 'Colorado',
    formName: 'DR 0100 - Colorado Retail Sales Tax Return',
    website: 'https://mytax.colorado.gov/',
    requiresJurisdictions: true,
    jurisdictionType: 'city/county',
    fields: [
      { name: 'State Tax (2.9%)', key: 'stateTax', description: 'State sales tax' },
      { name: 'RTD/CD/FD Taxes', key: 'specialTax', description: 'Regional transit, cultural, football district taxes' },
      { name: 'County Taxes', key: 'countyTax', description: 'Breakdown by county' },
      { name: 'City/Local Taxes', key: 'cityTax', description: 'Home rule cities require separate filing!' },
      { name: 'Total Tax Due', key: 'totalTax', description: 'All taxes' },
    ],
    note: 'Colorado home rule cities (Denver, Aurora, Colorado Springs, etc.) require SEPARATE registration and filing directly with the city. State-administered localities can be filed together.',
    calculate: (data, stateInfo) => ({
      stateTax: (data.totalSales || data.sales || 0) * 0.029,
      specialTax: 0,
      countyTax: 0,
      cityTax: (data.taxOwed || data.tax || 0) - ((data.totalSales || data.sales || 0) * 0.029),
      totalTax: data.taxOwed || data.tax || 0,
    }),
    exportFormat: 'jurisdiction',
  },
  KS: {
    name: 'Kansas',
    formName: 'ST-36 - Retailers Sales Tax Return',
    website: 'https://www.ksrevenue.gov/custservsalestax.html',
    requiresJurisdictions: true,
    jurisdictionType: 'jurisdiction',
    fields: [
      { name: 'Gross Sales', key: 'grossSales', description: 'Total sales' },
      { name: 'Exempt Sales', key: 'exemptSales', description: 'Non-taxable sales' },
      { name: 'Taxable Sales', key: 'taxableSales', description: 'Gross minus exempt' },
      { name: 'Tax by Jurisdiction', key: 'jurisdictionTax', description: 'Breakdown by city/county' },
    ],
    note: 'Kansas requires jurisdiction-level reporting. Use StreamlinedSalesTax.org or the Kansas WebFile system.',
    calculate: (data, stateInfo) => ({
      grossSales: data.totalSales || data.sales || 0,
      exemptSales: 0,
      taxableSales: data.totalSales || data.sales || 0,
      jurisdictionTax: data.taxOwed || data.tax || 0,
    }),
    exportFormat: 'jurisdiction',
  },
  LA: {
    name: 'Louisiana',
    formName: 'R-1029 - Louisiana Sales Tax Return',
    website: 'https://latap.revenue.louisiana.gov/',
    requiresJurisdictions: true,
    jurisdictionType: 'parish',
    fields: [
      { name: 'State Tax (4.45%)', key: 'stateTax', description: 'State sales tax' },
      { name: 'Parish Taxes', key: 'parishTax', description: 'Local parish taxes (vary widely)' },
      { name: 'Total Tax Due', key: 'totalTax', description: 'State + Parish' },
    ],
    note: 'Louisiana requires parish-level reporting. Remote sellers can use the Louisiana Sales & Use Tax Commission single return for most parishes.',
    calculate: (data, stateInfo) => ({
      stateTax: (data.totalSales || data.sales || 0) * 0.0445,
      parishTax: (data.taxOwed || data.tax || 0) - ((data.totalSales || data.sales || 0) * 0.0445),
      totalTax: data.taxOwed || data.tax || 0,
    }),
    exportFormat: 'jurisdiction',
  },
  DEFAULT: {
    name: 'Standard',
    formName: 'State Sales Tax Return',
    website: null,
    fields: [
      { name: 'Gross Sales', key: 'grossSales', description: 'Total sales shipped to state' },
      { name: 'Exempt Sales', key: 'exemptSales', description: 'Non-taxable sales' },
      { name: 'Net Taxable Sales', key: 'taxableSales', description: 'Gross minus exempt' },
      { name: 'Tax Collected', key: 'taxCollected', description: 'Tax you collected on orders' },
    ],
    calculate: (data, stateInfo) => ({
      grossSales: data.totalSales || data.sales || 0,
      exemptSales: 0,
      taxableSales: data.totalSales || data.sales || 0,
      taxCollected: data.taxOwed || data.tax || 0,
    }),
  },
};

// Filing frequency due date calculator
const getNextDueDate = (frequency, stateCode) => {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const currentDay = now.getDate();
  
  // Most states have 20th of month due dates, some vary
  const dueDayOfMonth = 20;
  
  if (frequency === 'monthly') {
    // Due 20th of following month
    let dueMonth = currentMonth + 1;
    let dueYear = currentYear;
    if (dueMonth > 11) { dueMonth = 0; dueYear++; }
    const dueDate = new Date(dueYear, dueMonth, dueDayOfMonth);
    if (dueDate <= now) {
      dueMonth++;
      if (dueMonth > 11) { dueMonth = 0; dueYear++; }
      return new Date(dueYear, dueMonth, dueDayOfMonth);
    }
    return dueDate;
  } else if (frequency === 'quarterly') {
    // Q1 (Jan-Mar) due Apr 20, Q2 (Apr-Jun) due Jul 20, Q3 (Jul-Sep) due Oct 20, Q4 (Oct-Dec) due Jan 20
    const quarterEnds = [[3, 20], [6, 20], [9, 20], [0, 20]]; // [month, day]
    const quarterYears = [0, 0, 0, 1]; // year offset
    for (let i = 0; i < 4; i++) {
      const [m, d] = quarterEnds[i];
      const y = currentYear + quarterYears[i];
      const dueDate = new Date(y, m, d);
      if (dueDate > now) return dueDate;
    }
    return new Date(currentYear + 1, 3, 20);
  } else if (frequency === 'semi-annual') {
    // Jan-Jun due Jul 20, Jul-Dec due Jan 20
    const h1Due = new Date(currentYear, 6, 20); // Jul 20
    const h2Due = new Date(currentYear + 1, 0, 20); // Jan 20 next year
    if (h1Due > now) return h1Due;
    if (h2Due > now) return h2Due;
    return new Date(currentYear + 1, 6, 20);
  } else if (frequency === 'annual') {
    // Due Jan 20 of following year
    const dueDate = new Date(currentYear + 1, 0, 20);
    if (dueDate <= now) return new Date(currentYear + 2, 0, 20);
    return dueDate;
  }
  return new Date(currentYear, currentMonth + 1, 20);
};

// Parse Shopify tax report - handles jurisdiction-based reports
const parseShopifyTaxReport = (csvData, stateCode) => {
  const stateInfo = US_STATES_TAX_INFO[stateCode];
  const result = {
    state: stateCode,
    stateName: stateInfo?.name || stateCode,
    periodStart: null,
    periodEnd: null,
    totalSales: 0,
    totalTaxableSales: 0,
    totalExemptSales: 0,
    totalTaxCollected: 0,
    stateTax: 0,
    countyTax: 0,
    cityTax: 0,
    specialTax: 0,
    jurisdictions: [],
    byType: { state: [], county: [], city: [], special: [] }
  };
  
  csvData.forEach(row => {
    const jurisdiction = row['Tax jurisdiction'] || '';
    const type = (row['Tax jurisdiction type'] || '').toLowerCase();
    const county = (row['Tax county'] || '').trim();
    const code = row['Tax jurisdiction code'] || '';
    const rate = parseFloat(row['Tax rate'] || 0);
    const totalSales = parseFloat(row['Total net item sales'] || 0);
    const taxableSales = parseFloat(row['Total taxable item sales'] || 0);
    const exemptSales = parseFloat(row['Total exempt and non-taxable item sales'] || 0);
    const itemTax = parseFloat(row['Total item tax amount'] || 0);
    const shippingTax = parseFloat(row['Total shipping tax amount'] || 0);
    const totalTax = itemTax + shippingTax;
    
    result.totalSales += totalSales;
    result.totalTaxableSales += taxableSales;
    result.totalExemptSales += exemptSales;
    result.totalTaxCollected += totalTax;
    
    const jurisdictionData = {
      name: jurisdiction,
      type,
      county: county.replace(' -', '').trim(),
      code,
      rate,
      totalSales,
      taxableSales,
      exemptSales,
      taxAmount: totalTax
    };
    
    result.jurisdictions.push(jurisdictionData);
    
    if (type === 'state') {
      result.stateTax += totalTax;
      result.byType.state.push(jurisdictionData);
    } else if (type === 'county') {
      result.countyTax += totalTax;
      result.byType.county.push(jurisdictionData);
    } else if (type === 'city') {
      result.cityTax += totalTax;
      result.byType.city.push(jurisdictionData);
    } else {
      result.specialTax += totalTax;
      result.byType.special.push(jurisdictionData);
    }
  });
  
  return result;
};

const combinedData = useMemo(() => ({
  sales: allWeeksData,
  dailySales: allDaysData, // Daily data
  inventory: invHistory,
  cogs: { lookup: savedCogs, updatedAt: cogsLastUpdated },
  periods: allPeriodsData,
  storeName,
  storeLogo,
  salesTax: salesTaxConfig,
  settings: appSettings,
  // New features
  invoices,
  amazonForecasts,
  forecastMeta,
  weekNotes,
  goals,
  productNames: savedProductNames,
  theme,
  widgetConfig,
  productionPipeline,
  threeplLedger,
  amazonCampaigns,
  // Self-learning forecast data
  forecastAccuracyHistory,
  forecastCorrections,
  // AI-powered forecasts
  aiForecasts,
  // Modular AI system
  leadTimeSettings,
  aiForecastModule,
  aiLearningHistory,
  // UNIFIED AI MODEL - single source of truth for all learning
  unifiedAIModel,
  // AI Reports & Chat
  weeklyReports,
  aiMessages, // Chat history
  // Banking data
  bankingData,
  // Recurring expenses
  confirmedRecurring,
  // Shopify Integration credentials
  shopifyCredentials,
}), [allWeeksData, allDaysData, invHistory, savedCogs, cogsLastUpdated, allPeriodsData, storeName, storeLogo, salesTaxConfig, appSettings, invoices, amazonForecasts, forecastMeta, weekNotes, goals, savedProductNames, theme, widgetConfig, productionPipeline, threeplLedger, amazonCampaigns, forecastAccuracyHistory, forecastCorrections, aiForecasts, leadTimeSettings, aiForecastModule, aiLearningHistory, unifiedAIModel, weeklyReports, aiMessages, bankingData, confirmedRecurring, shopifyCredentials]);

const loadFromLocal = useCallback(() => {
  try {
    const r = lsGet(STORAGE_KEY);
    if (r) {
      const d = JSON.parse(r);
      setAllWeeksData(d);
      const w = Object.keys(d).sort().reverse();
      if (w.length) { setSelectedWeek(w[0]); }
    }
  } catch {}

  // Load daily data
  try {
    const r = lsGet('ecommerce_daily_sales_v1');
    if (r) setAllDaysData(JSON.parse(r));
  } catch {}

  try {
    const r = lsGet(INVENTORY_KEY);
    if (r) setInvHistory(JSON.parse(r));
  } catch {}

  try {
    const r = lsGet(COGS_KEY);
    if (r) {
      const d = JSON.parse(r);
      setSavedCogs(d.lookup || {});
      setCogsLastUpdated(d.updatedAt || null);
    }
  } catch {}

  // Load product names
  try {
    const names = lsGet(PRODUCT_NAMES_KEY);
    if (names) setSavedProductNames(JSON.parse(names));
  } catch {}

  try {
    const r = lsGet(PERIODS_KEY);
    if (r) setAllPeriodsData(JSON.parse(r));
  } catch {}

  try {
    const r = lsGet(STORE_KEY);
    if (r) setStoreName(r);
  } catch {}

  try {
    const r = lsGet(GOALS_KEY);
    if (r) setGoals(JSON.parse(r));
  } catch {}

  try {
    const r = lsGet(SALES_TAX_KEY);
    if (r) setSalesTaxConfig(JSON.parse(r));
  } catch {}

  try {
    const r = lsGet(SETTINGS_KEY);
    if (r) setAppSettings(prev => ({ ...prev, ...JSON.parse(r) }));
  } catch {}

  try {
    const r = lsGet(THREEPL_LEDGER_KEY);
    if (r) setThreeplLedger(JSON.parse(r));
  } catch {}

  // Load Shopify credentials from localStorage
  try {
    const r = lsGet('ecommerce_shopify_creds_v1');
    if (r) setShopifyCredentials(JSON.parse(r));
  } catch {}
}, []);

// Sync 3PL ledger costs to weekly data when ledger changes
// This ensures profit calculations are accurate even if 3PL data was uploaded separately
useEffect(() => {
  if (!threeplLedger?.orders || Object.keys(threeplLedger.orders).length === 0) return;
  if (Object.keys(allWeeksData).length === 0) return;
  
  // Get unique week keys from ledger
  const ledgerWeeks = new Set(Object.values(threeplLedger.orders).map(o => o.weekKey).filter(Boolean));
  if (ledgerWeeks.size === 0) return;
  
  let needsUpdate = false;
  const updatedWeeks = { ...allWeeksData };
  
  ledgerWeeks.forEach(weekKey => {
    if (!updatedWeeks[weekKey]) return;
    
    // Calculate 3PL costs from ledger
    const ledger3PL = get3PLForWeek(threeplLedger, weekKey);
    const ledgerCost = ledger3PL?.metrics?.totalCost || 0;
    const currentCost = updatedWeeks[weekKey].shopify?.threeplCosts || 0;
    
    // Only update if ledger has more cost data than current
    if (ledgerCost > 0 && Math.abs(ledgerCost - currentCost) > 0.01) {
      const oldCost = currentCost;
      const shopProfit = (updatedWeeks[weekKey].shopify?.netProfit || 0) + oldCost - ledgerCost;
      
      updatedWeeks[weekKey] = {
        ...updatedWeeks[weekKey],
        shopify: {
          ...updatedWeeks[weekKey].shopify,
          threeplCosts: ledgerCost,
          threeplBreakdown: ledger3PL?.breakdown || updatedWeeks[weekKey].shopify?.threeplBreakdown,
          threeplMetrics: ledger3PL?.metrics || updatedWeeks[weekKey].shopify?.threeplMetrics,
          netProfit: shopProfit,
          netMargin: updatedWeeks[weekKey].shopify?.revenue > 0 ? (shopProfit / updatedWeeks[weekKey].shopify.revenue) * 100 : 0,
        },
        total: {
          ...updatedWeeks[weekKey].total,
          netProfit: (updatedWeeks[weekKey].amazon?.netProfit || 0) + shopProfit,
          netMargin: updatedWeeks[weekKey].total?.revenue > 0 ? (((updatedWeeks[weekKey].amazon?.netProfit || 0) + shopProfit) / updatedWeeks[weekKey].total.revenue) * 100 : 0,
        }
      };
      needsUpdate = true;
    }
  });
  
  if (needsUpdate) {
    setAllWeeksData(updatedWeeks);
    save(updatedWeeks);
  }
}, [threeplLedger]); // Only re-run when threeplLedger changes

const saveGoals = useCallback((newGoals) => {
  setGoals(newGoals);
  lsSet(GOALS_KEY, JSON.stringify(newGoals));
  setShowGoalsModal(false);
}, []);

const saveSalesTax = useCallback((newConfig) => {
  setSalesTaxConfig(newConfig);
  lsSet(SALES_TAX_KEY, JSON.stringify(newConfig));
}, []);

const saveSettings = useCallback((newSettings) => {
  setAppSettings(newSettings);
  lsSet(SETTINGS_KEY, JSON.stringify(newSettings));
}, []);

const writeToLocal = useCallback((key, value) => {
  lsSet(key, value);
}, []);

const pushToCloudNow = useCallback(async (dataObj) => {
  if (!supabase || !session?.user?.id) return;
  setCloudStatus('Savingâ€¦');
  const payload = {
    user_id: session.user.id,
    data: { 
      stores: stores,
      activeStoreId: activeStoreId,
      storeData: {
        [activeStoreId || 'default']: dataObj
      }
    },
    updated_at: new Date().toISOString(),
  };
  
  // Merge with existing stores data to preserve other stores
  const { data: existingData } = await supabase
    .from('app_data')
    .select('data')
    .eq('user_id', session.user.id)
    .maybeSingle();
  
  if (existingData?.data?.storeData) {
    payload.data.storeData = {
      ...existingData.data.storeData,
      [activeStoreId || 'default']: dataObj
    };
    payload.data.stores = existingData.data.stores || stores;
  }
  
  const { error } = await supabase.from('app_data').upsert(payload, { onConflict: 'user_id' });
  if (error) {
    setCloudStatus('Save failed (offline?)');
    return;
  }
  lastSavedRef.current = Date.now();
  setLastSyncDate(new Date().toISOString());
  setCloudStatus('Saved');
  setTimeout(() => setCloudStatus(''), 1500);
}, [session, stores, activeStoreId]);

const queueCloudSave = useCallback((nextDataObj) => {
  if (!session?.user?.id || !supabase) return;
  if (isLoadingDataRef.current) return;

  if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
  saveTimerRef.current = setTimeout(() => {
    pushToCloudNow(nextDataObj);
  }, 800);
}, [session, pushToCloudNow]);

const save3PLLedger = useCallback((newLedger) => {
  setThreeplLedger(newLedger);
  lsSet(THREEPL_LEDGER_KEY, JSON.stringify(newLedger));
  queueCloudSave({ ...combinedData, threeplLedger: newLedger });
}, [combinedData, queueCloudSave]);

// Store name persistence
useEffect(() => {
  try {
    if (storeName !== undefined) writeToLocal(STORE_KEY, storeName || '');
  } catch {}
  queueCloudSave({ ...combinedData, storeName });
}, [storeName]);

// Sync new features to cloud when they change
useEffect(() => {
  if (!session?.user?.id || !supabase) return;
  if (isLoadingDataRef.current) return; // Don't sync during initial load
  queueCloudSave(combinedData);
}, [invoices, amazonForecasts, weekNotes, goals, savedProductNames, theme, productionPipeline, allDaysData, bankingData, confirmedRecurring, shopifyCredentials]);

// Persist Shopify credentials to localStorage for offline backup
useEffect(() => {
  if (shopifyCredentials.storeUrl || shopifyCredentials.connected) {
    try {
      lsSet('ecommerce_shopify_creds_v1', JSON.stringify(shopifyCredentials));
    } catch {}
  }
}, [shopifyCredentials]);

const loadFromCloud = useCallback(async (storeId = null) => {
  if (!supabase || !session?.user?.id) return { ok: false, stores: [] };
  setCloudStatus('Loadingâ€¦');
  
  try {
    const { data, error } = await supabase
      .from('app_data')
      .select('data')
      .eq('user_id', session.user.id)
      .maybeSingle();

    if (error) {
      console.error('Cloud load error:', error);
      setCloudStatus('');
      return { ok: false, stores: [] };
    }
    if (!data?.data) {
      setCloudStatus('');
      return { ok: false, stores: [] };
    }

    const cloudData = data.data || {};
    
    // Handle multi-store structure
    const loadedStores = cloudData.stores || [];
    if (loadedStores.length > 0) {
      setStores(loadedStores);
    }
    
    // Determine which store to load
    const targetStoreId = storeId || cloudData.activeStoreId || (loadedStores[0]?.id) || 'default';
    setActiveStoreId(targetStoreId);
    
    // Get store-specific data (support both old and new format)
    let cloud;
    if (cloudData.storeData && cloudData.storeData[targetStoreId]) {
      cloud = cloudData.storeData[targetStoreId];
    } else if (cloudData.storeData?.default) {
      cloud = cloudData.storeData.default;
    } else {
      // Legacy format - data is directly in cloudData
      cloud = cloudData;
    }

    // Apply cloud data to state
    isLoadingDataRef.current = true;
    
    setAllWeeksData(cloud.sales || {});
    setAllDaysData(cloud.dailySales || {}); // Load daily data
    const w = Object.keys(cloud.sales || {}).sort().reverse();
    if (w.length) { setSelectedWeek(w[0]); }
    setInvHistory(cloud.inventory || {});
    setSavedCogs(cloud.cogs?.lookup || {});
    setCogsLastUpdated(cloud.cogs?.updatedAt || null);
    setAllPeriodsData(cloud.periods || {});
    setStoreName(cloud.storeName || '');
    
    // CRITICAL: Sync the stores array name with the loaded store's actual name
    // This ensures the dropdown shows the correct name for the active store
    if (cloud.storeName && loadedStores.length > 0) {
      const updatedStores = loadedStores.map(s => 
        s.id === targetStoreId ? { ...s, name: cloud.storeName } : s
      );
      // Only update if there's actually a change
      const storeChanged = loadedStores.find(s => s.id === targetStoreId)?.name !== cloud.storeName;
      if (storeChanged) {
        setStores(updatedStores);
      }
    }
    
    if (cloud.storeLogo) setStoreLogo(cloud.storeLogo);
    setSalesTaxConfig(cloud.salesTax || { nexusStates: {}, filingHistory: {}, hiddenStates: [] });
    if (cloud.settings) setAppSettings(prev => ({ ...prev, ...cloud.settings }));
    
    // Load new features from cloud
    if (cloud.invoices) setInvoices(cloud.invoices);
    if (cloud.amazonForecasts) setAmazonForecasts(cloud.amazonForecasts);
    if (cloud.forecastMeta) setForecastMeta(cloud.forecastMeta);
    if (cloud.weekNotes) setWeekNotes(cloud.weekNotes);
    if (cloud.goals) setGoals(cloud.goals);
    if (cloud.productNames) setSavedProductNames(cloud.productNames);
    if (cloud.theme) setTheme(cloud.theme);
    if (cloud.widgetConfig) setWidgetConfig(cloud.widgetConfig);
    if (cloud.productionPipeline) setProductionPipeline(cloud.productionPipeline);
    if (cloud.threeplLedger) setThreeplLedger(cloud.threeplLedger);
    if (cloud.amazonCampaigns) setAmazonCampaigns(cloud.amazonCampaigns);
    
    // Load self-learning forecast data
    if (cloud.forecastAccuracyHistory) setForecastAccuracyHistory(cloud.forecastAccuracyHistory);
    if (cloud.forecastCorrections) setForecastCorrections(cloud.forecastCorrections);
    if (cloud.aiForecasts) setAiForecasts(cloud.aiForecasts);
    if (cloud.leadTimeSettings) setLeadTimeSettings(cloud.leadTimeSettings);
    if (cloud.aiForecastModule) setAiForecastModule(cloud.aiForecastModule);
    if (cloud.aiLearningHistory) setAiLearningHistory(cloud.aiLearningHistory);
    if (cloud.unifiedAIModel) setUnifiedAIModel(cloud.unifiedAIModel);
    if (cloud.weeklyReports) setWeeklyReports(cloud.weeklyReports);
    if (cloud.aiMessages) setAiMessages(cloud.aiMessages);
    if (cloud.bankingData) setBankingData(cloud.bankingData);
    if (cloud.confirmedRecurring) setConfirmedRecurring(cloud.confirmedRecurring);
    if (cloud.shopifyCredentials) setShopifyCredentials(cloud.shopifyCredentials);

    // Also keep localStorage in sync for offline backup
    writeToLocal(STORAGE_KEY, JSON.stringify(cloud.sales || {}));
    writeToLocal('ecommerce_daily_sales_v1', JSON.stringify(cloud.dailySales || {})); // Daily data localStorage
    writeToLocal(INVENTORY_KEY, JSON.stringify(cloud.inventory || {}));
    writeToLocal(COGS_KEY, JSON.stringify({ lookup: cloud.cogs?.lookup || {}, updatedAt: cloud.cogs?.updatedAt || null }));
    writeToLocal(PERIODS_KEY, JSON.stringify(cloud.periods || {}));
    writeToLocal(STORE_KEY, cloud.storeName || '');
    if (cloud.storeLogo) localStorage.setItem('ecommerce_store_logo', cloud.storeLogo);
    writeToLocal(SALES_TAX_KEY, JSON.stringify(cloud.salesTax || { nexusStates: {}, filingHistory: {}, hiddenStates: [] }));
    if (cloud.settings) writeToLocal(SETTINGS_KEY, JSON.stringify(cloud.settings));
    if (cloud.invoices) writeToLocal(INVOICES_KEY, JSON.stringify(cloud.invoices));
    if (cloud.amazonForecasts) writeToLocal(AMAZON_FORECAST_KEY, JSON.stringify(cloud.amazonForecasts));
    if (cloud.forecastMeta) writeToLocal('ecommerce_forecast_meta_v1', JSON.stringify(cloud.forecastMeta));
    if (cloud.weekNotes) writeToLocal(NOTES_KEY, JSON.stringify(cloud.weekNotes));
    if (cloud.goals) writeToLocal(GOALS_KEY, JSON.stringify(cloud.goals));
    if (cloud.productNames) writeToLocal(PRODUCT_NAMES_KEY, JSON.stringify(cloud.productNames));
    if (cloud.theme) writeToLocal(THEME_KEY, JSON.stringify(cloud.theme));
    if (cloud.widgetConfig) writeToLocal('ecommerce_widget_config_v1', JSON.stringify(cloud.widgetConfig));
    if (cloud.productionPipeline) localStorage.setItem('ecommerce_production_v1', JSON.stringify(cloud.productionPipeline));
    if (cloud.threeplLedger) writeToLocal(THREEPL_LEDGER_KEY, JSON.stringify(cloud.threeplLedger));
    if (cloud.amazonCampaigns) writeToLocal('ecommerce_amazon_campaigns_v1', JSON.stringify(cloud.amazonCampaigns));
    
    // Sync self-learning forecast data to localStorage
    if (cloud.forecastAccuracyHistory) writeToLocal(FORECAST_ACCURACY_KEY, JSON.stringify(cloud.forecastAccuracyHistory));
    if (cloud.forecastCorrections) writeToLocal(FORECAST_CORRECTIONS_KEY, JSON.stringify(cloud.forecastCorrections));
    if (cloud.aiForecasts) writeToLocal('ecommerce_ai_forecasts_v1', JSON.stringify(cloud.aiForecasts));
    if (cloud.leadTimeSettings) writeToLocal('ecommerce_lead_times_v1', JSON.stringify(cloud.leadTimeSettings));
    if (cloud.aiLearningHistory) writeToLocal('ecommerce_ai_learning_v1', JSON.stringify(cloud.aiLearningHistory));
    if (cloud.unifiedAIModel) writeToLocal('ecommerce_unified_ai_v1', JSON.stringify(cloud.unifiedAIModel));
    if (cloud.weeklyReports) writeToLocal(WEEKLY_REPORTS_KEY, JSON.stringify(cloud.weeklyReports));
    if (cloud.aiMessages && cloud.aiMessages.length > 0) writeToLocal('ecommerce_ai_chat_history_v1', JSON.stringify(cloud.aiMessages));
    if (cloud.bankingData) writeToLocal('ecommerce_banking_v1', JSON.stringify(cloud.bankingData));
    if (cloud.confirmedRecurring) writeToLocal('ecommerce_recurring_v1', JSON.stringify(cloud.confirmedRecurring));
    if (cloud.shopifyCredentials) writeToLocal('ecommerce_shopify_creds_v1', JSON.stringify(cloud.shopifyCredentials));

    setCloudStatus('');
    return { ok: true, stores: loadedStores };
  } catch (err) {
    console.error('Cloud load unexpected error:', err);
    setCloudStatus('');
    return { ok: false, stores: [] };
  } finally {
    isLoadingDataRef.current = false;
  }
}, [session, writeToLocal]);

// Store management functions
const createStore = useCallback(async (name) => {
  if (!name.trim()) return;
  const newStore = {
    id: `store_${Date.now()}`,
    name: name.trim(),
    createdAt: new Date().toISOString(),
  };
  const updatedStores = [...stores, newStore];
  
  // Clear current data for new store - COMPLETE LIST
  const emptyData = {
    sales: {},
    dailySales: {},
    inventory: {},
    cogs: { lookup: {}, updatedAt: null },
    periods: {},
    storeName: name.trim(),
    storeLogo: '',
    salesTax: { nexusStates: {}, hiddenStates: [], filingHistory: {} },
    settings: appSettings,
    invoices: [],
    amazonForecasts: {},
    forecastMeta: { lastUploads: {}, history: [] },
    weekNotes: {},
    goals,
    productNames: {},
    theme,
    widgetConfig: null,
    productionPipeline: [],
    threeplLedger: { orders: [], importedFiles: [], summaryCharges: {} },
    amazonCampaigns: { campaigns: [], history: [], lastUpdated: null },
    forecastAccuracyHistory: { records: [], lastUpdated: null, modelVersion: '1.0' },
    forecastCorrections: { overall: { revenue: 1, units: 1, profit: 1 }, bySku: {}, byMonth: {}, byQuarter: {}, confidence: 0, samplesUsed: 0 },
    aiForecasts: {},
    leadTimeSettings: {},
    aiForecastModule: null,
    aiLearningHistory: { predictions: [], modelUpdates: [] },
    weeklyReports: {},
    aiMessages: [],
    // Banking data for new store
    bankingData: {
      transactions: [],
      accounts: {},
      categories: {},
      monthlySnapshots: {},
      dateRange: null,
      transactionCount: 0,
      lastUpload: null,
      categoryOverrides: {},
      settings: {},
    },
    // Shopify credentials for new store
    shopifyCredentials: { storeUrl: '', clientId: '', clientSecret: '', connected: false, lastSync: null },
  };
  
  // Save to cloud immediately with the new stores list
  if (supabase && session?.user?.id) {
    setCloudStatus('Creating storeâ€¦');
    try {
      // Get existing data first
      const { data: existingData } = await supabase
        .from('app_data')
        .select('data')
        .eq('user_id', session.user.id)
        .maybeSingle();
      
      const payload = {
        user_id: session.user.id,
        data: {
          stores: updatedStores,
          activeStoreId: newStore.id,
          storeData: {
            ...(existingData?.data?.storeData || {}),
            [newStore.id]: emptyData
          }
        },
        updated_at: new Date().toISOString(),
      };
      
      const { error } = await supabase.from('app_data').upsert(payload, { onConflict: 'user_id' });
      if (error) throw error;
      
      setCloudStatus('Store created');
      setTimeout(() => setCloudStatus(''), 1500);
    } catch (err) {
      console.error('Failed to save new store:', err);
      setCloudStatus('Save failed');
    }
  }
  
  // Update local state - COMPLETE LIST
  setStores(updatedStores);
  setActiveStoreId(newStore.id);
  setNewStoreName('');
  setAllWeeksData({});
  setAllDaysData({});
  setAllPeriodsData({});
  setInvHistory({});
  setStoreName(name.trim());
  setInvoices([]);
  setAmazonForecasts({});
  setThreeplLedger({ orders: [], importedFiles: [], summaryCharges: {} });
  setSavedCogs({});
  setSavedProductNames({});
  setStoreLogo('');
  setBankingData({
    transactions: [],
    accounts: {},
    categories: {},
    monthlySnapshots: {},
    dateRange: null,
    transactionCount: 0,
    lastUpload: null,
    categoryOverrides: {},
    settings: {},
  });
  setForecastCorrections({ overall: { revenue: 1, units: 1, profit: 1 }, bySku: {}, byMonth: {}, byQuarter: {}, confidence: 0, samplesUsed: 0 });
  setAiLearningHistory({ predictions: [], modelUpdates: [] });
  setAiMessages([]);
  setWeeklyReports({});
  
  setToast({ message: `Created store "${name}"`, type: 'success' });
  setShowStoreSelector(false);
  setShowStoreModal(false);
}, [stores, session, appSettings, goals, theme]);

const switchStore = useCallback(async (storeId) => {
  if (storeId === activeStoreId) {
    setShowStoreSelector(false);
    setShowStoreModal(false);
    return;
  }
  
  // Save current store first
  await pushToCloudNow(combinedData);
  
  // Load new store - this will also set activeStoreId and sync storeName
  await loadFromCloud(storeId);
  
  // Get the store name (loadFromCloud will have synced it)
  const store = stores.find(s => s.id === storeId);
  setToast({ message: `Switched to "${store?.name || storeName || 'store'}"`, type: 'success' });
  setShowStoreSelector(false);
  setShowStoreModal(false);
}, [activeStoreId, stores, combinedData, pushToCloudNow, loadFromCloud, storeName]);

const deleteStore = useCallback(async (storeId) => {
  const store = stores.find(s => s.id === storeId);
  if (!store) {
    setToast({ message: 'Store not found', type: 'error' });
    return;
  }
  
  // Use window.confirm to ensure it works
  const confirmed = window.confirm(`Delete store "${store.name}"? All data will be permanently lost.`);
  if (!confirmed) return;
  
  // If this is the last store, create a new empty one
  let updatedStores = stores.filter(s => s.id !== storeId);
  let newActiveId;
  
  if (updatedStores.length === 0) {
    // Create a fresh default store
    const newStore = {
      id: `store_${Date.now()}`,
      name: 'My Store',
      createdAt: new Date().toISOString(),
    };
    updatedStores = [newStore];
    newActiveId = newStore.id;
  } else {
    newActiveId = storeId === activeStoreId ? updatedStores[0].id : activeStoreId;
  }
  
  // Update local state first
  setStores(updatedStores);
  setActiveStoreId(newActiveId);
  
  // Clear all data for fresh start if last store was deleted
  if (stores.length === 1) {
    // Reset all state to defaults
    setAllWeeksData({});
    setAllDaysData({});
    setInvHistory({});
    setAllPeriodsData({});
    setBankingData({
      transactions: [],
      lastUpload: null,
      accounts: {},
      categories: {},
      monthlySnapshots: {},
      categoryOverrides: {},
      settings: { reminderEnabled: true, reminderTime: '09:00' }
    });
    // Clear localStorage
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith('ecommerce_')) {
        localStorage.removeItem(key);
      }
    });
  }
  
  // Save updated stores list to cloud
  if (supabase && session?.user?.id) {
    try {
      const { data: existingData } = await supabase
        .from('app_data')
        .select('data')
        .eq('user_id', session.user.id)
        .maybeSingle();
      
      // Remove deleted store's data and update stores list
      const storeData = { ...(existingData?.data?.storeData || {}) };
      delete storeData[storeId];
      
      const payload = {
        user_id: session.user.id,
        data: {
          stores: updatedStores,
          activeStoreId: newActiveId,
          storeData
        },
        updated_at: new Date().toISOString(),
      };
      
      await supabase.from('app_data').upsert(payload, { onConflict: 'user_id' });
    } catch (err) {
      console.error('Failed to delete store from cloud:', err);
      setToast({ message: 'Deleted locally but cloud sync failed', type: 'warning' });
      return;
    }
  }
  
  // Load new store data if we switched
  if (storeId === activeStoreId && updatedStores.length > 0) {
    await loadFromCloud(newActiveId);
  }
  
  setToast({ message: `Deleted store "${store.name}"`, type: 'success' });
}, [stores, activeStoreId, loadFromCloud, session]);

// Store Selector Modal
const StoreSelectorModal = () => {
  if (!showStoreModal || !session) return null;
  
  const currentStore = stores.find(s => s.id === activeStoreId);
  
  return (
    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
      <div className="bg-slate-800 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-md">
        <div className="p-6 border-b border-slate-700">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold text-white flex items-center gap-2">
              <Store className="w-5 h-5" />
              My Stores
            </h2>
            <button onClick={() => setShowStoreModal(false)} className="text-slate-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
          <p className="text-slate-400 text-sm mt-1">Switch between stores or create a new one</p>
        </div>
        
        <div className="p-4 max-h-[50vh] overflow-y-auto">
          {/* Existing Stores */}
          {stores.length === 0 ? (
            <div className="text-center py-6 text-slate-500">
              <Store className="w-12 h-12 mx-auto mb-2 opacity-50" />
              <p>No stores yet. Create your first store below.</p>
            </div>
          ) : (
            <div className="space-y-2">
              {stores.map(store => (
                <div 
                  key={store.id}
                  className={`flex items-center justify-between p-3 rounded-xl border ${store.id === activeStoreId ? 'bg-violet-900/30 border-violet-500/50' : 'bg-slate-700/30 border-slate-600 hover:bg-slate-700/50'} cursor-pointer`}
                  onClick={() => { switchStore(store.id); setShowStoreModal(false); }}
                >
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${store.id === activeStoreId ? 'bg-violet-600' : 'bg-slate-600'}`}>
                      <Store className="w-5 h-5 text-white" />
                    </div>
                    <div>
                      <p className="text-white font-medium">{store.name}</p>
                      <p className="text-slate-400 text-xs">Created {new Date(store.createdAt).toLocaleDateString()}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    {store.id === activeStoreId && (
                      <span className="px-2 py-0.5 bg-violet-500 rounded text-xs text-white">Active</span>
                    )}
                    <button 
                      onClick={(e) => { 
                        e.preventDefault();
                        e.stopPropagation(); 
                        deleteStore(store.id); 
                      }}
                      className="p-1.5 text-slate-400 hover:text-rose-400 hover:bg-rose-500/20 rounded transition-colors"
                      title={`Delete ${store.name}`}
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
        
        {/* Create New Store */}
        <div className="p-4 border-t border-slate-700">
          <p className="text-slate-300 text-sm mb-2">Create New Store</p>
          <div className="flex gap-2">
            <input
              type="text"
              id="modal-new-store-name"
              placeholder="Store name..."
              className="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-violet-500"
              onKeyDown={(e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                  createStore(e.target.value.trim());
                  e.target.value = '';
                }
              }}
            />
            <button
              onClick={() => {
                const input = document.getElementById('modal-new-store-name');
                if (input?.value?.trim()) {
                  createStore(input.value.trim());
                  input.value = '';
                }
              }}
              className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white text-sm flex items-center gap-1"
            >
              <Plus className="w-4 h-4" />
              Create
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// Set up auth + initial load
useEffect(() => {
  let unsub = null;
  const boot = async () => {
    if (!supabase) {
      setIsAuthReady(true);
      loadFromLocal();
      return;
    }

    const { data } = await supabase.auth.getSession();
    setSession(data?.session || null);

    unsub = supabase.auth.onAuthStateChange((_event, nextSession) => {
      setSession(nextSession);
    }).data?.subscription;

    setIsAuthReady(true);
  };

  boot();
  return () => { if (unsub) unsub.unsubscribe(); };
}, [loadFromLocal]);

// Auto-lock: track activity + idle check
useEffect(() => {
  const saved = parseInt(lsGet(ACTIVITY_KEY) || '0', 10);
  if (saved) lastActivityRef.current = saved;
  const bump = () => markActivity();
  const events = ['mousemove', 'keydown', 'mousedown', 'touchstart', 'scroll'];
  events.forEach((ev) => window.addEventListener(ev, bump, { passive: true }));
  return () => events.forEach((ev) => window.removeEventListener(ev, bump));
}, [markActivity]);

useEffect(() => {
  if (!session?.user?.id || !supabase) return;
  if (isLocked) return;
  const t = setInterval(() => {
    const last = lastActivityRef.current || parseInt(lsGet(ACTIVITY_KEY) || '0', 10) || Date.now();
    if (Date.now() - last > LOCK_MS) {
      setIsLocked(true);
      setUnlockPassword('');
      setUnlockError('');
    }
  }, 30000);
  return () => clearInterval(t);
}, [session, supabase, isLocked]);

// Manual lock helper
const lockNow = () => {
  setIsLocked(true);
  setUnlockPassword('');
  setUnlockError('');
};

const handleUnlock = async (e) => {
  e.preventDefault();
  setUnlockError('');
  if (!supabase || !session?.user?.email) {
    setUnlockError('Auth not ready');
    return;
  }
  try {
    const { error } = await supabase.auth.signInWithPassword({
      email: session.user.email,
      password: unlockPassword,
    });
    if (error) throw error;
    setIsLocked(false);
    setUnlockPassword('');
    markActivity();
  } catch (err) {
    setUnlockError(err?.message || 'Unlock failed');
  }
};

// Whenever session changes: load cloud if present, else fall back to local.
const hasInitializedRef = useRef(false);
useEffect(() => {
  // Only run once per session change
  if (hasInitializedRef.current && session?.user?.id) return;
  
  const run = async () => {
    if (!isAuthReady) return;
    if (isLoadingDataRef.current) return; // Prevent concurrent loads
    
    isLoadingDataRef.current = true;
    hasInitializedRef.current = true;
    
    try {
      if (session?.user?.id && supabase) {
        const result = await loadFromCloud();
        if (!result.ok) {
          // No cloud data yet: load local and push it up once.
          loadFromLocal();
          // Create default store if none exists
          const defaultStore = {
            id: `store_${Date.now()}`,
            name: storeName || 'My Store',
            createdAt: new Date().toISOString(),
          };
          setStores([defaultStore]);
          setActiveStoreId(defaultStore.id);
          
          const localCombined = {
            sales: (() => { try { return JSON.parse(lsGet(STORAGE_KEY) || '{}'); } catch { return {}; } })(),
            dailySales: (() => { try { return JSON.parse(lsGet('ecommerce_daily_sales_v1') || '{}'); } catch { return {}; } })(),
            inventory: (() => { try { return JSON.parse(lsGet(INVENTORY_KEY) || '{}'); } catch { return {}; } })(),
            cogs: (() => { try { return JSON.parse(lsGet(COGS_KEY) || '{"lookup":{},"updatedAt":null}'); } catch { return { lookup: {}, updatedAt: null }; } })(),
            periods: (() => { try { return JSON.parse(lsGet(PERIODS_KEY) || '{}'); } catch { return {}; } })(),
            storeName: (() => { try { return (lsGet(STORE_KEY) || ''); } catch { return ''; } })(),
          };
          await pushToCloudNow(localCombined);
        } else {
          // Create default store if loaded data has no stores
          if (result.stores.length === 0) {
            const defaultStore = {
              id: 'default',
              name: storeName || 'My Store',
              createdAt: new Date().toISOString(),
            };
            setStores([defaultStore]);
            setActiveStoreId(defaultStore.id);
          }
        }
      } else {
        loadFromLocal();
      }
    } finally {
      isLoadingDataRef.current = false;
    }
  };

  run();
// eslint-disable-next-line react-hooks/exhaustive-deps
}, [session, isAuthReady]);

const save = async (d) => {
  try {
    writeToLocal(STORAGE_KEY, JSON.stringify(d));
    setShowSaveConfirm(true);
    setTimeout(() => setShowSaveConfirm(false), 2000);
    queueCloudSave({ ...combinedData, sales: d });
  } catch {}
};

const saveInv = async (d) => {
  try {
    writeToLocal(INVENTORY_KEY, JSON.stringify(d));
    setShowSaveConfirm(true);
    setTimeout(() => setShowSaveConfirm(false), 2000);
    queueCloudSave({ ...combinedData, inventory: d });
  } catch {}
};

const saveCogs = async (lookup) => {
  try {
    const updatedAt = new Date().toISOString();
    writeToLocal(COGS_KEY, JSON.stringify({ lookup, updatedAt }));
    setSavedCogs(lookup);
    setCogsLastUpdated(updatedAt);
    setShowSaveConfirm(true);
    setTimeout(() => setShowSaveConfirm(false), 2000);
    queueCloudSave({ ...combinedData, cogs: { lookup, updatedAt } });
  } catch {}
};

const savePeriods = async (d) => {
  try {
    writeToLocal(PERIODS_KEY, JSON.stringify(d));
    setShowSaveConfirm(true);
    setTimeout(() => setShowSaveConfirm(false), 2000);
    queueCloudSave({ ...combinedData, periods: d });
  } catch {}
};

  const handleFile = useCallback(async (type, file, isInv = false) => {
    if (!file) return;
    
    // Check if it's an Excel file (for 3PL)
    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
    
    if (type === 'threepl' && isExcel) {
      // Parse Excel file for 3PL - extract Summary sheet
      try {
        const xlsx = await loadXLSX();
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = xlsx.read(data, { type: 'array' });
            
            // Look for Summary sheet
            if (workbook.SheetNames.includes('Summary')) {
              const summarySheet = workbook.Sheets['Summary'];
              const rows = xlsx.utils.sheet_to_json(summarySheet);
              setFiles(p => ({ ...p, threepl: [...(p.threepl || []), rows] }));
              setFileNames(p => ({ ...p, threepl: [...(p.threepl || []), file.name] }));
              setToast({ message: `Loaded ${rows.length} 3PL charges from Excel`, type: 'success' });
            } else {
              // Try first sheet as fallback
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const rows = xlsx.utils.sheet_to_json(firstSheet);
              setFiles(p => ({ ...p, threepl: [...(p.threepl || []), rows] }));
              setFileNames(p => ({ ...p, threepl: [...(p.threepl || []), file.name] }));
              setToast({ message: `Loaded ${rows.length} rows from 3PL Excel`, type: 'success' });
            }
          } catch (err) {
            console.error('Error parsing 3PL Excel:', err);
            setToast({ message: 'Error parsing 3PL Excel file', type: 'error' });
          }
        };
        reader.readAsArrayBuffer(file);
      } catch (err) {
        console.error('Error loading SheetJS:', err);
        setToast({ message: 'Error loading Excel parser', type: 'error' });
      }
      return;
    }
    
    // Regular CSV handling
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = parseCSV(e.target.result);
      if (isInv) { setInvFiles(p => ({ ...p, [type]: data })); setInvFileNames(p => ({ ...p, [type]: file.name })); }
      else if (type === 'threepl') {
        // 3PL supports multiple files - append to array
        setFiles(p => ({ ...p, threepl: [...(p.threepl || []), data] }));
        setFileNames(p => ({ ...p, threepl: [...(p.threepl || []), file.name] }));
      }
      else { setFiles(p => ({ ...p, [type]: data })); setFileNames(p => ({ ...p, [type]: file.name })); }
    };
    reader.readAsText(file);
  }, []);

  const clear3PLFiles = useCallback(() => {
    setFiles(p => ({ ...p, threepl: [] }));
    setFileNames(p => ({ ...p, threepl: [] }));
  }, []);

  const handlePeriodFile = useCallback(async (type, file) => {
    if (!file) return;
    
    // Check if it's an Excel file (for 3PL)
    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
    
    if (type === 'threepl' && isExcel) {
      try {
        const xlsx = await loadXLSX();
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = xlsx.read(data, { type: 'array' });
            
            if (workbook.SheetNames.includes('Summary')) {
              const summarySheet = workbook.Sheets['Summary'];
              const rows = xlsx.utils.sheet_to_json(summarySheet);
              setPeriodFiles(p => ({ ...p, threepl: [...(p.threepl || []), rows] }));
              setPeriodFileNames(p => ({ ...p, threepl: [...(p.threepl || []), file.name] }));
              setToast({ message: `Loaded ${rows.length} 3PL charges from Excel`, type: 'success' });
            } else {
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const rows = xlsx.utils.sheet_to_json(firstSheet);
              setPeriodFiles(p => ({ ...p, threepl: [...(p.threepl || []), rows] }));
              setPeriodFileNames(p => ({ ...p, threepl: [...(p.threepl || []), file.name] }));
              setToast({ message: `Loaded ${rows.length} rows from 3PL Excel`, type: 'success' });
            }
          } catch (err) {
            console.error('Error parsing 3PL Excel:', err);
            setToast({ message: 'Error parsing 3PL Excel file', type: 'error' });
          }
        };
        reader.readAsArrayBuffer(file);
      } catch (err) {
        console.error('Error loading SheetJS:', err);
      }
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = parseCSV(e.target.result);
      if (type === 'threepl') {
        // 3PL supports multiple files for periods too
        setPeriodFiles(p => ({ ...p, threepl: [...(p.threepl || []), data] }));
        setPeriodFileNames(p => ({ ...p, threepl: [...(p.threepl || []), file.name] }));
      } else {
        setPeriodFiles(p => ({ ...p, [type]: data }));
        setPeriodFileNames(p => ({ ...p, [type]: file.name }));
      }
    };
    reader.readAsText(file);
  }, []);

  const handleReprocessFile = useCallback(async (type, file) => {
    if (!file) return;
    
    // Check if it's an Excel file (for 3PL)
    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
    
    if (type === 'threepl' && isExcel) {
      try {
        const xlsx = await loadXLSX();
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = xlsx.read(data, { type: 'array' });
            
            if (workbook.SheetNames.includes('Summary')) {
              const summarySheet = workbook.Sheets['Summary'];
              const rows = xlsx.utils.sheet_to_json(summarySheet);
              setReprocessFiles(p => ({ ...p, [type]: rows }));
              setReprocessFileNames(p => ({ ...p, [type]: file.name }));
              setToast({ message: `Loaded ${rows.length} charges from 3PL Excel`, type: 'success' });
            } else {
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const rows = xlsx.utils.sheet_to_json(firstSheet);
              setReprocessFiles(p => ({ ...p, [type]: rows }));
              setReprocessFileNames(p => ({ ...p, [type]: file.name }));
              setToast({ message: `Loaded ${rows.length} rows from 3PL Excel`, type: 'success' });
            }
          } catch (err) {
            console.error('Error parsing 3PL Excel:', err);
            setToast({ message: 'Error parsing 3PL Excel file', type: 'error' });
          }
        };
        reader.readAsArrayBuffer(file);
      } catch (err) {
        console.error('Error loading SheetJS:', err);
      }
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = parseCSV(e.target.result);
      setReprocessFiles(p => ({ ...p, [type]: data }));
      setReprocessFileNames(p => ({ ...p, [type]: file.name }));
    };
    reader.readAsText(file);
  }, []);

  const reprocessWeek = useCallback((weekKey) => {
    try {
    const cogsLookup = { ...savedCogs };
    if (!reprocessFiles.amazon || !reprocessFiles.shopify) { alert('Upload Amazon & Shopify files'); return; }
    if (Object.keys(cogsLookup).length === 0) { alert('Set up COGS first'); return; }

    let amzRev = 0, amzUnits = 0, amzRet = 0, amzProfit = 0, amzCogs = 0, amzFees = 0, amzAds = 0;
    const amazonSkuData = {};
    reprocessFiles.amazon.forEach(r => {
      const net = parseInt(r['Net units sold'] || 0), sold = parseInt(r['Units sold'] || 0), ret = parseInt(r['Units returned'] || 0);
      const sales = parseFloat(r['Net sales'] || 0), proceeds = parseFloat(r['Net proceeds total'] || 0), sku = r['MSKU'] || '';
      const fees = parseFloat(r['FBA fulfillment fees total'] || 0) + parseFloat(r['Referral fee total'] || 0) + parseFloat(r['AWD Storage Fee total'] || 0);
      const ads = parseFloat(r['Sponsored Products charge total'] || 0);
      const name = r['Product title'] || r['product-name'] || sku;
      if (net > 0 || sold > 0) { 
        amzRev += sales; amzUnits += sold; amzRet += ret; amzProfit += proceeds; amzFees += fees; amzAds += ads; amzCogs += (cogsLookup[sku] || 0) * net;
        if (sku) {
          if (!amazonSkuData[sku]) amazonSkuData[sku] = { sku, name, unitsSold: 0, returns: 0, netSales: 0, netProceeds: 0, adSpend: 0, cogs: 0 };
          amazonSkuData[sku].unitsSold += sold;
          amazonSkuData[sku].returns += ret;
          amazonSkuData[sku].netSales += sales;
          amazonSkuData[sku].netProceeds += proceeds;
          amazonSkuData[sku].adSpend += ads;
          amazonSkuData[sku].cogs += (cogsLookup[sku] || 0) * net;
        }
      }
    });

    let shopRev = 0, shopUnits = 0, shopCogs = 0, shopDisc = 0;
    const shopifySkuData = {};
    reprocessFiles.shopify.forEach(r => {
      const units = parseInt(r['Net items sold'] || 0), sales = parseFloat(r['Net sales'] || 0), sku = r['Product variant SKU'] || '';
      const name = r['Product title'] || r['Product'] || sku;
      const disc = Math.abs(parseFloat(r['Discounts'] || 0));
      shopRev += sales; shopUnits += units; shopCogs += (cogsLookup[sku] || 0) * units; shopDisc += disc;
      if (sku && units > 0) {
        if (!shopifySkuData[sku]) shopifySkuData[sku] = { sku, name, unitsSold: 0, netSales: 0, discounts: 0, cogs: 0 };
        shopifySkuData[sku].unitsSold += units;
        shopifySkuData[sku].netSales += sales;
        shopifySkuData[sku].discounts += disc;
        shopifySkuData[sku].cogs += (cogsLookup[sku] || 0) * units;
      }
    });

    // Use enhanced 3PL parser
    const threeplData = parse3PLData(reprocessFiles.threepl);
    const threeplCost = threeplData.metrics.totalCost;
    const threeplBreakdown = threeplData.breakdown;
    const threeplMetrics = threeplData.metrics;

    const metaS = parseFloat(reprocessAdSpend.meta) || 0, googleS = parseFloat(reprocessAdSpend.google) || 0, shopAds = metaS + googleS;
    const shopProfit = shopRev - shopCogs - threeplCost - shopAds;
    const totalRev = amzRev + shopRev, totalProfit = amzProfit + shopProfit, totalCogs = amzCogs + shopCogs;

    const amazonSkus = Object.values(amazonSkuData).sort((a, b) => b.netSales - a.netSales);
    const shopifySkus = Object.values(shopifySkuData).sort((a, b) => b.netSales - a.netSales);

    const weekData = {
      weekEnding: weekKey, createdAt: new Date().toISOString(),
      amazon: { revenue: amzRev, units: amzUnits, returns: amzRet, cogs: amzCogs, fees: amzFees, adSpend: amzAds, netProfit: amzProfit, 
        margin: amzRev > 0 ? (amzProfit/amzRev)*100 : 0, aov: amzUnits > 0 ? amzRev/amzUnits : 0, roas: amzAds > 0 ? amzRev/amzAds : 0,
        returnRate: amzUnits > 0 ? (amzRet/amzUnits)*100 : 0, skuData: amazonSkus },
      shopify: { revenue: shopRev, units: shopUnits, cogs: shopCogs, threeplCosts: threeplCost, threeplBreakdown, threeplMetrics, adSpend: shopAds, metaSpend: metaS, googleSpend: googleS, discounts: shopDisc, netProfit: shopProfit, 
        netMargin: shopRev > 0 ? (shopProfit/shopRev)*100 : 0, aov: shopUnits > 0 ? shopRev/shopUnits : 0, roas: shopAds > 0 ? shopRev/shopAds : 0, skuData: shopifySkus },
      total: { revenue: totalRev, units: amzUnits + shopUnits, cogs: totalCogs, adSpend: amzAds + shopAds, netProfit: totalProfit, netMargin: totalRev > 0 ? (totalProfit/totalRev)*100 : 0, roas: (amzAds + shopAds) > 0 ? totalRev/(amzAds + shopAds) : 0, amazonShare: totalRev > 0 ? (amzRev/totalRev)*100 : 0, shopifyShare: totalRev > 0 ? (shopRev/totalRev)*100 : 0 }
    };

    const updated = { ...allWeeksData, [weekKey]: weekData };
    setAllWeeksData(updated); save(updated);
    setShowReprocess(false);
    setReprocessFiles({ amazon: null, shopify: null, threepl: null });
    setReprocessFileNames({ amazon: '', shopify: '', threepl: '' });
    setReprocessAdSpend({ meta: '', google: '' });
    } catch (err) {
      console.error('Reprocess error:', err);
      alert('Error reprocessing: ' + err.message);
    }
  }, [reprocessFiles, reprocessAdSpend, allWeeksData, savedCogs]);

  const getCogsLookup = useCallback(() => {
    const lookup = { ...savedCogs };
    if (files.cogs) files.cogs.forEach(r => { const s = r['SKU'] || r['sku']; const c = parseFloat(r['Cost Per Unit'] || 0); if (s && c) lookup[s] = c; });
    return lookup;
  }, [savedCogs, files.cogs]);

  const processAndSaveCogs = useCallback(() => {
    if (!files.cogs) return;
    const lookup = {};
    const names = {};
    files.cogs.forEach(r => { 
      const s = r['SKU'] || r['sku']; 
      const c = parseFloat(r['Cost Per Unit'] || 0); 
      const name = r['Product Name'] || r['Product Name '] || r['product name'] || r['Name'] || r['name'] || '';
      if (s) {
        lookup[s] = c;
        if (name) names[s] = name.trim();
      }
    });
    saveCogs(lookup);
    setSavedProductNames(names);
    // Save product names to localStorage
    try { localStorage.setItem(PRODUCT_NAMES_KEY, JSON.stringify(names)); } catch(e) {}
    setFiles(p => ({ ...p, cogs: null })); setFileNames(p => ({ ...p, cogs: '' })); setShowCogsManager(false);
  }, [files.cogs]);

  // Data Validation Function
  const validateUploadData = useCallback((type, data) => {
    const warnings = [];
    const errors = [];
    
    if (type === 'amazon' && data) {
      // Check for required columns
      const requiredCols = ['MSKU', 'Net sales', 'Units sold'];
      const sampleRow = data[0] || {};
      const missingCols = requiredCols.filter(col => !(col in sampleRow));
      if (missingCols.length > 0) {
        errors.push({ type: 'error', message: `Missing required columns: ${missingCols.join(', ')}`, detail: 'Make sure you downloaded the SKU Economics report' });
      }
      
      // Check for data quality
      let negativeRevenue = 0, zeroUnits = 0, missingSku = 0, totalRows = 0;
      data.forEach(row => {
        totalRows++;
        const revenue = parseFloat(row['Net sales'] || 0);
        const units = parseInt(row['Units sold'] || 0);
        const sku = row['MSKU'] || '';
        
        if (revenue < 0) negativeRevenue++;
        if (units === 0 && revenue > 0) zeroUnits++;
        if (!sku && (units > 0 || revenue > 0)) missingSku++;
      });
      
      if (negativeRevenue > 0) {
        warnings.push({ type: 'warning', message: `${negativeRevenue} rows have negative revenue`, detail: 'This may be due to refunds - usually OK' });
      }
      if (zeroUnits > totalRows * 0.5 && totalRows > 5) {
        warnings.push({ type: 'warning', message: `${zeroUnits} of ${totalRows} rows have 0 units`, detail: 'Check if this is the correct date range' });
      }
      if (missingSku > 0) {
        warnings.push({ type: 'warning', message: `${missingSku} rows missing SKU`, detail: 'These rows will be skipped' });
      }
      if (totalRows === 0) {
        errors.push({ type: 'error', message: 'No data rows found', detail: 'The file appears to be empty' });
      }
      if (totalRows < 3 && totalRows > 0) {
        warnings.push({ type: 'info', message: `Only ${totalRows} SKUs found`, detail: 'This seems low - verify the date range' });
      }
    }
    
    if (type === 'shopify' && data) {
      // Check for required columns
      const requiredCols = ['Product variant SKU', 'Net sales', 'Net items sold'];
      const sampleRow = data[0] || {};
      const missingCols = requiredCols.filter(col => !(col in sampleRow));
      if (missingCols.length > 0) {
        errors.push({ type: 'error', message: `Missing required columns: ${missingCols.join(', ')}`, detail: 'Make sure you downloaded Sales by product variant SKU' });
      }
      
      // Check data quality
      let negativeRevenue = 0, missingSku = 0, totalRows = 0;
      data.forEach(row => {
        totalRows++;
        const revenue = parseFloat(row['Net sales'] || 0);
        const sku = row['Product variant SKU'] || '';
        
        if (revenue < 0) negativeRevenue++;
        if (!sku && revenue !== 0) missingSku++;
      });
      
      if (negativeRevenue > 0) {
        warnings.push({ type: 'warning', message: `${negativeRevenue} rows have negative revenue`, detail: 'This may be due to refunds - usually OK' });
      }
      if (missingSku > 0) {
        warnings.push({ type: 'warning', message: `${missingSku} rows missing SKU`, detail: 'These rows will be grouped as unknown' });
      }
      if (totalRows === 0) {
        errors.push({ type: 'error', message: 'No data rows found', detail: 'The file appears to be empty' });
      }
    }
    
    if (type === 'cogs' && data) {
      let missingCost = 0, negativeCost = 0, zeroCost = 0, totalRows = 0;
      data.forEach(row => {
        const sku = row['SKU'] || row['sku'] || row['MSKU'] || row['Product variant SKU'] || '';
        const cost = parseFloat(row['Cost'] || row['cost'] || row['COGS'] || row['cogs'] || row['Cost Per Unit'] || row['Unit Cost'] || 0);
        if (sku) {
          totalRows++;
          if (isNaN(cost) || cost === 0) zeroCost++;
          if (cost < 0) negativeCost++;
        }
      });
      
      if (zeroCost > totalRows * 0.3 && totalRows > 0) {
        warnings.push({ type: 'warning', message: `${zeroCost} of ${totalRows} SKUs have $0 cost`, detail: 'Make sure COGS column is correctly named' });
      }
      if (negativeCost > 0) {
        errors.push({ type: 'error', message: `${negativeCost} SKUs have negative cost`, detail: 'COGS values should be positive' });
      }
    }
    
    if (type === 'inventory' && data) {
      let negativeQty = 0, totalRows = 0;
      data.forEach(row => {
        const qty = parseInt(row['Quantity'] || row['quantity'] || row['Available'] || row['available'] || row['Total units'] || 0);
        totalRows++;
        if (qty < 0) negativeQty++;
      });
      
      if (negativeQty > 0) {
        warnings.push({ type: 'warning', message: `${negativeQty} items have negative quantity`, detail: 'This may indicate data issues' });
      }
    }
    
    // Check for date range issues
    if ((type === 'amazon' || type === 'shopify') && data && data.length > 0) {
      const firstRow = data[0];
      const startDate = firstRow['Start date'] || firstRow['start_date'] || '';
      const endDate = firstRow['End date'] || firstRow['end_date'] || '';
      
      if (startDate && endDate && weekEnding) {
        const reportEnd = new Date(endDate);
        const selectedEnd = new Date(weekEnding + 'T00:00:00');
        const daysDiff = Math.abs((reportEnd - selectedEnd) / (1000 * 60 * 60 * 24));
        
        if (daysDiff > 3) {
          warnings.push({ 
            type: 'warning', 
            message: `Report date (${endDate}) doesn't match selected week (${weekEnding})`, 
            detail: `There's a ${Math.round(daysDiff)} day difference - verify you selected the correct date` 
          });
        }
      }
      
      // Check for SKUs missing COGS
      const cogsLookup = { ...savedCogs };
      if (Object.keys(cogsLookup).length > 0) {
        const skusWithoutCogs = [];
        data.forEach(row => {
          const sku = type === 'amazon' ? row['MSKU'] : row['Product variant SKU'];
          const units = type === 'amazon' ? parseInt(row['Units sold'] || 0) : parseInt(row['Net items sold'] || 0);
          if (sku && units > 0 && !cogsLookup[sku]) {
            if (!skusWithoutCogs.includes(sku)) skusWithoutCogs.push(sku);
          }
        });
        
        if (skusWithoutCogs.length > 0) {
          warnings.push({ 
            type: 'warning', 
            message: `${skusWithoutCogs.length} SKUs missing COGS`, 
            detail: `These SKUs will show $0 cost: ${skusWithoutCogs.slice(0, 5).join(', ')}${skusWithoutCogs.length > 5 ? '...' : ''}` 
          });
        }
      }
    }
    
    return { warnings, errors, hasErrors: errors.length > 0 };
  }, [weekEnding, savedCogs]);

  // Validation Modal Component (defined inline for access to state)
  const ValidationModal = () => {
    if (!showValidationModal) return null;
    const hasErrors = dataValidationWarnings.some(w => w.type === 'error');
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-lg w-full max-h-[80vh] overflow-y-auto">
          <h2 className="text-xl font-bold text-white mb-2 flex items-center gap-2">
            {hasErrors ? <AlertCircle className="w-6 h-6 text-rose-400" /> : <AlertTriangle className="w-6 h-6 text-amber-400" />}
            Data Validation {hasErrors ? 'Errors' : 'Warnings'}
          </h2>
          <p className="text-slate-400 text-sm mb-4">
            {hasErrors ? 'Please fix these issues before proceeding:' : 'Review these warnings before proceeding:'}
          </p>
          
          <div className="space-y-3 mb-6">
            {dataValidationWarnings.map((warning, idx) => (
              <div key={idx} className={`rounded-lg p-3 ${
                warning.type === 'error' ? 'bg-rose-900/30 border border-rose-500/50' :
                warning.type === 'warning' ? 'bg-amber-900/30 border border-amber-500/50' :
                'bg-blue-900/30 border border-blue-500/50'
              }`}>
                <p className={`font-medium ${
                  warning.type === 'error' ? 'text-rose-300' :
                  warning.type === 'warning' ? 'text-amber-300' :
                  'text-blue-300'
                }`}>
                  {warning.type === 'error' ? 'âŒ' : warning.type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'} {warning.message}
                </p>
                {warning.detail && <p className="text-slate-400 text-sm mt-1">{warning.detail}</p>}
              </div>
            ))}
          </div>
          
          <div className="flex gap-3">
            {!hasErrors && (
              <button 
                onClick={() => {
                  setShowValidationModal(false);
                  if (pendingProcessAction) {
                    pendingProcessAction();
                    setPendingProcessAction(null);
                  }
                }} 
                className="flex-1 bg-amber-600 hover:bg-amber-500 text-white font-semibold py-2 rounded-lg"
              >
                Continue Anyway
              </button>
            )}
            <button 
              onClick={() => { 
                setShowValidationModal(false); 
                setPendingProcessAction(null);
                setDataValidationWarnings([]);
              }} 
              className={`${hasErrors ? 'flex-1' : ''} bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg`}
            >
              {hasErrors ? 'Go Back & Fix' : 'Cancel'}
            </button>
          </div>
        </div>
      </div>
    );
  };

  const processSales = useCallback(() => {
    const cogsLookup = getCogsLookup();
    if (!files.amazon || !files.shopify || !weekEnding) { alert('Upload Amazon & Shopify files and select date'); return; }
    if (Object.keys(cogsLookup).length === 0) { alert('Set up COGS first via the COGS button'); return; }
    
    // Validate data before processing
    const amazonValidation = validateUploadData('amazon', files.amazon);
    const shopifyValidation = validateUploadData('shopify', files.shopify);
    const allWarnings = [...amazonValidation.warnings, ...amazonValidation.errors, ...shopifyValidation.warnings, ...shopifyValidation.errors];
    
    if (allWarnings.length > 0) {
      setDataValidationWarnings(allWarnings);
      setPendingProcessAction(() => processSalesCore);
      setShowValidationModal(true);
      return;
    }
    
    processSalesCore();
  }, [files, adSpend, weekEnding, allWeeksData, getCogsLookup, validateUploadData]);
  
  const processSalesCore = useCallback(() => {
    const cogsLookup = getCogsLookup();
    setIsProcessing(true);

    let amzRev = 0, amzUnits = 0, amzRet = 0, amzProfit = 0, amzCogs = 0, amzFees = 0, amzAds = 0;
    const amazonSkuData = {};
    files.amazon.forEach(r => {
      const net = parseInt(r['Net units sold'] || 0), sold = parseInt(r['Units sold'] || 0), ret = parseInt(r['Units returned'] || 0);
      const sales = parseFloat(r['Net sales'] || 0), proceeds = parseFloat(r['Net proceeds total'] || 0), sku = r['MSKU'] || '';
      const fees = parseFloat(r['FBA fulfillment fees total'] || 0) + parseFloat(r['Referral fee total'] || 0) + parseFloat(r['AWD Storage Fee total'] || 0);
      const ads = parseFloat(r['Sponsored Products charge total'] || 0);
      const name = r['Product title'] || r['product-name'] || sku;
      if (net > 0 || sold > 0) { 
        amzRev += sales; amzUnits += sold; amzRet += ret; amzProfit += proceeds; amzFees += fees; amzAds += ads; amzCogs += (cogsLookup[sku] || 0) * net;
        if (sku) {
          if (!amazonSkuData[sku]) amazonSkuData[sku] = { sku, name, unitsSold: 0, returns: 0, netSales: 0, netProceeds: 0, adSpend: 0, cogs: 0 };
          amazonSkuData[sku].unitsSold += sold;
          amazonSkuData[sku].returns += ret;
          amazonSkuData[sku].netSales += sales;
          amazonSkuData[sku].netProceeds += proceeds;
          amazonSkuData[sku].adSpend += ads;
          amazonSkuData[sku].cogs += (cogsLookup[sku] || 0) * net;
        }
      }
    });

    let shopRev = 0, shopUnits = 0, shopCogs = 0, shopDisc = 0;
    const shopifySkuData = {};
    files.shopify.forEach(r => {
      const units = parseInt(r['Net items sold'] || 0), sales = parseFloat(r['Net sales'] || 0), sku = r['Product variant SKU'] || '';
      const name = r['Product title'] || r['Product'] || sku;
      const disc = Math.abs(parseFloat(r['Discounts'] || 0));
      shopRev += sales; shopUnits += units; shopCogs += (cogsLookup[sku] || 0) * units; shopDisc += disc;
      if (sku && units > 0) {
        if (!shopifySkuData[sku]) shopifySkuData[sku] = { sku, name, unitsSold: 0, netSales: 0, discounts: 0, cogs: 0 };
        shopifySkuData[sku].unitsSold += units;
        shopifySkuData[sku].netSales += sales;
        shopifySkuData[sku].discounts += disc;
        shopifySkuData[sku].cogs += (cogsLookup[sku] || 0) * units;
      }
    });

    // Use enhanced 3PL parser
    const threeplData = parse3PLData(files.threepl);
    const threeplCost = threeplData.metrics.totalCost;
    const threeplBreakdown = threeplData.breakdown;
    const threeplMetrics = threeplData.metrics;

    const metaS = parseFloat(adSpend.meta) || 0, googleS = parseFloat(adSpend.google) || 0, shopAds = metaS + googleS;
    const shopProfit = shopRev - shopCogs - threeplCost - shopAds;
    const totalRev = amzRev + shopRev, totalProfit = amzProfit + shopProfit, totalCogs = amzCogs + shopCogs;

    // Convert SKU data to sorted arrays
    const amazonSkus = Object.values(amazonSkuData).sort((a, b) => b.netSales - a.netSales);
    const shopifySkus = Object.values(shopifySkuData).sort((a, b) => b.netSales - a.netSales);

    const weekData = {
      weekEnding, createdAt: new Date().toISOString(),
      amazon: { revenue: amzRev, units: amzUnits, returns: amzRet, cogs: amzCogs, fees: amzFees, adSpend: amzAds, netProfit: amzProfit, 
        margin: amzRev > 0 ? (amzProfit/amzRev)*100 : 0, aov: amzUnits > 0 ? amzRev/amzUnits : 0, roas: amzAds > 0 ? amzRev/amzAds : 0,
        returnRate: amzUnits > 0 ? (amzRet/amzUnits)*100 : 0, skuData: amazonSkus },
      shopify: { revenue: shopRev, units: shopUnits, cogs: shopCogs, threeplCosts: threeplCost, threeplBreakdown, threeplMetrics, adSpend: shopAds, metaSpend: metaS, googleSpend: googleS, discounts: shopDisc, netProfit: shopProfit, 
        netMargin: shopRev > 0 ? (shopProfit/shopRev)*100 : 0, aov: shopUnits > 0 ? shopRev/shopUnits : 0, roas: shopAds > 0 ? shopRev/shopAds : 0, skuData: shopifySkus },
      total: { revenue: totalRev, units: amzUnits + shopUnits, cogs: totalCogs, adSpend: amzAds + shopAds, netProfit: totalProfit, netMargin: totalRev > 0 ? (totalProfit/totalRev)*100 : 0, roas: (amzAds + shopAds) > 0 ? totalRev/(amzAds + shopAds) : 0, amazonShare: totalRev > 0 ? (amzRev/totalRev)*100 : 0, shopifyShare: totalRev > 0 ? (shopRev/totalRev)*100 : 0 }
    };

    const updated = { ...allWeeksData, [weekEnding]: weekData };
    setAllWeeksData(updated); save(updated); setSelectedWeek(weekEnding); setView('weekly'); setIsProcessing(false);
    setFiles({ amazon: null, shopify: null, cogs: null, threepl: [] }); setFileNames({ amazon: '', shopify: '', cogs: '', threepl: [] }); setAdSpend({ meta: '', google: '' }); setWeekEnding('');
    setToast({ message: 'Week data saved successfully!', type: 'success' });
  }, [files, adSpend, weekEnding, allWeeksData, getCogsLookup, save]);

  // Process daily upload
  const processDailyUpload = useCallback(async () => {
    if (!selectedDay) { alert('Please select a date'); return; }
    if (!dailyFiles.amazon && !dailyFiles.shopify) { alert('Upload at least one data file'); return; }
    
    const cogsLookup = getCogsLookup();
    setIsProcessing(true);
    
    try {
      let amzRev = 0, amzUnits = 0, amzRet = 0, amzProfit = 0, amzCogs = 0, amzFees = 0, amzAds = 0;
      const amazonSkuData = {};
      
      // Parse Amazon data if provided
      if (dailyFiles.amazon) {
        const amzData = await new Promise((resolve) => {
          dailyFiles.amazon.text().then(text => resolve(parseCSV(text)));
        });
        
        amzData.forEach(r => {
          const net = parseInt(r['Net units sold'] || 0), sold = parseInt(r['Units sold'] || 0), ret = parseInt(r['Units returned'] || 0);
          const sales = parseFloat(r['Net sales'] || 0), proceeds = parseFloat(r['Net proceeds total'] || 0), sku = r['MSKU'] || '';
          const fees = parseFloat(r['FBA fulfillment fees total'] || 0) + parseFloat(r['Referral fee total'] || 0) + parseFloat(r['AWD Storage Fee total'] || 0);
          const ads = parseFloat(r['Sponsored Products charge total'] || 0);
          const name = r['Product title'] || r['product-name'] || sku;
          if (net > 0 || sold > 0) { 
            amzRev += sales; amzUnits += sold; amzRet += ret; amzProfit += proceeds; amzFees += fees; amzAds += ads; amzCogs += (cogsLookup[sku] || 0) * net;
            if (sku) {
              if (!amazonSkuData[sku]) amazonSkuData[sku] = { sku, name, unitsSold: 0, returns: 0, netSales: 0, netProceeds: 0, adSpend: 0, cogs: 0 };
              amazonSkuData[sku].unitsSold += sold;
              amazonSkuData[sku].returns += ret;
              amazonSkuData[sku].netSales += sales;
              amazonSkuData[sku].netProceeds += proceeds;
              amazonSkuData[sku].adSpend += ads;
              amazonSkuData[sku].cogs += (cogsLookup[sku] || 0) * net;
            }
          }
        });
      }
      
      let shopRev = 0, shopUnits = 0, shopCogs = 0, shopDisc = 0;
      const shopifySkuData = {};
      
      // Parse Shopify data if provided
      if (dailyFiles.shopify) {
        const shopData = await new Promise((resolve) => {
          dailyFiles.shopify.text().then(text => resolve(parseCSV(text)));
        });
        
        shopData.forEach(r => {
          const units = parseInt(r['Net items sold'] || 0), sales = parseFloat(r['Net sales'] || 0), sku = r['Product variant SKU'] || '';
          const name = r['Product title'] || r['Product'] || sku;
          const disc = Math.abs(parseFloat(r['Discounts'] || 0));
          shopRev += sales; shopUnits += units; shopCogs += (cogsLookup[sku] || 0) * units; shopDisc += disc;
          if (sku && units > 0) {
            if (!shopifySkuData[sku]) shopifySkuData[sku] = { sku, name, unitsSold: 0, netSales: 0, discounts: 0, cogs: 0 };
            shopifySkuData[sku].unitsSold += units;
            shopifySkuData[sku].netSales += sales;
            shopifySkuData[sku].discounts += disc;
            shopifySkuData[sku].cogs += (cogsLookup[sku] || 0) * units;
          }
        });
      }
      
      const metaS = parseFloat(dailyAdSpend.meta) || 0;
      const googleS = parseFloat(dailyAdSpend.google) || 0;
      const shopAds = metaS + googleS;
      const shopProfit = shopRev - shopCogs - shopAds;
      const totalRev = amzRev + shopRev;
      const totalProfit = amzProfit + shopProfit;
      const totalCogs = amzCogs + shopCogs;
      
      const amazonSkus = Object.values(amazonSkuData).sort((a, b) => b.netSales - a.netSales);
      const shopifySkus = Object.values(shopifySkuData).sort((a, b) => b.netSales - a.netSales);
      
      const dayData = {
        date: selectedDay,
        createdAt: new Date().toISOString(),
        amazon: dailyFiles.amazon ? {
          revenue: amzRev, units: amzUnits, returns: amzRet, cogs: amzCogs, fees: amzFees, adSpend: amzAds, netProfit: amzProfit,
          margin: amzRev > 0 ? (amzProfit/amzRev)*100 : 0, aov: amzUnits > 0 ? amzRev/amzUnits : 0, roas: amzAds > 0 ? amzRev/amzAds : 0,
          returnRate: amzUnits > 0 ? (amzRet/amzUnits)*100 : 0, skuData: amazonSkus
        } : null,
        shopify: dailyFiles.shopify ? {
          revenue: shopRev, units: shopUnits, cogs: shopCogs, adSpend: shopAds, metaSpend: metaS, googleSpend: googleS,
          discounts: shopDisc, netProfit: shopProfit, netMargin: shopRev > 0 ? (shopProfit/shopRev)*100 : 0,
          aov: shopUnits > 0 ? shopRev/shopUnits : 0, roas: shopAds > 0 ? shopRev/shopAds : 0, skuData: shopifySkus
        } : null,
      };
      
      // CRITICAL: Merge with existing data - preserve channels that weren't uploaded
      const existingDayData = allDaysData[selectedDay] || {};
      const existingShopify = existingDayData.shopify || {};
      
      // Preserve ALL existing ads data
      const metaSpend = existingDayData.metaSpend || existingShopify.metaSpend || 0;
      const googleSpend = existingDayData.googleSpend || existingShopify.googleSpend || 0;
      const totalAds = metaSpend + googleSpend;
      
      // Only update channels that were actually uploaded, preserve others
      // But merge ad data into shopify object
      const uploadedShopify = dailyFiles.shopify ? dayData.shopify : existingShopify;
      const mergedShopify = {
        ...uploadedShopify,
        metaSpend: metaSpend,
        metaAds: metaSpend,
        googleSpend: googleSpend,
        googleAds: googleSpend,
        adSpend: totalAds,
      };
      
      // Recalculate profit if we have ad spend
      if (totalAds > 0 && mergedShopify.revenue > 0) {
        const grossProfit = (mergedShopify.revenue || 0) - (mergedShopify.cogs || 0) - (mergedShopify.threeplCosts || 0);
        mergedShopify.netProfit = grossProfit - totalAds;
        mergedShopify.netMargin = mergedShopify.revenue > 0 ? (mergedShopify.netProfit / mergedShopify.revenue) * 100 : 0;
        mergedShopify.roas = totalAds > 0 ? mergedShopify.revenue / totalAds : 0;
      }
      
      const mergedDayData = {
        ...existingDayData,
        date: selectedDay,
        createdAt: new Date().toISOString(),
        // Preserve existing Amazon data if no new Amazon file uploaded
        amazon: dailyFiles.amazon ? dayData.amazon : existingDayData.amazon,
        // Shopify with merged ad data
        shopify: mergedShopify,
        // Preserve ALL existing ads data (Meta/Google from bulk upload)
        metaSpend: metaSpend,
        metaAds: metaSpend,
        metaImpressions: existingDayData.metaImpressions,
        metaClicks: existingDayData.metaClicks,
        metaCpc: existingDayData.metaCpc,
        metaCpa: existingDayData.metaCpa,
        metaConversions: existingDayData.metaConversions,
        metaPurchases: existingDayData.metaPurchases,
        googleSpend: googleSpend,
        googleAds: googleSpend,
        googleImpressions: existingDayData.googleImpressions,
        googleClicks: existingDayData.googleClicks,
        googleCpc: existingDayData.googleCpc,
        googleCpa: existingDayData.googleCpa,
        googleConversions: existingDayData.googleConversions,
      };
      
      // Recalculate totals based on merged data
      const finalAmazon = mergedDayData.amazon || {};
      const finalShopify = mergedDayData.shopify || {};
      const finalAmzRev = finalAmazon.revenue || 0;
      const finalShopRev = finalShopify.revenue || 0;
      const finalTotalRev = finalAmzRev + finalShopRev;
      const finalAmzProfit = finalAmazon.netProfit || 0;
      const finalShopProfit = finalShopify.netProfit || 0;
      const finalTotalProfit = finalAmzProfit + finalShopProfit;
      const finalAmzAds = finalAmazon.adSpend || 0;
      const finalShopAds = finalShopify.adSpend || 0;
      const finalTotalAds = finalAmzAds + finalShopAds;
      
      mergedDayData.total = {
        revenue: finalTotalRev,
        units: (finalAmazon.units || 0) + (finalShopify.units || 0),
        cogs: (finalAmazon.cogs || 0) + (finalShopify.cogs || 0),
        adSpend: finalTotalAds,
        netProfit: finalTotalProfit,
        netMargin: finalTotalRev > 0 ? (finalTotalProfit/finalTotalRev)*100 : 0,
        roas: finalTotalAds > 0 ? finalTotalRev/finalTotalAds : 0,
        amazonShare: finalTotalRev > 0 ? (finalAmzRev/finalTotalRev)*100 : 0,
        shopifyShare: finalTotalRev > 0 ? (finalShopRev/finalTotalRev)*100 : 0
      };
      
      const updatedDays = { ...allDaysData, [selectedDay]: mergedDayData };
      setAllDaysData(updatedDays);
      lsSet('ecommerce_daily_sales_v1', JSON.stringify(updatedDays));
      
      // Sync to cloud
      queueCloudSave({ ...combinedData, dailySales: updatedDays });
      
      // Reset form
      setDailyFiles({ amazon: null, shopify: null });
      setDailyAdSpend({ meta: '', google: '' });
      setSelectedDay(null);
      setIsProcessing(false);
      setToast({ message: `Daily data for ${new Date(selectedDay + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} saved!`, type: 'success' });
      
    } catch (err) {
      console.error('Daily upload error:', err);
      setIsProcessing(false);
      setToast({ message: 'Error processing daily data', type: 'error' });
    }
  }, [selectedDay, dailyFiles, dailyAdSpend, allDaysData, getCogsLookup, combinedData, queueCloudSave]);

  // Auto-aggregate daily data into weekly summaries
  const aggregateDailyToWeekly = useCallback(() => {
    const sortedDays = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort();
    if (sortedDays.length === 0) {
      setToast({ message: 'No daily data to aggregate', type: 'error' });
      return;
    }
    
    // Group days by week (Monday to Sunday)
    const weeklyAgg = {};
    
    sortedDays.forEach(dayKey => {
      const dayData = allDaysData[dayKey];
      const date = new Date(dayKey + 'T12:00:00');
      // Get the Sunday of this week (week ending date)
      const dayOfWeek = date.getDay();
      const weekEnd = new Date(date);
      // Move to Sunday: if already Sunday add 0, else add days to reach Sunday
      weekEnd.setDate(date.getDate() + (dayOfWeek === 0 ? 0 : 7 - dayOfWeek));
      const weekKey = formatDateKey(weekEnd);
      
      if (!weeklyAgg[weekKey]) {
        weeklyAgg[weekKey] = {
          weekEnding: weekKey,
          days: [],
          amazon: { revenue: 0, units: 0, returns: 0, cogs: 0, fees: 0, adSpend: 0, netProfit: 0, skuData: {} },
          shopify: { revenue: 0, units: 0, cogs: 0, adSpend: 0, metaSpend: 0, googleSpend: 0, discounts: 0, netProfit: 0, skuData: {} },
        };
      }
      
      weeklyAgg[weekKey].days.push(dayKey);
      
      // Aggregate Amazon data
      if (dayData.amazon) {
        weeklyAgg[weekKey].amazon.revenue += dayData.amazon.revenue || 0;
        weeklyAgg[weekKey].amazon.units += dayData.amazon.units || 0;
        weeklyAgg[weekKey].amazon.returns += dayData.amazon.returns || 0;
        weeklyAgg[weekKey].amazon.cogs += dayData.amazon.cogs || 0;
        weeklyAgg[weekKey].amazon.fees += dayData.amazon.fees || 0;
        weeklyAgg[weekKey].amazon.adSpend += dayData.amazon.adSpend || 0;
        weeklyAgg[weekKey].amazon.netProfit += dayData.amazon.netProfit || 0;
        
        // Aggregate SKU data
        (dayData.amazon.skuData || []).forEach(sku => {
          if (!weeklyAgg[weekKey].amazon.skuData[sku.sku]) {
            weeklyAgg[weekKey].amazon.skuData[sku.sku] = { ...sku, unitsSold: 0, returns: 0, netSales: 0, netProceeds: 0, adSpend: 0, cogs: 0 };
          }
          weeklyAgg[weekKey].amazon.skuData[sku.sku].unitsSold += sku.unitsSold || 0;
          weeklyAgg[weekKey].amazon.skuData[sku.sku].returns += sku.returns || 0;
          weeklyAgg[weekKey].amazon.skuData[sku.sku].netSales += sku.netSales || 0;
          weeklyAgg[weekKey].amazon.skuData[sku.sku].netProceeds += sku.netProceeds || 0;
          weeklyAgg[weekKey].amazon.skuData[sku.sku].adSpend += sku.adSpend || 0;
          weeklyAgg[weekKey].amazon.skuData[sku.sku].cogs += sku.cogs || 0;
        });
      }
      
      // Aggregate Shopify data
      if (dayData.shopify) {
        weeklyAgg[weekKey].shopify.revenue += dayData.shopify.revenue || 0;
        weeklyAgg[weekKey].shopify.units += dayData.shopify.units || 0;
        weeklyAgg[weekKey].shopify.cogs += dayData.shopify.cogs || 0;
        weeklyAgg[weekKey].shopify.adSpend += dayData.shopify.adSpend || 0;
        weeklyAgg[weekKey].shopify.metaSpend += dayData.shopify.metaSpend || 0;
        weeklyAgg[weekKey].shopify.googleSpend += dayData.shopify.googleSpend || 0;
        weeklyAgg[weekKey].shopify.discounts += dayData.shopify.discounts || 0;
        weeklyAgg[weekKey].shopify.netProfit += dayData.shopify.netProfit || 0;
        
        // Aggregate SKU data
        (dayData.shopify.skuData || []).forEach(sku => {
          if (!weeklyAgg[weekKey].shopify.skuData[sku.sku]) {
            weeklyAgg[weekKey].shopify.skuData[sku.sku] = { ...sku, unitsSold: 0, netSales: 0, discounts: 0, cogs: 0 };
          }
          weeklyAgg[weekKey].shopify.skuData[sku.sku].unitsSold += sku.unitsSold || 0;
          weeklyAgg[weekKey].shopify.skuData[sku.sku].netSales += sku.netSales || 0;
          weeklyAgg[weekKey].shopify.skuData[sku.sku].discounts += sku.discounts || 0;
          weeklyAgg[weekKey].shopify.skuData[sku.sku].cogs += sku.cogs || 0;
        });
      }
    });
    
    // Filter to only include complete weeks (7 days, Mon-Sun)
    // Also track incomplete weeks for user feedback
    const completeWeeks = {};
    const incompleteWeeks = [];
    
    Object.entries(weeklyAgg).forEach(([weekKey, agg]) => {
      // Calculate which days should be in this week
      const weekEndDate = new Date(weekKey + 'T12:00:00');
      const expectedDays = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(weekEndDate);
        d.setDate(weekEndDate.getDate() - i);
        expectedDays.push(formatDateKey(d));
      }
      
      const missingDays = expectedDays.filter(d => !agg.days.includes(d));
      
      if (missingDays.length === 0) {
        // Complete week - include in aggregation
        completeWeeks[weekKey] = agg;
      } else {
        // Incomplete week - track for feedback
        incompleteWeeks.push({
          weekEnding: weekKey,
          daysPresent: agg.days.length,
          missingDays: missingDays.map(d => new Date(d + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }))
        });
      }
    });
    
    if (Object.keys(completeWeeks).length === 0) {
      const incompleteInfo = incompleteWeeks.map(w => 
        `Week ending ${new Date(w.weekEnding + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: missing ${w.missingDays.join(', ')}`
      ).join('\n');
      setToast({ 
        message: `No complete weeks to aggregate. ${incompleteWeeks.length > 0 ? `Incomplete weeks need all 7 days (Mon-Sun).` : ''}`, 
        type: 'error' 
      });
      return;
    }
    
    // Convert to weekly data format and merge with existing
    const newWeeksData = { ...allWeeksData };
    let weeksCreated = 0;
    let weeksUpdated = 0;
    
    Object.entries(completeWeeks).forEach(([weekKey, agg]) => {
      const amz = agg.amazon;
      const shop = agg.shopify;
      const totalRev = amz.revenue + shop.revenue;
      const totalProfit = amz.netProfit + shop.netProfit;
      const totalCogs = amz.cogs + shop.cogs;
      const totalAds = amz.adSpend + shop.adSpend;
      
      const weekData = {
        weekEnding: weekKey,
        createdAt: new Date().toISOString(),
        aggregatedFrom: agg.days, // Track which days were aggregated
        amazon: {
          revenue: amz.revenue,
          units: amz.units,
          returns: amz.returns,
          cogs: amz.cogs,
          fees: amz.fees,
          adSpend: amz.adSpend,
          netProfit: amz.netProfit,
          margin: amz.revenue > 0 ? (amz.netProfit / amz.revenue) * 100 : 0,
          aov: amz.units > 0 ? amz.revenue / amz.units : 0,
          roas: amz.adSpend > 0 ? amz.revenue / amz.adSpend : 0,
          returnRate: amz.units > 0 ? (amz.returns / amz.units) * 100 : 0,
          skuData: Object.values(amz.skuData).sort((a, b) => b.netSales - a.netSales),
        },
        shopify: {
          revenue: shop.revenue,
          units: shop.units,
          cogs: shop.cogs,
          adSpend: shop.adSpend,
          metaSpend: shop.metaSpend,
          googleSpend: shop.googleSpend,
          discounts: shop.discounts,
          netProfit: shop.netProfit,
          netMargin: shop.revenue > 0 ? (shop.netProfit / shop.revenue) * 100 : 0,
          aov: shop.units > 0 ? shop.revenue / shop.units : 0,
          roas: shop.adSpend > 0 ? shop.revenue / shop.adSpend : 0,
          skuData: Object.values(shop.skuData).sort((a, b) => b.netSales - a.netSales),
        },
        total: {
          revenue: totalRev,
          units: amz.units + shop.units,
          cogs: totalCogs,
          adSpend: totalAds,
          netProfit: totalProfit,
          netMargin: totalRev > 0 ? (totalProfit / totalRev) * 100 : 0,
          roas: totalAds > 0 ? totalRev / totalAds : 0,
          amazonShare: totalRev > 0 ? (amz.revenue / totalRev) * 100 : 0,
          shopifyShare: totalRev > 0 ? (shop.revenue / totalRev) * 100 : 0,
        },
      };
      
      if (newWeeksData[weekKey]) {
        weeksUpdated++;
      } else {
        weeksCreated++;
      }
      newWeeksData[weekKey] = weekData;
    });
    
    setAllWeeksData(newWeeksData);
    save(newWeeksData);
    
    // Calculate days aggregated from complete weeks
    const daysAggregated = Object.values(completeWeeks).reduce((sum, w) => sum + w.days.length, 0);
    
    let message = `Aggregated ${daysAggregated} days into ${weeksCreated + weeksUpdated} week${weeksCreated + weeksUpdated !== 1 ? 's' : ''} (${weeksCreated} new, ${weeksUpdated} updated)`;
    if (incompleteWeeks.length > 0) {
      message += `. ${incompleteWeeks.length} incomplete week${incompleteWeeks.length !== 1 ? 's' : ''} skipped (need all 7 days Mon-Sun)`;
    }
    setToast({ message, type: 'success' });
  }, [allDaysData, allWeeksData, save]);

  const processBulkImport = useCallback(() => {
    const cogsLookup = getCogsLookup();
    if (!files.amazon || !files.shopify) { alert('Upload Amazon & Shopify files'); return; }
    if (Object.keys(cogsLookup).length === 0) { alert('Set up COGS first'); return; }
    setIsProcessing(true); setBulkImportResult(null);

    const amazonByWeek = {};
    files.amazon.forEach(row => {
      const endDate = row['End date'] || '';
      if (!endDate) return;
      let dateObj;
      if (endDate.includes('/')) { const [m, d, y] = endDate.split('/'); dateObj = new Date(y, m - 1, d); }
      else { dateObj = new Date(endDate); }
      const sunday = getSunday(dateObj);
      if (!amazonByWeek[sunday]) amazonByWeek[sunday] = [];
      amazonByWeek[sunday].push(row);
    });

    const amazonWeeks = Object.keys(amazonByWeek).sort();
    const newWeeksData = { ...allWeeksData };
    let weeksCreated = 0;

    amazonWeeks.forEach(weekEnd => {
      const rows = amazonByWeek[weekEnd];
      let amzRev = 0, amzUnits = 0, amzRet = 0, amzProfit = 0, amzCogs = 0, amzFees = 0, amzAds = 0;
      const amazonSkuData = {};
      rows.forEach(r => {
        const net = parseInt(r['Net units sold'] || 0), sold = parseInt(r['Units sold'] || 0), ret = parseInt(r['Units returned'] || 0);
        const sales = parseFloat(r['Net sales'] || 0), proceeds = parseFloat(r['Net proceeds total'] || 0), sku = r['MSKU'] || '';
        const fees = parseFloat(r['FBA fulfillment fees total'] || 0) + parseFloat(r['Referral fee total'] || 0) + parseFloat(r['AWD Storage Fee total'] || 0);
        const ads = parseFloat(r['Sponsored Products charge total'] || 0);
        const name = r['Product title'] || r['product-name'] || sku;
        if (net > 0 || sold > 0) { 
          amzRev += sales; amzUnits += sold; amzRet += ret; amzProfit += proceeds; amzFees += fees; amzAds += ads; amzCogs += (cogsLookup[sku] || 0) * net;
          if (sku) {
            if (!amazonSkuData[sku]) amazonSkuData[sku] = { sku, name, unitsSold: 0, returns: 0, netSales: 0, netProceeds: 0, adSpend: 0, cogs: 0 };
            amazonSkuData[sku].unitsSold += sold;
            amazonSkuData[sku].returns += ret;
            amazonSkuData[sku].netSales += sales;
            amazonSkuData[sku].netProceeds += proceeds;
            amazonSkuData[sku].adSpend += ads;
            amazonSkuData[sku].cogs += (cogsLookup[sku] || 0) * net;
          }
        }
      });
      const amazonSkus = Object.values(amazonSkuData).sort((a, b) => b.netSales - a.netSales);
      if (amzRev > 0 || amzUnits > 0) {
        newWeeksData[weekEnd] = {
          weekEnding: weekEnd, createdAt: new Date().toISOString(),
          amazon: { revenue: amzRev, units: amzUnits, returns: amzRet, cogs: amzCogs, fees: amzFees, adSpend: amzAds, netProfit: amzProfit, 
            margin: amzRev > 0 ? (amzProfit/amzRev)*100 : 0, aov: amzUnits > 0 ? amzRev/amzUnits : 0, roas: amzAds > 0 ? amzRev/amzAds : 0,
            returnRate: amzUnits > 0 ? (amzRet/amzUnits)*100 : 0, skuData: amazonSkus },
          shopify: { revenue: 0, units: 0, cogs: 0, threeplCosts: 0, adSpend: 0, metaSpend: 0, googleSpend: 0, discounts: 0, netProfit: 0, netMargin: 0, aov: 0, roas: 0, skuData: [] },
          total: { revenue: amzRev, units: amzUnits, cogs: amzCogs, adSpend: amzAds, netProfit: amzProfit, netMargin: amzRev > 0 ? (amzProfit/amzRev)*100 : 0, roas: amzAds > 0 ? amzRev/amzAds : 0, amazonShare: 100, shopifyShare: 0 }
        };
        weeksCreated++;
      }
    });

    // Distribute Shopify - also capture SKU data
    let shopRev = 0, shopUnits = 0, shopCogs = 0, shopDisc = 0;
    const shopifySkuData = {};
    files.shopify.forEach(r => { 
      const u = parseInt(r['Net items sold'] || 0), s = parseFloat(r['Net sales'] || 0), sku = r['Product variant SKU'] || ''; 
      const name = r['Product title'] || r['Product'] || sku;
      const disc = Math.abs(parseFloat(r['Discounts'] || 0));
      shopRev += s; shopUnits += u; shopCogs += (cogsLookup[sku] || 0) * u; shopDisc += disc;
      if (sku && u > 0) {
        if (!shopifySkuData[sku]) shopifySkuData[sku] = { sku, name, unitsSold: 0, netSales: 0, discounts: 0, cogs: 0 };
        shopifySkuData[sku].unitsSold += u;
        shopifySkuData[sku].netSales += s;
        shopifySkuData[sku].discounts += disc;
        shopifySkuData[sku].cogs += (cogsLookup[sku] || 0) * u;
      }
    });
    const shopifySkus = Object.values(shopifySkuData).sort((a, b) => b.netSales - a.netSales);
    const totalAmzRev = Object.values(newWeeksData).reduce((sum, w) => sum + (w.amazon?.revenue || 0), 0);
    if (totalAmzRev > 0 && shopRev > 0) {
      Object.keys(newWeeksData).forEach(weekEnd => {
        const week = newWeeksData[weekEnd];
        const prop = week.amazon.revenue / totalAmzRev;
        const wRev = shopRev * prop, wUnits = Math.round(shopUnits * prop), wCogs = shopCogs * prop, wDisc = shopDisc * prop, wProfit = wRev - wCogs;
        // Proportionally distribute SKU data
        const wShopifySkus = shopifySkus.map(s => ({ ...s, unitsSold: Math.round(s.unitsSold * prop), netSales: s.netSales * prop, discounts: s.discounts * prop, cogs: s.cogs * prop }));
        week.shopify = { revenue: wRev, units: wUnits, cogs: wCogs, threeplCosts: 0, adSpend: 0, metaSpend: 0, googleSpend: 0, discounts: wDisc, netProfit: wProfit, netMargin: wRev > 0 ? (wProfit/wRev)*100 : 0, aov: wUnits > 0 ? wRev/wUnits : 0, roas: 0, skuData: wShopifySkus };
        const tRev = week.amazon.revenue + wRev, tProfit = week.amazon.netProfit + wProfit;
        week.total = { revenue: tRev, units: week.amazon.units + wUnits, cogs: week.amazon.cogs + wCogs, adSpend: week.amazon.adSpend, netProfit: tProfit, netMargin: tRev > 0 ? (tProfit/tRev)*100 : 0, roas: week.amazon.adSpend > 0 ? tRev/week.amazon.adSpend : 0, amazonShare: tRev > 0 ? (week.amazon.revenue/tRev)*100 : 0, shopifyShare: tRev > 0 ? (wRev/tRev)*100 : 0 };
      });
    }

    setAllWeeksData(newWeeksData); save(newWeeksData);
    setBulkImportResult({ weeksCreated, dateRange: amazonWeeks.length > 0 ? `${amazonWeeks[0]} to ${amazonWeeks[amazonWeeks.length-1]}` : '' });
    setIsProcessing(false); setFiles({ amazon: null, shopify: null, cogs: null, threepl: null }); setFileNames({ amazon: '', shopify: '', cogs: '', threepl: '' });
  }, [files, allWeeksData, getCogsLookup]);

  const processCustomPeriod = useCallback(() => {
    if (!customStartDate || !customEndDate) { alert('Select dates'); return; }
    const start = new Date(customStartDate + 'T00:00:00'), end = new Date(customEndDate + 'T00:00:00');
    const weeksInRange = Object.entries(allWeeksData).filter(([w]) => { const d = new Date(w + 'T00:00:00'); return d >= start && d <= end; });
    if (!weeksInRange.length) { alert('No data in range'); return; }

    const agg = { startDate: customStartDate, endDate: customEndDate, weeksIncluded: weeksInRange.length,
      amazon: { revenue: 0, units: 0, cogs: 0, adSpend: 0, netProfit: 0 }, shopify: { revenue: 0, units: 0, cogs: 0, adSpend: 0, netProfit: 0 },
      total: { revenue: 0, units: 0, cogs: 0, adSpend: 0, netProfit: 0 }, weeklyBreakdown: [] };

    weeksInRange.forEach(([w, d]) => {
      agg.amazon.revenue += d.amazon?.revenue || 0; agg.amazon.units += d.amazon?.units || 0; agg.amazon.cogs += d.amazon?.cogs || 0; agg.amazon.adSpend += d.amazon?.adSpend || 0; agg.amazon.netProfit += d.amazon?.netProfit || 0;
      agg.shopify.revenue += d.shopify?.revenue || 0; agg.shopify.units += d.shopify?.units || 0; agg.shopify.cogs += d.shopify?.cogs || 0; agg.shopify.adSpend += d.shopify?.adSpend || 0; agg.shopify.netProfit += d.shopify?.netProfit || 0;
      agg.total.revenue += d.total?.revenue || 0; agg.total.units += d.total?.units || 0; agg.total.cogs += d.total?.cogs || 0; agg.total.adSpend += d.total?.adSpend || 0; agg.total.netProfit += d.total?.netProfit || 0;
      agg.weeklyBreakdown.push({ week: w, revenue: d.total?.revenue || 0, profit: d.total?.netProfit || 0 });
    });

    agg.amazon.margin = agg.amazon.revenue > 0 ? (agg.amazon.netProfit / agg.amazon.revenue) * 100 : 0;
    agg.shopify.netMargin = agg.shopify.revenue > 0 ? (agg.shopify.netProfit / agg.shopify.revenue) * 100 : 0;
    agg.total.netMargin = agg.total.revenue > 0 ? (agg.total.netProfit / agg.total.revenue) * 100 : 0;
    agg.total.amazonShare = agg.total.revenue > 0 ? (agg.amazon.revenue / agg.total.revenue) * 100 : 0;
    agg.total.shopifyShare = agg.total.revenue > 0 ? (agg.shopify.revenue / agg.total.revenue) * 100 : 0;
    agg.avgWeeklyRevenue = agg.total.revenue / weeksInRange.length;
    agg.avgWeeklyProfit = agg.total.netProfit / weeksInRange.length;

    setCustomPeriodData(agg); setView('custom');
  }, [customStartDate, customEndDate, allWeeksData]);

  // Process a period (month/year) without weekly breakdown
  const processPeriod = useCallback(() => {
    const cogsLookup = { ...savedCogs };
    if (!periodFiles.amazon || !periodFiles.shopify || !periodLabel.trim()) { alert('Upload Amazon & Shopify files and enter a label (e.g., "January 2025")'); return; }
    if (Object.keys(cogsLookup).length === 0) { alert('Set up COGS first via the COGS button'); return; }
    
    // Validate data before processing
    const amazonValidation = validateUploadData('amazon', periodFiles.amazon);
    const shopifyValidation = validateUploadData('shopify', periodFiles.shopify);
    const allWarnings = [...amazonValidation.warnings, ...amazonValidation.errors, ...shopifyValidation.warnings, ...shopifyValidation.errors];
    
    if (allWarnings.length > 0) {
      setDataValidationWarnings(allWarnings);
      setPendingProcessAction(() => processPeriodCore);
      setShowValidationModal(true);
      return;
    }
    
    processPeriodCore();
  }, [periodFiles, periodAdSpend, periodLabel, savedCogs, allPeriodsData, validateUploadData]);
  
  const processPeriodCore = useCallback(() => {
    const cogsLookup = { ...savedCogs };
    setIsProcessing(true);

    let amzRev = 0, amzUnits = 0, amzRet = 0, amzProfit = 0, amzCogs = 0, amzFees = 0, amzAds = 0;
    const amazonSkuData = {};
    periodFiles.amazon.forEach(r => {
      const net = parseInt(r['Net units sold'] || 0), sold = parseInt(r['Units sold'] || 0), ret = parseInt(r['Units returned'] || 0);
      const sales = parseFloat(r['Net sales'] || 0), proceeds = parseFloat(r['Net proceeds total'] || 0), sku = r['MSKU'] || '';
      const fees = parseFloat(r['FBA fulfillment fees total'] || 0) + parseFloat(r['Referral fee total'] || 0) + parseFloat(r['AWD Storage Fee total'] || 0);
      const ads = parseFloat(r['Sponsored Products charge total'] || 0);
      const name = r['Product title'] || r['product-name'] || sku;
      if (net > 0 || sold > 0) { 
        amzRev += sales; amzUnits += sold; amzRet += ret; amzProfit += proceeds; amzFees += fees; amzAds += ads; amzCogs += (cogsLookup[sku] || 0) * net;
        if (sku) {
          if (!amazonSkuData[sku]) amazonSkuData[sku] = { sku, name, unitsSold: 0, returns: 0, netSales: 0, netProceeds: 0, adSpend: 0, cogs: 0 };
          amazonSkuData[sku].unitsSold += sold;
          amazonSkuData[sku].returns += ret;
          amazonSkuData[sku].netSales += sales;
          amazonSkuData[sku].netProceeds += proceeds;
          amazonSkuData[sku].adSpend += ads;
          amazonSkuData[sku].cogs += (cogsLookup[sku] || 0) * net;
        }
      }
    });

    let shopRev = 0, shopUnits = 0, shopCogs = 0, shopDisc = 0;
    const shopifySkuData = {};
    periodFiles.shopify.forEach(r => {
      const units = parseInt(r['Net items sold'] || 0), sales = parseFloat(r['Net sales'] || 0), sku = r['Product variant SKU'] || '';
      const name = r['Product title'] || r['Product'] || sku;
      const disc = Math.abs(parseFloat(r['Discounts'] || 0));
      shopRev += sales; shopUnits += units; shopCogs += (cogsLookup[sku] || 0) * units; shopDisc += disc;
      if (sku && units > 0) {
        if (!shopifySkuData[sku]) shopifySkuData[sku] = { sku, name, unitsSold: 0, netSales: 0, discounts: 0, cogs: 0 };
        shopifySkuData[sku].unitsSold += units;
        shopifySkuData[sku].netSales += sales;
        shopifySkuData[sku].discounts += disc;
        shopifySkuData[sku].cogs += (cogsLookup[sku] || 0) * units;
      }
    });

    // Use enhanced 3PL parser
    const threeplData = parse3PLData(periodFiles.threepl);
    const threeplCost = threeplData.metrics.totalCost;
    const threeplBreakdown = threeplData.breakdown;
    const threeplMetrics = threeplData.metrics;

    const metaS = parseFloat(periodAdSpend.meta) || 0, googleS = parseFloat(periodAdSpend.google) || 0, shopAds = metaS + googleS;
    const shopProfit = shopRev - shopCogs - threeplCost - shopAds;
    const totalRev = amzRev + shopRev, totalProfit = amzProfit + shopProfit, totalCogs = amzCogs + shopCogs;

    const amazonSkus = Object.values(amazonSkuData).sort((a, b) => b.netSales - a.netSales);
    const shopifySkus = Object.values(shopifySkuData).sort((a, b) => b.netSales - a.netSales);

    const periodData = {
      label: periodLabel.trim(), createdAt: new Date().toISOString(),
      amazon: { revenue: amzRev, units: amzUnits, returns: amzRet, cogs: amzCogs, fees: amzFees, adSpend: amzAds, netProfit: amzProfit, 
        margin: amzRev > 0 ? (amzProfit/amzRev)*100 : 0, aov: amzUnits > 0 ? amzRev/amzUnits : 0, roas: amzAds > 0 ? amzRev/amzAds : 0,
        returnRate: amzUnits > 0 ? (amzRet/amzUnits)*100 : 0, skuData: amazonSkus },
      shopify: { revenue: shopRev, units: shopUnits, cogs: shopCogs, threeplCosts: threeplCost, threeplBreakdown, threeplMetrics, adSpend: shopAds, metaSpend: metaS, googleSpend: googleS, discounts: shopDisc, netProfit: shopProfit, 
        netMargin: shopRev > 0 ? (shopProfit/shopRev)*100 : 0, aov: shopUnits > 0 ? shopRev/shopUnits : 0, roas: shopAds > 0 ? shopRev/shopAds : 0, skuData: shopifySkus },
      total: { revenue: totalRev, units: amzUnits + shopUnits, cogs: totalCogs, adSpend: amzAds + shopAds, netProfit: totalProfit, netMargin: totalRev > 0 ? (totalProfit/totalRev)*100 : 0, roas: (amzAds + shopAds) > 0 ? totalRev/(amzAds + shopAds) : 0, amazonShare: totalRev > 0 ? (amzRev/totalRev)*100 : 0, shopifyShare: totalRev > 0 ? (shopRev/totalRev)*100 : 0 }
    };

    const periodKey = periodLabel.trim().toLowerCase().replace(/\s+/g, '-');
    const updated = { ...allPeriodsData, [periodKey]: periodData };
    setAllPeriodsData(updated); savePeriods(updated); setSelectedPeriod(periodKey); setView('period-view'); setIsProcessing(false);
    setPeriodFiles({ amazon: null, shopify: null, threepl: [] }); setPeriodFileNames({ amazon: '', shopify: '', threepl: [] }); setPeriodAdSpend({ meta: '', google: '' }); setPeriodLabel('');
    setToast({ message: 'Period data saved successfully!', type: 'success' });
  }, [periodFiles, periodAdSpend, periodLabel, allPeriodsData, savedCogs, savePeriods]);

  const deletePeriod = (k) => { 
    const data = allPeriodsData[k];
    if (!data) return;
    
    // Show preview of what's being deleted
    const revenue = data.total?.revenue || 0;
    const units = data.total?.units || 0;
    
    // Delete immediately but allow undo
    const u = { ...allPeriodsData }; 
    delete u[k]; 
    setAllPeriodsData(u); 
    savePeriods(u); 
    
    // Store deleted item for undo
    const undoId = Date.now();
    const undoTimer = setTimeout(() => {
      setDeletedItems(prev => prev.filter(item => item.id !== undoId));
    }, 10000);
    
    setDeletedItems(prev => [...prev, { id: undoId, type: 'period', key: k, data, undoTimer }]);
    setToast({ 
      message: `Deleted ${k} ($${revenue.toFixed(0)} rev, ${units} units)`, 
      type: 'warning',
      action: {
        label: 'Undo',
        onClick: () => {
          clearTimeout(undoTimer);
          const restored = { ...allPeriodsData, [k]: data };
          setAllPeriodsData(restored);
          savePeriods(restored);
          setSelectedPeriod(k);
          setDeletedItems(prev => prev.filter(item => item.id !== undoId));
          setToast({ message: `Restored ${k}`, type: 'success' });
        }
      }
    });
    
    const r = Object.keys(u).sort().reverse(); 
    if (r.length) setSelectedPeriod(r[0]); 
    else { setUploadTab('period'); setView('upload'); setSelectedPeriod(null); }
  };

  const processInventory = useCallback(() => {
    if (!invFiles.amazon || !invSnapshotDate) { alert('Upload Amazon FBA file and select date'); return; }
    setIsProcessing(true);

    const cogsLookup = { ...savedCogs };
    if (invFiles.cogs) invFiles.cogs.forEach(r => { const s = r['SKU'] || r['sku']; if (s) cogsLookup[s] = parseFloat(r['Cost Per Unit'] || 0); });
    if (invFiles.threepl) invFiles.threepl.forEach(r => { const s = r['sku']; const c = parseFloat(r['cost'] || 0); if (s && c && !cogsLookup[s]) cogsLookup[s] = c; });

    // Build Shopify velocity from actual SKU sales data
    const sortedWeeks = Object.keys(allWeeksData).sort().reverse().slice(0, 4);
    const weeksCount = sortedWeeks.length;
    const shopifySkuVelocity = {}; // sku -> weekly units
    
    if (weeksCount > 0) {
      // Aggregate Shopify SKU sales from recent weeks
      sortedWeeks.forEach(w => {
        const weekData = allWeeksData[w];
        if (weekData.shopify?.skuData) {
          weekData.shopify.skuData.forEach(item => {
            if (!shopifySkuVelocity[item.sku]) shopifySkuVelocity[item.sku] = 0;
            shopifySkuVelocity[item.sku] += item.unitsSold || 0;
          });
        }
      });
      // Convert totals to weekly averages
      Object.keys(shopifySkuVelocity).forEach(sku => {
        shopifySkuVelocity[sku] = shopifySkuVelocity[sku] / weeksCount;
      });
    }

    const amzInv = {}, tplInv = {};
    let amzTotal = 0, amzValue = 0, amzInbound = 0, tplTotal = 0, tplValue = 0, tplInbound = 0;

    invFiles.amazon.forEach(r => {
      const sku = r['sku'] || '', avail = parseInt(r['available'] || 0), inb = parseInt(r['inbound-quantity'] || 0);
      const res = parseInt(r['Total Reserved Quantity'] || 0), t30 = parseInt(r['units-shipped-t30'] || 0);
      const name = r['product-name'] || '', asin = r['asin'] || '';
      const cost = cogsLookup[sku] || 0, total = avail + res;
      amzTotal += total; amzValue += total * cost; amzInbound += inb;
      if (sku) amzInv[sku] = { sku, asin, name, total, inbound: inb, cost, amzWeeklyVel: t30 / 4.3 };
    });

    if (invFiles.threepl) {
      invFiles.threepl.forEach(r => {
        const sku = r['sku'] || '', name = r['name'] || '', qty = parseInt(r['quantity_on_hand'] || 0);
        const inb = parseInt(r['quantity_inbound'] || 0), cost = parseFloat(r['cost'] || 0) || cogsLookup[sku] || 0;
        if (sku.includes('Bundle') || name.includes('Gift Card') || name.includes('FREE') || qty === 0) return;
        tplTotal += qty; tplValue += qty * cost; tplInbound += inb;
        if (sku) tplInv[sku] = { sku, name, total: qty, inbound: inb, cost };
      });
    }

    const allSkus = new Set([...Object.keys(amzInv), ...Object.keys(tplInv)]);
    const items = [];
    let critical = 0, low = 0, healthy = 0, overstock = 0;
    let hasShopifySkuData = Object.keys(shopifySkuVelocity).length > 0;

    allSkus.forEach(sku => {
      const a = amzInv[sku] || {}, t = tplInv[sku] || {};
      const aQty = a.total || 0, tQty = t.total || 0, totalQty = aQty + tQty;
      const cost = a.cost || t.cost || cogsLookup[sku] || 0;
      const amzVel = a.amzWeeklyVel || 0;
      const shopVel = shopifySkuVelocity[sku] || 0;
      const totalVel = amzVel + shopVel;
      
      // Apply learned corrections to velocity predictions if we have enough data
      let correctedVel = totalVel;
      let velocitySource = 'historical';
      if (forecastCorrections.confidence >= 30 && forecastCorrections.samplesUsed >= 2) {
        // Check for SKU-specific correction first
        if (forecastCorrections.bySku[sku]?.samples >= 2) {
          correctedVel = totalVel * forecastCorrections.bySku[sku].units;
          velocitySource = 'sku-corrected';
        } else {
          // Use overall correction
          correctedVel = totalVel * forecastCorrections.overall.units;
          velocitySource = 'overall-corrected';
        }
      }
      
      const dos = correctedVel > 0 ? Math.round((totalQty / correctedVel) * 7) : 999;
      let health = 'unknown';
      if (totalVel > 0) {
        if (dos < 14) { health = 'critical'; critical++; }
        else if (dos < 30) { health = 'low'; low++; }
        else if (dos <= 90) { health = 'healthy'; healthy++; }
        else { health = 'overstock'; overstock++; }
      }
      items.push({ sku, name: a.name || t.name || sku, asin: a.asin || '', amazonQty: aQty, threeplQty: tQty, totalQty, cost, totalValue: totalQty * cost, weeklyVel: totalVel, correctedVel: correctedVel, velocitySource, amzWeeklyVel: amzVel, shopWeeklyVel: shopVel, daysOfSupply: dos, health, amazonInbound: a.inbound || 0, threeplInbound: t.inbound || 0 });
    });
    items.sort((a, b) => b.totalValue - a.totalValue);

    const velNote = hasShopifySkuData 
      ? `Amazon + Shopify SKU data (${weeksCount}wk avg)` 
      : weeksCount > 0 
        ? `Amazon only (no Shopify SKU data - re-process weeks to add)` 
        : 'Amazon only';
    
    const learningNote = forecastCorrections.confidence >= 30 
      ? ` + AI-corrected (${forecastCorrections.confidence.toFixed(0)}% confidence)`
      : '';
    
    const snapshot = {
      date: invSnapshotDate, createdAt: new Date().toISOString(), velocitySource: velNote + learningNote,
      summary: { totalUnits: amzTotal + tplTotal, totalValue: amzValue + tplValue, amazonUnits: amzTotal, amazonValue: amzValue, amazonInbound: amzInbound, threeplUnits: tplTotal, threeplValue: tplValue, threeplInbound: tplInbound, critical, low, healthy, overstock, skuCount: items.length },
      items,
      learningStatus: {
        correctionsApplied: forecastCorrections.confidence >= 30,
        confidence: forecastCorrections.confidence,
        samplesUsed: forecastCorrections.samplesUsed,
        lastUpdated: forecastCorrections.lastUpdated,
      }
    };

    const updated = { ...invHistory, [invSnapshotDate]: snapshot };
    setInvHistory(updated); saveInv(updated); setSelectedInvDate(invSnapshotDate); setView('inventory'); setIsProcessing(false);
    setInvFiles({ amazon: null, threepl: null, cogs: null }); setInvFileNames({ amazon: '', threepl: '', cogs: '' }); setInvSnapshotDate('');
  }, [invFiles, invSnapshotDate, invHistory, savedCogs, allWeeksData, forecastCorrections]);

  const deleteWeek = (k) => { 
    const data = allWeeksData[k];
    if (!data) return;
    
    const revenue = data.total?.revenue || 0;
    const units = data.total?.units || 0;
    
    // Delete immediately
    const u = { ...allWeeksData }; 
    delete u[k]; 
    setAllWeeksData(u); 
    save(u); 
    
    // Store for undo
    const undoId = Date.now();
    const undoTimer = setTimeout(() => {
      setDeletedItems(prev => prev.filter(item => item.id !== undoId));
    }, 10000);
    
    setDeletedItems(prev => [...prev, { id: undoId, type: 'week', key: k, data, undoTimer }]);
    setToast({ 
      message: `Deleted week ${k} ($${revenue.toFixed(0)} rev, ${units} units)`, 
      type: 'warning',
      action: {
        label: 'Undo',
        onClick: () => {
          clearTimeout(undoTimer);
          const restored = { ...allWeeksData, [k]: data };
          setAllWeeksData(restored);
          save(restored);
          setSelectedWeek(k);
          setDeletedItems(prev => prev.filter(item => item.id !== undoId));
          setToast({ message: `Restored week ${k}`, type: 'success' });
        }
      }
    });
    
    const r = Object.keys(u).sort().reverse(); 
    if (r.length) setSelectedWeek(r[0]); 
    else { setView('upload'); setSelectedWeek(null); }
  };
  
  const deleteInv = (k) => { 
    const data = invHistory[k];
    if (!data) return;
    
    const totalUnits = data.summary?.totalUnits || 0;
    
    // Delete immediately
    const u = { ...invHistory }; 
    delete u[k]; 
    setInvHistory(u); 
    saveInv(u); 
    
    // Store for undo
    const undoId = Date.now();
    const undoTimer = setTimeout(() => {
      setDeletedItems(prev => prev.filter(item => item.id !== undoId));
    }, 10000);
    
    setDeletedItems(prev => [...prev, { id: undoId, type: 'inventory', key: k, data, undoTimer }]);
    setToast({ 
      message: `Deleted inventory ${k} (${totalUnits} units)`, 
      type: 'warning',
      action: {
        label: 'Undo',
        onClick: () => {
          clearTimeout(undoTimer);
          const restored = { ...invHistory, [k]: data };
          setInvHistory(restored);
          saveInv(restored);
          setSelectedInvDate(k);
          setDeletedItems(prev => prev.filter(item => item.id !== undoId));
          setToast({ message: `Restored inventory ${k}`, type: 'success' });
        }
      }
    });
    
    const r = Object.keys(u).sort().reverse(); 
    if (r.length) setSelectedInvDate(r[0]); 
    else setSelectedInvDate(null); 
  };

  const updateWeekAdSpend = useCallback((weekKey, metaSpend, googleSpend) => {
    const week = allWeeksData[weekKey];
    if (!week) return;
    const metaS = parseFloat(metaSpend) || 0, googleS = parseFloat(googleSpend) || 0;
    const totalShopAds = metaS + googleS;
    const oldShopAds = week.shopify.adSpend || 0;
    const shopProfit = week.shopify.netProfit + oldShopAds - totalShopAds; // adjust profit
    const updated = { ...allWeeksData };
    updated[weekKey] = {
      ...week,
      shopify: { ...week.shopify, adSpend: totalShopAds, metaSpend: metaS, googleSpend: googleS, netProfit: shopProfit,
        netMargin: week.shopify.revenue > 0 ? (shopProfit/week.shopify.revenue)*100 : 0,
        roas: totalShopAds > 0 ? week.shopify.revenue/totalShopAds : 0 },
      total: { ...week.total, adSpend: week.amazon.adSpend + totalShopAds, netProfit: week.amazon.netProfit + shopProfit,
        netMargin: week.total.revenue > 0 ? ((week.amazon.netProfit + shopProfit)/week.total.revenue)*100 : 0,
        roas: (week.amazon.adSpend + totalShopAds) > 0 ? week.total.revenue/(week.amazon.adSpend + totalShopAds) : 0 }
    };
    setAllWeeksData(updated); save(updated); setShowEditAdSpend(false);
  }, [allWeeksData]);

  // Update 3PL costs for a week
  const updateWeek3PL = useCallback((weekKey, threeplCost) => {
    const week = allWeeksData[weekKey];
    if (!week) return;
    const newCost = parseFloat(threeplCost) || 0;
    const oldCost = week.shopify?.threeplCosts || 0;
    const shopProfit = (week.shopify?.netProfit || 0) + oldCost - newCost; // adjust profit
    const updated = { ...allWeeksData };
    updated[weekKey] = {
      ...week,
      shopify: { 
        ...week.shopify, 
        threeplCosts: newCost, 
        netProfit: shopProfit,
        netMargin: week.shopify?.revenue > 0 ? (shopProfit / week.shopify.revenue) * 100 : 0,
      },
      total: { 
        ...week.total, 
        netProfit: (week.amazon?.netProfit || 0) + shopProfit,
        netMargin: week.total?.revenue > 0 ? (((week.amazon?.netProfit || 0) + shopProfit) / week.total.revenue) * 100 : 0,
      }
    };
    setAllWeeksData(updated); 
    save(updated); 
    setShowEdit3PL(false);
    setToast({ message: '3PL costs updated', type: 'success' });
  }, [allWeeksData]);

  // Parse Amazon Campaign CSV (aggregate campaign data)
  const parseAmazonCampaignCSV = useCallback((content) => {
    try {
      const lines = content.trim().split(/\r?\n/);
      if (lines.length < 2) return { error: 'File is empty or has no data rows' };
      
      const header = lines[0].toLowerCase();
      
      // Check if this is Amazon campaign data
      if (!header.includes('campaigns') || !header.includes('roas')) {
        return { error: 'Not a valid Amazon Campaign report. Expected columns: Campaigns, Spend, Sales, ROAS' };
      }
      
      // Parse header to find column indices
      const headerCols = [];
      let current = '', inQuotes = false;
      for (const char of lines[0]) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headerCols.push(current.trim().toLowerCase()); current = ''; }
        else current += char;
      }
      headerCols.push(current.trim().toLowerCase());
      
      const colIdx = {
        state: headerCols.findIndex(h => h === 'state'),
        campaign: headerCols.findIndex(h => h === 'campaigns'),
        status: headerCols.findIndex(h => h === 'status'),
        type: headerCols.findIndex(h => h === 'type'),
        targeting: headerCols.findIndex(h => h === 'targeting'),
        startDate: headerCols.findIndex(h => h === 'start date'),
        budget: headerCols.findIndex(h => h.includes('budget') && !h.includes('converted')),
        clicks: headerCols.findIndex(h => h === 'clicks'),
        ctr: headerCols.findIndex(h => h === 'ctr'),
        spend: headerCols.findIndex(h => h === 'spend (converted)' || (h === 'spend' && !h.includes('converted'))),
        cpc: headerCols.findIndex(h => h === 'cpc (converted)' || (h === 'cpc' && !h.includes('converted'))),
        orders: headerCols.findIndex(h => h === 'orders'),
        sales: headerCols.findIndex(h => h === 'sales (converted)' || (h === 'sales' && !h.includes('converted'))),
        roas: headerCols.findIndex(h => h === 'roas'),
        impressionShare: headerCols.findIndex(h => h.includes('impression share')),
      };
      
      // If spend (converted) not found, try just spend
      if (colIdx.spend === -1) colIdx.spend = headerCols.findIndex(h => h === 'spend');
      if (colIdx.sales === -1) colIdx.sales = headerCols.findIndex(h => h === 'sales');
      if (colIdx.cpc === -1) colIdx.cpc = headerCols.findIndex(h => h === 'cpc');
      
      const campaigns = [];
      let totalSpend = 0, totalSales = 0, totalOrders = 0, totalClicks = 0;
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        // Parse CSV row
        const cols = [];
        let curr = '', inQ = false;
        for (const char of line) {
          if (char === '"') inQ = !inQ;
          else if (char === ',' && !inQ) { cols.push(curr); curr = ''; }
          else curr += char;
        }
        cols.push(curr);
        
        const parseNum = (val) => parseFloat((val || '').replace(/[\$,%]/g, '').replace(/,/g, '')) || 0;
        
        const campaign = {
          id: i,
          state: cols[colIdx.state] || '',
          name: cols[colIdx.campaign] || '',
          status: cols[colIdx.status] || '',
          type: cols[colIdx.type] || '',
          targeting: cols[colIdx.targeting] || '',
          startDate: cols[colIdx.startDate] || '',
          budget: parseNum(cols[colIdx.budget]),
          clicks: parseInt(cols[colIdx.clicks]) || 0,
          ctr: parseNum(cols[colIdx.ctr]),
          spend: parseNum(cols[colIdx.spend]),
          cpc: parseNum(cols[colIdx.cpc]),
          orders: parseInt(cols[colIdx.orders]) || 0,
          sales: parseNum(cols[colIdx.sales]),
          roas: parseNum(cols[colIdx.roas]),
          impressionShare: cols[colIdx.impressionShare] || '',
          acos: 0,
          convRate: 0,
        };
        
        // Calculate derived metrics
        campaign.acos = campaign.sales > 0 ? (campaign.spend / campaign.sales) * 100 : 0;
        campaign.convRate = campaign.clicks > 0 ? (campaign.orders / campaign.clicks) * 100 : 0;
        
        campaigns.push(campaign);
        totalSpend += campaign.spend;
        totalSales += campaign.sales;
        totalOrders += campaign.orders;
        totalClicks += campaign.clicks;
      }
      
      // Calculate summary metrics
      const summary = {
        totalCampaigns: campaigns.length,
        enabledCount: campaigns.filter(c => c.state === 'ENABLED').length,
        pausedCount: campaigns.filter(c => c.state === 'PAUSED').length,
        totalSpend,
        totalSales,
        totalOrders,
        totalClicks,
        roas: totalSpend > 0 ? totalSales / totalSpend : 0,
        acos: totalSales > 0 ? (totalSpend / totalSales) * 100 : 0,
        avgCpc: totalClicks > 0 ? totalSpend / totalClicks : 0,
        convRate: totalClicks > 0 ? (totalOrders / totalClicks) * 100 : 0,
        byType: {
          SP: campaigns.filter(c => c.type === 'SP'),
          SB: campaigns.filter(c => c.type === 'SB2' || c.type === 'SB'),
          SD: campaigns.filter(c => c.type === 'SD'),
        }
      };
      
      return { campaigns, summary };
    } catch (e) {
      return { error: e.message };
    }
  }, []);

  // Save Amazon campaign data
  const saveAmazonCampaigns = useCallback((campaigns, summary) => {
    const now = new Date().toISOString();
    const weekKey = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    
    // Create snapshot with full campaign data for WoW comparison
    const snapshot = {
      date: now,
      weekKey,
      summary: { ...summary },
      // Store top campaigns for quick access in history
      topCampaigns: [...campaigns].sort((a, b) => b.spend - a.spend).slice(0, 20).map(c => ({
        name: c.name, type: c.type, state: c.state, spend: c.spend, sales: c.sales, orders: c.orders, roas: c.roas, acos: c.acos
      }))
    };
    
    // Merge with existing history, avoiding duplicate weeks
    const existingHistory = (amazonCampaigns.history || []).filter(h => h.weekKey !== weekKey);
    
    const newData = {
      campaigns,
      summary,
      lastUpdated: now,
      history: [snapshot, ...existingHistory].slice(0, 52) // Keep up to 52 weeks (1 year)
    };
    
    setAmazonCampaigns(newData);
    localStorage.setItem('ecommerce_amazon_campaigns_v1', JSON.stringify(newData));
    
    // Sync to cloud
    queueCloudSave({ ...combinedData, amazonCampaigns: newData });
    
    return newData;
  }, [amazonCampaigns, combinedData, queueCloudSave]);

  // Parse bulk ad file (Google Ads or Meta Ads CSV)
  const parseBulkAdFile = useCallback((content, platform, filename = '') => {
    try {
      const lines = content.trim().split('\n');
      if (lines.length < 2) return { error: 'File is empty or has no data rows' };
      
      const header = lines[0].toLowerCase();
      const dailyData = [];
      let totalSpend = 0;
      let totalImpressions = 0;
      let totalClicks = 0;
      let totalConversions = 0;
      
      // Detect format based on headers - support daily (Date), monthly (Month), quarterly (Quarter), and hourly (Hour) formats
      const hasDateCol = header.includes('date') || header.includes('month') || header.includes('day') || header.includes('quarter');
      const hasHourCol = header.includes('hour');
      const hasCostCol = header.includes('cost') || header.includes('spend');
      const isGoogleAds = (hasDateCol || hasHourCol) && hasCostCol;
      const isMetaAds = (hasDateCol || hasHourCol) && (header.includes('amount spent') || hasCostCol);
      const isHourlyData = hasHourCol && !hasDateCol;
      const isQuarterlyData = header.includes('quarter');
      
      if (!isGoogleAds && !isMetaAds) {
        return { error: 'Could not detect file format. Expected columns: Date/Month/Quarter/Hour and Cost/Spend' };
      }
      
      // Parse headers to find all columns
      const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
      const dateCol = headers.findIndex(h => h === 'date' || h === 'day' || h === 'month' || h === 'hour' || h === 'quarter' || h.includes('date'));
      const costCol = headers.findIndex(h => h === 'cost' || h === 'spend' || h === 'amount spent' || (h.includes('cost') && !h.includes('/')));
      const impressionsCol = headers.findIndex(h => h === 'impressions' || h === 'impr' || h.includes('impression'));
      const cpcCol = headers.findIndex(h => h === 'avg. cpc' || h === 'cpc' || h.includes('cost per click'));
      const cpaCol = headers.findIndex(h => h === 'cost / conv.' || h === 'cpa' || h.includes('cost per') || h.includes('/ conv'));
      
      // Detect if this is monthly or quarterly data
      const isMonthlyData = headers[dateCol] === 'month' || isQuarterlyData;
      
      if (dateCol === -1 || costCol === -1) {
        return { error: `Could not find required columns. Found headers: ${headers.join(', ')}` };
      }
      
      // For hourly data, we need to extract the date from the filename or use today
      // We'll aggregate all hours into a single day entry
      if (isHourlyData) {
        let hourlySpend = 0;
        let hourlyImpressions = 0;
        let hourlyCpc = 0;
        let hourlyCpa = 0;
        let hourCount = 0;
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = [];
          let current = '';
          let inQuotes = false;
          for (const char of line) {
            if (char === '"') inQuotes = !inQuotes;
            else if (char === ',' && !inQuotes) { cols.push(current.trim()); current = ''; }
            else current += char;
          }
          cols.push(current.trim());
          
          const cost = parseFloat(cols[costCol]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '')) || 0;
          const impressions = parseInt(cols[impressionsCol]?.replace(/"/g, '').replace(/,/g, '')) || 0;
          const cpc = parseFloat(cols[cpcCol]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '')) || 0;
          const cpa = parseFloat(cols[cpaCol]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '')) || 0;
          
          hourlySpend += cost;
          hourlyImpressions += impressions;
          if (cpc > 0) { hourlyCpc += cpc; hourCount++; }
          if (cpa > 0) hourlyCpa += cpa;
        }
        
        // Try to extract date from filename like "Time_series_2025_02_28_.csv"
        let dateStr;
        const filenameMatch = filename.match(/(\d{4})_(\d{2})_(\d{2})/);
        if (filenameMatch) {
          dateStr = `${filenameMatch[1]}-${filenameMatch[2]}-${filenameMatch[3]}`;
        } else {
          // Fall back to yesterday's date
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          dateStr = yesterday.toISOString().split('T')[0];
        }
        
        const avgCpc = hourCount > 0 ? hourlyCpc / hourCount : 0;
        const clicks = avgCpc > 0 ? Math.round(hourlySpend / avgCpc) : 0;
        const conversions = hourlyCpa > 0 ? Math.round(hourlySpend / hourlyCpa) : 0;
        
        dailyData.push({
          date: dateStr,
          spend: hourlySpend,
          impressions: hourlyImpressions,
          clicks,
          cpc: avgCpc,
          cpa: hourlyCpa,
          conversions,
          isHourly: true,
        });
        
        totalSpend = hourlySpend;
        totalImpressions = hourlyImpressions;
        totalClicks = clicks;
        totalConversions = conversions;
        
        // Skip to aggregation
      } else {
        // Parse data rows (daily or monthly)
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        // Handle CSV with quoted fields
        const cols = [];
        let current = '';
        let inQuotes = false;
        for (const char of line) {
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            cols.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        cols.push(current.trim());
        
        // Parse date - handle formats like "Sun, Dec 21, 2025" or "2025-12-21" or "12/21/2025" or "Apr 2024" or "4th quarter 2023"
        let dateStr = cols[dateCol]?.replace(/"/g, '').trim();
        let parsedDate = null;
        let isMonthlyRecord = false;
        let isQuarterlyRecord = false;
        
        const monthNames = { jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5, jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11 };
        
        // Try quarterly format like "4th quarter 2023" or "1st quarter 2024"
        const quarterlyMatch = dateStr.match(/(\d)(?:st|nd|rd|th)\s+quarter\s+(\d{4})/i);
        if (quarterlyMatch) {
          const quarter = parseInt(quarterlyMatch[1]);
          const year = parseInt(quarterlyMatch[2]);
          // Use last day of the quarter
          const quarterEndMonth = quarter * 3 - 1; // Q1=2 (Mar), Q2=5 (Jun), Q3=8 (Sep), Q4=11 (Dec)
          parsedDate = new Date(year, quarterEndMonth + 1, 0); // Last day of quarter
          isMonthlyRecord = true; // Treat as monthly for storage
          isQuarterlyRecord = true;
        }
        
        // Try "Mon YYYY" format (Monthly Google Ads like "Apr 2024")
        if (!parsedDate) {
          const monthlyMatch = dateStr.match(/^(\w{3})\s+(\d{4})$/);
          if (monthlyMatch) {
            const month = monthNames[monthlyMatch[1].toLowerCase()];
            if (month !== undefined) {
              // For monthly data, use the last day of the month
              const year = parseInt(monthlyMatch[2]);
              // Get last day of the month
              parsedDate = new Date(year, month + 1, 0); // Day 0 of next month = last day of this month
              isMonthlyRecord = true;
            }
          }
        }
        
        // Try "Day, Mon DD, YYYY" format (Daily Google Ads)
        if (!parsedDate) {
          const googleMatch = dateStr.match(/\w+,\s*(\w+)\s+(\d+),\s*(\d{4})/);
          if (googleMatch) {
            const month = monthNames[googleMatch[1].toLowerCase().substring(0, 3)];
            if (month !== undefined) {
              parsedDate = new Date(parseInt(googleMatch[3]), month, parseInt(googleMatch[2]));
            }
          }
        }
        
        // Try ISO format "YYYY-MM-DD"
        if (!parsedDate && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          parsedDate = new Date(dateStr + 'T00:00:00');
        }
        
        // Try US format "MM/DD/YYYY"
        if (!parsedDate && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
          const parts = dateStr.split('/');
          parsedDate = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
        }
        
        if (!parsedDate || isNaN(parsedDate)) continue;
        
        // Parse cost - remove $, commas, quotes
        let costStr = cols[costCol]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '').trim();
        const cost = parseFloat(costStr) || 0;
        
        // Parse impressions
        let impressionsStr = impressionsCol >= 0 ? cols[impressionsCol]?.replace(/"/g, '').replace(/,/g, '').trim() : '0';
        const impressions = parseInt(impressionsStr) || 0;
        
        // Parse CPC
        let cpcStr = cpcCol >= 0 ? cols[cpcCol]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '').trim() : '0';
        const cpc = parseFloat(cpcStr) || 0;
        
        // Parse CPA (cost per conversion)
        let cpaStr = cpaCol >= 0 ? cols[cpaCol]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '').trim() : '0';
        const cpa = parseFloat(cpaStr) || 0;
        
        // Calculate clicks from cost/CPC
        const clicks = cpc > 0 ? Math.round(cost / cpc) : 0;
        
        // Calculate conversions from cost/CPA
        const conversions = cpa > 0 ? Math.round(cost / cpa) : 0;
        
        if (cost > 0 || impressions > 0) {
          dailyData.push({
            date: parsedDate.toISOString().split('T')[0],
            spend: cost,
            impressions,
            clicks,
            cpc,
            cpa,
            conversions,
            isMonthly: isMonthlyRecord,
            monthLabel: isMonthlyRecord ? dateStr : null, // Store original month label like "Apr 2024"
          });
          totalSpend += cost;
          totalImpressions += impressions;
          totalClicks += clicks;
          totalConversions += conversions;
        }
      }
      } // end else (not hourly)
      
      if (dailyData.length === 0) {
        return { error: 'No valid data rows found' };
      }
      
      // Sort by date
      dailyData.sort((a, b) => a.date.localeCompare(b.date));
      
      // Check if this is all monthly data
      const isAllMonthly = dailyData.every(d => d.isMonthly);
      
      // For monthly data, create monthly periods instead of weekly
      let weeklyData = [];
      let monthlyData = [];
      
      if (isAllMonthly) {
        // Store as monthly periods
        monthlyData = dailyData.map(d => ({
          periodLabel: d.monthLabel, // "Apr 2024"
          date: d.date,
          spend: d.spend,
          impressions: d.impressions,
          clicks: d.clicks,
          conversions: d.conversions,
          cpc: d.cpc,
          cpa: d.cpa,
          ctr: d.impressions > 0 ? (d.clicks / d.impressions) * 100 : 0,
        }));
      } else {
        // Aggregate into weeks (Monday to Sunday, ending Sunday)
        const weeklyMap = {};
        dailyData.forEach(d => {
          const date = new Date(d.date + 'T12:00:00');
          const dayOfWeek = date.getDay(); // 0 = Sunday
          const daysUntilSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
          const weekEndDate = new Date(date);
          weekEndDate.setDate(weekEndDate.getDate() + daysUntilSunday);
          const weekEnding = formatDateKey(weekEndDate);
          
          if (!weeklyMap[weekEnding]) {
            weeklyMap[weekEnding] = { 
              weekEnding, spend: 0, impressions: 0, clicks: 0, conversions: 0, days: [] 
            };
          }
          weeklyMap[weekEnding].spend += d.spend;
          weeklyMap[weekEnding].impressions += d.impressions;
          weeklyMap[weekEnding].clicks += d.clicks;
          weeklyMap[weekEnding].conversions += d.conversions;
          weeklyMap[weekEnding].days.push(d.date);
        });
        
        // Calculate averages for weekly data
        Object.values(weeklyMap).forEach(w => {
          w.cpc = w.clicks > 0 ? w.spend / w.clicks : 0;
          w.cpa = w.conversions > 0 ? w.spend / w.conversions : 0;
          w.ctr = w.impressions > 0 ? (w.clicks / w.impressions) * 100 : 0;
        });
        
        weeklyData = Object.values(weeklyMap).sort((a, b) => a.weekEnding.localeCompare(b.weekEnding));
      }
      
      // Count weeks/months with existing data
      let weeksWithExistingData = 0;
      let monthsWithExistingData = 0;
      
      if (isAllMonthly) {
        monthlyData.forEach(m => {
          if (allPeriodsData[m.periodLabel]) monthsWithExistingData++;
        });
      } else {
        weeklyData.forEach(w => {
          if (allWeeksData[w.weekEnding]) weeksWithExistingData++;
        });
      }
      
      const dateRange = dailyData.length > 0 
        ? isAllMonthly 
          ? `${dailyData[0].monthLabel} - ${dailyData[dailyData.length - 1].monthLabel}`
          : `${new Date(dailyData[0].date + 'T00:00:00').toLocaleDateString()} - ${new Date(dailyData[dailyData.length - 1].date + 'T00:00:00').toLocaleDateString()}`
        : '';
      
      // Calculate overall averages
      const avgCpc = totalClicks > 0 ? totalSpend / totalClicks : 0;
      const avgCpa = totalConversions > 0 ? totalSpend / totalConversions : 0;
      const avgCtr = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;
      
      return {
        dailyData,
        weeklyData,
        monthlyData,
        isMonthlyData: isAllMonthly,
        totalSpend,
        totalImpressions,
        totalClicks,
        totalConversions,
        avgCpc,
        avgCpa,
        avgCtr,
        dateRange,
        weeksWithExistingData,
        monthsWithExistingData,
      };
    } catch (e) {
      return { error: `Parse error: ${e.message}` };
    }
  }, [allWeeksData, allPeriodsData]);
  
  // Process bulk ad upload - update weeks or periods with ad spend
  const processBulkAdUpload = useCallback((parsed, platform) => {
    if (!parsed) return;
    
    // Handle monthly data
    if (parsed.isMonthlyData && parsed.monthlyData?.length > 0) {
      setIsProcessing(true);
      
      try {
        const updatedPeriods = { ...allPeriodsData };
        let updatedCount = 0;
        let createdCount = 0;
        let skippedCount = 0;
        const skippedMonths = [];
        
        parsed.monthlyData.forEach(m => {
          const periodKey = m.periodLabel; // "Apr 2024"
          
          // Check if we have weekly data for this month (weekly data takes precedence)
          // Parse "Apr 2024" to check for weekly data
          const monthMatch = periodKey.match(/^(\w{3})\s+(\d{4})$/);
          if (monthMatch) {
            const monthNames = { jan: 1, feb: 2, mar: 3, apr: 4, may: 5, jun: 6, jul: 7, aug: 8, sep: 9, oct: 10, nov: 11, dec: 12 };
            const monthNum = monthNames[monthMatch[1].toLowerCase()];
            const year = parseInt(monthMatch[2]);
            
            if (monthNum && year) {
              // Check if any weeks exist in this month
              const hasWeeklyData = Object.keys(allWeeksData).some(weekKey => {
                const weekDate = new Date(weekKey + 'T00:00:00');
                return weekDate.getFullYear() === year && weekDate.getMonth() + 1 === monthNum;
              });
              
              if (hasWeeklyData) {
                // Skip this month - weekly data takes precedence
                skippedCount++;
                skippedMonths.push(periodKey);
                return;
              }
            }
          }
          
          if (updatedPeriods[periodKey]) {
            // Period exists - update ad spend
            const period = updatedPeriods[periodKey];
            const oldGoogleSpend = period.shopify?.googleSpend || period.shopify?.googleAds || 0;
            const oldMetaSpend = period.shopify?.metaSpend || period.shopify?.metaAds || 0;
            
            let newMetaSpend = oldMetaSpend;
            let newGoogleSpend = oldGoogleSpend;
            
            if (platform === 'google') {
              newGoogleSpend = m.spend;
            } else {
              newMetaSpend = m.spend;
            }
            
            const totalShopAds = newMetaSpend + newGoogleSpend;
            const oldShopAds = period.shopify?.adSpend || 0;
            const shopProfit = (period.shopify?.netProfit || 0) + oldShopAds - totalShopAds;
            
            updatedPeriods[periodKey] = {
              ...period,
              shopify: {
                ...period.shopify,
                adSpend: totalShopAds,
                metaSpend: newMetaSpend,
                metaAds: newMetaSpend,
                googleSpend: newGoogleSpend,
                googleAds: newGoogleSpend,
                netProfit: shopProfit,
              },
              total: {
                ...period.total,
                adSpend: (period.amazon?.adSpend || 0) + totalShopAds,
                netProfit: (period.amazon?.netProfit || 0) + shopProfit,
              },
              // Store ad KPIs
              adKPIs: {
                ...(period.adKPIs || {}),
                [platform]: {
                  spend: m.spend,
                  impressions: m.impressions,
                  clicks: m.clicks,
                  conversions: m.conversions,
                  cpc: m.cpc,
                  cpa: m.cpa,
                  ctr: m.ctr,
                }
              }
            };
            updatedCount++;
          } else {
            // Period doesn't exist - create it with ad data
            const metaSpend = platform === 'meta' ? m.spend : 0;
            const googleSpend = platform === 'google' ? m.spend : 0;
            const totalAds = metaSpend + googleSpend;
            
            updatedPeriods[periodKey] = {
              amazon: { revenue: 0, units: 0, cogs: 0, fees: 0, adSpend: 0, netProfit: 0 },
              shopify: { 
                revenue: 0, units: 0, cogs: 0, threeplCosts: 0, 
                adSpend: totalAds, metaSpend, metaAds: metaSpend, googleSpend, googleAds: googleSpend,
                netProfit: -totalAds
              },
              total: { revenue: 0, units: 0, cogs: 0, adSpend: totalAds, netProfit: -totalAds },
              adKPIs: {
                [platform]: {
                  spend: m.spend,
                  impressions: m.impressions,
                  clicks: m.clicks,
                  conversions: m.conversions,
                  cpc: m.cpc,
                  cpa: m.cpa,
                  ctr: m.ctr,
                }
              },
              _adDataOnly: true,
            };
            createdCount++;
          }
        });
        
        setAllPeriodsData(updatedPeriods);
        savePeriods(updatedPeriods);
        
        setBulkAdFiles([]);
        setBulkAdParsed(null);
        
        const platformName = platform === 'google' ? 'Google' : 'Meta';
        let message = `${platformName} ads updated for ${updatedCount + createdCount} month(s)`;
        if (skippedCount > 0) {
          message += `. Skipped ${skippedCount} month(s) with weekly data: ${skippedMonths.slice(0, 3).join(', ')}${skippedMonths.length > 3 ? '...' : ''}`;
        }
        setToast({ 
          message, 
          type: 'success' 
        });
      } catch (e) {
        setToast({ message: `Error: ${e.message}`, type: 'error' });
      } finally {
        setIsProcessing(false);
      }
      return;
    }
    
    // Handle weekly data (which comes from daily data aggregation)
    if (!parsed?.weeklyData?.length) return;
    
    setIsProcessing(true);
    
    try {
      const updated = { ...allWeeksData };
      const updatedDays = { ...allDaysData }; // Also store daily data
      let updatedCount = 0;
      let createdCount = 0;
      let dailyCount = 0;
      
      // First, store the raw daily data if available
      if (parsed.dailyData?.length > 0) {
        parsed.dailyData.forEach(d => {
          if (d.isMonthly || d.isHourly) return; // Skip monthly/hourly records for daily storage
          
          const dayKey = d.date; // YYYY-MM-DD format
          const existingDay = updatedDays[dayKey] || {};
          const existingShopify = existingDay.shopify || { revenue: 0, units: 0, cogs: 0, adSpend: 0, metaSpend: 0, googleSpend: 0, discounts: 0, netProfit: 0 };
          
          // Store ad spend in daily data - both at top level AND in shopify object
          if (platform === 'google') {
            const newGoogleSpend = d.spend;
            const existingMeta = existingDay.metaSpend || existingShopify.metaSpend || 0;
            const totalAds = existingMeta + newGoogleSpend;
            
            // Recalculate profit with updated ad spend
            const grossProfit = (existingShopify.revenue || 0) - (existingShopify.cogs || 0) - (existingShopify.threeplCosts || 0);
            const newNetProfit = grossProfit - totalAds;
            
            updatedDays[dayKey] = {
              ...existingDay,
              // Top level ad data
              googleSpend: newGoogleSpend,
              googleAds: newGoogleSpend,
              googleImpressions: d.impressions,
              googleClicks: d.clicks,
              googleCpc: d.cpc,
              googleCpa: d.cpa,
              googleConversions: d.conversions,
              // Also update shopify object
              shopify: {
                ...existingShopify,
                googleSpend: newGoogleSpend,
                googleAds: newGoogleSpend,
                adSpend: totalAds,
                netProfit: existingShopify.revenue > 0 ? newNetProfit : existingShopify.netProfit,
                netMargin: existingShopify.revenue > 0 ? (newNetProfit / existingShopify.revenue) * 100 : 0,
                roas: totalAds > 0 ? existingShopify.revenue / totalAds : 0,
              },
            };
          } else {
            const newMetaSpend = d.spend;
            const existingGoogle = existingDay.googleSpend || existingShopify.googleSpend || 0;
            const totalAds = newMetaSpend + existingGoogle;
            
            // Recalculate profit with updated ad spend
            const grossProfit = (existingShopify.revenue || 0) - (existingShopify.cogs || 0) - (existingShopify.threeplCosts || 0);
            const newNetProfit = grossProfit - totalAds;
            
            updatedDays[dayKey] = {
              ...existingDay,
              // Top level ad data
              metaSpend: newMetaSpend,
              metaAds: newMetaSpend,
              metaImpressions: d.impressions,
              metaClicks: d.clicks,
              metaCpc: d.cpc,
              metaCpa: d.cpa,
              metaConversions: d.conversions,
              // Also update shopify object
              shopify: {
                ...existingShopify,
                metaSpend: newMetaSpend,
                metaAds: newMetaSpend,
                adSpend: totalAds,
                netProfit: existingShopify.revenue > 0 ? newNetProfit : existingShopify.netProfit,
                netMargin: existingShopify.revenue > 0 ? (newNetProfit / existingShopify.revenue) * 100 : 0,
                roas: totalAds > 0 ? existingShopify.revenue / totalAds : 0,
              },
            };
          }
          dailyCount++;
        });
        
        // Save daily data to localStorage and queue cloud sync
        setAllDaysData(updatedDays);
        lsSet('ecommerce_daily_sales_v1', JSON.stringify(updatedDays));
        queueCloudSave({ ...combinedData, dailySales: updatedDays });
      }
      
      // Then aggregate into weekly data
      parsed.weeklyData.forEach(w => {
        const weekKey = w.weekEnding;
        
        if (updated[weekKey]) {
          // Week exists - update ad spend
          const week = updated[weekKey];
          const oldMetaSpend = week.shopify?.metaSpend || 0;
          const oldGoogleSpend = week.shopify?.googleSpend || 0;
          
          let newMetaSpend = oldMetaSpend;
          let newGoogleSpend = oldGoogleSpend;
          
          if (platform === 'google') {
            newGoogleSpend = w.spend;
          } else {
            newMetaSpend = w.spend;
          }
          
          const totalShopAds = newMetaSpend + newGoogleSpend;
          const oldShopAds = week.shopify?.adSpend || 0;
          const shopProfit = (week.shopify?.netProfit || 0) + oldShopAds - totalShopAds;
          
          updated[weekKey] = {
            ...week,
            shopify: {
              ...week.shopify,
              adSpend: totalShopAds,
              metaSpend: newMetaSpend,
              metaAds: newMetaSpend,
              googleSpend: newGoogleSpend,
              googleAds: newGoogleSpend,
              netProfit: shopProfit,
              netMargin: week.shopify?.revenue > 0 ? (shopProfit / week.shopify.revenue) * 100 : 0,
              roas: totalShopAds > 0 ? week.shopify.revenue / totalShopAds : 0,
            },
            total: {
              ...week.total,
              adSpend: (week.amazon?.adSpend || 0) + totalShopAds,
              netProfit: (week.amazon?.netProfit || 0) + shopProfit,
              netMargin: week.total?.revenue > 0 ? (((week.amazon?.netProfit || 0) + shopProfit) / week.total.revenue) * 100 : 0,
              roas: ((week.amazon?.adSpend || 0) + totalShopAds) > 0 ? week.total.revenue / ((week.amazon?.adSpend || 0) + totalShopAds) : 0,
            },
          };
          updatedCount++;
        } else {
          // Week doesn't exist - create a placeholder with just ad data
          // This allows ad data to be stored even before weekly sales data is uploaded
          const metaSpend = platform === 'meta' ? w.spend : 0;
          const googleSpend = platform === 'google' ? w.spend : 0;
          const totalAds = metaSpend + googleSpend;
          
          updated[weekKey] = {
            amazon: { revenue: 0, units: 0, cogs: 0, fees: 0, adSpend: 0, netProfit: 0, returns: 0, skuData: [] },
            shopify: { 
              revenue: 0, units: 0, cogs: 0, threeplCosts: 0, 
              adSpend: totalAds, metaSpend, metaAds: metaSpend, googleSpend, googleAds: googleSpend,
              netProfit: -totalAds, netMargin: 0, roas: 0, skuData: [] 
            },
            total: { revenue: 0, units: 0, cogs: 0, adSpend: totalAds, netProfit: -totalAds, netMargin: 0, roas: 0 },
            _adDataOnly: true, // Flag to indicate this is placeholder ad data
          };
          createdCount++;
        }
      });
      
      setAllWeeksData(updated);
      save(updated);
      
      // Clear upload state
      setBulkAdFiles([]);
      setBulkAdParsed(null);
      
      const platformName = platform === 'google' ? 'Google' : 'Meta';
      let msg = `${platformName} ads: ${updatedCount} week(s) updated`;
      if (createdCount > 0) msg += `, ${createdCount} placeholder week(s) created`;
      if (dailyCount > 0) msg += `, ${dailyCount} day(s) stored`;
      setToast({ message: msg, type: 'success' });
    } catch (e) {
      setToast({ message: `Error: ${e.message}`, type: 'error' });
    } finally {
      setIsProcessing(false);
    }
  }, [allWeeksData, allDaysData, allPeriodsData, save, combinedData]);

  const getMonths = () => { const m = new Set(); Object.keys(allWeeksData).forEach(w => { const d = new Date(w+'T00:00:00'); m.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`); }); return Array.from(m).sort().reverse(); };
  const getYears = () => { const y = new Set(); Object.keys(allWeeksData).forEach(w => { y.add(new Date(w+'T00:00:00').getFullYear()); }); return Array.from(y).sort().reverse(); };

  const getMonthlyData = (ym) => {
    const [y, m] = ym.split('-').map(Number);
    const weeks = Object.entries(allWeeksData).filter(([w]) => { const d = new Date(w+'T00:00:00'); return d.getFullYear() === y && d.getMonth()+1 === m; });
    if (!weeks.length) return null;
    const agg = { weeks: weeks.map(([w]) => w), 
      amazon: { revenue: 0, units: 0, returns: 0, cogs: 0, fees: 0, adSpend: 0, netProfit: 0 }, 
      shopify: { revenue: 0, units: 0, cogs: 0, threeplCosts: 0, adSpend: 0, metaSpend: 0, googleSpend: 0, discounts: 0, netProfit: 0, threeplBreakdown: { storage: 0, shipping: 0, pickFees: 0, boxCharges: 0, receiving: 0, other: 0 }, threeplMetrics: { orderCount: 0, totalUnits: 0 } }, 
      total: { revenue: 0, units: 0, cogs: 0, adSpend: 0, netProfit: 0 }};
    weeks.forEach(([w, d]) => {
      // Get ledger 3PL for this week
      const ledger3PL = get3PLForWeek(threeplLedger, w);
      const weekThreeplCost = ledger3PL?.metrics?.totalCost || d.shopify?.threeplCosts || 0;
      const weekThreeplBreakdown = ledger3PL?.breakdown || d.shopify?.threeplBreakdown || {};
      const weekThreeplMetrics = ledger3PL?.metrics || d.shopify?.threeplMetrics || {};
      
      agg.amazon.revenue += d.amazon?.revenue || 0; agg.amazon.units += d.amazon?.units || 0; agg.amazon.returns += d.amazon?.returns || 0;
      agg.amazon.cogs += d.amazon?.cogs || 0; agg.amazon.fees += d.amazon?.fees || 0; agg.amazon.adSpend += d.amazon?.adSpend || 0; agg.amazon.netProfit += d.amazon?.netProfit || 0;
      agg.shopify.revenue += d.shopify?.revenue || 0; agg.shopify.units += d.shopify?.units || 0; agg.shopify.cogs += d.shopify?.cogs || 0;
      agg.shopify.threeplCosts += weekThreeplCost; agg.shopify.adSpend += d.shopify?.adSpend || 0; 
      agg.shopify.metaSpend += d.shopify?.metaSpend || 0; agg.shopify.googleSpend += d.shopify?.googleSpend || 0;
      agg.shopify.discounts += d.shopify?.discounts || 0;
      // Recalculate shopify profit with ledger 3PL
      const shopProfit = (d.shopify?.revenue || 0) - (d.shopify?.cogs || 0) - weekThreeplCost - (d.shopify?.adSpend || 0);
      agg.shopify.netProfit += shopProfit;
      // Aggregate 3PL breakdown
      agg.shopify.threeplBreakdown.storage += weekThreeplBreakdown.storage || 0;
      agg.shopify.threeplBreakdown.shipping += weekThreeplBreakdown.shipping || 0;
      agg.shopify.threeplBreakdown.pickFees += weekThreeplBreakdown.pickFees || 0;
      agg.shopify.threeplBreakdown.boxCharges += weekThreeplBreakdown.boxCharges || 0;
      agg.shopify.threeplBreakdown.receiving += weekThreeplBreakdown.receiving || 0;
      agg.shopify.threeplBreakdown.other += weekThreeplBreakdown.other || 0;
      agg.shopify.threeplMetrics.orderCount += weekThreeplMetrics.orderCount || 0;
      agg.shopify.threeplMetrics.totalUnits += weekThreeplMetrics.totalUnits || 0;
      agg.total.revenue += d.total?.revenue || 0; agg.total.units += d.total?.units || 0; agg.total.cogs += d.total?.cogs || 0; agg.total.adSpend += d.total?.adSpend || 0; 
      agg.total.netProfit += (d.amazon?.netProfit || 0) + shopProfit;
    });
    // Calculate metrics
    agg.shopify.threeplMetrics.avgCostPerOrder = agg.shopify.threeplMetrics.orderCount > 0 ? (agg.shopify.threeplCosts - agg.shopify.threeplBreakdown.storage) / agg.shopify.threeplMetrics.orderCount : 0;
    agg.shopify.threeplMetrics.avgUnitsPerOrder = agg.shopify.threeplMetrics.orderCount > 0 ? agg.shopify.threeplMetrics.totalUnits / agg.shopify.threeplMetrics.orderCount : 0;
    agg.amazon.margin = agg.amazon.revenue > 0 ? (agg.amazon.netProfit/agg.amazon.revenue)*100 : 0;
    agg.amazon.aov = agg.amazon.units > 0 ? agg.amazon.revenue/agg.amazon.units : 0;
    agg.amazon.roas = agg.amazon.adSpend > 0 ? agg.amazon.revenue/agg.amazon.adSpend : 0;
    agg.amazon.returnRate = agg.amazon.units > 0 ? (agg.amazon.returns/agg.amazon.units)*100 : 0;
    agg.shopify.netMargin = agg.shopify.revenue > 0 ? (agg.shopify.netProfit/agg.shopify.revenue)*100 : 0;
    agg.shopify.aov = agg.shopify.units > 0 ? agg.shopify.revenue/agg.shopify.units : 0;
    agg.shopify.roas = agg.shopify.adSpend > 0 ? agg.shopify.revenue/agg.shopify.adSpend : 0;
    agg.total.netMargin = agg.total.revenue > 0 ? (agg.total.netProfit/agg.total.revenue)*100 : 0;
    agg.total.amazonShare = agg.total.revenue > 0 ? (agg.amazon.revenue/agg.total.revenue)*100 : 0;
    agg.total.shopifyShare = agg.total.revenue > 0 ? (agg.shopify.revenue/agg.total.revenue)*100 : 0;
    return agg;
  };

  const getYearlyData = (year) => {
    const weeks = Object.entries(allWeeksData).filter(([w]) => new Date(w+'T00:00:00').getFullYear() === year);
    if (!weeks.length) return null;
    const agg = { weeks: weeks.map(([w]) => w), 
      amazon: { revenue: 0, units: 0, returns: 0, cogs: 0, fees: 0, adSpend: 0, netProfit: 0 }, 
      shopify: { revenue: 0, units: 0, cogs: 0, threeplCosts: 0, adSpend: 0, metaSpend: 0, googleSpend: 0, discounts: 0, netProfit: 0, threeplBreakdown: { storage: 0, shipping: 0, pickFees: 0, boxCharges: 0, receiving: 0, other: 0 }, threeplMetrics: { orderCount: 0, totalUnits: 0 } }, 
      total: { revenue: 0, units: 0, cogs: 0, adSpend: 0, netProfit: 0 }, monthlyBreakdown: {}};
    weeks.forEach(([w, d]) => {
      const dt = new Date(w+'T00:00:00'); const mk = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
      if (!agg.monthlyBreakdown[mk]) agg.monthlyBreakdown[mk] = { revenue: 0, netProfit: 0 };
      
      // Get ledger 3PL for this week
      const ledger3PL = get3PLForWeek(threeplLedger, w);
      const weekThreeplCost = ledger3PL?.metrics?.totalCost || d.shopify?.threeplCosts || 0;
      const weekThreeplBreakdown = ledger3PL?.breakdown || d.shopify?.threeplBreakdown || {};
      const weekThreeplMetrics = ledger3PL?.metrics || d.shopify?.threeplMetrics || {};
      
      agg.amazon.revenue += d.amazon?.revenue || 0; agg.amazon.units += d.amazon?.units || 0; agg.amazon.returns += d.amazon?.returns || 0;
      agg.amazon.cogs += d.amazon?.cogs || 0; agg.amazon.fees += d.amazon?.fees || 0; agg.amazon.adSpend += d.amazon?.adSpend || 0; agg.amazon.netProfit += d.amazon?.netProfit || 0;
      agg.shopify.revenue += d.shopify?.revenue || 0; agg.shopify.units += d.shopify?.units || 0; agg.shopify.cogs += d.shopify?.cogs || 0;
      agg.shopify.threeplCosts += weekThreeplCost; agg.shopify.adSpend += d.shopify?.adSpend || 0;
      agg.shopify.metaSpend += d.shopify?.metaSpend || 0; agg.shopify.googleSpend += d.shopify?.googleSpend || 0;
      agg.shopify.discounts += d.shopify?.discounts || 0;
      // Recalculate shopify profit with ledger 3PL
      const shopProfit = (d.shopify?.revenue || 0) - (d.shopify?.cogs || 0) - weekThreeplCost - (d.shopify?.adSpend || 0);
      agg.shopify.netProfit += shopProfit;
      // Aggregate 3PL breakdown
      agg.shopify.threeplBreakdown.storage += weekThreeplBreakdown.storage || 0;
      agg.shopify.threeplBreakdown.shipping += weekThreeplBreakdown.shipping || 0;
      agg.shopify.threeplBreakdown.pickFees += weekThreeplBreakdown.pickFees || 0;
      agg.shopify.threeplBreakdown.boxCharges += weekThreeplBreakdown.boxCharges || 0;
      agg.shopify.threeplBreakdown.receiving += weekThreeplBreakdown.receiving || 0;
      agg.shopify.threeplBreakdown.other += weekThreeplBreakdown.other || 0;
      agg.shopify.threeplMetrics.orderCount += weekThreeplMetrics.orderCount || 0;
      agg.shopify.threeplMetrics.totalUnits += weekThreeplMetrics.totalUnits || 0;
      agg.total.revenue += d.total?.revenue || 0; agg.total.units += d.total?.units || 0; agg.total.cogs += d.total?.cogs || 0; agg.total.adSpend += d.total?.adSpend || 0;
      agg.total.netProfit += (d.amazon?.netProfit || 0) + shopProfit;
      agg.monthlyBreakdown[mk].revenue += d.total?.revenue || 0; agg.monthlyBreakdown[mk].netProfit += (d.amazon?.netProfit || 0) + shopProfit;
    });
    // Calculate metrics
    agg.shopify.threeplMetrics.avgCostPerOrder = agg.shopify.threeplMetrics.orderCount > 0 ? (agg.shopify.threeplCosts - agg.shopify.threeplBreakdown.storage) / agg.shopify.threeplMetrics.orderCount : 0;
    agg.shopify.threeplMetrics.avgUnitsPerOrder = agg.shopify.threeplMetrics.orderCount > 0 ? agg.shopify.threeplMetrics.totalUnits / agg.shopify.threeplMetrics.orderCount : 0;
    agg.amazon.margin = agg.amazon.revenue > 0 ? (agg.amazon.netProfit/agg.amazon.revenue)*100 : 0;
    agg.amazon.aov = agg.amazon.units > 0 ? agg.amazon.revenue/agg.amazon.units : 0;
    agg.amazon.roas = agg.amazon.adSpend > 0 ? agg.amazon.revenue/agg.amazon.adSpend : 0;
    agg.amazon.returnRate = agg.amazon.units > 0 ? (agg.amazon.returns/agg.amazon.units)*100 : 0;
    agg.shopify.netMargin = agg.shopify.revenue > 0 ? (agg.shopify.netProfit/agg.shopify.revenue)*100 : 0;
    agg.shopify.aov = agg.shopify.units > 0 ? agg.shopify.revenue/agg.shopify.units : 0;
    agg.shopify.roas = agg.shopify.adSpend > 0 ? agg.shopify.revenue/agg.shopify.adSpend : 0;
    agg.total.netMargin = agg.total.revenue > 0 ? (agg.total.netProfit/agg.total.revenue)*100 : 0;
    agg.total.amazonShare = agg.total.revenue > 0 ? (agg.amazon.revenue/agg.total.revenue)*100 : 0;
    agg.total.shopifyShare = agg.total.revenue > 0 ? (agg.shopify.revenue/agg.total.revenue)*100 : 0;
    return agg;
  };

  // COMPLETE BACKUP - includes ALL dashboard data
  const exportAll = () => { 
    const fullBackup = {
      version: '3.0',
      exportedAt: new Date().toISOString(),
      storeName,
      storeLogo,
      // Core sales data
      sales: allWeeksData,
      dailySales: allDaysData, // Daily data export
      periods: allPeriodsData,
      inventory: invHistory, 
      cogs: savedCogs,
      // Settings & config
      goals,
      settings: appSettings,
      salesTax: salesTaxConfig, // Renamed for consistency
      salesTaxConfig, // Keep old name for backward compatibility
      productNames: savedProductNames,
      theme,
      widgetConfig,
      // New features
      invoices,
      amazonForecasts,
      forecastMeta,
      weekNotes,
      productionPipeline,
      threeplLedger,
      amazonCampaigns,
      // Self-learning forecast data
      forecastAccuracyHistory,
      forecastCorrections,
      aiForecasts,
      leadTimeSettings,
      aiForecastModule,
      aiLearningHistory,
      // UNIFIED AI MODEL - single source of truth for all learning
      unifiedAIModel,
      // AI & Reports
      weeklyReports,
      aiMessages,
      // Banking data
      bankingData,
    };
    const blob = new Blob([JSON.stringify(fullBackup, null, 2)], { type: 'application/json' }); 
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = `${storeName || 'dashboard'}_FULL_backup_${new Date().toISOString().split('T')[0]}.json`; 
    a.click();
    // Track last backup date
    const now = new Date().toISOString();
    localStorage.setItem('ecommerce_last_backup', now);
    setLastBackupDate(now);
    setToast({ message: 'Complete backup downloaded (v3.0)', type: 'success' });
  };
  
  // COMPLETE RESTORE - restores ALL dashboard data
  const importData = (file) => { 
    const reader = new FileReader(); 
    reader.onload = async (e) => { 
      try { 
        const d = JSON.parse(e.target.result); 
        let restored = [];
        
        // Build merged data for cloud sync
        let mergedData = { ...combinedData };
        
        // Core data - deep merge to preserve ad data in weekly data
        if (d.sales && Object.keys(d.sales).length > 0) { 
          const mergedSales = { ...allWeeksData };
          Object.entries(d.sales).forEach(([weekKey, weekData]) => {
            const existing = mergedSales[weekKey] || {};
            const existingShopify = existing.shopify || {};
            const newShopify = weekData.shopify || {};
            
            // Preserve ad data from both sources (existing takes precedence)
            const metaSpend = existingShopify.metaSpend || existingShopify.metaAds || newShopify.metaSpend || newShopify.metaAds || 0;
            const googleSpend = existingShopify.googleSpend || existingShopify.googleAds || newShopify.googleSpend || newShopify.googleAds || 0;
            const totalAds = metaSpend + googleSpend;
            
            mergedSales[weekKey] = {
              ...existing,
              ...weekData,
              shopify: {
                ...newShopify,
                metaSpend: metaSpend,
                metaAds: metaSpend,
                googleSpend: googleSpend,
                googleAds: googleSpend,
                adSpend: totalAds || newShopify.adSpend || 0,
              },
            };
          });
          setAllWeeksData(mergedSales); 
          await save(mergedSales); 
          mergedData.sales = mergedSales;
          restored.push(`${Object.keys(d.sales).length} weeks`);
        }
        // Daily data - deep merge to preserve ad data
        if (d.dailySales && Object.keys(d.dailySales).length > 0) {
          const mergedDays = { ...allDaysData };
          Object.entries(d.dailySales).forEach(([dateKey, dayData]) => {
            const existing = mergedDays[dateKey] || {};
            // Preserve ad data from both sources
            const metaSpend = existing.metaSpend || existing.shopify?.metaSpend || dayData.metaSpend || dayData.shopify?.metaSpend || 0;
            const googleSpend = existing.googleSpend || existing.shopify?.googleSpend || dayData.googleSpend || dayData.shopify?.googleSpend || 0;
            
            mergedDays[dateKey] = {
              ...existing,
              ...dayData,
              // Ensure ad data is preserved
              metaSpend: metaSpend,
              metaAds: metaSpend,
              metaImpressions: existing.metaImpressions || dayData.metaImpressions,
              metaClicks: existing.metaClicks || dayData.metaClicks,
              metaCpc: existing.metaCpc || dayData.metaCpc,
              metaCpa: existing.metaCpa || dayData.metaCpa,
              metaConversions: existing.metaConversions || dayData.metaConversions,
              googleSpend: googleSpend,
              googleAds: googleSpend,
              googleImpressions: existing.googleImpressions || dayData.googleImpressions,
              googleClicks: existing.googleClicks || dayData.googleClicks,
              googleCpc: existing.googleCpc || dayData.googleCpc,
              googleCpa: existing.googleCpa || dayData.googleCpa,
              googleConversions: existing.googleConversions || dayData.googleConversions,
              // Merge shopify with ad data
              shopify: dayData.shopify ? {
                ...dayData.shopify,
                metaSpend: metaSpend,
                metaAds: metaSpend,
                googleSpend: googleSpend,
                googleAds: googleSpend,
                adSpend: metaSpend + googleSpend,
              } : existing.shopify,
            };
          });
          setAllDaysData(mergedDays);
          lsSet('ecommerce_daily_sales_v1', JSON.stringify(mergedDays));
          mergedData.dailySales = mergedDays;
          restored.push(`${Object.keys(d.dailySales).length} days`);
        }
        if (d.inventory && Object.keys(d.inventory).length > 0) { 
          const mergedInv = {...invHistory, ...d.inventory};
          setInvHistory(mergedInv); 
          await saveInv(mergedInv); 
          mergedData.inventory = mergedInv;
          restored.push('inventory');
        } 
        if (d.cogs && Object.keys(d.cogs).length > 0) { 
          setSavedCogs(d.cogs); 
          await saveCogs(d.cogs); 
          mergedData.cogs = { lookup: d.cogs, updatedAt: new Date().toISOString() };
          restored.push('COGS');
        } 
        if (d.periods && Object.keys(d.periods).length > 0) { 
          const mergedPeriods = {...allPeriodsData, ...d.periods};
          setAllPeriodsData(mergedPeriods); 
          await savePeriods(mergedPeriods); 
          mergedData.periods = mergedPeriods;
          restored.push(`${Object.keys(d.periods).length} periods`);
        } 
        if (d.goals) { 
          setGoals(d.goals); 
          lsSet(GOALS_KEY, JSON.stringify(d.goals)); 
          mergedData.goals = d.goals;
          restored.push('goals');
        } 
        if (d.storeName) { 
          setStoreName(d.storeName); 
          lsSet(STORE_KEY, d.storeName); 
          mergedData.storeName = d.storeName;
        }
        
        // Settings & config
        if (d.settings) {
          setAppSettings(d.settings);
          lsSet(SETTINGS_KEY, JSON.stringify(d.settings));
          mergedData.settings = d.settings;
          restored.push('settings');
        }
        if (d.salesTax || d.salesTaxConfig) {
          const taxConfig = d.salesTax || d.salesTaxConfig;
          setSalesTaxConfig(taxConfig);
          lsSet(SALES_TAX_KEY, JSON.stringify(taxConfig));
          mergedData.salesTax = taxConfig;
          restored.push('sales tax');
        }
        if (d.productNames) {
          setSavedProductNames(d.productNames);
          lsSet(PRODUCT_NAMES_KEY, JSON.stringify(d.productNames));
          mergedData.productNames = d.productNames;
          restored.push('product names');
        }
        if (d.theme) {
          setTheme(d.theme);
          lsSet(THEME_KEY, JSON.stringify(d.theme));
          mergedData.theme = d.theme;
        }
        
        // New features
        if (d.invoices && d.invoices.length > 0) {
          setInvoices(d.invoices);
          mergedData.invoices = d.invoices;
          restored.push(`${d.invoices.length} invoices`);
        }
        if (d.amazonForecasts && Object.keys(d.amazonForecasts).length > 0) {
          setAmazonForecasts(d.amazonForecasts);
          mergedData.amazonForecasts = d.amazonForecasts;
          restored.push(`${Object.keys(d.amazonForecasts).length} forecasts`);
        }
        if (d.forecastMeta) {
          setForecastMeta(d.forecastMeta);
          localStorage.setItem('ecommerce_forecast_meta', JSON.stringify(d.forecastMeta));
          mergedData.forecastMeta = d.forecastMeta;
          restored.push('forecast tracking');
        }
        if (d.weekNotes && Object.keys(d.weekNotes).length > 0) {
          const mergedNotes = {...weekNotes, ...d.weekNotes};
          setWeekNotes(mergedNotes);
          mergedData.weekNotes = mergedNotes;
          restored.push('notes');
        }
        if (d.productionPipeline && d.productionPipeline.length > 0) {
          setProductionPipeline(d.productionPipeline);
          mergedData.productionPipeline = d.productionPipeline;
          restored.push(`${d.productionPipeline.length} production orders`);
        }
        if (d.storeLogo) {
          setStoreLogo(d.storeLogo);
          mergedData.storeLogo = d.storeLogo;
        }
        if (d.threeplLedger && (Object.keys(d.threeplLedger.orders || {}).length > 0 || Object.keys(d.threeplLedger.summaryCharges || {}).length > 0)) {
          setThreeplLedger(d.threeplLedger);
          lsSet(THREEPL_LEDGER_KEY, JSON.stringify(d.threeplLedger));
          mergedData.threeplLedger = d.threeplLedger;
          restored.push(`${Object.keys(d.threeplLedger.orders || {}).length} 3PL orders`);
        }
        if (d.widgetConfig) {
          setWidgetConfig(d.widgetConfig);
          lsSet(WIDGET_KEY, JSON.stringify(d.widgetConfig));
          mergedData.widgetConfig = d.widgetConfig;
          restored.push('widget config');
        }
        
        // Restore self-learning forecast data
        if (d.forecastAccuracyHistory && d.forecastAccuracyHistory.records && d.forecastAccuracyHistory.records.length > 0) {
          setForecastAccuracyHistory(d.forecastAccuracyHistory);
          localStorage.setItem(FORECAST_ACCURACY_KEY, JSON.stringify(d.forecastAccuracyHistory));
          mergedData.forecastAccuracyHistory = d.forecastAccuracyHistory;
          restored.push(`${d.forecastAccuracyHistory.records.length} learning samples`);
        }
        if (d.forecastCorrections && d.forecastCorrections.samplesUsed > 0) {
          setForecastCorrections(d.forecastCorrections);
          localStorage.setItem(FORECAST_CORRECTIONS_KEY, JSON.stringify(d.forecastCorrections));
          mergedData.forecastCorrections = d.forecastCorrections;
          restored.push('forecast corrections');
        }
        
        // Restore additional data types
        if (d.amazonCampaigns && (d.amazonCampaigns.campaigns?.length > 0 || d.amazonCampaigns.history?.length > 0)) {
          setAmazonCampaigns(d.amazonCampaigns);
          lsSet('ecommerce_amazon_campaigns_v1', JSON.stringify(d.amazonCampaigns));
          mergedData.amazonCampaigns = d.amazonCampaigns;
          restored.push(`${d.amazonCampaigns.campaigns?.length || 0} ad campaigns`);
        }
        if (d.bankingData && d.bankingData.transactions?.length > 0) {
          setBankingData(d.bankingData);
          lsSet('ecommerce_banking_v1', JSON.stringify(d.bankingData));
          mergedData.bankingData = d.bankingData;
          restored.push(`${d.bankingData.transactions.length} banking transactions`);
        }
        if (d.aiMessages && d.aiMessages.length > 0) {
          setAiMessages(d.aiMessages);
          lsSet('ecommerce_ai_chat_history_v1', JSON.stringify(d.aiMessages));
          mergedData.aiMessages = d.aiMessages;
          restored.push('AI chat history');
        }
        if (d.aiLearningHistory && (d.aiLearningHistory.predictions?.length > 0 || d.aiLearningHistory.modelUpdates?.length > 0)) {
          setAiLearningHistory(d.aiLearningHistory);
          lsSet('ecommerce_ai_learning_v1', JSON.stringify(d.aiLearningHistory));
          mergedData.aiLearningHistory = d.aiLearningHistory;
          restored.push('AI learning history');
        }
        // UNIFIED AI MODEL - restore comprehensive learning state
        if (d.unifiedAIModel && d.unifiedAIModel.lastUpdated) {
          setUnifiedAIModel(d.unifiedAIModel);
          lsSet('ecommerce_unified_ai_v1', JSON.stringify(d.unifiedAIModel));
          mergedData.unifiedAIModel = d.unifiedAIModel;
          restored.push('Unified AI model');
        }
        if (d.weeklyReports && Object.keys(d.weeklyReports).length > 0) {
          setWeeklyReports(d.weeklyReports);
          lsSet(WEEKLY_REPORTS_KEY, JSON.stringify(d.weeklyReports));
          mergedData.weeklyReports = d.weeklyReports;
          restored.push(`${Object.keys(d.weeklyReports).length} reports`);
        }
        
        // CRITICAL: Push all merged data to cloud to ensure sync
        if (session?.user?.id && supabase) {
          queueCloudSave(mergedData);
        }
        
        setToast({ message: `Restored: ${restored.join(', ')}. Syncing to cloud...`, type: 'success' });
      } catch (err) { 
        console.error('Import error:', err);
        setToast({ message: 'Invalid backup file: ' + err.message, type: 'error' });
      }
    }; 
    reader.readAsText(file); 
  };

  // 5. FORECASTING - Simple linear regression based forecast
  const generateForecast = useMemo(() => {
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const sortedPeriods = Object.keys(allPeriodsData).sort();
    
    // Get Amazon forecast data - check all formats and find upcoming ones
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const upcomingForecasts = Object.entries(amazonForecasts)
      .filter(([weekKey, data]) => {
        // Try to parse the date - support multiple formats
        const d = new Date(weekKey + 'T00:00:00');
        const isValidDate = !isNaN(d);
        const isFuture = d >= today;
        const hasData = data && ((data.totalSales || 0) > 0 || (data.totals?.sales || 0) > 0);
        return isValidDate && isFuture && hasData;
      })
      .sort((a, b) => a[0].localeCompare(b[0]));
    
    // Debug: count how many forecasts we have
    const forecastCount = upcomingForecasts.length;
    
    // Calculate trend from recent weeks
    const calcWeeklyTrend = (weeks) => {
      if (weeks.length < 2) return { slope: 0, avgRev: 0, avgProfit: 0, avgUnits: 0 };
      const revenues = weeks.map(w => allWeeksData[w]?.total?.revenue || 0);
      const profits = weeks.map(w => allWeeksData[w]?.total?.netProfit || 0);
      const units = weeks.map(w => allWeeksData[w]?.total?.units || 0);
      
      const n = revenues.length;
      const avgRev = revenues.reduce((s, v) => s + v, 0) / n;
      const avgProfit = profits.reduce((s, v) => s + v, 0) / n;
      const avgUnits = units.reduce((s, v) => s + v, 0) / n;
      
      // Calculate slope (trend direction)
      const sumX = revenues.reduce((s, _, i) => s + i, 0);
      const sumY = revenues.reduce((s, v) => s + v, 0);
      const sumXY = revenues.reduce((s, v, i) => s + i * v, 0);
      const sumX2 = revenues.reduce((s, _, i) => s + i * i, 0);
      const denom = n * sumX2 - sumX * sumX;
      const slope = denom !== 0 ? (n * sumXY - sumX * sumY) / denom : 0;
      const slopePercent = avgRev > 0 ? (slope / avgRev * 100) : 0;
      
      return { slope, slopePercent, avgRev, avgProfit, avgUnits };
    };
    
    // Priority 1: If we have 4+ weeks of weekly data, use linear regression with variance
    // Filter out weeks with no revenue (incomplete data)
    const weeksWithRevenue = sortedWeeks.filter(w => (allWeeksData[w]?.total?.revenue || 0) > 0);
    if (weeksWithRevenue.length >= 4) {
      const recentWeeks = weeksWithRevenue.slice(-8);
      const trend = calcWeeklyTrend(recentWeeks);
      
      const revenues = recentWeeks.map(w => allWeeksData[w]?.total?.revenue || 0);
      const profits = recentWeeks.map(w => allWeeksData[w]?.total?.netProfit || 0);
      const units = recentWeeks.map(w => allWeeksData[w]?.total?.units || 0);
      
      // Calculate standard deviation for realistic variance
      const variance = revenues.reduce((s, v) => s + Math.pow(v - trend.avgRev, 2), 0) / revenues.length;
      const stdDev = Math.sqrt(variance);
      
      const n = revenues.length;
      const forecast = [];
      
      for (let i = 0; i < 4; i++) {
        // Calculate trend-based projection
        const trendRevenue = Math.max(0, trend.avgRev + trend.slope * (i + 1));
        const trendProfit = trend.avgProfit + (trend.avgProfit > 0 ? trend.slope * 0.35 * (i + 1) : trend.slope * 0.5 * (i + 1));
        const trendUnits = Math.max(0, Math.round(trend.avgUnits * (1 + trend.slopePercent / 100 * (i + 1))));
        
        // Check for Amazon forecast for this week (by index)
        const amazonForecast = upcomingForecasts[i]?.[1];
        
        if (amazonForecast) {
          const amzSales = amazonForecast.totalSales || amazonForecast.totals?.sales || 0;
          const amzProceeds = amazonForecast.totalProceeds || amazonForecast.totals?.proceeds || 0;
          const amzUnits = amazonForecast.totalUnits || amazonForecast.totals?.units || 0;
          
          // Use Amazon forecast primarily (70%) blended with trend (30%)
          forecast.push({
            week: `Week +${i + 1}`,
            weekDate: upcomingForecasts[i]?.[0],
            revenue: Math.round(amzSales * 0.7 + trendRevenue * 0.3),
            profit: Math.round(amzProceeds * 0.7 + trendProfit * 0.3),
            units: Math.round(amzUnits * 0.7 + trendUnits * 0.3),
            hasAmazonForecast: true,
            amazonRaw: { sales: amzSales, proceeds: amzProceeds, units: amzUnits },
          });
        } else {
          // Use pure trend with slight weekly variance
          const weekVariance = 1 + (Math.random() - 0.5) * 0.08 * (i + 1); // Â±4-16% variance
          forecast.push({
            week: `Week +${i + 1}`,
            revenue: Math.round(trendRevenue * weekVariance),
            profit: Math.round(trendProfit * weekVariance),
            units: Math.round(trendUnits * weekVariance),
            hasAmazonForecast: false,
          });
        }
      }
      
      const monthlyRevenue = forecast.reduce((s, f) => s + f.revenue, 0);
      const monthlyProfit = forecast.reduce((s, f) => s + f.profit, 0);
      const monthlyUnits = forecast.reduce((s, f) => s + f.units, 0);
      
      const confidence = trend.avgRev > 0 ? Math.max(30, Math.min(95, 85 - (stdDev / trend.avgRev * 50))) : 50;
      
      return {
        weekly: forecast,
        monthly: { revenue: monthlyRevenue, profit: monthlyProfit, units: monthlyUnits },
        trend: { 
          revenue: trend.slope > trend.avgRev * 0.01 ? 'up' : trend.slope < -trend.avgRev * 0.01 ? 'down' : 'flat',
          revenueChange: trend.slopePercent,
        },
        confidence: confidence.toFixed(0),
        basedOn: recentWeeks.length,
        source: forecastCount > 0 ? 'weekly-amazon' : 'weekly',
        amazonBlended: forecastCount > 0,
        amazonForecastCount: forecastCount,
      };
    }
    
    // Priority 2: If we have 1-3 weeks of weekly data, use averages with decay
    if (weeksWithRevenue.length >= 1) {
      const trend = calcWeeklyTrend(weeksWithRevenue);
      
      // Get seasonality adjustment from period data
      let seasonalityFactor = 1.0;
      const currentMonth = new Date().toLocaleString('en-US', { month: 'long' });
      const lastYearSameMonth = `${currentMonth} ${new Date().getFullYear() - 1}`;
      const thisYearData = allPeriodsData[`${currentMonth} ${new Date().getFullYear()}`];
      const lastYearData = allPeriodsData[lastYearSameMonth];
      
      if (lastYearData && lastYearData.total?.revenue > 0 && thisYearData && thisYearData.total?.revenue > 0) {
        const yoyGrowth = (thisYearData.total.revenue - lastYearData.total.revenue) / lastYearData.total.revenue;
        seasonalityFactor = 1 + (yoyGrowth * 0.25);
      }
      
      const forecast = [];
      for (let i = 0; i < 4; i++) {
        const amazonForecast = upcomingForecasts[i]?.[1];
        // Apply slight variance so weeks aren't identical
        const weekVariance = 1 + (i * 0.02) - 0.03; // Slight growth trend assumption
        
        if (amazonForecast && (amazonForecast.totalSales > 0 || amazonForecast.totals?.sales > 0)) {
          const amzSales = amazonForecast.totalSales || amazonForecast.totals?.sales || 0;
          const amzProceeds = amazonForecast.totalProceeds || amazonForecast.totals?.proceeds || 0;
          const amzUnits = amazonForecast.totalUnits || amazonForecast.totals?.units || 0;
          
          forecast.push({
            week: `Week +${i + 1}`,
            revenue: Math.round(amzSales * 0.7 + trend.avgRev * seasonalityFactor * 0.3),
            profit: Math.round(amzProceeds * 0.7 + trend.avgProfit * seasonalityFactor * 0.3),
            units: Math.round(amzUnits * 0.7 + trend.avgUnits * seasonalityFactor * 0.3),
            hasAmazonForecast: true,
          });
        } else {
          forecast.push({
            week: `Week +${i + 1}`,
            revenue: Math.round(trend.avgRev * seasonalityFactor * weekVariance),
            profit: Math.round(trend.avgProfit * seasonalityFactor * weekVariance),
            units: Math.round(trend.avgUnits * seasonalityFactor * weekVariance),
          });
        }
      }
      
      const hasAmazon = upcomingForecasts.length > 0;
      const hasPeriods = sortedPeriods.length > 0;
      
      return {
        weekly: forecast,
        monthly: { revenue: forecast.reduce((s, f) => s + f.revenue, 0), profit: forecast.reduce((s, f) => s + f.profit, 0), units: forecast.reduce((s, f) => s + f.units, 0) },
        trend: { revenue: trend.slopePercent > 2 ? 'up' : trend.slopePercent < -2 ? 'down' : 'flat', revenueChange: trend.slopePercent },
        confidence: Math.min(80, 40 + sortedWeeks.length * 12 + (hasAmazon ? 15 : 0) + (hasPeriods ? 8 : 0)).toFixed(0),
        basedOn: sortedWeeks.length,
        source: hasAmazon ? 'weekly-amazon' : 'weekly-avg',
        note: sortedWeeks.length < 4 ? `Based on ${sortedWeeks.length} week${sortedWeeks.length > 1 ? 's' : ''} of data${hasAmazon ? ' + Amazon forecast' : ''}. Need 4+ weeks for trend analysis.` : null,
        amazonBlended: hasAmazon,
        seasonalityApplied: seasonalityFactor !== 1.0 ? seasonalityFactor : null,
      };
    }
    
    // Priority 3: Only period data - use averages
    if (sortedPeriods.length >= 1) {
      let totalRevenue = 0, totalProfit = 0, totalUnits = 0, totalMonths = 0;
      
      sortedPeriods.forEach(p => {
        const period = allPeriodsData[p];
        const rev = (period.amazon?.revenue || 0) + (period.shopify?.revenue || 0);
        const profit = (period.amazon?.netProfit || 0) + (period.shopify?.netProfit || 0);
        const units = (period.amazon?.units || 0) + (period.shopify?.units || 0);
        const startDate = new Date(period.startDate || p);
        const endDate = new Date(period.endDate || p);
        const months = Math.max(1, Math.round((endDate - startDate) / (1000 * 60 * 60 * 24 * 30)));
        totalRevenue += rev;
        totalProfit += profit;
        totalUnits += units;
        totalMonths += months;
      });
      
      const avgMonthlyRevenue = totalMonths > 0 ? totalRevenue / totalMonths : totalRevenue;
      const avgMonthlyProfit = totalMonths > 0 ? totalProfit / totalMonths : totalProfit;
      const avgMonthlyUnits = totalMonths > 0 ? totalUnits / totalMonths : totalUnits;
      
      const weeklyRevenue = avgMonthlyRevenue / 4;
      const weeklyProfit = avgMonthlyProfit / 4;
      const weeklyUnits = Math.round(avgMonthlyUnits / 4);
      
      const forecast = [];
      for (let i = 0; i < 4; i++) {
        const amazonForecast = upcomingForecasts[i]?.[1];
        const weekVariance = 1 + (i * 0.015); // Slight growth assumption
        
        if (amazonForecast && (amazonForecast.totalSales > 0 || amazonForecast.totals?.sales > 0)) {
          const amzSales = amazonForecast.totalSales || amazonForecast.totals?.sales || 0;
          const amzProceeds = amazonForecast.totalProceeds || amazonForecast.totals?.proceeds || 0;
          const amzUnits = amazonForecast.totalUnits || amazonForecast.totals?.units || 0;
          
          forecast.push({
            week: `Week +${i + 1}`,
            revenue: Math.round(amzSales * 0.7 + weeklyRevenue * 0.3),
            profit: Math.round(amzProceeds * 0.7 + weeklyProfit * 0.3),
            units: Math.round(amzUnits * 0.7 + weeklyUnits * 0.3),
            hasAmazonForecast: true,
          });
        } else {
          forecast.push({ 
            week: `Week +${i + 1}`, 
            revenue: Math.round(weeklyRevenue * weekVariance), 
            profit: Math.round(weeklyProfit * weekVariance), 
            units: Math.round(weeklyUnits * weekVariance),
          });
        }
      }
      
      return {
        weekly: forecast,
        monthly: { revenue: forecast.reduce((s, f) => s + f.revenue, 0), profit: forecast.reduce((s, f) => s + f.profit, 0), units: forecast.reduce((s, f) => s + f.units, 0) },
        trend: { revenue: 'flat', revenueChange: 0 },
        confidence: '45',
        basedOn: sortedPeriods.length,
        source: 'period',
        note: 'Based on period averages. Upload weekly data for accurate trend analysis.',
        amazonBlended: upcomingForecasts.length > 0,
      };
    }
    
    return null;
  }, [allWeeksData, allPeriodsData, amazonForecasts]);

  // ============ ENHANCED FORECAST WITH LEARNED CORRECTIONS ============
  // Apply learned correction factors to improve forecast accuracy
  const enhancedForecast = useMemo(() => {
    if (!generateForecast) return null;
    
    // Only apply corrections if confidence is at least 30%
    const shouldApplyCorrections = forecastCorrections.confidence >= 30 && forecastCorrections.samplesUsed >= 2;
    
    if (!shouldApplyCorrections) {
      return {
        ...generateForecast,
        corrected: false,
        correctionConfidence: forecastCorrections.confidence,
        correctionNote: forecastCorrections.samplesUsed < 2 
          ? 'Waiting for data overlap: Need weekly actual sales that match forecast periods'
          : 'Low confidence: Collecting more samples to improve accuracy',
      };
    }
    
    // Apply corrections to weekly forecasts
    const correctedWeekly = generateForecast.weekly?.map(week => {
      const weekDate = new Date(week.weekEnding);
      const month = weekDate.getMonth() + 1;
      const quarter = Math.ceil(month / 3);
      
      // Determine which correction to use (priority: month > quarter > overall)
      let revenueCorrection = forecastCorrections.overall.revenue;
      let unitsCorrection = forecastCorrections.overall.units;
      let profitCorrection = forecastCorrections.overall.profit;
      let correctionSource = 'overall';
      
      // Try month-specific correction
      if (forecastCorrections.byMonth[month]?.samples >= 2) {
        revenueCorrection = forecastCorrections.byMonth[month].revenue;
        unitsCorrection = forecastCorrections.byMonth[month].units;
        profitCorrection = forecastCorrections.byMonth[month].profit;
        correctionSource = `month-${month}`;
      }
      // Fall back to quarter-specific correction
      else if (forecastCorrections.byQuarter[quarter]?.samples >= 2) {
        revenueCorrection = forecastCorrections.byQuarter[quarter].revenue;
        unitsCorrection = forecastCorrections.byQuarter[quarter].units;
        profitCorrection = forecastCorrections.byQuarter[quarter].profit;
        correctionSource = `quarter-${quarter}`;
      }
      
      return {
        ...week,
        originalRevenue: week.revenue,
        originalUnits: week.units,
        originalProfit: week.profit,
        revenue: Math.round(week.revenue * revenueCorrection),
        units: Math.round(week.units * unitsCorrection),
        profit: Math.round(week.profit * profitCorrection),
        correctionApplied: {
          revenue: revenueCorrection,
          units: unitsCorrection,
          profit: profitCorrection,
          source: correctionSource,
        },
      };
    }) || [];
    
    // Recalculate monthly totals
    const correctedMonthly = {
      revenue: correctedWeekly.reduce((sum, w) => sum + w.revenue, 0),
      units: correctedWeekly.reduce((sum, w) => sum + w.units, 0),
      profit: correctedWeekly.reduce((sum, w) => sum + w.profit, 0),
    };
    
    // Calculate improvement from original
    const originalMonthly = generateForecast.monthly || { revenue: 0, units: 0, profit: 0 };
    const revenueChange = originalMonthly.revenue > 0 
      ? ((correctedMonthly.revenue - originalMonthly.revenue) / originalMonthly.revenue * 100).toFixed(1)
      : 0;
    
    return {
      ...generateForecast,
      weekly: correctedWeekly,
      monthly: correctedMonthly,
      originalMonthly,
      corrected: true,
      correctionConfidence: forecastCorrections.confidence,
      correctionSamplesUsed: forecastCorrections.samplesUsed,
      correctionNote: `Forecast adjusted by ${revenueChange}% based on ${forecastCorrections.samplesUsed} historical comparisons`,
      learningStatus: {
        confidence: forecastCorrections.confidence,
        samples: forecastCorrections.samplesUsed,
        skusTracked: Object.keys(forecastCorrections.bySku).length,
        lastUpdated: forecastCorrections.lastUpdated,
      },
    };
  }, [generateForecast, forecastCorrections]);
  // ============ END ENHANCED FORECAST ============

  // AMAZON FORECAST - Parse and store Amazon's forecast data
  const processAmazonForecast = (csvData) => {
    if (!csvData || csvData.length === 0) return null;
    
    // Get date range from first row
    const startDateStr = csvData[0]['Start date'];
    const endDateStr = csvData[0]['End date'];
    
    if (!startDateStr || !endDateStr) return null;
    
    const startDate = new Date(startDateStr);
    const endDate = new Date(endDateStr);
    const daysDiff = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Aggregate forecast data
    let totalUnits = 0, totalSales = 0, totalProceeds = 0, totalAds = 0;
    const skuForecasts = {};
    
    csvData.forEach(r => {
      const sku = r['MSKU'] || '';
      const units = parseInt(r['Net units sold'] || r['Units sold'] || 0);
      const sales = parseFloat(r['Net sales'] || r['Sales'] || 0);
      const proceeds = parseFloat(r['Net proceeds total'] || 0);
      const ads = parseFloat(r['Sponsored Products charge total'] || 0);
      const cogs = parseFloat(r['Cost of goods sold per unit'] || 0);
      
      if (units > 0 || sales > 0) {
        totalUnits += units;
        totalSales += sales;
        totalProceeds += proceeds;
        totalAds += ads;
        
        if (sku) {
          skuForecasts[sku] = {
            sku,
            units,
            sales,
            proceeds,
            ads,
            cogsPerUnit: cogs,
            profitPerUnit: units > 0 ? proceeds / units : 0,
          };
        }
      }
    });
    
    // If this is a 30-day forecast (28-31 days), break it into weekly forecasts
    const isMontlyForecast = daysDiff >= 25 && daysDiff <= 35;
    const weeksInForecast = Math.ceil(daysDiff / 7);
    
    if (isMontlyForecast) {
      // Return multiple weekly forecasts
      const weeklyForecasts = {};
      const weeklyUnits = Math.round(totalUnits / weeksInForecast);
      const weeklySales = totalSales / weeksInForecast;
      const weeklyProceeds = totalProceeds / weeksInForecast;
      const weeklyAds = totalAds / weeksInForecast;
      
      // Generate a forecast for each week in the period
      for (let i = 0; i < weeksInForecast; i++) {
        const weekStart = new Date(startDate);
        weekStart.setDate(weekStart.getDate() + (i * 7));
        const weekKey = getSunday(weekStart);
        
        weeklyForecasts[weekKey] = {
          weekEnding: weekKey,
          startDate: startDateStr,
          endDate: endDateStr,
          uploadedAt: new Date().toISOString(),
          sourceType: '30-day-split',
          weekNumber: i + 1,
          totalWeeks: weeksInForecast,
          totals: {
            units: weeklyUnits,
            sales: weeklySales,
            proceeds: weeklyProceeds,
            ads: weeklyAds,
            profitPerUnit: weeklyUnits > 0 ? weeklyProceeds / weeklyUnits : 0,
          },
          skus: Object.fromEntries(Object.entries(skuForecasts).map(([sku, data]) => [sku, {
            ...data,
            units: Math.round(data.units / weeksInForecast),
            sales: data.sales / weeksInForecast,
            proceeds: data.proceeds / weeksInForecast,
            ads: data.ads / weeksInForecast,
          }])),
          skuCount: Object.keys(skuForecasts).length,
          // Also store the monthly total for reference
          monthlyTotal: {
            units: totalUnits,
            sales: totalSales,
            proceeds: totalProceeds,
            ads: totalAds,
          },
        };
      }
      
      return {
        type: 'monthly',
        forecasts: weeklyForecasts,
        period: { startDate: startDateStr, endDate: endDateStr, days: daysDiff },
        monthlyTotal: { units: totalUnits, sales: totalSales, proceeds: totalProceeds, ads: totalAds },
      };
    }
    
    // Standard weekly forecast
    const weekKey = getSunday(endDate);
    return {
      type: 'weekly',
      forecast: {
        weekEnding: weekKey,
        startDate: startDateStr,
        endDate: endDateStr,
        uploadedAt: new Date().toISOString(),
        sourceType: 'weekly',
        totals: {
          units: totalUnits,
          sales: totalSales,
          proceeds: totalProceeds,
          ads: totalAds,
          profitPerUnit: totalUnits > 0 ? totalProceeds / totalUnits : 0,
        },
        skus: skuForecasts,
        skuCount: Object.keys(skuForecasts).length,
      },
    };
  };

  // Compare Amazon forecast vs actual results - comprehensive analysis with fuzzy matching
  const getAmazonForecastComparison = useMemo(() => {
    const comparisons = [];
    
    // Helper to find best matching actual week (within 3 days)
    const findMatchingActual = (forecastWeekKey) => {
      // First try exact match
      if (allWeeksData[forecastWeekKey]) {
        return { weekKey: forecastWeekKey, actual: allWeeksData[forecastWeekKey], matchType: 'exact' };
      }
      
      // Fuzzy match - look for weeks within 3 days
      const forecastDate = new Date(forecastWeekKey + 'T00:00:00');
      const weekKeys = Object.keys(allWeeksData);
      
      for (const weekKey of weekKeys) {
        const actualDate = new Date(weekKey + 'T00:00:00');
        const daysDiff = Math.abs((forecastDate - actualDate) / (1000 * 60 * 60 * 24));
        
        if (daysDiff <= 3) {
          return { weekKey, actual: allWeeksData[weekKey], matchType: 'fuzzy', daysDiff };
        }
      }
      
      return null;
    };
    
    Object.entries(amazonForecasts).forEach(([weekKey, forecast]) => {
      // Skip if forecast doesn't have the required structure
      if (!forecast || (!forecast.totals && !forecast.totalSales)) return;
      
      const match = findMatchingActual(weekKey);
      
      if (match && match.actual && match.actual.amazon) {
        const actual = match.actual;
        // Support both old (totalSales) and new (totals.sales) structures
        const forecastRev = forecast.totals?.sales || forecast.totalSales || 0;
        const actualRev = actual.amazon.revenue || 0;
        const forecastUnits = forecast.totals?.units || forecast.totalUnits || 0;
        const actualUnits = actual.amazon.units || 0;
        const forecastProfit = forecast.totals?.proceeds || forecast.totalProceeds || 0;
        const actualProfit = actual.amazon.netProfit || 0;
        
        // SKU-level comparison with correction factors for learning
        const skuComparisons = [];
        if (forecast.skus && actual.amazon.skuData) {
          const actualSkuMap = {};
          actual.amazon.skuData.forEach(s => { actualSkuMap[s.sku] = s; });
          
          Object.entries(forecast.skus).forEach(([sku, fcast]) => {
            if (!fcast) return; // Skip if fcast is undefined
            const actualSku = actualSkuMap[sku];
            const fcastUnits = fcast.units || 0;
            const fcastSales = fcast.sales || 0;
            if (actualSku) {
              skuComparisons.push({
                sku,
                forecast: { units: fcastUnits, sales: fcastSales },
                actual: { units: actualSku.unitsSold || 0, sales: actualSku.netSales || 0 },
                variance: {
                  units: (actualSku.unitsSold || 0) - fcastUnits,
                  unitsPercent: fcastUnits > 0 ? (((actualSku.unitsSold || 0) - fcastUnits) / fcastUnits * 100) : 0,
                  sales: (actualSku.netSales || 0) - fcastSales,
                  salesPercent: fcastSales > 0 ? (((actualSku.netSales || 0) - fcastSales) / fcastSales * 100) : 0,
                },
                // Correction factor for this SKU (for self-learning)
                correctionFactor: {
                  units: fcastUnits > 0 ? (actualSku.unitsSold || 0) / fcastUnits : 1,
                  sales: fcastSales > 0 ? (actualSku.netSales || 0) / fcastSales : 1,
                },
              });
            }
          });
        }
        
        comparisons.push({
          weekEnding: weekKey,
          actualWeekKey: match.weekKey,
          matchType: match.matchType,
          daysDiff: match.daysDiff || 0,
          uploadedAt: forecast.uploadedAt,
          recordedAt: new Date().toISOString(),
          forecast: {
            revenue: forecastRev,
            units: forecastUnits,
            profit: forecastProfit,
            skuCount: forecast.skuCount || 0,
          },
          actual: {
            revenue: actualRev,
            units: actualUnits,
            profit: actualProfit,
          },
          variance: {
            revenue: actualRev - forecastRev,
            revenuePercent: forecastRev > 0 ? ((actualRev - forecastRev) / forecastRev * 100) : 0,
            units: actualUnits - forecastUnits,
            unitsPercent: forecastUnits > 0 ? ((actualUnits - forecastUnits) / forecastUnits * 100) : 0,
            profit: actualProfit - forecastProfit,
            profitPercent: forecastProfit > 0 ? ((actualProfit - forecastProfit) / forecastProfit * 100) : 0,
          },
          accuracy: forecastRev > 0 ? Math.max(0, 100 - Math.abs((actualRev - forecastRev) / forecastRev * 100)) : 0,
          status: actualRev >= forecastRev ? 'beat' : 'missed',
          skuComparisons: skuComparisons.sort((a, b) => Math.abs(b.variance.salesPercent) - Math.abs(a.variance.salesPercent)),
          // Correction factors learned from this comparison (for self-learning)
          correctionFactors: {
            revenue: forecastRev > 0 ? actualRev / forecastRev : 1,
            units: forecastUnits > 0 ? actualUnits / forecastUnits : 1,
            profit: forecastProfit > 0 ? actualProfit / forecastProfit : 1,
          },
          // Temporal features for pattern learning
          temporalFeatures: {
            month: new Date(weekKey).getMonth() + 1,
            quarter: Math.ceil((new Date(weekKey).getMonth() + 1) / 3),
            weekOfYear: Math.ceil((new Date(weekKey) - new Date(new Date(weekKey).getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000)),
          },
          // ML training data
          mlFeatures: {
            forecastWeek: weekKey,
            forecastRevenue: forecastRev,
            forecastUnits: forecastUnits,
            actualRevenue: actualRev,
            actualUnits: actualUnits,
            error: actualRev - forecastRev,
            errorPercent: forecastRev > 0 ? ((actualRev - forecastRev) / forecastRev * 100) : 0,
            skuCount: forecast.skuCount || 0,
            // Could add: day of week, month, season, etc.
            month: new Date(weekKey).getMonth() + 1,
            quarter: Math.ceil((new Date(weekKey).getMonth() + 1) / 3),
          },
        });
      }
    });
    
    return comparisons.sort((a, b) => b.weekEnding.localeCompare(a.weekEnding));
  }, [amazonForecasts, allWeeksData]);
  
  // Get pending forecasts (uploaded but no matching actual yet)
  const pendingForecasts = useMemo(() => {
    const matched = new Set(getAmazonForecastComparison.map(c => c.weekEnding));
    return Object.entries(amazonForecasts)
      .filter(([weekKey]) => !matched.has(weekKey))
      .map(([weekKey, forecast]) => ({
        weekEnding: weekKey,
        forecast,
        isPast: new Date(weekKey) < new Date(),
        daysUntil: Math.ceil((new Date(weekKey) - new Date()) / (1000 * 60 * 60 * 24)),
      }))
      .sort((a, b) => a.weekEnding.localeCompare(b.weekEnding));
  }, [amazonForecasts, getAmazonForecastComparison]);
  
  // ML Training Data Export - accumulates all historical comparisons
  const mlTrainingData = useMemo(() => {
    if (getAmazonForecastComparison.length === 0) return null;
    
    return {
      samples: getAmazonForecastComparison.map(c => c.mlFeatures),
      summary: {
        totalSamples: getAmazonForecastComparison.length,
        avgError: getAmazonForecastComparison.reduce((s, c) => s + c.mlFeatures.errorPercent, 0) / getAmazonForecastComparison.length,
        stdDev: Math.sqrt(
          getAmazonForecastComparison.reduce((s, c) => {
            const avg = getAmazonForecastComparison.reduce((s2, c2) => s2 + c2.mlFeatures.errorPercent, 0) / getAmazonForecastComparison.length;
            return s + Math.pow(c.mlFeatures.errorPercent - avg, 2);
          }, 0) / getAmazonForecastComparison.length
        ),
        // Bias: positive = Amazon under-forecasts, negative = Amazon over-forecasts
        bias: getAmazonForecastComparison.reduce((s, c) => s + c.mlFeatures.errorPercent, 0) / getAmazonForecastComparison.length,
        // Suggested correction factor
        correctionFactor: 1 + (getAmazonForecastComparison.reduce((s, c) => s + c.mlFeatures.errorPercent, 0) / getAmazonForecastComparison.length / 100),
      },
    };
  }, [getAmazonForecastComparison]);
  
  // Calculate rolling forecast accuracy metrics
  const forecastAccuracyMetrics = useMemo(() => {
    const comparisons = getAmazonForecastComparison;
    if (comparisons.length === 0) return null;
    
    // Overall accuracy
    const avgAccuracy = comparisons.reduce((s, c) => s + c.accuracy, 0) / comparisons.length;
    const avgRevenueVariance = comparisons.reduce((s, c) => s + c.variance.revenuePercent, 0) / comparisons.length;
    const avgUnitsVariance = comparisons.reduce((s, c) => s + c.variance.unitsPercent, 0) / comparisons.length;
    
    // Trend - is accuracy improving?
    const recentComparisons = comparisons.slice(0, 4); // Last 4 weeks
    const olderComparisons = comparisons.slice(4, 8); // 4 weeks before that
    const recentAccuracy = recentComparisons.length > 0 ? recentComparisons.reduce((s, c) => s + c.accuracy, 0) / recentComparisons.length : 0;
    const olderAccuracy = olderComparisons.length > 0 ? olderComparisons.reduce((s, c) => s + c.accuracy, 0) / olderComparisons.length : 0;
    const accuracyTrend = olderComparisons.length > 0 ? recentAccuracy - olderAccuracy : 0;
    
    // Bias detection - does Amazon consistently over/under forecast?
    const overForecasts = comparisons.filter(c => c.variance.revenuePercent < 0).length;
    const underForecasts = comparisons.filter(c => c.variance.revenuePercent > 0).length;
    const bias = overForecasts > underForecasts * 1.5 ? 'over' : underForecasts > overForecasts * 1.5 ? 'under' : 'neutral';
    
    // Best/worst predicted weeks
    const sortedByAccuracy = [...comparisons].sort((a, b) => b.accuracy - a.accuracy);
    const bestWeek = sortedByAccuracy[0];
    const worstWeek = sortedByAccuracy[sortedByAccuracy.length - 1];
    
    return {
      totalWeeks: comparisons.length,
      avgAccuracy,
      avgRevenueVariance,
      avgUnitsVariance,
      recentAccuracy,
      accuracyTrend,
      bias,
      biasDescription: bias === 'over' ? 'Amazon tends to over-forecast (actuals lower than predicted)' :
                       bias === 'under' ? 'Amazon tends to under-forecast (actuals higher than predicted)' :
                       'Amazon forecasts are balanced',
      beatCount: comparisons.filter(c => c.status === 'beat').length,
      missedCount: comparisons.filter(c => c.status === 'missed').length,
      bestWeek,
      worstWeek,
    };
  }, [getAmazonForecastComparison]);

  // ============ AUTO-LEARNING EFFECT ============
  // Automatically detect new forecast comparisons and update learning
  useEffect(() => {
    if (getAmazonForecastComparison.length === 0) return;
    
    // Check if we have new comparisons that aren't in our history
    const existingWeeks = new Set(forecastAccuracyHistory.records.map(r => r.weekEnding));
    const newComparisons = getAmazonForecastComparison.filter(c => !existingWeeks.has(c.weekEnding));
    
    if (newComparisons.length > 0) {
      // Add new records to history
      const updatedRecords = [
        ...forecastAccuracyHistory.records,
        ...newComparisons.map(c => ({
          weekEnding: c.weekEnding,
          recordedAt: new Date().toISOString(),
          forecast: c.forecast,
          actual: c.actual,
          variance: c.variance,
          accuracy: c.accuracy,
          correctionFactors: c.correctionFactors,
          temporalFeatures: c.temporalFeatures,
          skuComparisons: c.skuComparisons,
        }))
      ];
      
      setForecastAccuracyHistory({
        records: updatedRecords,
        lastUpdated: new Date().toISOString(),
        modelVersion: forecastAccuracyHistory.modelVersion
      });
      
      // Now compute new correction factors using EWMA (Exponential Weighted Moving Average)
      const alpha = 0.3; // Weight for recent data (higher = more responsive to recent trends)
      const records = updatedRecords.sort((a, b) => a.weekEnding.localeCompare(b.weekEnding));
      
      if (records.length >= 2) {
        // Overall correction factors
        let weightedRevenue = 0, weightedUnits = 0, weightedProfit = 0, totalWeight = 0;
        
        records.forEach((record, idx) => {
          const weight = Math.pow(1 - alpha, records.length - 1 - idx);
          weightedRevenue += weight * (record.correctionFactors?.revenue || 1);
          weightedUnits += weight * (record.correctionFactors?.units || 1);
          weightedProfit += weight * (record.correctionFactors?.profit || 1);
          totalWeight += weight;
        });
        
        const overallCorrections = {
          revenue: totalWeight > 0 ? weightedRevenue / totalWeight : 1,
          units: totalWeight > 0 ? weightedUnits / totalWeight : 1,
          profit: totalWeight > 0 ? weightedProfit / totalWeight : 1,
        };
        
        // SKU-level correction factors
        const skuCorrections = {};
        records.forEach(record => {
          if (record.skuComparisons) {
            record.skuComparisons.forEach(sc => {
              if (!skuCorrections[sc.sku]) {
                skuCorrections[sc.sku] = { samples: [], units: [], sales: [] };
              }
              if (sc.correctionFactor) {
                skuCorrections[sc.sku].units.push(sc.correctionFactor.units);
                skuCorrections[sc.sku].sales.push(sc.correctionFactor.sales);
                skuCorrections[sc.sku].samples.push(record.weekEnding);
              }
            });
          }
        });
        
        const bySku = {};
        Object.entries(skuCorrections).forEach(([sku, data]) => {
          if (data.units.length >= 2) {
            bySku[sku] = {
              units: data.units.reduce((a, b) => a + b, 0) / data.units.length,
              sales: data.sales.reduce((a, b) => a + b, 0) / data.sales.length,
              samples: data.samples.length,
            };
          }
        });
        
        // Monthly correction factors
        const byMonth = {};
        records.forEach(record => {
          const month = record.temporalFeatures?.month || new Date(record.weekEnding).getMonth() + 1;
          if (!byMonth[month]) {
            byMonth[month] = { revenue: [], units: [], profit: [] };
          }
          if (record.correctionFactors) {
            byMonth[month].revenue.push(record.correctionFactors.revenue);
            byMonth[month].units.push(record.correctionFactors.units);
            byMonth[month].profit.push(record.correctionFactors.profit);
          }
        });
        
        Object.keys(byMonth).forEach(month => {
          const data = byMonth[month];
          byMonth[month] = {
            revenue: data.revenue.length > 0 ? data.revenue.reduce((a, b) => a + b, 0) / data.revenue.length : 1,
            units: data.units.length > 0 ? data.units.reduce((a, b) => a + b, 0) / data.units.length : 1,
            profit: data.profit.length > 0 ? data.profit.reduce((a, b) => a + b, 0) / data.profit.length : 1,
            samples: data.revenue.length,
          };
        });
        
        // Quarterly correction factors
        const byQuarter = {};
        records.forEach(record => {
          const quarter = record.temporalFeatures?.quarter || Math.ceil((new Date(record.weekEnding).getMonth() + 1) / 3);
          if (!byQuarter[quarter]) {
            byQuarter[quarter] = { revenue: [], units: [], profit: [] };
          }
          if (record.correctionFactors) {
            byQuarter[quarter].revenue.push(record.correctionFactors.revenue);
            byQuarter[quarter].units.push(record.correctionFactors.units);
            byQuarter[quarter].profit.push(record.correctionFactors.profit);
          }
        });
        
        Object.keys(byQuarter).forEach(quarter => {
          const data = byQuarter[quarter];
          byQuarter[quarter] = {
            revenue: data.revenue.length > 0 ? data.revenue.reduce((a, b) => a + b, 0) / data.revenue.length : 1,
            units: data.units.length > 0 ? data.units.reduce((a, b) => a + b, 0) / data.units.length : 1,
            profit: data.profit.length > 0 ? data.profit.reduce((a, b) => a + b, 0) / data.profit.length : 1,
            samples: data.revenue.length,
          };
        });
        
        // Calculate confidence score (0-100)
        const stdDev = Math.sqrt(
          records.reduce((sum, r) => {
            const diff = (r.correctionFactors?.revenue || 1) - overallCorrections.revenue;
            return sum + diff * diff;
          }, 0) / records.length
        );
        const confidence = Math.min(95, Math.max(10, 100 - (stdDev * 30) - (10 / Math.sqrt(records.length))));
        
        setForecastCorrections({
          overall: overallCorrections,
          bySku,
          byMonth,
          byQuarter,
          confidence,
          samplesUsed: records.length,
          lastUpdated: new Date().toISOString(),
        });
      }
    }
  }, [getAmazonForecastComparison, forecastAccuracyHistory.records]);
  // ============ END AUTO-LEARNING EFFECT ============

  // ============ UNIFIED AI LEARNING SYSTEM ============
  // This is the master learning system that combines all data sources and learns continuously
  
  // Helper: Scan data availability across all sources
  const scanDataAvailability = useCallback(() => {
    const amazon = { daily: [], weekly: [], periods: [] };
    const shopify = { daily: [], weekly: [], periods: [] };
    
    // Scan daily data
    Object.entries(allDaysData).forEach(([dateKey, dayData]) => {
      if (dayData.amazon?.revenue > 0 || dayData.amazon?.units > 0) {
        amazon.daily.push(dateKey);
      }
      if (dayData.shopify?.revenue > 0 || dayData.shopify?.units > 0) {
        shopify.daily.push(dateKey);
      }
    });
    
    // Scan weekly data
    Object.entries(allWeeksData).forEach(([weekKey, weekData]) => {
      if (weekData.amazon?.revenue > 0 || weekData.amazon?.units > 0) {
        amazon.weekly.push(weekKey);
      }
      if (weekData.shopify?.revenue > 0 || weekData.shopify?.units > 0) {
        shopify.weekly.push(weekKey);
      }
    });
    
    // Scan period data (monthly, quarterly, yearly)
    Object.entries(allPeriodsData).forEach(([periodKey, periodData]) => {
      if (periodData.amazon?.revenue > 0 || periodData.amazon?.units > 0) {
        amazon.periods.push(periodKey);
      }
      if (periodData.shopify?.revenue > 0 || periodData.shopify?.units > 0) {
        shopify.periods.push(periodKey);
      }
    });
    
    return { amazon, shopify, lastScanned: new Date().toISOString() };
  }, [allDaysData, allWeeksData, allPeriodsData]);
  
  // Helper: Get estimated daily average from period data when daily data isn't available
  const getEstimatedDailyFromPeriod = useCallback((channel, dateKey) => {
    // Find which period this date falls into
    const date = new Date(dateKey + 'T12:00:00');
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const quarter = Math.ceil(month / 3);
    
    // Try monthly first, then quarterly, then yearly
    const monthKey = `${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][month-1]} ${year}`;
    const quarterKey = `Q${quarter} ${year}`;
    const yearKey = `${year}`;
    
    for (const periodKey of [monthKey, quarterKey, yearKey]) {
      const periodData = allPeriodsData[periodKey];
      if (periodData && periodData[channel]?.revenue > 0) {
        // Calculate days in period
        let daysInPeriod = 30; // default for monthly
        if (periodKey.startsWith('Q')) daysInPeriod = 91;
        if (/^\d{4}$/.test(periodKey)) daysInPeriod = 365;
        
        return {
          estimatedRevenue: periodData[channel].revenue / daysInPeriod,
          estimatedUnits: periodData[channel].units / daysInPeriod,
          estimatedProfit: periodData[channel].netProfit / daysInPeriod,
          source: periodKey,
          daysInPeriod,
          isEstimate: true,
        };
      }
    }
    return null;
  }, [allPeriodsData]);
  
  // Helper: Check if a day has complete data for a channel
  const hasDayData = useCallback((channel, dateKey) => {
    const dayData = allDaysData[dateKey];
    if (!dayData) return false;
    const channelData = dayData[channel];
    return channelData && (channelData.revenue > 0 || channelData.units > 0);
  }, [allDaysData]);
  
  // Helper: Get smart daily data that uses actuals when available, estimates when not
  const getSmartDailyData = useCallback((dateKey) => {
    const dayData = allDaysData[dateKey] || {};
    const result = {
      date: dateKey,
      amazon: { revenue: 0, units: 0, profit: 0, isEstimate: false, source: 'none' },
      shopify: { revenue: 0, units: 0, profit: 0, isEstimate: false, source: 'none' },
      total: { revenue: 0, units: 0, profit: 0 },
      hasActualAmazon: false,
      hasActualShopify: false,
      isComplete: false,
    };
    
    // Amazon data
    if (hasDayData('amazon', dateKey)) {
      result.amazon = {
        revenue: dayData.amazon.revenue || 0,
        units: dayData.amazon.units || 0,
        profit: dayData.amazon.netProfit || 0,
        isEstimate: false,
        source: 'daily',
      };
      result.hasActualAmazon = true;
    } else {
      // Try to get estimate from period data
      const estimate = getEstimatedDailyFromPeriod('amazon', dateKey);
      if (estimate) {
        result.amazon = {
          revenue: estimate.estimatedRevenue,
          units: estimate.estimatedUnits,
          profit: estimate.estimatedProfit,
          isEstimate: true,
          source: estimate.source,
        };
      }
    }
    
    // Shopify data
    if (hasDayData('shopify', dateKey)) {
      result.shopify = {
        revenue: dayData.shopify.revenue || 0,
        units: dayData.shopify.units || 0,
        profit: dayData.shopify.netProfit || 0,
        isEstimate: false,
        source: 'daily',
      };
      result.hasActualShopify = true;
    } else {
      const estimate = getEstimatedDailyFromPeriod('shopify', dateKey);
      if (estimate) {
        result.shopify = {
          revenue: estimate.estimatedRevenue,
          units: estimate.estimatedUnits,
          profit: estimate.estimatedProfit,
          isEstimate: true,
          source: estimate.source,
        };
      }
    }
    
    // Calculate totals
    result.total = {
      revenue: result.amazon.revenue + result.shopify.revenue,
      units: result.amazon.units + result.shopify.units,
      profit: result.amazon.profit + result.shopify.profit,
    };
    result.isComplete = result.hasActualAmazon && result.hasActualShopify;
    
    return result;
  }, [allDaysData, hasDayData, getEstimatedDailyFromPeriod]);
  
  // Helper: Calculate trend excluding days without data (don't treat missing as $0)
  const calculateSmartTrend = useCallback((daysCount = 14, channel = 'total') => {
    const today = new Date();
    const days = [];
    
    for (let i = 0; i < daysCount * 2; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateKey = d.toISOString().split('T')[0];
      const smartData = getSmartDailyData(dateKey);
      
      // Only include days that have actual data for the requested channel
      // For 'total', require at least one channel to have actual data
      const hasData = channel === 'total' 
        ? (smartData.hasActualAmazon || smartData.hasActualShopify)
        : (channel === 'amazon' ? smartData.hasActualAmazon : smartData.hasActualShopify);
      
      if (hasData) {
        days.push({
          date: dateKey,
          revenue: channel === 'total' ? smartData.total.revenue : smartData[channel].revenue,
          profit: channel === 'total' ? smartData.total.profit : smartData[channel].profit,
          isEstimate: channel === 'total' 
            ? (smartData.amazon.isEstimate && smartData.shopify.isEstimate)
            : smartData[channel].isEstimate,
        });
      }
      
      if (days.length >= daysCount) break;
    }
    
    if (days.length < 4) return { trend: 0, recentAvg: 0, priorAvg: 0, daysAnalyzed: days.length, message: 'Insufficient data' };
    
    const half = Math.floor(days.length / 2);
    const recent = days.slice(0, half);
    const prior = days.slice(half);
    
    const recentAvg = recent.reduce((s, d) => s + d.revenue, 0) / recent.length;
    const priorAvg = prior.reduce((s, d) => s + d.revenue, 0) / prior.length;
    const trend = priorAvg > 0 ? ((recentAvg - priorAvg) / priorAvg) * 100 : 0;
    
    return {
      trend,
      recentAvg,
      priorAvg,
      daysAnalyzed: days.length,
      recentDays: recent.length,
      priorDays: prior.length,
      excludedEstimates: daysCount - days.length,
    };
  }, [getSmartDailyData]);
  
  // Main unified AI model update effect
  useEffect(() => {
    // Don't run until we have some data
    if (Object.keys(allDaysData).length === 0 && Object.keys(allWeeksData).length === 0 && Object.keys(allPeriodsData).length === 0) {
      return;
    }
    
    // Debounce updates
    const updateModel = () => {
      const dataAvailability = scanDataAvailability();
      
      // Calculate confidence based on data completeness
      const amazonDailyCount = dataAvailability.amazon.daily.length;
      const amazonPeriodCount = dataAvailability.amazon.periods.length;
      const shopifyDailyCount = dataAvailability.shopify.daily.length;
      const shopifyPeriodCount = dataAvailability.shopify.periods.length;
      
      // Amazon confidence: daily data is best, period data is okay
      const amazonConfidence = Math.min(100, (amazonDailyCount * 3) + (amazonPeriodCount * 10));
      const shopifyConfidence = Math.min(100, (shopifyDailyCount * 3) + (shopifyPeriodCount * 10));
      const overallConfidence = Math.round((amazonConfidence + shopifyConfidence) / 2);
      
      // Learn day-of-week patterns from actual daily data only
      const dayOfWeekPatterns = {};
      Object.entries(allDaysData).forEach(([dateKey, dayData]) => {
        // Only use days with actual sales data, not estimates
        if (!dayData.total?.revenue && !dayData.shopify?.revenue && !dayData.amazon?.revenue) return;
        
        const dayName = new Date(dateKey + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' });
        if (!dayOfWeekPatterns[dayName]) {
          dayOfWeekPatterns[dayName] = { count: 0, totalRevenue: 0, totalProfit: 0 };
        }
        dayOfWeekPatterns[dayName].count++;
        dayOfWeekPatterns[dayName].totalRevenue += dayData.total?.revenue || dayData.shopify?.revenue || dayData.amazon?.revenue || 0;
        dayOfWeekPatterns[dayName].totalProfit += dayData.total?.netProfit || dayData.shopify?.netProfit || dayData.amazon?.netProfit || 0;
      });
      
      // Calculate averages and find best/worst days
      const dayStats = Object.entries(dayOfWeekPatterns).map(([day, data]) => ({
        day,
        avgRevenue: data.count > 0 ? data.totalRevenue / data.count : 0,
        avgProfit: data.count > 0 ? data.totalProfit / data.count : 0,
        samples: data.count,
      })).sort((a, b) => b.avgRevenue - a.avgRevenue);
      
      const bestDays = dayStats.filter(d => d.samples >= 3).slice(0, 2).map(d => d.day);
      const worstDays = dayStats.filter(d => d.samples >= 3).slice(-2).map(d => d.day);
      
      // Learn seasonal patterns from period data
      const monthlyRevenue = {};
      Object.entries(allPeriodsData).forEach(([periodKey, data]) => {
        const monthMatch = periodKey.match(/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
        if (monthMatch) {
          const month = monthMatch[1];
          if (!monthlyRevenue[month]) monthlyRevenue[month] = [];
          monthlyRevenue[month].push(data.total?.revenue || 0);
        }
      });
      
      // Find peak months
      const monthAvgs = Object.entries(monthlyRevenue).map(([month, revenues]) => ({
        month,
        avgRevenue: revenues.reduce((a, b) => a + b, 0) / revenues.length,
        samples: revenues.length,
      })).sort((a, b) => b.avgRevenue - a.avgRevenue);
      
      const seasonalPeaks = monthAvgs.filter(m => m.samples >= 1).slice(0, 3).map(m => m.month);
      
      // Merge existing correction factors (don't overwrite, just enhance)
      const existingCorrections = unifiedAIModel.corrections || {};
      const mergedCorrections = {
        ...existingCorrections,
        overall: forecastCorrections.overall || existingCorrections.overall || { revenue: 1, units: 1, profit: 1 },
        bySku: { ...existingCorrections.bySku, ...forecastCorrections.bySku },
        byMonth: { ...existingCorrections.byMonth, ...forecastCorrections.byMonth },
        byQuarter: { ...existingCorrections.byQuarter, ...forecastCorrections.byQuarter },
        byDayOfWeek: Object.fromEntries(
          dayStats.filter(d => d.samples >= 5).map(d => {
            const overallAvg = dayStats.reduce((s, x) => s + x.avgRevenue, 0) / dayStats.length;
            return [d.day, { revenue: overallAvg > 0 ? d.avgRevenue / overallAvg : 1 }];
          })
        ),
      };
      
      // Update the model
      setUnifiedAIModel(prev => ({
        ...prev,
        lastUpdated: new Date().toISOString(),
        dataAvailability,
        confidence: {
          amazon: amazonConfidence,
          shopify: shopifyConfidence,
          overall: overallConfidence,
        },
        corrections: mergedCorrections,
        patterns: {
          ...prev.patterns,
          bestDays,
          worstDays,
          seasonalPeaks,
          dayOfWeekStats: dayStats,
          monthlyStats: monthAvgs,
        },
        // Merge learning from forecastCorrections
        signalWeights: {
          dailyTrend: shopifyDailyCount > 14 ? 0.4 : 0.2,  // Less weight if little daily data
          weeklyAverage: 0.25,
          amazonForecast: amazonPeriodCount > 0 ? 0.2 : 0.1,
          seasonality: monthAvgs.length > 3 ? 0.1 : 0.05,
          momentum: 0.1,
        },
      }));
    };
    
    // Debounce to avoid excessive updates
    const timer = setTimeout(updateModel, 1000);
    return () => clearTimeout(timer);
  }, [allDaysData, allWeeksData, allPeriodsData, forecastCorrections, scanDataAvailability]);
  
  // ============ SMART DATA AGGREGATION ============
  // Provides comprehensive business metrics that properly handle gaps in daily data
  // Uses period data (monthly/quarterly) to fill in when daily data isn't available
  const unifiedBusinessMetrics = useMemo(() => {
    const metrics = {
      // Overall totals - prefer period data for historical accuracy
      allTime: { amazon: { revenue: 0, units: 0, profit: 0 }, shopify: { revenue: 0, units: 0, profit: 0 }, total: { revenue: 0, units: 0, profit: 0 } },
      
      // By year breakdown
      byYear: {},
      
      // Data source tracking - helps AI understand data completeness
      dataSources: {
        amazon: { dailyDates: [], periodNames: [], hasDailyGaps: false, gapsCoveredByPeriods: [] },
        shopify: { dailyDates: [], periodNames: [], hasDailyGaps: false, gapsCoveredByPeriods: [] },
      },
      
      // Proper averages that don't treat missing days as $0
      averages: {
        dailyRevenue: { amazon: 0, shopify: 0, total: 0, daysUsed: 0 },
        weeklyRevenue: { amazon: 0, shopify: 0, total: 0, weeksUsed: 0 },
        monthlyRevenue: { amazon: 0, shopify: 0, total: 0, monthsUsed: 0 },
      },
    };
    
    // Track which periods/years we have data for
    const yearlyTotals = {};
    const periodsCounted = new Set();
    
    // First pass: Collect all period data (most accurate for historical totals)
    Object.entries(allPeriodsData).forEach(([periodKey, data]) => {
      // Extract year from period key
      const yearMatch = periodKey.match(/(\d{4})/);
      const year = yearMatch ? yearMatch[1] : 'Unknown';
      
      if (!yearlyTotals[year]) {
        yearlyTotals[year] = { 
          amazon: { revenue: 0, units: 0, profit: 0, sources: [] }, 
          shopify: { revenue: 0, units: 0, profit: 0, sources: [] },
          total: { revenue: 0, units: 0, profit: 0 },
        };
      }
      
      // Check if this is a monthly period (most granular period data)
      const isMonthly = /^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i.test(periodKey);
      const isQuarterly = /^Q\d/i.test(periodKey);
      const isYearly = /^\d{4}$/.test(periodKey);
      
      // For yearly totals, prefer monthly data, then quarterly, then yearly
      // Only add if we haven't already counted this data
      if (isMonthly) {
        // Monthly data - most accurate, always use
        if (data.amazon?.revenue > 0) {
          yearlyTotals[year].amazon.revenue += data.amazon.revenue;
          yearlyTotals[year].amazon.units += data.amazon.units || 0;
          yearlyTotals[year].amazon.profit += data.amazon.netProfit || 0;
          yearlyTotals[year].amazon.sources.push(periodKey);
          metrics.dataSources.amazon.periodNames.push(periodKey);
        }
        if (data.shopify?.revenue > 0) {
          yearlyTotals[year].shopify.revenue += data.shopify.revenue;
          yearlyTotals[year].shopify.units += data.shopify.units || 0;
          yearlyTotals[year].shopify.profit += data.shopify.netProfit || 0;
          yearlyTotals[year].shopify.sources.push(periodKey);
          metrics.dataSources.shopify.periodNames.push(periodKey);
        }
        periodsCounted.add(periodKey);
      } else if (isQuarterly && !periodsCounted.has(periodKey)) {
        // Check if we already have monthly data for this quarter
        const quarterNum = parseInt(periodKey.match(/Q(\d)/)?.[1] || '0');
        const monthsInQuarter = {
          1: ['Jan', 'Feb', 'Mar'],
          2: ['Apr', 'May', 'Jun'],
          3: ['Jul', 'Aug', 'Sep'],
          4: ['Oct', 'Nov', 'Dec'],
        }[quarterNum] || [];
        
        const hasMonthlyData = monthsInQuarter.some(m => periodsCounted.has(`${m} ${year}`));
        
        if (!hasMonthlyData) {
          // Use quarterly data since we don't have monthly
          if (data.amazon?.revenue > 0) {
            yearlyTotals[year].amazon.revenue += data.amazon.revenue;
            yearlyTotals[year].amazon.units += data.amazon.units || 0;
            yearlyTotals[year].amazon.profit += data.amazon.netProfit || 0;
            yearlyTotals[year].amazon.sources.push(periodKey);
            metrics.dataSources.amazon.periodNames.push(periodKey);
          }
          if (data.shopify?.revenue > 0) {
            yearlyTotals[year].shopify.revenue += data.shopify.revenue;
            yearlyTotals[year].shopify.units += data.shopify.units || 0;
            yearlyTotals[year].shopify.profit += data.shopify.netProfit || 0;
            yearlyTotals[year].shopify.sources.push(periodKey);
            metrics.dataSources.shopify.periodNames.push(periodKey);
          }
          periodsCounted.add(periodKey);
        }
      }
    });
    
    // For 2026 (current year), also check weekly data if no period data
    const currentYear = new Date().getFullYear().toString();
    if (!yearlyTotals[currentYear] || yearlyTotals[currentYear].amazon.sources.length === 0) {
      if (!yearlyTotals[currentYear]) {
        yearlyTotals[currentYear] = { 
          amazon: { revenue: 0, units: 0, profit: 0, sources: [] }, 
          shopify: { revenue: 0, units: 0, profit: 0, sources: [] },
          total: { revenue: 0, units: 0, profit: 0 },
        };
      }
      
      // Use weekly data for current year
      Object.entries(allWeeksData).forEach(([weekKey, data]) => {
        if (weekKey.startsWith(currentYear)) {
          if (data.amazon?.revenue > 0) {
            yearlyTotals[currentYear].amazon.revenue += data.amazon.revenue;
            yearlyTotals[currentYear].amazon.units += data.amazon.units || 0;
            yearlyTotals[currentYear].amazon.profit += data.amazon.netProfit || 0;
            yearlyTotals[currentYear].amazon.sources.push(`Week ${weekKey}`);
          }
          if (data.shopify?.revenue > 0) {
            yearlyTotals[currentYear].shopify.revenue += data.shopify.revenue;
            yearlyTotals[currentYear].shopify.units += data.shopify.units || 0;
            yearlyTotals[currentYear].shopify.profit += data.shopify.netProfit || 0;
            yearlyTotals[currentYear].shopify.sources.push(`Week ${weekKey}`);
          }
        }
      });
    }
    
    // Calculate totals by year
    Object.entries(yearlyTotals).forEach(([year, data]) => {
      data.total = {
        revenue: data.amazon.revenue + data.shopify.revenue,
        units: data.amazon.units + data.shopify.units,
        profit: data.amazon.profit + data.shopify.profit,
      };
      metrics.byYear[year] = data;
      
      // Add to all-time totals
      metrics.allTime.amazon.revenue += data.amazon.revenue;
      metrics.allTime.amazon.units += data.amazon.units;
      metrics.allTime.amazon.profit += data.amazon.profit;
      metrics.allTime.shopify.revenue += data.shopify.revenue;
      metrics.allTime.shopify.units += data.shopify.units;
      metrics.allTime.shopify.profit += data.shopify.profit;
    });
    
    metrics.allTime.total = {
      revenue: metrics.allTime.amazon.revenue + metrics.allTime.shopify.revenue,
      units: metrics.allTime.amazon.units + metrics.allTime.shopify.units,
      profit: metrics.allTime.amazon.profit + metrics.allTime.shopify.profit,
    };
    
    // Calculate proper averages from ACTUAL data only
    // Daily averages - only from days with actual data
    let amazonDailySum = 0, shopifyDailySum = 0, daysWithData = 0;
    Object.entries(allDaysData).forEach(([dateKey, data]) => {
      const hasAmazon = data.amazon?.revenue > 0;
      const hasShopify = data.shopify?.revenue > 0;
      if (hasAmazon || hasShopify) {
        daysWithData++;
        amazonDailySum += data.amazon?.revenue || 0;
        shopifyDailySum += data.shopify?.revenue || 0;
        if (hasAmazon) metrics.dataSources.amazon.dailyDates.push(dateKey);
        if (hasShopify) metrics.dataSources.shopify.dailyDates.push(dateKey);
      }
    });
    
    if (daysWithData > 0) {
      metrics.averages.dailyRevenue = {
        amazon: amazonDailySum / daysWithData,
        shopify: shopifyDailySum / daysWithData,
        total: (amazonDailySum + shopifyDailySum) / daysWithData,
        daysUsed: daysWithData,
      };
    }
    
    // Weekly averages - only from weeks with actual data
    let amazonWeeklySum = 0, shopifyWeeklySum = 0, weeksWithData = 0;
    Object.entries(allWeeksData).forEach(([weekKey, data]) => {
      const hasAmazon = data.amazon?.revenue > 0;
      const hasShopify = data.shopify?.revenue > 0;
      if (hasAmazon || hasShopify) {
        weeksWithData++;
        amazonWeeklySum += data.amazon?.revenue || 0;
        shopifyWeeklySum += data.shopify?.revenue || 0;
      }
    });
    
    if (weeksWithData > 0) {
      metrics.averages.weeklyRevenue = {
        amazon: amazonWeeklySum / weeksWithData,
        shopify: shopifyWeeklySum / weeksWithData,
        total: (amazonWeeklySum + shopifyWeeklySum) / weeksWithData,
        weeksUsed: weeksWithData,
      };
    }
    
    // Monthly averages - from period data
    let amazonMonthlySum = 0, shopifyMonthlySum = 0, monthsWithData = 0;
    Object.entries(allPeriodsData).forEach(([periodKey, data]) => {
      if (/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i.test(periodKey)) {
        const hasAmazon = data.amazon?.revenue > 0;
        const hasShopify = data.shopify?.revenue > 0;
        if (hasAmazon || hasShopify) {
          monthsWithData++;
          amazonMonthlySum += data.amazon?.revenue || 0;
          shopifyMonthlySum += data.shopify?.revenue || 0;
        }
      }
    });
    
    if (monthsWithData > 0) {
      metrics.averages.monthlyRevenue = {
        amazon: amazonMonthlySum / monthsWithData,
        shopify: shopifyMonthlySum / monthsWithData,
        total: (amazonMonthlySum + shopifyMonthlySum) / monthsWithData,
        monthsUsed: monthsWithData,
      };
    }
    
    // Detect data gaps
    // For Amazon: check if we have monthly periods but few daily entries for 2025
    const amazon2025Months = metrics.dataSources.amazon.periodNames.filter(p => p.includes('2025'));
    const amazon2025Days = metrics.dataSources.amazon.dailyDates.filter(d => d.startsWith('2025'));
    if (amazon2025Months.length > 0 && amazon2025Days.length < 30) {
      metrics.dataSources.amazon.hasDailyGaps = true;
      metrics.dataSources.amazon.gapsCoveredByPeriods = amazon2025Months;
    }
    
    return metrics;
  }, [allDaysData, allWeeksData, allPeriodsData]);
  // ============ END UNIFIED AI LEARNING SYSTEM ============

  // Get upcoming Amazon forecasts (weeks we haven't reached yet)
  const upcomingAmazonForecasts = useMemo(() => {
    const today = new Date();
    return Object.entries(amazonForecasts)
      .filter(([weekKey]) => new Date(weekKey) > today)
      .sort((a, b) => a[0].localeCompare(b[0]))
      .map(([weekKey, data]) => ({ weekEnding: weekKey, ...data }));
  }, [amazonForecasts]);

  // ============ AI INSIGHTS GENERATION ============
  const generateAIInsights = useCallback(async () => {
    if (aiInsightsLoading) return;
    setAiInsightsLoading(true);
    
    try {
      // Prepare context data for AI analysis
      const recentWeeks = Object.keys(allWeeksData).sort().reverse().slice(0, 8);
      const weekData = recentWeeks.map(w => ({
        week: w,
        revenue: allWeeksData[w]?.total?.revenue || 0,
        profit: allWeeksData[w]?.total?.netProfit || 0,
        units: allWeeksData[w]?.total?.units || 0,
      }));
      
      const accuracyData = forecastAccuracyHistory.records.slice(-8).map(r => ({
        week: r.weekEnding,
        accuracy: r.accuracy,
        variance: r.variance?.revenuePercent || 0,
      }));
      
      const learningStatus = {
        confidence: forecastCorrections.confidence,
        samples: forecastCorrections.samplesUsed,
        overallRevenueFactor: forecastCorrections.overall?.revenue || 1,
        overallUnitsFactor: forecastCorrections.overall?.units || 1,
      };
      
      const prompt = `Analyze this e-commerce business data and provide 3-5 actionable insights:

Recent Sales (last 8 weeks): ${JSON.stringify(weekData)}

Forecast Accuracy History: ${JSON.stringify(accuracyData)}

Learning System Status: ${JSON.stringify(learningStatus)}

Focus on:
1. Sales trends and patterns
2. Forecast accuracy improvement opportunities
3. Inventory planning recommendations
4. Any concerning patterns

Keep insights brief and actionable. Format as numbered list.`;

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: [{ role: 'user', content: prompt }],
          model: 'claude-sonnet-4-20250514',
        }),
      });
      
      if (response.ok) {
        const data = await response.json();
        const insights = data.content || data.message || data.response || 'Unable to generate insights';
        setAiInsights({
          content: insights,
          generatedAt: new Date().toISOString(),
          dataPoints: weekData.length + accuracyData.length,
        });
      } else {
        setAiInsights({
          content: 'AI analysis unavailable. Check API connection.',
          generatedAt: new Date().toISOString(),
          error: true,
        });
      }
    } catch (err) {
      console.error('AI insights error:', err);
      setAiInsights({
        content: 'Error generating insights: ' + err.message,
        generatedAt: new Date().toISOString(),
        error: true,
      });
    } finally {
      setAiInsightsLoading(false);
    }
  }, [allWeeksData, forecastAccuracyHistory.records, forecastCorrections, aiInsightsLoading]);
  // ============ END AI INSIGHTS ============

  // ============ AI-POWERED FORECASTING ============
  const generateAIForecasts = useCallback(async () => {
    if (aiForecastLoading) return;
    setAiForecastLoading(true);
    
    try {
      // ==================== DATA COLLECTION ====================
      const sortedWeeks = Object.keys(allWeeksData).sort();
      const sortedDays = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort();
      const today = new Date();
      
      if (sortedWeeks.length < 2 && sortedDays.length < 7) {
        setAiForecasts({ error: 'Need at least 2 weeks or 7 days of data', generatedAt: new Date().toISOString() });
        return;
      }
      
      // ==================== DAILY DATA ANALYSIS (MOST IMPORTANT) ====================
      const dailyData = sortedDays.slice(-60).map(d => {
        const data = allDaysData[d];
        const date = new Date(d + 'T12:00:00');
        return {
          date: d,
          dayOfWeek: date.toLocaleDateString('en-US', { weekday: 'long' }),
          dayNum: date.getDay(),
          revenue: data?.total?.revenue || 0,
          profit: data?.total?.netProfit || 0,
          units: data?.total?.units || 0,
          amazonRevenue: data?.amazon?.revenue || 0,
          shopifyRevenue: data?.shopify?.revenue || 0,
        };
      }).filter(d => d.revenue > 0); // Only days with actual sales
      
      // Last 7 days, 14 days, 30 days analysis
      const last7Days = dailyData.slice(-7);
      const last14Days = dailyData.slice(-14);
      const last30Days = dailyData.slice(-30);
      const prior7Days = dailyData.slice(-14, -7);
      
      const avg7Day = last7Days.length > 0 ? last7Days.reduce((s, d) => s + d.revenue, 0) / last7Days.length : 0;
      const avg14Day = last14Days.length > 0 ? last14Days.reduce((s, d) => s + d.revenue, 0) / last14Days.length : 0;
      const avg30Day = last30Days.length > 0 ? last30Days.reduce((s, d) => s + d.revenue, 0) / last30Days.length : 0;
      const avgPrior7 = prior7Days.length > 0 ? prior7Days.reduce((s, d) => s + d.revenue, 0) / prior7Days.length : avg7Day;
      
      // Momentum: Compare last 7 days to prior 7 days
      const momentum = avgPrior7 > 0 ? ((avg7Day - avgPrior7) / avgPrior7 * 100) : 0;
      
      // Day-of-week patterns
      const dayPatterns = {};
      ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].forEach(day => {
        const dayData = dailyData.filter(d => d.dayOfWeek === day);
        if (dayData.length > 0) {
          dayPatterns[day] = {
            avgRevenue: dayData.reduce((s, d) => s + d.revenue, 0) / dayData.length,
            avgProfit: dayData.reduce((s, d) => s + d.profit, 0) / dayData.length,
            sampleSize: dayData.length,
          };
        }
      });
      
      // Best and worst days
      const sortedDayPatterns = Object.entries(dayPatterns).sort((a, b) => b[1].avgRevenue - a[1].avgRevenue);
      const bestDays = sortedDayPatterns.slice(0, 2).map(([day]) => day);
      const worstDays = sortedDayPatterns.slice(-2).map(([day]) => day);
      
      // ==================== WEEKLY DATA ANALYSIS ====================
      const weeklyData = sortedWeeks.slice(-12).map(w => {
        const data = allWeeksData[w];
        return {
          weekEnding: w,
          revenue: data?.total?.revenue || 0,
          profit: data?.total?.netProfit || 0,
          units: data?.total?.units || 0,
          margin: data?.total?.revenue > 0 ? (data?.total?.netProfit / data?.total?.revenue * 100) : 0,
          amazonRevenue: data?.amazon?.revenue || 0,
          shopifyRevenue: data?.shopify?.revenue || 0,
          adSpend: data?.total?.adSpend || 0,
        };
      });
      
      // Filter to complete weeks only (> $1000 revenue or > 10% of average)
      const avgWeekRev = weeklyData.reduce((s, w) => s + w.revenue, 0) / weeklyData.length;
      const completeWeeks = weeklyData.filter(w => w.revenue > Math.max(1000, avgWeekRev * 0.1));
      
      // Weekly trend analysis
      const recentWeeks = completeWeeks.slice(-4);
      const olderWeeks = completeWeeks.slice(-8, -4);
      const recentWeekAvg = recentWeeks.length > 0 ? recentWeeks.reduce((s, w) => s + w.revenue, 0) / recentWeeks.length : 0;
      const olderWeekAvg = olderWeeks.length > 0 ? olderWeeks.reduce((s, w) => s + w.revenue, 0) / olderWeeks.length : recentWeekAvg;
      const weeklyTrend = olderWeekAvg > 0 ? ((recentWeekAvg - olderWeekAvg) / olderWeekAvg * 100) : 0;
      
      // ==================== AMAZON FORECAST ANALYSIS (CRITICAL) ====================
      const amazonForecastWeeks = Object.entries(amazonForecasts)
        .map(([week, data]) => ({
          weekEnding: week,
          forecastRevenue: data.totals?.sales || data.totals?.revenue || 0,
          forecastUnits: data.totals?.units || 0,
          forecastProceeds: data.totals?.proceeds || 0,
          skuCount: data.skuCount || Object.keys(data.skuForecasts || {}).length,
          isFuture: new Date(week) > today,
          isPast: new Date(week) <= today,
        }))
        .sort((a, b) => a.weekEnding.localeCompare(b.weekEnding));
      
      // Future Amazon forecasts (next 4 weeks)
      const futureAmazonForecasts = amazonForecastWeeks.filter(f => f.isFuture).slice(0, 4);
      
      // Amazon forecast accuracy: Compare past forecasts to actual results
      let amazonAccuracy = { samples: 0, avgError: 0, bias: 0 };
      const pastForecasts = amazonForecastWeeks.filter(f => f.isPast && f.forecastRevenue > 0);
      if (pastForecasts.length > 0) {
        let totalError = 0, totalBias = 0, samples = 0;
        pastForecasts.forEach(f => {
          const actual = allWeeksData[f.weekEnding]?.amazon?.revenue || 0;
          if (actual > 0) {
            const error = Math.abs(f.forecastRevenue - actual) / actual * 100;
            const bias = (f.forecastRevenue - actual) / actual * 100; // Positive = optimistic
            totalError += error;
            totalBias += bias;
            samples++;
          }
        });
        if (samples > 0) {
          amazonAccuracy = {
            samples,
            avgError: totalError / samples,
            bias: totalBias / samples, // Positive means Amazon typically over-predicts
          };
        }
      }
      
      // Adjust Amazon forecast based on historical accuracy
      const amazonBiasCorrection = amazonAccuracy.samples >= 2 ? (1 - amazonAccuracy.bias / 100) : 1;
      const adjustedAmazonForecast = futureAmazonForecasts.length > 0 
        ? futureAmazonForecasts[0].forecastRevenue * amazonBiasCorrection
        : null;
      
      // ==================== CALCULATE WEIGHTED PREDICTION ====================
      // Weight: Daily data (60%), Weekly trend (20%), Amazon forecast (20%)
      const dailyBasedWeekly = avg7Day * 7; // Most recent daily Ã— 7
      const trendAdjustedWeekly = dailyBasedWeekly * (1 + weeklyTrend / 100 * 0.5); // Damped trend
      
      // ==================== PERIOD DATA ANALYSIS (2025 Monthly, 2024 Quarterly) ====================
      const periodsSummary = Object.entries(allPeriodsData).map(([label, data]) => ({
        period: label,
        type: (() => {
          const l = label.toLowerCase();
          if (l.match(/^\d{4}$/)) return 'yearly';
          if (l.match(/^q\d/i)) return 'quarterly';
          if (l.match(/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i)) return 'monthly';
          return 'monthly';
        })(),
        totalRevenue: data.total?.revenue || 0,
        totalProfit: data.total?.netProfit || 0,
        totalUnits: data.total?.units || 0,
        margin: data.total?.revenue > 0 ? ((data.total?.netProfit || 0) / data.total.revenue * 100) : 0,
      })).sort((a, b) => a.period.localeCompare(b.period));
      
      const months2025 = periodsSummary.filter(p => (p.period.includes('2025') || p.period.includes('-2025')) && p.type === 'monthly');
      const quarters2024 = periodsSummary.filter(p => (p.period.includes('2024') || p.period.includes('-2024')) && p.type === 'quarterly');
      
      // Calculate seasonal index for current month (if we have historical data)
      const currentMonth = today.toLocaleDateString('en-US', { month: 'long' });
      const monthlyData = periodsSummary.filter(p => p.type === 'monthly' && p.totalRevenue > 0);
      let seasonalIndex = 1.0;
      if (monthlyData.length >= 3) {
        const avgMonthlyRevenue = monthlyData.reduce((s, m) => s + m.totalRevenue, 0) / monthlyData.length;
        const currentMonthData = monthlyData.find(m => m.period.toLowerCase().includes(currentMonth.toLowerCase()));
        if (currentMonthData && avgMonthlyRevenue > 0) {
          seasonalIndex = currentMonthData.totalRevenue / avgMonthlyRevenue;
        }
      }
      
      // Get YoY baseline if available (same month last year)
      const lastYearSameMonth = `${currentMonth} ${today.getFullYear() - 1}`;
      const yoyBaseline = periodsSummary.find(p => p.period === lastYearSameMonth);
      
      let weightedPrediction;
      if (adjustedAmazonForecast && futureAmazonForecasts.length > 0) {
        // Blend: 60% daily-based, 20% trend-adjusted, 20% Amazon (bias-corrected)
        weightedPrediction = (dailyBasedWeekly * 0.6) + (trendAdjustedWeekly * 0.2) + (adjustedAmazonForecast * 0.2);
      } else {
        // No Amazon forecast: 70% daily-based, 30% trend-adjusted
        weightedPrediction = (dailyBasedWeekly * 0.7) + (trendAdjustedWeekly * 0.3);
      }
      
      // Calculate profit prediction based on historical margin
      // Try daily data first, fall back to weekly data, then use default
      const dailyTotalRevenue = last30Days.reduce((s, d) => s + d.revenue, 0);
      const dailyTotalProfit = last30Days.reduce((s, d) => s + d.profit, 0);
      
      let avgProfitMargin;
      if (dailyTotalRevenue > 0 && dailyTotalProfit !== 0) {
        avgProfitMargin = dailyTotalProfit / dailyTotalRevenue;
      } else {
        // Fall back to weekly data
        const recentWeeks = sortedWeeks.slice(-8);
        const weeklyTotalRevenue = recentWeeks.reduce((s, w) => s + (allWeeksData[w]?.total?.revenue || 0), 0);
        const weeklyTotalProfit = recentWeeks.reduce((s, w) => s + (allWeeksData[w]?.total?.netProfit || 0), 0);
        
        if (weeklyTotalRevenue > 0 && weeklyTotalProfit !== 0) {
          avgProfitMargin = weeklyTotalProfit / weeklyTotalRevenue;
        } else {
          avgProfitMargin = 0.25; // Default 25% margin if no profit data
        }
      }
      
      // Sanity check - margin should be between -50% and 60%
      if (isNaN(avgProfitMargin) || avgProfitMargin > 0.6) avgProfitMargin = 0.25;
      if (avgProfitMargin < -0.5) avgProfitMargin = -0.1; // Cap losses at -10% for forecasting
      
      const profitPrediction = weightedPrediction * avgProfitMargin;
      
      // ==================== INVENTORY ANALYSIS ====================
      const latestInvKey = Object.keys(invHistory).sort().reverse()[0];
      const inventoryItems = latestInvKey ? (invHistory[latestInvKey]?.items || []).map(item => ({
        sku: item.sku,
        name: savedProductNames[item.sku] || item.name || item.sku,
        currentStock: item.totalQty || 0,
        weeklyVelocity: item.weeklyVel || 0,
        daysOfSupply: item.daysOfSupply || 0,
        health: item.health,
      })) : [];
      
      const criticalInventory = inventoryItems.filter(i => i.daysOfSupply > 0 && i.daysOfSupply < 14);
      const lowInventory = inventoryItems.filter(i => i.daysOfSupply >= 14 && i.daysOfSupply < 30);
      
      // ==================== ADS SPEND ANALYSIS ====================
      // Handle both formats: shopify.googleSpend (with sales data) and root-level googleSpend (ads-only)
      const adsAnalysis = sortedDays.slice(-30).reduce((acc, d) => {
        const dayData = allDaysData[d];
        if (!dayData) return acc;
        
        // Support both nested (shopify.googleSpend) and flat (googleSpend) formats
        const googleAds = dayData?.shopify?.googleSpend || dayData?.googleSpend || dayData?.googleAds || 0;
        const metaAds = dayData?.shopify?.metaSpend || dayData?.metaSpend || dayData?.metaAds || 0;
        const adsMetrics = dayData?.shopify?.adsMetrics || {};
        
        // For flat format, metrics are at root level
        const googleImpressions = adsMetrics.googleImpressions || dayData?.googleImpressions || 0;
        const metaImpressions = adsMetrics.metaImpressions || dayData?.metaImpressions || 0;
        const googleClicks = adsMetrics.googleClicks || dayData?.googleClicks || 0;
        const metaClicks = adsMetrics.metaClicks || dayData?.metaClicks || 0;
        const googleConversions = adsMetrics.googleConversions || dayData?.googleConversions || 0;
        const metaPurchases = adsMetrics.metaPurchases || dayData?.metaConversions || 0;
        const metaPurchaseValue = adsMetrics.metaPurchaseValue || dayData?.metaPurchaseValue || 0;
        
        return {
          totalGoogleSpend: acc.totalGoogleSpend + googleAds,
          totalMetaSpend: acc.totalMetaSpend + metaAds,
          totalImpressions: acc.totalImpressions + googleImpressions + metaImpressions,
          totalClicks: acc.totalClicks + googleClicks + metaClicks,
          totalConversions: acc.totalConversions + googleConversions + metaPurchases,
          metaPurchaseValue: acc.metaPurchaseValue + metaPurchaseValue,
          daysWithAds: googleAds > 0 || metaAds > 0 ? acc.daysWithAds + 1 : acc.daysWithAds,
        };
      }, { totalGoogleSpend: 0, totalMetaSpend: 0, totalImpressions: 0, totalClicks: 0, totalConversions: 0, metaPurchaseValue: 0, daysWithAds: 0 });
      
      const totalAdSpend = adsAnalysis.totalGoogleSpend + adsAnalysis.totalMetaSpend;
      const avgDailyAdSpend = adsAnalysis.daysWithAds > 0 ? totalAdSpend / adsAnalysis.daysWithAds : 0;
      const overallCTR = adsAnalysis.totalImpressions > 0 ? (adsAnalysis.totalClicks / adsAnalysis.totalImpressions * 100) : 0;
      const avgCPC = adsAnalysis.totalClicks > 0 ? totalAdSpend / adsAnalysis.totalClicks : 0;
      
      // ==================== BUILD COMPREHENSIVE PROMPT ====================
      const prompt = `You are an elite e-commerce forecasting AI. I've pre-calculated key signals - your job is to synthesize them into accurate predictions.

## ðŸ“Š PRE-CALCULATED FORECAST SIGNALS

### DAILY DATA ANALYSIS (Primary Signal - 60% weight)
- Last 7 Days Average: $${avg7Day.toFixed(2)}/day
- Last 14 Days Average: $${avg14Day.toFixed(2)}/day  
- Last 30 Days Average: $${avg30Day.toFixed(2)}/day
- 7-Day Momentum: ${momentum > 0 ? '+' : ''}${momentum.toFixed(1)}% (vs prior 7 days)
- Daily â†’ Weekly Projection: $${dailyBasedWeekly.toFixed(2)}/week

### WEEKLY TREND ANALYSIS (Secondary Signal - 20% weight)
- Recent 4-Week Average: $${recentWeekAvg.toFixed(2)}/week
- Prior 4-Week Average: $${olderWeekAvg.toFixed(2)}/week
- Weekly Trend: ${weeklyTrend > 0 ? '+' : ''}${weeklyTrend.toFixed(1)}%
- Trend-Adjusted Projection: $${trendAdjustedWeekly.toFixed(2)}/week

### AMAZON FORECAST ANALYSIS (Forward Signal - 20% weight)
${futureAmazonForecasts.length > 0 ? `
- Next Week Amazon Forecast: $${futureAmazonForecasts[0].forecastRevenue.toFixed(2)} (${futureAmazonForecasts[0].forecastUnits} units)
- Amazon Forecast Accuracy: ${amazonAccuracy.samples} samples, ${amazonAccuracy.avgError.toFixed(1)}% avg error
- Amazon Bias: ${amazonAccuracy.bias > 0 ? 'Over-predicts' : 'Under-predicts'} by ${Math.abs(amazonAccuracy.bias).toFixed(1)}%
- Bias-Corrected Amazon Forecast: $${adjustedAmazonForecast?.toFixed(2) || 'N/A'}
` : 'No Amazon forecast data available - rely on historical patterns'}

### ðŸŽ¯ WEIGHTED PREDICTION (My calculation)
**NEXT WEEK REVENUE: $${weightedPrediction.toFixed(2)}**
**NEXT WEEK PROFIT: $${profitPrediction.toFixed(2)}** (at ${(avgProfitMargin * 100).toFixed(1)}% margin)

### DAY-OF-WEEK PATTERNS
Best Days: ${bestDays.join(', ')} 
Worst Days: ${worstDays.join(', ')}
${JSON.stringify(dayPatterns, null, 2)}

### RAW DAILY DATA (Last 14 days)
${JSON.stringify(last14Days, null, 2)}

### RAW WEEKLY DATA (Complete weeks)
${JSON.stringify(completeWeeks.slice(-8), null, 2)}

### AMAZON FORECASTS (Next 4 weeks)
${JSON.stringify(futureAmazonForecasts, null, 2)}

### HISTORICAL PERIOD DATA (2025 Monthly, 2024 Quarterly)
${months2025.length > 0 ? `2025 Monthly Performance:
${months2025.map(m => `- ${m.period}: $${m.totalRevenue.toFixed(0)} revenue, $${m.totalProfit.toFixed(0)} profit, ${m.margin.toFixed(1)}% margin`).join('\n')}` : 'No 2025 monthly data uploaded'}

${quarters2024.length > 0 ? `2024 Quarterly Performance:
${quarters2024.map(q => `- ${q.period}: $${q.totalRevenue.toFixed(0)} revenue, $${q.totalProfit.toFixed(0)} profit`).join('\n')}` : 'No 2024 quarterly data'}

${yoyBaseline ? `YoY Baseline (${lastYearSameMonth}): $${yoyBaseline.totalRevenue.toFixed(0)} revenue, $${yoyBaseline.totalProfit.toFixed(0)} profit` : ''}
Seasonal Index for ${currentMonth}: ${seasonalIndex.toFixed(2)} (1.0 = average, >1 = above average month)

### INVENTORY ALERTS
Critical (< 14 days): ${criticalInventory.length} items
Low Stock (< 30 days): ${lowInventory.length} items
${criticalInventory.length > 0 ? JSON.stringify(criticalInventory.slice(0, 5), null, 2) : ''}

### ADS SPEND ANALYSIS (Last 30 days)
${adsAnalysis.daysWithAds > 0 ? `
- Total Google Ads Spend: $${adsAnalysis.totalGoogleSpend.toFixed(2)}
- Total Meta Ads Spend: $${adsAnalysis.totalMetaSpend.toFixed(2)}
- Combined Ad Spend: $${totalAdSpend.toFixed(2)}
- Avg Daily Ad Spend: $${avgDailyAdSpend.toFixed(2)}/day
- Days with Ad Data: ${adsAnalysis.daysWithAds}
- Total Impressions: ${adsAnalysis.totalImpressions.toLocaleString()}
- Total Clicks: ${adsAnalysis.totalClicks.toLocaleString()}
- Overall CTR: ${overallCTR.toFixed(2)}%
- Avg CPC: $${avgCPC.toFixed(2)}
- Conversions: ${adsAnalysis.totalConversions}
- Meta Purchase Value: $${adsAnalysis.metaPurchaseValue.toFixed(2)}
` : 'No ads data available for the last 30 days'}

### LEARNING CORRECTIONS (from past predictions)
- Confidence: ${forecastCorrections.confidence?.toFixed(1) || 0}%
- Revenue Multiplier: ${forecastCorrections.overall?.revenue?.toFixed(3) || 1}x
- Samples Used: ${forecastCorrections.samplesUsed || 0}

---

## YOUR TASK

1. **Validate or adjust** my weighted prediction of $${weightedPrediction.toFixed(2)}/week
2. **Generate next 4 weeks** forecast with confidence levels
3. **Identify patterns** I may have missed
4. **Provide actionable insights**

Respond with ONLY this JSON:

{
  "salesForecast": {
    "next4Weeks": [
      {
        "weekEnding": "YYYY-MM-DD",
        "predictedRevenue": ${Math.round(weightedPrediction)},
        "predictedProfit": ${Math.round(profitPrediction)},
        "predictedUnits": number,
        "confidence": "high|medium|low",
        "reasoning": "why this prediction"
      }
    ],
    "monthlyOutlook": {
      "expectedRevenue": ${Math.round(weightedPrediction * 4)},
      "expectedProfit": ${Math.round(profitPrediction * 4)},
      "growthTrend": "up|stable|down",
      "keyFactors": ["factor1", "factor2"]
    }
  },
  "signalAnalysis": {
    "dailySignalStrength": "strong|moderate|weak",
    "amazonForecastReliability": "${amazonAccuracy.samples >= 3 ? 'reliable' : amazonAccuracy.samples >= 1 ? 'moderate' : 'no data'}",
    "trendDirection": "${weeklyTrend > 5 ? 'up' : weeklyTrend < -5 ? 'down' : 'stable'}",
    "confidenceFactors": ["what increases confidence", "what decreases it"]
  },
  "patterns": {
    "bestDays": ${JSON.stringify(bestDays)},
    "worstDays": ${JSON.stringify(worstDays)},
    "seasonalTrend": "any seasonal pattern detected",
    "anomalies": ["unusual patterns"]
  },
  "inventoryRecommendations": [
    { "sku": "SKU", "action": "reorder|monitor", "urgency": "critical|high|medium", "reasoning": "why" }
  ],
  "adsRecommendations": {
    "overallPerformance": "good|average|poor",
    "recommendations": [
      { "platform": "google|meta|amazon", "action": "increase|maintain|decrease|pause", "reasoning": "why" }
    ],
    "suggestedBudget": {
      "daily": number,
      "weekly": number,
      "rationale": "why this budget"
    }
  },
  "actionableInsights": [
    { "category": "sales|inventory|marketing|ads", "priority": "high|medium", "insight": "specific action", "expectedImpact": "expected result" }
  ],
  "risks": [
    { "risk": "description", "likelihood": "high|medium|low", "mitigation": "how to address" }
  ]
}`;

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system: 'You are an elite e-commerce forecasting AI. You receive pre-calculated signals and synthesize them into accurate predictions. Trust the weighted calculation provided but adjust based on patterns you identify. Always respond with valid JSON only.',
          messages: [{ role: 'user', content: prompt }],
          model: 'claude-sonnet-4-20250514',
        }),
      });
      
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      const responseText = data.content?.[0]?.text || data.content || '';
      
      // Parse JSON response
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const forecast = JSON.parse(jsonMatch[0]);
        
        // Light validation - predictions should be within 50% of our weighted calculation
        const maxReasonable = weightedPrediction * 1.5;
        const minReasonable = weightedPrediction * 0.5;
        
        if (forecast.salesForecast?.next4Weeks) {
          forecast.salesForecast.next4Weeks = forecast.salesForecast.next4Weeks.map((week, i) => {
            let { predictedRevenue, predictedProfit } = week;
            
            // Only adjust revenue if way off (> 50% deviation)
            if (predictedRevenue > maxReasonable || predictedRevenue < minReasonable) {
              predictedRevenue = weightedPrediction * (1 + (i * 0.02)); // Slight growth per week
              week.confidence = 'medium';
              week.reasoning = `Adjusted to align with weighted signal calculation. ${week.reasoning || ''}`;
            }
            
            // ALWAYS ensure profit is calculated based on actual margin data
            // AI often returns 0 or misses this field
            if (!predictedProfit || predictedProfit === 0) {
              predictedProfit = predictedRevenue * avgProfitMargin;
            }
            
            // Sanity check: profit shouldn't exceed revenue or be wildly negative
            if (predictedProfit > predictedRevenue) {
              predictedProfit = predictedRevenue * avgProfitMargin;
            }
            
            return { ...week, predictedRevenue: Math.round(predictedRevenue * 100) / 100, predictedProfit: Math.round(predictedProfit * 100) / 100 };
          });
        }
        
        setAiForecasts({
          ...forecast,
          generatedAt: new Date().toISOString(),
          calculatedSignals: {
            dailyAvg7: avg7Day,
            dailyAvg14: avg14Day,
            dailyAvg30: avg30Day,
            momentum,
            weeklyTrend,
            amazonBiasCorrection,
            weightedPrediction,
            profitPrediction,
            avgProfitMargin: avgProfitMargin * 100,
            seasonalIndex,
          },
          periodData: {
            months2025: months2025.length,
            quarters2024: quarters2024.length,
            totalPeriods: periodsSummary.length,
            yoyBaseline: yoyBaseline ? { period: yoyBaseline.period, revenue: yoyBaseline.totalRevenue, profit: yoyBaseline.totalProfit } : null,
            currentMonthSeasonalIndex: seasonalIndex,
          },
          adsAnalysis: {
            totalGoogleSpend: adsAnalysis.totalGoogleSpend,
            totalMetaSpend: adsAnalysis.totalMetaSpend,
            totalAdSpend,
            avgDailyAdSpend,
            totalImpressions: adsAnalysis.totalImpressions,
            totalClicks: adsAnalysis.totalClicks,
            totalConversions: adsAnalysis.totalConversions,
            metaPurchaseValue: adsAnalysis.metaPurchaseValue,
            overallCTR,
            avgCPC,
            daysWithAds: adsAnalysis.daysWithAds,
          },
          dataPoints: {
            dailyDays: dailyData.length,
            weeklyWeeks: completeWeeks.length,
            amazonForecastWeeks: futureAmazonForecasts.length,
            amazonAccuracySamples: amazonAccuracy.samples,
            adsDataDays: adsAnalysis.daysWithAds,
            periodMonths2025: months2025.length,
            periodQuarters2024: quarters2024.length,
          },
        });
      } else {
        throw new Error('Invalid response format');
      }
      
    } catch (error) {
      console.error('AI Forecast error:', error);
      setAiForecasts({ error: error.message || 'Failed to generate AI forecast', generatedAt: new Date().toISOString() });
    } finally {
      setAiForecastLoading(false);
    }
  }, [allWeeksData, allDaysData, amazonForecasts, invHistory, savedProductNames, forecastCorrections, aiForecastLoading]);
  // ============ END AI-POWERED FORECASTING ============

  // ============ MODULAR AI FORECAST SYSTEM ============
  
  // Helper to get lead time for a SKU
  const getLeadTime = useCallback((sku) => {
    return leadTimeSettings.skuLeadTimes[sku] || leadTimeSettings.defaultLeadTimeDays;
  }, [leadTimeSettings]);
  
  // 1. SALES FORECAST AI - Predict tomorrow, week, month, quarter
  const generateSalesForecastAI = useCallback(async (period = 'week') => {
    setAiForecastModule(prev => ({ ...prev, loading: 'sales' }));
    
    try {
      const sortedWeeks = Object.keys(allWeeksData).sort();
      const sortedDays = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort();
      
      // Prepare historical data
      const weeklyHistory = sortedWeeks.slice(-12).map(w => ({
        weekEnding: w,
        revenue: allWeeksData[w]?.total?.revenue || 0,
        profit: allWeeksData[w]?.total?.netProfit || 0,
        units: allWeeksData[w]?.total?.units || 0,
        amazonRevenue: allWeeksData[w]?.amazon?.revenue || 0,
        shopifyRevenue: allWeeksData[w]?.shopify?.revenue || 0,
      }));
      
      const dailyHistory = sortedDays.slice(-30).map(d => {
        const date = new Date(d + 'T12:00:00');
        return {
          date: d,
          dayOfWeek: date.toLocaleDateString('en-US', { weekday: 'short' }),
          revenue: allDaysData[d]?.total?.revenue || 0,
          profit: allDaysData[d]?.total?.netProfit || 0,
          units: allDaysData[d]?.total?.units || 0,
        };
      });
      
      // Calculate key metrics for baseline - EXCLUDE ZERO REVENUE WEEKS
      // Filter to only weeks with actual revenue > $100 (to exclude placeholder/empty weeks)
      const activeWeeks = weeklyHistory.filter(w => w.revenue > 100);
      const activeDays = dailyHistory.filter(d => d.revenue > 0);
      
      // Calculate averages from ACTIVE data only
      const avgWeeklyRevenue = activeWeeks.length > 0 
        ? activeWeeks.reduce((sum, w) => sum + w.revenue, 0) / activeWeeks.length : 0;
      const avgWeeklyProfit = activeWeeks.length > 0
        ? activeWeeks.reduce((sum, w) => sum + w.profit, 0) / activeWeeks.length : 0;
      const avgWeeklyUnits = activeWeeks.length > 0
        ? activeWeeks.reduce((sum, w) => sum + w.units, 0) / activeWeeks.length : 0;
      const avgDailyRevenue = activeDays.length > 0
        ? activeDays.reduce((sum, d) => sum + d.revenue, 0) / activeDays.length : 0;
      const avgDailyProfit = activeDays.length > 0
        ? activeDays.reduce((sum, d) => sum + d.profit, 0) / activeDays.length : 0;
      const avgDailyUnits = activeDays.length > 0
        ? activeDays.reduce((sum, d) => sum + d.units, 0) / activeDays.length : 0;
      
      // Calculate weekly estimate from daily data (more accurate if we have recent daily data)
      const weeklyFromDaily = avgDailyRevenue * 7;
      const weeklyProfitFromDaily = avgDailyProfit * 7;
      const weeklyUnitsFromDaily = avgDailyUnits * 7;
      
      // If we have recent daily data (last 7 days), prefer that over weekly averages
      const recentDays = activeDays.slice(-7);
      const hasRecentDailyData = recentDays.length >= 5;
      
      // Use weighted average: 70% daily-based if recent, 30% weekly
      let effectiveWeeklyRevenue, effectiveWeeklyProfit, effectiveWeeklyUnits;
      if (hasRecentDailyData && weeklyFromDaily > 0) {
        effectiveWeeklyRevenue = weeklyFromDaily * 0.7 + avgWeeklyRevenue * 0.3;
        effectiveWeeklyProfit = weeklyProfitFromDaily * 0.7 + avgWeeklyProfit * 0.3;
        effectiveWeeklyUnits = weeklyUnitsFromDaily * 0.7 + avgWeeklyUnits * 0.3;
      } else if (avgWeeklyRevenue > 0) {
        effectiveWeeklyRevenue = avgWeeklyRevenue;
        effectiveWeeklyProfit = avgWeeklyProfit;
        effectiveWeeklyUnits = avgWeeklyUnits;
      } else {
        effectiveWeeklyRevenue = weeklyFromDaily;
        effectiveWeeklyProfit = weeklyProfitFromDaily;
        effectiveWeeklyUnits = weeklyUnitsFromDaily;
      }
      
      // Past predictions for learning
      const pastPredictions = aiLearningHistory.predictions
        .filter(p => p.type === 'sales' && p.actual !== undefined)
        .slice(-10);
      
      // Determine the baseline based on period
      let baselineRevenue, baselineProfit, baselineUnits;
      if (period === 'tomorrow') {
        baselineRevenue = avgDailyRevenue;
        baselineProfit = avgDailyProfit;
        baselineUnits = avgDailyUnits;
      } else if (period === 'week') {
        baselineRevenue = effectiveWeeklyRevenue;
        baselineProfit = effectiveWeeklyProfit;
        baselineUnits = effectiveWeeklyUnits;
      } else if (period === 'month') {
        baselineRevenue = effectiveWeeklyRevenue * 4.33;
        baselineProfit = effectiveWeeklyProfit * 4.33;
        baselineUnits = effectiveWeeklyUnits * 4.33;
      } else { // quarter
        baselineRevenue = effectiveWeeklyRevenue * 13;
        baselineProfit = effectiveWeeklyProfit * 13;
        baselineUnits = effectiveWeeklyUnits * 13;
      }
      
      const prompt = `You are an expert e-commerce sales forecaster. Analyze this data and predict sales.

CRITICAL: Base your prediction on the ACTUAL historical data. Do NOT make up numbers.

## REQUEST: Predict ${period === 'tomorrow' ? "TOMORROW's" : period === 'week' ? 'THIS WEEK' : period === 'month' ? 'THIS MONTH' : 'THIS QUARTER'} sales

## TODAY'S DATE: ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}

## KEY BASELINES (calculated from ACTIVE data only - zero-revenue weeks excluded)
- Average Daily Revenue (last 30 days): $${avgDailyRevenue.toFixed(2)}/day
- Weekly estimate from daily data: $${weeklyFromDaily.toFixed(2)}/week
- Average from active weeks (${activeWeeks.length} weeks with sales): $${avgWeeklyRevenue.toFixed(2)}/week
- **EFFECTIVE WEEKLY BASELINE**: $${effectiveWeeklyRevenue.toFixed(2)} (${hasRecentDailyData ? '70% daily-based, 30% weekly' : 'weekly average'})
- EXPECTED BASELINE FOR ${period.toUpperCase()}: $${baselineRevenue.toFixed(2)} revenue, $${baselineProfit.toFixed(2)} profit, ${Math.round(baselineUnits)} units

## RECENT DAILY PERFORMANCE (MOST RELIABLE - ${activeDays.length} active days)
${JSON.stringify(dailyHistory.slice(-14), null, 2)}

## WEEKLY HISTORY (${activeWeeks.length} active weeks out of ${weeklyHistory.length} total)
${JSON.stringify(activeWeeks.slice(-8), null, 2)}

## PAST AI PREDICTIONS VS ACTUALS (for learning)
${pastPredictions.length > 0 ? JSON.stringify(pastPredictions, null, 2) : 'No past predictions yet'}

## LEARNING CORRECTIONS
Revenue Correction: ${forecastCorrections.overall?.revenue?.toFixed(3) || 1}x
Confidence: ${forecastCorrections.confidence?.toFixed(1) || 0}%

RULES:
1. PRIORITIZE recent daily data over older weekly data
2. Your "expected" prediction should be very close to the baseline of $${baselineRevenue.toFixed(0)}
3. "low" should be ~20% below baseline, "high" should be ~20% above
4. Only deviate significantly if there's a clear trend in the RECENT data
5. Ignore weeks with zero or near-zero revenue (they represent data gaps, not actual performance)

Respond with ONLY this JSON:
{
  "period": "${period}",
  "prediction": {
    "revenue": { "low": number, "expected": number (near $${baselineRevenue.toFixed(0)}), "high": number },
    "profit": { "low": number, "expected": number, "high": number },
    "units": { "low": number, "expected": number, "high": number }
  },
  "confidence": "high" | "medium" | "low",
  "reasoning": "explain based on actual data",
  "factors": ["factor1", "factor2"],
  "dayOfWeekInsight": "pattern insight if relevant",
  "trend": "up" | "stable" | "down"
}`;

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system: 'You are an expert e-commerce sales forecaster. Provide accurate, data-driven predictions. Always respond with valid JSON only.',
          messages: [{ role: 'user', content: prompt }],
          model: 'claude-sonnet-4-20250514',
        }),
      });
      
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      const responseText = data.content?.[0]?.text || data.content || '';
      
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        let forecast = JSON.parse(jsonMatch[0]);
        
        // VALIDATION: Ensure predictions are within reasonable bounds
        const maxReasonable = baselineRevenue * 2.5;
        const minReasonable = baselineRevenue * 0.3;
        
        if (forecast.prediction?.revenue?.expected) {
          const pred = forecast.prediction.revenue.expected;
          if (pred > maxReasonable || pred < minReasonable) {
            // Adjust to reasonable values based on baseline
            forecast.prediction.revenue = {
              low: Math.round(baselineRevenue * 0.8),
              expected: Math.round(baselineRevenue),
              high: Math.round(baselineRevenue * 1.2),
            };
            forecast.prediction.profit = {
              low: Math.round(baselineProfit * 0.8),
              expected: Math.round(baselineProfit),
              high: Math.round(baselineProfit * 1.2),
            };
            forecast.prediction.units = {
              low: Math.round(baselineUnits * 0.8),
              expected: Math.round(baselineUnits),
              high: Math.round(baselineUnits * 1.2),
            };
            forecast.confidence = 'low';
            forecast.reasoning = `Adjusted to historical baseline of $${baselineRevenue.toFixed(0)}. Original AI prediction was outside reasonable range.`;
          }
        }
        
        // Store prediction for future learning
        const predictionRecord = {
          id: `sales-${period}-${Date.now()}`,
          type: 'sales',
          period,
          predictedAt: new Date().toISOString(),
          prediction: forecast.prediction,
          baseline: { revenue: baselineRevenue, profit: baselineProfit, units: baselineUnits },
          // actual will be filled in later when we have real data
        };
        
        setAiLearningHistory(prev => ({
          ...prev,
          predictions: [...prev.predictions.slice(-50), predictionRecord], // Keep last 50
        }));
        
        setAiForecastModule(prev => ({
          ...prev,
          sales: {
            ...prev.sales,
            [period]: { ...forecast, baseline: baselineRevenue, generatedAt: new Date().toISOString() },
          },
          loading: null,
          lastUpdated: new Date().toISOString(),
        }));
      }
    } catch (error) {
      console.error('Sales Forecast AI error:', error);
      setAiForecastModule(prev => ({ ...prev, loading: null }));
    }
  }, [allWeeksData, allDaysData, forecastCorrections, aiLearningHistory]);
  
  // 2. INVENTORY AI - Reorder recommendations with lead times
  const generateInventoryAI = useCallback(async () => {
    setAiForecastModule(prev => ({ ...prev, loading: 'inventory' }));
    
    try {
      const latestInvKey = Object.keys(invHistory).sort().reverse()[0];
      const currentInventory = latestInvKey ? (invHistory[latestInvKey]?.items || []).map(item => ({
        sku: item.sku,
        name: savedProductNames[item.sku] || item.name || item.sku,
        currentStock: item.totalQty || 0,
        amazonStock: item.amazonQty || 0,
        threeplStock: item.threeplQty || 0,
        weeklyVelocity: item.weeklyVel || 0,
        daysOfSupply: item.daysOfSupply || 0,
        health: item.health,
        leadTimeDays: getLeadTime(item.sku),
        cost: savedCogs[item.sku] || item.cost || 0,
      })) : [];
      
      // Get production pipeline
      const pendingProduction = productionPipeline.map(p => ({
        sku: p.sku,
        quantity: p.quantity,
        expectedDate: p.expectedDate,
        daysUntilArrival: Math.ceil((new Date(p.expectedDate) - new Date()) / (1000 * 60 * 60 * 24)),
      }));
      
      const prompt = `You are an expert inventory planner. Analyze current stock levels, velocity, lead times, and pending production to provide reorder recommendations.

## TODAY'S DATE: ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}

## LEAD TIME SETTINGS
Default Lead Time: ${leadTimeSettings.defaultLeadTimeDays} days
Reorder Buffer: ${leadTimeSettings.reorderBuffer} days (extra safety margin)

## CURRENT INVENTORY (${currentInventory.length} SKUs)
${JSON.stringify(currentInventory.slice(0, 30), null, 2)}

## PENDING PRODUCTION ORDERS (${pendingProduction.length} orders)
${pendingProduction.length > 0 ? JSON.stringify(pendingProduction, null, 2) : 'No pending production orders'}

## ANALYSIS RULES
1. Reorder Point = (Weekly Velocity / 7) Ã— (Lead Time + Buffer Days)
2. If Days of Supply < Lead Time + Buffer â†’ CRITICAL
3. If Days of Supply < Lead Time + Buffer + 14 â†’ REORDER NOW
4. Factor in pending production - if it arrives before stockout, adjust urgency
5. Calculate optimal reorder quantity (typically 4-8 weeks of supply)

Respond with ONLY this JSON:
{
  "summary": {
    "criticalCount": number,
    "reorderCount": number,
    "healthyCount": number,
    "totalValue": number
  },
  "recommendations": [
    {
      "sku": "SKU code",
      "name": "Product name",
      "urgency": "critical" | "reorder" | "monitor" | "healthy",
      "action": "specific action to take",
      "currentStock": number,
      "daysOfSupply": number,
      "leadTimeDays": number,
      "weeklyVelocity": number,
      "suggestedOrderQty": number,
      "reorderDate": "YYYY-MM-DD when to place order",
      "stockoutDate": "YYYY-MM-DD estimated stockout if no action",
      "pendingProduction": number or null,
      "pendingArrivalDate": "date or null",
      "reasoning": "why this recommendation"
    }
  ],
  "alerts": ["urgent alert 1", "urgent alert 2"],
  "insights": "overall inventory health assessment"
}`;

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system: 'You are an expert inventory planner for e-commerce. Provide specific, actionable reorder recommendations. Always respond with valid JSON only.',
          messages: [{ role: 'user', content: prompt }],
          model: 'claude-sonnet-4-20250514',
        }),
      });
      
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      const responseText = data.content?.[0]?.text || data.content || '';
      
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const inventory = JSON.parse(jsonMatch[0]);
        setAiForecastModule(prev => ({
          ...prev,
          inventory: { ...inventory, generatedAt: new Date().toISOString() },
          loading: null,
          lastUpdated: new Date().toISOString(),
        }));
      }
    } catch (error) {
      console.error('Inventory AI error:', error);
      setAiForecastModule(prev => ({ ...prev, loading: null }));
    }
  }, [invHistory, savedProductNames, savedCogs, productionPipeline, leadTimeSettings, getLeadTime]);
  
  // 3. CHANNEL FORECAST AI - Amazon or Shopify specific
  const generateChannelForecastAI = useCallback(async (channel = 'amazon') => {
    setAiForecastModule(prev => ({ ...prev, loading: channel }));
    
    try {
      // Filter to only weeks with actual revenue data
      const sortedWeeks = Object.keys(allWeeksData)
        .filter(w => (allWeeksData[w]?.total?.revenue || 0) > 0)
        .sort()
        .slice(-12);
      const sortedDays = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort().slice(-30);
      
      const channelWeekly = sortedWeeks.map(w => {
        const data = allWeeksData[w]?.[channel] || {};
        return {
          weekEnding: w,
          revenue: data.revenue || 0,
          profit: data.netProfit || 0,
          units: data.units || 0,
          adSpend: data.adSpend || (channel === 'shopify' ? (data.metaSpend || 0) + (data.googleSpend || 0) : 0),
          margin: data.netMargin || data.margin || 0,
        };
      }).filter(w => w.revenue > 0); // Only include weeks with channel revenue
      
      const channelDaily = sortedDays.map(d => {
        const data = allDaysData[d]?.[channel] || {};
        return {
          date: d,
          revenue: data.revenue || 0,
          profit: data.netProfit || 0,
          units: data.units || 0,
        };
      }).filter(d => d.revenue > 0); // Only include days with channel revenue
      
      // Get Amazon forecasts if channel is amazon
      const amazonForecastData = channel === 'amazon' ? Object.entries(amazonForecasts)
        .filter(([week]) => new Date(week) > new Date())
        .slice(0, 4)
        .map(([week, data]) => ({
          weekEnding: week,
          amazonForecastedUnits: data.totals?.units || 0,
          amazonForecastedRevenue: data.totals?.revenue || 0,
        })) : [];
      
      const prompt = `You are an expert ${channel === 'amazon' ? 'Amazon' : 'Shopify'} channel analyst. Forecast performance for this specific channel.

## CHANNEL: ${channel.toUpperCase()}
## TODAY: ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}

## ${channel.toUpperCase()} WEEKLY HISTORY (${channelWeekly.length} weeks)
${JSON.stringify(channelWeekly, null, 2)}

## ${channel.toUpperCase()} DAILY HISTORY (${channelDaily.length} days)
${JSON.stringify(channelDaily, null, 2)}

${channel === 'amazon' && amazonForecastData.length > 0 ? `## AMAZON'S OWN FORECAST (for comparison)
${JSON.stringify(amazonForecastData, null, 2)}` : ''}

Respond with ONLY this JSON:
{
  "channel": "${channel}",
  "nextWeek": {
    "revenue": { "low": number, "expected": number, "high": number },
    "profit": { "low": number, "expected": number, "high": number },
    "units": { "low": number, "expected": number, "high": number }
  },
  "nextMonth": {
    "revenue": number,
    "profit": number,
    "units": number
  },
  "trend": "up" | "stable" | "down",
  "growthRate": number (percentage),
  "confidence": "high" | "medium" | "low",
  "channelHealth": "excellent" | "good" | "fair" | "poor",
  "insights": ["insight 1", "insight 2"],
  "recommendations": ["recommendation 1", "recommendation 2"],
  ${channel === 'amazon' ? '"vsAmazonForecast": "how our AI prediction compares to Amazon\'s forecast",' : ''}
  "reasoning": "explanation of forecast"
}`;

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system: `You are an expert ${channel === 'amazon' ? 'Amazon marketplace' : 'Shopify/DTC'} analyst. Provide accurate channel-specific forecasts. Always respond with valid JSON only.`,
          messages: [{ role: 'user', content: prompt }],
          model: 'claude-sonnet-4-20250514',
        }),
      });
      
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      const responseText = data.content?.[0]?.text || data.content || '';
      
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const forecast = JSON.parse(jsonMatch[0]);
        setAiForecastModule(prev => ({
          ...prev,
          [channel]: { ...forecast, generatedAt: new Date().toISOString() },
          loading: null,
          lastUpdated: new Date().toISOString(),
        }));
      }
    } catch (error) {
      console.error(`${channel} Forecast AI error:`, error);
      setAiForecastModule(prev => ({ ...prev, loading: null }));
    }
  }, [allWeeksData, allDaysData, amazonForecasts]);
  
  // 4. AI VS AMAZON COMPARISON - Compare predictions
  const generateForecastComparisonAI = useCallback(async () => {
    setAiForecastModule(prev => ({ ...prev, loading: 'comparison' }));
    
    try {
      // Get weeks where we have both Amazon forecast and actual data
      const comparisons = [];
      Object.keys(amazonForecasts).forEach(weekKey => {
        const forecast = amazonForecasts[weekKey];
        const actual = allWeeksData[weekKey];
        if (actual && forecast) {
          const forecastRevenue = forecast.totals?.sales || forecast.totalSales || 0;
          const forecastUnits = forecast.totals?.units || forecast.totalUnits || 0;
          comparisons.push({
            weekEnding: weekKey,
            amazonForecast: {
              revenue: forecastRevenue,
              units: forecastUnits,
            },
            actual: {
              revenue: actual.amazon?.revenue || 0,
              units: actual.amazon?.units || 0,
            },
            variance: {
              revenuePercent: forecastRevenue > 0 ? ((actual.amazon?.revenue || 0) - forecastRevenue) / forecastRevenue * 100 : 0,
              unitsPercent: forecastUnits > 0 ? ((actual.amazon?.units || 0) - forecastUnits) / forecastUnits * 100 : 0,
            },
          });
        }
      });
      
      // Get AI's past predictions
      const aiPredictions = aiLearningHistory.predictions.filter(p => p.actual !== undefined);
      
      const prompt = `You are an expert forecast analyst. Compare Amazon's forecasts vs actual results and analyze accuracy patterns.

## AMAZON FORECAST VS ACTUAL (${comparisons.length} weeks)
${JSON.stringify(comparisons, null, 2)}

## OUR AI'S PAST PREDICTIONS VS ACTUALS (${aiPredictions.length} records)
${aiPredictions.length > 0 ? JSON.stringify(aiPredictions.slice(-10), null, 2) : 'Not enough AI predictions yet for comparison'}

## CURRENT LEARNING CORRECTIONS
Revenue Correction Factor: ${forecastCorrections.overall?.revenue?.toFixed(3) || 'Not calculated'}
Units Correction Factor: ${forecastCorrections.overall?.units?.toFixed(3) || 'Not calculated'}
Confidence: ${forecastCorrections.confidence?.toFixed(1) || 0}%
Samples Used: ${forecastCorrections.samplesUsed || 0}

Analyze the data and respond with ONLY this JSON:
{
  "amazonAccuracy": {
    "averageRevenueError": number (percentage),
    "averageUnitsError": number (percentage),
    "bias": "overestimates" | "underestimates" | "balanced",
    "consistency": "high" | "medium" | "low"
  },
  "aiAccuracy": {
    "averageError": number or null,
    "improvement": "better than Amazon" | "similar" | "worse" | "not enough data"
  },
  "recommendedCorrection": {
    "revenue": number (multiplier),
    "units": number (multiplier),
    "confidence": number (0-100)
  },
  "patterns": ["pattern 1", "pattern 2"],
  "insights": "detailed analysis of forecast accuracy",
  "recommendations": ["how to improve forecasting"]
}`;

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system: 'You are an expert forecast accuracy analyst. Compare prediction models and identify improvement opportunities. Always respond with valid JSON only.',
          messages: [{ role: 'user', content: prompt }],
          model: 'claude-sonnet-4-20250514',
        }),
      });
      
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      const responseText = data.content?.[0]?.text || data.content || '';
      
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const comparison = JSON.parse(jsonMatch[0]);
        setAiForecastModule(prev => ({
          ...prev,
          comparison: { ...comparison, rawData: comparisons, generatedAt: new Date().toISOString() },
          loading: null,
          lastUpdated: new Date().toISOString(),
        }));
      }
    } catch (error) {
      console.error('Forecast Comparison AI error:', error);
      setAiForecastModule(prev => ({ ...prev, loading: null }));
    }
  }, [amazonForecasts, allWeeksData, aiLearningHistory, forecastCorrections]);
  
  // Update learning when new actual data comes in
  const updateAILearning = useCallback(() => {
    // Find predictions that now have actual data
    const updatedPredictions = aiLearningHistory.predictions.map(pred => {
      if (pred.actual !== undefined) return pred; // Already has actual
      
      // Check if we now have actual data for this prediction
      if (pred.type === 'sales') {
        const predDate = new Date(pred.predictedAt);
        let actualData = null;
        
        if (pred.period === 'tomorrow') {
          const targetDate = new Date(predDate);
          targetDate.setDate(targetDate.getDate() + 1);
          const dateKey = formatDateKey(targetDate);
          if (allDaysData[dateKey] && hasDailySalesData(allDaysData[dateKey])) {
            actualData = {
              revenue: allDaysData[dateKey].total?.revenue || 0,
              profit: allDaysData[dateKey].total?.netProfit || 0,
              units: allDaysData[dateKey].total?.units || 0,
            };
          }
        } else if (pred.period === 'week') {
          // Find the week that ended after the prediction
          const sortedWeeks = Object.keys(allWeeksData).sort();
          const targetWeek = sortedWeeks.find(w => new Date(w) > predDate);
          if (targetWeek && allWeeksData[targetWeek]) {
            actualData = {
              revenue: allWeeksData[targetWeek].total?.revenue || 0,
              profit: allWeeksData[targetWeek].total?.netProfit || 0,
              units: allWeeksData[targetWeek].total?.units || 0,
            };
          }
        }
        
        if (actualData) {
          return {
            ...pred,
            actual: actualData,
            accuracy: {
              revenueError: pred.prediction?.revenue?.expected ? 
                ((actualData.revenue - pred.prediction.revenue.expected) / pred.prediction.revenue.expected * 100) : null,
              profitError: pred.prediction?.profit?.expected ?
                ((actualData.profit - pred.prediction.profit.expected) / pred.prediction.profit.expected * 100) : null,
            },
          };
        }
      }
      return pred;
    });
    
    // Only update if something changed
    const hasUpdates = updatedPredictions.some((pred, i) => 
      pred.actual !== undefined && aiLearningHistory.predictions[i]?.actual === undefined
    );
    
    if (hasUpdates) {
      setAiLearningHistory(prev => ({ ...prev, predictions: updatedPredictions }));
    }
  }, [aiLearningHistory, allDaysData, allWeeksData]);
  
  // Auto-update learning when data changes
  useEffect(() => {
    updateAILearning();
  }, [allDaysData, allWeeksData]);
  
  // ============ END MODULAR AI FORECAST SYSTEM ============

  // 7. BREAK-EVEN CALCULATOR
  const calculateBreakEven = (adSpend, cogs, price, conversionRate) => {
    if (!price || price <= cogs) return null;
    const profitPerUnit = price - cogs;
    const unitsToBreakEven = Math.ceil(adSpend / profitPerUnit);
    const clicksNeeded = conversionRate > 0 ? Math.ceil(unitsToBreakEven / (conversionRate / 100)) : 0;
    const revenueAtBreakEven = unitsToBreakEven * price;
    const roasAtBreakEven = adSpend > 0 ? revenueAtBreakEven / adSpend : 0;
    return { unitsToBreakEven, clicksNeeded, revenueAtBreakEven, roasAtBreakEven, profitPerUnit };
  };

  // 10. CSV EXPORT functions
  const exportToCSV = (data, filename, headers) => {
    const csvContent = [
      headers.join(','),
      ...data.map(row => headers.map(h => {
        const val = row[h] ?? '';
        return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
      }).join(','))
    ].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  };

  const exportWeeklyDataCSV = () => {
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const data = sortedWeeks.map(w => {
      const d = allWeeksData[w];
      return {
        'Week Ending': w,
        'Total Revenue': d.total?.revenue?.toFixed(2) || 0,
        'Total Profit': d.total?.netProfit?.toFixed(2) || 0,
        'Total Units': d.total?.units || 0,
        'Amazon Revenue': d.amazon?.revenue?.toFixed(2) || 0,
        'Amazon Profit': d.amazon?.netProfit?.toFixed(2) || 0,
        'Shopify Revenue': d.shopify?.revenue?.toFixed(2) || 0,
        'Shopify Profit': d.shopify?.netProfit?.toFixed(2) || 0,
        'Total Ad Spend': d.total?.adSpend?.toFixed(2) || 0,
        'Notes': weekNotes[w] || '',
      };
    });
    exportToCSV(data, 'weekly_sales', ['Week Ending', 'Total Revenue', 'Total Profit', 'Total Units', 'Amazon Revenue', 'Amazon Profit', 'Shopify Revenue', 'Shopify Profit', 'Total Ad Spend', 'Notes']);
  };

  const exportSKUDataCSV = () => {
    const skuMap = {};
    // Include weekly data (primarily 2026)
    Object.entries(allWeeksData).forEach(([week, data]) => {
      [...(data.amazon?.skuData || []), ...(data.shopify?.skuData || [])].forEach(s => {
        if (!skuMap[s.sku]) skuMap[s.sku] = { sku: s.sku, name: savedProductNames[s.sku] || s.name || '', totalUnits: 0, totalRevenue: 0, totalProfit: 0, periods: 0 };
        skuMap[s.sku].totalUnits += s.unitsSold || 0;
        skuMap[s.sku].totalRevenue += s.netSales || 0;
        skuMap[s.sku].totalProfit += s.netProceeds || (s.netSales || 0) - (s.cogs || 0);
        skuMap[s.sku].periods += 1;
      });
    });
    // Include period data (2024 quarterly, 2025 monthly)
    Object.entries(allPeriodsData).forEach(([period, data]) => {
      // Skip yearly totals to avoid double-counting
      if (/^\d{4}$/.test(period)) return;
      [...(data.amazon?.skuData || []), ...(data.shopify?.skuData || [])].forEach(s => {
        if (!skuMap[s.sku]) skuMap[s.sku] = { sku: s.sku, name: savedProductNames[s.sku] || s.name || '', totalUnits: 0, totalRevenue: 0, totalProfit: 0, periods: 0 };
        skuMap[s.sku].totalUnits += s.unitsSold || 0;
        skuMap[s.sku].totalRevenue += s.netSales || 0;
        skuMap[s.sku].totalProfit += s.netProceeds || (s.netSales || 0) - (s.cogs || 0);
        skuMap[s.sku].periods += 1;
      });
    });
    const data = Object.values(skuMap).map(s => ({
      'SKU': s.sku,
      'Product Name': s.name,
      'Total Units': s.totalUnits,
      'Total Revenue': s.totalRevenue.toFixed(2),
      'Total Profit': s.totalProfit.toFixed(2),
      'Periods Active': s.periods,
      'Avg Units/Period': (s.totalUnits / s.periods).toFixed(1),
    }));
    exportToCSV(data, 'sku_performance', ['SKU', 'Product Name', 'Total Units', 'Total Revenue', 'Total Profit', 'Periods Active', 'Avg Units/Period']);
  };

  const exportInventoryCSV = () => {
    const latestDate = Object.keys(invHistory).sort().pop();
    if (!latestDate) return;
    const inv = invHistory[latestDate];
    const data = [...(inv.fba || []), ...(inv.threepl || [])].map(i => ({
      'SKU': i.sku,
      'Location': i.source || 'Unknown',
      'Units': i.quantity || i.units || 0,
      'COGS': savedCogs[i.sku] || 0,
      'Value': ((i.quantity || i.units || 0) * (savedCogs[i.sku] || 0)).toFixed(2),
    }));
    exportToCSV(data, 'inventory', ['SKU', 'Location', 'Units', 'COGS', 'Value']);
  };

  // UI Components
  const FileBox = ({ type, label, desc, req, isInv }) => {
    const fs = isInv ? invFiles : files, fn = isInv ? invFileNames : fileNames;
    const isMulti3PL = type === 'threepl' && !isInv;
    const hasFile = isMulti3PL ? (fs.threepl?.length > 0) : fs[type];
    const displayName = isMulti3PL ? (fn.threepl?.length > 0 ? `${fn.threepl.length} file(s)` : '') : fn[type];
    const acceptTypes = type === 'threepl' ? '.csv,.xlsx,.xls' : '.csv';
    
    return (
      <div className={`relative border-2 border-dashed rounded-xl p-4 ${hasFile ? 'border-emerald-400 bg-emerald-950/30' : 'border-slate-600 hover:border-slate-400 bg-slate-800/30'}`}>
        <input type="file" accept={acceptTypes} onChange={(e) => handleFile(type, e.target.files[0], isInv)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${hasFile ? 'bg-emerald-500' : 'bg-slate-700'}`}>
            {hasFile ? <Check className="w-5 h-5 text-white" /> : <FileSpreadsheet className="w-5 h-5 text-slate-300" />}
          </div>
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2"><span className="font-medium text-white text-sm">{label}</span>{req && <span className="text-xs text-rose-400">*</span>}{isMulti3PL && <span className="text-xs text-cyan-400">(multi)</span>}</div>
            {hasFile ? (
              <div className="flex items-center gap-2">
                <p className="text-xs text-emerald-400 truncate">{displayName}</p>
                {isMulti3PL && fn.threepl?.length > 0 && (
                  <button onClick={(e) => { e.stopPropagation(); clear3PLFiles(); }} className="text-xs text-rose-400 hover:text-rose-300">Clear</button>
                )}
              </div>
            ) : <p className="text-xs text-slate-500">{desc}</p>}
          </div>
        </div>
        {isMulti3PL && fn.threepl?.length > 0 && (
          <div className="mt-2 text-xs text-slate-400">
            {fn.threepl.map((name, i) => <div key={i} className="truncate">â€¢ {name}</div>)}
          </div>
        )}
      </div>
    );
  };

  // Period FileBox with multi-3PL support
  const PeriodFileBox = ({ type, label, desc, req }) => {
    const isMulti3PL = type === 'threepl';
    const hasFile = isMulti3PL ? (periodFiles.threepl?.length > 0) : periodFiles[type];
    const displayName = isMulti3PL ? (periodFileNames.threepl?.length > 0 ? `${periodFileNames.threepl.length} file(s)` : '') : periodFileNames[type];
    const acceptTypes = type === 'threepl' ? '.csv,.xlsx,.xls' : '.csv';
    
    return (
      <div className={`relative border-2 border-dashed rounded-xl p-4 ${hasFile ? 'border-emerald-400 bg-emerald-950/30' : 'border-slate-600 hover:border-slate-400 bg-slate-800/30'}`}>
        <input type="file" accept={acceptTypes} onChange={(e) => handlePeriodFile(type, e.target.files[0])} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${hasFile ? 'bg-emerald-500' : 'bg-slate-700'}`}>
            {hasFile ? <Check className="w-5 h-5 text-white" /> : <FileSpreadsheet className="w-5 h-5 text-slate-300" />}
          </div>
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2"><span className="font-medium text-white text-sm">{label}</span>{req && <span className="text-xs text-rose-400">*</span>}{isMulti3PL && <span className="text-xs text-cyan-400">(multi)</span>}</div>
            {hasFile ? (
              <div className="flex items-center gap-2">
                <p className="text-xs text-emerald-400 truncate">{displayName}</p>
                {isMulti3PL && periodFileNames.threepl?.length > 0 && (
                  <button onClick={(e) => { e.stopPropagation(); clearPeriod3PLFiles(); }} className="text-xs text-rose-400 hover:text-rose-300">Clear</button>
                )}
              </div>
            ) : <p className="text-xs text-slate-500">{desc}</p>}
          </div>
        </div>
        {isMulti3PL && periodFileNames.threepl?.length > 0 && (
          <div className="mt-2 text-xs text-slate-400">
            {periodFileNames.threepl.map((name, i) => <div key={i} className="truncate">â€¢ {name}</div>)}
          </div>
        )}
      </div>
    );
  };

  const MetricCard = ({ label, value, sub, icon: Icon, color = 'slate' }) => {
    const colors = { emerald: 'from-emerald-500/20 to-emerald-600/5 border-emerald-500/30', blue: 'from-blue-500/20 to-blue-600/5 border-blue-500/30', amber: 'from-amber-500/20 to-amber-600/5 border-amber-500/30', rose: 'from-rose-500/20 to-rose-600/5 border-rose-500/30', violet: 'from-violet-500/20 to-violet-600/5 border-violet-500/30', orange: 'from-orange-500/20 to-orange-600/5 border-orange-500/30', cyan: 'from-cyan-500/20 to-cyan-600/5 border-cyan-500/30' };
    const iconC = { emerald: 'text-emerald-400', blue: 'text-blue-400', amber: 'text-amber-400', rose: 'text-rose-400', violet: 'text-violet-400', orange: 'text-orange-400', cyan: 'text-cyan-400' };
    return (
      <div className={`bg-gradient-to-br ${colors[color] || colors.emerald} border rounded-2xl p-5`}>
        <div className="flex items-start justify-between mb-3"><span className="text-slate-400 text-sm font-medium">{label}</span>{Icon && <Icon className={`w-5 h-5 ${iconC[color] || iconC.emerald}`} />}</div>
        <div className="text-2xl font-bold text-white mb-1">{value}</div>
        {sub && <div className="text-sm text-slate-400">{sub}</div>}
      </div>
    );
  };

  const ChannelCard = ({ title, color, data, isAmz, showSkuTable = false }) => {
    const [expanded, setExpanded] = useState(false);
    const [show3plBreakdown, setShow3plBreakdown] = useState(false);
    const [skuSort, setSkuSort] = useState({ field: 'netSales', dir: 'desc' });
    const skuDataRaw = data.skuData || [];
    const threeplBreakdown = data.threeplBreakdown || {};
    const has3plData = !isAmz && (data.threeplCosts > 0);
    const has3plBreakdown = has3plData && Object.values(threeplBreakdown).some(v => v > 0);
    
    // Add calculated fields and sort
    const skuData = useMemo(() => {
      const withCalcs = skuDataRaw.map(item => {
        // Amazon: netProceeds IS the profit (already has COGS, fees, and ad spend deducted)
        // Shopify: netSales already has discounts deducted, subtract COGS
        const profit = isAmz 
          ? (item.netProceeds || 0)
          : (item.netSales || 0) - (item.cogs || 0);
        // For $/Unit: Amazon uses proceeds (the profit), Shopify uses netSales
        const proceedsPerUnit = item.unitsSold > 0 
          ? (isAmz ? item.netProceeds : item.netSales) / item.unitsSold 
          : 0;
        return { ...item, profit, proceedsPerUnit };
      });
      return withCalcs.sort((a, b) => {
        const aVal = a[skuSort.field] || 0;
        const bVal = b[skuSort.field] || 0;
        return skuSort.dir === 'desc' ? bVal - aVal : aVal - bVal;
      });
    }, [skuDataRaw, skuSort, isAmz]);
    
    const handleSort = (field) => {
      setSkuSort(prev => ({ field, dir: prev.field === field && prev.dir === 'desc' ? 'asc' : 'desc' }));
    };
    
    const SortHeader = ({ field, label, align = 'right' }) => (
      <th 
        onClick={() => handleSort(field)}
        className={`text-${align} text-xs font-medium text-slate-400 uppercase px-2 py-2 cursor-pointer hover:text-white transition-all ${skuSort.field === field ? 'text-violet-400' : ''}`}
      >
        {label} {skuSort.field === field && (skuSort.dir === 'desc' ? 'â†“' : 'â†‘')}
      </th>
    );
    
    return (
      <div className="bg-slate-800/50 rounded-2xl border border-slate-700 overflow-hidden">
        <div className={`border-l-4 ${color === 'orange' ? 'border-orange-500' : 'border-blue-500'} p-5`}>
          <h3 className={`text-lg font-bold ${color === 'orange' ? 'text-orange-400' : 'text-blue-400'} mb-4`}>{title}</h3>
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div><p className="text-slate-500 text-xs uppercase mb-1">Revenue</p><p className="text-xl font-bold text-white">{formatCurrency(data.revenue)}</p></div>
            <div><p className="text-slate-500 text-xs uppercase mb-1">Units</p><p className="text-xl font-bold text-white">{formatNumber(data.units)}</p></div>
            <div><p className="text-slate-500 text-xs uppercase mb-1">Net Profit</p><p className={`text-xl font-bold ${data.netProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(data.netProfit)}</p></div>
            <div><p className="text-slate-500 text-xs uppercase mb-1">Margin</p><p className={`text-xl font-bold ${(isAmz ? data.margin : data.netMargin) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatPercent(isAmz ? data.margin : data.netMargin)}</p></div>
          </div>
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div><p className="text-slate-500 text-xs uppercase mb-1">COGS</p><p className="text-lg font-semibold text-white">{formatCurrency(data.cogs)}</p></div>
            <div>
              <p className="text-slate-500 text-xs uppercase mb-1">{isAmz ? 'Fees' : '3PL Costs'}</p>
              <p className="text-lg font-semibold text-white">{formatCurrency(isAmz ? data.fees : data.threeplCosts)}</p>
              {has3plData && <button onClick={() => setShow3plBreakdown(!show3plBreakdown)} className="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1"><Truck className="w-3 h-3" />{show3plBreakdown ? 'Hide Details' : 'View Details'}</button>}
              {!isAmz && data.threeplMetrics?.isProrated && <span className="text-xs text-amber-400">~estimated</span>}
            </div>
            <div><p className="text-slate-500 text-xs uppercase mb-1">Ad Spend</p><p className="text-lg font-semibold text-white">{formatCurrency(data.adSpend)}</p></div>
            <div><p className="text-slate-500 text-xs uppercase mb-1">TACOS</p><p className="text-lg font-semibold text-white">{(data.roas || 0).toFixed(2)}x</p></div>
          </div>
          {/* 3PL Breakdown */}
          {show3plBreakdown && has3plData && (
            <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
              <h4 className="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2"><Truck className="w-4 h-4 text-blue-400" />3PL Cost Breakdown</h4>
              {has3plBreakdown ? (
                <>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                    {threeplBreakdown.shipping > 0 && <div className="flex justify-between"><span className="text-slate-400 text-sm">Shipping</span><span className="text-white text-sm">{formatCurrency(threeplBreakdown.shipping)}</span></div>}
                    {threeplBreakdown.pickFees > 0 && <div className="flex justify-between"><span className="text-slate-400 text-sm">Pick Fees</span><span className="text-white text-sm">{formatCurrency(threeplBreakdown.pickFees)}</span></div>}
                    {threeplBreakdown.storage > 0 && <div className="flex justify-between"><span className="text-slate-400 text-sm">Storage</span><span className="text-white text-sm">{formatCurrency(threeplBreakdown.storage)}</span></div>}
                    {threeplBreakdown.boxCharges > 0 && <div className="flex justify-between"><span className="text-slate-400 text-sm">Box/Mailer</span><span className="text-white text-sm">{formatCurrency(threeplBreakdown.boxCharges)}</span></div>}
                    {threeplBreakdown.receiving > 0 && <div className="flex justify-between"><span className="text-slate-400 text-sm">Receiving</span><span className="text-white text-sm">{formatCurrency(threeplBreakdown.receiving)}</span></div>}
                    {threeplBreakdown.other > 0 && <div className="flex justify-between"><span className="text-slate-400 text-sm">Other</span><span className="text-white text-sm">{formatCurrency(threeplBreakdown.other)}</span></div>}
                  </div>
                  {/* Enhanced 3PL Metrics */}
                  {data.threeplMetrics && data.threeplMetrics.orderCount > 0 ? (
                    <div className="border-t border-slate-700 pt-3 mt-3">
                      <h5 className="text-xs font-semibold text-cyan-400 uppercase mb-2">ðŸ“¦ Order Metrics</h5>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div className="bg-slate-800/50 rounded-lg p-2">
                          <p className="text-slate-500 text-xs">Orders</p>
                          <p className="text-white font-semibold">{formatNumber(data.threeplMetrics.orderCount)}</p>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-2">
                          <p className="text-slate-500 text-xs">Units Picked</p>
                          <p className="text-white font-semibold">{formatNumber(data.threeplMetrics.totalUnits)}</p>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-2">
                          <p className="text-slate-500 text-xs">Avg Units/Order</p>
                          <p className="text-white font-semibold">{data.threeplMetrics.avgUnitsPerOrder.toFixed(1)}</p>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-2">
                          <p className="text-slate-500 text-xs">Avg Ship Cost</p>
                          <p className="text-white font-semibold">{formatCurrency(data.threeplMetrics.avgShippingCost)}</p>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-2">
                          <p className="text-slate-500 text-xs">Avg Pick Cost</p>
                          <p className="text-white font-semibold">{formatCurrency(data.threeplMetrics.avgPickCost)}</p>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-2">
                          <p className="text-slate-500 text-xs">Avg Packaging</p>
                          <p className="text-white font-semibold">{formatCurrency(data.threeplMetrics.avgPackagingCost)}</p>
                        </div>
                        <div className="bg-cyan-900/30 rounded-lg p-2 border border-cyan-500/30">
                          <p className="text-cyan-400 text-xs font-medium">Avg Cost/Order</p>
                          <p className="text-cyan-300 font-bold">{formatCurrency(data.threeplMetrics.avgCostPerOrder)}</p>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-2">
                          <p className="text-slate-500 text-xs">Storage</p>
                          <p className="text-white font-semibold">{formatCurrency(threeplBreakdown.storage)}</p>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="border-t border-slate-700 pt-3 mt-3">
                      <div className="bg-amber-900/20 border border-amber-500/30 rounded-lg p-3">
                        <p className="text-amber-400 text-sm font-medium">ðŸ“Š Order metrics not available</p>
                        <p className="text-slate-400 text-xs mt-1">To see orders, avg cost/order, and other metrics:</p>
                        <ul className="text-slate-500 text-xs mt-1 list-disc list-inside">
                          <li>Re-process this data with a 3PL CSV that includes "Count Total" column</li>
                          <li>Make sure your 3PL file has "First Pick Fee" rows (used to count orders)</li>
                        </ul>
                      </div>
                    </div>
                  )}
                </>
              ) : (
                <p className="text-slate-500 text-sm">No breakdown available. Re-process this data with a 3PL CSV to see the breakdown.</p>
              )}
            </div>
          )}
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div><p className="text-slate-500 text-xs uppercase mb-1">AOV</p><p className="text-lg font-semibold text-white">{formatCurrency(data.aov)}</p></div>
            {isAmz ? (
              <>
                <div><p className="text-slate-500 text-xs uppercase mb-1">Returns</p><p className="text-lg font-semibold text-white">{formatNumber(data.returns || 0)}</p></div>
                <div><p className="text-slate-500 text-xs uppercase mb-1">Return Rate</p><p className="text-lg font-semibold text-white">{formatPercent(data.returnRate || 0)}</p></div>
              </>
            ) : (
              <>
                <div><p className="text-slate-500 text-xs uppercase mb-1">Meta Ads</p><p className="text-lg font-semibold text-white">{formatCurrency(data.metaSpend || 0)}</p></div>
                <div><p className="text-slate-500 text-xs uppercase mb-1">Google Ads</p><p className="text-lg font-semibold text-white">{formatCurrency(data.googleSpend || 0)}</p></div>
              </>
            )}
            <div><p className="text-slate-500 text-xs uppercase mb-1">{isAmz ? 'COGS/Unit' : 'Discounts'}</p><p className="text-lg font-semibold text-white">{isAmz ? formatCurrency(data.units > 0 ? data.cogs / data.units : 0) : formatCurrency(data.discounts || 0)}</p></div>
          </div>
          {showSkuTable && (
            <div className="mt-4 pt-4 border-t border-slate-700">
              <button onClick={() => setExpanded(!expanded)} className="flex items-center gap-2 text-sm text-slate-400 hover:text-white mb-3">
                <ChevronRight className={`w-4 h-4 transition-transform ${expanded ? 'rotate-90' : ''}`} />
                SKU Details ({skuData.length} products)
              </button>
              {expanded && (
                skuData.length > 0 ? (
                  <div className="overflow-x-auto max-h-64 overflow-y-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-900/50 sticky top-0">
                        <tr>
                          <th className="text-left text-xs font-medium text-slate-400 uppercase px-2 py-2">SKU</th>
                          <SortHeader field="unitsSold" label="Units" />
                          <SortHeader field="netSales" label="Sales" />
                          {isAmz && <SortHeader field="netProceeds" label="Proceeds" />}
                          {isAmz && <SortHeader field="adSpend" label="Ad Spend" />}
                          {isAmz && <SortHeader field="returns" label="Returns" />}
                          {!isAmz && <SortHeader field="discounts" label="Discounts" />}
                          <SortHeader field="cogs" label="COGS" />
                          <SortHeader field="profit" label="Profit" />
                          <SortHeader field="proceedsPerUnit" label="$/Unit" />
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-700/50">
                        {skuData.map((item, i) => (
                          <tr key={item.sku + i} className="hover:bg-slate-700/30">
                            <td className="px-2 py-2"><div className="max-w-[200px] truncate text-white" title={item.name}>{item.sku}</div></td>
                            <td className="text-right px-2 py-2 text-white">{formatNumber(item.unitsSold)}</td>
                            <td className="text-right px-2 py-2 text-white">{formatCurrency(item.netSales)}</td>
                            {isAmz && <td className="text-right px-2 py-2 text-emerald-400">{formatCurrency(item.netProceeds)}</td>}
                            {isAmz && <td className="text-right px-2 py-2 text-violet-400">{formatCurrency(item.adSpend)}</td>}
                            {isAmz && <td className="text-right px-2 py-2 text-rose-400">{formatNumber(item.returns)}</td>}
                            {!isAmz && <td className="text-right px-2 py-2 text-amber-400">{formatCurrency(item.discounts)}</td>}
                            <td className="text-right px-2 py-2 text-slate-400">{formatCurrency(item.cogs)}</td>
                            <td className={`text-right px-2 py-2 font-medium ${item.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(item.profit)}</td>
                            <td className={`text-right px-2 py-2 font-medium ${item.proceedsPerUnit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(item.proceedsPerUnit)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="bg-slate-900/50 rounded-lg p-4 text-center">
                    <p className="text-slate-400 text-sm">No SKU data available for this week.</p>
                    <p className="text-slate-500 text-xs mt-1">Re-upload your sales files to capture SKU-level detail.</p>
                  </div>
                )
              )}
            </div>
          )}
        </div>
      </div>
    );
  };

  const HealthBadge = ({ health }) => {
    const s = { critical: 'bg-rose-500/20 text-rose-400', low: 'bg-amber-500/20 text-amber-400', healthy: 'bg-emerald-500/20 text-emerald-400', overstock: 'bg-violet-500/20 text-violet-400', unknown: 'bg-slate-500/20 text-slate-400' };
    return <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${s[health] || s.unknown}`}>{health || 'â€”'}</span>;
  };

  // Reusable Goals Progress Card with Trend Analysis
  const GoalsCard = ({ weekRevenue = 0, weekProfit = 0, monthRevenue = 0, monthProfit = 0, monthLabel = '' }) => {
    const hasGoals = goals.weeklyRevenue > 0 || goals.weeklyProfit > 0 || goals.monthlyRevenue > 0 || goals.monthlyProfit > 0;
    if (!hasGoals) return null;
    
    // Calculate trend data
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const recentWeeks = sortedWeeks.slice(-8); // Last 8 weeks for trend
    const weeklyRevenues = recentWeeks.map(w => allWeeksData[w]?.total?.revenue || 0);
    const weeklyProfits = recentWeeks.map(w => allWeeksData[w]?.total?.netProfit || 0);
    
    // Simple linear regression for trend
    const calcTrend = (data) => {
      if (data.length < 3) return { slope: 0, projected: data[data.length - 1] || 0, trend: 'stable' };
      const n = data.length;
      const sumX = data.reduce((s, _, i) => s + i, 0);
      const sumY = data.reduce((s, v) => s + v, 0);
      const sumXY = data.reduce((s, v, i) => s + i * v, 0);
      const sumX2 = data.reduce((s, _, i) => s + i * i, 0);
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      const projected = slope * n + intercept; // Project next period
      const avgChange = slope / (sumY / n) * 100; // % change per period
      return { 
        slope, 
        projected, 
        avgChange,
        trend: avgChange > 2 ? 'up' : avgChange < -2 ? 'down' : 'stable'
      };
    };
    
    const revenueTrend = calcTrend(weeklyRevenues);
    const profitTrend = calcTrend(weeklyProfits);
    
    // Calculate monthly projection (4 weeks)
    const projectedMonthlyRevenue = revenueTrend.projected * 4;
    const projectedMonthlyProfit = profitTrend.projected * 4;
    
    const ProgressBar = ({ current, target, label, projected, trendDir }) => {
      if (!target || target <= 0) return null;
      const pct = Math.min((current / target) * 100, 100);
      const hit = current >= target;
      const projectedPct = projected ? Math.min((projected / target) * 100, 150) : null;
      const willHit = projected >= target;
      const diff = current - target;
      const projectedDiff = projected ? projected - target : null;
      
      return (
        <div className="mb-4">
          <div className="flex justify-between text-sm mb-1">
            <span className="text-slate-400">{label}</span>
            <span className="text-white">{formatCurrency(current)} / {formatCurrency(target)}</span>
          </div>
          <div className="h-2.5 bg-slate-700 rounded-full overflow-hidden relative">
            <div className={`h-full transition-all ${hit ? 'bg-emerald-500' : 'bg-amber-500'}`} style={{ width: `${pct}%` }} />
            {projectedPct && (
              <div 
                className={`absolute top-0 h-full w-1 ${willHit ? 'bg-emerald-300' : 'bg-rose-400'}`} 
                style={{ left: `${Math.min(projectedPct, 100)}%` }}
                title={`Projected: ${formatCurrency(projected)}`}
              />
            )}
          </div>
          <div className="flex justify-between items-center mt-1">
            <p className={`text-xs ${hit ? 'text-emerald-400' : 'text-amber-400'}`}>
              {pct.toFixed(0)}% {hit ? 'ðŸŽ‰' : ''} 
              <span className="text-slate-500 ml-1">
                ({diff >= 0 ? '+' : ''}{formatCurrency(diff)})
              </span>
            </p>
            {projected && recentWeeks.length >= 3 && (
              <p className={`text-xs flex items-center gap-1 ${willHit ? 'text-emerald-400' : 'text-rose-400'}`}>
                {trendDir === 'up' ? <TrendingUp className="w-3 h-3" /> : trendDir === 'down' ? <TrendingDown className="w-3 h-3" /> : <Minus className="w-3 h-3" />}
                Trend: {willHit ? 'On track' : `${formatCurrency(Math.abs(projectedDiff))} short`}
              </p>
            )}
          </div>
        </div>
      );
    };
    
    return (
      <div className="bg-gradient-to-br from-amber-900/20 to-slate-800/50 rounded-xl border border-amber-500/30 p-4 mb-6">
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-amber-400 font-semibold flex items-center gap-2"><Target className="w-4 h-4" />Goals Progress</h3>
          <button onClick={() => setShowGoalsModal(true)} className="text-xs text-slate-400 hover:text-white">Edit</button>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {goals.weeklyRevenue > 0 && (
            <ProgressBar 
              current={weekRevenue} 
              target={goals.weeklyRevenue} 
              label="Weekly Revenue" 
              projected={revenueTrend.projected}
              trendDir={revenueTrend.trend}
            />
          )}
          {goals.weeklyProfit > 0 && (
            <ProgressBar 
              current={weekProfit} 
              target={goals.weeklyProfit} 
              label="Weekly Profit" 
              projected={profitTrend.projected}
              trendDir={profitTrend.trend}
            />
          )}
          {goals.monthlyRevenue > 0 && (
            <ProgressBar 
              current={monthRevenue} 
              target={goals.monthlyRevenue} 
              label={monthLabel ? `${monthLabel} Revenue` : 'Monthly Revenue'} 
              projected={projectedMonthlyRevenue}
              trendDir={revenueTrend.trend}
            />
          )}
          {goals.monthlyProfit > 0 && (
            <ProgressBar 
              current={monthProfit} 
              target={goals.monthlyProfit} 
              label={monthLabel ? `${monthLabel} Profit` : 'Monthly Profit'} 
              projected={projectedMonthlyProfit}
              trendDir={profitTrend.trend}
            />
          )}
        </div>
        {recentWeeks.length >= 3 && (
          <div className="mt-3 pt-3 border-t border-slate-700/50">
            <p className="text-xs text-slate-400">
              ðŸ“ˆ Trend based on last {recentWeeks.length} weeks | 
              Revenue: <span className={revenueTrend.trend === 'up' ? 'text-emerald-400' : revenueTrend.trend === 'down' ? 'text-rose-400' : 'text-slate-300'}>
                {revenueTrend.avgChange > 0 ? '+' : ''}{revenueTrend.avgChange.toFixed(1)}%/wk
              </span> | 
              Profit: <span className={profitTrend.trend === 'up' ? 'text-emerald-400' : profitTrend.trend === 'down' ? 'text-rose-400' : 'text-slate-300'}>
                {profitTrend.avgChange > 0 ? '+' : ''}{profitTrend.avgChange.toFixed(1)}%/wk
              </span>
            </p>
          </div>
        )}
      </div>
    );
  };

  const NavTabs = () => (
    <div className="flex flex-wrap gap-2 mb-6 p-1.5 bg-slate-800/50 rounded-xl">
      {/* Main Navigation */}
      <button onClick={() => setView('dashboard')} className={`px-3 py-2 rounded-lg text-sm font-medium ${view === 'dashboard' ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><BarChart3 className="w-4 h-4 inline mr-1" />Dashboard</button>
      <button onClick={() => setView('upload')} className={`px-3 py-2 rounded-lg text-sm font-medium ${view === 'upload' || view === 'period-upload' || view === 'inv-upload' ? 'bg-violet-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Upload className="w-4 h-4 inline mr-1" />Upload</button>
      
      <div className="w-px bg-slate-600 mx-1" />
      
      {/* Data Views */}
      {appSettings.modulesEnabled?.dailyTracking !== false && (
        <button onClick={() => { const d = Object.keys(allDaysData).filter(k => hasDailySalesData(allDaysData[k])).sort().reverse(); if (d.length) { setSelectedDay(d[0]); setView('daily'); }}} disabled={!Object.keys(allDaysData).filter(k => hasDailySalesData(allDaysData[k])).length} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === 'daily' ? 'bg-cyan-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Sun className="w-4 h-4 inline mr-1" />Days</button>
      )}
      {appSettings.modulesEnabled?.weeklyTracking !== false && (
        <button onClick={() => { const w = Object.keys(allWeeksData).sort().reverse(); if (w.length) { setSelectedWeek(w[0]); setView('weekly'); }}} disabled={!Object.keys(allWeeksData).length} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === 'weekly' ? 'bg-violet-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Calendar className="w-4 h-4 inline mr-1" />Weeks</button>
      )}
      {appSettings.modulesEnabled?.periodTracking !== false && (
        <button onClick={() => { const p = Object.keys(allPeriodsData).sort().reverse(); if (p.length) { setSelectedPeriod(p[0]); setView('period-view'); }}} disabled={!Object.keys(allPeriodsData).length} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === 'period-view' ? 'bg-teal-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><CalendarRange className="w-4 h-4 inline mr-1" />Periods</button>
      )}
      {appSettings.modulesEnabled?.inventory !== false && (
        <button onClick={() => { if (Object.keys(invHistory).length) { const d = Object.keys(invHistory).sort().reverse()[0]; setSelectedInvDate(d); setView('inventory'); } else { setUploadTab('inventory'); setView('upload'); }}} className={`px-3 py-2 rounded-lg text-sm font-medium ${view === 'inventory' ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Boxes className="w-4 h-4 inline mr-1" />Inventory</button>
      )}
      
      <div className="w-px bg-slate-600 mx-1" />
      
      {/* Analytics */}
      {appSettings.modulesEnabled?.trends !== false && (
        <button onClick={() => setView('trends')} disabled={Object.keys(allWeeksData).length < 2} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === 'trends' ? 'bg-cyan-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><TrendingUp className="w-4 h-4 inline mr-1" />Trends</button>
      )}
      <button onClick={() => setView('forecast')} className={`px-3 py-2 rounded-lg text-sm font-medium ${view === 'forecast' ? 'bg-purple-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Brain className="w-4 h-4 inline mr-1" />Forecast</button>
      <button onClick={() => setView('analytics')} disabled={Object.keys(allWeeksData).length < 1} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === 'analytics' ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><BarChart3 className="w-4 h-4 inline mr-1" />Analytics</button>
      {appSettings.modulesEnabled?.yoy !== false && (
        <button onClick={() => setView('yoy')} disabled={Object.keys(allWeeksData).length < 2 && Object.keys(allPeriodsData).length < 2} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === 'yoy' ? 'bg-amber-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><GitCompare className="w-4 h-4 inline mr-1" />YoY</button>
      )}
      {appSettings.modulesEnabled?.skus !== false && (
        <button onClick={() => setView('skus')} disabled={Object.keys(allWeeksData).length < 1 && Object.keys(allPeriodsData).length < 1} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === 'skus' ? 'bg-pink-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Trophy className="w-4 h-4 inline mr-1" />SKUs</button>
      )}
      {appSettings.modulesEnabled?.profitability !== false && (
        <button onClick={() => setView('profitability')} disabled={Object.keys(allWeeksData).length < 1 && Object.keys(allPeriodsData).length < 1} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === 'profitability' ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><PieChart className="w-4 h-4 inline mr-1" />Profit</button>
      )}
      {appSettings.modulesEnabled?.ads !== false && (
        <button onClick={() => setView('ads')} disabled={Object.keys(allWeeksData).length < 1 && Object.keys(allPeriodsData).length < 1} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === 'ads' ? 'bg-purple-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Zap className="w-4 h-4 inline mr-1" />Ads</button>
      )}
      {appSettings.modulesEnabled?.threepl !== false && (
        <button onClick={() => setView('3pl')} disabled={Object.keys(allWeeksData).length < 1 && Object.keys(allPeriodsData).length < 1} className={`px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 ${view === '3pl' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Truck className="w-4 h-4 inline mr-1" />3PL</button>
      )}
      <button onClick={() => setView('banking')} className={`px-3 py-2 rounded-lg text-sm font-medium ${view === 'banking' ? 'bg-green-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Landmark className="w-4 h-4 inline mr-1" />Banking{bankingData.lastUpload && new Date().toDateString() !== new Date(bankingData.lastUpload).toDateString() && <span className="ml-1 w-2 h-2 bg-amber-400 rounded-full inline-block animate-pulse" title="Banking data not uploaded today" />}</button>
      
      <div className="w-px bg-slate-600 mx-1" />
      
      {/* Compliance & Settings */}
      {appSettings.modulesEnabled?.salesTax !== false && (
        <button onClick={() => setView('sales-tax')} className={`px-3 py-2 rounded-lg text-sm font-medium ${view === 'sales-tax' ? 'bg-rose-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><DollarSign className="w-4 h-4 inline mr-1" />Sales Tax</button>
      )}
      <button onClick={() => setView('settings')} className={`px-3 py-2 rounded-lg text-sm font-medium ${view === 'settings' ? 'bg-slate-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}><Settings className="w-4 h-4 inline mr-1" />Settings</button>
    </div>
  );

  const dataBar = useMemo(() => (
    <div className="flex flex-wrap items-center gap-3 mb-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
      {/* Store Selector */}
      {session && stores.length > 0 && (
        <button 
          onClick={() => setShowStoreSelector(true)}
          className="flex items-center gap-2 px-3 py-1.5 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/50 rounded-lg text-sm text-violet-300"
        >
          <Store className="w-4 h-4" />
          <span className="max-w-[120px] truncate">{stores.find(s => s.id === activeStoreId)?.name || storeName || 'My Store'}</span>
          <ChevronRight className="w-3 h-3" />
        </button>
      )}
      <div className="flex items-center gap-2 text-slate-400 text-sm"><Database className="w-4 h-4" /><span>{Object.keys(allDaysData).length} days | {Object.keys(allWeeksData).length} weeks | {Object.keys(allPeriodsData).length} periods</span></div>
      
      {/* Forecast Status Indicators */}
      <div className="flex items-center gap-1.5 px-2 py-1 bg-slate-900/50 rounded-lg border border-slate-700">
        <Target className="w-3 h-3 text-amber-400" />
        {['7day', '30day', '60day'].map(type => {
          const status = dataStatus.forecastStatus[type];
          const label = type === '7day' ? '7d' : type === '30day' ? '30d' : '60d';
          return (
            <span key={type} className={`text-xs px-1.5 py-0.5 rounded ${
              status.status === 'active' ? 'bg-emerald-500/20 text-emerald-400' :
              status.status === 'expiring' ? 'bg-amber-500/20 text-amber-400' :
              status.status === 'expired' ? 'bg-rose-500/20 text-rose-400' :
              'bg-slate-700 text-slate-500'
            }`} title={status.status === 'active' ? `${status.daysUntilExpiry} days left` : status.status}>
              {label}
            </span>
          );
        })}
      </div>
      
      <div className="flex items-center gap-2">
        {Object.keys(savedCogs).length > 0 ? <span className="text-emerald-400 text-xs flex items-center gap-1"><Check className="w-3 h-3" />{Object.keys(savedCogs).length} SKUs</span> : <span className="text-amber-400 text-xs">No COGS</span>}
        <button onClick={() => setShowCogsManager(true)} className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs text-white flex items-center gap-1"><Settings className="w-3 h-3" />COGS</button>
        <button onClick={() => setShowProductCatalog(true)} className="px-2 py-1 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/50 rounded text-xs text-violet-300 flex items-center gap-1"><Package className="w-3 h-3" />Catalog{Object.keys(savedProductNames).length > 0 && <span className="text-violet-400">âœ“</span>}</button>
      </div>
      <button onClick={() => setShowGoalsModal(true)} className="px-2 py-1 bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 rounded text-xs text-amber-300 flex items-center gap-1"><Target className="w-3 h-3" />Goals</button>
      <div className="flex items-center gap-2">
        <span className="text-slate-400 text-sm">Store:</span>
        <input 
          key={`store-name-${activeStoreId || 'default'}`}
          defaultValue={storeName} 
          onBlur={(e) => {
            if (e.target.value !== storeName) {
              setStoreName(e.target.value);
            }
          }}
          onKeyDown={(e) => {
            if (e.key === 'Enter') {
              e.target.blur();
            }
          }}
          placeholder="Your brand name"
          className="bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-sm text-white w-44" />
      </div>
      <div className="flex-1" />
      <button onClick={exportAll} className="flex items-center gap-2 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white"><Download className="w-4 h-4" />Export</button>
      <label className="flex items-center gap-2 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white cursor-pointer"><Upload className="w-4 h-4" />Import<input type="file" accept=".json" onChange={(e) => e.target.files[0] && importData(e.target.files[0])} className="hidden" /></label>
    </div>
  ), [allWeeksData, allDaysData, allPeriodsData, savedCogs, savedProductNames, storeName, isLocked, cloudStatus, session, stores, activeStoreId, dataStatus]);

  // Toast notification component
  const Toast = () => {
    useEffect(() => {
      if (toast) {
        // Longer timeout for warnings with undo actions
        const duration = toast.action ? 10000 : 3000;
        const timer = setTimeout(() => setToast(null), duration);
        return () => clearTimeout(timer);
      }
    }, [toast]);
    
    if (showSaveConfirm) {
      return <div className="fixed bottom-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50"><Check className="w-4 h-4" />Saved!</div>;
    }
    
    if (toast) {
      const bgColor = toast.type === 'error' ? 'bg-rose-600' : 
                      toast.type === 'warning' ? 'bg-amber-600' : 'bg-emerald-600';
      const Icon = toast.type === 'error' ? AlertTriangle : 
                   toast.type === 'warning' ? Trash2 : Check;
      
      return (
        <div className={`fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 z-50 ${bgColor} text-white`}>
          <Icon className="w-4 h-4 flex-shrink-0" />
          <span>{toast.message}</span>
          {toast.action && (
            <button 
              onClick={() => {
                toast.action.onClick();
                setToast(null);
              }}
              className="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-colors"
            >
              {toast.action.label}
            </button>
          )}
        </div>
      );
    }
    
    return null;
  };

  // Day Details Modal - shows detailed breakdown for a specific day
  const [editingDayAdSpend, setEditingDayAdSpend] = useState(false);
  const [dayAdSpendEdit, setDayAdSpendEdit] = useState({ meta: '', google: '' });
  
  const DayDetailsModal = () => {
    if (!viewingDayDetails) return null;
    
    const dayData = allDaysData[viewingDayDetails];
    if (!dayData) {
      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setViewingDayDetails(null)}>
          <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-lg w-full" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-white">
                {new Date(viewingDayDetails + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
              </h2>
              <button onClick={() => setViewingDayDetails(null)} className="text-slate-400 hover:text-white"><X className="w-5 h-5" /></button>
            </div>
            <p className="text-slate-400">No data available for this day.</p>
          </div>
        </div>
      );
    }
    
    const amazon = dayData.amazon || {};
    const shopify = dayData.shopify || {};
    const total = dayData.total || {};
    const hasAmazon = dayData.amazon && (amazon.revenue > 0 || amazon.units > 0);
    const hasShopify = dayData.shopify && (shopify.revenue > 0 || shopify.units > 0);
    
    // Calculate channel share percentages
    const totalRevenue = (amazon.revenue || 0) + (shopify.revenue || 0);
    const amazonShare = totalRevenue > 0 ? ((amazon.revenue || 0) / totalRevenue) * 100 : 0;
    const shopifyShare = totalRevenue > 0 ? ((shopify.revenue || 0) / totalRevenue) * 100 : 0;
    
    // Calculate Shopify COGS from skuData if not stored
    let shopifyCogs = shopify.cogs || 0;
    if (shopifyCogs === 0 && shopify.skuData) {
      shopifyCogs = (shopify.skuData || []).reduce((sum, sku) => {
        const skuKey = sku.sku || sku.title || '';
        const unitCost = savedCogs[skuKey] || savedCogs[sku.title] || 0;
        return sum + (unitCost * (sku.unitsSold || sku.units || 0));
      }, 0);
    }
    
    // Calculate totals for display
    const amazonCogs = amazon.cogs || 0;
    const amazonFees = amazon.fees || 0;
    const amazonAdSpend = amazon.adSpend || 0;
    const shopifyAdSpend = (shopify.metaSpend || 0) + (shopify.googleSpend || 0) + (shopify.adSpend || 0);
    const shopifyFees = shopify.fees || shopify.transactionFees || 0;
    const shopifyShipping = shopify.shipping || 0;
    
    // Save ad spend edits
    const saveAdSpendEdit = () => {
      const metaSpend = parseFloat(dayAdSpendEdit.meta) || 0;
      const googleSpend = parseFloat(dayAdSpendEdit.google) || 0;
      
      // Calculate new Shopify profit with updated ad spend
      const oldMetaSpend = shopify.metaSpend || 0;
      const oldGoogleSpend = shopify.googleSpend || 0;
      const adSpendDiff = (metaSpend + googleSpend) - (oldMetaSpend + oldGoogleSpend);
      
      const updatedShopify = {
        ...shopify,
        metaSpend,
        googleSpend,
        adSpend: metaSpend + googleSpend,
        netProfit: (shopify.netProfit || 0) - adSpendDiff,
        netMargin: shopify.revenue > 0 ? (((shopify.netProfit || 0) - adSpendDiff) / shopify.revenue) * 100 : 0,
        roas: (metaSpend + googleSpend) > 0 ? (shopify.revenue || 0) / (metaSpend + googleSpend) : 0,
      };
      
      // Update total
      const newTotalAdSpend = (amazon.adSpend || 0) + metaSpend + googleSpend;
      const newTotalProfit = (total.netProfit || 0) - adSpendDiff;
      const newTotalRevenue = total.revenue || 0;
      
      const updatedTotal = {
        ...total,
        adSpend: newTotalAdSpend,
        netProfit: newTotalProfit,
        netMargin: newTotalRevenue > 0 ? (newTotalProfit / newTotalRevenue) * 100 : 0,
        roas: newTotalAdSpend > 0 ? newTotalRevenue / newTotalAdSpend : 0,
      };
      
      const updatedDayData = {
        ...dayData,
        shopify: updatedShopify,
        total: updatedTotal,
        lastEdited: new Date().toISOString(),
      };
      
      const updatedDays = { ...allDaysData, [viewingDayDetails]: updatedDayData };
      setAllDaysData(updatedDays);
      lsSet('ecommerce_daily_sales_v1', JSON.stringify(updatedDays));
      queueCloudSave({ ...combinedData, dailySales: updatedDays });
      
      setEditingDayAdSpend(false);
      setToast({ message: 'Ad spend updated!', type: 'success' });
    };
    
    // Start editing
    const startEditingAdSpend = () => {
      setDayAdSpendEdit({
        meta: (shopify.metaSpend || 0).toString(),
        google: (shopify.googleSpend || 0).toString(),
      });
      setEditingDayAdSpend(true);
    };
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-start justify-center z-50 p-2 sm:p-4 overflow-y-auto" onClick={() => { setViewingDayDetails(null); setEditingDayAdSpend(false); }}>
        <div className="bg-slate-800 rounded-xl sm:rounded-2xl border border-slate-700 p-4 sm:p-6 max-w-4xl w-full my-2 sm:my-4 max-h-[calc(100vh-1rem)] sm:max-h-[calc(100vh-2rem)] overflow-y-auto" onClick={e => e.stopPropagation()}>
          {/* Header */}
          <div className="flex items-start justify-between mb-4 sm:mb-6 gap-2">
            <div className="min-w-0 flex-1">
              <h2 className="text-base sm:text-xl font-bold text-white leading-tight">
                {new Date(viewingDayDetails + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}
              </h2>
              <p className="text-slate-400 text-xs sm:text-sm">Daily Performance Details</p>
            </div>
            <button onClick={() => { setViewingDayDetails(null); setEditingDayAdSpend(false); }} className="text-slate-400 hover:text-white p-2 hover:bg-slate-700 rounded-lg flex-shrink-0"><X className="w-5 h-5" /></button>
          </div>
          
          {/* Edit Ad Spend Section */}
          {editingDayAdSpend && (
            <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-3 sm:p-4 mb-4 sm:mb-6">
              <h3 className="text-amber-300 font-semibold mb-3 flex items-center gap-2 text-sm sm:text-base">
                <DollarSign className="w-4 h-4" /> Edit Ad Spend
              </h3>
              <div className="grid grid-cols-2 gap-3 sm:gap-4 mb-3 sm:mb-4">
                <div>
                  <label className="block text-xs sm:text-sm text-slate-300 mb-1">Meta ($)</label>
                  <input 
                    type="number" 
                    step="0.01"
                    id="day-ad-spend-meta"
                    defaultValue={dayAdSpendEdit.meta}
                    className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
                    placeholder="0.00"
                  />
                </div>
                <div>
                  <label className="block text-xs sm:text-sm text-slate-300 mb-1">Google ($)</label>
                  <input 
                    type="number" 
                    step="0.01"
                    id="day-ad-spend-google"
                    defaultValue={dayAdSpendEdit.google}
                    className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
                    placeholder="0.00"
                  />
                </div>
              </div>
              <div className="flex gap-2">
                <button 
                  onClick={() => {
                    const meta = document.getElementById('day-ad-spend-meta')?.value || '0';
                    const google = document.getElementById('day-ad-spend-google')?.value || '0';
                    setDayAdSpendEdit({ meta, google });
                    setTimeout(saveAdSpendEdit, 10);
                  }}
                  className="px-3 sm:px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm font-medium"
                >
                  Save
                </button>
                <button 
                  onClick={() => setEditingDayAdSpend(false)}
                  className="px-3 sm:px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-sm"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}
          
          {/* Summary Cards */}
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 mb-4 sm:mb-6">
            <div className="bg-slate-900/50 rounded-lg sm:rounded-xl p-3 sm:p-4">
              <p className="text-slate-400 text-[10px] sm:text-xs mb-0.5 sm:mb-1">Revenue</p>
              <p className="text-base sm:text-xl font-bold text-white">{formatCurrency(totalRevenue)}</p>
            </div>
            <div className="bg-slate-900/50 rounded-lg sm:rounded-xl p-3 sm:p-4">
              <p className="text-slate-400 text-[10px] sm:text-xs mb-0.5 sm:mb-1">Profit</p>
              {(() => {
                // Calculate total profit properly
                const totalCogs = amazonCogs + shopifyCogs;
                const totalFees = amazonFees + shopifyFees;
                const totalAds = amazonAdSpend + shopifyAdSpend;
                const calcTotalProfit = total.netProfit || (totalRevenue - totalCogs - totalFees - shopifyShipping - totalAds);
                return <p className={`text-base sm:text-xl font-bold ${calcTotalProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(calcTotalProfit)}</p>;
              })()}
            </div>
            <div className="bg-slate-900/50 rounded-lg sm:rounded-xl p-3 sm:p-4">
              <p className="text-slate-400 text-[10px] sm:text-xs mb-0.5 sm:mb-1">Units</p>
              <p className="text-base sm:text-xl font-bold text-white">{formatNumber((amazon.units || 0) + (shopify.units || 0))}</p>
            </div>
            <div className="bg-slate-900/50 rounded-lg sm:rounded-xl p-3 sm:p-4">
              <p className="text-slate-400 text-[10px] sm:text-xs mb-0.5 sm:mb-1">Margin</p>
              {(() => {
                const totalCogs = amazonCogs + shopifyCogs;
                const totalFees = amazonFees + shopifyFees;
                const totalAds = amazonAdSpend + shopifyAdSpend;
                const calcTotalProfit = total.netProfit || (totalRevenue - totalCogs - totalFees - shopifyShipping - totalAds);
                const calcMargin = totalRevenue > 0 ? (calcTotalProfit / totalRevenue) * 100 : 0;
                return <p className={`text-base sm:text-xl font-bold ${calcMargin >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatPercent(calcMargin)}</p>;
              })()}
            </div>
          </div>
          
          {/* Channel Breakdown */}
          <div className="grid grid-cols-1 gap-4 sm:gap-6 mb-4 sm:mb-6">
            {/* Amazon */}
            <div className={`rounded-lg sm:rounded-xl border p-3 sm:p-4 ${hasAmazon ? 'bg-orange-900/20 border-orange-500/30' : 'bg-slate-900/30 border-slate-700'}`}>
              <h3 className="text-base sm:text-lg font-semibold text-orange-400 mb-2 sm:mb-3 flex items-center gap-2 flex-wrap">
                <Store className="w-4 h-4 sm:w-5 sm:h-5" /> Amazon
                {hasAmazon && <span className="text-[10px] sm:text-xs bg-orange-500/20 px-2 py-0.5 rounded">{formatPercent(amazonShare)}</span>}
              </h3>
              {hasAmazon ? (
                <div className="space-y-1.5 sm:space-y-2 text-sm">
                  <div className="flex justify-between"><span className="text-slate-400">Revenue</span><span className="text-white font-medium">{formatCurrency(amazon.revenue || 0)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-400">Units</span><span className="text-white font-medium">{formatNumber(amazon.units || 0)}</span></div>
                  <div className="border-t border-orange-500/20 pt-1.5 mt-1.5">
                    <div className="flex justify-between text-slate-500"><span>COGS</span><span className="text-rose-400/70">-{formatCurrency(amazonCogs)}</span></div>
                    <div className="flex justify-between text-slate-500"><span>Amazon Fees</span><span className="text-rose-400/70">-{formatCurrency(amazonFees)}</span></div>
                    <div className="flex justify-between text-slate-500"><span>Ad Spend</span><span className="text-amber-400">-{formatCurrency(amazonAdSpend)}</span></div>
                  </div>
                  <div className="border-t border-orange-500/30 pt-2 mt-2">
                    <div className="flex justify-between"><span className="text-slate-300 font-medium">Net Profit</span><span className={`font-bold ${(amazon.netProfit || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(amazon.netProfit || 0)}</span></div>
                    <div className="flex justify-between"><span className="text-slate-400">Margin</span><span className={`font-medium ${(amazon.netMargin || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatPercent(amazon.netMargin || (amazon.revenue > 0 ? (amazon.netProfit / amazon.revenue) * 100 : 0))}</span></div>
                    {amazonAdSpend > 0 && <div className="flex justify-between"><span className="text-slate-400">ROAS</span><span className="text-cyan-400 font-medium">{(amazon.revenue / amazonAdSpend).toFixed(2)}x</span></div>}
                  </div>
                </div>
              ) : (
                <p className="text-slate-500 text-sm">No Amazon sales this day</p>
              )}
            </div>
            
            {/* Shopify */}
            <div className={`rounded-lg sm:rounded-xl border p-3 sm:p-4 ${hasShopify ? 'bg-green-900/20 border-green-500/30' : 'bg-slate-900/30 border-slate-700'}`}>
              <h3 className="text-base sm:text-lg font-semibold text-green-400 mb-2 sm:mb-3 flex items-center gap-2 flex-wrap">
                <ShoppingBag className="w-4 h-4 sm:w-5 sm:h-5" /> Shopify
                {hasShopify && <span className="text-[10px] sm:text-xs bg-green-500/20 px-2 py-0.5 rounded">{formatPercent(shopifyShare)}</span>}
              </h3>
              {hasShopify ? (
                <div className="space-y-1.5 sm:space-y-2 text-sm">
                  <div className="flex justify-between"><span className="text-slate-400">Revenue</span><span className="text-white font-medium">{formatCurrency(shopify.revenue || 0)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-400">Units</span><span className="text-white font-medium">{formatNumber(shopify.units || 0)}</span></div>
                  <div className="border-t border-green-500/20 pt-1.5 mt-1.5">
                    {shopifyCogs > 0 && <div className="flex justify-between text-slate-500"><span>COGS</span><span className="text-rose-400/70">-{formatCurrency(shopifyCogs)}</span></div>}
                    {shopifyFees > 0 && <div className="flex justify-between text-slate-500"><span>Transaction Fees</span><span className="text-rose-400/70">-{formatCurrency(shopifyFees)}</span></div>}
                    {shopifyShipping > 0 && <div className="flex justify-between text-slate-500"><span>Shipping</span><span className="text-rose-400/70">-{formatCurrency(shopifyShipping)}</span></div>}
                    {(shopify.metaSpend || 0) > 0 && <div className="flex justify-between text-slate-500"><span>Meta Ads</span><span className="text-amber-400">-{formatCurrency(shopify.metaSpend || 0)}</span></div>}
                    {(shopify.googleSpend || 0) > 0 && <div className="flex justify-between text-slate-500"><span>Google Ads</span><span className="text-amber-400">-{formatCurrency(shopify.googleSpend || 0)}</span></div>}
                    {shopifyAdSpend === 0 && shopifyCogs === 0 && shopifyFees === 0 && shopifyShipping === 0 && (
                      <div className="text-slate-500 text-xs italic">No costs tracked yet</div>
                    )}
                  </div>
                  <div className="border-t border-green-500/30 pt-2 mt-2">
                    {(() => {
                      // Calculate net profit if not stored
                      const calcProfit = shopify.netProfit || (shopify.revenue - shopifyCogs - shopifyFees - shopifyShipping - shopifyAdSpend);
                      const calcMargin = shopify.revenue > 0 ? (calcProfit / shopify.revenue) * 100 : 0;
                      return (
                        <>
                          <div className="flex justify-between"><span className="text-slate-300 font-medium">Net Profit</span><span className={`font-bold ${calcProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(calcProfit)}</span></div>
                          <div className="flex justify-between"><span className="text-slate-400">Margin</span><span className={`font-medium ${calcMargin >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatPercent(calcMargin)}</span></div>
                          {shopifyAdSpend > 0 && <div className="flex justify-between"><span className="text-slate-400">ROAS</span><span className="text-cyan-400 font-medium">{(shopify.revenue / shopifyAdSpend).toFixed(2)}x</span></div>}
                        </>
                      );
                    })()}
                  </div>
                </div>
              ) : (
                <p className="text-slate-500 text-sm">No Shopify sales this day</p>
              )}
            </div>
          </div>
          
          {/* Google Ads data if present */}
          {(dayData.googleAds || dayData.googleSpend || dayData.googleImpressions || shopify.googleSpend || shopify.adsMetrics?.googleImpressions) && (
            <div className="bg-red-900/20 border border-red-500/30 rounded-lg sm:rounded-xl p-3 sm:p-4 mb-4 sm:mb-6">
              <h3 className="text-base sm:text-lg font-semibold text-red-400 mb-2 sm:mb-3">Google Ads</h3>
              <div className="grid grid-cols-3 sm:grid-cols-6 gap-2 sm:gap-4 text-center">
                <div><p className="text-slate-400 text-[10px] sm:text-xs">Spend</p><p className="text-white text-sm font-medium">{formatCurrency(shopify.googleSpend || dayData.googleSpend || 0)}</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">Clicks</p><p className="text-white text-sm font-medium">{formatNumber(shopify.adsMetrics?.googleClicks || dayData.googleClicks || 0)}</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">Impr</p><p className="text-white text-sm font-medium">{formatNumber(shopify.adsMetrics?.googleImpressions || dayData.googleImpressions || 0)}</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">Conv</p><p className="text-white text-sm font-medium">{formatNumber(shopify.adsMetrics?.googleConversions || dayData.googleConversions || 0)}</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">CPC</p><p className="text-white text-sm font-medium">{formatCurrency(shopify.adsMetrics?.googleCPC || dayData.googleCpc || 0)}</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">CPA</p><p className="text-white text-sm font-medium">{formatCurrency(shopify.adsMetrics?.googleCostPerConv || dayData.googleCpa || 0)}</p></div>
              </div>
            </div>
          )}
          
          {/* Meta Ads data if present */}
          {(dayData.metaAds || dayData.metaSpend || dayData.metaImpressions || (shopify.adsMetrics?.metaImpressions)) && (
            <div className="bg-indigo-900/20 border border-indigo-500/30 rounded-lg sm:rounded-xl p-3 sm:p-4 mb-4 sm:mb-6">
              <h3 className="text-base sm:text-lg font-semibold text-indigo-400 mb-2 sm:mb-3">Meta Ads</h3>
              <div className="grid grid-cols-3 sm:grid-cols-6 gap-2 sm:gap-4 text-center">
                <div><p className="text-slate-400 text-[10px] sm:text-xs">Spend</p><p className="text-white text-sm font-medium">{formatCurrency(dayData.metaSpend || shopify.metaSpend || 0)}</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">Clicks</p><p className="text-white text-sm font-medium">{formatNumber(dayData.metaClicks || shopify.adsMetrics?.metaClicks || 0)}</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">Impr</p><p className="text-white text-sm font-medium">{formatNumber(dayData.metaImpressions || shopify.adsMetrics?.metaImpressions || 0)}</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">Purch</p><p className="text-white text-sm font-medium">{formatNumber(dayData.metaConversions || shopify.adsMetrics?.metaPurchases || 0)}</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">CTR</p><p className="text-white text-sm font-medium">{(dayData.metaCtr || shopify.adsMetrics?.metaCTR || 0).toFixed(1)}%</p></div>
                <div><p className="text-slate-400 text-[10px] sm:text-xs">CPC</p><p className="text-white text-sm font-medium">{formatCurrency(dayData.metaCpc || shopify.adsMetrics?.metaCPC || 0)}</p></div>
              </div>
            </div>
          )}
          
          {/* SKU Breakdown */}
          {((amazon.skuData && amazon.skuData.length > 0) || (shopify.skuData && shopify.skuData.length > 0)) && (
            <div className="bg-slate-900/50 rounded-lg sm:rounded-xl p-3 sm:p-4">
              <h3 className="text-base sm:text-lg font-semibold text-white mb-2 sm:mb-3">Top Products</h3>
              <div className="grid grid-cols-1 gap-3 sm:gap-4">
                {amazon.skuData && amazon.skuData.length > 0 && (
                  <div>
                    <p className="text-orange-400 text-xs sm:text-sm font-medium mb-1.5 sm:mb-2">Amazon</p>
                    <div className="space-y-1 max-h-32 sm:max-h-40 overflow-y-auto">
                      {amazon.skuData.slice(0, 5).map((sku, i) => (
                        <div key={i} className="flex justify-between text-xs sm:text-sm">
                          <span className="text-slate-300 truncate flex-1 mr-2">{savedProductNames[sku.sku] || sku.name || sku.sku}</span>
                          <span className="text-white flex-shrink-0">{formatCurrency(sku.netSales || 0)}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                {shopify.skuData && shopify.skuData.length > 0 && (
                  <div>
                    <p className="text-green-400 text-xs sm:text-sm font-medium mb-1.5 sm:mb-2">Shopify</p>
                    <div className="space-y-1 max-h-32 sm:max-h-40 overflow-y-auto">
                      {shopify.skuData.slice(0, 5).map((sku, i) => (
                        <div key={i} className="flex justify-between text-xs sm:text-sm">
                          <span className="text-slate-300 truncate flex-1 mr-2">{savedProductNames[sku.sku] || sku.name || sku.sku}</span>
                          <span className="text-white flex-shrink-0">{formatCurrency(sku.netSales || 0)}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
          
          {/* Footer */}
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mt-4 sm:mt-6 pt-3 sm:pt-4 border-t border-slate-700">
            <p className="text-slate-500 text-[10px] sm:text-xs order-2 sm:order-1">
              {dayData.createdAt && `${new Date(dayData.createdAt).toLocaleDateString()}`}
              {dayData.lastEdited && ` â€¢ Edited`}
            </p>
            <div className="flex gap-2 w-full sm:w-auto order-1 sm:order-2">
              {!editingDayAdSpend && hasDailySalesData(dayData) && (
                <button 
                  onClick={startEditingAdSpend}
                  className="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 rounded-lg text-amber-300 text-xs sm:text-sm flex items-center justify-center gap-1.5 sm:gap-2"
                >
                  <DollarSign className="w-3.5 h-3.5 sm:w-4 sm:h-4" /> <span className="hidden sm:inline">Edit </span>Ad Spend
                </button>
              )}
              <button onClick={() => { setViewingDayDetails(null); setEditingDayAdSpend(false); }} className="flex-1 sm:flex-none px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-sm">Close</button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const CogsManager = () => showCogsManager && (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
      <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full">
        <h2 className="text-xl font-bold text-white mb-4">Manage COGS</h2>
        {Object.keys(savedCogs).length > 0 ? (
          <div className="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-4 mb-4">
            <div className="flex items-center gap-2 text-emerald-400 mb-1"><Check className="w-5 h-5" /><span className="font-semibold">COGS Loaded</span></div>
            <p className="text-slate-300 text-sm">{Object.keys(savedCogs).length} SKUs</p>
            {cogsLastUpdated && <p className="text-slate-500 text-xs">Updated: {new Date(cogsLastUpdated).toLocaleDateString()}</p>}
          </div>
        ) : (
          <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4 mb-4">
            <p className="text-amber-400 font-semibold">No COGS Data</p>
            <p className="text-slate-300 text-sm">Upload a COGS file to enable profit calculations</p>
          </div>
        )}
        <div className="mb-4"><p className="text-slate-400 text-sm mb-2">Upload COGS file:</p><FileBox type="cogs" label="COGS File" desc="CSV with SKU and Cost Per Unit" /></div>
        <div className="flex gap-3">
          {files.cogs && <button onClick={processAndSaveCogs} className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-2 rounded-xl">Save COGS</button>}
          <button onClick={() => { setShowCogsManager(false); setFiles(p => ({ ...p, cogs: null })); setFileNames(p => ({ ...p, cogs: '' })); }} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-xl">{files.cogs ? 'Cancel' : 'Close'}</button>
        </div>
      </div>
    </div>
  );

  const GoalsModal = () => {
    if (!showGoalsModal) return null;
    
    const handleSave = () => {
      const weeklyRev = parseFloat(document.getElementById('goal-weekly-rev')?.value) || 0;
      const weeklyProf = parseFloat(document.getElementById('goal-weekly-prof')?.value) || 0;
      const monthlyRev = parseFloat(document.getElementById('goal-monthly-rev')?.value) || 0;
      const monthlyProf = parseFloat(document.getElementById('goal-monthly-prof')?.value) || 0;
      saveGoals({ weeklyRevenue: weeklyRev, weeklyProfit: weeklyProf, monthlyRevenue: monthlyRev, monthlyProfit: monthlyProf });
    };
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full">
          <h2 className="text-xl font-bold text-white mb-2 flex items-center gap-2"><Target className="w-6 h-6 text-amber-400" />Set Goals</h2>
          <p className="text-slate-400 text-sm mb-4">Set revenue and profit targets to track your progress</p>
          <div className="space-y-4">
            <div>
              <label className="block text-sm text-slate-300 mb-1">Weekly Revenue Target</label>
              <input type="number" id="goal-weekly-rev" defaultValue={goals.weeklyRevenue || ''} placeholder="e.g., 5000" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500" />
            </div>
            <div>
              <label className="block text-sm text-slate-300 mb-1">Weekly Profit Target</label>
              <input type="number" id="goal-weekly-prof" defaultValue={goals.weeklyProfit || ''} placeholder="e.g., 1500" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500" />
            </div>
            <div>
              <label className="block text-sm text-slate-300 mb-1">Monthly Revenue Target</label>
              <input type="number" id="goal-monthly-rev" defaultValue={goals.monthlyRevenue || ''} placeholder="e.g., 20000" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500" />
            </div>
            <div>
              <label className="block text-sm text-slate-300 mb-1">Monthly Profit Target</label>
              <input type="number" id="goal-monthly-prof" defaultValue={goals.monthlyProfit || ''} placeholder="e.g., 6000" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500" />
            </div>
          </div>
          <div className="flex gap-3 mt-6">
            <button onClick={handleSave} className="flex-1 bg-amber-600 hover:bg-amber-500 text-white font-semibold py-2 rounded-xl">Save Goals</button>
            <button onClick={() => setShowGoalsModal(false)} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-xl">Cancel</button>
          </div>
        </div>
      </div>
    );
  };

  // Product Catalog Modal - maps SKUs to product names for AI
  const ProductCatalogModal = () => {
    if (!showProductCatalog) return null;
    
    const handleFileUpload = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      setProductCatalogFileName(file.name);
      const reader = new FileReader();
      reader.onload = (evt) => {
        const text = evt.target.result;
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        if (lines.length < 2) return;
        
        // Parse CSV properly handling quoted fields with commas
        const parseCSVLine = (line) => {
          const result = [];
          let current = '';
          let inQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
              if (inQuotes && line[i + 1] === '"') {
                current += '"';
                i++; // Skip escaped quote
              } else {
                inQuotes = !inQuotes;
              }
            } else if (char === ',' && !inQuotes) {
              result.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          result.push(current.trim());
          return result;
        };
        
        const headers = parseCSVLine(lines[0]).map(h => h.replace(/"/g, '').trim().toLowerCase());
        const skuCol = headers.findIndex(h => h === 'sku');
        const nameCol = headers.findIndex(h => h.includes('product') || h === 'name');
        if (skuCol === -1 || nameCol === -1) {
          alert('CSV must have SKU and Product Name columns');
          return;
        }
        const catalog = {};
        for (let i = 1; i < lines.length; i++) {
          const cols = parseCSVLine(lines[i]);
          const sku = (cols[skuCol] || '').replace(/"/g, '').trim();
          const name = (cols[nameCol] || '').replace(/"/g, '').trim();
          if (sku && name) catalog[sku] = name;
        }
        setProductCatalogFile(catalog);
        setToast({ message: `Parsed ${Object.keys(catalog).length} products`, type: 'success' });
      };
      reader.readAsText(file);
    };
    
    const saveCatalog = () => {
      if (!productCatalogFile) return;
      setSavedProductNames(productCatalogFile);
      try { localStorage.setItem(PRODUCT_NAMES_KEY, JSON.stringify(productCatalogFile)); } catch(e) {}
      setShowProductCatalog(false);
      setProductCatalogFile(null);
      setProductCatalogFileName('');
    };
    
    // Get category summary
    const getCategorySummary = (names) => {
      const categories = {};
      Object.entries(names).forEach(([sku, name]) => {
        const nameLower = name.toLowerCase();
        let cat = 'Other';
        if (nameLower.includes('lip balm')) cat = 'Lip Balm';
        else if (nameLower.includes('deodorant') && nameLower.includes('sensitive')) cat = 'Sensitive Deodorant';
        else if (nameLower.includes('deodorant') && nameLower.includes('extra strength')) cat = 'Extra Strength Deodorant';
        else if (nameLower.includes('deodorant')) cat = 'Deodorant';
        else if (nameLower.includes('soap') && nameLower.includes('athlete')) cat = "Athlete's Shield";
        else if (nameLower.includes('soap')) cat = 'Tallow Soap';
        else if (nameLower.includes('sun balm')) cat = 'Sun Balm';
        else if (nameLower.includes('tallow balm')) cat = 'Tallow Balm';
        if (!categories[cat]) categories[cat] = 0;
        categories[cat]++;
      });
      return categories;
    };
    
    const currentCategories = getCategorySummary(savedProductNames);
    const previewCategories = productCatalogFile ? getCategorySummary(productCatalogFile) : null;
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
          <h2 className="text-xl font-bold text-white mb-2 flex items-center gap-2">
            <Package className="w-6 h-6 text-violet-400" />
            Product Catalog
          </h2>
          <p className="text-slate-400 text-sm mb-4">
            Map SKUs to product names so AI can answer questions like "How much lip balm did I sell?"
          </p>
          
          {/* Current catalog status */}
          {Object.keys(savedProductNames).length > 0 ? (
            <div className="bg-emerald-900/30 border border-emerald-500/30 rounded-xl p-4 mb-4">
              <div className="flex items-center gap-2 text-emerald-400 mb-2">
                <Check className="w-5 h-5" />
                <span className="font-semibold">{Object.keys(savedProductNames).length} Products Mapped</span>
              </div>
              <div className="flex flex-wrap gap-2">
                {Object.entries(currentCategories).map(([cat, count]) => (
                  <span key={cat} className="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">
                    {cat}: {count}
                  </span>
                ))}
              </div>
            </div>
          ) : (
            <div className="bg-amber-900/30 border border-amber-500/30 rounded-xl p-4 mb-4">
              <p className="text-amber-400 font-semibold">No Product Catalog</p>
              <p className="text-slate-400 text-sm">Upload a CSV with SKU and Product Name columns</p>
            </div>
          )}
          
          {/* File upload */}
          <div className="mb-4">
            <label className="block text-sm text-slate-300 mb-2">Upload Product Catalog CSV:</label>
            <input
              type="file"
              accept=".csv"
              onChange={handleFileUpload}
              className="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-violet-600 file:text-white file:cursor-pointer"
            />
            {productCatalogFileName && (
              <p className="text-violet-400 text-sm mt-2">ðŸ“„ {productCatalogFileName}</p>
            )}
          </div>
          
          {/* Preview */}
          {productCatalogFile && (
            <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
              <p className="text-white font-semibold mb-2">Preview: {Object.keys(productCatalogFile).length} products found</p>
              <div className="flex flex-wrap gap-2 mb-3">
                {Object.entries(previewCategories).map(([cat, count]) => (
                  <span key={cat} className="text-xs bg-violet-600/30 px-2 py-1 rounded text-violet-300">
                    {cat}: {count}
                  </span>
                ))}
              </div>
              <div className="max-h-32 overflow-y-auto text-xs space-y-1">
                {Object.entries(productCatalogFile).slice(0, 5).map(([sku, name]) => (
                  <div key={sku} className="flex gap-2">
                    <span className="text-slate-500 font-mono">{sku}</span>
                    <span className="text-slate-300 truncate">{name}</span>
                  </div>
                ))}
                {Object.keys(productCatalogFile).length > 5 && (
                  <p className="text-slate-500">...and {Object.keys(productCatalogFile).length - 5} more</p>
                )}
              </div>
            </div>
          )}
          
          <div className="flex gap-3">
            {productCatalogFile && (
              <button onClick={saveCatalog} className="flex-1 bg-violet-600 hover:bg-violet-500 text-white font-semibold py-2 rounded-xl">
                Save Catalog
              </button>
            )}
            <button 
              onClick={() => { setShowProductCatalog(false); setProductCatalogFile(null); setProductCatalogFileName(''); }} 
              className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-xl"
            >
              {productCatalogFile ? 'Cancel' : 'Close'}
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Upload Help Modal
  const UploadHelpModal = () => {
    if (!showUploadHelp) return null;
    
    const HelpSection = ({ icon, title, steps, color = 'violet' }) => (
      <div className={`bg-slate-900/50 rounded-xl p-4 border border-${color}-500/20`}>
        <h4 className={`text-${color}-400 font-semibold mb-3 flex items-center gap-2`}>
          {icon}
          {title}
        </h4>
        <ol className="space-y-2 text-sm text-slate-300">
          {steps.map((step, i) => (
            <li key={i} className="flex gap-2">
              <span className={`text-${color}-400 font-medium`}>{i + 1}.</span>
              <span>{step}</span>
            </li>
          ))}
        </ol>
      </div>
    );
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-white flex items-center gap-2">
              <FileText className="w-6 h-6 text-violet-400" />
              How to Upload Data
            </h2>
            <button onClick={() => setShowUploadHelp(false)} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
          
          <div className="space-y-4">
            <HelpSection 
              icon={<ShoppingCart className="w-5 h-5" />}
              title="Amazon Sales (SKU Economics Report)"
              color="orange"
              steps={[
                'Go to Seller Central â†’ Reports â†’ Business Reports â†’ SKU Economics',
                'Select your marketplace',
                'Set Data Aggregation to "MSKU"',
                'Select your desired date range',
                'Check ALL boxes under "Set Report Configurations"',
                'Important: Make sure COGS are entered in Amazon for accurate data',
                'Export as CSV'
              ]}
            />
            
            <HelpSection 
              icon={<ShoppingBag className="w-5 h-5" />}
              title="Shopify Sales"
              color="blue"
              steps={[
                'Go to Analytics â†’ Reports',
                'Find "Total sales by product variant SKU"',
                'Select your date range',
                'Export as CSV'
              ]}
            />
            
            <HelpSection 
              icon={<Boxes className="w-5 h-5" />}
              title="Amazon Inventory (FBA)"
              color="emerald"
              steps={[
                'Go to Inventory â†’ FBA Inventory',
                'Click "Reports"',
                'Select "Inventory Report"',
                'Download as CSV'
              ]}
            />
            
            <HelpSection 
              icon={<Truck className="w-5 h-5" />}
              title="3PL Inventory (Packiyo)"
              color="amber"
              steps={[
                'Go to Inventory â†’ Products',
                'Click Export',
                'Convert Excel file to CSV format'
              ]}
            />
            
            <HelpSection 
              icon={<DollarSign className="w-5 h-5" />}
              title="3PL Charges"
              color="rose"
              steps={[
                'Create or export a CSV with your weekly 3PL charges',
                'Include columns for charge types and amounts',
                'Upload to track fulfillment costs'
              ]}
            />
          </div>
          
          <div className="mt-6 pt-4 border-t border-slate-700">
            <button 
              onClick={() => setShowUploadHelp(false)} 
              className="w-full bg-violet-600 hover:bg-violet-500 text-white font-semibold py-2 rounded-xl"
            >
              Got It!
            </button>
          </div>
        </div>
      </div>
    );
  };

  // FORECAST MODAL (Feature 5)
  const ForecastModal = () => {
    if (!showForecast || !generateForecast) return null;
    const f = enhancedForecast || generateForecast;
    
    const sourceLabels = {
      'weekly': 'Weekly trend analysis (4+ weeks)',
      'weekly-amazon': 'Weekly avg + Amazon forecast',
      'weekly-avg': 'Weekly averages',
      'period': 'Period averages (historical)',
    };
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-white flex items-center gap-2">
              <TrendingUp className="w-6 h-6 text-emerald-400" />
              Revenue Forecast
              {f.corrected && <span className="text-xs bg-purple-500/30 text-purple-300 px-2 py-0.5 rounded ml-2">AI-Enhanced</span>}
            </h2>
            <button onClick={() => setShowForecast(false)} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
          
          {/* AI Learning Status */}
          {enhancedForecast && (
            <div className={`rounded-xl p-3 mb-4 ${enhancedForecast.corrected ? 'bg-purple-900/30 border border-purple-500/30' : 'bg-slate-700/30 border border-slate-600'}`}>
              <div className="flex items-center gap-2">
                <Brain className={`w-4 h-4 ${enhancedForecast.corrected ? 'text-purple-400' : 'text-slate-400'}`} />
                <span className={`text-sm font-medium ${enhancedForecast.corrected ? 'text-purple-300' : 'text-slate-300'}`}>
                  Self-Learning: {enhancedForecast.corrected ? 'Active' : 'Training'}
                </span>
              </div>
              <p className="text-xs text-slate-400 mt-1">{enhancedForecast.correctionNote}</p>
            </div>
          )}
          
          <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
            <div className="flex items-center justify-between mb-2">
              <span className="text-slate-400">Data Source</span>
              <span className="text-white font-medium">{sourceLabels[generateForecast.source] || generateForecast.source}</span>
            </div>
            <div className="flex items-center justify-between mb-2">
              <span className="text-slate-400">Based on</span>
              <span className="text-white font-medium">
                {generateForecast.basedOn} {generateForecast.source === 'period' ? 'period(s)' : generateForecast.source === 'blended' ? 'week(s) + periods' : 'week(s)'}
              </span>
            </div>
            {generateForecast.amazonBlended && (
              <div className="mb-2 p-2 bg-orange-900/30 border border-orange-500/30 rounded-lg">
                <p className="text-orange-300 text-xs flex items-center gap-1">
                  <Target className="w-3 h-3" />
                  Using {generateForecast.amazonForecastCount || 0} Amazon forecast(s) for enhanced accuracy
                </p>
              </div>
            )}
            {!generateForecast.amazonBlended && Object.keys(amazonForecasts).length === 0 && (
              <div className="mb-2 p-2 bg-slate-700/50 border border-slate-600 rounded-lg">
                <p className="text-slate-400 text-xs flex items-center gap-1">
                  ðŸ’¡ Upload Amazon forecasts (7/30/60-day) from Seller Central to improve projections
                </p>
              </div>
            )}
            {generateForecast.note && (
              <div className="mb-2 p-2 bg-amber-900/30 border border-amber-500/30 rounded-lg">
                <p className="text-amber-300 text-xs">âš ï¸ {generateForecast.note}</p>
              </div>
            )}
            <div className="flex items-center justify-between mb-2">
              <span className="text-slate-400">Trend Direction</span>
              <span className={`font-medium flex items-center gap-1 ${f.trend.revenue === 'up' ? 'text-emerald-400' : f.trend.revenue === 'down' ? 'text-rose-400' : 'text-slate-400'}`}>
                {f.trend.revenue === 'up' ? <TrendingUp className="w-4 h-4" /> : f.trend.revenue === 'down' ? <TrendingDown className="w-4 h-4" /> : <Minus className="w-4 h-4" />}
                {f.trend.revenueChange > 0 ? '+' : ''}{f.trend.revenueChange.toFixed(1)}% per week
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-slate-400">Confidence</span>
              <span className={`font-medium ${parseFloat(f.confidence) > 70 ? 'text-emerald-400' : parseFloat(f.confidence) > 40 ? 'text-amber-400' : 'text-rose-400'}`}>{f.confidence}%</span>
            </div>
          </div>
          
          <h3 className="text-sm font-semibold text-slate-400 uppercase mb-3">Weekly Projections</h3>
          <div className="grid grid-cols-4 gap-3 mb-4">
            {f.weekly.map((w, i) => {
              const onWeeklyTarget = goals.weeklyRevenue > 0 ? w.revenue >= goals.weeklyRevenue : null;
              return (
                <div key={i} className={`rounded-xl p-3 text-center ${w.hasAmazonForecast ? 'bg-orange-900/20 border border-orange-500/30' : 'bg-slate-900/50'}`}>
                  <p className="text-slate-500 text-xs mb-1">{w.week}</p>
                  {w.hasAmazonForecast && <p className="text-orange-400 text-xs mb-1">ðŸ“Š Amazon</p>}
                  <p className="text-white font-bold">{formatCurrency(w.revenue)}</p>
                  <p className={`text-sm ${w.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(w.profit)}</p>
                  <p className="text-slate-500 text-xs">{formatNumber(w.units)} units</p>
                  {onWeeklyTarget !== null && (
                    <p className={`text-xs mt-1 ${onWeeklyTarget ? 'text-emerald-400' : 'text-amber-400'}`}>
                      {onWeeklyTarget ? 'âœ“ On target' : `${formatCurrency(goals.weeklyRevenue - w.revenue)} short`}
                    </p>
                  )}
                </div>
              );
            })}
          </div>
          
          {/* Weekly Goal Progress */}
          {goals.weeklyRevenue > 0 && (
            <div className="bg-slate-900/50 rounded-xl p-4 mb-4 border border-slate-700">
              <div className="flex items-center justify-between mb-2">
                <span className="text-slate-400 text-sm">Weekly Goal Progress (Avg Projection)</span>
                <span className={`font-medium ${f.weekly.reduce((s, w) => s + w.revenue, 0) / 4 >= goals.weeklyRevenue ? 'text-emerald-400' : 'text-amber-400'}`}>
                  {formatCurrency(f.weekly.reduce((s, w) => s + w.revenue, 0) / 4)} / {formatCurrency(goals.weeklyRevenue)}
                </span>
              </div>
              <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
                <div 
                  className={`h-full rounded-full transition-all ${f.weekly.reduce((s, w) => s + w.revenue, 0) / 4 >= goals.weeklyRevenue ? 'bg-emerald-500' : 'bg-amber-500'}`}
                  style={{ width: `${Math.min(100, (f.weekly.reduce((s, w) => s + w.revenue, 0) / 4 / goals.weeklyRevenue * 100))}%` }}
                />
              </div>
              <p className="text-xs text-slate-500 mt-2">
                {f.weekly.reduce((s, w) => s + w.revenue, 0) / 4 >= goals.weeklyRevenue 
                  ? `ðŸŽ¯ Projections exceed weekly goal by ${formatCurrency(f.weekly.reduce((s, w) => s + w.revenue, 0) / 4 - goals.weeklyRevenue)}`
                  : `âš ï¸ Projections are ${formatCurrency(goals.weeklyRevenue - f.weekly.reduce((s, w) => s + w.revenue, 0) / 4)} below weekly goal`
                }
              </p>
            </div>
          )}
          
          <div className="bg-gradient-to-r from-emerald-900/30 to-violet-900/30 rounded-xl p-4 border border-emerald-500/30">
            <h3 className="text-sm font-semibold text-emerald-400 uppercase mb-3">Next Month Projection</h3>
            <div className="grid grid-cols-3 gap-4 text-center">
              <div>
                <p className="text-slate-400 text-sm">Revenue</p>
                <p className="text-2xl font-bold text-white">{formatCurrency(f.monthly.revenue)}</p>
              </div>
              <div>
                <p className="text-slate-400 text-sm">Profit</p>
                <p className={`text-2xl font-bold ${f.monthly.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(f.monthly.profit)}</p>
              </div>
              <div>
                <p className="text-slate-400 text-sm">Units</p>
                <p className="text-2xl font-bold text-white">{formatNumber(f.monthly.units)}</p>
              </div>
            </div>
            {goals.monthlyRevenue > 0 && (
              <div className="mt-3 pt-3 border-t border-slate-700">
                <div className="flex justify-between text-sm">
                  <span className="text-slate-400">vs Monthly Goal</span>
                  <span className={f.monthly.revenue >= goals.monthlyRevenue ? 'text-emerald-400' : 'text-amber-400'}>
                    {f.monthly.revenue >= goals.monthlyRevenue ? 'âœ“ On track' : `${formatCurrency(goals.monthlyRevenue - f.monthly.revenue)} short`}
                  </span>
                </div>
              </div>
            )}
          </div>
          
          <p className="text-slate-500 text-xs mt-4 text-center">
            * Forecast based on {sourceLabels[f.source] || 'available data'}. Actual results may vary.
          </p>
        </div>
      </div>
    );
  };

  // BREAK-EVEN CALCULATOR (Feature 7)
  const BreakEvenModal = () => {
    if (!showBreakEven) return null;
    const result = calculateBreakEven(
      parseFloat(breakEvenInputs.adSpend) || 0,
      parseFloat(breakEvenInputs.cogs) || 0,
      parseFloat(breakEvenInputs.price) || 0,
      parseFloat(breakEvenInputs.conversionRate) || 2
    );
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-white flex items-center gap-2">
              <Calculator className="w-6 h-6 text-amber-400" />
              Break-Even Calculator
            </h2>
            <button onClick={() => setShowBreakEven(false)} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
          
          <div className="space-y-4 mb-6">
            <div>
              <label className="block text-sm text-slate-400 mb-1">Ad Spend ($)</label>
              <input type="number" id="be-adspend" defaultValue={breakEvenInputs.adSpend}
                onBlur={e => setBreakEvenInputs(p => ({...p, adSpend: e.target.value}))}
                className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="500" />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-1">COGS per Unit ($)</label>
              <input type="number" id="be-cogs" defaultValue={breakEvenInputs.cogs}
                onBlur={e => setBreakEvenInputs(p => ({...p, cogs: e.target.value}))}
                className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="5" />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-1">Selling Price ($)</label>
              <input type="number" id="be-price" defaultValue={breakEvenInputs.price}
                onBlur={e => setBreakEvenInputs(p => ({...p, price: e.target.value}))}
                className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="25" />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-1">Conversion Rate (%)</label>
              <input type="number" id="be-cvr" defaultValue={breakEvenInputs.conversionRate}
                onBlur={e => setBreakEvenInputs(p => ({...p, conversionRate: e.target.value}))}
                className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="2" />
            </div>
            <button onClick={() => {
              const adSpend = document.getElementById('be-adspend')?.value || '';
              const cogs = document.getElementById('be-cogs')?.value || '';
              const price = document.getElementById('be-price')?.value || '';
              const conversionRate = document.getElementById('be-cvr')?.value || '';
              setBreakEvenInputs({ adSpend, cogs, price, conversionRate });
            }} className="w-full py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-white font-semibold">
              Calculate
            </button>
          </div>
          
          {result && parseFloat(breakEvenInputs.price) > parseFloat(breakEvenInputs.cogs) ? (
            <div className="bg-slate-900/50 rounded-xl p-4 space-y-3">
              <div className="flex justify-between">
                <span className="text-slate-400">Profit per Unit</span>
                <span className="text-emerald-400 font-bold">{formatCurrency(result.profitPerUnit)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-slate-400">Units to Break Even</span>
                <span className="text-white font-bold">{result.unitsToBreakEven}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-slate-400">Clicks Needed (at {breakEvenInputs.conversionRate}% CVR)</span>
                <span className="text-white font-bold">{formatNumber(result.clicksNeeded)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-slate-400">Revenue at Break-Even</span>
                <span className="text-white font-bold">{formatCurrency(result.revenueAtBreakEven)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-slate-400">ROAS at Break-Even</span>
                <span className="text-amber-400 font-bold">{result.roasAtBreakEven.toFixed(2)}x</span>
              </div>
            </div>
          ) : parseFloat(breakEvenInputs.price) <= parseFloat(breakEvenInputs.cogs) && breakEvenInputs.price ? (
            <div className="bg-rose-900/30 border border-rose-500/50 rounded-xl p-4 text-center">
              <p className="text-rose-400">Price must be greater than COGS to make profit</p>
            </div>
          ) : (
            <div className="bg-slate-900/50 rounded-xl p-4 text-center text-slate-500">
              Enter values above to calculate break-even point
            </div>
          )}
        </div>
      </div>
    );
  };

  // CSV EXPORT MODAL (Feature 10)
  const ExportModal = () => {
    if (!showExportModal) return null;
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-white flex items-center gap-2">
              <FileDown className="w-6 h-6 text-emerald-400" />
              Export Data
            </h2>
            <button onClick={() => setShowExportModal(false)} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
          
          <div className="space-y-3">
            <button onClick={() => { exportWeeklyDataCSV(); setShowExportModal(false); }}
              className="w-full p-4 bg-slate-900/50 hover:bg-slate-700 border border-slate-600 rounded-xl text-left flex items-center gap-3">
              <Calendar className="w-6 h-6 text-violet-400" />
              <div>
                <p className="text-white font-medium">Weekly Sales Data</p>
                <p className="text-slate-400 text-sm">Revenue, profit, units by week</p>
              </div>
            </button>
            
            <button onClick={() => { exportSKUDataCSV(); setShowExportModal(false); }}
              className="w-full p-4 bg-slate-900/50 hover:bg-slate-700 border border-slate-600 rounded-xl text-left flex items-center gap-3">
              <Package className="w-6 h-6 text-pink-400" />
              <div>
                <p className="text-white font-medium">SKU Performance</p>
                <p className="text-slate-400 text-sm">All SKUs with totals and averages</p>
              </div>
            </button>
            
            <button onClick={() => { exportInventoryCSV(); setShowExportModal(false); }}
              disabled={Object.keys(invHistory).length === 0}
              className="w-full p-4 bg-slate-900/50 hover:bg-slate-700 border border-slate-600 rounded-xl text-left flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
              <Boxes className="w-6 h-6 text-amber-400" />
              <div>
                <p className="text-white font-medium">Inventory Snapshot</p>
                <p className="text-slate-400 text-sm">Current inventory with values</p>
              </div>
            </button>
            
            <button onClick={() => { exportAll(); setShowExportModal(false); }}
              className="w-full p-4 bg-slate-900/50 hover:bg-slate-700 border border-slate-600 rounded-xl text-left flex items-center gap-3">
              <Database className="w-6 h-6 text-emerald-400" />
              <div>
                <p className="text-white font-medium">Full Backup (JSON)</p>
                <p className="text-slate-400 text-sm">Complete data backup for restore</p>
              </div>
            </button>
          </div>
        </div>
      </div>
    );
  };

  // 3PL BULK UPLOAD MODAL
  const ThreePLBulkUploadModal = () => {
    const [dragActive, setDragActive] = useState(false);
    
    // Use Dashboard-level state for files, processing, results
    const selectedFiles = threeplSelectedFiles;
    const setSelectedFiles = setThreeplSelectedFiles;
    const processing = threeplProcessing;
    const setProcessing = setThreeplProcessing;
    const results = threeplResults;
    const setResults = setThreeplResults;
    
    if (!show3PLBulkUpload) return null;
    
    const handleDrag = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (e.type === 'dragenter' || e.type === 'dragover') setDragActive(true);
      else if (e.type === 'dragleave') setDragActive(false);
    };
    
    const handleDrop = (e) => {
      e.preventDefault();
      e.stopPropagation();
      setDragActive(false);
      
      const files = [...e.dataTransfer.files].filter(f => 
        f.name.endsWith('.xlsx') || f.name.endsWith('.xls') || f.name.endsWith('.csv')
      );
      setSelectedFiles(prev => [...prev, ...files]);
    };
    
    const handleFileSelect = (e) => {
      const files = [...e.target.files].filter(f => 
        f.name.endsWith('.xlsx') || f.name.endsWith('.xls') || f.name.endsWith('.csv')
      );
      setSelectedFiles(prev => [...prev, ...files]);
    };
    
    const removeFile = (idx) => {
      setSelectedFiles(prev => prev.filter((_, i) => i !== idx));
    };
    
    const processFiles = async () => {
      const totalFiles = selectedFiles.length;
      const processResults = [];
      let newOrders = { ...threeplLedger.orders };
      let newSummaryCharges = { ...threeplLedger.summaryCharges };
      let newImportedFiles = [...(threeplLedger.importedFiles || [])];
      let totalAdded = 0;
      let totalSkipped = 0;
      let weeksAffected = new Set();
      
      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        
        // Update progress
        setProcessing({ current: i + 1, total: totalFiles, fileName: file.name });
        
        try {
          const parsed = await parse3PLExcel(file);
          let fileAdded = 0;
          let fileSkipped = 0;
          
          // Process orders
          parsed.orders.forEach(order => {
            if (newOrders[order.uniqueKey]) {
              fileSkipped++;
            } else {
              newOrders[order.uniqueKey] = order;
              fileAdded++;
              weeksAffected.add(order.weekKey);
            }
          });
          
          // Process non-order charges (allocate to weeks based on file date range)
          if (parsed.dateRange.start && parsed.dateRange.end) {
            const startDate = new Date(parsed.dateRange.start);
            const endDate = new Date(parsed.dateRange.end);
            const numWeeks = Math.max(1, Math.ceil((endDate - startDate) / (7 * 24 * 60 * 60 * 1000)));
            
            parsed.nonOrderCharges.forEach((charge, idx) => {
              // Allocate charges proportionally across weeks in the range
              // For simplicity, assign to the end week
              const weekKey = getSunday(endDate);
              const chargeKey = `${file.name}-${charge.chargeType}-${idx}`;
              
              if (!newSummaryCharges[chargeKey]) {
                newSummaryCharges[chargeKey] = {
                  ...charge,
                  weekKey,
                  sourceFile: file.name,
                  dateRange: { start: parsed.dateRange.start, end: parsed.dateRange.end },
                };
                weeksAffected.add(weekKey);
              }
            });
          }
          
          newImportedFiles.push({
            name: file.name,
            importedAt: new Date().toISOString(),
            ordersAdded: fileAdded,
            dateRange: parsed.dateRange,
          });
          
          totalAdded += fileAdded;
          totalSkipped += fileSkipped;
          
          processResults.push({
            file: file.name,
            status: 'success',
            ordersAdded: fileAdded,
            ordersSkipped: fileSkipped,
            dateRange: parsed.dateRange,
            format: parsed.format,
          });
        } catch (err) {
          console.error('Error processing file:', file.name, err);
          processResults.push({
            file: file.name,
            status: 'error',
            error: err.message,
          });
        }
      }
      
      // Save updated ledger
      const newLedger = {
        orders: newOrders,
        summaryCharges: newSummaryCharges,
        importedFiles: newImportedFiles,
      };
      save3PLLedger(newLedger);
      
      // IMPORTANT: Update weekly data with new 3PL costs so profit calculations are accurate
      if (weeksAffected.size > 0) {
        const updatedWeeks = { ...allWeeksData };
        let weeksUpdated = 0;
        
        weeksAffected.forEach(weekKey => {
          if (updatedWeeks[weekKey]) {
            // Calculate 3PL costs from ledger for this week
            const ledger3PL = get3PLForWeek(newLedger, weekKey);
            const newThreeplCost = ledger3PL?.metrics?.totalCost || 0;
            const oldCost = updatedWeeks[weekKey].shopify?.threeplCosts || 0;
            
            if (newThreeplCost > 0 && newThreeplCost !== oldCost) {
              const shopProfit = (updatedWeeks[weekKey].shopify?.netProfit || 0) + oldCost - newThreeplCost;
              updatedWeeks[weekKey] = {
                ...updatedWeeks[weekKey],
                shopify: {
                  ...updatedWeeks[weekKey].shopify,
                  threeplCosts: newThreeplCost,
                  threeplBreakdown: ledger3PL?.breakdown || updatedWeeks[weekKey].shopify?.threeplBreakdown,
                  threeplMetrics: ledger3PL?.metrics || updatedWeeks[weekKey].shopify?.threeplMetrics,
                  netProfit: shopProfit,
                  netMargin: updatedWeeks[weekKey].shopify?.revenue > 0 ? (shopProfit / updatedWeeks[weekKey].shopify.revenue) * 100 : 0,
                },
                total: {
                  ...updatedWeeks[weekKey].total,
                  netProfit: (updatedWeeks[weekKey].amazon?.netProfit || 0) + shopProfit,
                  netMargin: updatedWeeks[weekKey].total?.revenue > 0 ? (((updatedWeeks[weekKey].amazon?.netProfit || 0) + shopProfit) / updatedWeeks[weekKey].total.revenue) * 100 : 0,
                }
              };
              weeksUpdated++;
            }
          }
        });
        
        if (weeksUpdated > 0) {
          setAllWeeksData(updatedWeeks);
          save(updatedWeeks);
        }
      }
      
      setResults({
        files: processResults,
        totalAdded,
        totalSkipped,
        weeksAffected: weeksAffected.size,
      });
      setProcessing(null);
    };
    
    const ledgerStats = {
      totalOrders: Object.keys(threeplLedger.orders || {}).length,
      totalFiles: (threeplLedger.importedFiles || []).length,
      weeks: new Set(Object.values(threeplLedger.orders || {}).map(o => o.weekKey)).size,
    };
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-white flex items-center gap-2">
              <Truck className="w-6 h-6 text-blue-400" />
              3PL Bulk Upload
            </h2>
            <button onClick={() => { setShow3PLBulkUpload(false); setThreeplSelectedFiles([]); setThreeplResults(null); }} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
          
          {/* Current Stats */}
          <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
            <p className="text-slate-400 text-sm mb-2">Current 3PL Data</p>
            <div className="grid grid-cols-3 gap-4 text-center">
              <div>
                <p className="text-2xl font-bold text-white">{formatNumber(ledgerStats.totalOrders)}</p>
                <p className="text-slate-500 text-xs">Orders</p>
              </div>
              <div>
                <p className="text-2xl font-bold text-white">{ledgerStats.weeks}</p>
                <p className="text-slate-500 text-xs">Weeks</p>
              </div>
              <div>
                <p className="text-2xl font-bold text-white">{ledgerStats.totalFiles}</p>
                <p className="text-slate-500 text-xs">Files Imported</p>
              </div>
            </div>
          </div>
          
          {!results ? (
            <>
              {/* Drop Zone */}
              <div 
                className={`border-2 border-dashed rounded-xl p-8 text-center transition-all ${dragActive ? 'border-blue-500 bg-blue-500/10' : 'border-slate-600 hover:border-slate-500'}`}
                onDragEnter={handleDrag}
                onDragLeave={handleDrag}
                onDragOver={handleDrag}
                onDrop={handleDrop}
              >
                <Upload className="w-12 h-12 text-slate-500 mx-auto mb-3" />
                <p className="text-white font-medium mb-1">Drop 3PL Excel files here</p>
                <p className="text-slate-400 text-sm mb-3">or click to browse</p>
                <input
                  type="file"
                  multiple
                  accept=".xlsx,.xls,.csv"
                  onChange={handleFileSelect}
                  className="hidden"
                  id="threepl-file-input"
                />
                <label htmlFor="threepl-file-input" className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white cursor-pointer inline-block">
                  Select Files
                </label>
                <p className="text-slate-500 text-xs mt-3">Supports .xlsx, .xls, .csv â€¢ Multiple files OK â€¢ Duplicates auto-skipped</p>
              </div>
              
              {/* Selected Files */}
              {selectedFiles.length > 0 && (
                <div className="mt-4">
                  <p className="text-slate-400 text-sm mb-2">Selected Files ({selectedFiles.length})</p>
                  <div className="space-y-2 max-h-40 overflow-y-auto">
                    {selectedFiles.map((file, idx) => (
                      <div key={idx} className="flex items-center justify-between bg-slate-900/50 rounded-lg p-2">
                        <div className="flex items-center gap-2">
                          <FileSpreadsheet className="w-4 h-4 text-emerald-400" />
                          <span className="text-white text-sm">{file.name}</span>
                          <span className="text-slate-500 text-xs">({(file.size / 1024).toFixed(1)} KB)</span>
                        </div>
                        <button onClick={() => removeFile(idx)} className="text-slate-400 hover:text-rose-400">
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>
                  
                  {/* Progress Bar */}
                  {processing && (
                    <div className="mt-4 space-y-2">
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-slate-400">Processing: {processing.fileName}</span>
                        <span className="text-white font-medium">{processing.current} of {processing.total}</span>
                      </div>
                      <div className="w-full bg-slate-700 rounded-full h-3 overflow-hidden">
                        <div 
                          className="bg-blue-500 h-full rounded-full transition-all duration-300 ease-out"
                          style={{ width: `${(processing.current / processing.total) * 100}%` }}
                        />
                      </div>
                      <p className="text-slate-500 text-xs text-center">
                        {Math.round((processing.current / processing.total) * 100)}% complete
                      </p>
                    </div>
                  )}
                  
                  <button
                    onClick={processFiles}
                    disabled={processing}
                    className="w-full mt-4 py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 rounded-xl text-white font-semibold flex items-center justify-center gap-2"
                  >
                    {processing ? (
                      <>
                        <RefreshCw className="w-5 h-5 animate-spin" />
                        Processing {processing.current}/{processing.total}...
                      </>
                    ) : (
                      <>
                        <Upload className="w-5 h-5" />
                        Import {selectedFiles.length} File{selectedFiles.length > 1 ? 's' : ''}
                      </>
                    )}
                  </button>
                </div>
              )}
            </>
          ) : (
            /* Results */
            <div className="space-y-4">
              <div className="bg-emerald-900/30 border border-emerald-500/30 rounded-xl p-4">
                <div className="flex items-center gap-2 mb-2">
                  <CheckCircle className="w-5 h-5 text-emerald-400" />
                  <span className="text-emerald-400 font-semibold">Import Complete</span>
                </div>
                <div className="grid grid-cols-3 gap-4 text-center">
                  <div>
                    <p className="text-2xl font-bold text-emerald-400">{results.totalAdded}</p>
                    <p className="text-slate-400 text-xs">Orders Added</p>
                  </div>
                  <div>
                    <p className="text-2xl font-bold text-amber-400">{results.totalSkipped}</p>
                    <p className="text-slate-400 text-xs">Duplicates Skipped</p>
                  </div>
                  <div>
                    <p className="text-2xl font-bold text-blue-400">{results.weeksAffected}</p>
                    <p className="text-slate-400 text-xs">Weeks Updated</p>
                  </div>
                </div>
              </div>
              
              <div className="space-y-2">
                <p className="text-slate-400 text-sm">File Details</p>
                {results.files.map((r, idx) => (
                  <div key={idx} className={`flex items-center justify-between rounded-lg p-3 ${r.status === 'success' ? 'bg-slate-900/50' : 'bg-rose-900/20 border border-rose-500/30'}`}>
                    <div className="flex items-center gap-2">
                      {r.status === 'success' ? (
                        <CheckCircle className="w-4 h-4 text-emerald-400" />
                      ) : (
                        <AlertCircle className="w-4 h-4 text-rose-400" />
                      )}
                      <span className="text-white text-sm">{r.file}</span>
                      {r.format && <span className="text-xs text-slate-500">({r.format})</span>}
                    </div>
                    {r.status === 'success' ? (
                      <span className="text-slate-400 text-sm">
                        +{r.ordersAdded} orders {r.dateRange?.start && `(${r.dateRange.start} to ${r.dateRange.end})`}
                      </span>
                    ) : (
                      <span className="text-rose-400 text-sm">{r.error}</span>
                    )}
                  </div>
                ))}
              </div>
              
              <button
                onClick={() => { setSelectedFiles([]); setResults(null); }}
                className="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-semibold"
              >
                Import More Files
              </button>
            </div>
          )}
        </div>
      </div>
    );
  };

  // ADS BULK UPLOAD MODAL (Meta & Google)
  const AdsBulkUploadModal = () => {
    const [dragActive, setDragActive] = useState(false);
    
    if (!showAdsBulkUpload) return null;
    
    const handleDrag = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (e.type === 'dragenter' || e.type === 'dragover') setDragActive(true);
      else if (e.type === 'dragleave') setDragActive(false);
    };
    
    const handleDrop = (e) => {
      e.preventDefault();
      e.stopPropagation();
      setDragActive(false);
      const files = [...e.dataTransfer.files].filter(f => f.name.endsWith('.csv'));
      setAdsSelectedFiles(prev => [...prev, ...files]);
    };
    
    const handleFileSelect = (e) => {
      const files = [...e.target.files].filter(f => f.name.endsWith('.csv'));
      setAdsSelectedFiles(prev => [...prev, ...files]);
    };
    
    const removeFile = (idx) => setAdsSelectedFiles(prev => prev.filter((_, i) => i !== idx));
    
    // Parse date formats from Meta and Google ads exports
    const parseAdsDate = (dateStr) => {
      if (!dateStr) return null;
      const str = dateStr.replace(/"/g, '').trim();
      
      // Format: "Jan 4, 2026" or "Dec 31, 2025" (Meta)
      const metaMatch = str.match(/^([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})$/);
      if (metaMatch) {
        const months = { jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5, jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11 };
        const month = months[metaMatch[1].toLowerCase().substring(0, 3)];
        const day = parseInt(metaMatch[2]);
        const year = parseInt(metaMatch[3]);
        if (month !== undefined && day && year) {
          const d = new Date(year, month, day);
          return d.toISOString().split('T')[0]; // YYYY-MM-DD
        }
      }
      
      // Format: "Mon, Dec 29, 2025" (Google)
      const googleMatch = str.match(/^[A-Za-z]+,\s*([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})$/);
      if (googleMatch) {
        const months = { jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5, jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11 };
        const month = months[googleMatch[1].toLowerCase().substring(0, 3)];
        const day = parseInt(googleMatch[2]);
        const year = parseInt(googleMatch[3]);
        if (month !== undefined && day && year) {
          const d = new Date(year, month, day);
          return d.toISOString().split('T')[0];
        }
      }
      
      // Format: YYYY-MM-DD
      const isoMatch = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (isoMatch) return str;
      
      // Format: MM/DD/YYYY
      const usMatch = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (usMatch) {
        const d = new Date(parseInt(usMatch[3]), parseInt(usMatch[1]) - 1, parseInt(usMatch[2]));
        return d.toISOString().split('T')[0];
      }
      
      return null;
    };
    
    // Parse currency/number values
    const parseNumber = (val) => {
      if (val === null || val === undefined || val === 'null' || val === '') return 0;
      const str = String(val).replace(/[$,]/g, '').trim();
      const num = parseFloat(str);
      return isNaN(num) ? 0 : num;
    };
    
    // Detect file type and parse accordingly
    const parseAdsFile = async (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length < 2) {
              reject(new Error('File has no data rows'));
              return;
            }
            
            // Parse header
            const parseCSVLine = (line) => {
              const result = [];
              let current = '';
              let inQuotes = false;
              for (const char of line) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
              }
              result.push(current.trim());
              return result;
            };
            
            const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().replace(/"/g, ''));
            const dateColIdx = headers.findIndex(h => h === 'date' || h.includes('date'));
            
            if (dateColIdx === -1) {
              reject(new Error('No date column found'));
              return;
            }
            
            // Detect file type by headers
            const isMetaAds = headers.some(h => h.includes('ad name') || h.includes('amount spent') || h.includes('roas'));
            const isGoogleAds = headers.some(h => h.includes('avg. cpc') || h.includes('avg cpc') || h.includes('cost / conv'));
            
            if (!isMetaAds && !isGoogleAds) {
              reject(new Error('Unrecognized ads format. Expected Meta or Google Ads export.'));
              return;
            }
            
            // Map headers to indices
            const getColIdx = (patterns) => headers.findIndex(h => patterns.some(p => h.includes(p)));
            
            const dailyData = {}; // { date: { metaSpend, googleSpend, impressions, clicks, ... } }
            
            // Parse data rows
            for (let i = 1; i < lines.length; i++) {
              const cols = parseCSVLine(lines[i]);
              const dateStr = cols[dateColIdx];
              const parsedDate = parseAdsDate(dateStr);
              
              if (!parsedDate) continue; // Skip invalid dates
              
              if (!dailyData[parsedDate]) {
                dailyData[parsedDate] = {
                  metaSpend: 0, googleSpend: 0,
                  metaImpressions: 0, googleImpressions: 0,
                  metaClicks: 0, googleClicks: 0,
                  metaPurchases: 0, googleConversions: 0,
                  metaPurchaseValue: 0, googleConversionValue: 0,
                  metaROAS: 0, googleCostPerConv: 0,
                  metaCPM: 0, metaCPC: 0, googleCPC: 0,
                  metaCTR: 0, googleCTR: 0,
                };
              }
              
              if (isMetaAds) {
                // Meta columns: Amount spent, Purchases value, Purchases, ROAS, Impressions, Link clicks, CTR, CPC, CPM
                const spendIdx = getColIdx(['amount spent']);
                const purchaseValueIdx = getColIdx(['purchases value', 'purchase value']);
                const purchasesIdx = getColIdx(['purchases (all)', 'purchases']);
                const roasIdx = getColIdx(['roas']);
                const impressionsIdx = getColIdx(['impressions']);
                const clicksIdx = getColIdx(['link clicks', 'clicks']);
                const ctrIdx = getColIdx(['ctr']);
                const cpcIdx = getColIdx(['cost per link click', 'cpc']);
                const cpmIdx = getColIdx(['cpm']);
                
                dailyData[parsedDate].metaSpend += parseNumber(cols[spendIdx]);
                dailyData[parsedDate].metaImpressions += parseNumber(cols[impressionsIdx]);
                dailyData[parsedDate].metaClicks += parseNumber(cols[clicksIdx]);
                dailyData[parsedDate].metaPurchases += parseNumber(cols[purchasesIdx]);
                dailyData[parsedDate].metaPurchaseValue += parseNumber(cols[purchaseValueIdx]);
                
                // For averages (CTR, CPC, CPM, ROAS), we'll recalculate after aggregation
              } else if (isGoogleAds) {
                // Google columns: Impressions, Avg. CPC, Cost, Cost / conv.
                const impressionsIdx = getColIdx(['impressions']);
                const cpcIdx = getColIdx(['avg. cpc', 'avg cpc']);
                const costIdx = getColIdx(['cost']);
                const costPerConvIdx = getColIdx(['cost / conv', 'cost/conv', 'cost per conv']);
                
                dailyData[parsedDate].googleSpend += parseNumber(cols[costIdx]);
                dailyData[parsedDate].googleImpressions += parseNumber(cols[impressionsIdx]);
                dailyData[parsedDate].googleCPC = parseNumber(cols[cpcIdx]); // Will take last value (daily totals)
                dailyData[parsedDate].googleCostPerConv = parseNumber(cols[costPerConvIdx]);
                
                // Estimate conversions from cost per conv
                const cost = parseNumber(cols[costIdx]);
                const costPerConv = parseNumber(cols[costPerConvIdx]);
                if (costPerConv > 0) {
                  dailyData[parsedDate].googleConversions += Math.round(cost / costPerConv);
                }
              }
            }
            
            // Calculate derived metrics for Meta
            Object.keys(dailyData).forEach(date => {
              const d = dailyData[date];
              if (d.metaImpressions > 0) {
                d.metaCPM = (d.metaSpend / d.metaImpressions) * 1000;
                d.metaCTR = (d.metaClicks / d.metaImpressions) * 100;
              }
              if (d.metaClicks > 0) {
                d.metaCPC = d.metaSpend / d.metaClicks;
              }
              if (d.metaSpend > 0 && d.metaPurchaseValue > 0) {
                d.metaROAS = d.metaPurchaseValue / d.metaSpend;
              }
              if (d.googleImpressions > 0 && d.googleSpend > 0) {
                d.googleCTR = (d.googleSpend / d.googleCPC / d.googleImpressions) * 100 || 0;
              }
            });
            
            const dates = Object.keys(dailyData).sort();
            if (dates.length === 0) {
              reject(new Error('No valid daily data found'));
              return;
            }
            
            resolve({
              type: isMetaAds ? 'meta' : 'google',
              dailyData,
              dateRange: { start: dates[0], end: dates[dates.length - 1] },
              daysCount: dates.length,
            });
          } catch (err) {
            reject(new Error(`Parse error: ${err.message}`));
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });
    };
    
    const processFiles = async () => {
      const totalFiles = adsSelectedFiles.length;
      const processResults = [];
      let updatedDays = { ...allDaysData };
      let totalDaysUpdated = 0;
      let allDatesAffected = new Set();
      
      for (let i = 0; i < adsSelectedFiles.length; i++) {
        const file = adsSelectedFiles[i];
        
        // Update progress
        setAdsProcessing({ current: i + 1, total: totalFiles, fileName: file.name });
        
        try {
          const parsed = await parseAdsFile(file);
          let daysUpdated = 0;
          
          Object.entries(parsed.dailyData).forEach(([date, adsData]) => {
            allDatesAffected.add(date);
            
            // Get existing day data or create minimal structure
            const existingDay = updatedDays[date] || {
              total: { revenue: 0, units: 0, cogs: 0, adSpend: 0, netProfit: 0 },
              amazon: { revenue: 0, units: 0, cogs: 0, adSpend: 0, netProfit: 0 },
              shopify: { revenue: 0, units: 0, cogs: 0, adSpend: 0, metaSpend: 0, googleSpend: 0, netProfit: 0 },
            };
            
            // Update ad spend data WITHOUT touching sales data
            const newMetaSpend = parsed.type === 'meta' ? adsData.metaSpend : (existingDay.shopify?.metaSpend || 0);
            const newGoogleSpend = parsed.type === 'google' ? adsData.googleSpend : (existingDay.shopify?.googleSpend || 0);
            const totalAdSpend = newMetaSpend + newGoogleSpend;
            
            // Store ads metrics
            const adsMetrics = {
              ...(existingDay.shopify?.adsMetrics || {}),
              ...(parsed.type === 'meta' ? {
                metaImpressions: adsData.metaImpressions,
                metaClicks: adsData.metaClicks,
                metaPurchases: adsData.metaPurchases,
                metaPurchaseValue: adsData.metaPurchaseValue,
                metaROAS: adsData.metaROAS,
                metaCPM: adsData.metaCPM,
                metaCPC: adsData.metaCPC,
                metaCTR: adsData.metaCTR,
              } : {}),
              ...(parsed.type === 'google' ? {
                googleImpressions: adsData.googleImpressions,
                googleClicks: adsData.googleClicks,
                googleConversions: adsData.googleConversions,
                googleCPC: adsData.googleCPC,
                googleCostPerConv: adsData.googleCostPerConv,
              } : {}),
            };
            
            // Calculate new profit (existing revenue - existing cogs - new ad spend)
            const shopifyRevenue = existingDay.shopify?.revenue || 0;
            const shopifyCogs = existingDay.shopify?.cogs || 0;
            const shopifyThreeplCosts = existingDay.shopify?.threeplCosts || 0;
            const shopifyDiscounts = existingDay.shopify?.discounts || 0;
            const newShopifyProfit = shopifyRevenue - shopifyCogs - totalAdSpend - shopifyThreeplCosts - shopifyDiscounts;
            
            const amazonProfit = existingDay.amazon?.netProfit || 0;
            const totalProfit = amazonProfit + newShopifyProfit;
            
            updatedDays[date] = {
              ...existingDay,
              shopify: {
                ...existingDay.shopify,
                adSpend: totalAdSpend,
                metaSpend: newMetaSpend,
                googleSpend: newGoogleSpend,
                netProfit: newShopifyProfit,
                adsMetrics,
              },
              total: {
                ...existingDay.total,
                adSpend: totalAdSpend + (existingDay.amazon?.adSpend || 0),
                netProfit: totalProfit,
              },
            };
            
            daysUpdated++;
          });
          
          totalDaysUpdated += daysUpdated;
          processResults.push({
            file: file.name,
            status: 'success',
            type: parsed.type,
            daysUpdated,
            dateRange: parsed.dateRange,
          });
        } catch (err) {
          console.error('Error processing ads file:', file.name, err);
          processResults.push({
            file: file.name,
            status: 'error',
            error: err.message,
          });
        }
      }
      
      // Save updated data
      if (totalDaysUpdated > 0) {
        // Save to state
        setAllDaysData(updatedDays);
        
        // Save to localStorage immediately  
        lsSet('ecommerce_daily_sales_v1', JSON.stringify(updatedDays));
        
        // Push to cloud immediately (not queued) with explicit dailySales
        // Build fresh combined data with the new dailySales
        const freshCombinedData = {
          ...combinedData,
          dailySales: updatedDays,
        };
        if (session?.user?.id && supabase) {
          pushToCloudNow(freshCombinedData);
        }
      }
      
      setAdsResults({
        processResults,
        totalDaysUpdated,
        datesAffected: allDatesAffected.size,
      });
      setAdsProcessing(null);
    };
    
    return (
      <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div className="bg-slate-900 rounded-2xl border border-slate-700 w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
          {/* Header */}
          <div className="bg-gradient-to-r from-violet-600 to-purple-600 p-4 flex items-center justify-between">
            <div>
              <h2 className="text-xl font-bold text-white flex items-center gap-2">
                <TrendingUp className="w-6 h-6" />Bulk Upload Ads Data
              </h2>
              <p className="text-white/70 text-sm">Import Meta (Facebook) & Google Ads daily data</p>
            </div>
            <button onClick={() => { setShowAdsBulkUpload(false); setAdsSelectedFiles([]); setAdsResults(null); }} className="p-2 hover:bg-white/20 rounded-lg text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
          
          {/* Content */}
          <div className="p-6 overflow-y-auto flex-1">
            {!adsResults ? (
              <>
                {/* Instructions */}
                <div className="bg-slate-800/50 rounded-xl p-4 mb-4">
                  <h3 className="text-white font-semibold mb-2">Supported Formats</h3>
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div className="bg-blue-900/30 rounded-lg p-3 border border-blue-500/30">
                      <p className="text-blue-400 font-medium mb-1">ðŸ“˜ Meta/Facebook Ads</p>
                      <p className="text-slate-400 text-xs">Export from Meta Ads Manager with:</p>
                      <p className="text-slate-300 text-xs mt-1">Date, Amount spent, Purchases, ROAS, Impressions, Clicks, CTR, CPC, CPM</p>
                    </div>
                    <div className="bg-amber-900/30 rounded-lg p-3 border border-amber-500/30">
                      <p className="text-amber-400 font-medium mb-1">ðŸ”¶ Google Ads</p>
                      <p className="text-slate-400 text-xs">Export from Google Ads with:</p>
                      <p className="text-slate-300 text-xs mt-1">Date, Impressions, Avg CPC, Cost, Cost/conv</p>
                    </div>
                  </div>
                  <p className="text-slate-500 text-xs mt-3">âœ“ Daily data will be parsed and aggregated by date â€¢ âœ“ Sales data will NOT be overwritten â€¢ âœ“ Existing ads data for same dates will be replaced</p>
                </div>
                
                {/* Drop Zone */}
                <div
                  className={`border-2 border-dashed rounded-xl p-8 text-center transition-all ${dragActive ? 'border-violet-500 bg-violet-500/10' : 'border-slate-600 hover:border-slate-500'}`}
                  onDragEnter={handleDrag}
                  onDragLeave={handleDrag}
                  onDragOver={handleDrag}
                  onDrop={handleDrop}
                >
                  <TrendingUp className="w-12 h-12 text-slate-500 mx-auto mb-3" />
                  <p className="text-white font-medium mb-1">Drop CSV files here</p>
                  <p className="text-slate-400 text-sm mb-3">or click to browse</p>
                  <input type="file" multiple accept=".csv" onChange={handleFileSelect} className="hidden" id="ads-file-input" />
                  <label htmlFor="ads-file-input" className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white cursor-pointer inline-block">
                    Select Files
                  </label>
                  <p className="text-slate-500 text-xs mt-3">Supports .csv â€¢ Multiple files OK â€¢ Meta & Google can be mixed</p>
                </div>
                
                {/* Selected Files */}
                {adsSelectedFiles.length > 0 && (
                  <div className="mt-4">
                    <p className="text-slate-400 text-sm mb-2">Selected Files ({adsSelectedFiles.length})</p>
                    <div className="space-y-2 max-h-40 overflow-y-auto">
                      {adsSelectedFiles.map((file, idx) => (
                        <div key={idx} className="flex items-center justify-between bg-slate-900/50 rounded-lg p-2">
                          <div className="flex items-center gap-2">
                            <FileSpreadsheet className="w-4 h-4 text-violet-400" />
                            <span className="text-white text-sm">{file.name}</span>
                            <span className="text-slate-500 text-xs">({(file.size / 1024).toFixed(1)} KB)</span>
                          </div>
                          <button onClick={() => removeFile(idx)} className="text-slate-400 hover:text-rose-400">
                            <X className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                    </div>
                    
                    {/* Progress Bar */}
                    {adsProcessing && (
                      <div className="mt-4 space-y-2">
                        <div className="flex items-center justify-between text-sm">
                          <span className="text-slate-400">Processing: {adsProcessing.fileName}</span>
                          <span className="text-white font-medium">{adsProcessing.current} of {adsProcessing.total}</span>
                        </div>
                        <div className="w-full bg-slate-700 rounded-full h-3 overflow-hidden">
                          <div 
                            className="bg-violet-500 h-full rounded-full transition-all duration-300 ease-out"
                            style={{ width: `${(adsProcessing.current / adsProcessing.total) * 100}%` }}
                          />
                        </div>
                        <p className="text-slate-500 text-xs text-center">
                          {Math.round((adsProcessing.current / adsProcessing.total) * 100)}% complete
                        </p>
                      </div>
                    )}
                    
                    <button
                      onClick={processFiles}
                      disabled={adsProcessing}
                      className="w-full mt-4 py-3 bg-violet-600 hover:bg-violet-500 disabled:bg-slate-600 rounded-xl text-white font-semibold flex items-center justify-center gap-2"
                    >
                      {adsProcessing ? (
                        <><RefreshCw className="w-5 h-5 animate-spin" />Processing {adsProcessing.current}/{adsProcessing.total}...</>
                      ) : (
                        <><Upload className="w-5 h-5" />Import {adsSelectedFiles.length} File{adsSelectedFiles.length > 1 ? 's' : ''}</>
                      )}
                    </button>
                  </div>
                )}
              </>
            ) : (
              /* Results */
              <div className="space-y-4">
                <div className="bg-emerald-900/30 border border-emerald-500/30 rounded-xl p-4">
                  <div className="flex items-center gap-2 mb-2">
                    <CheckCircle className="w-5 h-5 text-emerald-400" />
                    <span className="text-emerald-400 font-semibold">Import Complete</span>
                  </div>
                  <div className="grid grid-cols-2 gap-4 text-center">
                    <div>
                      <p className="text-2xl font-bold text-emerald-400">{adsResults.totalDaysUpdated}</p>
                      <p className="text-slate-400 text-xs">Days Updated</p>
                    </div>
                    <div>
                      <p className="text-2xl font-bold text-violet-400">{adsResults.datesAffected}</p>
                      <p className="text-slate-400 text-xs">Unique Dates</p>
                    </div>
                  </div>
                </div>
                
                {/* File Results */}
                <div className="space-y-2">
                  {adsResults.processResults.map((r, idx) => (
                    <div key={idx} className={`rounded-lg p-3 flex items-center justify-between ${r.status === 'success' ? 'bg-slate-800' : 'bg-rose-900/30 border border-rose-500/30'}`}>
                      <div className="flex items-center gap-3">
                        {r.status === 'success' ? (
                          <CheckCircle className="w-5 h-5 text-emerald-400" />
                        ) : (
                          <AlertTriangle className="w-5 h-5 text-rose-400" />
                        )}
                        <div>
                          <p className="text-white text-sm">{r.file}</p>
                          {r.status === 'success' ? (
                            <p className="text-slate-400 text-xs">
                              {r.type === 'meta' ? 'ðŸ“˜ Meta' : 'ðŸ”¶ Google'} â€¢ {r.daysUpdated} days â€¢ {r.dateRange?.start} to {r.dateRange?.end}
                            </p>
                          ) : (
                            <p className="text-rose-400 text-xs">{r.error}</p>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                
                <button
                  onClick={() => { setShowAdsBulkUpload(false); setAdsSelectedFiles([]); setAdsResults(null); }}
                  className="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-semibold"
                >
                  Done
                </button>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  // INVOICE/BILLS MODAL
  const InvoiceModal = () => {
    if (!showInvoiceModal) return null;
    
    const categories = [
      { value: 'operations', label: 'ðŸ¢ Operations', color: 'slate' },
      { value: 'inventory', label: 'ðŸ“¦ Inventory/COGS', color: 'amber' },
      { value: 'marketing', label: 'ðŸ“£ Marketing/Ads', color: 'violet' },
      { value: 'software', label: 'ðŸ’» Software/SaaS', color: 'blue' },
      { value: 'shipping', label: 'ðŸšš Shipping/3PL', color: 'emerald' },
      { value: 'taxes', label: 'ðŸ“‹ Taxes/Fees', color: 'rose' },
      { value: 'other', label: 'ðŸ“Ž Other', color: 'slate' },
    ];
    
    const resetForm = () => {
      setInvoiceForm({ vendor: '', description: '', amount: '', dueDate: '', recurring: false, frequency: 'monthly', category: 'operations' });
      setEditingInvoice(null);
    };
    
    const handleSave = () => {
      if (!invoiceForm.vendor || !invoiceForm.amount || !invoiceForm.dueDate) return;
      
      const invoice = {
        id: editingInvoice?.id || Date.now().toString(),
        ...invoiceForm,
        amount: parseFloat(invoiceForm.amount),
        createdAt: editingInvoice?.createdAt || new Date().toISOString(),
        paid: editingInvoice?.paid || false,
      };
      
      if (editingInvoice) {
        setInvoices(prev => prev.map(i => i.id === editingInvoice.id ? invoice : i));
      } else {
        setInvoices(prev => [...prev, invoice]);
      }
      resetForm();
    };
    
    const handleDelete = (id) => {
      setInvoices(prev => prev.filter(i => i.id !== id));
    };
    
    const handleMarkPaid = (id) => {
      setInvoices(prev => prev.map(i => i.id === id ? { ...i, paid: true, paidDate: new Date().toISOString() } : i));
    };
    
    // PDF Upload and AI extraction
    const handlePdfUpload = async (file) => {
      if (!file) return;
      
      const fileName = file.name.toLowerCase();
      const isPdf = file.type.includes('pdf') || fileName.endsWith('.pdf');
      const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || file.type.includes('spreadsheet') || file.type.includes('excel');
      const isCsv = fileName.endsWith('.csv') || file.type.includes('csv');
      
      if (!isPdf && !isExcel && !isCsv) {
        alert('Please upload a PDF, Excel (.xlsx/.xls), or CSV file');
        return;
      }
      
      setProcessingPdf(true);
      
      try {
        let textContent = '';
        
        if (isCsv) {
          // Handle CSV directly
          textContent = await file.text();
        } else if (isExcel) {
          // Handle Excel files using SheetJS
          const xlsxLib = await loadXLSX();
          const arrayBuffer = await file.arrayBuffer();
          const workbook = xlsxLib.read(arrayBuffer, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          textContent = xlsxLib.utils.sheet_to_csv(firstSheet);
        }
        
        if (isCsv || isExcel) {
          // Parse CSV/Excel content with AI
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              system: `You are an invoice data extractor. Extract the following from this invoice/bill data and respond ONLY with valid JSON, no other text:
{
  "vendor": "company name",
  "description": "brief description of what this invoice is for",
  "amount": number (just the number, no currency symbol),
  "dueDate": "YYYY-MM-DD format",
  "category": one of: "operations", "inventory", "marketing", "software", "shipping", "taxes", "other"
}
If you cannot find a field, use null. For dueDate, if only month/year given, use the 1st of that month. Look for amounts, totals, due dates, vendor names in the data.`,
              messages: [{ 
                role: 'user', 
                content: `Extract invoice details from this data:\n\n${textContent.slice(0, 5000)}`
              }],
              model: 'claude-sonnet-4-20250514',
            }),
          });
          
          if (!response.ok) throw new Error('API error');
          const data = await response.json();
          const text = data.content?.[0]?.text || data.content || '';
          
          const jsonMatch = text.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            const extracted = JSON.parse(jsonMatch[0]);
            setInvoiceForm(prev => ({
              ...prev,
              vendor: extracted.vendor || prev.vendor,
              description: extracted.description || prev.description,
              amount: extracted.amount?.toString() || prev.amount,
              dueDate: extracted.dueDate || prev.dueDate,
              category: extracted.category || prev.category,
            }));
          }
        } else {
          // Handle PDF with vision
          const base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
          
          // Send to AI to extract invoice details
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              system: `You are an invoice data extractor. Extract the following from the invoice and respond ONLY with valid JSON, no other text:
{
  "vendor": "company name",
  "description": "brief description of what this invoice is for",
  "amount": number (just the number, no currency symbol),
  "dueDate": "YYYY-MM-DD format",
  "category": one of: "operations", "inventory", "marketing", "software", "shipping", "taxes", "other"
}
If you cannot find a field, use null. For dueDate, if only month/year given, use the 1st of that month.`,
              messages: [{ 
                role: 'user', 
                content: [
                  { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: base64 }},
                  { type: 'text', text: 'Extract the invoice details from this PDF.' }
                ]
              }],
              model: 'claude-sonnet-4-20250514',
            }),
          });
          
          if (!response.ok) throw new Error('API error');
          const data = await response.json();
          const text = data.content?.[0]?.text || data.content || '';
          
          // Parse the JSON response
          const jsonMatch = text.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            const extracted = JSON.parse(jsonMatch[0]);
            setInvoiceForm(prev => ({
              ...prev,
              vendor: extracted.vendor || prev.vendor,
              description: extracted.description || prev.description,
              amount: extracted.amount?.toString() || prev.amount,
              dueDate: extracted.dueDate || prev.dueDate,
              category: extracted.category || prev.category,
            }));
          }
        }
      } catch (error) {
        console.error('File extraction error:', error);
        alert('Could not extract invoice details. Please enter manually.');
      } finally {
        setProcessingPdf(false);
      }
    };
    
    const upcomingInvoices = invoices.filter(i => !i.paid).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
    const paidInvoices = invoices.filter(i => i.paid).sort((a, b) => new Date(b.paidDate) - new Date(a.paidDate)).slice(0, 10);
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-white flex items-center gap-2">
              <FileText className="w-6 h-6 text-amber-400" />
              Upcoming Bills & Invoices
            </h2>
            <button onClick={() => { setShowInvoiceModal(false); resetForm(); }} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
          
          {/* Add/Edit Form */}
          <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
            <h3 className="text-sm font-semibold text-slate-300 mb-3">{editingInvoice ? 'Edit Invoice' : 'Add New Invoice'}</h3>
            
            {/* PDF Upload */}
            <div className="mb-4">
              <label className={`flex items-center justify-center gap-2 p-3 border-2 border-dashed rounded-xl cursor-pointer transition-all ${processingPdf ? 'border-violet-500 bg-violet-950/30' : 'border-slate-600 hover:border-slate-500'}`}>
                <input type="file" accept=".pdf,.xlsx,.xls,.csv" onChange={(e) => e.target.files[0] && handlePdfUpload(e.target.files[0])} className="hidden" disabled={processingPdf} />
                {processingPdf ? (
                  <>
                    <RefreshCw className="w-5 h-5 text-violet-400 animate-spin" />
                    <span className="text-violet-400">Extracting invoice details...</span>
                  </>
                ) : (
                  <>
                    <Upload className="w-5 h-5 text-slate-400" />
                    <span className="text-slate-400">Upload PDF, Excel, or CSV to auto-fill</span>
                  </>
                )}
              </label>
            </div>
            
            <div className="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label className="block text-xs text-slate-400 mb-1">Vendor/Company *</label>
                <input 
                  id="invoice-vendor"
                  defaultValue={invoiceForm.vendor}
                  className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-violet-500" 
                  placeholder="Amazon, Shopify, etc." 
                />
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-1">Amount *</label>
                <input 
                  type="number" 
                  id="invoice-amount"
                  defaultValue={invoiceForm.amount}
                  className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-violet-500" 
                  placeholder="0.00" 
                />
              </div>
            </div>
            
            <div className="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label className="block text-xs text-slate-400 mb-1">Due Date *</label>
                <input 
                  type="date" 
                  id="invoice-duedate"
                  defaultValue={invoiceForm.dueDate}
                  className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-violet-500" 
                />
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-1">Category</label>
                <select 
                  id="invoice-category"
                  defaultValue={invoiceForm.category}
                  className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-violet-500">
                  {categories.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}
                </select>
              </div>
            </div>
            
            <div className="mb-3">
              <label className="block text-xs text-slate-400 mb-1">Description</label>
              <input 
                id="invoice-description"
                defaultValue={invoiceForm.description}
                className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-violet-500" 
                placeholder="Monthly subscription, inventory purchase, etc." 
              />
            </div>
            
            <div className="flex items-center gap-4 mb-3">
              <label className="flex items-center gap-2 cursor-pointer">
                <input 
                  type="checkbox" 
                  id="invoice-recurring"
                  defaultChecked={invoiceForm.recurring}
                  className="w-4 h-4 rounded border-slate-600 bg-slate-800 text-violet-500" 
                />
                <span className="text-sm text-slate-300">Recurring bill</span>
              </label>
              <select 
                id="invoice-frequency"
                defaultValue={invoiceForm.frequency}
                className="bg-slate-800 border border-slate-600 rounded-lg px-3 py-1 text-white text-sm">
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
            
            <div className="flex gap-2">
              <button onClick={() => {
                const vendor = document.getElementById('invoice-vendor')?.value || '';
                const amount = document.getElementById('invoice-amount')?.value || '';
                const dueDate = document.getElementById('invoice-duedate')?.value || '';
                const category = document.getElementById('invoice-category')?.value || 'operations';
                const description = document.getElementById('invoice-description')?.value || '';
                const recurring = document.getElementById('invoice-recurring')?.checked || false;
                const frequency = document.getElementById('invoice-frequency')?.value || 'monthly';
                
                if (!vendor || !amount || !dueDate) return;
                
                const invoice = {
                  id: editingInvoice?.id || Date.now().toString(),
                  vendor, description, amount: parseFloat(amount), dueDate, recurring, frequency, category,
                  createdAt: editingInvoice?.createdAt || new Date().toISOString(),
                  paid: editingInvoice?.paid || false,
                };
                
                if (editingInvoice) {
                  setInvoices(prev => prev.map(i => i.id === editingInvoice.id ? invoice : i));
                } else {
                  setInvoices(prev => [...prev, invoice]);
                }
                resetForm();
              }}
                className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-2 rounded-lg text-sm">
                {editingInvoice ? 'Update' : 'Add Invoice'}
              </button>
              {editingInvoice && (
                <button onClick={resetForm} className="px-4 bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 rounded-lg text-sm">
                  Cancel
                </button>
              )}
            </div>
          </div>
          
          {/* Upcoming Invoices */}
          <div className="mb-4">
            <h3 className="text-sm font-semibold text-amber-400 mb-2 flex items-center gap-2">
              <Clock className="w-4 h-4" />
              Upcoming ({upcomingInvoices.length})
            </h3>
            {upcomingInvoices.length > 0 ? (
              <div className="space-y-2">
                {upcomingInvoices.map(inv => {
                  const daysUntil = Math.ceil((new Date(inv.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                  const isOverdue = daysUntil < 0;
                  const isDueSoon = daysUntil <= 7 && daysUntil >= 0;
                  const cat = categories.find(c => c.value === inv.category);
                  
                  return (
                    <div key={inv.id} className={`flex items-center justify-between p-3 rounded-xl border ${isOverdue ? 'bg-rose-900/20 border-rose-500/50' : isDueSoon ? 'bg-amber-900/20 border-amber-500/50' : 'bg-slate-900/50 border-slate-700'}`}>
                      <div className="flex items-center gap-3">
                        <span className="text-lg">{cat?.label.split(' ')[0]}</span>
                        <div>
                          <p className="text-white font-medium">{inv.vendor}</p>
                          <p className="text-slate-400 text-xs">{inv.description || 'No description'}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-3">
                        <div className="text-right">
                          <p className="text-white font-bold">{formatCurrency(inv.amount)}</p>
                          <p className={`text-xs ${isOverdue ? 'text-rose-400' : isDueSoon ? 'text-amber-400' : 'text-slate-400'}`}>
                            {isOverdue ? `${Math.abs(daysUntil)} days overdue` : daysUntil === 0 ? 'Due today' : `Due in ${daysUntil} days`}
                          </p>
                        </div>
                        <div className="flex gap-1">
                          <button onClick={() => handleMarkPaid(inv.id)} className="p-1.5 bg-emerald-600/30 hover:bg-emerald-600/50 rounded-lg text-emerald-400" title="Mark as paid">
                            <Check className="w-4 h-4" />
                          </button>
                          <button onClick={() => { setEditingInvoice(inv); setInvoiceForm({ vendor: inv.vendor, description: inv.description || '', amount: inv.amount.toString(), dueDate: inv.dueDate, recurring: inv.recurring || false, frequency: inv.frequency || 'monthly', category: inv.category || 'operations' }); }} className="p-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-400" title="Edit">
                            <FileText className="w-4 h-4" />
                          </button>
                          <button onClick={() => handleDelete(inv.id)} className="p-1.5 bg-rose-600/30 hover:bg-rose-600/50 rounded-lg text-rose-400" title="Delete">
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <p className="text-slate-500 text-sm text-center py-4">No upcoming invoices</p>
            )}
          </div>
          
          {/* Recently Paid */}
          {paidInvoices.length > 0 && (
            <div>
              <h3 className="text-sm font-semibold text-emerald-400 mb-2 flex items-center gap-2">
                <CheckCircle className="w-4 h-4" />
                Recently Paid
              </h3>
              <div className="space-y-1">
                {paidInvoices.map(inv => (
                  <div key={inv.id} className="flex items-center justify-between p-2 bg-slate-900/30 rounded-lg opacity-60">
                    <span className="text-slate-400 text-sm">{inv.vendor}</span>
                    <span className="text-slate-400 text-sm">{formatCurrency(inv.amount)}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  // COMPARISON MODAL (Feature 12)
  const ComparisonView = () => {
    if (!compareMode || compareItems.length < 2) return null;
    
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const items = compareItems.slice(0, 4).map(key => {
      const data = allWeeksData[key];
      if (!data) return null;
      return {
        key,
        label: key,
        revenue: data.total?.revenue || 0,
        profit: data.total?.netProfit || 0,
        units: data.total?.units || 0,
        margin: data.total?.revenue ? ((data.total?.netProfit || 0) / data.total.revenue * 100) : 0,
        amazonRev: data.amazon?.revenue || 0,
        shopifyRev: data.shopify?.revenue || 0,
        note: weekNotes[key] || '',
      };
    }).filter(Boolean);
    
    if (items.length < 2) return null;
    
    return (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-white flex items-center gap-2">
              <GitCompareArrows className="w-6 h-6 text-violet-400" />
              Compare Weeks
            </h2>
            <button onClick={() => { setCompareMode(false); setCompareItems([]); }} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
          
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="border-b border-slate-700">
                  <th className="text-left text-slate-400 py-2 px-3">Metric</th>
                  {items.map(item => (
                    <th key={item.key} className="text-right text-white py-2 px-3 font-semibold">{item.label}</th>
                  ))}
                  <th className="text-right text-slate-400 py-2 px-3">Difference</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-700/50">
                <tr>
                  <td className="py-3 px-3 text-slate-400">Revenue</td>
                  {items.map(item => <td key={item.key} className="text-right py-3 px-3 text-white font-medium">{formatCurrency(item.revenue)}</td>)}
                  <td className={`text-right py-3 px-3 font-medium ${items[1].revenue >= items[0].revenue ? 'text-emerald-400' : 'text-rose-400'}`}>
                    {items[1].revenue >= items[0].revenue ? '+' : ''}{formatCurrency(items[1].revenue - items[0].revenue)}
                  </td>
                </tr>
                <tr>
                  <td className="py-3 px-3 text-slate-400">Profit</td>
                  {items.map(item => <td key={item.key} className={`text-right py-3 px-3 font-medium ${item.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(item.profit)}</td>)}
                  <td className={`text-right py-3 px-3 font-medium ${items[1].profit >= items[0].profit ? 'text-emerald-400' : 'text-rose-400'}`}>
                    {items[1].profit >= items[0].profit ? '+' : ''}{formatCurrency(items[1].profit - items[0].profit)}
                  </td>
                </tr>
                <tr>
                  <td className="py-3 px-3 text-slate-400">Units</td>
                  {items.map(item => <td key={item.key} className="text-right py-3 px-3 text-white">{formatNumber(item.units)}</td>)}
                  <td className={`text-right py-3 px-3 font-medium ${items[1].units >= items[0].units ? 'text-emerald-400' : 'text-rose-400'}`}>
                    {items[1].units >= items[0].units ? '+' : ''}{formatNumber(items[1].units - items[0].units)}
                  </td>
                </tr>
                <tr>
                  <td className="py-3 px-3 text-slate-400">Margin</td>
                  {items.map(item => <td key={item.key} className="text-right py-3 px-3 text-white">{item.margin.toFixed(1)}%</td>)}
                  <td className={`text-right py-3 px-3 font-medium ${items[1].margin >= items[0].margin ? 'text-emerald-400' : 'text-rose-400'}`}>
                    {items[1].margin >= items[0].margin ? '+' : ''}{(items[1].margin - items[0].margin).toFixed(1)}%
                  </td>
                </tr>
                <tr>
                  <td className="py-3 px-3 text-slate-400">Amazon</td>
                  {items.map(item => <td key={item.key} className="text-right py-3 px-3 text-orange-400">{formatCurrency(item.amazonRev)}</td>)}
                  <td className={`text-right py-3 px-3 font-medium ${items[1].amazonRev >= items[0].amazonRev ? 'text-emerald-400' : 'text-rose-400'}`}>
                    {items[1].amazonRev >= items[0].amazonRev ? '+' : ''}{formatCurrency(items[1].amazonRev - items[0].amazonRev)}
                  </td>
                </tr>
                <tr>
                  <td className="py-3 px-3 text-slate-400">Shopify</td>
                  {items.map(item => <td key={item.key} className="text-right py-3 px-3 text-blue-400">{formatCurrency(item.shopifyRev)}</td>)}
                  <td className={`text-right py-3 px-3 font-medium ${items[1].shopifyRev >= items[0].shopifyRev ? 'text-emerald-400' : 'text-rose-400'}`}>
                    {items[1].shopifyRev >= items[0].shopifyRev ? '+' : ''}{formatCurrency(items[1].shopifyRev - items[0].shopifyRev)}
                  </td>
                </tr>
                {items.some(i => i.note) && (
                  <tr>
                    <td className="py-3 px-3 text-slate-400">Notes</td>
                    {items.map(item => <td key={item.key} className="text-right py-3 px-3 text-slate-300 text-sm max-w-[150px] truncate">{item.note || 'â€”'}</td>)}
                    <td></td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
          
          <div className="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center">
            <p className="text-slate-500 text-sm">Select weeks from the dashboard to compare</p>
            <button onClick={() => { setCompareMode(false); setCompareItems([]); }}
              className="px-4 py-2 bg-violet-600 hover:bg-violet-500 text-white rounded-lg font-medium">
              Done
            </button>
          </div>
        </div>
      </div>
    );
  };

  // NOTES COMPONENT (Feature 8)
  const WeekNoteEditor = ({ weekKey, compact = false }) => {
    const note = weekNotes[weekKey] || '';
    const isEditing = editingNote === weekKey;
    
    if (compact) {
      return note ? (
        <div className="flex items-center gap-1 text-amber-400 text-xs cursor-pointer" onClick={() => { setEditingNote(weekKey); setNoteText(note); }}>
          <StickyNote className="w-3 h-3" />
          <span className="truncate max-w-[100px]">{note}</span>
        </div>
      ) : (
        <button onClick={() => { setEditingNote(weekKey); setNoteText(''); }} className="text-slate-500 hover:text-slate-400 text-xs flex items-center gap-1">
          <StickyNote className="w-3 h-3" />Add note
        </button>
      );
    }
    
    if (isEditing) {
      return (
        <div className="flex gap-2 items-start">
          <textarea value={noteText} onChange={e => setNoteText(e.target.value)} placeholder="Add a note (e.g., 'Ran 20% off promo')"
            className="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm resize-none" rows={2} />
          <div className="flex flex-col gap-1">
            <button onClick={() => { setWeekNotes(p => ({...p, [weekKey]: noteText})); setEditingNote(null); }}
              className="px-3 py-1 bg-emerald-600 hover:bg-emerald-500 text-white text-sm rounded-lg">Save</button>
            <button onClick={() => setEditingNote(null)} className="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg">Cancel</button>
          </div>
        </div>
      );
    }
    
    return note ? (
      <div className="flex items-start gap-2 bg-amber-900/20 border border-amber-500/30 rounded-lg p-2 cursor-pointer" onClick={() => { setEditingNote(weekKey); setNoteText(note); }}>
        <StickyNote className="w-4 h-4 text-amber-400 flex-shrink-0 mt-0.5" />
        <p className="text-amber-200 text-sm">{note}</p>
      </div>
    ) : (
      <button onClick={() => { setEditingNote(weekKey); setNoteText(''); }} className="text-slate-500 hover:text-slate-400 text-sm flex items-center gap-1">
        <StickyNote className="w-4 h-4" />Add note for this week
      </button>
    );
  };

  const hasCogs = Object.keys(savedCogs).length > 0;
  
  // AI Chat - Prepare data context function
  const prepareDataContext = () => {
    const weeksCount = Object.keys(allWeeksData).length;
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const sortedDays = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort();
    const daysCount = sortedDays.length;
    const periodsCount = Object.keys(allPeriodsData).length;
    
    // Daily data summary
    const dailySummary = sortedDays.slice(-14).map(day => {
      const data = allDaysData[day];
      return {
        date: day,
        totalRevenue: data.total?.revenue || 0,
        totalProfit: data.total?.netProfit || 0,
        totalUnits: data.total?.units || 0,
        amazonRevenue: data.amazon?.revenue || 0,
        amazonProfit: data.amazon?.netProfit || 0,
        shopifyRevenue: data.shopify?.revenue || 0,
        shopifyProfit: data.shopify?.netProfit || 0,
      };
    });
    
    const weeksSummary = sortedWeeks.map(week => {
      const data = allWeeksData[week];
      const amz = data.amazon || {};
      const shop = data.shopify || {};
      const total = data.total || {};
      
      // Adjust date if it's Monday (start of week) to show Sunday (end of week)
      const weekDate = new Date(week + 'T00:00:00');
      const dayOfWeek = weekDate.getDay();
      const weekEndDate = dayOfWeek === 1 
        ? new Date(weekDate.getTime() - 24 * 60 * 60 * 1000) 
        : weekDate;
      const weekEndStr = weekEndDate.toISOString().split('T')[0];
      
      return {
        weekEnding: weekEndStr,
        weekKey: week, // Original key
        totalRevenue: total.revenue || 0,
        totalProfit: total.netProfit || 0,
        totalUnits: total.units || 0,
        margin: total.revenue ? ((total.netProfit || 0) / total.revenue * 100).toFixed(1) : 0,
        amazonRevenue: amz.revenue || 0,
        amazonProfit: amz.netProfit || 0,
        shopifyRevenue: shop.revenue || 0,
        shopifyProfit: shop.netProfit || 0,
      };
    });
    
    const periodsSummary = Object.entries(allPeriodsData).map(([label, data]) => {
      const amz = data.amazon || {};
      const shop = data.shopify || {};
      
      // Get 3PL data from ledger for this period
      const ledger3PL = get3PLForPeriod(threeplLedger, label);
      const threeplFromLedger = ledger3PL?.metrics?.totalCost || 0;
      
      // Compute category breakdown for this period (like we do for weeks)
      const categoryBreakdown = {};
      const processSkusForPeriod = (skuData, channel) => {
        (skuData || []).forEach(s => {
          const sku = s.sku || s.msku || '';
          const productName = (savedProductNames[sku] || s.name || s.title || sku).toLowerCase();
          const units = s.unitsSold || s.units || 0;
          const revenue = s.netSales || s.revenue || 0;
          const profit = channel === 'Amazon' ? (s.netProceeds || revenue) : (revenue - (s.cogs || 0));
          
          // Determine category (same logic as computeCategoryBreakdown)
          let category = 'Other';
          if (productName.includes('lip balm') || productName.includes('lip-balm')) category = 'Lip Balm';
          else if (productName.includes('sensitive') && productName.includes('deodorant')) category = 'Sensitive Skin Deodorant';
          else if (productName.includes('extra strength') && productName.includes('deodorant')) category = 'Extra Strength Deodorant';
          else if (productName.includes('deodorant') || productName.includes('deo')) category = 'Deodorant';
          else if (productName.includes('athlete') && productName.includes('soap')) category = "Athlete's Shield Soap";
          else if (productName.includes('soap') || productName.includes('bar soap')) category = 'Tallow Soap Bars';
          else if (productName.includes('sun balm') || productName.includes('spf')) category = 'Sun Balm';
          else if (productName.includes('tallow balm') || productName.includes('moisturizer')) category = 'Tallow Balm';
          
          // Fallback: check for lip balm pack patterns (handles "Sweet Orange 3-Pack", "Assorted Pack", etc.)
          if (category === 'Other') {
            const combined = (sku + ' ' + productName).toLowerCase();
            // Check for pack patterns with lip balm flavors/variants
            const isLipBalmPack = (
              (combined.includes('pack') || combined.includes('pk')) && (
                combined.includes('orange') || combined.includes('peppermint') || 
                combined.includes('vanilla') || combined.includes('lavender') ||
                combined.includes('unscented') || combined.includes('assorted') ||
                combined.includes('mint') || combined.includes('honey') ||
                combined.includes('sweet') || combined.includes('citrus') ||
                combined.includes('cherry') || combined.includes('berry')
              )
            );
            // Also check for lip balm SKU patterns (like LB-, BALM-, etc.)
            const hasLipBalmSku = /^(lb|balm|lip)/i.test(sku) || sku.toLowerCase().includes('lip');
            
            if (isLipBalmPack || hasLipBalmSku) {
              category = 'Lip Balm';
            }
          }
          
          if (!categoryBreakdown[category]) {
            categoryBreakdown[category] = { units: 0, revenue: 0, profit: 0 };
          }
          categoryBreakdown[category].units += units;
          categoryBreakdown[category].revenue += revenue;
          categoryBreakdown[category].profit += profit;
        });
      };
      
      processSkusForPeriod(amz.skuData, 'Amazon');
      processSkusForPeriod(shop.skuData, 'Shopify');
      
      // Also build SKU-level breakdown for detailed queries
      const skuBreakdown = {};
      const buildSkuBreakdown = (skuData) => {
        (skuData || []).forEach(s => {
          const sku = s.sku || s.msku || '';
          if (!sku) return;
          const name = savedProductNames[sku] || s.name || s.title || sku;
          const revenue = s.netSales || s.revenue || 0;
          const units = s.unitsSold || s.units || 0;
          if (!skuBreakdown[sku]) {
            skuBreakdown[sku] = { name, revenue: 0, units: 0 };
          }
          skuBreakdown[sku].revenue += revenue;
          skuBreakdown[sku].units += units;
        });
      };
      buildSkuBreakdown(amz.skuData);
      buildSkuBreakdown(shop.skuData);
      
      return {
        period: label,
        label: data.label || label,
        type: (() => {
          const l = label.toLowerCase();
          if (l.match(/^\d{4}$/)) return 'yearly';
          if (l.match(/^q\d/i)) return 'quarterly';
          if (l.match(/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i)) return 'monthly';
          return 'monthly';
        })(),
        totalRevenue: data.total?.revenue || 0,
        totalProfit: data.total?.netProfit || 0,
        totalUnits: data.total?.units || 0,
        totalCogs: data.total?.cogs || 0,
        totalAdSpend: data.total?.adSpend || 0,
        margin: data.total?.revenue > 0 ? ((data.total?.netProfit || 0) / data.total.revenue * 100) : 0,
        amazonRevenue: amz.revenue || 0,
        amazonProfit: amz.netProfit || 0,
        amazonUnits: amz.units || 0,
        shopifyRevenue: shop.revenue || 0,
        shopifyProfit: shop.netProfit || 0,
        shopifyUnits: shop.units || 0,
        threeplCosts: threeplFromLedger || shop.threeplCosts || 0,
        skuCount: ((amz.skuData || []).length + (shop.skuData || []).length),
        byCategory: categoryBreakdown, // Category breakdown for this period
        skuBreakdown: skuBreakdown, // SKU-level breakdown for detailed queries
      };
    }).sort((a, b) => a.period.localeCompare(b.period));
    
    // Calculate year-over-year insights
    const yoyInsights = [];
    const quarters2024 = periodsSummary.filter(p => p.period.includes('2024') && p.type === 'quarterly');
    const months2024 = periodsSummary.filter(p => p.period.includes('2024') && p.type === 'monthly');
    const months2025 = periodsSummary.filter(p => p.period.includes('2025') && p.type === 'monthly');
    
    // Q4 2024 vs Q4 2025 (or most recent comparable quarters)
    quarters2024.forEach(q2024 => {
      const qNum = q2024.period.split(' ')[0]; // e.g., "Q3"
      const q2025 = periodsSummary.find(p => p.period === `${qNum} 2025`);
      if (q2025) {
        yoyInsights.push({
          comparison: `${qNum} YoY`,
          period1: q2024.period,
          period2: q2025.period,
          revChange: q2024.totalRevenue > 0 ? ((q2025.totalRevenue - q2024.totalRevenue) / q2024.totalRevenue * 100) : 0,
          profitChange: q2024.totalProfit > 0 ? ((q2025.totalProfit - q2024.totalProfit) / q2024.totalProfit * 100) : 0,
        });
      }
    });
    
    // Monthly trends for 2025
    const monthlyTrend2025 = months2025.map(m => ({
      month: m.label,
      revenue: m.totalRevenue,
      profit: m.totalProfit,
      margin: m.margin,
    }));
    
    const skuWeeklyBreakdown = {};
    sortedWeeks.forEach(week => {
      const data = allWeeksData[week];
      (data.amazon?.skuData || []).forEach(s => {
        const sku = s.sku || s.msku || 'unknown';
        if (!skuWeeklyBreakdown[sku]) {
          skuWeeklyBreakdown[sku] = { sku, name: s.name || s.title || sku, channel: 'Amazon', weeks: {}, totals: { revenue: 0, units: 0, profit: 0, fees: 0 } };
        }
        const units = s.unitsSold || s.units || 0;
        const revenue = s.netSales || s.revenue || 0;
        const proceeds = s.netProceeds || revenue;
        // Amazon: netProceeds IS the profit (already has COGS, fees, and ad spend deducted)
        const profit = proceeds;
        const fees = revenue - proceeds;
        skuWeeklyBreakdown[sku].weeks[week] = { units, revenue, profit, fees, profitPerUnit: units > 0 ? profit / units : 0 };
        skuWeeklyBreakdown[sku].totals.revenue += revenue;
        skuWeeklyBreakdown[sku].totals.units += units;
        skuWeeklyBreakdown[sku].totals.profit += profit;
        skuWeeklyBreakdown[sku].totals.fees += fees;
      });
      (data.shopify?.skuData || []).forEach(s => {
        const sku = 'SHOP_' + (s.sku || 'unknown');
        if (!skuWeeklyBreakdown[sku]) {
          skuWeeklyBreakdown[sku] = { sku: s.sku, name: s.name || s.title || s.sku, channel: 'Shopify', weeks: {}, totals: { revenue: 0, units: 0, profit: 0, fees: 0 } };
        }
        const units = s.unitsSold || s.units || 0;
        const revenue = s.netSales || s.revenue || 0;
        // Shopify: netSales already has discounts deducted, subtract COGS
        const profit = revenue - (s.cogs || 0);
        skuWeeklyBreakdown[sku].weeks[week] = { units, revenue, profit, fees: 0, profitPerUnit: units > 0 ? profit / units : 0 };
        skuWeeklyBreakdown[sku].totals.revenue += revenue;
        skuWeeklyBreakdown[sku].totals.units += units;
        skuWeeklyBreakdown[sku].totals.profit += profit;
      });
    });
    
    const skuAnalysis = Object.values(skuWeeklyBreakdown).filter(s => s.totals.units >= 1).map(s => {
      const weekDates = Object.keys(s.weeks).sort();
      const recentWeeks = weekDates.slice(-4);
      const olderWeeks = weekDates.slice(-8, -4);
      let recentUnits = 0, recentProfit = 0, olderUnits = 0, olderProfit = 0;
      recentWeeks.forEach(w => { recentUnits += s.weeks[w].units; recentProfit += s.weeks[w].profit; });
      olderWeeks.forEach(w => { olderUnits += s.weeks[w].units; olderProfit += s.weeks[w].profit; });
      const recentPPU = recentUnits > 0 ? recentProfit / recentUnits : 0;
      const olderPPU = olderUnits > 0 ? olderProfit / olderUnits : 0;
      const ppuChange = olderWeeks.length > 0 ? recentPPU - olderPPU : 0;
      const overallPPU = s.totals.units > 0 ? s.totals.profit / s.totals.units : 0;
      const overallMargin = s.totals.revenue > 0 ? (s.totals.profit / s.totals.revenue * 100) : 0;
      // Get product name from savedProductNames if available
      const productName = savedProductNames[s.sku] || s.name || s.sku;
      return {
        sku: s.sku, name: s.name, productName, channel: s.channel,
        totalRevenue: s.totals.revenue, totalUnits: s.totals.units, totalProfit: s.totals.profit, totalFees: s.totals.fees,
        profitPerUnit: overallPPU, margin: overallMargin,
        recentProfitPerUnit: recentPPU, priorProfitPerUnit: olderPPU, profitPerUnitChange: ppuChange,
        trend: ppuChange > 0.5 ? 'improving' : ppuChange < -0.5 ? 'declining' : 'stable',
      };
    }).sort((a, b) => b.totalRevenue - a.totalRevenue);
    
    const latestInvDate = Object.keys(invHistory).sort().reverse()[0];
    const latestInv = latestInvDate ? invHistory[latestInvDate] : null;
    const inventorySummary = latestInv ? {
      asOfDate: latestInvDate, totalUnits: latestInv.totalUnits || 0, totalValue: latestInv.totalValue || 0,
      lowStockItems: (latestInv.items || []).filter(i => i.health === 'low' || i.health === 'critical').map(i => ({ sku: i.sku, units: i.totalUnits })),
    } : null;
    
    const taxSummary = {
      nexusStates: Object.entries(salesTaxConfig.nexusStates || {}).filter(([,v]) => v.hasNexus).map(([code, config]) => ({ state: US_STATES_TAX_INFO[code]?.name || code, frequency: config.frequency })),
      totalPaidAllTime: Object.values(salesTaxConfig.filingHistory || {}).reduce((sum, periods) => sum + Object.values(periods).reduce((s, p) => s + (p.amount || 0), 0), 0),
    };
    
    // Build product catalog with categories from product names
    const productCatalog = Object.entries(savedProductNames).map(([sku, name]) => {
      // Auto-detect category from product name
      const nameLower = name.toLowerCase();
      let category = 'Other';
      if (nameLower.includes('lip balm')) category = 'Lip Balm';
      else if (nameLower.includes('deodorant') && nameLower.includes('sensitive')) category = 'Sensitive Skin Deodorant';
      else if (nameLower.includes('deodorant') && nameLower.includes('extra strength')) category = 'Extra Strength Deodorant';
      else if (nameLower.includes('deodorant')) category = 'Deodorant';
      else if (nameLower.includes('soap') && nameLower.includes('athlete')) category = "Athlete's Shield Soap";
      else if (nameLower.includes('soap')) category = 'Tallow Soap Bars';
      else if (nameLower.includes('sun balm')) category = 'Sun Balm';
      else if (nameLower.includes('tallow balm')) category = 'Tallow Balm';
      
      return { sku, name, category };
    });
    
    // Group SKUs by category for easier AI lookup
    const skusByCategory = {};
    productCatalog.forEach(p => {
      if (!skusByCategory[p.category]) skusByCategory[p.category] = [];
      skusByCategory[p.category].push(p.sku);
    });
    
    // COMPREHENSIVE SKU-LEVEL AGGREGATION (combines all periods + weeks)
    const skuMasterData = {};
    
    // Add period data (2025 monthly, 2024 quarterly)
    periodsSummary.filter(p => p.totalRevenue > 0).forEach(period => {
      Object.entries(period.skuBreakdown || {}).forEach(([sku, data]) => {
        if (!skuMasterData[sku]) {
          const catalogEntry = productCatalog.find(p => p.sku === sku);
          skuMasterData[sku] = {
            sku,
            name: catalogEntry?.name || data.name || sku,
            category: catalogEntry?.category || 'Other',
            totalRevenue: 0,
            totalUnits: 0,
            byPeriod: {},
            byWeek: {},
          };
        }
        skuMasterData[sku].totalRevenue += data.revenue || 0;
        skuMasterData[sku].totalUnits += data.units || 0;
        skuMasterData[sku].byPeriod[period.period] = { revenue: data.revenue, units: data.units };
      });
    });
    
    // Add weekly data (recent weeks)
    sortedWeeks.slice(-12).forEach(week => {
      const weekData = allWeeksData[week];
      if (!weekData) return;
      
      const processWeekSkus = (skuData, channel) => {
        (skuData || []).forEach(s => {
          const sku = s.sku || s.msku || '';
          if (!sku) return;
          const revenue = s.netSales || s.revenue || 0;
          const units = s.unitsSold || s.units || 0;
          
          if (!skuMasterData[sku]) {
            const catalogEntry = productCatalog.find(p => p.sku === sku);
            skuMasterData[sku] = {
              sku,
              name: catalogEntry?.name || savedProductNames[sku] || s.name || sku,
              category: catalogEntry?.category || 'Other',
              totalRevenue: 0,
              totalUnits: 0,
              byPeriod: {},
              byWeek: {},
            };
          }
          
          if (!skuMasterData[sku].byWeek[week]) {
            skuMasterData[sku].byWeek[week] = { revenue: 0, units: 0 };
          }
          skuMasterData[sku].byWeek[week].revenue += revenue;
          skuMasterData[sku].byWeek[week].units += units;
          // Only add to totals if not already counted in periods
          if (Object.keys(skuMasterData[sku].byPeriod).length === 0) {
            skuMasterData[sku].totalRevenue += revenue;
            skuMasterData[sku].totalUnits += units;
          }
        });
      };
      
      processWeekSkus(weekData.amazon?.skuData, 'Amazon');
      processWeekSkus(weekData.shopify?.skuData, 'Shopify');
    });
    
    // Convert to sorted array
    const skuMasterList = Object.values(skuMasterData)
      .filter(s => s.totalRevenue > 0 || Object.keys(s.byWeek).length > 0)
      .sort((a, b) => b.totalRevenue - a.totalRevenue);
    
    // Calculate all time totals properly:
    // 2026: Use weekly data (actual weeks)
    // 2025: Use monthly period data (no weekly breakdown available)
    // 2024: Use quarterly period data
    const weeks2026 = weeksSummary.filter(w => w.weekKey && w.weekKey.startsWith('2026') && w.totalRevenue > 0);
    // Note: months2025 and quarters2024 already defined above in YoY section
    
    const allTimeRevenue = 
      weeks2026.reduce((s, w) => s + w.totalRevenue, 0) +
      months2025.reduce((s, p) => s + p.totalRevenue, 0) +
      quarters2024.reduce((s, p) => s + p.totalRevenue, 0);
    const allTimeProfit = 
      weeks2026.reduce((s, w) => s + w.totalProfit, 0) +
      months2025.reduce((s, p) => s + p.totalProfit, 0) +
      quarters2024.reduce((s, p) => s + p.totalProfit, 0);
    const allTimeUnits = 
      weeks2026.reduce((s, w) => s + w.totalUnits, 0) +
      months2025.reduce((s, p) => s + p.totalUnits, 0) +
      quarters2024.reduce((s, p) => s + p.totalUnits, 0);
    const recentWeeksData = weeksSummary.filter(w => w.totalRevenue > 0).slice(-4);
    const priorWeeksData = weeksSummary.filter(w => w.totalRevenue > 0).slice(-8, -4);
    const recentRevenue = recentWeeksData.reduce((s, w) => s + w.totalRevenue, 0);
    const priorRevenue = priorWeeksData.reduce((s, w) => s + w.totalRevenue, 0);
    const recentProfit = recentWeeksData.reduce((s, w) => s + w.totalProfit, 0);
    const priorProfit = priorWeeksData.reduce((s, w) => s + w.totalProfit, 0);
    
    // Calculate daily trends for AI learning
    const recentDailyData = dailySummary.slice(-7);
    const priorDailyData = dailySummary.slice(-14, -7);
    const recentDailyRevenue = recentDailyData.reduce((s, d) => s + d.totalRevenue, 0);
    const priorDailyRevenue = priorDailyData.reduce((s, d) => s + d.totalRevenue, 0);
    const dailyTrend = priorDailyRevenue > 0 ? ((recentDailyRevenue - priorDailyRevenue) / priorDailyRevenue * 100) : 0;
    
    // Calculate day-of-week patterns for AI learning
    const dayOfWeekPatterns = {};
    sortedDays.forEach(day => {
      const data = allDaysData[day];
      const dayName = new Date(day + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' });
      if (!dayOfWeekPatterns[dayName]) {
        dayOfWeekPatterns[dayName] = { count: 0, totalRevenue: 0, totalProfit: 0 };
      }
      dayOfWeekPatterns[dayName].count++;
      dayOfWeekPatterns[dayName].totalRevenue += data.total?.revenue || 0;
      dayOfWeekPatterns[dayName].totalProfit += data.total?.netProfit || 0;
    });
    Object.keys(dayOfWeekPatterns).forEach(day => {
      const p = dayOfWeekPatterns[day];
      p.avgRevenue = p.count > 0 ? p.totalRevenue / p.count : 0;
      p.avgProfit = p.count > 0 ? p.totalProfit / p.count : 0;
    });
    
    // PRE-COMPUTED: Filter to only weeks with actual revenue
    const weeksWithRevenue = sortedWeeks.filter(w => (allWeeksData[w]?.total?.revenue || 0) > 0);
    
    // Helper function to compute category breakdown for a set of weeks
    const computeCategoryBreakdown = (weekKeys) => {
      const categories = {};
      
      // SKU patterns for categorization (fallback if product name doesn't match)
      const skuPatterns = {
        'Lip Balm': [/lip/i, /balm.*pack/i, /orange.*pack/i, /peppermint.*pack/i, /unscented.*pack/i, /assorted.*pack/i, /vanilla.*pack/i, /lavender.*pack/i, /mint.*pack/i],
        'Deodorant': [/deo/i, /deod/i],
        'Tallow Soap Bars': [/soap/i, /bar/i],
        'Sun Balm': [/sun/i, /spf/i],
        'Tallow Balm': [/tallow.*balm/i, /moisturiz/i, /hydrat/i],
      };
      
      weekKeys.forEach(weekKey => {
        const weekData = allWeeksData[weekKey];
        if (!weekData) return;
        
        // Process all SKUs and group by category
        const processSkus = (skuData, channel) => {
          (skuData || []).forEach(s => {
            const sku = s.sku || s.msku || '';
            const productName = (savedProductNames[sku] || s.name || s.title || sku).toLowerCase();
            const units = s.unitsSold || s.units || 0;
            const revenue = s.netSales || s.revenue || 0;
            const profit = channel === 'Amazon' ? (s.netProceeds || revenue) : (revenue - (s.cogs || 0));
            
            // Determine category from product name first
            let category = 'Other';
            
            // Explicit product name matching
            if (productName.includes('lip balm') || productName.includes('lip-balm')) category = 'Lip Balm';
            else if (productName.includes('sensitive') && productName.includes('deodorant')) category = 'Sensitive Skin Deodorant';
            else if (productName.includes('extra strength') && productName.includes('deodorant')) category = 'Extra Strength Deodorant';
            else if (productName.includes('deodorant') || productName.includes('deo')) category = 'Deodorant';
            else if (productName.includes('athlete') && productName.includes('soap')) category = "Athlete's Shield Soap";
            else if (productName.includes('soap') || productName.includes('bar soap')) category = 'Tallow Soap Bars';
            else if (productName.includes('sun balm') || productName.includes('spf')) category = 'Sun Balm';
            else if (productName.includes('tallow balm') || productName.includes('moisturizer')) category = 'Tallow Balm';
            
            // If still "Other", try SKU-based pattern matching (common lip balm packs)
            if (category === 'Other') {
              const combined = (sku + ' ' + productName).toLowerCase();
              // Check for pack patterns with lip balm flavors/variants
              const isLipBalmPack = (
                (combined.includes('pack') || combined.includes('pk')) && (
                  combined.includes('orange') || combined.includes('peppermint') || 
                  combined.includes('vanilla') || combined.includes('lavender') ||
                  combined.includes('unscented') || combined.includes('assorted') ||
                  combined.includes('mint') || combined.includes('honey') ||
                  combined.includes('sweet') || combined.includes('citrus') ||
                  combined.includes('cherry') || combined.includes('berry')
                )
              );
              // Also check for lip balm SKU patterns (like LB-, BALM-, etc.)
              const hasLipBalmSku = /^(lb|balm|lip)/i.test(sku) || sku.toLowerCase().includes('lip');
              
              if (isLipBalmPack || hasLipBalmSku) {
                category = 'Lip Balm';
              }
            }
            
            // Final fallback: check SKU patterns
            if (category === 'Other') {
              for (const [cat, patterns] of Object.entries(skuPatterns)) {
                for (const pattern of patterns) {
                  if (pattern.test(sku) || pattern.test(productName)) {
                    category = cat;
                    break;
                  }
                }
                if (category !== 'Other') break;
              }
            }
            
            if (!categories[category]) {
              categories[category] = { units: 0, revenue: 0, profit: 0, skus: [] };
            }
            categories[category].units += units;
            categories[category].revenue += revenue;
            categories[category].profit += profit;
            
            // Only add SKU details for single-week queries (keep data compact)
            if (weekKeys.length === 1) {
              categories[category].skus.push({ sku, name: savedProductNames[sku] || s.name || sku, channel, units, revenue, profit });
            }
          });
        };
        
        processSkus(weekData.amazon?.skuData, 'Amazon');
        processSkus(weekData.shopify?.skuData, 'Shopify');
      });
      
      // Calculate margins and sort SKUs
      Object.values(categories).forEach(cat => {
        cat.margin = cat.revenue > 0 ? (cat.profit / cat.revenue * 100).toFixed(1) : 0;
        if (cat.skus) cat.skus.sort((a, b) => b.revenue - a.revenue);
      });
      
      return categories;
    };
    
    // Get total metrics for a set of weeks
    const getWeeksTotals = (weekKeys) => {
      return weekKeys.reduce((acc, w) => {
        const data = allWeeksData[w];
        if (data) {
          acc.revenue += data.total?.revenue || 0;
          acc.profit += data.total?.netProfit || 0;
          acc.units += data.total?.units || 0;
        }
        return acc;
      }, { revenue: 0, profit: 0, units: 0 });
    };
    
    // LAST WEEK (most recent week with actual data)
    const lastWeekKey = weeksWithRevenue[weeksWithRevenue.length - 1];
    const lastWeekData = lastWeekKey ? allWeeksData[lastWeekKey] : null;
    
    return {
      storeName: storeName || 'E-Commerce Store',
      dataRange: { 
        weeksTracked: weeksCount, 
        daysTracked: daysCount,
        periodsTracked: periodsCount, 
        oldestWeek: sortedWeeks[0], 
        newestWeek: sortedWeeks[sortedWeeks.length - 1],
        oldestDay: sortedDays[0],
        newestDay: sortedDays[sortedDays.length - 1],
      },
      dailyData: dailySummary,
      dailyTrend,
      dayOfWeekPatterns,
      weeklyData: weeksSummary,
      periodData: periodsSummary,
      yoyInsights,
      monthlyTrend2025,
      // PER-WEEK SKU BREAKDOWN - for answering "last week" questions accurately
      skuByWeek: (() => {
        const recentWeeks = sortedWeeks.slice(-4);
        return recentWeeks.map(week => {
          const data = allWeeksData[week];
          const skuList = [];
          
          // Week dates: Amazon reports week as ending Sunday, key is typically the Sunday
          // If key is Monday (start of week), adjust to show Sunday (end of prior week)
          const weekDate = new Date(week + 'T00:00:00');
          const dayOfWeek = weekDate.getDay(); // 0=Sun, 1=Mon, etc.
          // If it's Monday (1), subtract 1 day to get Sunday
          // If it's already Sunday (0), keep it
          const weekEndDate = dayOfWeek === 1 
            ? new Date(weekDate.getTime() - 24 * 60 * 60 * 1000) 
            : weekDate;
          const weekEndStr = weekEndDate.toISOString().split('T')[0];
          
          // Amazon SKUs
          (data.amazon?.skuData || []).forEach(s => {
            const sku = s.sku || s.msku;
            const productName = savedProductNames[sku] || s.name || s.title || sku;
            const units = s.unitsSold || s.units || 0;
            const revenue = s.netSales || s.revenue || 0;
            const profit = s.netProceeds || revenue;
            skuList.push({
              sku,
              productName,
              channel: 'Amazon',
              units,
              revenue,
              profit,
              profitPerUnit: units > 0 ? profit / units : 0,
            });
          });
          
          // Shopify SKUs
          (data.shopify?.skuData || []).forEach(s => {
            const sku = s.sku;
            const productName = savedProductNames[sku] || s.name || s.title || sku;
            const units = s.unitsSold || s.units || 0;
            const revenue = s.netSales || s.revenue || 0;
            const profit = revenue - (s.cogs || 0);
            skuList.push({
              sku,
              productName,
              channel: 'Shopify',
              units,
              revenue,
              profit,
              profitPerUnit: units > 0 ? profit / units : 0,
            });
          });
          
          return {
            weekEnding: weekEndStr,
            weekKey: week, // Original key for reference
            weekLabel: `Week ending ${weekEndDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' })}`,
            totalRevenue: data.total?.revenue || 0,
            totalProfit: data.total?.netProfit || 0,
            totalUnits: data.total?.units || 0,
            skus: skuList.sort((a, b) => b.revenue - a.revenue),
          };
        });
      })(),
      // LAST WEEK (most recent week with actual revenue)
      lastWeekByCategory: lastWeekKey ? {
        weekEnding: lastWeekKey,
        weekLabel: `Week of ${new Date(new Date(lastWeekKey + 'T00:00:00').getTime() - 6*24*60*60*1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(lastWeekKey + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
        totalRevenue: lastWeekData?.total?.revenue || 0,
        totalProfit: lastWeekData?.total?.netProfit || 0,
        totalUnits: lastWeekData?.total?.units || 0,
        byCategory: computeCategoryBreakdown([lastWeekKey]),
      } : null,
      
      // LAST 2 WEEKS
      last2WeeksByCategory: (() => {
        const weeks = weeksWithRevenue.slice(-2);
        if (weeks.length === 0) return null;
        const totals = getWeeksTotals(weeks);
        const startDate = new Date(new Date(weeks[0] + 'T00:00:00').getTime() - 6*24*60*60*1000);
        const endDate = new Date(weeks[weeks.length - 1] + 'T00:00:00');
        return {
          weeks: weeks,
          dateRange: `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
          totalRevenue: totals.revenue,
          totalProfit: totals.profit,
          totalUnits: totals.units,
          byCategory: computeCategoryBreakdown(weeks),
        };
      })(),
      
      // LAST 4 WEEKS (approx 1 month)
      last4WeeksByCategory: (() => {
        const weeks = weeksWithRevenue.slice(-4);
        if (weeks.length === 0) return null;
        const totals = getWeeksTotals(weeks);
        const startDate = new Date(new Date(weeks[0] + 'T00:00:00').getTime() - 6*24*60*60*1000);
        const endDate = new Date(weeks[weeks.length - 1] + 'T00:00:00');
        return {
          weeks: weeks,
          dateRange: `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
          totalRevenue: totals.revenue,
          totalProfit: totals.profit,
          totalUnits: totals.units,
          byCategory: computeCategoryBreakdown(weeks),
        };
      })(),
      
      // ALL TIME by category
      allTimeByCategory: (() => {
        const totals = getWeeksTotals(weeksWithRevenue);
        return {
          weeks: weeksWithRevenue.length,
          totalRevenue: totals.revenue,
          totalProfit: totals.profit,
          totalUnits: totals.units,
          byCategory: computeCategoryBreakdown(weeksWithRevenue),
        };
      })(),
      
      skuAnalysis: skuAnalysis.slice(0, 30),
      skusByProfitPerUnit: [...skuAnalysis].sort((a, b) => b.profitPerUnit - a.profitPerUnit).slice(0, 10),
      decliningSkus: skuAnalysis.filter(s => s.trend === 'declining').slice(0, 10),
      improvingSkus: skuAnalysis.filter(s => s.trend === 'improving').slice(0, 10),
      productCatalog,
      skusByCategory,
      skuMasterData: skuMasterList, // COMPREHENSIVE: all SKU data across periods + weeks
      inventory: inventorySummary,
      salesTax: taxSummary,
      goals,
      insights: {
        allTimeRevenue, allTimeProfit, allTimeUnits,
        avgWeeklyRevenue: weeksCount > 0 ? allTimeRevenue / weeksCount : 0,
        avgWeeklyProfit: weeksCount > 0 ? allTimeProfit / weeksCount : 0,
        avgDailyRevenue: daysCount > 0 ? dailySummary.reduce((s, d) => s + d.totalRevenue, 0) / daysCount : 0,
        avgDailyProfit: daysCount > 0 ? dailySummary.reduce((s, d) => s + d.totalProfit, 0) / daysCount : 0,
        overallMargin: allTimeRevenue > 0 ? (allTimeProfit / allTimeRevenue * 100) : 0,
        overallProfitPerUnit: allTimeUnits > 0 ? allTimeProfit / allTimeUnits : 0,
        recentVsPrior: {
          recentRevenue, priorRevenue, revenueChange: priorRevenue > 0 ? ((recentRevenue - priorRevenue) / priorRevenue * 100) : 0,
          recentProfit, priorProfit, profitChange: priorProfit > 0 ? ((recentProfit - priorProfit) / priorProfit * 100) : 0,
        },
        topChannel: allTimeRevenue > 0 ? (weeksSummary.reduce((s, w) => s + w.amazonRevenue, 0) > allTimeRevenue / 2 ? 'Amazon' : 'Shopify') : 'Unknown',
      },
      // AI Learning Data - helps Claude make better predictions
      aiLearning: {
        forecastCorrections: {
          revenueMultiplier: forecastCorrections.overall?.revenue || 1,
          unitsMultiplier: forecastCorrections.overall?.units || 1,
          confidence: forecastCorrections.confidence || 0,
          samplesUsed: forecastCorrections.samplesUsed || 0,
        },
        predictionHistory: {
          totalPredictions: aiLearningHistory.predictions?.length || 0,
          verifiedPredictions: aiLearningHistory.predictions?.filter(p => p.actual !== undefined).length || 0,
          recentAccuracy: (() => {
            const verified = aiLearningHistory.predictions?.filter(p => p.accuracy?.revenueError !== undefined) || [];
            if (verified.length === 0) return null;
            const avgError = verified.slice(-10).reduce((sum, p) => sum + Math.abs(p.accuracy.revenueError || 0), 0) / Math.min(10, verified.length);
            return 100 - avgError;
          })(),
        },
        recentPredictions: aiLearningHistory.predictions?.slice(-5).map(p => ({
          type: p.type,
          period: p.period,
          predictedAt: p.predictedAt,
          predicted: p.prediction?.revenue?.expected,
          actual: p.actual?.revenue,
          error: p.accuracy?.revenueError,
        })) || [],
      },
      // Seasonal Patterns for AI Forecasting
      seasonalPatterns: (() => {
        // Group data by month across years
        const monthlyByYear = {};
        sortedWeeks.forEach(w => {
          const data = allWeeksData[w];
          const date = new Date(w);
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const key = `${year}-${String(month).padStart(2, '0')}`;
          if (!monthlyByYear[key]) monthlyByYear[key] = { year, month, revenue: 0, profit: 0, units: 0, weeks: 0 };
          monthlyByYear[key].revenue += data.total?.revenue || 0;
          monthlyByYear[key].profit += data.total?.netProfit || 0;
          monthlyByYear[key].units += data.total?.units || 0;
          monthlyByYear[key].weeks++;
        });
        
        // Calculate month-over-month and year-over-year patterns
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const seasonalIndex = {};
        monthNames.forEach((name, i) => {
          const monthData = Object.values(monthlyByYear).filter(m => m.month === i + 1);
          if (monthData.length > 0) {
            const avgRevenue = monthData.reduce((s, m) => s + m.revenue, 0) / monthData.length;
            seasonalIndex[name] = {
              avgRevenue,
              avgProfit: monthData.reduce((s, m) => s + m.profit, 0) / monthData.length,
              dataPoints: monthData.length,
              years: monthData.map(m => m.year),
            };
          }
        });
        
        // Calculate overall average for seasonal index
        const allMonths = Object.values(seasonalIndex);
        const overallAvg = allMonths.length > 0 ? allMonths.reduce((s, m) => s + m.avgRevenue, 0) / allMonths.length : 0;
        
        // Add seasonal index (1.0 = average, >1 = above average month)
        Object.keys(seasonalIndex).forEach(month => {
          seasonalIndex[month].index = overallAvg > 0 ? seasonalIndex[month].avgRevenue / overallAvg : 1;
        });
        
        return {
          byMonth: seasonalIndex,
          overallMonthlyAvg: overallAvg,
          strongMonths: Object.entries(seasonalIndex).filter(([_, m]) => m.index > 1.1).map(([name]) => name),
          weakMonths: Object.entries(seasonalIndex).filter(([_, m]) => m.index < 0.9).map(([name]) => name),
        };
      })(),
      // Multi-Source Data Triangulation for AI
      dataTriangulation: (() => {
        // Compare sales data with banking deposits
        const salesVsBanking = {};
        if (bankingData.monthlySnapshots) {
          Object.entries(bankingData.monthlySnapshots).forEach(([month, banking]) => {
            // Find matching sales data
            const salesWeeks = sortedWeeks.filter(w => w.startsWith(month));
            const salesRevenue = salesWeeks.reduce((s, w) => s + (allWeeksData[w]?.total?.revenue || 0), 0);
            const salesProfit = salesWeeks.reduce((s, w) => s + (allWeeksData[w]?.total?.netProfit || 0), 0);
            
            if (salesRevenue > 0 || banking.income > 0) {
              salesVsBanking[month] = {
                salesRevenue,
                salesProfit,
                bankDeposits: banking.income,
                bankExpenses: banking.expenses,
                bankNet: banking.net,
                // Deposits should be less than revenue (after marketplace fees)
                depositRatio: salesRevenue > 0 ? (banking.income / salesRevenue) : 0,
                // True profit = sales profit - additional bank expenses (like ads, 3PL not in sales data)
                adjustedProfit: salesProfit - (banking.expenses * 0.3), // Estimate 30% of expenses are already in COGS
              };
            }
          });
        }
        
        return {
          salesVsBanking,
          hasMultipleSources: bankingData.transactions?.length > 0 && sortedWeeks.length > 0,
          dataQualityScore: (() => {
            let score = 0;
            if (sortedWeeks.length >= 12) score += 25; // Good weekly history
            if (sortedDays.length >= 30) score += 20; // Good daily history
            if (bankingData.transactions?.length >= 100) score += 20; // Good banking data
            if (Object.keys(savedCogs).length >= 10) score += 15; // Good COGS coverage
            if (forecastCorrections.samplesUsed >= 4) score += 10; // AI learning active
            if (Object.keys(amazonForecasts).length > 0) score += 10; // Has forecasts
            return score;
          })(),
        };
      })(),
      // Banking/Cash Flow Data for AI analysis
      banking: bankingData.transactions?.length > 0 ? (() => {
        // Filter to real bank accounts only
        const strictFilter = (name) => {
          if (!/\(\d{4}\)\s*-\s*\d+$/.test(name)) return false;
          if (name.includes('"') || name.length > 60) return false;
          if (!/^[A-Za-z]/.test(name.trim())) return false;
          return true;
        };
        const accts = Object.entries(bankingData.accounts || {}).filter(([name, _]) => strictFilter(name));
        const checkingAccts = accts.filter(([_, a]) => a.type !== 'credit_card');
        const creditAccts = accts.filter(([_, a]) => a.type === 'credit_card');
        const totalCash = checkingAccts.reduce((s, [_, a]) => s + (a.balance || 0), 0);
        const totalDebt = creditAccts.reduce((s, [_, a]) => s + (a.balance || 0), 0);
        const recentMonths = Object.keys(bankingData.monthlySnapshots || {}).sort().slice(-3);
        const avgBurn = recentMonths.length > 0 
          ? recentMonths.reduce((s, m) => s + (bankingData.monthlySnapshots[m]?.expenses || 0), 0) / recentMonths.length
          : 0;
        const runway = avgBurn > 0 ? Math.floor(totalCash / avgBurn) : 99;
        
        return {
          transactionCount: bankingData.transactions.length,
          dateRange: bankingData.dateRange,
          lastUpload: bankingData.lastUpload,
          // CFO Summary (note: this is CASH FLOW not profit - doesn't include COGS)
          cfoMetrics: {
            cashPosition: totalCash,
            creditCardDebt: totalDebt,
            netPosition: totalCash - totalDebt,
            monthlyBurnRate: avgBurn,
            cashRunwayMonths: runway,
          },
          // Account Balances
          accounts: accts.map(([name, data]) => ({
            name: name.split('(')[0].trim(),
            type: data.type,
            balance: data.balance || 0,
            transactions: data.transactions,
          })),
          // Monthly Cash Flow (last 12 months) - NOTE: income is deposits, not revenue; net is cash flow, not profit
          monthlySnapshots: Object.entries(bankingData.monthlySnapshots || {}).slice(-12).map(([month, data]) => ({
            month,
            income: data.income,  // Bank deposits (Amazon/Shopify payouts after fees)
            expenses: data.expenses,
            net: data.net,
            transactionCount: data.transactions,
          })),
          // Top expense categories
          topExpenseCategories: Object.entries(bankingData.categories || {})
            .filter(([_, c]) => c.totalOut > 0)
            .sort((a, b) => b[1].totalOut - a[1].totalOut)
            .slice(0, 10)
            .map(([name, data]) => ({ name, total: data.totalOut, count: data.count })),
          // Top income sources
          topIncomeCategories: Object.entries(bankingData.categories || {})
            .filter(([_, c]) => c.totalIn > 0)
            .sort((a, b) => b[1].totalIn - a[1].totalIn)
            .slice(0, 10)
            .map(([name, data]) => ({ name, total: data.totalIn, count: data.count })),
        };
      })() : null,
      // ========= UNIFIED AI METRICS - COMPREHENSIVE DATA VIEW =========
      // This provides the AI with a proper understanding of data availability
      // IMPORTANT: Use these metrics for ALL-TIME totals, not the daily data
      unifiedMetrics: unifiedBusinessMetrics,
      
      // Data availability explanation for AI
      dataAvailability: {
        // Amazon: Daily data may only exist for 2026, but 2024-2025 has monthly/quarterly period data
        amazon: {
          dailyDataDates: unifiedBusinessMetrics.dataSources?.amazon?.dailyDates?.length || 0,
          periodDataCount: unifiedBusinessMetrics.dataSources?.amazon?.periodNames?.length || 0,
          hasDailyGaps: unifiedBusinessMetrics.dataSources?.amazon?.hasDailyGaps || false,
          gapsCoveredBy: unifiedBusinessMetrics.dataSources?.amazon?.gapsCoveredByPeriods || [],
          explanation: unifiedBusinessMetrics.dataSources?.amazon?.hasDailyGaps 
            ? 'Amazon has monthly period data for periods without daily uploads. DO NOT treat missing daily data as $0 sales.'
            : 'Amazon has daily data available.',
        },
        shopify: {
          dailyDataDates: unifiedBusinessMetrics.dataSources?.shopify?.dailyDates?.length || 0,
          periodDataCount: unifiedBusinessMetrics.dataSources?.shopify?.periodNames?.length || 0,
          hasDailyGaps: unifiedBusinessMetrics.dataSources?.shopify?.hasDailyGaps || false,
          gapsCoveredBy: unifiedBusinessMetrics.dataSources?.shopify?.gapsCoveredByPeriods || [],
        },
        // Key instruction for AI
        instructions: `
âš ï¸ CRITICAL DATA AVAILABILITY RULES:
1. Amazon daily data may not exist for all dates - we have MONTHLY period data instead
2. NEVER treat missing daily Amazon data as $0 sales - this will severely undercount revenue
3. For all-time totals, use the unifiedMetrics.allTime values which properly combine period + weekly data
4. For averages, use unifiedMetrics.averages which only calculate from days WITH data
5. When calculating trends, EXCLUDE days without data rather than counting them as $0
6. Period data (monthly/quarterly) is AUTHORITATIVE for historical totals

ðŸ“Š DATA SOURCES HIERARCHY:
- For 2024: Use quarterly period data (most accurate)
- For 2025: Use monthly period data (most accurate)
- For 2026: Use weekly/daily data (most current)
`,
      },
    };
  };
  
  // Send AI Message - defined at component level, not nested
  const sendAIMessage = async () => {
    if (!aiInput.trim() || aiLoading) return;
    const userMessage = aiInput.trim();
    setAiInput('');
    setAiMessages(prev => [...prev, { role: 'user', content: userMessage }]);
    setAiLoading(true);
    
    try {
      const ctx = prepareDataContext();
      
      // Build alerts summary for AI
      const alertsSummary = [];
      if (ctx.inventory?.lowStockItems?.length > 0) {
        alertsSummary.push(`LOW STOCK ALERT: ${ctx.inventory.lowStockItems.length} products need reorder (${ctx.inventory.lowStockItems.map(i => i.sku).join(', ')})`);
      }
      if (ctx.salesTax?.nexusStates?.length > 0) {
        alertsSummary.push(`Sales tax nexus in ${ctx.salesTax.nexusStates.length} states: ${ctx.salesTax.nexusStates.map(s => s.state).join(', ')}`);
      }
      
      // Channel concentration alert
      if (ctx.insights.allTimeRevenue > 0) {
        const amazonShare = ctx.weeklyData.reduce((s, w) => s + w.amazonRevenue, 0) / ctx.insights.allTimeRevenue * 100;
        if (amazonShare > 90) {
          alertsSummary.push(`CHANNEL CONCENTRATION: ${amazonShare.toFixed(0)}% of revenue from Amazon - consider diversifying`);
        }
      }
      
      // 3PL cost alert
      const ledgerOrders = Object.values(threeplLedger.orders || {});
      if (ledgerOrders.length > 100) {
        let total3PL = 0;
        ledgerOrders.forEach(o => {
          const c = o.charges || {};
          total3PL += (c.firstPick || 0) + (c.additionalPick || 0) + (c.box || 0);
        });
        const avgCostPerOrder = total3PL / ledgerOrders.length;
        if (avgCostPerOrder > 12) {
          alertsSummary.push(`3PL COSTS ELEVATED: Avg $${avgCostPerOrder.toFixed(2)}/order - review fulfillment efficiency`);
        }
      }
      
      // Include forecast data if available (use enhanced if corrections active)
      const forecastData = enhancedForecast ? {
        nextMonth: enhancedForecast.monthly,
        originalNextMonth: enhancedForecast.originalMonthly,
        trend: generateForecast?.trend,
        confidence: generateForecast?.confidence,
        weekly: enhancedForecast.weekly,
        corrected: enhancedForecast.corrected,
        correctionNote: enhancedForecast.correctionNote,
        learningStatus: enhancedForecast.learningStatus,
      } : generateForecast ? {
        nextMonth: generateForecast.monthly,
        trend: generateForecast.trend,
        confidence: generateForecast.confidence,
        weekly: generateForecast.weekly
      } : null;
      
      // Include Multi-Signal AI Forecast (the most accurate forecast - same as dashboard widget)
      const multiSignalForecast = aiForecasts?.salesForecast ? {
        nextWeek: aiForecasts.salesForecast.next4Weeks?.[0] || null,
        next4Weeks: aiForecasts.salesForecast.next4Weeks || [],
        signals: aiForecasts.calculatedSignals || {},
        dataPoints: aiForecasts.dataPoints || {},
        generatedAt: aiForecasts.generatedAt,
        methodology: 'Weighted: 60% daily trends (last 7 days), 20% weekly averages, 20% Amazon forecasts (if available)',
      } : null;
      
      // Include Forecast Accuracy History (for learning from past predictions)
      const forecastAccuracy = {
        records: forecastAccuracyHistory.records?.slice(-20) || [], // Last 20 forecast vs actual comparisons
        summary: (() => {
          const records = forecastAccuracyHistory.records || [];
          if (records.length === 0) return null;
          const withActuals = records.filter(r => r.actualRevenue !== undefined);
          if (withActuals.length === 0) return { message: 'No actuals recorded yet - waiting for weeks to complete' };
          
          const avgRevenueError = withActuals.reduce((s, r) => {
            const error = r.forecastRevenue > 0 ? Math.abs(r.actualRevenue - r.forecastRevenue) / r.forecastRevenue * 100 : 0;
            return s + error;
          }, 0) / withActuals.length;
          
          const avgBias = withActuals.reduce((s, r) => {
            const bias = r.forecastRevenue > 0 ? (r.actualRevenue - r.forecastRevenue) / r.forecastRevenue * 100 : 0;
            return s + bias;
          }, 0) / withActuals.length;
          
          return {
            samplesWithActuals: withActuals.length,
            avgAccuracy: (100 - avgRevenueError).toFixed(1) + '%',
            avgBias: (avgBias > 0 ? '+' : '') + avgBias.toFixed(1) + '% (positive = forecasts too low)',
            recentTrend: withActuals.slice(-5).map(r => ({
              week: r.weekEnding,
              forecast: r.forecastRevenue,
              actual: r.actualRevenue,
              error: r.forecastRevenue > 0 ? ((r.actualRevenue - r.forecastRevenue) / r.forecastRevenue * 100).toFixed(1) + '%' : 'N/A'
            }))
          };
        })(),
      };
      
      // Include week notes
      const notesData = Object.entries(weekNotes).filter(([k, v]) => v).map(([week, note]) => ({ week, note }));
      
      const systemPrompt = `You are an expert e-commerce analyst and business advisor for "${ctx.storeName}". You have access to ALL uploaded sales data and can answer questions about any aspect of the business.

ðŸš¨ðŸš¨ðŸš¨ CRITICAL DATA AVAILABILITY RULES - READ FIRST ðŸš¨ðŸš¨ðŸš¨

${ctx.dataAvailability?.instructions || ''}

**DATA AVAILABILITY STATUS:**
- Amazon: ${ctx.dataAvailability?.amazon?.dailyDataDates || 0} days of daily data, ${ctx.dataAvailability?.amazon?.periodDataCount || 0} period records
${ctx.dataAvailability?.amazon?.hasDailyGaps ? `  âš ï¸ GAPS COVERED BY: ${ctx.dataAvailability.amazon.gapsCoveredBy?.join(', ') || 'monthly data'}` : ''}
- Shopify: ${ctx.dataAvailability?.shopify?.dailyDataDates || 0} days of daily data

**UNIFIED ALL-TIME TOTALS (USE THESE - includes period data):**
${ctx.unifiedMetrics ? `
- Amazon Revenue: $${ctx.unifiedMetrics.allTime?.amazon?.revenue?.toFixed(2) || 0}
- Shopify Revenue: $${ctx.unifiedMetrics.allTime?.shopify?.revenue?.toFixed(2) || 0}
- TOTAL Revenue: $${ctx.unifiedMetrics.allTime?.total?.revenue?.toFixed(2) || 0}
- TOTAL Profit: $${ctx.unifiedMetrics.allTime?.total?.profit?.toFixed(2) || 0}

By Year:
${Object.entries(ctx.unifiedMetrics.byYear || {}).map(([year, data]) => 
  `  ${year}: Amazon $${data.amazon?.revenue?.toFixed(0) || 0} | Shopify $${data.shopify?.revenue?.toFixed(0) || 0} | Total $${data.total?.revenue?.toFixed(0) || 0}`
).join('\n')}

Proper Averages (only from days WITH data):
- Daily Avg Revenue: $${ctx.unifiedMetrics.averages?.dailyRevenue?.total?.toFixed(2) || 0} (from ${ctx.unifiedMetrics.averages?.dailyRevenue?.daysUsed || 0} days with actual data)
- Weekly Avg Revenue: $${ctx.unifiedMetrics.averages?.weeklyRevenue?.total?.toFixed(2) || 0} (from ${ctx.unifiedMetrics.averages?.weeklyRevenue?.weeksUsed || 0} weeks)
- Monthly Avg Revenue: $${ctx.unifiedMetrics.averages?.monthlyRevenue?.total?.toFixed(2) || 0} (from ${ctx.unifiedMetrics.averages?.monthlyRevenue?.monthsUsed || 0} months)
` : 'Unified metrics not available'}

ðŸš¨ðŸš¨ðŸš¨ TIMEFRAME QUERIES - USE PRE-COMPUTED DATA ðŸš¨ðŸš¨ðŸš¨
When user asks about a TIMEFRAME (last week, last month, etc.) you MUST use the PRE-COMPUTED data below.
DO NOT use skuAnalysis - that's ALL-TIME data and will give WRONG answers for timeframe questions!

| User asks about... | ONLY USE THIS DATA |
|-------------------|-------------------|
| "last week" | lastWeekByCategory (below) |
| "last 2 weeks" | last2WeeksByCategory (below) |
| "last month" / "last 4 weeks" | last4WeeksByCategory (below) |
| "all time" / "total" | allTimeByCategory (below) |

For category questions (e.g., "how much lip balm last week?"):
â†’ Look up: lastWeekByCategory.byCategory["Lip Balm"]
â†’ The data includes: units, revenue, profit, margin

â›” NEVER use skuAnalysis for timeframe questions - it contains ALL-TIME totals
â›” NEVER sum from skuByWeek array - those are historical weeks
â›” NEVER treat missing Amazon daily data as $0 - use period data instead
âœ… ALWAYS use the pre-computed byCategory data for the matching timeframe
âœ… ALWAYS use unifiedMetrics for all-time totals (includes Amazon 2025 period data)

IMPORTANT PROFIT CALCULATION NOTES:
- Amazon "Net Proceeds" IS the profit - it already has COGS, fees, and ad spend deducted
- Shopify profit = Net Sales - COGS (discounts already deducted from Net Sales)
- Do NOT double-count COGS or ad spend when calculating Amazon profit

STORE: ${ctx.storeName}
DATA RANGE: ${ctx.dataRange.weeksTracked} weeks tracked (${ctx.dataRange.oldestWeek || 'N/A'} to ${ctx.dataRange.newestWeek || 'N/A'})

=== KEY METRICS (All Time) ===
- Total Revenue: $${ctx.insights.allTimeRevenue.toFixed(2)}
- Total Profit: $${ctx.insights.allTimeProfit.toFixed(2)}
- Total Units Sold: ${ctx.insights.allTimeUnits}
- Overall Margin: ${ctx.insights.overallMargin.toFixed(1)}%
- Avg Profit/Unit: $${ctx.insights.overallProfitPerUnit.toFixed(2)}
- Avg Weekly Revenue: $${ctx.insights.avgWeeklyRevenue.toFixed(2)}
- Avg Weekly Profit: $${ctx.insights.avgWeeklyProfit.toFixed(2)}
- Avg Daily Revenue: $${ctx.insights.avgDailyRevenue?.toFixed(2) || 0}
- Avg Daily Profit: $${ctx.insights.avgDailyProfit?.toFixed(2) || 0}

=== DAILY DATA (Last 14 days for granular analysis) ===
${ctx.dailyData?.length > 0 ? `
Days tracked: ${ctx.dataRange.daysTracked}
Recent daily trend (last 7 days vs prior 7 days): ${ctx.dailyTrend?.toFixed(1) || 0}%
${JSON.stringify(ctx.dailyData)}
` : 'No daily data uploaded yet'}

=== DAY-OF-WEEK PATTERNS (AI Learning) ===
${ctx.dayOfWeekPatterns && Object.keys(ctx.dayOfWeekPatterns).length > 0 ? `
Best performing days and average revenue/profit by day of week:
${JSON.stringify(ctx.dayOfWeekPatterns)}
Use this to identify optimal days for promotions, ad spend, and inventory planning.
` : 'Not enough daily data for day-of-week analysis'}

=== RECENT TREND (Last 4 weeks vs Prior 4 weeks) ===
- Recent Revenue: $${ctx.insights.recentVsPrior.recentRevenue.toFixed(2)}
- Prior Revenue: $${ctx.insights.recentVsPrior.priorRevenue.toFixed(2)}
- Revenue Change: ${ctx.insights.recentVsPrior.revenueChange.toFixed(1)}%
- Recent Profit: $${ctx.insights.recentVsPrior.recentProfit.toFixed(2)}
- Prior Profit: $${ctx.insights.recentVsPrior.priorProfit.toFixed(2)}
- Profit Change: ${ctx.insights.recentVsPrior.profitChange.toFixed(1)}%

=== FORECAST (Next 4 Weeks Projection) ===
${forecastData ? `
- Projected Monthly Revenue: $${forecastData.nextMonth.revenue.toFixed(2)}
- Projected Monthly Profit: $${forecastData.nextMonth.profit.toFixed(2)}
- Projected Monthly Units: ${forecastData.nextMonth.units}
- Trend Direction: ${forecastData.trend.revenue} (${forecastData.trend.revenueChange.toFixed(1)}% per week)
- Forecast Confidence: ${forecastData.confidence}%
- Weekly Projections: ${JSON.stringify(forecastData.weekly)}
` : 'Not enough data for forecast (need 4+ weeks)'}

=== ðŸ§  MULTI-SIGNAL AI FORECAST (PRIMARY - Use this for predictions) ===
${multiSignalForecast ? `
This is the most accurate forecast - it's the same one shown on the dashboard widget.

**NEXT WEEK PREDICTION:**
- Revenue: $${multiSignalForecast.nextWeek?.predictedRevenue?.toFixed(2) || 0}
- Profit: $${multiSignalForecast.nextWeek?.predictedProfit?.toFixed(2) || 0}
- Units: ${multiSignalForecast.nextWeek?.predictedUnits || 0}
- Confidence: ${multiSignalForecast.nextWeek?.confidence || 'N/A'}

**4-WEEK OUTLOOK:**
${JSON.stringify(multiSignalForecast.next4Weeks)}

**SIGNALS USED:**
- Daily Average (7 days): $${multiSignalForecast.signals.dailyAvg7?.toFixed(2) || 0}/day
- Momentum (7d vs prior 7d): ${multiSignalForecast.signals.momentum?.toFixed(1) || 0}%
- Profit Margin: ${((multiSignalForecast.signals.avgProfitMargin || 0) * 100).toFixed(1)}%

**DATA SOURCES:**
- Daily data points: ${multiSignalForecast.dataPoints.dailyDays || multiSignalForecast.dataPoints.daysAnalyzed || 0} days
- Weekly data points: ${multiSignalForecast.dataPoints.weeklyWeeks || multiSignalForecast.dataPoints.weeksAnalyzed || 0} weeks  
- Amazon forecasts: ${multiSignalForecast.dataPoints.amazonForecastWeeks || 0} weeks

**METHODOLOGY:** ${multiSignalForecast.methodology}

Last updated: ${multiSignalForecast.generatedAt || 'Not yet generated'}
` : 'Multi-Signal forecast not yet generated. User should click "Refresh Forecast" on dashboard.'}

=== ðŸ“Š FORECAST ACCURACY LEARNING (Compare predictions to actuals) ===
${forecastAccuracy.summary ? `
**ACCURACY SUMMARY (from past forecasts vs actuals):**
- Samples with actual data: ${forecastAccuracy.summary.samplesWithActuals || 0}
- Average Accuracy: ${forecastAccuracy.summary.avgAccuracy || 'N/A'}
- Bias: ${forecastAccuracy.summary.avgBias || 'N/A'}

**RECENT FORECAST vs ACTUAL COMPARISONS:**
${forecastAccuracy.summary.recentTrend ? JSON.stringify(forecastAccuracy.summary.recentTrend, null, 2) : 'No recent comparisons yet'}

âš ï¸ LEARNING INSTRUCTIONS:
- If bias is consistently positive (actuals > forecast), predictions are too conservative - adjust up
- If bias is consistently negative (actuals < forecast), predictions are too optimistic - adjust down
- Use the accuracy % to determine confidence level in your predictions
- Factor in the specific error patterns when making new predictions
` : 'No forecast accuracy data yet. As weeks complete and actuals are uploaded, I will learn from prediction errors.'}

**FULL ACCURACY HISTORY (last 20 records):**
${forecastAccuracy.records.length > 0 ? JSON.stringify(forecastAccuracy.records.slice(-10)) : 'No records yet'}

=== GOALS ===
- Weekly Revenue Target: $${ctx.goals.weeklyRevenue || 0}
- Weekly Profit Target: $${ctx.goals.weeklyProfit || 0}
- Monthly Revenue Target: $${ctx.goals.monthlyRevenue || 0}
- Monthly Profit Target: $${ctx.goals.monthlyProfit || 0}
${ctx.goals.weeklyRevenue > 0 && ctx.weeklyData.length > 0 ? `- Last Week vs Goal: ${ctx.weeklyData[ctx.weeklyData.length-1]?.totalRevenue >= ctx.goals.weeklyRevenue ? 'MET' : 'MISSED'}` : ''}

=== ALERTS ===
${alertsSummary.length > 0 ? alertsSummary.join('\n') : 'No active alerts'}

=== PRODUCT CATALOG (SKU â†” Product Name mapping) ===
Use this to translate between product names and SKUs:
${JSON.stringify(ctx.productCatalog)}

=== QUICK LOOKUP: Product Names â†’ SKUs ===
${ctx.productCatalog?.slice(0, 15).map(p => `"${p.name.substring(0, 40)}..." â†’ ${p.sku} [${p.category}]`).join('\n') || 'No catalog'}

=== SKUs BY CATEGORY (for category queries) ===
${Object.entries(ctx.skusByCategory || {}).map(([cat, skus]) => `${cat}: ${skus.join(', ')}`).join('\n') || 'No categories'}

=== ðŸ“¦ SKU MASTER DATA (PRIMARY DATA SOURCE - USE THIS) ===
IMPORTANT: This is the authoritative SKU-level data. Use SKUs as the primary identifier for all analysis.

**TOP 20 SKUs BY REVENUE (all-time across periods + weeks):**
${ctx.skuMasterData?.slice(0, 20).map(s => 
  `${s.sku}: "${s.name}" [${s.category}] - $${s.totalRevenue.toFixed(0)} rev, ${s.totalUnits} units`
).join('\n') || 'No SKU data'}

**SKU BREAKDOWN BY 2025 MONTH:**
${(() => {
  const byMonth = {};
  ctx.skuMasterData?.forEach(s => {
    Object.entries(s.byPeriod || {}).forEach(([period, data]) => {
      if (!byMonth[period]) byMonth[period] = [];
      if (data.revenue > 0) byMonth[period].push({ sku: s.sku, name: s.name, category: s.category, revenue: data.revenue, units: data.units });
    });
  });
  return Object.entries(byMonth)
    .filter(([p]) => p.includes('2025') || p.includes('-2025'))
    .sort(([a], [b]) => a.localeCompare(b))
    .slice(0, 6)
    .map(([period, skus]) => {
      const top3 = skus.sort((a, b) => b.revenue - a.revenue).slice(0, 3);
      return `${period}: ${top3.map(s => `${s.sku}=$${s.revenue.toFixed(0)}`).join(', ')}`;
    }).join('\n') || 'No period data';
})()}

**CATEGORY TOTALS FROM SKU DATA:**
${(() => {
  const cats = {};
  ctx.skuMasterData?.forEach(s => {
    if (!cats[s.category]) cats[s.category] = { revenue: 0, units: 0, skuCount: 0 };
    cats[s.category].revenue += s.totalRevenue;
    cats[s.category].units += s.totalUnits;
    cats[s.category].skuCount++;
  });
  return Object.entries(cats)
    .sort(([,a], [,b]) => b.revenue - a.revenue)
    .map(([cat, d]) => `${cat}: $${d.revenue.toFixed(0)} revenue, ${d.units} units (${d.skuCount} SKUs)`)
    .join('\n') || 'No category data';
})()}

ðŸ”‘ SKU-CENTRIC ANALYSIS RULES:
- ALWAYS use SKU codes (e.g., DDPE0004Shop) as primary identifiers
- Look up product names from productCatalog when needed for display
- For category questions, find SKUs in that category and sum their data
- For period questions, use skuMasterData[x].byPeriod[period]
- For week questions, use skuMasterData[x].byWeek[week]

=== ðŸŽ¯ðŸŽ¯ðŸŽ¯ PRE-COMPUTED TIMEFRAME DATA - USE THIS FOR TIMEFRAME QUESTIONS ðŸŽ¯ðŸŽ¯ðŸŽ¯ ===

**LAST WEEK (${ctx.lastWeekByCategory?.weekLabel || 'No data'}):** â† USE THIS FOR "last week" questions
${ctx.lastWeekByCategory ? `
Week: ${ctx.lastWeekByCategory.weekEnding}
Total Revenue: $${ctx.lastWeekByCategory.totalRevenue.toFixed(2)}
Total Profit: $${ctx.lastWeekByCategory.totalProfit.toFixed(2)}
Total Units: ${ctx.lastWeekByCategory.totalUnits}
BY CATEGORY: ${JSON.stringify(ctx.lastWeekByCategory.byCategory)}
` : 'No data'}

**LAST 2 WEEKS (${ctx.last2WeeksByCategory?.dateRange || 'No data'}):** â† USE THIS FOR "last 2 weeks" questions
${ctx.last2WeeksByCategory ? `
Weeks included: ${ctx.last2WeeksByCategory.weeks?.join(', ')}
Total Revenue: $${ctx.last2WeeksByCategory.totalRevenue.toFixed(2)}
Total Profit: $${ctx.last2WeeksByCategory.totalProfit.toFixed(2)}
Total Units: ${ctx.last2WeeksByCategory.totalUnits}
BY CATEGORY: ${JSON.stringify(ctx.last2WeeksByCategory.byCategory)}
` : 'No data'}

**LAST 4 WEEKS / LAST MONTH (${ctx.last4WeeksByCategory?.dateRange || 'No data'}):** â† USE THIS FOR "last month" questions
${ctx.last4WeeksByCategory ? `
Weeks included: ${ctx.last4WeeksByCategory.weeks?.join(', ')}
Total Revenue: $${ctx.last4WeeksByCategory.totalRevenue.toFixed(2)}
Total Profit: $${ctx.last4WeeksByCategory.totalProfit.toFixed(2)}
Total Units: ${ctx.last4WeeksByCategory.totalUnits}
BY CATEGORY: ${JSON.stringify(ctx.last4WeeksByCategory.byCategory)}
` : 'No data'}

**ALL TIME (${ctx.allTimeByCategory?.weeks || 0} weeks):** â† USE THIS FOR "all time/total" questions
${ctx.allTimeByCategory ? `
Total Revenue: $${ctx.allTimeByCategory.totalRevenue.toFixed(2)}
Total Profit: $${ctx.allTimeByCategory.totalProfit.toFixed(2)}
Total Units: ${ctx.allTimeByCategory.totalUnits}
BY CATEGORY: ${JSON.stringify(ctx.allTimeByCategory.byCategory)}
` : 'No data'}

âš ï¸ REMINDER: For "how much X sold last week" â†’ use lastWeekByCategory.byCategory["X"]
âš ï¸ DO NOT use skuAnalysis below - that is ALL-TIME data!

ðŸ—“ï¸ FOR HISTORICAL QUESTIONS (2025 monthly, 2024 quarterly):
- "How did we do in January 2025?" â†’ Use PERIOD DATA section above
- "What was Q3 2024 revenue?" â†’ Use PERIOD DATA section above
- "Compare 2024 vs 2025" â†’ Use YoY INSIGHTS + PERIOD DATA
- The period data contains monthly 2025 totals and quarterly 2024 totals

ðŸ·ï¸ FOR CATEGORY QUESTIONS (e.g., "how much lip balm sold?"):
- User says category name â†’ Find SKUs: skusByCategory["Lip Balm"] = ["DDPE0001Shop", "DDPE0002Shop", ...]
- Sum data from skuMasterData for each of those SKUs
- Show breakdown by SKU in response: "DDPE0001Shop (Unscented): $X, DDPE0002Shop (Peppermint): $Y..."

ðŸ“¦ FOR SPECIFIC PRODUCT QUESTIONS (e.g., "how did assorted pack do?" or "DDPE0004Shop sales"):
- If SKU given â†’ Look up directly in skuMasterData
- If product name given â†’ Search productCatalog for match â†’ Get SKU â†’ Look up in skuMasterData
- Show: "DDPE0004Shop (Grass-Fed Tallow Lip Balm 3-Pack â€“ Assorted): $285,000 total, 21,000 units"

ðŸ—“ï¸ FOR PERIOD QUESTIONS (e.g., "lip balm in January 2025"):
- Resolve product/category to SKUs first
- Then look up each SKU's byPeriod["january-2025"] data
- Sum and display with SKU breakdown

ðŸ”‘ REMEMBER: Internally always use SKUs - they're unique identifiers. Product names are for user-friendly display.

=== WEEKLY DATA (most recent 12 weeks) ===
${JSON.stringify(ctx.weeklyData.slice().reverse().slice(0, 12))}

=== PERIOD DATA (Quarterly/Monthly/Yearly Historical) ===
${ctx.periodData.length > 0 ? `Total periods tracked: ${ctx.periodData.filter(p => p.totalRevenue > 0).length} (with data)

ðŸ“… 2025 MONTHLY TOTALS:
${ctx.periodData.filter(p => (p.period.includes('2025') || p.period.includes('-2025')) && p.type === 'monthly' && p.totalRevenue > 0).map(p => 
  `${p.period}: $${p.totalRevenue.toFixed(0)} rev, ${p.totalUnits} units, ${p.margin.toFixed(1)}% margin`
).join('\n') || 'No 2025 monthly periods'}

ðŸ“… 2024 QUARTERLY TOTALS:
${ctx.periodData.filter(p => (p.period.includes('2024') || p.period.includes('-2024')) && p.type === 'quarterly' && p.totalRevenue > 0).map(p => 
  `${p.period}: $${p.totalRevenue.toFixed(0)} rev, ${p.totalUnits} units`
).join('\n') || 'No 2024 quarterly periods'}

NOTE: For SKU-level breakdown by period, use the SKU MASTER DATA section above.
` : 'No historical period data uploaded yet'}

=== YEAR-OVER-YEAR INSIGHTS ===
${ctx.yoyInsights?.length > 0 ? JSON.stringify(ctx.yoyInsights) : 'No comparable year-over-year data available yet'}

=== 2025 MONTHLY TREND ===
${ctx.monthlyTrend2025?.length > 0 ? JSON.stringify(ctx.monthlyTrend2025) : 'No 2025 monthly data'}

=== SEASONALITY INSIGHTS ===
${ctx.periodData.length > 0 ? (() => {
  const months = ctx.periodData.filter(p => p.type === 'monthly');
  if (months.length < 3) return 'Not enough monthly data for seasonality analysis';
  const sorted = [...months].sort((a, b) => b.totalRevenue - a.totalRevenue);
  const best = sorted[0];
  const worst = sorted[sorted.length - 1];
  const avgRev = months.reduce((s, m) => s + m.totalRevenue, 0) / months.length;
  return 'Best Month: ' + best.label + ' ($' + best.totalRevenue.toFixed(0) + ')\n' +
         'Worst Month: ' + worst.label + ' ($' + worst.totalRevenue.toFixed(0) + ')\n' +
         'Avg Monthly Revenue: $' + avgRev.toFixed(0) + '\n' +
         'Peak vs Avg: ' + ((best.totalRevenue / avgRev - 1) * 100).toFixed(0) + '% above average';
})() : 'No seasonality data'}

=== SEASONAL PATTERNS (AI Learning) ===
${ctx.seasonalPatterns ? `
Monthly Performance Patterns (for forecasting):
${JSON.stringify(ctx.seasonalPatterns.byMonth)}
Overall Monthly Average: $${ctx.seasonalPatterns.overallMonthlyAvg?.toFixed(0) || 0}
Strong Months (>10% above avg): ${ctx.seasonalPatterns.strongMonths?.join(', ') || 'None identified yet'}
Weak Months (<10% below avg): ${ctx.seasonalPatterns.weakMonths?.join(', ') || 'None identified yet'}

Use seasonal indices when forecasting:
- Index > 1.0 = Above average month (expect higher sales)
- Index < 1.0 = Below average month (expect lower sales)
- Apply: Expected Revenue = Base Forecast Ã— Seasonal Index
` : 'Not enough historical data for seasonal pattern analysis'}

=== DATA QUALITY & TRIANGULATION ===
${ctx.dataTriangulation ? `
Data Quality Score: ${ctx.dataTriangulation.dataQualityScore}/100
- 25 pts: 12+ weeks sales history
- 20 pts: 30+ days daily data
- 20 pts: 100+ banking transactions
- 15 pts: 10+ SKUs with COGS
- 10 pts: AI learning active (4+ samples)
- 10 pts: Amazon forecasts uploaded

Multiple Data Sources: ${ctx.dataTriangulation.hasMultipleSources ? 'YES - Can cross-validate sales vs banking' : 'NO - Limited to single source'}

${ctx.dataTriangulation.hasMultipleSources && Object.keys(ctx.dataTriangulation.salesVsBanking || {}).length > 0 ? `
Sales vs Banking Comparison (cross-validation):
${Object.entries(ctx.dataTriangulation.salesVsBanking).slice(-6).map(([month, data]) => 
  `- ${month}: Sales $${data.salesRevenue?.toFixed(0) || 0} â†’ Bank Deposits $${data.bankDeposits?.toFixed(0) || 0} (${(data.depositRatio * 100).toFixed(0)}% deposit ratio)`
).join('\n')}

Note: Deposit ratio < 100% is normal (marketplace fees taken before payout)
Typical healthy range: 70-85% for Amazon, 95-98% for Shopify
` : ''}
` : 'Data triangulation not available'}

=== WEEK NOTES (user annotations) ===
${notesData.length > 0 ? JSON.stringify(notesData) : 'No notes added'}

=== â›”â›”â›” ALL-TIME SKU DATA BELOW - DO NOT USE FOR TIMEFRAME QUESTIONS â›”â›”â›” ===
The data below is ALL-TIME totals. For "last week", "last month" etc. use the PRE-COMPUTED TIMEFRAME DATA sections above!

=== TOP SKUS BY REVENUE (ALL-TIME totals - NOT for timeframe questions) ===
${JSON.stringify(ctx.skuAnalysis.slice(0, 15))}

=== SKUS WITH DECLINING PROFITABILITY (ALL-TIME) ===
${JSON.stringify(ctx.decliningSkus)}

=== SKUS WITH IMPROVING PROFITABILITY (ALL-TIME) ===
${JSON.stringify(ctx.improvingSkus)}

=== INVENTORY STATUS ===
${ctx.inventory ? `As of ${ctx.inventory.asOfDate}: ${ctx.inventory.totalUnits} total units, $${ctx.inventory.totalValue?.toFixed(2) || 0} value` : 'No inventory data'}
${ctx.inventory?.lowStockItems?.length > 0 ? `Low stock items: ${JSON.stringify(ctx.inventory.lowStockItems)}` : ''}

=== INVENTORY FORECASTING ===
${(() => {
  // Calculate velocity and days of supply from weekly data
  const sortedWeeks = Object.keys(allWeeksData).sort().slice(-8);
  if (sortedWeeks.length < 2) return 'Not enough weekly data for inventory forecasting';
  
  const weeklyUnits = sortedWeeks.map(w => allWeeksData[w]?.total?.units || 0);
  const avgWeeklyVelocity = weeklyUnits.reduce((s, u) => s + u, 0) / weeklyUnits.length;
  
  // Get SKU-level velocity
  const skuVelocity = {};
  sortedWeeks.forEach(w => {
    const shopify = allWeeksData[w]?.shopify?.skuData || [];
    const amazon = allWeeksData[w]?.amazon?.skuData || [];
    [...shopify, ...amazon].forEach(s => {
      const sku = s.sku || s.msku;
      if (!skuVelocity[sku]) skuVelocity[sku] = [];
      skuVelocity[sku].push(s.unitsSold || s.units || 0);
    });
  });
  
  const topVelocity = Object.entries(skuVelocity)
    .map(([sku, weeks]) => ({ sku, avgPerWeek: weeks.reduce((s,u) => s+u, 0) / weeks.length }))
    .sort((a, b) => b.avgPerWeek - a.avgPerWeek)
    .slice(0, 10);
  
  return 'Avg Weekly Unit Velocity: ' + avgWeeklyVelocity.toFixed(0) + ' units/week\n' +
    'Top SKUs by Velocity: ' + JSON.stringify(topVelocity.slice(0, 5)) + '\n' +
    'Use this to calculate: Days of Supply = Current Inventory / (Weekly Velocity / 7)';
})()}

=== SALES TAX ===
${ctx.salesTax?.nexusStates?.length > 0 ? `Nexus states: ${JSON.stringify(ctx.salesTax.nexusStates)}` : 'No nexus states configured'}
Total sales tax paid all-time: $${ctx.salesTax?.totalPaidAllTime?.toFixed(2) || 0}

=== UPCOMING BILLS & INVOICES ===
${(() => {
  const unpaid = invoices.filter(i => !i.paid);
  if (unpaid.length === 0) return 'No upcoming bills';
  const total = unpaid.reduce((s, i) => s + i.amount, 0);
  return `Upcoming bills (${unpaid.length} total, $${total.toFixed(2)}):
${JSON.stringify(unpaid.map(i => ({ vendor: i.vendor, amount: i.amount, dueDate: i.dueDate, category: i.category, daysUntilDue: Math.ceil((new Date(i.dueDate) - new Date()) / (1000 * 60 * 60 * 24)) })))}`;
})()}

=== AMAZON FORECASTS (from Amazon's projections) ===
${upcomingAmazonForecasts.length > 0 ? `
Upcoming Amazon projections:
${JSON.stringify(upcomingAmazonForecasts.map(f => ({ weekEnding: f.weekEnding, projectedRevenue: f.totals?.sales || f.totalSales || 0, projectedUnits: f.totals?.units || f.totalUnits || 0, projectedProfit: f.totals?.proceeds || f.totalProceeds || 0, skuCount: f.skuCount || 0 })))}
` : 'No upcoming Amazon forecasts uploaded'}

${getAmazonForecastComparison.length > 0 ? `
Forecast vs Actual Accuracy (Amazon) - ${getAmazonForecastComparison.length} weeks tracked:
${JSON.stringify(getAmazonForecastComparison.slice(0, 8).map(c => ({ 
  week: c.weekEnding, 
  forecastRev: c.forecast.revenue, 
  actualRev: c.actual.revenue, 
  variance: c.variance.revenuePercent.toFixed(1) + '%',
  accuracy: c.accuracy.toFixed(1) + '%',
  status: c.status 
})))}
` : ''}

${forecastAccuracyMetrics ? `
FORECAST ACCURACY INSIGHTS:
- Overall Accuracy: ${forecastAccuracyMetrics.avgAccuracy.toFixed(1)}% (based on ${forecastAccuracyMetrics.totalWeeks} weeks)
- Beat forecast ${forecastAccuracyMetrics.beatCount} times, Missed ${forecastAccuracyMetrics.missedCount} times
- Average Revenue Variance: ${forecastAccuracyMetrics.avgRevenueVariance > 0 ? '+' : ''}${forecastAccuracyMetrics.avgRevenueVariance.toFixed(1)}%
- Forecast Bias: ${forecastAccuracyMetrics.biasDescription}
- Recent 4-week Accuracy: ${forecastAccuracyMetrics.recentAccuracy.toFixed(1)}%
- Accuracy Trend: ${forecastAccuracyMetrics.accuracyTrend > 0 ? 'Improving' : forecastAccuracyMetrics.accuracyTrend < 0 ? 'Declining' : 'Stable'} (${forecastAccuracyMetrics.accuracyTrend > 0 ? '+' : ''}${forecastAccuracyMetrics.accuracyTrend.toFixed(1)}%)
${forecastAccuracyMetrics.bestWeek ? `- Best Predicted Week: ${forecastAccuracyMetrics.bestWeek.weekEnding} (${forecastAccuracyMetrics.bestWeek.accuracy.toFixed(1)}% accurate)` : ''}
${forecastAccuracyMetrics.worstWeek ? `- Worst Predicted Week: ${forecastAccuracyMetrics.worstWeek.weekEnding} (${forecastAccuracyMetrics.worstWeek.accuracy.toFixed(1)}% accurate)` : ''}
` : ''}

${mlTrainingData ? `
ML CORRECTION MODEL (based on ${mlTrainingData.summary.totalSamples} samples):
- Amazon Bias: ${mlTrainingData.summary.bias > 0 ? 'Under-forecasts' : 'Over-forecasts'} by ${Math.abs(mlTrainingData.summary.bias).toFixed(1)}% on average
- Correction Factor: ${mlTrainingData.summary.correctionFactor.toFixed(3)}x (multiply Amazon forecast by this)
- Prediction Variance: Â±${mlTrainingData.summary.stdDev.toFixed(1)}%
- When user asks about expected revenue, apply correction: Amazon Forecast Ã— ${mlTrainingData.summary.correctionFactor.toFixed(3)} = Adjusted Forecast
` : ''}

${forecastCorrections.samplesUsed >= 2 ? `
SELF-LEARNING FORECAST SYSTEM:
- Learning Status: ${forecastCorrections.confidence >= 30 ? 'ACTIVE' : 'TRAINING'} (${forecastCorrections.confidence.toFixed(0)}% confidence)
- Samples Used: ${forecastCorrections.samplesUsed} weeks of forecast-vs-actual comparisons
- Revenue Correction Factor: ${forecastCorrections.overall.revenue.toFixed(3)}x
- Units Correction Factor: ${forecastCorrections.overall.units.toFixed(3)}x  
- Profit Correction Factor: ${forecastCorrections.overall.profit.toFixed(3)}x
- SKUs with Custom Corrections: ${Object.keys(forecastCorrections.bySku).length}
- Last Updated: ${forecastCorrections.lastUpdated || 'Never'}
- Note: When confidence >= 30%, forecasts are auto-adjusted using learned corrections
` : `
SELF-LEARNING FORECAST SYSTEM:
- Status: COLLECTING DATA (need more samples)
- Current Samples: ${forecastCorrections.samplesUsed}
- Required: At least 2 weeks of forecast-vs-actual comparisons
- To enable: Upload Amazon forecasts BEFORE week ends, then upload actual sales AFTER week ends
`}

${pendingForecasts.length > 0 ? `
PENDING FORECASTS (awaiting actual data):
${pendingForecasts.map(pf => `- Week ${pf.weekEnding}: ${(pf.forecast.totals?.sales || pf.forecast.totalSales || 0).toFixed(0)} forecasted (${pf.isPast ? 'PAST - needs actuals uploaded' : pf.daysUntil + ' days until week ends'})`).join('\n')}
` : ''}

=== PRODUCTION PIPELINE (incoming inventory) ===
${productionPipeline.length > 0 ? `
${productionPipeline.length} production orders in pipeline (${formatNumber(productionPipeline.reduce((s, p) => s + (p.quantity || 0), 0))} total units):
${JSON.stringify(productionPipeline.map(p => ({ 
  sku: p.sku, 
  product: p.productName, 
  quantity: p.quantity, 
  expectedDate: p.expectedDate, 
  status: p.status,
  daysUntil: p.expectedDate ? Math.ceil((new Date(p.expectedDate) - new Date()) / (1000 * 60 * 60 * 24)) : null
})))}
` : 'No production orders in pipeline'}

=== 3PL FULFILLMENT COSTS ===
${(() => {
  const ledgerOrders = Object.values(threeplLedger.orders || {});
  if (ledgerOrders.length === 0) return 'No 3PL data uploaded yet';
  
  // Calculate totals from ledger
  const allWeeks = [...new Set(ledgerOrders.map(o => o.weekKey))].sort();
  const totalOrders = ledgerOrders.length;
  let totalCost = 0;
  let totalUnits = 0;
  
  ledgerOrders.forEach(o => {
    const c = o.charges || {};
    totalCost += (c.firstPick || 0) + (c.additionalPick || 0) + (c.box || 0) + (c.reBoxing || 0) + (c.fbaForwarding || 0);
    totalUnits += (c.firstPickQty || 0) + (c.additionalPickQty || 0);
  });
  
  // Get summary charges (storage, shipping, etc.)
  Object.values(threeplLedger.summaryCharges || {}).forEach(c => {
    totalCost += c.amount || 0;
  });
  
  // Recent weeks data
  const recentWeeks = allWeeks.slice(-8);
  const weeklyTotals = recentWeeks.map(w => {
    const weekOrders = ledgerOrders.filter(o => o.weekKey === w);
    let weekCost = 0;
    weekOrders.forEach(o => {
      const c = o.charges || {};
      weekCost += (c.firstPick || 0) + (c.additionalPick || 0) + (c.box || 0);
    });
    return { week: w, orders: weekOrders.length, cost: weekCost };
  });
  
  // Calculate trend
  const avgCostPerOrder = totalOrders > 0 ? totalCost / totalOrders : 0;
  
  return '3PL Summary (from bulk uploads):\n' +
    '- Total Orders Tracked: ' + totalOrders + '\n' +
    '- Total 3PL Cost: $' + totalCost.toFixed(2) + '\n' +
    '- Avg Cost Per Order: $' + avgCostPerOrder.toFixed(2) + '\n' +
    '- Total Units Shipped: ' + totalUnits + '\n' +
    '- Weeks with Data: ' + allWeeks.length + ' (' + (allWeeks[0] || 'N/A') + ' to ' + (allWeeks[allWeeks.length-1] || 'N/A') + ')\n\n' +
    'Recent Weekly 3PL Costs:\n' + JSON.stringify(weeklyTotals) + '\n\n' +
    'LOOK FOR:\n' +
    '- Rising avg cost per order (margin erosion)\n' +
    '- Storage cost spikes\n' +
    '- Shipping cost increases\n' +
    '- Changes in units per order affecting fulfillment efficiency';
})()}

=== FORECAST DIVERGENCE ANALYSIS ===
${(() => {
  // Compare our projection vs Amazon's forecast
  const upcomingAmazon = Object.entries(amazonForecasts)
    .filter(([weekKey]) => new Date(weekKey) > new Date())
    .sort((a, b) => a[0].localeCompare(b[0]));
  
  if (upcomingAmazon.length === 0) return 'No upcoming Amazon forecasts to compare';
  
  const sortedWeeks = Object.keys(allWeeksData).sort();
  if (sortedWeeks.length === 0) return 'No historical data for our projection';
  
  const weeklyRevenues = sortedWeeks.map(w => allWeeksData[w]?.total?.revenue || 0);
  const ourAvg = weeklyRevenues.reduce((s, v) => s + v, 0) / weeklyRevenues.length;
  
  let analysis = 'FORECAST COMPARISON:\n';
  upcomingAmazon.slice(0, 4).forEach(([weekKey, forecast]) => {
    const amazonProjected = forecast.totals?.sales || 0;
    const divergence = ourAvg > 0 ? ((amazonProjected - ourAvg) / ourAvg * 100) : 0;
    const direction = divergence > 10 ? 'ðŸ“ˆ ABOVE' : divergence < -10 ? 'ðŸ“‰ BELOW' : 'â‰ˆ ALIGNED';
    analysis += `Week ${weekKey}: Amazon=$${amazonProjected.toFixed(0)} vs Our Avg=$${ourAvg.toFixed(0)} â†’ ${direction} (${divergence > 0 ? '+' : ''}${divergence.toFixed(0)}%)\n`;
  });
  
  // Add recommendation
  const firstAmazon = upcomingAmazon[0]?.[1]?.totals?.sales || 0;
  const divergence = ourAvg > 0 ? ((firstAmazon - ourAvg) / ourAvg * 100) : 0;
  if (divergence > 20) {
    analysis += '\nâš ï¸ SIGNIFICANT DIVERGENCE: Amazon forecasts much higher than historical average. Could indicate upcoming demand surge OR Amazon being optimistic.';
  } else if (divergence < -20) {
    analysis += '\nâš ï¸ SIGNIFICANT DIVERGENCE: Amazon forecasts lower than historical average. Could indicate demand slowdown OR seasonality adjustment.';
  } else {
    analysis += '\nForecasts are reasonably aligned.';
  }
  
  return analysis;
})()}

=== FORECAST UPLOAD STATUS ===
${(() => {
  const uploads = forecastMeta?.lastUploads || {};
  const status = [];
  ['7day', '30day', '60day'].forEach(type => {
    const last = uploads[type];
    if (last) {
      const days = Math.floor((new Date() - new Date(last)) / (1000 * 60 * 60 * 24));
      const threshold = type === '7day' ? 7 : type === '30day' ? 30 : 60;
      const isStale = days >= threshold;
      status.push(`${type}: ${days} days ago ${isStale ? '(NEEDS REFRESH)' : ''}`);
    } else {
      status.push(`${type}: Never uploaded`);
    }
  });
  return status.join('\n');
})()}

=== AMAZON PPC CAMPAIGNS ===
${amazonCampaigns.campaigns?.length > 0 ? `
Last Updated: ${amazonCampaigns.lastUpdated ? new Date(amazonCampaigns.lastUpdated).toLocaleDateString() : 'N/A'}
Total Campaigns: ${amazonCampaigns.summary?.totalCampaigns || 0} (${amazonCampaigns.summary?.enabledCount || 0} enabled, ${amazonCampaigns.summary?.pausedCount || 0} paused)

CAMPAIGN PERFORMANCE SUMMARY:
- Total Spend: $${(amazonCampaigns.summary?.totalSpend || 0).toFixed(2)}
- Total Sales: $${(amazonCampaigns.summary?.totalSales || 0).toFixed(2)}
- Total Orders: ${amazonCampaigns.summary?.totalOrders || 0}
- ROAS: ${(amazonCampaigns.summary?.roas || 0).toFixed(2)}x
- ACOS: ${(amazonCampaigns.summary?.acos || 0).toFixed(1)}%
- Avg CPC: $${(amazonCampaigns.summary?.avgCpc || 0).toFixed(2)}
- Conversion Rate: ${(amazonCampaigns.summary?.convRate || 0).toFixed(2)}%

BY CAMPAIGN TYPE:
- Sponsored Products (SP): ${amazonCampaigns.summary?.byType?.SP?.length || 0} campaigns, $${(amazonCampaigns.summary?.byType?.SP?.reduce((s,c) => s + c.spend, 0) || 0).toFixed(0)} spend, ${((amazonCampaigns.summary?.byType?.SP?.reduce((s,c) => s + c.spend, 0) || 0) > 0 ? (amazonCampaigns.summary?.byType?.SP?.reduce((s,c) => s + c.sales, 0) / amazonCampaigns.summary?.byType?.SP?.reduce((s,c) => s + c.spend, 0)).toFixed(2) : 0)}x ROAS
- Sponsored Brands (SB): ${amazonCampaigns.summary?.byType?.SB?.length || 0} campaigns, $${(amazonCampaigns.summary?.byType?.SB?.reduce((s,c) => s + c.spend, 0) || 0).toFixed(0)} spend
- Sponsored Display (SD): ${amazonCampaigns.summary?.byType?.SD?.length || 0} campaigns, $${(amazonCampaigns.summary?.byType?.SD?.reduce((s,c) => s + c.spend, 0) || 0).toFixed(0)} spend

TOP 10 CAMPAIGNS BY SPEND:
${amazonCampaigns.campaigns?.slice().sort((a,b) => (b.spend || 0) - (a.spend || 0)).slice(0,10).map(c => 
  `- ${(c.name || 'Unknown').substring(0,50)}${(c.name || '').length > 50 ? '...' : ''}: $${(c.spend || 0).toFixed(0)} spend, $${(c.sales || 0).toFixed(0)} sales, ${(c.roas || 0).toFixed(2)}x ROAS, ${(c.acos || 0).toFixed(0)}% ACOS`
).join('\n')}

TOP 5 CAMPAIGNS BY ROAS (>$100 spend):
${amazonCampaigns.campaigns?.filter(c => c.spend > 100 && c.state === 'ENABLED').sort((a,b) => b.roas - a.roas).slice(0,5).map(c => 
  `- ${c.name.substring(0,40)}...: ${c.roas.toFixed(2)}x ROAS, $${c.spend.toFixed(0)} spend`
).join('\n') || 'No qualifying campaigns'}

CAMPAIGNS NEEDING ATTENTION (Low ROAS, >$100 spend):
${amazonCampaigns.campaigns?.filter(c => c.spend > 100 && c.roas < 2 && c.state === 'ENABLED').sort((a,b) => a.roas - b.roas).slice(0,5).map(c => 
  `- ${c.name.substring(0,40)}...: ${c.roas.toFixed(2)}x ROAS, ${c.acos.toFixed(0)}% ACOS - consider pausing or optimizing`
).join('\n') || 'All campaigns performing adequately'}

${amazonCampaigns.history?.length > 1 ? `
WEEK-OVER-WEEK TREND (${amazonCampaigns.history.length} weeks tracked):
${(() => {
  const current = amazonCampaigns.history[0]?.summary;
  const prior = amazonCampaigns.history[1]?.summary;
  if (!current || !prior) return 'Insufficient history';
  const spendChange = prior.totalSpend > 0 ? ((current.totalSpend - prior.totalSpend) / prior.totalSpend * 100) : 0;
  const salesChange = prior.totalSales > 0 ? ((current.totalSales - prior.totalSales) / prior.totalSales * 100) : 0;
  const roasChange = current.roas - prior.roas;
  return `Spend: $${current.totalSpend.toFixed(0)} (${spendChange >= 0 ? '+' : ''}${spendChange.toFixed(1)}% WoW)
Sales: $${current.totalSales.toFixed(0)} (${salesChange >= 0 ? '+' : ''}${salesChange.toFixed(1)}% WoW)
ROAS: ${current.roas.toFixed(2)}x (${roasChange >= 0 ? '+' : ''}${roasChange.toFixed(2)} WoW)`;
})()}
` : ''}
` : 'No Amazon campaign data uploaded yet. User can upload Amazon Ads campaign report CSV.'}

=== AI LEARNING STATUS ===
${ctx.aiLearning ? `
Forecast Correction Factors (learned from comparing predictions to actuals):
- Revenue Multiplier: ${ctx.aiLearning.forecastCorrections.revenueMultiplier.toFixed(3)}x
- Units Multiplier: ${ctx.aiLearning.forecastCorrections.unitsMultiplier.toFixed(3)}x
- Learning Confidence: ${ctx.aiLearning.forecastCorrections.confidence.toFixed(0)}%
- Samples Used: ${ctx.aiLearning.forecastCorrections.samplesUsed}

Prediction History:
- Total Predictions Made: ${ctx.aiLearning.predictionHistory.totalPredictions}
- Verified with Actuals: ${ctx.aiLearning.predictionHistory.verifiedPredictions}
- Recent Accuracy: ${ctx.aiLearning.predictionHistory.recentAccuracy ? ctx.aiLearning.predictionHistory.recentAccuracy.toFixed(1) + '%' : 'Still learning'}

${ctx.aiLearning.recentPredictions.length > 0 ? `Recent Predictions vs Actuals:
${ctx.aiLearning.recentPredictions.map(p => 
  `- ${p.type} (${p.period}): Predicted $${p.predicted?.toFixed(0) || 'N/A'}, Actual $${p.actual?.toFixed(0) || 'pending'}, Error: ${p.error ? p.error.toFixed(1) + '%' : 'awaiting actual'}`
).join('\n')}` : 'No predictions tracked yet'}

USE THIS LEARNING: When forecasting, apply the correction factors if confidence > 30%. This helps adjust for systematic biases in predictions.
` : 'AI Learning not yet initialized'}

=== WHAT YOU CAN HELP WITH ===
- Analyze sales trends and patterns (weekly, monthly, quarterly, yearly)
- Year-over-year comparisons (2024 vs 2025, Q1 vs Q1, etc.)
- Quarterly and monthly trend analysis
- Compare performance across weeks, months, quarters, years, products
- Identify best/worst performing SKUs and their trends over time
- Track progress toward goals
- Explain profit margins and calculations
- Forecast future revenue based on historical trends
- Compare Amazon's projections vs actual performance
- Inventory planning recommendations
- Answer questions about specific products by name or SKU
- Provide insights on advertising effectiveness (TACOS, ROAS) and how it changes over time
- Sales tax obligations by state
- Upcoming bills and cash flow planning
- Production pipeline tracking and timing
- Seasonality analysis (which months/quarters perform best)
- Channel mix analysis (Amazon vs Shopify trends)
- Cost structure analysis (COGS, fees, ads as % of revenue over time)
- 3PL cost analysis (avg cost per order, storage trends, shipping cost changes)
- Identify rising fulfillment costs that may be eroding margins
- Compare 3PL efficiency across time periods
- Amazon PPC campaign analysis (ROAS, ACOS by campaign, top/bottom performers)
- Campaign optimization recommendations (which campaigns to pause, scale, or optimize)
- Week-over-week campaign performance changes
- Campaign type comparison (SP vs SB vs SD effectiveness)
- **BANKING/CASH FLOW ANALYSIS** - analyze real bank transactions to find waste, forecast EOY profit

=== BANKING & CASH FLOW DATA ===
${ctx.banking ? `
Banking data available from ${ctx.banking.dateRange?.start} to ${ctx.banking.dateRange?.end}
Total transactions: ${ctx.banking.transactionCount}
Last upload: ${ctx.banking.lastUpload ? new Date(ctx.banking.lastUpload).toLocaleString() : 'Unknown'}

MONTHLY CASH FLOW (last 12 months):
${ctx.banking.monthlySnapshots.map(m => 
  `- ${m.month}: Income $${m.income?.toFixed(0) || 0}, Expenses $${m.expenses?.toFixed(0) || 0}, Net $${m.net?.toFixed(0) || 0}`
).join('\n')}

TOP EXPENSE CATEGORIES:
${ctx.banking.topExpenseCategories.map((c, i) => 
  `${i + 1}. ${c.name}: $${c.total?.toFixed(0) || 0} (${c.count} transactions)`
).join('\n')}

TOP INCOME SOURCES:
${ctx.banking.topIncomeCategories.map((c, i) => 
  `${i + 1}. ${c.name}: $${c.total?.toFixed(0) || 0} (${c.count} transactions)`
).join('\n')}

ACCOUNTS:
${ctx.banking.accounts.map(a => 
  `- ${a.name}: ${a.transactions} txns, In: $${a.totalIn?.toFixed(0) || 0}, Out: $${a.totalOut?.toFixed(0) || 0}`
).join('\n')}

You can help with:
- Identifying where money is being wasted (unusual expense patterns, rising costs)
- Projecting end-of-year profit based on monthly trends
- Calculating true business profitability (income - all expenses)
- Comparing expense categories over time to find cost creep
- Analyzing cash flow patterns and forecasting cash needs
- Identifying the biggest expense drivers
` : 'No banking data uploaded yet. User can upload QBO Transaction Detail by Account CSV.'}

Format all currency as $X,XXX.XX. Be concise but thorough. Reference specific numbers when discussing trends. When comparing periods, always show the actual numbers and % change. If the user asks about data you don't have, let them know what they need to upload.

=== ðŸ§  AI LEARNING INSTRUCTIONS ===
You have access to the MULTI-SIGNAL AI FORECAST which is the most accurate forecast available. Use it as your PRIMARY source for predictions.

**PRODUCT IDENTIFICATION (CRITICAL):**
- Users may ask using EITHER product name ("lip balm", "assorted 3-pack") OR SKU ("DDPE0004Shop")
- ALWAYS resolve to SKU internally for data lookup
- When user says "lip balm" â†’ find SKUs in skusByCategory["Lip Balm"] â†’ aggregate skuMasterData for those SKUs
- When user says "DDPE0004Shop" â†’ look up directly in skuMasterData
- When user says "assorted pack" â†’ search productCatalog for matching name â†’ get SKU â†’ look up in skuMasterData
- In responses, show BOTH: "DDPE0004Shop (Assorted 3-Pack Lip Balm): $X revenue"

**FOR SKU-LEVEL ANALYSIS:**
1. Use skuMasterData as the authoritative source for all SKU data
2. Each SKU has: totalRevenue, totalUnits, byPeriod (monthly), byWeek (recent weeks)
3. For category totals, sum data from all SKUs in that category
4. For period-specific questions, use skuMasterData[sku].byPeriod["january-2025"]

**FOR PREDICTIONS:**
1. Always use the Multi-Signal AI Forecast data (if available) for weekly predictions
2. Check the FORECAST ACCURACY LEARNING section to understand how past predictions performed
3. Apply any correction bias you observe (e.g., if forecasts are consistently 5% low, adjust up 5%)
4. Consider momentum - if daily trends show acceleration/deceleration, factor this in

**FOR ANALYSIS:**
1. Cross-reference sales data with banking data when available to validate accuracy
2. Use seasonal patterns to contextualize current performance
3. Reference the day-of-week patterns for tactical recommendations

**FOR CONSISTENCY:**
1. Your predictions should align with the Multi-Signal AI Forecast shown on the dashboard
2. If asked "what will next week's revenue be?", use the Multi-Signal next week prediction
3. Be transparent about confidence levels and data quality
4. Always show SKU codes alongside product names in responses for clarity

The goal is for you to learn from the forecast vs actual comparisons over time and become increasingly accurate.`;

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          system: systemPrompt, 
          messages: [...aiMessages.map(m => ({ role: m.role, content: m.content })), { role: 'user', content: userMessage }],
          model: 'claude-sonnet-4-20250514',
        }),
      });
      
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      setAiMessages(prev => [...prev, { role: 'assistant', content: data.content?.[0]?.text || data.content || 'Sorry, I could not process that.' }]);
    } catch (error) {
      console.error('AI Chat error:', error);
      setAiMessages(prev => [...prev, { role: 'assistant', content: 'Error processing request. Check /api/chat endpoint.' }]);
    } finally {
      setAiLoading(false);
    }
  };

  // Send AI Ads Message - specialized for advertising insights only
  const sendAdsAIMessage = async () => {
    if (!adsAiInput.trim() || adsAiLoading) return;
    const userMessage = adsAiInput.trim();
    setAdsAiInput('');
    setAdsAiMessages(prev => [...prev, { role: 'user', content: userMessage }]);
    setAdsAiLoading(true);
    
    try {
      // Prepare minimal ads context to avoid timeout
      const sortedWeeks = Object.keys(allWeeksData || {}).sort();
      const sortedDays = Object.keys(allDaysData || {}).filter(d => hasDailySalesData(allDaysData[d])).sort();
      
      // Only last 4 weeks of ad spend
      const recentWeeks = sortedWeeks.slice(-4).map(w => {
        const week = allWeeksData[w];
        return {
          w: w,
          amz: Math.round(week?.amazon?.adSpend || 0),
          ggl: Math.round(week?.shopify?.googleAds || week?.shopify?.googleSpend || 0),
          meta: Math.round(week?.shopify?.metaAds || week?.shopify?.metaSpend || 0),
          rev: Math.round(week?.total?.revenue || 0),
        };
      });
      
      // Calculate totals
      const totals = recentWeeks.reduce((acc, w) => ({
        amz: acc.amz + w.amz, ggl: acc.ggl + w.ggl, meta: acc.meta + w.meta, rev: acc.rev + w.rev
      }), { amz: 0, ggl: 0, meta: 0, rev: 0 });
      const totalAds = totals.amz + totals.ggl + totals.meta;
      const tacos = totals.rev > 0 ? (totalAds / totals.rev * 100).toFixed(1) : 0;
      
      // Amazon campaign summary only (no individual campaigns to reduce size)
      const campSummary = amazonCampaigns?.summary || {};
      const hasCampaigns = (amazonCampaigns?.campaigns?.length || 0) > 0;
      
      // Top 3 and bottom 3 campaigns (names truncated)
      const campaigns = amazonCampaigns?.campaigns || [];
      const top3 = [...campaigns].filter(c => c.state === 'ENABLED' && c.roas > 0).sort((a, b) => b.roas - a.roas).slice(0, 3);
      const bottom3 = [...campaigns].filter(c => c.state === 'ENABLED' && c.spend > 50).sort((a, b) => a.roas - b.roas).slice(0, 3);
      
      const systemPrompt = `You are an e-commerce advertising analyst. Only answer ad-related questions.

AD SPEND (Last 4 weeks):
Total: $${totalAds} | Amazon: $${totals.amz} | Google: $${totals.ggl} | Meta: $${totals.meta}
Revenue: $${totals.rev} | TACOS: ${tacos}%
Weekly: ${JSON.stringify(recentWeeks)}

${hasCampaigns ? `AMAZON CAMPAIGNS (${campSummary.totalCampaigns}):
ROAS: ${(campSummary.roas||0).toFixed(2)}x | ACOS: ${(campSummary.acos||0).toFixed(1)}%
Spend: $${Math.round(campSummary.totalSpend||0)} | Sales: $${Math.round(campSummary.totalSales||0)} | Orders: ${campSummary.totalOrders||0}
Top 3: ${top3.map(c => c.name.substring(0,30) + ' ROAS:' + c.roas.toFixed(1)).join(', ')}
Worst 3: ${bottom3.map(c => c.name.substring(0,30) + ' ROAS:' + c.roas.toFixed(1)).join(', ')}` : 'No Amazon campaign data uploaded yet.'}

Data available: ${sortedWeeks.length} weeks, ${sortedDays.length} days
Be specific with numbers and suggest actionable improvements.`;

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          system: systemPrompt, 
          messages: [...adsAiMessages.map(m => ({ role: m.role, content: m.content })), { role: 'user', content: userMessage }],
          model: 'claude-sonnet-4-20250514',
        }),
      });
      
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      setAdsAiMessages(prev => [...prev, { role: 'assistant', content: data.content?.[0]?.text || data.content || 'Sorry, I could not process that.' }]);
    } catch (error) {
      console.error('Ads AI Chat error:', error);
      setAdsAiMessages(prev => [...prev, { role: 'assistant', content: `Error: ${error.message}. Try a simpler question.` }]);
    } finally {
      setAdsAiLoading(false);
    }
  };

  // Save weekly reports to localStorage
  useEffect(() => {
    localStorage.setItem(WEEKLY_REPORTS_KEY, JSON.stringify(weeklyReports));
  }, [weeklyReports]);

  // Generate Intelligence Report (weekly, monthly, quarterly, annual)
  const generateReport = async (type = 'weekly', forceRegenerate = false) => {
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const sortedPeriods = Object.keys(allPeriodsData).sort();
    const sortedDays = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort();
    
    if (sortedWeeks.length === 0 && sortedPeriods.length === 0 && sortedDays.length === 0) {
      setReportError('No data available to generate report');
      return;
    }

    let periodKey, periodLabel, periodData = null, weeksInPeriod = [], dataSource = '';
    let comparisonData = null, comparisonLabel = '';

    if (type === 'weekly') {
      if (sortedWeeks.length === 0 && sortedDays.length === 0) {
        setReportError('No weekly data available');
        return;
      }
      
      // Find the most recent COMPLETE week (with actual revenue)
      let selectedWeekIndex = sortedWeeks.length - 1;
      while (selectedWeekIndex >= 0) {
        const weekData = allWeeksData[sortedWeeks[selectedWeekIndex]];
        const weekRevenue = weekData?.total?.revenue || 0;
        if (weekRevenue > 100) { // Week has meaningful data
          break;
        }
        selectedWeekIndex--;
      }
      
      // If no complete week found, use daily data to build context
      if (selectedWeekIndex < 0) {
        // Use the most recent week key but note it's incomplete
        periodKey = sortedWeeks[sortedWeeks.length - 1] || formatDateKey(new Date());
        periodLabel = `Week ending ${periodKey} (In Progress)`;
        weeksInPeriod = [periodKey];
        dataSource = 'daily'; // Flag to use daily data
      } else {
        periodKey = sortedWeeks[selectedWeekIndex];
        periodLabel = `Week ending ${periodKey}`;
        weeksInPeriod = [periodKey];
        dataSource = 'weekly';
        // Comparison: previous complete week
        if (selectedWeekIndex > 0) {
          comparisonLabel = 'vs Previous Week';
          comparisonData = allWeeksData[sortedWeeks[selectedWeekIndex - 1]];
        }
      }
    } else if (type === 'monthly') {
      const monthPeriods = sortedPeriods.filter(p => /^\d{4}-\d{2}$/.test(p) || /^(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{4}$/i.test(p));
      const monthsFromWeeks = [...new Set(sortedWeeks.map(w => w.substring(0, 7)))].sort();
      
      if (monthPeriods.length > 0) {
        const latestMonthPeriod = monthPeriods[monthPeriods.length - 1];
        periodKey = latestMonthPeriod;
        periodLabel = latestMonthPeriod;
        periodData = allPeriodsData[latestMonthPeriod];
        dataSource = 'period';
        // Comparison: previous month or same month last year
        if (monthPeriods.length > 1) {
          comparisonLabel = 'vs Previous Month';
          comparisonData = allPeriodsData[monthPeriods[monthPeriods.length - 2]];
        }
      } else if (monthsFromWeeks.length > 0) {
        const latestMonth = monthsFromWeeks[monthsFromWeeks.length - 1];
        periodKey = latestMonth;
        const [year, month] = latestMonth.split('-');
        periodLabel = new Date(parseInt(year), parseInt(month) - 1, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        weeksInPeriod = sortedWeeks.filter(w => w.startsWith(latestMonth));
        dataSource = 'weekly';
      } else {
        setReportError('No monthly data available');
        return;
      }
    } else if (type === 'quarterly') {
      const quarterPeriods = sortedPeriods.filter(p => /Q[1-4]/i.test(p));
      
      if (quarterPeriods.length > 0) {
        const latestQuarterPeriod = quarterPeriods[quarterPeriods.length - 1];
        periodKey = latestQuarterPeriod;
        periodLabel = latestQuarterPeriod;
        periodData = allPeriodsData[latestQuarterPeriod];
        dataSource = 'period';
        // Comparison: previous quarter
        if (quarterPeriods.length > 1) {
          comparisonLabel = 'vs Previous Quarter';
          comparisonData = allPeriodsData[quarterPeriods[quarterPeriods.length - 2]];
        }
      } else if (sortedWeeks.length > 0) {
        const getQuarter = (dateStr) => Math.ceil(parseInt(dateStr.substring(5, 7)) / 3);
        const getYear = (dateStr) => dateStr.substring(0, 4);
        const quarterDataMap = {};
        sortedWeeks.forEach(w => {
          const q = `${getYear(w)}-Q${getQuarter(w)}`;
          if (!quarterDataMap[q]) quarterDataMap[q] = [];
          quarterDataMap[q].push(w);
        });
        const quarters = Object.keys(quarterDataMap).sort();
        if (quarters.length === 0) {
          setReportError('No quarterly data available');
          return;
        }
        const latestQuarter = quarters[quarters.length - 1];
        periodKey = latestQuarter;
        periodLabel = latestQuarter.replace('-', ' ');
        weeksInPeriod = quarterDataMap[latestQuarter];
        dataSource = 'weekly';
      } else {
        setReportError('No quarterly data available');
        return;
      }
    } else if (type === 'annual') {
      const yearPeriods = sortedPeriods.filter(p => /^\d{4}$/.test(p));
      const yearsFromWeeks = [...new Set(sortedWeeks.map(w => w.substring(0, 4)))].sort();
      
      if (yearPeriods.length > 0) {
        const latestYearPeriod = yearPeriods[yearPeriods.length - 1];
        periodKey = latestYearPeriod;
        periodLabel = latestYearPeriod;
        periodData = allPeriodsData[latestYearPeriod];
        dataSource = 'period';
        // Comparison: previous year
        if (yearPeriods.length > 1) {
          comparisonLabel = 'vs Previous Year';
          comparisonData = allPeriodsData[yearPeriods[yearPeriods.length - 2]];
        }
      } else if (yearsFromWeeks.length > 0) {
        const latestYear = yearsFromWeeks[yearsFromWeeks.length - 1];
        periodKey = latestYear;
        periodLabel = latestYear;
        weeksInPeriod = sortedWeeks.filter(w => w.startsWith(latestYear));
        dataSource = 'weekly';
      } else {
        setReportError('No annual data available');
        return;
      }
    }

    // Check for existing report
    const existingReport = weeklyReports[type]?.reports?.find(r => r.periodKey === periodKey);
    if (existingReport && !forceRegenerate) {
      setCurrentReport(existingReport);
      setReportType(type);
      setShowWeeklyReport(true);
      return;
    }

    setGeneratingReport(true);
    setReportError(null);
    setReportType(type);
    setShowWeeklyReport(true);

    try {
      // Build report data
      let reportData = { total: { revenue: 0, netProfit: 0, units: 0, adSpend: 0 }, amazon: { revenue: 0, netProfit: 0, adSpend: 0 }, shopify: { revenue: 0, netProfit: 0, adSpend: 0, threeplCosts: 0 } };
      
      if (dataSource === 'period' && periodData) {
        reportData.total.revenue = periodData.total?.revenue || 0;
        reportData.total.netProfit = periodData.total?.netProfit || 0;
        reportData.total.units = periodData.total?.units || 0;
        reportData.total.adSpend = periodData.total?.adSpend || 0;
        reportData.amazon.revenue = periodData.amazon?.revenue || 0;
        reportData.amazon.netProfit = periodData.amazon?.netProfit || 0;
        reportData.amazon.adSpend = periodData.amazon?.adSpend || 0;
        reportData.shopify.revenue = periodData.shopify?.revenue || 0;
        reportData.shopify.netProfit = periodData.shopify?.netProfit || 0;
        reportData.shopify.adSpend = periodData.shopify?.adSpend || 0;
        reportData.shopify.threeplCosts = periodData.shopify?.threeplCosts || 0;
      } else if (dataSource === 'daily') {
        // Use daily data when weekly data is incomplete
        const recentDays = sortedDays.slice(-7); // Last 7 days
        recentDays.forEach(d => {
          const dayData = allDaysData[d];
          if (!dayData) return;
          reportData.total.revenue += dayData.total?.revenue || 0;
          reportData.total.netProfit += dayData.total?.netProfit || 0;
          reportData.total.units += dayData.total?.units || 0;
          reportData.total.adSpend += dayData.total?.adSpend || 0;
          reportData.amazon.revenue += dayData.amazon?.revenue || 0;
          reportData.amazon.netProfit += dayData.amazon?.netProfit || 0;
          reportData.amazon.adSpend += dayData.amazon?.adSpend || 0;
          reportData.shopify.revenue += dayData.shopify?.revenue || 0;
          reportData.shopify.netProfit += dayData.shopify?.netProfit || 0;
          reportData.shopify.adSpend += dayData.shopify?.adSpend || 0;
          reportData.shopify.threeplCosts += dayData.shopify?.threeplCosts || 0;
        });
        // Update period label to reflect we're using daily data
        periodLabel = `Last ${recentDays.length} days (${recentDays[0]} to ${recentDays[recentDays.length - 1]})`;
      } else {
        weeksInPeriod.forEach(w => {
          const d = allWeeksData[w];
          if (!d) return;
          reportData.total.revenue += d.total?.revenue || 0;
          reportData.total.netProfit += d.total?.netProfit || 0;
          reportData.total.units += d.total?.units || 0;
          reportData.total.adSpend += d.total?.adSpend || 0;
          reportData.amazon.revenue += d.amazon?.revenue || 0;
          reportData.amazon.netProfit += d.amazon?.netProfit || 0;
          reportData.amazon.adSpend += d.amazon?.adSpend || 0;
          reportData.shopify.revenue += d.shopify?.revenue || 0;
          reportData.shopify.netProfit += d.shopify?.netProfit || 0;
          reportData.shopify.adSpend += d.shopify?.adSpend || 0;
          reportData.shopify.threeplCosts += d.shopify?.threeplCosts || 0;
        });
      }
      
      reportData.total.netMargin = reportData.total.revenue > 0 ? (reportData.total.netProfit / reportData.total.revenue * 100) : 0;
      reportData.total.amazonShare = reportData.total.revenue > 0 ? (reportData.amazon.revenue / reportData.total.revenue * 100) : 0;
      reportData.total.shopifyShare = reportData.total.revenue > 0 ? (reportData.shopify.revenue / reportData.total.revenue * 100) : 0;
      reportData.amazon.roas = reportData.amazon.adSpend > 0 ? (reportData.amazon.revenue / reportData.amazon.adSpend) : 0;
      reportData.shopify.roas = reportData.shopify.adSpend > 0 ? (reportData.shopify.revenue / reportData.shopify.adSpend) : 0;

      // Calculate comparison changes
      let changes = { revenue: 0, profit: 0, units: 0, margin: 0 };
      if (comparisonData) {
        const prevRev = comparisonData.total?.revenue || 0;
        const prevProfit = comparisonData.total?.netProfit || 0;
        const prevUnits = comparisonData.total?.units || 0;
        const prevMargin = prevRev > 0 ? (prevProfit / prevRev * 100) : 0;
        changes.revenue = prevRev > 0 ? ((reportData.total.revenue - prevRev) / prevRev * 100) : 0;
        changes.profit = prevProfit > 0 ? ((reportData.total.netProfit - prevProfit) / prevProfit * 100) : 0;
        changes.units = prevUnits > 0 ? ((reportData.total.units - prevUnits) / prevUnits * 100) : 0;
        changes.margin = reportData.total.netMargin - prevMargin;
      }

      // Get inventory alerts (top 3 only)
      const latestInvKey = Object.keys(invHistory).sort().pop();
      const latestInv = latestInvKey ? invHistory[latestInvKey] : null;
      const inventoryAlerts = latestInv?.items
        ? latestInv.items
            .filter(i => i.daysOfSupply && i.daysOfSupply < 45 && i.daysOfSupply > 0)
            .sort((a, b) => a.daysOfSupply - b.daysOfSupply)
            .slice(0, 3)
            .map(i => `${i.sku}:${i.daysOfSupply}d`)
        : [];

      // Get forecast alerts (top 2 only)
      const topAlerts = forecastAlerts.slice(0, 2).map(a => a.message?.substring(0, 50) || '');

      // Cash summary
      let cashInfo = '';
      if (bankingData.transactions?.length > 0) {
        const accts = Object.entries(bankingData.accounts || {}).filter(([n]) => /\(\d{4}\)/.test(n));
        const cash = accts.filter(([_, a]) => a.type !== 'credit_card').reduce((s, [_, a]) => s + (a.balance || 0), 0);
        const debt = accts.filter(([_, a]) => a.type === 'credit_card').reduce((s, [_, a]) => s + (a.balance || 0), 0);
        cashInfo = `Cash:$${(cash/1000).toFixed(0)}k Debt:$${(debt/1000).toFixed(0)}k`;
      }

      // AI Forecast
      const aiForecast = aiForecasts?.salesForecast?.next4Weeks?.[0];
      
      // Build ULTRA-MINIMAL prompt
      const p = `${type.toUpperCase()} REPORT ${periodLabel}
Rev:$${(reportData.total.revenue/1000).toFixed(1)}k${comparisonData ? `(${changes.revenue>0?'+':''}${changes.revenue.toFixed(0)}%)` : ''} Profit:$${(reportData.total.netProfit/1000).toFixed(1)}k Margin:${reportData.total.netMargin.toFixed(0)}% Units:${reportData.total.units}
AMZ:$${(reportData.amazon.revenue/1000).toFixed(1)}k ${reportData.amazon.roas.toFixed(1)}xROAS | SHOP:$${(reportData.shopify.revenue/1000).toFixed(1)}k ${reportData.shopify.roas.toFixed(1)}xROAS
${aiForecast ? `Forecast:$${(aiForecast.predictedRevenue/1000).toFixed(1)}k next wk` : ''}
${inventoryAlerts.length > 0 ? `LowStock:${inventoryAlerts.join(',')}` : ''}
${cashInfo}
${topAlerts.length > 0 ? `Alerts:${topAlerts.join(';')}` : ''}

Write markdown: Summary(3 sentences), Metrics Table(âœ…âš ï¸âŒ), Wins(3), Concerns(3), Channels, ${inventoryAlerts.length > 0 ? 'Inventory Actions,' : ''}Recommendations(5)`;

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system: `E-commerce analyst for ${storeName || 'Store'}. Write detailed reports from compact data. Be specific with numbers.`,
          messages: [{ role: 'user', content: p }],
          model: 'claude-sonnet-4-20250514',
        }),
      });

      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      const reportContent = data.content?.[0]?.text || data.content || '';
      if (!reportContent) throw new Error('No report content generated');

      const newReport = {
        id: `${type}-report-${Date.now()}`,
        type,
        periodKey,
        periodLabel,
        generatedAt: new Date().toISOString(),
        content: reportContent,
        metrics: { 
          revenue: reportData.total.revenue, 
          profit: reportData.total.netProfit, 
          units: reportData.total.units, 
          margin: reportData.total.netMargin,
          changes,
        },
        dataSource,
        inventoryAlerts: inventoryAlerts.length,
        forecastWeeks: Object.keys(amazonForecasts).length,
      };

      setCurrentReport(newReport);
      setWeeklyReports(prev => ({
        ...prev,
        [type]: {
          reports: [newReport, ...(prev[type]?.reports || []).filter(r => r.periodKey !== periodKey)].slice(0, 52),
          lastGenerated: new Date().toISOString(),
        },
      }));
      
      setToast({ message: `${type.charAt(0).toUpperCase() + type.slice(1)} Report generated!`, type: 'success' });

    } catch (error) {
      console.error('Report generation error:', error);
      setReportError(error.message || 'Failed to generate report');
    } finally {
      setGeneratingReport(false);
    }
  };

  const downloadReport = (report) => {
    if (!report) return;
    const blob = new Blob([report.content], { type: 'text/markdown' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${report.type}_Report_${report.periodKey}.md`;
    a.click();
    setToast({ message: 'Report downloaded', type: 'success' });
  };

  // Weekly Report UI Modal
  const weeklyReportUI = showWeeklyReport && (
    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <div className={`p-6 flex items-center justify-between flex-shrink-0 ${
          reportType === 'weekly' ? 'bg-gradient-to-r from-emerald-600 to-teal-600' :
          reportType === 'monthly' ? 'bg-gradient-to-r from-blue-600 to-indigo-600' :
          reportType === 'quarterly' ? 'bg-gradient-to-r from-violet-600 to-purple-600' :
          'bg-gradient-to-r from-amber-600 to-orange-600'
        }`}>
          <div className="flex items-center gap-4">
            <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">
              {reportType === 'weekly' ? 'ðŸ“…' : reportType === 'monthly' ? 'ðŸ“Š' : reportType === 'quarterly' ? 'ðŸ“ˆ' : 'ðŸ†'}
            </div>
            <div>
              <h2 className="text-white text-xl font-bold">{reportType.charAt(0).toUpperCase() + reportType.slice(1)} Intelligence Report</h2>
              <p className="text-white/70 text-sm">{currentReport?.periodLabel || 'AI-powered business analysis'}</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {currentReport && (
              <button onClick={() => downloadReport(currentReport)} className="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-white text-sm flex items-center gap-2">
                <Download className="w-4 h-4" />Download
              </button>
            )}
            <button onClick={() => { setShowWeeklyReport(false); setCurrentReport(null); setReportError(null); }} className="p-2 hover:bg-white/20 rounded-lg text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
        </div>

        <div className="bg-slate-800/50 border-b border-slate-700 px-4 py-2 flex gap-2">
          {['weekly', 'monthly', 'quarterly', 'annual'].map(type => (
            <button
              key={type}
              onClick={() => { setReportType(type); setCurrentReport(weeklyReports[type]?.reports?.[0] || null); setReportError(null); }}
              className={`px-3 py-1.5 rounded-lg text-sm flex items-center gap-1.5 ${reportType === type ? 'bg-white/20 text-white font-medium' : 'text-slate-400 hover:bg-white/10'}`}
            >
              {type === 'weekly' ? 'ðŸ“…' : type === 'monthly' ? 'ðŸ“Š' : type === 'quarterly' ? 'ðŸ“ˆ' : 'ðŸ†'}
              {type.charAt(0).toUpperCase() + type.slice(1)}
              {weeklyReports[type]?.reports?.length > 0 && <span className="w-2 h-2 rounded-full bg-emerald-400"></span>}
            </button>
          ))}
        </div>

        <div className="flex-1 overflow-y-auto p-6">
          {generatingReport ? (
            <div className="flex flex-col items-center justify-center py-20">
              <div className="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-6" />
              <h3 className="text-white text-lg font-semibold mb-2">Generating Report...</h3>
              <p className="text-slate-400 text-sm">Analyzing your business data...</p>
            </div>
          ) : reportError ? (
            <div className="flex flex-col items-center justify-center py-20">
              <AlertTriangle className="w-16 h-16 text-rose-400 mb-6" />
              <h3 className="text-white text-lg font-semibold mb-2">Unable to Generate Report</h3>
              <p className="text-slate-400 text-sm mb-6">{reportError}</p>
              <button onClick={() => generateReport(reportType, true)} className="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-white">Try Again</button>
            </div>
          ) : currentReport ? (
            <div className="report-content text-slate-200">
              <style>{`
                .report-content { color: #e2e8f0; line-height: 1.7; }
                .report-content h1 { color: #ffffff; font-size: 1.5rem; font-weight: bold; border-bottom: 1px solid #475569; padding-bottom: 0.75rem; margin: 1.5rem 0 1rem 0; }
                .report-content h2 { color: #34d399; font-size: 1.25rem; font-weight: 600; margin: 2rem 0 1rem 0; }
                .report-content h3 { color: #22d3ee; font-size: 1.1rem; font-weight: 500; margin: 1.5rem 0 0.75rem 0; }
                .report-content p { color: #e2e8f0; margin: 0.75rem 0; }
                .report-content strong, .report-content b { color: #ffffff; font-weight: 600; }
                .report-content li { color: #e2e8f0; margin: 0.5rem 0 0.5rem 1.5rem; }
                .report-content ul, .report-content ol { margin: 0.5rem 0; }
                .report-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; background: rgba(51, 65, 85, 0.3); border-radius: 0.5rem; overflow: hidden; }
                .report-content th { color: #cbd5e1; font-weight: 600; text-align: left; padding: 0.75rem; border-bottom: 1px solid #475569; background: rgba(51, 65, 85, 0.5); }
                .report-content td { color: #e2e8f0; padding: 0.75rem; border-bottom: 1px solid rgba(71, 85, 105, 0.5); }
                .report-content tr:nth-child(even) { background: rgba(51, 65, 85, 0.2); }
                .report-content tr:hover { background: rgba(51, 65, 85, 0.4); }
                .report-content a { color: #60a5fa; }
                .report-content code { background: rgba(51, 65, 85, 0.5); padding: 0.125rem 0.375rem; border-radius: 0.25rem; color: #fbbf24; }
              `}</style>
              <div dangerouslySetInnerHTML={{ 
                __html: (() => {
                  let html = currentReport.content;
                  
                  // Convert markdown tables to HTML tables
                  const tableRegex = /\|(.+)\|\n\|[-:\s|]+\|\n((?:\|.+\|\n?)+)/g;
                  html = html.replace(tableRegex, (match, headerRow, bodyRows) => {
                    const headers = headerRow.split('|').filter(c => c.trim()).map(c => `<th>${c.trim()}</th>`).join('');
                    const rows = bodyRows.trim().split('\n').map(row => {
                      const cells = row.split('|').filter(c => c.trim()).map(c => `<td>${c.trim()}</td>`).join('');
                      return `<tr>${cells}</tr>`;
                    }).join('');
                    return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
                  });
                  
                  // Headings
                  html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                  html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                  html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                  
                  // Bold
                  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                  
                  // Lists
                  html = html.replace(/^- (.*$)/gim, '<li>$1</li>');
                  html = html.replace(/^\d+\. (.*$)/gim, '<li>$1</li>');
                  
                  // Wrap consecutive li elements in ul
                  html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
                  
                  // Paragraphs - wrap lines that aren't already wrapped
                  html = html.replace(/^(?!<[hultdp]|<\/)(.*\S.*)$/gim, '<p>$1</p>');
                  
                  // Clean up empty paragraphs
                  html = html.replace(/<p>\s*<\/p>/g, '');
                  
                  // Double newlines to breaks
                  html = html.replace(/\n\n/g, '<br/>');
                  
                  return html;
                })()
              }} />
            </div>
          ) : (
            <div className="flex flex-col items-center justify-center py-20">
              <FileText className="w-16 h-16 text-slate-600 mb-6" />
              <h3 className="text-white text-lg font-semibold mb-2">No {reportType} Report Yet</h3>
              <p className="text-slate-400 text-sm mb-6">Generate an AI-powered report for insights.</p>
              <button onClick={() => generateReport(reportType)} className="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-white flex items-center gap-2">
                <Zap className="w-5 h-5" />Generate Report
              </button>
            </div>
          )}
        </div>

        {weeklyReports[reportType]?.reports?.length > 0 && !generatingReport && (
          <div className="border-t border-slate-700 p-4 flex-shrink-0">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="text-slate-400 text-sm">History:</span>
                {weeklyReports[reportType].reports.slice(0, 5).map(r => (
                  <button key={r.id} onClick={() => setCurrentReport(r)} className={`px-3 py-1 rounded-lg text-xs ${currentReport?.id === r.id ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                    {r.periodLabel}
                  </button>
                ))}
              </div>
              <button onClick={() => generateReport(reportType, true)} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-slate-300 flex items-center gap-2">
                <RefreshCw className="w-4 h-4" />Regenerate
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
  
  // AI Chat UI - rendered as JSX variable, not a component function
  const aiChatUI = showAIChat && (
    <div className="fixed bottom-4 right-4 z-50 w-96 max-w-[calc(100vw-2rem)]">
      <div className="bg-slate-800 rounded-2xl border border-slate-700 shadow-2xl overflow-hidden">
        <div className="bg-gradient-to-r from-violet-600 to-indigo-600 p-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
              <MessageSquare className="w-5 h-5 text-white" />
            </div>
            <div>
              <h3 className="text-white font-semibold">AI Assistant</h3>
              <p className="text-white/70 text-xs">Ask about your business data</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {aiMessages.length > 0 && (
              <button 
                onClick={() => { if (confirm('Clear chat history?')) setAiMessages([]); }} 
                className="p-2 hover:bg-white/20 rounded-lg text-white/70 hover:text-white"
                title="Clear chat history"
              >
                <Trash2 className="w-4 h-4" />
              </button>
            )}
            <button onClick={() => setShowAIChat(false)} className="p-2 hover:bg-white/20 rounded-lg text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
        </div>
        
        <div className="h-80 overflow-y-auto p-4 space-y-4">
          {aiMessages.length === 0 && (
            <div className="text-center text-slate-400 py-8">
              <MessageSquare className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p className="text-sm">Ask me anything about your business!</p>
              <div className="mt-4 space-y-2">
                <button onClick={() => setAiInput("What was my total revenue last month?")} className="block w-full text-left px-3 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-xs text-slate-300">ðŸ’¡ "What was my total revenue last month?"</button>
                <button onClick={() => setAiInput("Which SKU has the best profit per unit?")} className="block w-full text-left px-3 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-xs text-slate-300">ðŸ’¡ "Which SKU has the best profit per unit?"</button>
                <button onClick={() => setAiInput("Which SKUs are declining in profitability?")} className="block w-full text-left px-3 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-xs text-slate-300">ðŸ’¡ "Which SKUs are declining in profitability?"</button>
              </div>
            </div>
          )}
          {aiMessages.map((msg, i) => (
            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
              <div className={`max-w-[85%] rounded-2xl px-4 py-2 ${msg.role === 'user' ? 'bg-violet-600 text-white' : 'bg-slate-700 text-slate-200'}`}>
                <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
              </div>
            </div>
          ))}
          {aiLoading && (
            <div className="flex justify-start">
              <div className="bg-slate-700 rounded-2xl px-4 py-3">
                <div className="flex gap-1">
                  <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
                  <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
                  <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
                </div>
              </div>
            </div>
          )}
        </div>
        
        <div className="p-4 border-t border-slate-700">
          <div className="flex gap-2">
            <input
              type="text"
              value={aiInput}
              onChange={(e) => setAiInput(e.target.value)}
              onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); sendAIMessage(); } }}
              placeholder="Ask about your data..."
              className="flex-1 bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white text-sm focus:outline-none focus:border-violet-500"
              autoComplete="off"
            />
            <button onClick={sendAIMessage} disabled={!aiInput.trim() || aiLoading} className="px-4 py-2 bg-violet-600 hover:bg-violet-500 disabled:opacity-50 rounded-xl text-white">
              <Send className="w-4 h-4" />
            </button>
          </div>
        </div>
      </div>
    </div>
  );
  
  // AI Chat Button - rendered as JSX variable
  const aiChatButton = !showAIChat && (
    <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-3">
      <button onClick={() => generateReport('weekly')} className="w-14 h-14 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center group">
        <FileText className="w-6 h-6 text-white" />
        <span className="absolute right-full mr-3 px-3 py-1 bg-slate-800 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">AI Reports</span>
      </button>
      <button onClick={() => setShowAIChat(true)} className="w-14 h-14 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center group">
        <MessageSquare className="w-6 h-6 text-white" />
        <span className="absolute right-full mr-3 px-3 py-1 bg-slate-800 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Ask AI Assistant</span>
      </button>
    </div>
  );

  
  // Calculate dashboard metrics based on selected range
  const dashboardMetrics = useMemo(() => {
    // Filter to only include weeks with actual revenue data
    const sortedWeeks = Object.keys(allWeeksData)
      .filter(w => (allWeeksData[w]?.total?.revenue || 0) > 0)
      .sort();
    const sortedPeriods = Object.keys(allPeriodsData).sort();
    const now = new Date();
    const currentYear = now.getFullYear().toString();
    const lastYear = (now.getFullYear() - 1).toString();
    
    // Helper to filter weeks by time range
    const getWeeksInRange = (range) => {
      if (range === 'week') {
        return sortedWeeks.slice(-1);
      } else if (range === 'month') {
        // Last 30 days worth of weeks (~4-5 weeks)
        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        return sortedWeeks.filter(w => new Date(w) >= thirtyDaysAgo);
      } else if (range === 'quarter') {
        // Last 90 days
        const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
        return sortedWeeks.filter(w => new Date(w) >= ninetyDaysAgo);
      } else if (range === 'year') {
        // Current year
        return sortedWeeks.filter(w => w.startsWith(currentYear));
      }
      return sortedWeeks.slice(-4);
    };
    
    const rangeWeeks = getWeeksInRange(dashboardRange);
    
    // For "year" view, prefer period data if available
    let current = { revenue: 0, profit: 0, units: 0, adSpend: 0, cogs: 0, orders: 0 };
    let previous = { revenue: 0, profit: 0 };
    let usingPeriodData = false;
    let usingDailyData = false;
    
    // Handle "yesterday" - use daily data (only days with real sales data)
    if (dashboardRange === 'yesterday') {
      const sortedDays = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort();
      if (sortedDays.length > 0) {
        const yesterday = sortedDays[sortedDays.length - 1];
        const dayData = allDaysData[yesterday];
        const googleAds = dayData.shopify?.googleSpend || dayData.googleSpend || dayData.googleAds || 0;
        const metaAds = dayData.shopify?.metaSpend || dayData.metaSpend || dayData.metaAds || 0;
        const amazonAds = dayData.amazon?.adSpend || 0;
        current = {
          revenue: dayData.total?.revenue || 0,
          profit: dayData.total?.netProfit || 0,
          units: dayData.total?.units || 0,
          adSpend: dayData.total?.adSpend || 0,
          cogs: dayData.total?.cogs || 0,
          orders: (dayData.amazon?.units || 0) + (dayData.shopify?.units || 0),
          date: yesterday,
          amazonRev: dayData.amazon?.revenue || 0,
          shopifyRev: dayData.shopify?.revenue || 0,
          googleAds,
          metaAds,
          amazonAds,
        };
        usingDailyData = true;
        
        // Compare to day before
        if (sortedDays.length > 1) {
          const priorDay = sortedDays[sortedDays.length - 2];
          const priorData = allDaysData[priorDay];
          previous = {
            revenue: priorData.total?.revenue || 0,
            profit: priorData.total?.netProfit || 0,
          };
        }
      }
    } else if (dashboardRange === 'year' && allPeriodsData[currentYear]) {
      // Use period data for current year
      const period = allPeriodsData[currentYear];
      const googleAds = period?.shopify?.googleSpend || period?.shopify?.googleAds || 0;
      const metaAds = period?.shopify?.metaSpend || period?.shopify?.metaAds || 0;
      const amazonAds = period?.amazon?.adSpend || 0;
      current = {
        revenue: period.total?.revenue || 0,
        profit: period.total?.netProfit || 0,
        units: period.total?.units || 0,
        adSpend: period.total?.adSpend || 0,
        cogs: period.total?.cogs || 0,
        orders: (period.shopify?.threeplMetrics?.orderCount || 0) + (period.amazon?.units || 0),
        googleAds,
        metaAds,
        amazonAds,
      };
      usingPeriodData = true;
      
      // Compare to last year's period if available
      if (allPeriodsData[lastYear]) {
        const lastPeriod = allPeriodsData[lastYear];
        previous = {
          revenue: lastPeriod.total?.revenue || 0,
          profit: lastPeriod.total?.netProfit || 0,
        };
      }
    } else {
      // Use weekly data
      const weeklyAggWithAds = rangeWeeks.reduce((acc, w) => {
        const week = allWeeksData[w];
        const googleAds = week?.shopify?.googleSpend || week?.shopify?.googleAds || 0;
        const metaAds = week?.shopify?.metaSpend || week?.shopify?.metaAds || 0;
        const amazonAds = week?.amazon?.adSpend || 0;
        return {
          revenue: acc.revenue + (week.total?.revenue || 0),
          profit: acc.profit + (week.total?.netProfit || 0),
          units: acc.units + (week.total?.units || 0),
          adSpend: acc.adSpend + (week.total?.adSpend || 0),
          cogs: acc.cogs + (week.total?.cogs || 0),
          orders: acc.orders + (week.shopify?.threeplMetrics?.orderCount || 0) + (week.amazon?.units || 0),
          googleAds: acc.googleAds + googleAds,
          metaAds: acc.metaAds + metaAds,
          amazonAds: acc.amazonAds + amazonAds,
        };
      }, { revenue: 0, profit: 0, units: 0, adSpend: 0, cogs: 0, orders: 0, googleAds: 0, metaAds: 0, amazonAds: 0 });
      
      current = weeklyAggWithAds;
      
      // Previous range for comparison
      const previousRangeWeeks = dashboardRange === 'week' 
        ? sortedWeeks.slice(-2, -1)
        : dashboardRange === 'month'
        ? sortedWeeks.slice(-8, -4)
        : dashboardRange === 'quarter'
        ? sortedWeeks.slice(-26, -13)
        : sortedWeeks.filter(w => w.startsWith(lastYear));
        
      previous = previousRangeWeeks.reduce((acc, w) => {
        const week = allWeeksData[w];
        return {
          revenue: acc.revenue + (week.total?.revenue || 0),
          profit: acc.profit + (week.total?.netProfit || 0),
        };
      }, { revenue: 0, profit: 0 });
    }
    
    // Changes
    const revenueChange = previous.revenue > 0 ? ((current.revenue - previous.revenue) / previous.revenue) * 100 : 0;
    const profitChange = previous.profit !== 0 ? ((current.profit - previous.profit) / Math.abs(previous.profit)) * 100 : 0;
    
    // Range label
    const rangeLabels = {
      'yesterday': 'Yesterday',
      'week': 'This Week',
      'month': 'Last 30 Days',
      'quarter': 'Last 90 Days',
      'year': currentYear,
    };
    
    return { 
      current, 
      previous, 
      revenueChange, 
      profitChange, 
      rangeWeeks, 
      sortedWeeks,
      sortedPeriods,
      usingPeriodData,
      usingDailyData,
      rangeLabel: rangeLabels[dashboardRange] || 'Last 30 Days',
      comparisonLabel: dashboardRange === 'yesterday' ? 'vs Prior Day' : dashboardRange === 'year' ? `vs ${lastYear}` : 'vs Prior Period'
    };
  }, [allWeeksData, allPeriodsData, allDaysData, dashboardRange]);

  // ==================== AUTH SCREENS (must come after all hooks) ====================
  
  // Show loading spinner while auth is initializing
  if (supabase && !isAuthReady) {
    return (
      <div className="min-h-screen bg-slate-950 text-white p-6 flex items-center justify-center">
        <div className="w-12 h-12 border-4 border-violet-500 border-t-transparent rounded-full animate-spin" />
      </div>
    );
  }

  // If logged in but locked, require password to continue
  if (supabase && isAuthReady && session && isLocked) {
    return (
      <div className="min-h-screen bg-slate-950 text-white flex items-center justify-center p-6">
        <div className="w-full max-w-md bg-slate-900/60 border border-slate-800 rounded-2xl p-6 shadow-xl">
          <div className="flex items-center gap-3 mb-6">
            <div className="w-10 h-10 rounded-xl bg-violet-500 flex items-center justify-center">
              <Clock className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-xl font-bold">Unlock Dashboard</h1>
              <p className="text-slate-400 text-sm">Session locked after 10 minutes of inactivity.</p>
            </div>
          </div>

          <form onSubmit={handleUnlock} className="space-y-4">
            <div>
              <label className="block text-sm text-slate-300 mb-1">Password</label>
              <input value={unlockPassword} onChange={(e) => setUnlockPassword(e.target.value)} type="password" required
                className="w-full rounded-xl bg-slate-950/60 border border-slate-700 px-3 py-2 outline-none focus:border-violet-500" />
            </div>

            {unlockError && (
              <div className="text-sm text-rose-300 bg-rose-950/30 border border-rose-900/50 rounded-xl p-3">
                {unlockError}
              </div>
            )}

            <button type="submit" className="w-full rounded-xl bg-violet-500 hover:bg-violet-400 text-slate-950 font-semibold py-2">
              Unlock
            </button>

            <button type="button" onClick={handleLogout}
              className="w-full rounded-xl border border-slate-700 hover:border-slate-500 text-slate-200 py-2">
              Sign out
            </button>
          </form>
        </div>
      </div>
    );
  }

  // If Supabase is configured, require login so your data is private.
  if (supabase && isAuthReady && !session) {
    return (
      <div className="min-h-screen bg-slate-950 text-white flex items-center justify-center p-6">
        <div className="w-full max-w-md bg-slate-900/60 border border-slate-800 rounded-2xl p-6 shadow-xl">
          <div className="flex items-center gap-3 mb-6">
            <div className="w-10 h-10 rounded-xl bg-emerald-500 flex items-center justify-center">
              <Database className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-xl font-bold">Dashboard Login</h1>
              <p className="text-slate-400 text-sm">Sign in to access your data from any device.</p>
            </div>
          </div>

          <form onSubmit={handleAuth} className="space-y-4">
            <div>
              <label className="block text-sm text-slate-300 mb-1">Email</label>
              <input value={authEmail} onChange={(e) => setAuthEmail(e.target.value)} type="email" required
                className="w-full rounded-xl bg-slate-950/60 border border-slate-700 px-3 py-2 outline-none focus:border-emerald-500" />
            </div>
            <div>
              <label className="block text-sm text-slate-300 mb-1">Password</label>
              <input value={authPassword} onChange={(e) => setAuthPassword(e.target.value)} type="password" required
                className="w-full rounded-xl bg-slate-950/60 border border-slate-700 px-3 py-2 outline-none focus:border-emerald-500" />
            </div>

            {authError && (
              <div className="text-sm text-rose-300 bg-rose-950/30 border border-rose-900/50 rounded-xl p-3">
                {authError}
              </div>
            )}

            <button type="submit" className="w-full rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold py-2">
              {authMode === 'sign_up' ? 'Create account' : 'Sign in'}
            </button>

            <button type="button" onClick={() => setAuthMode(authMode === 'sign_up' ? 'sign_in' : 'sign_up')}
              className="w-full rounded-xl border border-slate-700 hover:border-slate-500 text-slate-200 py-2">
              {authMode === 'sign_up' ? 'Have an account? Sign in' : 'New here? Create an account'}
            </button>

            <p className="text-xs text-slate-500">If you haven't added your Supabase keys yet, the app will run without login but data will stay on this device only.</p>
          </form>
        </div>
      </div>
    );
  }

  // VIEWS
  
  // ==================== DASHBOARD VIEW ====================
  if (view === 'dashboard') {
    const hasData = Object.keys(allWeeksData).length > 0 || Object.keys(allPeriodsData).length > 0 || Object.keys(allDaysData).length > 0;
    const { current, revenueChange, profitChange, rangeWeeks, sortedWeeks, sortedPeriods, usingPeriodData, usingDailyData, rangeLabel, comparisonLabel } = dashboardMetrics;
    
    // Get alerts
    const alerts = [];
    if (!hasCogs) alerts.push({ type: 'warning', text: 'Set up COGS to track profitability accurately' });
    // Weekly goal tracking is now handled by the progress bar widget instead of alerts
    
    // Check inventory alerts
    const latestInv = Object.keys(invHistory).sort().reverse()[0];
    const invAlerts = latestInv ? (invHistory[latestInv]?.items || []).filter(i => i.health === 'critical' || i.health === 'low') : [];
    if (invAlerts.length > 0 && appSettings.alertInventoryEnabled) {
      alerts.push({ type: 'critical', text: `${invAlerts.length} products need reorder attention` });
    }
    
    // Check upcoming invoices/bills
    const upcomingBills = invoices.filter(i => !i.paid);
    const overdueBills = upcomingBills.filter(i => new Date(i.dueDate) < new Date());
    const dueSoonBills = upcomingBills.filter(i => {
      const daysUntil = Math.ceil((new Date(i.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
      return daysUntil >= 0 && daysUntil <= 7;
    });
    if (overdueBills.length > 0) {
      const total = overdueBills.reduce((s, i) => s + i.amount, 0);
      alerts.push({ type: 'critical', text: `${overdueBills.length} overdue bills totaling ${formatCurrency(total)}`, link: 'invoices' });
    } else if (dueSoonBills.length > 0) {
      const total = dueSoonBills.reduce((s, i) => s + i.amount, 0);
      alerts.push({ type: 'warning', text: `${dueSoonBills.length} bills due within 7 days (${formatCurrency(total)})`, link: 'invoices' });
    }
    
    // Check sales tax deadlines
    if (appSettings.alertSalesTaxEnabled) {
      const now = new Date();
      const alertDays = appSettings.alertSalesTaxDays || 7;
      const alertThreshold = new Date(now.getTime() + alertDays * 24 * 60 * 60 * 1000);
      
      Object.entries(salesTaxConfig.nexusStates || {}).forEach(([stateCode, config]) => {
        if (!config.hasNexus) return;
        const nextDue = getNextDueDate(config.frequency || 'monthly', stateCode);
        const stateName = US_STATES_TAX_INFO[stateCode]?.name || stateCode;
        
        if (nextDue < now) {
          alerts.push({ type: 'critical', text: `${stateName} sales tax filing is OVERDUE!`, link: 'sales-tax' });
        } else if (nextDue <= alertThreshold) {
          const daysUntil = Math.ceil((nextDue - now) / (1000 * 60 * 60 * 24));
          alerts.push({ type: 'warning', text: `${stateName} sales tax due in ${daysUntil} days`, link: 'sales-tax' });
        }
        
        // Check custom filings too
        (config.customFilings || []).forEach(filing => {
          const filingDue = new Date(now.getFullYear(), filing.dueMonth - 1, filing.dueDay);
          if (filingDue < now) filingDue.setFullYear(filingDue.getFullYear() + 1);
          if (filingDue <= alertThreshold) {
            const daysUntil = Math.ceil((filingDue - now) / (1000 * 60 * 60 * 24));
            if (daysUntil <= 0) {
              alerts.push({ type: 'critical', text: `${stateName} ${filing.name} is OVERDUE!`, link: 'sales-tax' });
            } else {
              alerts.push({ type: 'warning', text: `${stateName} ${filing.name} due in ${daysUntil} days`, link: 'sales-tax' });
            }
          }
        });
      });
    }
    
    // Forecast alerts
    forecastAlerts.filter(a => a.severity === 'warning').forEach(a => {
      alerts.push({ type: 'warning', text: a.message, link: 'forecast' });
    });
    
    // QBO/Banking data stale alert
    if (bankingData.transactions?.length > 0) {
      const lastUpload = bankingData.lastUpload ? new Date(bankingData.lastUpload) : null;
      const today = new Date();
      const isStale = !lastUpload || 
        (today.getTime() - lastUpload.getTime()) > 24 * 60 * 60 * 1000; // More than 24 hours old
      
      if (isStale) {
        const daysSince = lastUpload 
          ? Math.floor((today.getTime() - lastUpload.getTime()) / (24 * 60 * 60 * 1000))
          : null;
        alerts.push({ 
          type: 'warning', 
          text: daysSince 
            ? `QBO data is ${daysSince} day${daysSince !== 1 ? 's' : ''} old - upload latest transactions`
            : 'QBO data needs to be uploaded',
          link: 'banking' 
        });
      }
    }
    
    // Calculate total upcoming bills for display
    const totalUpcomingBills = upcomingBills.reduce((s, i) => s + i.amount, 0);
    
    // Calculate weekly progress with AI projection
    const getWeeklyProgress = () => {
      if (goals.weeklyRevenue <= 0) return null;
      
      const now = new Date();
      const dayOfWeek = now.getDay(); // 0 = Sunday
      const daysIntoWeek = dayOfWeek === 0 ? 7 : dayOfWeek; // Sunday is end of week
      const daysRemaining = 7 - daysIntoWeek;
      
      // Get current week's date range (Monday to Sunday) using consistent date format
      const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysIntoWeek + 1);
      
      let currentWeekRevenue = 0;
      let daysWithData = 0;
      const dailyRevenues = [];
      
      // Sum up daily revenue for this week (check each day of current week)
      for (let i = 0; i < daysIntoWeek; i++) {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        const dateKey = formatDateKey(d);
        const dayData = allDaysData[dateKey];
        // Only count days with real sales data (not just Google Ads)
        if (dayData?.total?.revenue || (hasDailySalesData(dayData) && dayData.total)) {
          currentWeekRevenue += dayData.total?.revenue || 0;
          dailyRevenues.push(dayData.total?.revenue || 0);
          daysWithData++;
        }
      }
      
      // Calculate projection
      let projectedTotal = currentWeekRevenue;
      let projectionMethod = 'none';
      
      if (daysWithData > 0 && daysRemaining > 0) {
        // Use average daily revenue to project remaining days
        const avgDailyRevenue = currentWeekRevenue / daysWithData;
        projectedTotal = currentWeekRevenue + (avgDailyRevenue * daysRemaining);
        projectionMethod = 'daily-avg';
      } else if (daysWithData === 0 && sortedWeeks.length > 0) {
        // No daily data for current week - use last week's total as projection
        const lastWeekData = allWeeksData[sortedWeeks[sortedWeeks.length - 1]];
        projectedTotal = lastWeekData?.total?.revenue || 0;
        projectionMethod = 'last-week';
      }
      
      const progressPct = (currentWeekRevenue / goals.weeklyRevenue) * 100;
      const projectedPct = (projectedTotal / goals.weeklyRevenue) * 100;
      const onTrack = projectedTotal >= goals.weeklyRevenue;
      const shortfall = goals.weeklyRevenue - projectedTotal;
      
      return {
        currentRevenue: currentWeekRevenue,
        projectedTotal,
        goal: goals.weeklyRevenue,
        progressPct: Math.min(progressPct, 100),
        projectedPct: Math.min(projectedPct, 150),
        onTrack,
        shortfall,
        daysRemaining,
        daysWithData,
        projectionMethod,
      };
    };
    
    const weeklyProgress = getWeeklyProgress();
    
    // Calculate sales tax due this month
    const getSalesTaxDueThisMonth = () => {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      const endOfMonth = new Date(currentYear, currentMonth + 1, 0);
      
      const statesDue = [];
      
      Object.entries(salesTaxConfig.nexusStates || {}).forEach(([stateCode, config]) => {
        if (!config.hasNexus) return;
        
        const stateName = US_STATES_TAX_INFO[stateCode]?.name || stateCode;
        const nextDue = getNextDueDate(config.frequency || 'monthly', stateCode);
        
        // Check if due this month
        if (nextDue.getMonth() === currentMonth && nextDue.getFullYear() === currentYear) {
          const daysUntil = Math.ceil((nextDue - now) / (1000 * 60 * 60 * 24));
          statesDue.push({
            stateCode,
            stateName,
            dueDate: nextDue,
            daysUntil,
            frequency: config.frequency || 'monthly',
            isOverdue: daysUntil < 0,
          });
        }
        
        // Also check custom filings (LLC, annual reports, etc.)
        (config.customFilings || []).forEach(filing => {
          const filingDue = new Date(currentYear, filing.dueMonth - 1, filing.dueDay);
          if (filingDue.getMonth() === currentMonth) {
            const daysUntil = Math.ceil((filingDue - now) / (1000 * 60 * 60 * 24));
            statesDue.push({
              stateCode,
              stateName,
              dueDate: filingDue,
              daysUntil,
              filingName: filing.name,
              isCustom: true,
              isOverdue: daysUntil < 0,
            });
          }
        });
      });
      
      return statesDue.sort((a, b) => a.daysUntil - b.daysUntil);
    };
    
    const salesTaxDueThisMonth = getSalesTaxDueThisMonth();
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          
          {/* Header */}
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <div className="flex items-center gap-4">
              {storeLogo && (
                <img src={storeLogo} alt="Store logo" className="w-12 h-12 object-contain rounded-xl bg-white p-1.5" />
              )}
              <div>
                <h1 className="text-2xl lg:text-3xl font-bold text-white">{storeName ? storeName + ' Dashboard' : 'E-Commerce Dashboard'}</h1>
                <p className="text-slate-400">Business performance overview</p>
              </div>
            </div>
            <div className="flex items-center gap-3 flex-wrap">
              {/* Store Selector Dropdown - Always visible */}
              {session && (
                <div className="relative">
                  <button 
                    onClick={() => setShowStoreSelector(!showStoreSelector)}
                    className="px-4 py-2 bg-gradient-to-r from-violet-600/40 to-purple-600/40 hover:from-violet-600/60 hover:to-purple-600/60 border border-violet-500/50 rounded-xl text-sm text-white flex items-center gap-2 shadow-lg"
                  >
                    <Store className="w-4 h-4 text-violet-300" />
                    <span className="max-w-[150px] truncate font-medium">{stores.find(s => s.id === activeStoreId)?.name || storeName || 'My Store'}</span>
                    <ChevronDown className={`w-4 h-4 transition-transform ${showStoreSelector ? 'rotate-180' : ''}`} />
                  </button>
                  {showStoreSelector && (
                    <>
                      {/* Backdrop to close dropdown */}
                      <div className="fixed inset-0 z-40" onClick={() => setShowStoreSelector(false)} />
                      <div className="absolute top-full mt-2 right-0 w-72 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl z-50 overflow-hidden">
                        <div className="p-3 border-b border-slate-700 bg-slate-800/80">
                          <p className="text-white font-semibold flex items-center gap-2">
                            <Store className="w-4 h-4 text-violet-400" />
                            Switch Store
                          </p>
                          <p className="text-slate-400 text-xs mt-0.5">Select or create a store</p>
                        </div>
                        <div className="p-2 max-h-64 overflow-y-auto">
                          {stores.length === 0 ? (
                            <div className="text-center py-4 text-slate-500 text-sm">
                              <p>Current store: <span className="text-white">{storeName || 'My Store'}</span></p>
                              <p className="text-xs mt-1">Create a new store below to switch between them</p>
                            </div>
                          ) : (
                            stores.map(store => {
                              const isActive = store.id === activeStoreId;
                              return (
                                <button
                                  key={store.id}
                                  onClick={() => {
                                    if (!isActive) {
                                      switchStore(store.id);
                                    }
                                    setShowStoreSelector(false);
                                  }}
                                  className={`w-full text-left px-3 py-2.5 rounded-lg flex items-center gap-3 mb-1 transition-all ${isActive ? 'bg-violet-600/30 text-white border border-violet-500/50' : 'bg-slate-700/30 hover:bg-slate-700/70 text-slate-300'}`}
                                >
                                  <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${isActive ? 'bg-violet-600' : 'bg-slate-600'}`}>
                                    <Store className="w-4 h-4 text-white" />
                                  </div>
                                  <span className={`flex-1 truncate font-medium ${isActive ? 'text-white' : 'text-slate-300'}`}>{store.name}</span>
                                  {isActive && <Check className="w-5 h-5 text-violet-400" />}
                                </button>
                              );
                            })
                          )}
                        </div>
                        <div className="p-2 border-t border-slate-700 bg-slate-900/50">
                          <button
                            onClick={() => { setShowStoreSelector(false); setShowStoreModal(true); }}
                            className="w-full text-left px-3 py-2.5 rounded-lg bg-violet-600/20 hover:bg-violet-600/30 text-violet-300 flex items-center gap-2 text-sm border border-violet-500/30"
                          >
                            <Plus className="w-4 h-4" />
                            <span className="font-medium">Create New Store</span>
                          </button>
                          <button
                            onClick={() => { setShowStoreSelector(false); setShowStoreModal(true); }}
                            className="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-700/50 text-slate-400 flex items-center gap-2 text-xs mt-1"
                          >
                            <Settings className="w-3 h-3" />
                            Manage All Stores
                          </button>
                        </div>
                      </div>
                    </>
                  )}
                </div>
              )}
              <button onClick={() => setShowGoalsModal(true)} className="px-3 py-2 bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 rounded-lg text-sm text-amber-300 flex items-center gap-1"><Target className="w-4 h-4" />Goals</button>
              <button onClick={() => setShowCogsManager(true)} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white flex items-center gap-1"><Settings className="w-4 h-4" />COGS</button>
              <button onClick={() => setShowProductCatalog(true)} className="px-3 py-2 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/50 rounded-lg text-sm text-violet-300 flex items-center gap-1"><Package className="w-4 h-4" />Catalog{Object.keys(savedProductNames).length > 0 && <span className="ml-1">âœ“</span>}</button>
              <button onClick={() => setShowInvoiceModal(true)} className={`px-3 py-2 rounded-lg text-sm flex items-center gap-1 ${upcomingBills.length > 0 ? 'bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 text-amber-300' : 'bg-slate-700 hover:bg-slate-600 text-white'}`}>
                <FileText className="w-4 h-4" />Bills{upcomingBills.length > 0 && <span className="ml-1 px-1.5 py-0.5 bg-amber-500/30 rounded text-xs">{upcomingBills.length}</span>}
              </button>
              {generateForecast ? (
                <button onClick={() => setShowForecast(true)} className="px-3 py-2 bg-emerald-600/30 hover:bg-emerald-600/50 border border-emerald-500/50 rounded-lg text-sm text-emerald-300 flex items-center gap-1"><TrendingUp className="w-4 h-4" />Forecast</button>
              ) : (
                <button onClick={() => setView('analytics')} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-400 flex items-center gap-1" title="Need 4+ weeks for forecast"><TrendingUp className="w-4 h-4" />Forecast</button>
              )}
              <button onClick={() => setShowBreakEven(true)} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white flex items-center gap-1"><Calculator className="w-4 h-4" /></button>
              <button onClick={() => setShowExportModal(true)} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white flex items-center gap-1"><FileDown className="w-4 h-4" /></button>
              <button onClick={() => setShowUploadHelp(true)} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white flex items-center gap-1"><FileText className="w-4 h-4" /></button>
              <button onClick={() => setView('settings')} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white flex items-center gap-1"><Settings className="w-4 h-4" /></button>
            </div>
          </div>
          
          <NavTabs />
          
          {/* No Data State */}
          {!hasData ? (
            <div className="text-center py-12">
              <div className="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-violet-500 to-indigo-600 mb-6">
                <BarChart3 className="w-10 h-10 text-white" />
              </div>
              <h2 className="text-2xl font-bold text-white mb-3">Welcome to Your Dashboard</h2>
              <p className="text-slate-400 mb-8 max-w-md mx-auto">Get started by uploading your sales data. We support Amazon and Shopify exports.</p>
              
              {/* Getting Started Checklist */}
              <div className="max-w-xl mx-auto mb-8 bg-slate-800/50 rounded-2xl border border-slate-700 p-6 text-left">
                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <CheckCircle className="w-5 h-5 text-emerald-400" />
                  Getting Started Checklist
                </h3>
                <div className="space-y-3">
                  <div className="flex items-center gap-3">
                    {session ? <Check className="w-5 h-5 text-emerald-400" /> : <div className="w-5 h-5 rounded-full border-2 border-slate-600" />}
                    <span className={session ? 'text-emerald-400' : 'text-slate-300'}>Sign up for cloud sync</span>
                    {!session && <button onClick={() => setView('settings')} className="text-xs text-violet-400 hover:text-violet-300 ml-auto">Setup â†’</button>}
                  </div>
                  <div className="flex items-center gap-3">
                    {Object.keys(savedCogs).length > 0 ? <Check className="w-5 h-5 text-emerald-400" /> : <div className="w-5 h-5 rounded-full border-2 border-slate-600" />}
                    <span className={Object.keys(savedCogs).length > 0 ? 'text-emerald-400' : 'text-slate-300'}>Set up COGS for profit tracking</span>
                    {Object.keys(savedCogs).length === 0 && <button onClick={() => setShowCogsManager(true)} className="text-xs text-violet-400 hover:text-violet-300 ml-auto">Setup â†’</button>}
                  </div>
                  <div className="flex items-center gap-3">
                    {Object.keys(allPeriodsData).length > 0 ? <Check className="w-5 h-5 text-emerald-400" /> : <div className="w-5 h-5 rounded-full border-2 border-slate-600" />}
                    <span className={Object.keys(allPeriodsData).length > 0 ? 'text-emerald-400' : 'text-slate-300'}>Upload historical data (2024-2025)</span>
                    {Object.keys(allPeriodsData).length === 0 && <button onClick={() => { setUploadTab('period'); setView('upload'); }} className="text-xs text-violet-400 hover:text-violet-300 ml-auto">Upload â†’</button>}
                  </div>
                  <div className="flex items-center gap-3">
                    {Object.keys(allWeeksData).length > 0 ? <Check className="w-5 h-5 text-emerald-400" /> : <div className="w-5 h-5 rounded-full border-2 border-slate-600" />}
                    <span className={Object.keys(allWeeksData).length > 0 ? 'text-emerald-400' : 'text-slate-300'}>Upload your first weekly report</span>
                    {Object.keys(allWeeksData).length === 0 && <button onClick={() => { setUploadTab('weekly'); setView('upload'); }} className="text-xs text-violet-400 hover:text-violet-300 ml-auto">Upload â†’</button>}
                  </div>
                  <div className="flex items-center gap-3">
                    {goals.weeklyRevenue > 0 || goals.monthlyRevenue > 0 ? <Check className="w-5 h-5 text-emerald-400" /> : <div className="w-5 h-5 rounded-full border-2 border-slate-600" />}
                    <span className={goals.weeklyRevenue > 0 || goals.monthlyRevenue > 0 ? 'text-emerald-400' : 'text-slate-300'}>Set revenue goals</span>
                    {!(goals.weeklyRevenue > 0 || goals.monthlyRevenue > 0) && <button onClick={() => setShowGoalsModal(true)} className="text-xs text-violet-400 hover:text-violet-300 ml-auto">Setup â†’</button>}
                  </div>
                </div>
              </div>
              
              <div className="flex flex-col sm:flex-row gap-4 justify-center">
                <button onClick={() => { setUploadTab('weekly'); setView('upload'); }} className="px-6 py-3 bg-violet-600 hover:bg-violet-500 rounded-xl font-semibold flex items-center justify-center gap-2">
                  <Upload className="w-5 h-5" />Upload Weekly Data
                </button>
                <button onClick={() => { setUploadTab('period'); setView('upload'); }} className="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold flex items-center justify-center gap-2">
                  <CalendarRange className="w-5 h-5" />Upload Period Data
                </button>
                <button onClick={() => setShowUploadHelp(true)} className="px-6 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-xl font-semibold flex items-center justify-center gap-2 text-slate-300">
                  <FileText className="w-5 h-5" />How to Upload
                </button>
              </div>
              <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto text-left">
                <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                  <Calendar className="w-6 h-6 text-violet-400 mb-2" />
                  <h3 className="font-semibold text-white mb-1">Weekly Tracking</h3>
                  <p className="text-slate-400 text-sm">Upload weekly reports for detailed trends and analysis</p>
                </div>
                <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                  <CalendarRange className="w-6 h-6 text-teal-400 mb-2" />
                  <h3 className="font-semibold text-white mb-1">Period Reports</h3>
                  <p className="text-slate-400 text-sm">Upload monthly or yearly totals for YoY comparisons</p>
                </div>
                <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                  <Boxes className="w-6 h-6 text-emerald-400 mb-2" />
                  <h3 className="font-semibold text-white mb-1">Inventory Alerts</h3>
                  <p className="text-slate-400 text-sm">Track stock levels and get reorder notifications</p>
                </div>
              </div>
            </div>
          ) : (
            <>
              {/* Alerts */}
              {alerts.length > 0 && (
                <div className="mb-6 space-y-2">
                  {alerts.map((alert, i) => (
                    <div 
                      key={i} 
                      onClick={() => {
                        if (alert.link === 'invoices') setShowInvoiceModal(true);
                        else if (alert.link === 'forecast') { setUploadTab('forecast'); setView('upload'); }
                        else if (alert.link === 'sales-tax') setView('sales-tax');
                        else if (alert.link) setView(alert.link);
                      }}
                      className={`flex items-center justify-between p-3 rounded-xl ${alert.type === 'critical' ? 'bg-rose-900/30 border border-rose-500/50' : 'bg-amber-900/30 border border-amber-500/50'} ${alert.link ? 'cursor-pointer hover:opacity-80' : ''}`}
                    >
                      <div className="flex items-center gap-3">
                        <AlertTriangle className={`w-5 h-5 ${alert.type === 'critical' ? 'text-rose-400' : 'text-amber-400'}`} />
                        <span className={alert.type === 'critical' ? 'text-rose-300' : 'text-amber-300'}>{alert.text}</span>
                      </div>
                      {alert.link && <ChevronRight className="w-5 h-5 text-slate-400" />}
                    </div>
                  ))}
                </div>
              )}
              
              {/* Weekly Progress Bar */}
              {weeklyProgress && (
                <div className={`mb-6 rounded-2xl border p-4 ${
                  weeklyProgress.onTrack 
                    ? 'bg-gradient-to-r from-emerald-900/30 to-teal-900/20 border-emerald-500/30' 
                    : weeklyProgress.projectedPct >= 80 
                      ? 'bg-gradient-to-r from-amber-900/30 to-yellow-900/20 border-amber-500/30'
                      : 'bg-gradient-to-r from-rose-900/30 to-red-900/20 border-rose-500/30'
                }`}>
                  <div className="flex items-center justify-between mb-2">
                    <h3 className={`text-sm font-semibold flex items-center gap-2 ${
                      weeklyProgress.onTrack ? 'text-emerald-400' : weeklyProgress.projectedPct >= 80 ? 'text-amber-400' : 'text-rose-400'
                    }`}>
                      <Target className="w-4 h-4" />
                      Weekly Goal Progress
                    </h3>
                    <span className="text-white font-bold">
                      {formatCurrency(weeklyProgress.currentRevenue)} / {formatCurrency(weeklyProgress.goal)}
                    </span>
                  </div>
                  
                  {/* Progress Bar */}
                  <div className="relative h-4 bg-slate-800 rounded-full overflow-hidden mb-2">
                    {/* Current progress */}
                    <div 
                      className={`absolute left-0 top-0 h-full transition-all rounded-full ${
                        weeklyProgress.onTrack ? 'bg-emerald-500' : weeklyProgress.projectedPct >= 80 ? 'bg-amber-500' : 'bg-rose-500'
                      }`}
                      style={{ width: `${Math.min(weeklyProgress.progressPct, 100)}%` }}
                    />
                    {/* Projected endpoint marker */}
                    {weeklyProgress.daysRemaining > 0 && weeklyProgress.projectionMethod !== 'none' && (
                      <div 
                        className={`absolute top-0 h-full w-1 ${weeklyProgress.onTrack ? 'bg-emerald-300' : 'bg-amber-300'}`}
                        style={{ left: `${Math.min(weeklyProgress.projectedPct, 100)}%` }}
                        title={`Projected: ${formatCurrency(weeklyProgress.projectedTotal)}`}
                      />
                    )}
                    {/* Goal line at 100% */}
                    <div className="absolute right-0 top-0 h-full w-0.5 bg-white/50" />
                  </div>
                  
                  <div className="flex items-center justify-between text-sm">
                    <div className="flex items-center gap-4">
                      <span className="text-slate-400">{weeklyProgress.progressPct.toFixed(0)}% achieved</span>
                      {weeklyProgress.daysRemaining > 0 && (
                        <span className="text-slate-500">{weeklyProgress.daysRemaining} days left</span>
                      )}
                    </div>
                    <div className={`font-medium ${weeklyProgress.onTrack ? 'text-emerald-400' : 'text-amber-400'}`}>
                      {weeklyProgress.projectionMethod !== 'none' ? (
                        weeklyProgress.onTrack 
                          ? `âœ“ On track (${formatCurrency(weeklyProgress.projectedTotal)} projected)`
                          : `${formatCurrency(Math.abs(weeklyProgress.shortfall))} ${weeklyProgress.shortfall > 0 ? 'short' : 'over'} projected`
                      ) : (
                        weeklyProgress.daysWithData === 0 ? 'Upload daily data for projection' : ''
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {/* Quick Action Widgets */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                {/* Sales Tax Due This Month Card */}
                <div 
                  className={`rounded-2xl border p-4 cursor-pointer hover:opacity-90 ${
                    salesTaxDueThisMonth.some(s => s.isOverdue) 
                      ? 'bg-gradient-to-br from-rose-900/30 to-red-900/20 border-rose-500/30'
                      : salesTaxDueThisMonth.length > 0
                        ? 'bg-gradient-to-br from-violet-900/30 to-purple-900/20 border-violet-500/30'
                        : 'bg-slate-800/30 border-slate-700'
                  }`}
                  onClick={() => setView('sales-tax')}
                >
                  <div className="flex items-center justify-between mb-2">
                    <h3 className={`text-sm font-semibold flex items-center gap-2 ${
                      salesTaxDueThisMonth.some(s => s.isOverdue) ? 'text-rose-400' : salesTaxDueThisMonth.length > 0 ? 'text-violet-400' : 'text-slate-400'
                    }`}>
                      <DollarSign className="w-4 h-4" />Sales Tax
                    </h3>
                    <span className="text-xs text-slate-400">This month</span>
                  </div>
                  {salesTaxDueThisMonth.length > 0 ? (
                    <>
                      <p className="text-lg font-bold text-white mb-1">{salesTaxDueThisMonth.length} filing{salesTaxDueThisMonth.length > 1 ? 's' : ''} due</p>
                      <div className="space-y-1">
                        {salesTaxDueThisMonth.slice(0, 3).map((st, i) => (
                          <p key={i} className={`text-xs ${st.isOverdue ? 'text-rose-400' : st.daysUntil <= 7 ? 'text-amber-400' : 'text-slate-400'}`}>
                            {st.stateName}{st.filingName ? ` (${st.filingName})` : ''}: {st.isOverdue ? 'OVERDUE' : `${st.daysUntil} days`}
                          </p>
                        ))}
                        {salesTaxDueThisMonth.length > 3 && (
                          <p className="text-xs text-slate-500">+{salesTaxDueThisMonth.length - 3} more</p>
                        )}
                      </div>
                    </>
                  ) : Object.keys(salesTaxConfig.nexusStates || {}).length > 0 ? (
                    <>
                      <p className="text-emerald-400 text-sm mb-1 flex items-center gap-1"><Check className="w-4 h-4" />All clear</p>
                      <p className="text-slate-500 text-xs">No filings due this month</p>
                    </>
                  ) : (
                    <>
                      <p className="text-slate-500 text-sm mb-1">No nexus configured</p>
                      <p className="text-xs text-violet-400">Setup states â†’</p>
                    </>
                  )}
                </div>
                
                {/* AI Forecast Widget - Unified Predictions */}
                {aiForecasts && !aiForecasts.error && aiForecasts.salesForecast ? (
                  <div className="bg-gradient-to-br from-purple-900/30 to-indigo-900/20 rounded-2xl border border-purple-500/30 p-4">
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="text-purple-400 text-sm font-semibold flex items-center gap-2">
                        <Brain className="w-4 h-4" />AI Forecast
                      </h3>
                      <span className="text-xs text-slate-400">Multi-Signal</span>
                    </div>
                    {aiForecasts.salesForecast.next4Weeks?.[0] && (
                      <>
                        <p className="text-2xl font-bold text-white">{formatCurrency(aiForecasts.salesForecast.next4Weeks[0].predictedRevenue || 0)}</p>
                        <p className="text-slate-400 text-sm">Next week prediction</p>
                        <p className={`text-xs mt-1 ${(aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                          {formatCurrency(aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0)} profit â€¢ {aiForecasts.salesForecast.next4Weeks[0].confidence} confidence
                        </p>
                        {aiForecasts.calculatedSignals && (
                          <div className="mt-2 pt-2 border-t border-slate-700/50 text-xs text-slate-500 space-y-0.5">
                            <p>ðŸ“Š Daily avg: {formatCurrency(aiForecasts.calculatedSignals.dailyAvg7)}/day</p>
                            <p>ðŸ“ˆ Momentum: {aiForecasts.calculatedSignals.momentum > 0 ? '+' : ''}{aiForecasts.calculatedSignals.momentum?.toFixed(1)}%</p>
                            {aiForecasts.dataPoints?.amazonForecastWeeks > 0 && (
                              <p>ðŸ›’ Amazon forecast: {aiForecasts.dataPoints.amazonForecastWeeks} weeks</p>
                            )}
                          </div>
                        )}
                      </>
                    )}
                    <button 
                      onClick={generateAIForecasts}
                      disabled={aiForecastLoading}
                      className="mt-2 text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1"
                    >
                      {aiForecastLoading ? <Loader2 className="w-3 h-3 animate-spin" /> : <RefreshCw className="w-3 h-3" />}
                      {aiForecastLoading ? 'Analyzing signals...' : 'Refresh forecast'}
                    </button>
                  </div>
                ) : (
                  <div className="bg-gradient-to-br from-purple-900/20 to-slate-800 rounded-2xl border border-dashed border-purple-500/30 p-4">
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="text-purple-400 text-sm font-semibold flex items-center gap-2">
                        <Brain className="w-4 h-4" />AI Forecast
                      </h3>
                    </div>
                    <p className="text-slate-400 text-sm mb-2">Multi-signal AI predictions</p>
                    <button 
                      onClick={generateAIForecasts}
                      disabled={aiForecastLoading || (Object.keys(allWeeksData).length < 2 && Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).length < 7)}
                      className="text-xs bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 disabled:text-slate-500 px-3 py-1.5 rounded-lg text-white flex items-center gap-1"
                    >
                      {aiForecastLoading ? <Loader2 className="w-3 h-3 animate-spin" /> : <Zap className="w-3 h-3" />}
                      {aiForecastLoading ? 'Analyzing...' : 'Generate Forecast'}
                    </button>
                    {Object.keys(allWeeksData).length < 2 && Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).length < 7 && (
                      <p className="text-slate-500 text-xs mt-2">Need 2+ weeks or 7+ days of data</p>
                    )}
                  </div>
                )}
                
                {/* Upcoming Bills Widget */}
                {upcomingBills.length > 0 ? (
                  <div className="bg-gradient-to-br from-rose-900/30 to-pink-900/20 rounded-2xl border border-rose-500/30 p-4 cursor-pointer hover:border-rose-400/50" onClick={() => setShowInvoiceModal(true)}>
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="text-rose-400 text-sm font-semibold flex items-center gap-2">
                        <FileText className="w-4 h-4" />Upcoming Bills
                      </h3>
                      <span className="text-xs text-slate-400">{upcomingBills.length} due</span>
                    </div>
                    <p className="text-2xl font-bold text-white">{formatCurrency(totalUpcomingBills)}</p>
                    {(() => {
                      const nextBill = upcomingBills.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))[0];
                      const daysUntil = Math.ceil((new Date(nextBill.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                      return (
                        <>
                          <p className="text-slate-400 text-sm">Next: {nextBill.vendor}</p>
                          <p className={`text-xs mt-1 ${daysUntil <= 3 ? 'text-rose-400' : daysUntil <= 7 ? 'text-amber-400' : 'text-slate-500'}`}>
                            {daysUntil <= 0 ? 'Due today!' : `Due in ${daysUntil} days`}
                          </p>
                        </>
                      );
                    })()}
                  </div>
                ) : (
                  <div className="bg-slate-800/30 rounded-2xl border border-dashed border-slate-600 p-4">
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="text-slate-400 text-sm font-semibold flex items-center gap-2">
                        <FileText className="w-4 h-4" />Upcoming Bills
                      </h3>
                    </div>
                    <p className="text-slate-500 text-sm mb-2">No bills tracked</p>
                    <button onClick={() => setShowInvoiceModal(true)} className="text-xs text-rose-400 hover:text-rose-300 flex items-center gap-1">
                      <Plus className="w-3 h-3" />Add a bill
                    </button>
                  </div>
                )}
                
                {/* Sync & Backup Status Widget */}
                <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-4">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-slate-300 text-sm font-semibold flex items-center gap-2">
                      <Database className="w-4 h-4" />Data Status
                    </h3>
                  </div>
                  <div className="space-y-2">
                    {/* Cloud Sync Status */}
                    <div className="flex items-center justify-between">
                      <span className="text-slate-400 text-sm">Cloud Sync</span>
                      {session ? (
                        <div className="flex items-center gap-2">
                          {cloudStatus && <span className="text-blue-400 text-xs">{cloudStatus}</span>}
                          {!cloudStatus && <span className="text-emerald-400 text-xs flex items-center gap-1"><Check className="w-3 h-3" />Connected</span>}
                        </div>
                      ) : (
                        <span className="text-amber-400 text-xs flex items-center gap-1"><AlertCircle className="w-3 h-3" />Local only</span>
                      )}
                    </div>
                    {/* Last Sync (for cloud users) */}
                    {session && lastSyncDate && (
                      <div className="flex items-center justify-between">
                        <span className="text-slate-400 text-sm">Last Sync</span>
                        <span className="text-slate-400 text-xs">{new Date(lastSyncDate).toLocaleString()}</span>
                      </div>
                    )}
                    {/* Last Backup */}
                    <div className="flex items-center justify-between">
                      <span className="text-slate-400 text-sm">Last Backup</span>
                      {lastBackupDate ? (
                        <span className={`text-xs ${(new Date() - new Date(lastBackupDate)) / (1000 * 60 * 60 * 24) > 7 ? 'text-amber-400' : 'text-slate-400'}`}>
                          {new Date(lastBackupDate).toLocaleDateString()}
                        </span>
                      ) : (
                        <span className="text-rose-400 text-xs">Never</span>
                      )}
                    </div>
                    {/* Quick Actions */}
                    <div className="flex gap-2 mt-2">
                      <button onClick={exportAll} className="flex-1 px-2 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs text-white flex items-center justify-center gap-1">
                        <Download className="w-3 h-3" />Backup
                      </button>
                      {!session && (
                        <button onClick={() => setView('settings')} className="flex-1 px-2 py-1.5 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/50 rounded-lg text-xs text-violet-300 flex items-center justify-center gap-1">
                          <Cloud className="w-3 h-3" />Enable Sync
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Quick Uploads Shortcuts */}
              <div className="bg-slate-800/30 rounded-2xl border border-slate-700 p-4 mb-6">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-slate-300 text-sm font-semibold flex items-center gap-2">
                    <Upload className="w-4 h-4" />Quick Uploads
                  </h3>
                  <button onClick={() => setView('upload')} className="text-xs text-slate-400 hover:text-white">View all â†’</button>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <button 
                    onClick={() => { setUploadTab('weekly'); setView('upload'); }}
                    className="p-3 bg-violet-600/20 hover:bg-violet-600/30 border border-violet-500/30 rounded-xl text-left transition-all"
                  >
                    <Calendar className="w-5 h-5 text-violet-400 mb-1" />
                    <p className="text-violet-300 text-sm font-medium">Weekly Data</p>
                    <p className="text-slate-500 text-xs">Amazon + Shopify</p>
                  </button>
                  <button 
                    onClick={() => { setUploadTab('bulk-ads'); setView('upload'); }}
                    className="p-3 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/30 rounded-xl text-left transition-all"
                  >
                    <DollarSign className="w-5 h-5 text-blue-400 mb-1" />
                    <p className="text-blue-300 text-sm font-medium">Bulk Ads</p>
                    <p className="text-slate-500 text-xs">Google / Meta</p>
                  </button>
                  <button 
                    onClick={() => { setUploadTab('inventory'); setView('upload'); }}
                    className="p-3 bg-emerald-600/20 hover:bg-emerald-600/30 border border-emerald-500/30 rounded-xl text-left transition-all"
                  >
                    <Boxes className="w-5 h-5 text-emerald-400 mb-1" />
                    <p className="text-emerald-300 text-sm font-medium">Inventory</p>
                    <p className="text-slate-500 text-xs">Stock levels</p>
                  </button>
                  <button 
                    onClick={() => { setUploadTab('forecast'); setView('upload'); }}
                    className="p-3 bg-amber-600/20 hover:bg-amber-600/30 border border-amber-500/30 rounded-xl text-left transition-all"
                  >
                    <TrendingUp className="w-5 h-5 text-amber-400 mb-1" />
                    <p className="text-amber-300 text-sm font-medium">Forecast</p>
                    <p className="text-slate-500 text-xs">Amazon projections</p>
                  </button>
                </div>
              </div>
              
              {/* Quick Upload - Show if most recent week is missing */}
              {(() => {
                const today = new Date();
                const sortedWeeks = Object.keys(allWeeksData).sort();
                if (sortedWeeks.length === 0) return null; // Don't show if no data at all
                
                // Get the expected most recent week end (last Sunday)
                const dayOfWeek = today.getDay(); // 0 = Sunday
                const lastSunday = new Date(today);
                // Go back to the most recent Sunday
                if (dayOfWeek !== 0) {
                  lastSunday.setDate(today.getDate() - dayOfWeek);
                }
                const expectedWeekEnd = `${lastSunday.getFullYear()}-${String(lastSunday.getMonth() + 1).padStart(2, '0')}-${String(lastSunday.getDate()).padStart(2, '0')}`;
                
                // Check if we have data for the expected week OR the most recent week is within 7 days
                const hasExpectedWeek = allWeeksData[expectedWeekEnd];
                const mostRecentWeek = sortedWeeks[sortedWeeks.length - 1];
                const mostRecentDate = new Date(mostRecentWeek + 'T00:00:00');
                const daysSinceLast = Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24));
                
                // Only show alert if the most recent data is more than 7 days old AND we don't have this week
                if (!hasExpectedWeek && daysSinceLast > 7) {
                  return (
                    <div className="bg-violet-900/20 border border-violet-500/30 rounded-xl p-4 mb-6 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <Calendar className="w-5 h-5 text-violet-400" />
                        <div>
                          <p className="text-violet-300 font-medium">Most recent week data missing</p>
                          <p className="text-slate-400 text-sm">Week ending {new Date(expectedWeekEnd + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} (last data: {daysSinceLast} days ago)</p>
                        </div>
                      </div>
                      <button onClick={() => { setWeekEnding(expectedWeekEnd); setUploadTab('weekly'); setView('upload'); }} className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-sm text-white flex items-center gap-2">
                        <Upload className="w-4 h-4" />Upload This Week
                      </button>
                    </div>
                  );
                }
                return null;
              })()}
              
              {/* ============ DATA HUB - Complete Data Status ============ */}
              <div className="bg-gradient-to-r from-slate-800/70 to-slate-900/70 rounded-2xl border border-purple-500/30 p-5 mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-white font-semibold flex items-center gap-2">
                    <Database className="w-5 h-5 text-purple-400" />
                    Data Hub - What's Powering Your Predictions
                  </h3>
                  <button onClick={() => setView('analytics')} className="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1">
                    View Forecast Accuracy â†’
                  </button>
                </div>
                
                {/* Data Actions Required */}
                {dataStatus.nextActions.length > 0 && (
                  <div className="mb-4 space-y-2">
                    {dataStatus.nextActions.slice(0, 3).map((action, idx) => (
                      <div key={idx} className={`flex items-center justify-between p-3 rounded-lg text-sm ${
                        action.priority === 'high' ? 'bg-rose-900/30 border border-rose-500/30' :
                        action.priority === 'medium' ? 'bg-amber-900/30 border border-amber-500/30' :
                        'bg-slate-700/30 border border-slate-600/30'
                      }`}>
                        <div className="flex items-center gap-2">
                          <AlertCircle className={`w-4 h-4 ${
                            action.priority === 'high' ? 'text-rose-400' :
                            action.priority === 'medium' ? 'text-amber-400' : 'text-slate-400'
                          }`} />
                          <span className={
                            action.priority === 'high' ? 'text-rose-300' :
                            action.priority === 'medium' ? 'text-amber-300' : 'text-slate-300'
                          }>{action.message}</span>
                        </div>
                        <button 
                          onClick={() => {
                            if (action.action === 'upload-forecast') { setUploadTab('forecast'); setView('upload'); }
                            else if (action.action === 'upload-weekly') { setUploadTab('weekly'); setView('upload'); }
                            else if (action.action === 'upload-daily') { setUploadTab('daily'); setView('upload'); }
                            else if (action.action === 'aggregate-daily') aggregateDailyToWeekly();
                          }}
                          className="px-3 py-1 bg-slate-600/50 hover:bg-slate-500/50 rounded text-xs text-white"
                        >
                          {action.action === 'aggregate-daily' ? 'Aggregate' : 'Upload Now'}
                        </button>
                      </div>
                    ))}
                  </div>
                )}
                
                <div className="grid grid-cols-2 lg:grid-cols-5 gap-3">
                  {/* Amazon Forecasts Status - NEW PROMINENT CARD */}
                  <div className="bg-gradient-to-br from-amber-900/30 to-orange-900/20 rounded-xl p-3 border border-amber-500/30">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2">
                        <Target className="w-4 h-4 text-amber-400" />
                        <span className="text-xs font-medium text-amber-300 uppercase">Amazon Forecasts</span>
                      </div>
                    </div>
                    <div className="space-y-1 mb-2">
                      {['7day', '30day', '60day'].map(type => {
                        const status = dataStatus.forecastStatus[type];
                        return (
                          <div key={type} className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">{status.type}</span>
                            {status.status === 'active' ? (
                              <span className="text-emerald-400 flex items-center gap-1">
                                <Check className="w-3 h-3" />{status.daysUntilExpiry}d
                              </span>
                            ) : status.status === 'expiring' ? (
                              <span className="text-amber-400">âš ï¸ {status.daysUntilExpiry}d</span>
                            ) : status.status === 'expired' ? (
                              <span className="text-rose-400">Expired</span>
                            ) : (
                              <span className="text-slate-500">â€”</span>
                            )}
                          </div>
                        );
                      })}
                    </div>
                    <button 
                      onClick={() => { setUploadTab('forecast'); setView('upload'); }}
                      className="w-full py-1.5 bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 rounded-lg text-xs text-amber-300 flex items-center justify-center gap-1"
                    >
                      <Upload className="w-3 h-3" /> Update
                    </button>
                  </div>
                  
                  {/* Daily Data Status */}
                  <div className="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                    <div className="flex items-center gap-2 mb-2">
                      <Calendar className="w-4 h-4 text-cyan-400" />
                      <span className="text-xs font-medium text-slate-300 uppercase">Daily Data</span>
                    </div>
                    <p className="text-lg font-semibold text-white">{dataStatus.dailyStatus.totalDays} days</p>
                    <p className="text-xs text-slate-400 mb-2">
                      {dataStatus.dailyStatus.streak > 0 ? (
                        <span className="text-emerald-400">ðŸ”¥ {dataStatus.dailyStatus.streak}-day streak</span>
                      ) : dataStatus.dailyStatus.newestDate ? (
                        `Latest: ${new Date(dataStatus.dailyStatus.newestDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                      ) : 'No data yet'}
                    </p>
                    <button 
                      onClick={() => { setUploadTab('daily'); setView('upload'); }}
                      className="w-full py-1.5 bg-cyan-600/30 hover:bg-cyan-600/50 border border-cyan-500/50 rounded-lg text-xs text-cyan-300 flex items-center justify-center gap-1"
                    >
                      <Upload className="w-3 h-3" /> Upload
                    </button>
                  </div>
                  
                  {/* Weekly Data Status */}
                  <div className="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                    <div className="flex items-center gap-2 mb-2">
                      <CalendarRange className="w-4 h-4 text-violet-400" />
                      <span className="text-xs font-medium text-slate-300 uppercase">Weekly Data</span>
                    </div>
                    <p className="text-lg font-semibold text-white">{dataStatus.weeklyStatus.totalWeeks} weeks</p>
                    <p className="text-xs text-slate-400 mb-2">
                      {dataStatus.weeklyStatus.newestWeek ? (
                        `Latest: ${new Date(dataStatus.weeklyStatus.newestWeek + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                      ) : 'No data yet'}
                    </p>
                    <button 
                      onClick={() => { setUploadTab('weekly'); setView('upload'); }}
                      className="w-full py-1.5 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/50 rounded-lg text-xs text-violet-300 flex items-center justify-center gap-1"
                    >
                      <Upload className="w-3 h-3" /> Upload
                    </button>
                  </div>
                  
                  {/* Inventory Status */}
                  <div className="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                    <div className="flex items-center gap-2 mb-2">
                      <Boxes className="w-4 h-4 text-emerald-400" />
                      <span className="text-xs font-medium text-slate-300 uppercase">Inventory</span>
                    </div>
                    <p className="text-lg font-semibold text-white">{Object.keys(invHistory).length} snapshots</p>
                    <p className="text-xs text-slate-400 mb-2">
                      {Object.keys(invHistory).length > 0 ? (
                        `Latest: ${new Date(Object.keys(invHistory).sort().reverse()[0] + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                      ) : 'No data yet'}
                    </p>
                    <button 
                      onClick={() => { setUploadTab('inventory'); setView('upload'); }}
                      className="w-full py-1.5 bg-emerald-600/30 hover:bg-emerald-600/50 border border-emerald-500/50 rounded-lg text-xs text-emerald-300 flex items-center justify-center gap-1"
                    >
                      <Upload className="w-3 h-3" /> Upload
                    </button>
                  </div>
                  
                  {/* AI Learning Status */}
                  <div className={`rounded-xl p-3 border ${dataStatus.learningStatus.active ? 'bg-gradient-to-br from-purple-900/30 to-indigo-900/20 border-purple-500/30' : 'bg-slate-800/50 border-slate-700'}`}>
                    <div className="flex items-center gap-2 mb-2">
                      <Brain className="w-4 h-4 text-purple-400" />
                      <span className="text-xs font-medium text-slate-300 uppercase">AI Learning</span>
                    </div>
                    <p className={`text-lg font-semibold ${dataStatus.learningStatus.active ? 'text-emerald-400' : 'text-amber-400'}`}>
                      {dataStatus.learningStatus.active ? 'Active' : 'Training'}
                    </p>
                    <p className="text-xs text-slate-400 mb-2">
                      {dataStatus.learningStatus.samples} samples â€¢ {dataStatus.learningStatus.confidence.toFixed(0)}% conf
                    </p>
                    <button 
                      onClick={() => { setAnalyticsTab('amazon-accuracy'); setView('analytics'); }}
                      className="w-full py-1.5 bg-purple-600/30 hover:bg-purple-600/50 border border-purple-500/50 rounded-lg text-xs text-purple-300 flex items-center justify-center gap-1"
                    >
                      <Eye className="w-3 h-3" /> View Accuracy
                    </button>
                  </div>
                </div>
                
                {/* Forecast vs Actuals - Link only to avoid circular dependency */}
                {Object.keys(amazonForecasts).length > 0 && Object.keys(allWeeksData).length > 0 && (
                  <div className="mt-4 pt-4 border-t border-slate-700/50">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-slate-400">Forecast vs Actuals tracking available</span>
                      </div>
                      <button 
                        onClick={() => { setAnalyticsTab('amazon-accuracy'); setView('analytics'); }}
                        className="text-xs text-purple-400 hover:text-purple-300"
                      >
                        View Accuracy Details â†’
                      </button>
                    </div>
                  </div>
                )}
                
                {/* Data Flow Visualization */}
                <div className="mt-4 pt-4 border-t border-slate-700/50">
                  <div className="flex items-center justify-between text-xs">
                    <div className="flex items-center gap-2">
                      <div className="flex items-center gap-1">
                        <div className="w-2 h-2 rounded-full bg-cyan-500" />
                        <span className="text-slate-400">Daily</span>
                      </div>
                      <span className="text-slate-600">â†’</span>
                      <div className="flex items-center gap-1">
                        <div className="w-2 h-2 rounded-full bg-violet-500" />
                        <span className="text-slate-400">Weekly</span>
                      </div>
                      <span className="text-slate-600">â†’</span>
                      <div className="flex items-center gap-1">
                        <div className="w-2 h-2 rounded-full bg-emerald-500" />
                        <span className="text-slate-400">Inventory Velocity</span>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="flex items-center gap-1">
                        <div className="w-2 h-2 rounded-full bg-amber-500" />
                        <span className="text-slate-400">Forecasts</span>
                      </div>
                      <span className="text-slate-600">+</span>
                      <div className="flex items-center gap-1">
                        <div className="w-2 h-2 rounded-full bg-purple-500" />
                        <span className="text-slate-400">Learning</span>
                      </div>
                      <span className="text-slate-600">â†’</span>
                      <div className="flex items-center gap-1">
                        <div className="w-2 h-2 rounded-full bg-green-500" />
                        <span className="text-slate-400">Predictions</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {/* ============ END DATA HUB ============ */}
              
              {/* ============ DAILY CALENDAR ============ */}
              {Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).length > 0 && (
                <div className="bg-gradient-to-br from-slate-800 to-slate-800/50 rounded-2xl border border-slate-700 p-6 shadow-lg">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center">
                        <Calendar className="w-5 h-5 text-cyan-400" />
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-white">Daily Calendar</h3>
                        <p className="text-slate-400 text-xs">Click any day to view details</p>
                      </div>
                    </div>
                    <button 
                      onClick={() => { setTrendsTab('daily'); setView('trends'); }}
                      className="text-xs text-cyan-400 hover:text-cyan-300"
                    >
                      View Trends â†’
                    </button>
                  </div>
                  
                  {(() => {
                    // Get current month and year - use calendarMonth state if set, otherwise auto-detect
                    const now = new Date();
                    const daysWithSales = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort();
                    const allDaysWithAny = Object.keys(allDaysData).sort();
                    const latestDate = daysWithSales.length > 0 ? new Date(daysWithSales[daysWithSales.length - 1] + 'T12:00:00') : now;
                    
                    // Use calendarMonth state if set, otherwise use latest data month
                    const viewMonth = calendarMonth ? calendarMonth.month : latestDate.getMonth();
                    const viewYear = calendarMonth ? calendarMonth.year : latestDate.getFullYear();
                    
                    // Get available months for navigation (months with any data)
                    const availableMonths = new Set();
                    allDaysWithAny.forEach(d => {
                      const date = new Date(d + 'T12:00:00');
                      availableMonths.add(`${date.getFullYear()}-${date.getMonth()}`);
                    });
                    const sortedMonths = Array.from(availableMonths).sort();
                    const currentMonthKey = `${viewYear}-${viewMonth}`;
                    const currentMonthIdx = sortedMonths.indexOf(currentMonthKey);
                    const hasPrevMonth = currentMonthIdx > 0;
                    const hasNextMonth = currentMonthIdx < sortedMonths.length - 1;
                    
                    // Get first day of month and number of days
                    const firstDay = new Date(viewYear, viewMonth, 1);
                    const lastDay = new Date(viewYear, viewMonth + 1, 0);
                    const startPadding = firstDay.getDay(); // 0=Sunday
                    const totalDays = lastDay.getDate();
                    
                    // Calculate month totals
                    const monthDays = daysWithSales.filter(d => {
                      const date = new Date(d + 'T12:00:00');
                      return date.getMonth() === viewMonth && date.getFullYear() === viewYear;
                    });
                    const monthRevenue = monthDays.reduce((sum, d) => sum + (allDaysData[d]?.total?.revenue || 0), 0);
                    const monthProfit = monthDays.reduce((sum, d) => sum + (allDaysData[d]?.total?.netProfit || 0), 0);
                    
                    // Count days missing ads data and track which days
                    const daysMissingMetaList = monthDays.filter(d => {
                      const data = allDaysData[d];
                      return !((data?.shopify?.metaSpend || data?.metaSpend || data?.metaAds || 0) > 0);
                    });
                    const daysMissingGoogleList = monthDays.filter(d => {
                      const data = allDaysData[d];
                      return !((data?.shopify?.googleSpend || data?.googleSpend || data?.googleAds || 0) > 0);
                    });
                    const daysMissingMeta = daysMissingMetaList.length;
                    const daysMissingGoogle = daysMissingGoogleList.length;
                    
                    // Format dates for display (just day numbers)
                    const formatMissingDays = (days) => {
                      if (days.length === 0) return '';
                      if (days.length <= 7) {
                        return days.map(d => parseInt(d.split('-')[2])).join(', ');
                      }
                      // If more than 7, show first 5 + "..."
                      const dayNums = days.map(d => parseInt(d.split('-')[2]));
                      return dayNums.slice(0, 5).join(', ') + ` +${days.length - 5} more`;
                    };
                    
                    // Navigate to prev/next month
                    const goPrevMonth = () => {
                      if (hasPrevMonth) {
                        const [year, month] = sortedMonths[currentMonthIdx - 1].split('-').map(Number);
                        setCalendarMonth({ year, month });
                      }
                    };
                    const goNextMonth = () => {
                      if (hasNextMonth) {
                        const [year, month] = sortedMonths[currentMonthIdx + 1].split('-').map(Number);
                        setCalendarMonth({ year, month });
                      }
                    };
                    const goToLatest = () => setCalendarMonth(null);
                    
                    return (
                      <>
                        {/* Month Header with Navigation */}
                        <div className="flex items-center justify-between mb-4">
                          <div className="flex items-center gap-2">
                            <button 
                              onClick={goPrevMonth}
                              disabled={!hasPrevMonth}
                              className={`w-7 h-7 flex items-center justify-center rounded-lg ${hasPrevMonth ? 'bg-slate-700 hover:bg-slate-600 text-white' : 'bg-slate-800/50 text-slate-600 cursor-not-allowed'}`}
                            >
                              â†
                            </button>
                            <h4 className="text-white font-medium min-w-[140px] text-center">
                              {new Date(viewYear, viewMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                            </h4>
                            <button 
                              onClick={goNextMonth}
                              disabled={!hasNextMonth}
                              className={`w-7 h-7 flex items-center justify-center rounded-lg ${hasNextMonth ? 'bg-slate-700 hover:bg-slate-600 text-white' : 'bg-slate-800/50 text-slate-600 cursor-not-allowed'}`}
                            >
                              â†’
                            </button>
                            {calendarMonth && (
                              <button onClick={goToLatest} className="ml-2 px-2 py-1 text-xs bg-cyan-500/20 text-cyan-400 rounded hover:bg-cyan-500/30">
                                Latest
                              </button>
                            )}
                          </div>
                          <div className="flex items-center gap-4 text-sm">
                            <span className="text-slate-400">{monthDays.length} days</span>
                            <span className="text-emerald-400">{formatCurrency(monthRevenue)}</span>
                            <span className={monthProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}>{formatCurrency(monthProfit)} profit</span>
                          </div>
                        </div>
                        
                        {/* Missing Ads Data Alert */}
                        {monthDays.length > 0 && (daysMissingMeta > 0 || daysMissingGoogle > 0) && (
                          <div className="mb-3 p-2 bg-amber-500/10 border border-amber-500/20 rounded-lg text-xs text-amber-400">
                            <div className="flex items-center gap-2 flex-wrap">
                              <span>âš ï¸ Missing ads data:</span>
                              {daysMissingMeta > 0 && (
                                <span className="px-2 py-0.5 bg-blue-500/20 rounded" title={daysMissingMetaList.join(', ')}>
                                  Meta: {daysMissingMeta} days ({formatMissingDays(daysMissingMetaList)})
                                </span>
                              )}
                              {daysMissingGoogle > 0 && (
                                <span className="px-2 py-0.5 bg-red-500/20 rounded" title={daysMissingGoogleList.join(', ')}>
                                  Google: {daysMissingGoogle} days ({formatMissingDays(daysMissingGoogleList)})
                                </span>
                              )}
                            </div>
                          </div>
                        )}
                        
                        {/* Calendar Grid */}
                        <div className="grid grid-cols-7 gap-1 mb-2">
                          {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                            <div key={day} className="text-center text-xs text-slate-500 py-1">{day}</div>
                          ))}
                        </div>
                        <div className="grid grid-cols-7 gap-1">
                          {/* Padding for days before month starts */}
                          {Array(startPadding).fill(null).map((_, i) => (
                            <div key={`pad-${i}`} className="h-12" />
                          ))}
                          
                          {/* Calendar days */}
                          {Array(totalDays).fill(null).map((_, i) => {
                            const dayNum = i + 1;
                            const dateKey = `${viewYear}-${String(viewMonth + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                            const dayData = allDaysData[dateKey];
                            const hasSales = hasDailySalesData(dayData);
                            const hasAdsOnly = dayData && !hasSales;
                            const isToday = dateKey === formatDateKey(now);
                            const revenue = dayData?.total?.revenue || 0;
                            const profit = dayData?.total?.netProfit || 0;
                            // Check if day has ads data (for indicator)
                            const googleAds = dayData?.shopify?.googleSpend || dayData?.googleSpend || dayData?.googleAds || 0;
                            const metaAds = dayData?.shopify?.metaSpend || dayData?.metaSpend || dayData?.metaAds || 0;
                            const hasAds = googleAds > 0 || metaAds > 0;
                            
                            return (
                              <div 
                                key={dayNum}
                                onClick={() => {
                                  if (hasSales) {
                                    setViewingDayDetails(dateKey);
                                  } else if (hasAdsOnly) {
                                    setSelectedDay(dateKey);
                                    setUploadTab('daily');
                                    setView('upload');
                                  }
                                }}
                                className={`h-12 rounded-lg p-1 text-center relative transition-all ${
                                  hasSales 
                                    ? 'bg-cyan-500/20 hover:bg-cyan-500/30 border border-cyan-500/30 cursor-pointer' 
                                    : hasAdsOnly
                                      ? 'bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/20 cursor-pointer'
                                      : 'bg-slate-800/50 border border-slate-700/50'
                                } ${isToday ? 'ring-2 ring-white/50' : ''}`}
                              >
                                <div className={`text-xs font-medium ${hasSales ? 'text-cyan-300' : hasAdsOnly ? 'text-amber-400/60' : 'text-slate-500'}`}>
                                  {dayNum}
                                  {hasSales && hasAds && <span className="ml-0.5 text-violet-400">â—</span>}
                                </div>
                                {hasSales && (
                                  <div className={`text-[10px] font-medium truncate ${profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                    {formatCurrency(revenue).replace('$', '').replace('.00', '')}
                                  </div>
                                )}
                                {hasAdsOnly && (
                                  <div className="text-[10px] text-amber-400/50">â—</div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                        
                        {/* Legend */}
                        <div className="flex items-center justify-center gap-4 mt-4 text-xs text-slate-400 flex-wrap">
                          <div className="flex items-center gap-1">
                            <div className="w-3 h-3 rounded bg-cyan-500/20 border border-cyan-500/30" />
                            <span>Sales data</span>
                          </div>
                          <div className="flex items-center gap-1">
                            <span className="text-violet-400">â—</span>
                            <span>Has ads data</span>
                          </div>
                          <div className="flex items-center gap-1">
                            <div className="w-3 h-3 rounded bg-amber-500/10 border border-amber-500/20" />
                            <span>Ads only</span>
                          </div>
                          <div className="flex items-center gap-1">
                            <div className="w-3 h-3 rounded bg-slate-800/50 border border-slate-700/50" />
                            <span>No data</span>
                          </div>
                        </div>
                      </>
                    );
                  })()}
                </div>
              )}
              {/* ============ END DAILY CALENDAR ============ */}
              
              
              {/* ============ AI FORECAST SUMMARY ============ */}
              {(aiForecasts || Object.keys(allWeeksData).length >= 4) && (
                <div className="bg-gradient-to-br from-purple-900/20 via-slate-800 to-indigo-900/10 rounded-2xl border border-purple-500/20 p-5">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
                        <Brain className="w-5 h-5 text-purple-400" />
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-white">AI Forecast</h3>
                        {aiForecasts && !aiForecasts.error && aiForecasts.salesForecast?.next4Weeks?.[0] ? (
                          <p className="text-slate-400 text-sm">
                            Next week: {formatCurrency(aiForecasts.salesForecast.next4Weeks[0].predictedRevenue || 0)} revenue
                          </p>
                        ) : (
                          <p className="text-slate-400 text-sm">AI-powered predictions ready to generate</p>
                        )}
                      </div>
                    </div>
                    <button 
                      onClick={() => setView('forecast')}
                      className="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white text-sm font-medium flex items-center gap-2"
                    >
                      <Zap className="w-4 h-4" />
                      {aiForecasts ? 'View Full Forecast' : 'Generate Forecast'}
                    </button>
                  </div>
                  {aiForecasts && aiForecasts.actionableInsights && aiForecasts.actionableInsights.length > 0 && (
                    <div className="mt-3 pt-3 border-t border-slate-700">
                      <p className="text-slate-400 text-xs mb-2">Top Recommendation:</p>
                      <p className="text-white text-sm">{aiForecasts.actionableInsights[0].insight}</p>
                    </div>
                  )}
                </div>
              )}
              {/* ============ END AI FORECAST SUMMARY ============ */}

              
              {/* Check for weeks with missing 3PL or Ad data */}
              {(() => {
                const recentWeeks = Object.entries(allWeeksData)
                  .sort((a, b) => b[0].localeCompare(a[0]))
                  .slice(0, 4); // Check last 4 weeks
                
                const incompleteWeeks = recentWeeks.filter(([key, data]) => {
                  // Check both weekly data AND the 3PL ledger
                  const weeklyHas3PL = data.shopify?.threeplCosts > 0;
                  const ledgerHas3PL = (() => {
                    const ledgerData = get3PLForWeek(threeplLedger, key);
                    return ledgerData && ledgerData.metrics?.totalCost > 0;
                  })();
                  const has3PL = weeklyHas3PL || ledgerHas3PL;
                  const hasAds = (data.shopify?.metaSpend > 0) || (data.shopify?.googleSpend > 0);
                  return !has3PL || !hasAds;
                });
                
                if (incompleteWeeks.length > 0) {
                  return (
                    <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4 mb-6">
                      <div className="flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 text-amber-400 mt-0.5" />
                        <div className="flex-1">
                          <p className="text-amber-300 font-medium mb-2">Some weeks have incomplete cost data</p>
                          <div className="space-y-2">
                            {incompleteWeeks.slice(0, 3).map(([key, data]) => {
                              const missing = [];
                              const weeklyHas3PL = data.shopify?.threeplCosts > 0;
                              const ledgerHas3PL = (() => {
                                const ledgerData = get3PLForWeek(threeplLedger, key);
                                return ledgerData && ledgerData.metrics?.totalCost > 0;
                              })();
                              if (!weeklyHas3PL && !ledgerHas3PL) missing.push('3PL');
                              if (!data.shopify?.metaSpend && !data.shopify?.googleSpend) missing.push('Ads');
                              return (
                                <div key={key} className="flex items-center justify-between text-sm">
                                  <span className="text-slate-400">
                                    Week of {new Date(key + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                    <span className="text-amber-400/70 ml-2">â€” missing {missing.join(' & ')}</span>
                                  </span>
                                  <button 
                                    onClick={() => { setSelectedWeek(key); setView('weekly'); }}
                                    className="text-amber-400 hover:text-amber-300 text-xs underline"
                                  >
                                    Update
                                  </button>
                                </div>
                              );
                            })}
                          </div>
                          {incompleteWeeks.length > 3 && (
                            <p className="text-slate-500 text-xs mt-2">+ {incompleteWeeks.length - 3} more weeks</p>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                }
                return null;
              })()}
              
              {/* Time Range Toggle & Key Metrics */}
              <div className="flex flex-wrap items-center gap-2 mb-4">
                <span className="text-slate-400 text-sm mr-2">View:</span>
                {[
                  { key: 'yesterday', label: 'Yesterday' },
                  { key: 'week', label: 'Week' },
                  { key: 'month', label: 'Month' },
                  { key: 'quarter', label: 'Quarter' },
                  { key: 'year', label: 'Year' },
                ].map(({ key, label }) => (
                  <button
                    key={key}
                    onClick={() => setDashboardRange(key)}
                    className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                      dashboardRange === key
                        ? 'bg-emerald-600 text-white'
                        : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
                    }`}
                  >
                    {label}
                  </button>
                ))}
                {usingPeriodData && (
                  <span className="text-xs text-teal-400 ml-2">(from period data)</span>
                )}
                {usingDailyData && (
                  <span className="text-xs text-cyan-400 ml-2">(from daily data)</span>
                )}
              </div>
              
              {/* No Daily Data Message */}
              {dashboardRange === 'yesterday' && !usingDailyData && (
                <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-8 mb-6 text-center">
                  <Clock className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                  <h3 className="text-lg font-semibold text-white mb-2">No Daily Data Available</h3>
                  <p className="text-slate-400 mb-4">Upload yesterday's sales data to see daily metrics</p>
                  <button 
                    onClick={() => { setUploadTab('daily'); setView('upload'); }}
                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-white font-medium"
                  >
                    Upload Daily Data
                  </button>
                </div>
              )}
              
              {/* Daily Channel Breakdown (only for yesterday view) */}
              {dashboardRange === 'yesterday' && usingDailyData && current.date && (
                <div className="bg-slate-800/50 rounded-2xl border border-cyan-500/30 p-5 mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-sm font-semibold text-cyan-400 uppercase flex items-center gap-2">
                      <Clock className="w-4 h-4" />
                      {new Date(current.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                    </h3>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-orange-900/20 rounded-xl border border-orange-500/30 p-4">
                      <p className="text-orange-400 text-sm font-medium mb-1">ðŸ›’ Amazon</p>
                      <p className="text-xl font-bold text-white">{formatCurrency(current.amazonRev || 0)}</p>
                      <p className="text-slate-500 text-xs mt-1">{current.revenue > 0 ? ((current.amazonRev / current.revenue) * 100).toFixed(0) : 0}% of total</p>
                    </div>
                    <div className="bg-green-900/20 rounded-xl border border-green-500/30 p-4">
                      <p className="text-green-400 text-sm font-medium mb-1">ðŸ›ï¸ Shopify</p>
                      <p className="text-xl font-bold text-white">{formatCurrency(current.shopifyRev || 0)}</p>
                      <p className="text-slate-500 text-xs mt-1">{current.revenue > 0 ? ((current.shopifyRev / current.revenue) * 100).toFixed(0) : 0}% of total</p>
                    </div>
                  </div>
                </div>
              )}
              
              {(dashboardRange !== 'yesterday' || usingDailyData) && (
              <div className="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div className="bg-gradient-to-br from-emerald-900/40 to-emerald-800/20 rounded-2xl border border-emerald-500/30 p-5">
                  <p className="text-emerald-400 text-sm font-medium mb-1">Revenue</p>
                  <p className="text-2xl lg:text-3xl font-bold text-white">{formatCurrency(current.revenue)}</p>
                  {revenueChange !== 0 && (
                    <p className={`text-sm flex items-center gap-1 mt-1 ${revenueChange >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                      {revenueChange >= 0 ? <ArrowUpRight className="w-4 h-4" /> : <ArrowDownRight className="w-4 h-4" />}
                      {Math.abs(revenueChange).toFixed(1)}% {comparisonLabel}
                    </p>
                  )}
                </div>
                <div className={`rounded-2xl border p-5 ${current.profit >= 0 ? 'bg-gradient-to-br from-blue-900/40 to-blue-800/20 border-blue-500/30' : 'bg-gradient-to-br from-rose-900/40 to-rose-800/20 border-rose-500/30'}`}>
                  <p className={`text-sm font-medium mb-1 ${current.profit >= 0 ? 'text-blue-400' : 'text-rose-400'}`}>Net Profit</p>
                  <p className="text-2xl lg:text-3xl font-bold text-white">{formatCurrency(current.profit)}</p>
                  {profitChange !== 0 && (
                    <p className={`text-sm flex items-center gap-1 mt-1 ${profitChange >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                      {profitChange >= 0 ? <ArrowUpRight className="w-4 h-4" /> : <ArrowDownRight className="w-4 h-4" />}
                      {Math.abs(profitChange).toFixed(1)}% {comparisonLabel}
                    </p>
                  )}
                </div>
                <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
                  <p className="text-slate-400 text-sm font-medium mb-1">Units Sold</p>
                  <p className="text-2xl lg:text-3xl font-bold text-white">{formatNumber(current.units)}</p>
                </div>
                <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
                  <p className="text-slate-400 text-sm font-medium mb-1">Ad Spend</p>
                  <p className="text-2xl lg:text-3xl font-bold text-white">{formatCurrency(current.adSpend)}</p>
                  <p className="text-slate-500 text-sm mt-1">{current.revenue > 0 ? ((current.adSpend / current.revenue) * 100).toFixed(1) : 0}% TACOS</p>
                  {(current.googleAds > 0 || current.metaAds > 0 || current.amazonAds > 0) && (
                    <div className="mt-3 pt-3 border-t border-slate-700 space-y-1 text-xs">
                      {current.googleAds > 0 && <div className="flex justify-between"><span className="text-red-400">â— Google</span><span className="text-white">{formatCurrency(current.googleAds)}</span></div>}
                      {current.metaAds > 0 && <div className="flex justify-between"><span className="text-blue-400">â— Meta</span><span className="text-white">{formatCurrency(current.metaAds)}</span></div>}
                      {current.amazonAds > 0 && <div className="flex justify-between"><span className="text-orange-400">â— Amazon</span><span className="text-white">{formatCurrency(current.amazonAds)}</span></div>}
                    </div>
                  )}
                </div>
                <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
                  <p className="text-slate-400 text-sm font-medium mb-1">Net Margin</p>
                  <p className={`text-2xl lg:text-3xl font-bold ${current.revenue > 0 && (current.profit / current.revenue) * 100 >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                    {current.revenue > 0 ? ((current.profit / current.revenue) * 100).toFixed(1) : 0}%
                  </p>
                </div>
              </div>
              )}
              
              {/* Goals Progress */}
              {(goals.weeklyRevenue > 0 || goals.weeklyProfit > 0 || goals.monthlyRevenue > 0 || goals.monthlyProfit > 0) && sortedWeeks.length > 0 ? (
                <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5 mb-6">
                  <h3 className="text-sm font-semibold text-amber-400 uppercase mb-4 flex items-center gap-2"><Target className="w-4 h-4" />Goals Progress</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {goals.weeklyRevenue > 0 && sortedWeeks.length > 0 && (() => {
                      // Calculate current calendar week revenue from daily data
                      const now = new Date();
                      const dayOfWeek = now.getDay(); // 0 = Sunday
                      const daysIntoWeek = dayOfWeek === 0 ? 7 : dayOfWeek;
                      const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysIntoWeek + 1);
                      
                      let weeklyRevenue = 0;
                      for (let i = 0; i < 7; i++) {
                        const d = new Date(weekStart);
                        d.setDate(weekStart.getDate() + i);
                        const dateKey = formatDateKey(d);
                        const dayData = allDaysData[dateKey];
                        // Only include days with actual sales data
                        if (hasDailySalesData(dayData)) {
                          weeklyRevenue += dayData.total?.revenue || 0;
                        }
                      }
                      
                      // If no daily data, fall back to last week's uploaded data
                      if (weeklyRevenue === 0) {
                        const currentWeekKey = getSunday(now);
                        weeklyRevenue = allWeeksData[currentWeekKey]?.total?.revenue || 
                                       allWeeksData[sortedWeeks[sortedWeeks.length - 1]]?.total?.revenue || 0;
                      }
                      
                      return (
                        <div>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-slate-400">Weekly Revenue</span>
                            <span className="text-white">{formatCurrency(weeklyRevenue)} / {formatCurrency(goals.weeklyRevenue)}</span>
                          </div>
                          <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div className={`h-full ${weeklyRevenue >= goals.weeklyRevenue ? 'bg-emerald-500' : 'bg-amber-500'}`} 
                              style={{ width: `${Math.min(100, (weeklyRevenue / goals.weeklyRevenue) * 100)}%` }} />
                          </div>
                        </div>
                      );
                    })()}
                    {goals.weeklyProfit > 0 && sortedWeeks.length > 0 && (() => {
                      // Calculate current calendar week profit from daily data
                      const now = new Date();
                      const dayOfWeek = now.getDay();
                      const daysIntoWeek = dayOfWeek === 0 ? 7 : dayOfWeek;
                      const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysIntoWeek + 1);
                      
                      let weeklyProfit = 0;
                      for (let i = 0; i < 7; i++) {
                        const d = new Date(weekStart);
                        d.setDate(weekStart.getDate() + i);
                        const dateKey = formatDateKey(d);
                        const dayData = allDaysData[dateKey];
                        // Only include days with actual sales data
                        if (hasDailySalesData(dayData)) {
                          weeklyProfit += dayData.total?.netProfit || 0;
                        }
                      }
                      
                      // If no daily data, fall back to last week's uploaded data
                      if (weeklyProfit === 0) {
                        const currentWeekKey = getSunday(now);
                        weeklyProfit = allWeeksData[currentWeekKey]?.total?.netProfit || 
                                      allWeeksData[sortedWeeks[sortedWeeks.length - 1]]?.total?.netProfit || 0;
                      }
                      
                      return (
                        <div>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-slate-400">Weekly Profit</span>
                            <span className="text-white">{formatCurrency(weeklyProfit)} / {formatCurrency(goals.weeklyProfit)}</span>
                          </div>
                          <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div className={`h-full ${weeklyProfit >= goals.weeklyProfit ? 'bg-emerald-500' : 'bg-amber-500'}`}
                              style={{ width: `${Math.min(100, Math.max(0, (weeklyProfit / goals.weeklyProfit) * 100))}%` }} />
                          </div>
                        </div>
                      );
                    })()}
                    {goals.monthlyRevenue > 0 && (
                      <div>
                        <div className="flex justify-between text-sm mb-1">
                          <span className="text-slate-400">Monthly Revenue</span>
                          <span className="text-white">{formatCurrency(current.revenue)} / {formatCurrency(goals.monthlyRevenue)}</span>
                        </div>
                        <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                          <div className={`h-full ${current.revenue >= goals.monthlyRevenue ? 'bg-emerald-500' : 'bg-amber-500'}`}
                            style={{ width: `${Math.min(100, (current.revenue / goals.monthlyRevenue) * 100)}%` }} />
                        </div>
                      </div>
                    )}
                    {goals.monthlyProfit > 0 && (
                      <div>
                        <div className="flex justify-between text-sm mb-1">
                          <span className="text-slate-400">Monthly Profit</span>
                          <span className="text-white">{formatCurrency(current.profit)} / {formatCurrency(goals.monthlyProfit)}</span>
                        </div>
                        <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                          <div className={`h-full ${current.profit >= goals.monthlyProfit ? 'bg-emerald-500' : 'bg-amber-500'}`}
                            style={{ width: `${Math.min(100, Math.max(0, (current.profit / goals.monthlyProfit) * 100))}%` }} />
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              ) : (
                <div className="bg-slate-800/30 rounded-2xl border border-dashed border-slate-600 p-5 mb-6 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <Target className="w-6 h-6 text-slate-500" />
                    <div>
                      <p className="text-slate-400 font-medium">No goals set</p>
                      <p className="text-slate-500 text-sm">Set revenue and profit targets to track your progress</p>
                    </div>
                  </div>
                  <button onClick={() => setShowGoalsModal(true)} className="px-4 py-2 bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 rounded-lg text-amber-300 text-sm font-medium">
                    Set Goals
                  </button>
                </div>
              )}
              
              {/* Quick Actions & Recent Data */}
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                {/* Recent Weeks */}
                <div className="lg:col-span-2 bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-sm font-semibold text-slate-300 uppercase">Recent Weeks</h3>
                    <div className="flex items-center gap-2">
                      {compareMode ? (
                        <span className="text-xs text-violet-400">Select weeks to compare ({compareItems.length}/2)</span>
                      ) : (
                        <button onClick={() => setCompareMode(true)} className="text-xs text-slate-400 hover:text-violet-300 flex items-center gap-1"><GitCompareArrows className="w-3 h-3" />Compare</button>
                      )}
                      <button onClick={() => { setUploadTab('weekly'); setView('upload'); }} className="text-xs text-violet-400 hover:text-violet-300 flex items-center gap-1"><Upload className="w-3 h-3" />Add Week</button>
                    </div>
                  </div>
                  {sortedWeeks.length > 0 ? (
                    <div className="space-y-2">
                      {sortedWeeks.slice(-5).reverse().map(w => {
                        const week = allWeeksData[w];
                        const isSelected = compareItems.includes(w);
                        const note = weekNotes[w];
                        return (
                          <div key={w} className={`flex items-center gap-2 ${compareMode ? '' : ''}`}>
                            {compareMode && (
                              <button onClick={() => {
                                if (isSelected) setCompareItems(p => p.filter(x => x !== w));
                                else if (compareItems.length < 2) setCompareItems(p => [...p, w]);
                              }} className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center flex-shrink-0 ${isSelected ? 'bg-violet-600 border-violet-500' : 'border-slate-600 hover:border-violet-500'}`}>
                                {isSelected && <Check className="w-4 h-4 text-white" />}
                              </button>
                            )}
                            <button onClick={() => { if (!compareMode) { setSelectedWeek(w); setView('weekly'); }}} className={`flex-1 flex items-center justify-between p-3 bg-slate-900/50 hover:bg-slate-700/50 rounded-xl transition-all ${isSelected ? 'ring-2 ring-violet-500' : ''}`}>
                              <div className="flex items-center gap-3">
                                <Calendar className="w-5 h-5 text-violet-400" />
                                <div className="text-left">
                                  <p className="text-white font-medium">{new Date(w + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                  <div className="flex items-center gap-2">
                                    <p className="text-slate-500 text-xs">{formatNumber(week.total?.units || 0)} units</p>
                                    {note && <span className="text-amber-400 text-xs flex items-center gap-0.5"><StickyNote className="w-3 h-3" /></span>}
                                  </div>
                                </div>
                              </div>
                              <div className="text-right">
                                <p className="text-emerald-400 font-semibold">{formatCurrency(week.total?.revenue || 0)}</p>
                                <p className={`text-xs ${(week.total?.netProfit || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(week.total?.netProfit || 0)} profit</p>
                              </div>
                            </button>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <p className="text-slate-500 text-center py-4">No weekly data yet</p>
                  )}
                  {compareMode && compareItems.length === 2 && (
                    <button onClick={() => {}} className="w-full mt-3 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white font-medium text-sm">
                      Compare Selected Weeks
                    </button>
                  )}
                </div>
                
                {/* Quick Stats & Actions */}
                <div className="space-y-4">
                  {/* Data Summary */}
                  <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
                    <h3 className="text-sm font-semibold text-slate-300 uppercase mb-3">Data Summary</h3>
                    <div className="space-y-2">
                      <div className="flex justify-between"><span className="text-slate-400">Weeks tracked</span><span className="text-white font-medium">{Object.keys(allWeeksData).length}</span></div>
                      <div className="flex justify-between"><span className="text-slate-400">Periods saved</span><span className="text-white font-medium">{Object.keys(allPeriodsData).length}</span></div>
                      <div className="flex justify-between"><span className="text-slate-400">COGS entries</span><span className="text-white font-medium">{Object.keys(savedCogs).length}</span></div>
                      <div className="flex justify-between"><span className="text-slate-400">Inventory snapshots</span><span className="text-white font-medium">{Object.keys(invHistory).length}</span></div>
                    </div>
                  </div>
                  
                  {/* Quick Actions */}
                  <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
                    <h3 className="text-sm font-semibold text-slate-300 uppercase mb-3">Quick Actions</h3>
                    <div className="space-y-2">
                      <button onClick={() => { setUploadTab('weekly'); setView('upload'); }} className="w-full p-2 bg-violet-600/20 hover:bg-violet-600/30 border border-violet-500/30 rounded-lg text-violet-300 text-sm text-left flex items-center gap-2"><Upload className="w-4 h-4" />Upload Weekly Data</button>
                      <button onClick={() => { setUploadTab('period'); setView('upload'); }} className="w-full p-2 bg-teal-600/20 hover:bg-teal-600/30 border border-teal-500/30 rounded-lg text-teal-300 text-sm text-left flex items-center gap-2"><CalendarRange className="w-4 h-4" />Upload Period Data</button>
                      <button onClick={() => { setUploadTab('inventory'); setView('upload'); }} className="w-full p-2 bg-emerald-600/20 hover:bg-emerald-600/30 border border-emerald-500/30 rounded-lg text-emerald-300 text-sm text-left flex items-center gap-2"><Boxes className="w-4 h-4" />Upload Inventory</button>
                      <button onClick={exportAll} className="w-full p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300 text-sm text-left flex items-center gap-2"><Download className="w-4 h-4" />Export All Data</button>
                    </div>
                  </div>
                  
                  {/* Banking Summary Widget */}
                  {bankingData.transactions?.length > 0 && (() => {
                    const now = new Date();
                    const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    const lastMonth = now.getMonth() === 0 
                      ? `${now.getFullYear() - 1}-12` 
                      : `${now.getFullYear()}-${String(now.getMonth()).padStart(2, '0')}`;
                    const twoMonthsAgo = now.getMonth() <= 1
                      ? `${now.getFullYear() - 1}-${String(12 + now.getMonth() - 1).padStart(2, '0')}`
                      : `${now.getFullYear()}-${String(now.getMonth() - 1).padStart(2, '0')}`;
                    
                    const thisMonthSnap = bankingData.monthlySnapshots?.[thisMonth] || { income: 0, expenses: 0, net: 0 };
                    const lastMonthSnap = bankingData.monthlySnapshots?.[lastMonth] || { income: 0, expenses: 0, net: 0 };
                    const isStale = !bankingData.lastUpload || new Date().toDateString() !== new Date(bankingData.lastUpload).toDateString();
                    
                    // Filter to only real bank accounts (strict pattern matching)
                    const allAccounts = Object.entries(bankingData.accounts || {});
                    const realAccounts = allAccounts.filter(([name, _]) => {
                      if (!/\(\d{4}\)\s*-\s*\d+$/.test(name)) return false;
                      if (name.includes('"')) return false;
                      if (name.length > 60) return false;
                      if (!/^[A-Za-z]/.test(name.trim())) return false;
                      return true;
                    });
                    const checkingAccounts = realAccounts.filter(([_, a]) => a.type !== 'credit_card');
                    const creditCardAccounts = realAccounts.filter(([_, a]) => a.type === 'credit_card');
                    const totalCash = checkingAccounts.reduce((sum, [_, a]) => sum + (a.balance || 0), 0);
                    const totalDebt = creditCardAccounts.reduce((sum, [_, a]) => sum + Math.abs(a.balance || 0), 0);
                    
                    // Calculate burn rate (average monthly expenses over last 3 months)
                    const recentMonths = Object.keys(bankingData.monthlySnapshots || {}).sort().slice(-3);
                    const avgBurn = recentMonths.length > 0 
                      ? recentMonths.reduce((s, m) => s + (bankingData.monthlySnapshots[m]?.expenses || 0), 0) / recentMonths.length
                      : 0;
                    
                    // Calculate average net cash flow (income - expenses)
                    const avgNetCashFlow = recentMonths.length > 0
                      ? recentMonths.reduce((s, m) => s + (bankingData.monthlySnapshots[m]?.net || 0), 0) / recentMonths.length
                      : 0;
                    
                    // Cash runway - for revenue-generating business, use NET cash flow
                    // If net positive, runway is infinite. If net negative, calculate months until cash runs out.
                    const runway = avgNetCashFlow >= 0 ? 99 : Math.floor(totalCash / Math.abs(avgNetCashFlow));
                    const isCashFlowPositive = avgNetCashFlow >= 0;
                    
                    // Trend: compare this month to last month
                    const trend = thisMonthSnap.net - lastMonthSnap.net;
                    
                    return (
                      <div className={`bg-slate-800/50 rounded-2xl border ${isStale ? 'border-amber-500/50' : 'border-slate-700'} p-5`}>
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="text-sm font-semibold text-slate-300 uppercase flex items-center gap-2">
                            <Landmark className="w-4 h-4 text-green-400" />CFO Dashboard
                          </h3>
                          {isStale && <span className="text-xs text-amber-400 flex items-center gap-1"><AlertTriangle className="w-3 h-3" />Update needed</span>}
                        </div>
                        
                        {/* Cash Position & Debt */}
                        <div className="grid grid-cols-2 gap-3 mb-3">
                          <div className="bg-emerald-900/20 rounded-lg p-3 border border-emerald-500/20">
                            <p className="text-xs text-emerald-400 mb-1">ðŸ’µ Cash Position</p>
                            <p className="text-lg font-bold text-white">{formatCurrency(totalCash)}</p>
                          </div>
                          <div className="bg-rose-900/20 rounded-lg p-3 border border-rose-500/20">
                            <p className="text-xs text-rose-400 mb-1">ðŸ’³ Credit Card Debt</p>
                            <p className="text-lg font-bold text-white">{formatCurrency(totalDebt)}</p>
                          </div>
                        </div>
                        
                        {/* Key Metrics */}
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between items-center">
                            <span className="text-slate-400">Avg Monthly Net</span>
                            <span className={`font-medium ${avgNetCashFlow >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                              {avgNetCashFlow >= 0 ? '+' : ''}{formatCurrency(avgNetCashFlow)}
                            </span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-slate-400">Cash Runway</span>
                            <span className={`font-bold ${isCashFlowPositive ? 'text-emerald-400' : runway > 6 ? 'text-emerald-400' : runway > 3 ? 'text-amber-400' : 'text-rose-400'}`}>
                              {isCashFlowPositive ? 'Cash Flow +' : runway > 12 ? '12+ months' : `${runway} months`}
                            </span>
                          </div>
                          <div className="flex justify-between items-center pt-2 border-t border-slate-700">
                            <span className="text-slate-300">This Month Cash Flow</span>
                            <span className={`font-bold ${thisMonthSnap.net >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                              {formatCurrency(thisMonthSnap.net)}
                            </span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-slate-500 text-xs">vs Last Month</span>
                            <span className={`text-xs flex items-center gap-1 ${trend >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                              {trend >= 0 ? <TrendingUp className="w-3 h-3" /> : <TrendingDown className="w-3 h-3" />}
                              {trend >= 0 ? '+' : ''}{formatCurrency(trend)}
                            </span>
                          </div>
                        </div>
                        
                        <button onClick={() => setView('banking')} className="w-full mt-3 p-2 bg-green-600/20 hover:bg-green-600/30 border border-green-500/30 rounded-lg text-green-300 text-sm flex items-center justify-center gap-2">
                          <BarChart3 className="w-4 h-4" />View Full Banking
                        </button>
                      </div>
                    );
                  })()}
                </div>
              </div>
            </>
          )}
        </div>
      </div>
    );
  }

  // ==================== UPLOAD VIEW (Combined) ====================
  if (view === 'upload' || view === 'period-upload' || view === 'inv-upload') {
    
    // Local FileBox for period uploads
    const PeriodFileBox = ({ type, label, desc, req, multi }) => {
      const hasFile = multi ? (periodFiles[type]?.length > 0) : periodFiles[type];
      const fileName = multi ? (periodFileNames[type]?.join(', ') || '') : periodFileNames[type];
      return (
        <div className={`relative border-2 border-dashed rounded-xl p-4 transition-all ${hasFile ? 'border-emerald-500/50 bg-emerald-950/20' : 'border-slate-600 hover:border-slate-500 bg-slate-800/30'}`}>
          <input type="file" accept=".csv" onChange={(e) => handlePeriodFile(type, e.target.files[0])} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          <div className="flex items-start gap-3">
            {hasFile ? <Check className="w-5 h-5 text-emerald-400 mt-0.5" /> : <FileSpreadsheet className="w-5 h-5 text-slate-400 mt-0.5" />}
            <div className="flex-1 min-w-0">
              <p className={`font-medium ${hasFile ? 'text-emerald-400' : 'text-white'}`}>{label}{req && <span className="text-rose-400 ml-1">*</span>}</p>
              <p className="text-slate-500 text-sm truncate">{hasFile ? fileName : desc}</p>
            </div>
          </div>
        </div>
      );
    };
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-4xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          
          <div className="text-center mb-6">
            <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-violet-500 to-indigo-600 mb-4">
              <Upload className="w-8 h-8 text-white" />
            </div>
            <h1 className="text-2xl lg:text-3xl font-bold text-white mb-2">Upload Data</h1>
            <p className="text-slate-400 mb-3">Import your sales reports and track performance</p>
            <button onClick={() => setShowUploadHelp(true)} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300 flex items-center gap-2 mx-auto">
              <FileText className="w-4 h-4" />How to Get These Files
            </button>
          </div>
          
          <NavTabs />
          
          {/* Upload Type Tabs */}
          <div className="flex gap-2 mb-6 p-1 bg-slate-800/50 rounded-xl overflow-x-auto">
            <button onClick={() => setUploadTab('daily')} className={`flex-1 min-w-fit px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 ${uploadTab === 'daily' ? 'bg-cyan-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <Clock className="w-5 h-5" />Daily
            </button>
            <button onClick={() => setUploadTab('weekly')} className={`flex-1 min-w-fit px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 ${uploadTab === 'weekly' ? 'bg-violet-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <Calendar className="w-5 h-5" />Weekly
            </button>
            <button onClick={() => setUploadTab('period')} className={`flex-1 min-w-fit px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 ${uploadTab === 'period' ? 'bg-teal-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <CalendarRange className="w-5 h-5" />Period
            </button>
            <button onClick={() => setUploadTab('bulk-ads')} className={`flex-1 min-w-fit px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 ${uploadTab === 'bulk-ads' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <DollarSign className="w-5 h-5" />Bulk Ads
            </button>
            <button onClick={() => setUploadTab('inventory')} className={`flex-1 min-w-fit px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 ${uploadTab === 'inventory' ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <Boxes className="w-5 h-5" />Inventory
            </button>
            <button onClick={() => setUploadTab('forecast')} className={`flex-1 min-w-fit px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 ${uploadTab === 'forecast' ? 'bg-amber-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <TrendingUp className="w-5 h-5" />Forecast
            </button>
            <button onClick={() => setUploadTab('shopify-sync')} className={`flex-1 min-w-fit px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 ${uploadTab === 'shopify-sync' ? 'bg-green-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <ShoppingBag className="w-5 h-5" />Shopify Sync
            </button>
          </div>
          
          {/* ============ DATA STATUS DASHBOARD ============ */}
          <div className="mb-6 bg-gradient-to-r from-slate-800/80 to-slate-900/80 rounded-2xl border border-slate-700 p-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                <Database className="w-5 h-5 text-violet-400" />
                Data Status Dashboard
              </h3>
              <div className="flex items-center gap-2">
                {dataStatus.learningStatus.active && (
                  <span className="text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400 flex items-center gap-1">
                    <Brain className="w-3 h-3" />AI Learning Active
                  </span>
                )}
                <span className="text-xs text-slate-500">
                  {dataStatus.dailyStatus.totalDays} days â€¢ {dataStatus.weeklyStatus.totalWeeks} weeks
                </span>
              </div>
            </div>
            
            {/* Action Items */}
            {dataStatus.nextActions.length > 0 && (
              <div className="mb-4 space-y-2">
                {dataStatus.nextActions.slice(0, 3).map((action, idx) => (
                  <div key={idx} className={`flex items-center gap-3 p-2 rounded-lg ${
                    action.priority === 'high' ? 'bg-rose-900/30 border border-rose-500/30' :
                    action.priority === 'medium' ? 'bg-amber-900/30 border border-amber-500/30' :
                    'bg-slate-700/30 border border-slate-600/30'
                  }`}>
                    {action.priority === 'high' ? <AlertCircle className="w-4 h-4 text-rose-400" /> :
                     action.priority === 'medium' ? <Clock className="w-4 h-4 text-amber-400" /> :
                     <Bell className="w-4 h-4 text-slate-400" />}
                    <span className={`text-sm flex-1 ${
                      action.priority === 'high' ? 'text-rose-300' :
                      action.priority === 'medium' ? 'text-amber-300' :
                      'text-slate-400'
                    }`}>{action.message}</span>
                    {action.action === 'upload-forecast' && (
                      <button onClick={() => { setUploadTab('forecast'); setView('upload'); }} className="text-xs px-2 py-1 bg-amber-600 hover:bg-amber-500 rounded text-white">Upload</button>
                    )}
                    {action.action === 'upload-daily' && (
                      <button onClick={() => { setUploadTab('daily'); setView('upload'); }} className="text-xs px-2 py-1 bg-cyan-600 hover:bg-cyan-500 rounded text-white">Upload</button>
                    )}
                    {action.action === 'upload-weekly' && (
                      <button onClick={() => { setUploadTab('weekly'); setView('upload'); }} className="text-xs px-2 py-1 bg-violet-600 hover:bg-violet-500 rounded text-white">Upload</button>
                    )}
                    {action.action === 'aggregate-daily' && (
                      <button onClick={aggregateDailyToWeekly} className="text-xs px-2 py-1 bg-teal-600 hover:bg-teal-500 rounded text-white">Aggregate</button>
                    )}
                  </div>
                ))}
              </div>
            )}
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {/* Forecast Status */}
              <div className="bg-slate-900/50 rounded-xl p-3">
                <h4 className="text-sm font-medium text-amber-400 mb-2 flex items-center gap-2">
                  <TrendingUp className="w-4 h-4" />Forecasts
                </h4>
                <div className="space-y-2">
                  {Object.entries(dataStatus.forecastStatus).map(([key, f]) => (
                    <div key={key} className="flex items-center justify-between text-xs">
                      <span className="text-slate-400">{f.type}</span>
                      <span className={`px-2 py-0.5 rounded ${
                        f.status === 'active' ? 'bg-green-500/20 text-green-400' :
                        f.status === 'expiring' ? 'bg-amber-500/20 text-amber-400' :
                        f.status === 'expired' ? 'bg-rose-500/20 text-rose-400' :
                        'bg-slate-600/50 text-slate-500'
                      }`}>
                        {f.status === 'active' ? `${f.daysUntilExpiry}d left` :
                         f.status === 'expiring' ? `${f.daysUntilExpiry}d left!` :
                         f.status === 'expired' ? 'Expired' :
                         'Not uploaded'}
                      </span>
                    </div>
                  ))}
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  {dataStatus.forecastWeeks.length} weeks with forecast data
                </p>
              </div>
              
              {/* Daily Data Status - Mini Calendar */}
              <div className="bg-slate-900/50 rounded-xl p-3">
                <h4 className="text-sm font-medium text-cyan-400 mb-2 flex items-center gap-2">
                  <Clock className="w-4 h-4" />Daily Data (Last 14 Days)
                </h4>
                <div className="grid grid-cols-7 gap-1">
                  {dataStatus.dailyStatus.last14Days.map((day, idx) => (
                    <div 
                      key={idx}
                      className={`w-6 h-6 rounded flex items-center justify-center text-xs cursor-pointer transition-all ${
                        day.hasData ? 'bg-cyan-500/30 text-cyan-300 hover:bg-cyan-500/50' : day.hasAdsOnly ? 'bg-amber-500/20 text-amber-400/60' : 'bg-slate-700/50 text-slate-600 hover:bg-slate-600/50'
                      }`}
                      title={`${day.date}${day.hasData ? ' âœ“' : day.hasAdsOnly ? ' (ads only)' : ' (no data)'}`}
                    >
                      {new Date(day.date + 'T12:00:00').getDate()}
                    </div>
                  ))}
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  {dataStatus.dailyStatus.totalDays} total days â€¢ {dataStatus.dataFlow.weeksFromDaily} weeks
                </p>
              </div>
              
              {/* Learning Status */}
              <div className="bg-slate-900/50 rounded-xl p-3">
                <h4 className="text-sm font-medium text-purple-400 mb-2 flex items-center gap-2">
                  <Brain className="w-4 h-4" />Self-Learning
                </h4>
                <div className="space-y-2">
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-slate-400">Status</span>
                    <span className={`px-2 py-0.5 rounded ${
                      dataStatus.learningStatus.active ? 'bg-green-500/20 text-green-400' : 'bg-amber-500/20 text-amber-400'
                    }`}>
                      {dataStatus.learningStatus.active ? 'Active' : 'Training'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-slate-400">Confidence</span>
                    <span className="text-slate-300">{dataStatus.learningStatus.confidence.toFixed(0)}%</span>
                  </div>
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-slate-400">Samples</span>
                    <span className="text-slate-300">{dataStatus.learningStatus.samples} comparisons</span>
                  </div>
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-slate-400">Pending</span>
                    <span className={dataStatus.learningStatus.pendingComparisons > 0 ? 'text-amber-400' : 'text-slate-500'}>
                      {dataStatus.learningStatus.pendingComparisons} awaiting actuals
                    </span>
                  </div>
                </div>
                <div className="mt-2">
                  <div className="w-full h-1.5 bg-slate-700 rounded-full overflow-hidden">
                    <div 
                      className={`h-full transition-all ${dataStatus.learningStatus.active ? 'bg-green-500' : 'bg-amber-500'}`}
                      style={{ width: `${Math.min(100, dataStatus.learningStatus.confidence)}%` }}
                    />
                  </div>
                </div>
              </div>
            </div>
            
            {/* Data Flow Explanation */}
            <div className="mt-4 pt-3 border-t border-slate-700/50">
              <p className="text-xs text-slate-500 flex items-center gap-2 flex-wrap">
                <span className="flex items-center gap-1"><Clock className="w-3 h-3" />Daily</span>
                <span>â†’</span>
                <span className="flex items-center gap-1"><Calendar className="w-3 h-3" />Weekly ({dataStatus.weeklyStatus.totalWeeks})</span>
                <span>â†’</span>
                <span className="flex items-center gap-1"><TrendingUp className="w-3 h-3" />Forecasts ({dataStatus.forecastWeeks.length})</span>
                <span>â†’</span>
                <span className="flex items-center gap-1"><Brain className="w-3 h-3" />Learning ({dataStatus.learningStatus.samples})</span>
                <span>â†’</span>
                <span className="flex items-center gap-1"><Boxes className="w-3 h-3" />Inventory</span>
                {dataStatus.learningStatus.active && (
                  <span className="ml-auto text-green-400 flex items-center gap-1">
                    <Check className="w-3 h-3" />Corrections Active!
                  </span>
                )}
              </p>
            </div>
          </div>
          {/* ============ END DATA STATUS DASHBOARD ============ */}
          
          {/* Daily Upload */}
          {uploadTab === 'daily' && (
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
              <h2 className="text-lg font-semibold text-white mb-1">ðŸ“… Daily Sales Upload</h2>
              <p className="text-slate-400 text-sm mb-4">Upload yesterday's Amazon, Shopify, and ad data for daily tracking</p>
              
              {/* Already uploaded days indicator */}
              <div className="bg-slate-900/50 rounded-xl p-4 mb-6">
                <div className="flex items-center justify-between mb-3">
                  <span className="text-sm font-medium text-slate-300">Days Already Uploaded (Last 14 Days)</span>
                  <span className="text-xs text-slate-500">{dataStatus.dailyStatus.last14Days.filter(d => d.hasData).length}/14 days</span>
                </div>
                <div className="flex flex-wrap gap-2">
                  {dataStatus.dailyStatus.last14Days.map((day, idx) => (
                    <div 
                      key={idx}
                      onClick={() => !day.hasData && setSelectedDay(day.date)}
                      className={`px-3 py-1.5 rounded-lg text-xs font-medium cursor-pointer transition-all ${
                        day.hasData 
                          ? 'bg-cyan-500/20 text-cyan-300 border border-cyan-500/30' 
                          : day.hasAdsOnly
                            ? 'bg-amber-500/10 text-amber-400/70 border border-amber-500/20 hover:bg-amber-500/20'
                            : selectedDay === day.date
                              ? 'bg-violet-500/30 text-violet-300 border border-violet-500/50'
                              : 'bg-slate-700/50 text-slate-400 border border-slate-600/30 hover:bg-slate-600/50'
                      }`}
                      title={day.hasData ? `${day.date} - Data uploaded âœ“` : day.hasAdsOnly ? `${day.date} - Only Google Ads data (click to add sales)` : `${day.date} - Click to select`}
                    >
                      {day.dayOfWeek} {new Date(day.date + 'T12:00:00').getDate()}
                      {day.hasData && <Check className="w-3 h-3 ml-1 inline" />}
                      {day.hasAdsOnly && !day.hasData && <span className="ml-1 text-amber-400/50">â—</span>}
                    </div>
                  ))}
                </div>
                {dataStatus.dailyStatus.last14Days.filter(d => !d.hasData).length > 0 && (
                  <p className="text-xs text-slate-500 mt-2">
                    ðŸ’¡ Click a day without âœ“ to select it for upload {dataStatus.dailyStatus.last14Days.some(d => d.hasAdsOnly && !d.hasData) && <span className="text-amber-400/70">(â— = has Google Ads data only)</span>}
                  </p>
                )}
              </div>
              
              <div className="mb-6">
                <label className="block text-sm font-medium text-slate-300 mb-2">Date <span className="text-rose-400">*</span></label>
                <input 
                  type="date" 
                  value={selectedDay || ''} 
                  onChange={(e) => setSelectedDay(e.target.value)} 
                  max={new Date().toISOString().split('T')[0]}
                  className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white" 
                />
                {selectedDay && (
                  <div className="mt-2">
                    <p className="text-slate-500 text-sm">
                      Uploading data for: {new Date(selectedDay + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                    </p>
                    {hasDailySalesData(allDaysData[selectedDay]) && (
                      <p className="text-amber-400 text-sm flex items-center gap-1 mt-1">
                        <AlertTriangle className="w-4 h-4" />
                        Sales data already exists for this date - uploading will replace it
                      </p>
                    )}
                    {allDaysData[selectedDay] && !hasDailySalesData(allDaysData[selectedDay]) && (
                      <p className="text-cyan-400 text-sm flex items-center gap-1 mt-1">
                        <Check className="w-4 h-4" />
                        Google Ads data exists - sales data will be added
                      </p>
                    )}
                  </div>
                )}
              </div>
              
              {/* File uploads for daily data */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div className={`relative border-2 border-dashed rounded-xl p-4 transition-all ${dailyFiles.amazon ? 'border-orange-500/50 bg-orange-950/20' : 'border-slate-600 hover:border-slate-500 bg-slate-800/30'}`}>
                  <input type="file" accept=".csv" onChange={(e) => setDailyFiles(prev => ({ ...prev, amazon: e.target.files[0] }))} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                  <div className="flex items-start gap-3">
                    {dailyFiles.amazon ? <Check className="w-5 h-5 text-orange-400 mt-0.5" /> : <FileSpreadsheet className="w-5 h-5 text-slate-400 mt-0.5" />}
                    <div className="flex-1 min-w-0">
                      <p className={`font-medium ${dailyFiles.amazon ? 'text-orange-400' : 'text-white'}`}>Amazon Daily Report</p>
                      <p className="text-slate-500 text-sm truncate">{dailyFiles.amazon ? dailyFiles.amazon.name : 'SKU Economics for single day'}</p>
                    </div>
                  </div>
                </div>
                
                <div className={`relative border-2 border-dashed rounded-xl p-4 transition-all ${dailyFiles.shopify ? 'border-blue-500/50 bg-blue-950/20' : 'border-slate-600 hover:border-slate-500 bg-slate-800/30'}`}>
                  <input type="file" accept=".csv" onChange={(e) => setDailyFiles(prev => ({ ...prev, shopify: e.target.files[0] }))} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                  <div className="flex items-start gap-3">
                    {dailyFiles.shopify ? <Check className="w-5 h-5 text-blue-400 mt-0.5" /> : <FileSpreadsheet className="w-5 h-5 text-slate-400 mt-0.5" />}
                    <div className="flex-1 min-w-0">
                      <p className={`font-medium ${dailyFiles.shopify ? 'text-blue-400' : 'text-white'}`}>Shopify Daily Report</p>
                      <p className="text-slate-500 text-sm truncate">{dailyFiles.shopify ? dailyFiles.shopify.name : 'Sales by product for single day'}</p>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Ad Spend Inputs */}
              <div className="grid grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">Meta Ad Spend ($)</label>
                  <input 
                    type="number" 
                    step="0.01" 
                    id="daily-meta-ad"
                    defaultValue={dailyAdSpend.meta} 
                    onBlur={(e) => setDailyAdSpend(prev => ({ ...prev, meta: e.target.value }))} 
                    placeholder="0.00" 
                    className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" 
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">Google Ad Spend ($)</label>
                  <input 
                    type="number" 
                    step="0.01" 
                    id="daily-google-ad"
                    defaultValue={dailyAdSpend.google} 
                    onBlur={(e) => setDailyAdSpend(prev => ({ ...prev, google: e.target.value }))} 
                    placeholder="0.00" 
                    className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" 
                  />
                </div>
              </div>
              
              {/* Process Button */}
              <button 
                onClick={processDailyUpload} 
                disabled={!selectedDay || (!dailyFiles.amazon && !dailyFiles.shopify) || isProcessing}
                className="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed rounded-xl font-semibold text-lg flex items-center justify-center gap-2"
              >
                {isProcessing ? <><Loader2 className="w-5 h-5 animate-spin" />Processing...</> : <><Upload className="w-5 h-5" />Process Daily Data</>}
              </button>
              
              {/* Existing Days */}
              {Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).length > 0 && (
                <div className="mt-6 pt-6 border-t border-slate-700">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-sm font-medium text-slate-300">Recent Daily Data ({Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).length} days with sales)</h3>
                    <button 
                      onClick={aggregateDailyToWeekly}
                      disabled={dataStatus.aggregationStatus.completeWeeks === 0}
                      className={`px-3 py-1.5 rounded-lg text-sm flex items-center gap-2 ${
                        dataStatus.aggregationStatus.completeWeeks > 0 
                          ? 'bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/50 text-violet-300'
                          : 'bg-slate-700/50 border border-slate-600/50 text-slate-500 cursor-not-allowed'
                      }`}
                    >
                      <RefreshCw className="w-4 h-4" />
                      Aggregate to Weekly {dataStatus.aggregationStatus.completeWeeks > 0 && `(${dataStatus.aggregationStatus.completeWeeks} ready)`}
                    </button>
                  </div>
                  
                  {/* Week completion status */}
                  {dataStatus.aggregationStatus.weekDetails.length > 0 && (
                    <div className="mb-4 space-y-2">
                      {dataStatus.aggregationStatus.weekDetails.slice(0, 3).map(week => (
                        <div key={week.weekEnding} className={`p-3 rounded-lg border ${
                          week.isComplete 
                            ? allWeeksData[week.weekEnding] 
                              ? 'bg-slate-700/30 border-slate-600/30'
                              : 'bg-emerald-900/20 border-emerald-500/30'
                            : 'bg-amber-900/20 border-amber-500/30'
                        }`}>
                          <div className="flex items-center justify-between">
                            <span className={`text-sm font-medium ${
                              week.isComplete 
                                ? allWeeksData[week.weekEnding] ? 'text-slate-400' : 'text-emerald-300'
                                : 'text-amber-300'
                            }`}>
                              Week ending {new Date(week.weekEnding + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                            </span>
                            <span className={`text-xs px-2 py-0.5 rounded ${
                              week.isComplete 
                                ? allWeeksData[week.weekEnding]
                                  ? 'bg-slate-600/50 text-slate-400'
                                  : 'bg-emerald-500/20 text-emerald-300'
                                : 'bg-amber-500/20 text-amber-300'
                            }`}>
                              {week.isComplete 
                                ? allWeeksData[week.weekEnding] ? 'Already aggregated' : `âœ“ Complete (${week.days.length}/7 days)`
                                : `${week.days.length}/7 days`
                              }
                            </span>
                          </div>
                          {!week.isComplete && week.missingDays.length > 0 && (
                            <p className="text-xs text-amber-400/80 mt-1">
                              Missing: {week.missingDays.map(d => d.display).join(', ')}
                            </p>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                  
                  <div className="flex flex-wrap gap-2 mb-3">
                    {Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort().reverse().slice(0, 14).map(day => (
                      <div key={day} className="px-3 py-1.5 bg-slate-700/50 rounded-lg text-sm text-slate-300 flex items-center gap-2">
                        <span>{new Date(day + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                        <span className="text-emerald-400 text-xs">{formatCurrency(allDaysData[day].total?.revenue || 0)}</span>
                      </div>
                    ))}
                  </div>
                  <p className="text-slate-500 text-xs">ðŸ’¡ Weeks require all 7 days (Mon-Sun) to aggregate</p>
                </div>
              )}
            </div>
          )}
          
          {/* Weekly Upload */}
          {uploadTab === 'weekly' && (
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
              <h2 className="text-lg font-semibold text-white mb-1">Weekly Sales Upload</h2>
              <p className="text-slate-400 text-sm mb-4">Upload your Amazon and Shopify weekly reports</p>
              
              {/* Weeks with forecasts needing actuals */}
              {dataStatus.learningStatus.pendingComparisons > 0 && (
                <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4 mb-6">
                  <h3 className="text-amber-300 font-medium mb-2 flex items-center gap-2">
                    <Brain className="w-4 h-4" />
                    Learning System Needs Your Data!
                  </h3>
                  <p className="text-slate-300 text-sm mb-3">
                    These weeks have forecast data but no actuals. Upload actuals to help improve predictions:
                  </p>
                  <div className="flex flex-wrap gap-2">
                    {Object.keys(amazonForecasts)
                      .filter(w => new Date(w + 'T00:00:00') < new Date() && !allWeeksData[w])
                      .sort()
                      .slice(0, 5)
                      .map(w => (
                        <button 
                          key={w}
                          onClick={() => setWeekEnding(w)}
                          className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                            weekEnding === w 
                              ? 'bg-amber-500/40 text-amber-200 border border-amber-500/50' 
                              : 'bg-slate-700/50 text-amber-400 border border-amber-500/30 hover:bg-amber-500/20'
                          }`}
                        >
                          Week ending {new Date(w + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        </button>
                      ))
                    }
                  </div>
                </div>
              )}
              
              <div className="mb-6">
                <label className="block text-sm font-medium text-slate-300 mb-2">Week Ending Date <span className="text-rose-400">*</span></label>
                <input type="date" value={weekEnding} onChange={(e) => setWeekEnding(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white" />
                {weekEnding && (
                  <div className="mt-2">
                    <div className="flex items-center gap-2 flex-wrap">
                      {amazonForecasts[weekEnding] && (
                        <span className="text-xs px-2 py-1 rounded bg-amber-500/20 text-amber-300 flex items-center gap-1">
                          <TrendingUp className="w-3 h-3" />Has forecast data
                        </span>
                      )}
                      {allWeeksData[weekEnding] && (
                        <span className="text-xs px-2 py-1 rounded bg-cyan-500/20 text-cyan-300 flex items-center gap-1">
                          <Check className="w-3 h-3" />Has actual data (will update)
                        </span>
                      )}
                      {amazonForecasts[weekEnding] && !allWeeksData[weekEnding] && (
                        <span className="text-xs px-2 py-1 rounded bg-green-500/20 text-green-300 flex items-center gap-1">
                          <Brain className="w-3 h-3" />Will create learning sample!
                        </span>
                      )}
                    </div>
                    {/* Detailed warning for existing data */}
                    {allWeeksData[weekEnding] && (
                      <div className="mt-2 p-3 bg-amber-900/30 border border-amber-500/30 rounded-lg">
                        <div className="flex items-start gap-2">
                          <AlertTriangle className="w-4 h-4 text-amber-400 mt-0.5 flex-shrink-0" />
                          <div>
                            <p className="text-amber-300 text-sm font-medium">Data already exists for this week</p>
                            <p className="text-amber-400/70 text-xs mt-1">
                              Existing: {formatCurrency(allWeeksData[weekEnding].total?.revenue || 0)} revenue â€¢ {allWeeksData[weekEnding].total?.units || 0} units â€¢ {formatCurrency(allWeeksData[weekEnding].total?.netProfit || 0)} profit
                            </p>
                            <p className="text-slate-400 text-xs mt-1">Uploading new data will replace all existing data for this week.</p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
              
              {/* Date Range Guide */}
              {weekEnding && (() => {
                const endDate = new Date(weekEnding + 'T00:00:00');
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 6);
                const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const formatShort = (d) => d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
                return (
                  <div className="bg-indigo-900/30 border border-indigo-500/30 rounded-xl p-4 mb-6">
                    <h3 className="text-indigo-300 font-semibold mb-3 flex items-center gap-2">
                      <Calendar className="w-4 h-4" />
                      Date Ranges for Week: {formatDate(startDate)} â€“ {formatDate(endDate)}
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                      <div className="bg-slate-800/50 rounded-lg p-3">
                        <p className="text-orange-400 font-medium mb-1">ðŸ“¦ Amazon SKU Economics</p>
                        <p className="text-white font-mono text-xs">{formatShort(startDate)} â†’ {formatShort(endDate)}</p>
                        <p className="text-slate-400 text-xs mt-1">Seller Central â†’ Reports â†’ Business Reports â†’ SKU Economics</p>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-3">
                        <p className="text-blue-400 font-medium mb-1">ðŸ›’ Shopify Sales by Product</p>
                        <p className="text-white font-mono text-xs">{formatShort(startDate)} â†’ {formatShort(endDate)}</p>
                        <p className="text-slate-400 text-xs mt-1">Analytics â†’ Reports â†’ Sales by product variant SKU</p>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-3">
                        <p className="text-teal-400 font-medium mb-1">ðŸšš 3PL Invoice (if applicable)</p>
                        <p className="text-white font-mono text-xs">{formatShort(startDate)} â†’ {formatShort(endDate)}</p>
                        <p className="text-slate-400 text-xs mt-1">Download fulfillment invoice for this week</p>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-3">
                        <p className="text-violet-400 font-medium mb-1">ðŸ“£ Ad Spend (Meta/Google)</p>
                        <p className="text-white font-mono text-xs">{formatShort(startDate)} â†’ {formatShort(endDate)}</p>
                        <p className="text-slate-400 text-xs mt-1">Enter total spend for this 7-day period</p>
                      </div>
                    </div>
                  </div>
                );
              })()}
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <FileBox type="amazon" label="Amazon Report" desc="Business Reports > Detail Page" req />
                <FileBox type="shopify" label="Shopify Sales" desc="Analytics > Sales by product" req />
                <div className="relative">
                  <FileBox type="threepl" label="3PL Costs" desc="Fulfillment invoice (CSV or Excel)" multi />
                  <button 
                    onClick={() => setShow3PLBulkUpload(true)} 
                    className="absolute top-2 right-2 px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs text-white flex items-center gap-1"
                    title="Bulk upload multiple 3PL files with deduplication"
                  >
                    <Upload className="w-3 h-3" />Bulk
                  </button>
                </div>
                <FileBox type="cogs" label="COGS File" desc="SKU & Cost Per Unit columns" />
              </div>
              
              {/* 3PL Bulk Upload Banner */}
              <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4 mb-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <Truck className="w-8 h-8 text-blue-400" />
                    <div>
                      <p className="text-white font-medium">3PL Bulk Upload</p>
                      <p className="text-slate-400 text-sm">Upload multiple Packiyo Excel files at once with auto-deduplication</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => setShow3PLBulkUpload(true)}
                    className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-medium flex items-center gap-2"
                  >
                    <Upload className="w-4 h-4" />
                    Upload 3PL Files
                  </button>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div><label className="block text-sm text-slate-400 mb-2">Meta Ad Spend</label><input type="number" id="weekly-meta-ad" defaultValue={adSpend.meta} onBlur={(e) => setAdSpend(p => ({ ...p, meta: e.target.value }))} placeholder="0.00" className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-violet-500" /></div>
                <div><label className="block text-sm text-slate-400 mb-2">Google Ad Spend</label><input type="number" id="weekly-google-ad" defaultValue={adSpend.google} onBlur={(e) => setAdSpend(p => ({ ...p, google: e.target.value }))} placeholder="0.00" className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-violet-500" /></div>
              </div>
              
              {/* Ads Bulk Upload Banner */}
              <div className="bg-violet-900/20 border border-violet-500/30 rounded-xl p-4 mb-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <TrendingUp className="w-8 h-8 text-violet-400" />
                    <div>
                      <p className="text-white font-medium">Bulk Upload Ad Spend Data</p>
                      <p className="text-slate-400 text-sm">Import Meta & Google Ads CSV exports with full metrics</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => setShowAdsBulkUpload(true)}
                    className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white font-medium flex items-center gap-2"
                  >
                    <Upload className="w-4 h-4" />
                    Upload Ads Data
                  </button>
                </div>
              </div>
              
              {!hasCogs && <div className="bg-amber-900/30 border border-amber-500/50 rounded-xl p-4 mb-6 flex items-start gap-3"><AlertTriangle className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" /><div><p className="text-amber-300 font-medium">COGS not set up</p><p className="text-amber-200/70 text-sm">Upload a COGS file or configure in settings for profit tracking</p></div></div>}
              
              <button onClick={processSales} disabled={isProcessing || !files.amazon || !files.shopify || !weekEnding || !hasCogs} className="w-full bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 disabled:from-slate-700 disabled:to-slate-700 text-white font-semibold py-4 rounded-xl">{isProcessing ? 'Processing...' : 'Process Weekly Data'}</button>
            </div>
          )}
          
          {/* Period Upload */}
          {uploadTab === 'period' && (
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
              <h2 className="text-lg font-semibold text-white mb-1">Period Upload</h2>
              <p className="text-slate-400 text-sm mb-6">Upload monthly or yearly totals for historical tracking</p>
              
              <div className="mb-6">
                <label className="block text-sm font-medium text-slate-300 mb-2">Period Label <span className="text-rose-400">*</span></label>
                <input type="text" id="period-label-input" defaultValue={periodLabel} onBlur={(e) => setPeriodLabel(e.target.value)} placeholder="e.g., 2024, Q1 2025, January 2025" className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-violet-500" />
                <p className="text-slate-500 text-xs mt-1">Tip: Use "2024" or "2025" for YoY comparisons</p>
              </div>
              
              {/* Period Date Range Guide */}
              {periodLabel && (() => {
                // Try to determine date range from label
                let startDate = '', endDate = '', suggestion = '';
                const label = periodLabel.trim().toLowerCase();
                const currentYear = new Date().getFullYear();
                
                if (/^20\d{2}$/.test(periodLabel.trim())) {
                  // Full year like "2024"
                  startDate = `01/01/${periodLabel.trim()}`;
                  endDate = `12/31/${periodLabel.trim()}`;
                  suggestion = `Full year ${periodLabel.trim()}`;
                } else if (/q[1-4]\s*20\d{2}/i.test(label)) {
                  // Quarter like "Q1 2025"
                  const match = label.match(/q([1-4])\s*(20\d{2})/i);
                  if (match) {
                    const q = parseInt(match[1]);
                    const y = match[2];
                    const qStarts = ['01/01', '04/01', '07/01', '10/01'];
                    const qEnds = ['03/31', '06/30', '09/30', '12/31'];
                    startDate = `${qStarts[q-1]}/${y}`;
                    endDate = `${qEnds[q-1]}/${y}`;
                    suggestion = `Q${q} ${y}`;
                  }
                }
                
                if (startDate && endDate) {
                  return (
                    <div className="bg-teal-900/20 border border-teal-500/30 rounded-xl p-4 mb-6">
                      <h3 className="text-teal-300 font-semibold mb-3 flex items-center gap-2">
                        <CalendarRange className="w-4 h-4" />
                        Date Range for "{suggestion}"
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <p className="text-orange-400 font-medium mb-1">ðŸ“¦ Amazon SKU Economics</p>
                          <p className="text-white font-mono">{startDate} â†’ {endDate}</p>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <p className="text-blue-400 font-medium mb-1">ðŸ›’ Shopify Sales by Product</p>
                          <p className="text-white font-mono">{startDate} â†’ {endDate}</p>
                        </div>
                      </div>
                      <p className="text-slate-400 text-xs mt-3">Make sure both reports use the same date range</p>
                    </div>
                  );
                }
                return null;
              })()}
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <PeriodFileBox type="amazon" label="Amazon Report" desc="Business Reports" req />
                <PeriodFileBox type="shopify" label="Shopify Sales" desc="Sales by product" req />
                <PeriodFileBox type="threepl" label="3PL Costs" desc="Fulfillment file (CSV or Excel)" multi />
              </div>
              
              <div className="grid grid-cols-2 gap-4 mb-6">
                <div><label className="block text-sm text-slate-400 mb-2">Meta Ad Spend</label><input type="number" id="period-meta-ad" defaultValue={periodAdSpend.meta} onBlur={(e) => setPeriodAdSpend(p => ({ ...p, meta: e.target.value }))} placeholder="0.00" className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-500" /></div>
                <div><label className="block text-sm text-slate-400 mb-2">Google Ad Spend</label><input type="number" id="period-google-ad" defaultValue={periodAdSpend.google} onBlur={(e) => setPeriodAdSpend(p => ({ ...p, google: e.target.value }))} placeholder="0.00" className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-500" /></div>
              </div>
              
              {!hasCogs && <div className="bg-amber-900/30 border border-amber-500/50 rounded-xl p-4 mb-6 flex items-start gap-3"><AlertTriangle className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" /><div><p className="text-amber-300 font-medium">COGS not set up</p><p className="text-amber-200/70 text-sm">Upload a COGS file or configure in settings for profit tracking</p></div></div>}
              
              <button onClick={processPeriod} disabled={isProcessing || !periodFiles.amazon || !periodFiles.shopify || !periodLabel.trim() || !hasCogs} className="w-full bg-gradient-to-r from-teal-600 to-emerald-600 hover:from-teal-500 hover:to-emerald-500 disabled:from-slate-700 disabled:to-slate-700 text-white font-semibold py-4 rounded-xl">{isProcessing ? 'Processing...' : 'Save Period Data'}</button>
            </div>
          )}
          
          {/* Bulk Ads Upload */}
          {uploadTab === 'bulk-ads' && (
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
              <h2 className="text-lg font-semibold text-white mb-1">ðŸ“Š Bulk Ad Spend Upload</h2>
              <p className="text-slate-400 text-sm mb-6">Upload Google Ads or Meta Ads exports to bulk update ad spend across multiple weeks</p>
              
              {/* Platform Selection */}
              <div className="mb-6">
                <label className="block text-sm font-medium text-slate-300 mb-2">Ad Platform</label>
                <div className="grid grid-cols-2 gap-3">
                  <button 
                    onClick={() => setBulkAdPlatform('google')}
                    className={`p-4 rounded-xl border-2 flex items-center gap-3 transition-all ${bulkAdPlatform === 'google' ? 'bg-red-900/30 border-red-500' : 'bg-slate-900/50 border-slate-700 hover:border-slate-500'}`}
                  >
                    <div className="w-10 h-10 rounded-lg bg-red-600/20 flex items-center justify-center">
                      <span className="text-xl">ðŸ”´</span>
                    </div>
                    <div className="text-left">
                      <p className={`font-medium ${bulkAdPlatform === 'google' ? 'text-red-400' : 'text-white'}`}>Google Ads</p>
                      <p className="text-xs text-slate-500">Time series export</p>
                    </div>
                  </button>
                  <button 
                    onClick={() => setBulkAdPlatform('meta')}
                    className={`p-4 rounded-xl border-2 flex items-center gap-3 transition-all ${bulkAdPlatform === 'meta' ? 'bg-blue-900/30 border-blue-500' : 'bg-slate-900/50 border-slate-700 hover:border-slate-500'}`}
                  >
                    <div className="w-10 h-10 rounded-lg bg-blue-600/20 flex items-center justify-center">
                      <span className="text-xl">ðŸ”µ</span>
                    </div>
                    <div className="text-left">
                      <p className={`font-medium ${bulkAdPlatform === 'meta' ? 'text-blue-400' : 'text-white'}`}>Meta Ads</p>
                      <p className="text-xs text-slate-500">Facebook/Instagram</p>
                    </div>
                  </button>
                </div>
              </div>
              
              {/* File Upload */}
              <div className="mb-6">
                <label className="block text-sm font-medium text-slate-300 mb-2">Upload CSV Files (select multiple)</label>
                <div 
                  className={`border-2 border-dashed rounded-xl p-6 text-center cursor-pointer transition-all ${bulkAdFiles.length > 0 ? 'border-emerald-500/50 bg-emerald-900/20' : 'border-slate-600 hover:border-slate-500'}`}
                  onClick={() => document.getElementById('bulk-ad-file')?.click()}
                >
                  <input 
                    type="file" 
                    id="bulk-ad-file" 
                    accept=".csv"
                    multiple
                    className="hidden" 
                    onChange={async (e) => {
                      const files = Array.from(e.target.files || []);
                      if (files.length === 0) return;
                      
                      setBulkAdProcessing(true);
                      setBulkAdFiles([]);
                      setBulkAdParsed(null);
                      
                      // Parse all files
                      const parsedFiles = [];
                      let combinedDaily = [];
                      let combinedWeekly = [];
                      let combinedMonthly = [];
                      let totalSpend = 0;
                      let totalImpressions = 0;
                      let totalClicks = 0;
                      let totalConversions = 0;
                      let errors = [];
                      
                      for (const file of files) {
                        const text = await file.text();
                        const parsed = parseBulkAdFile(text, bulkAdPlatform, file.name);
                        
                        if (parsed.error) {
                          errors.push(`${file.name}: ${parsed.error}`);
                          continue;
                        }
                        
                        parsedFiles.push({ name: file.name, parsed });
                        
                        // Combine data
                        if (parsed.dailyData) combinedDaily.push(...parsed.dailyData);
                        if (parsed.weeklyData) combinedWeekly.push(...parsed.weeklyData);
                        if (parsed.monthlyData) combinedMonthly.push(...parsed.monthlyData);
                        totalSpend += parsed.totalSpend || 0;
                        totalImpressions += parsed.totalImpressions || 0;
                        totalClicks += parsed.totalClicks || 0;
                        totalConversions += parsed.totalConversions || 0;
                      }
                      
                      // Deduplicate daily data by date (keep latest)
                      const dailyMap = {};
                      combinedDaily.forEach(d => { if (!d.isMonthly) dailyMap[d.date] = d; });
                      const dedupedDaily = Object.values(dailyMap).sort((a, b) => a.date.localeCompare(b.date));
                      
                      // Deduplicate weekly data by weekEnding (sum duplicates)
                      const weeklyMap = {};
                      combinedWeekly.forEach(w => {
                        if (!weeklyMap[w.weekEnding]) {
                          weeklyMap[w.weekEnding] = { ...w };
                        }
                        // Don't sum - just keep latest (they should be the same)
                      });
                      const dedupedWeekly = Object.values(weeklyMap).sort((a, b) => a.weekEnding.localeCompare(b.weekEnding));
                      
                      // Deduplicate monthly data by periodLabel
                      const monthlyMap = {};
                      combinedMonthly.forEach(m => { monthlyMap[m.periodLabel] = m; });
                      const dedupedMonthly = Object.values(monthlyMap).sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                      
                      setBulkAdFiles(parsedFiles);
                      
                      // Create combined parsed result
                      const dateRange = dedupedDaily.length > 0
                        ? `${new Date(dedupedDaily[0].date + 'T00:00:00').toLocaleDateString()} - ${new Date(dedupedDaily[dedupedDaily.length - 1].date + 'T00:00:00').toLocaleDateString()}`
                        : dedupedMonthly.length > 0
                        ? `${dedupedMonthly[0].periodLabel} - ${dedupedMonthly[dedupedMonthly.length - 1].periodLabel}`
                        : '';
                      
                      const avgCpc = totalClicks > 0 ? totalSpend / totalClicks : 0;
                      const avgCpa = totalConversions > 0 ? totalSpend / totalConversions : 0;
                      const avgCtr = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;
                      
                      setBulkAdParsed({
                        dailyData: dedupedDaily,
                        weeklyData: dedupedWeekly,
                        monthlyData: dedupedMonthly,
                        isMonthlyData: dedupedDaily.length === 0 && dedupedMonthly.length > 0,
                        totalSpend,
                        totalImpressions,
                        totalClicks,
                        totalConversions,
                        avgCpc,
                        avgCpa,
                        avgCtr,
                        dateRange,
                        fileCount: parsedFiles.length,
                        errors: errors.length > 0 ? errors : null,
                        weeksWithExistingData: dedupedWeekly.filter(w => allWeeksData[w.weekEnding]).length,
                        monthsWithExistingData: dedupedMonthly.filter(m => allPeriodsData[m.periodLabel]).length,
                      });
                      
                      setBulkAdProcessing(false);
                      e.target.value = ''; // Reset input to allow re-selecting same files
                    }}
                  />
                  {bulkAdProcessing ? (
                    <div>
                      <RefreshCw className="w-8 h-8 text-blue-400 mx-auto mb-2 animate-spin" />
                      <p className="text-blue-400 font-medium">Processing files...</p>
                    </div>
                  ) : bulkAdFiles.length > 0 ? (
                    <div>
                      <Check className="w-8 h-8 text-emerald-400 mx-auto mb-2" />
                      <p className="text-emerald-400 font-medium">{bulkAdFiles.length} file{bulkAdFiles.length > 1 ? 's' : ''} loaded</p>
                      <p className="text-slate-400 text-xs mt-1 max-w-md mx-auto truncate">{bulkAdFiles.map(f => f.name).join(', ')}</p>
                      <p className="text-slate-500 text-sm mt-1">Click to change files</p>
                    </div>
                  ) : (
                    <div>
                      <Upload className="w-8 h-8 text-slate-500 mx-auto mb-2" />
                      <p className="text-slate-400">Click to upload {bulkAdPlatform === 'google' ? 'Google' : 'Meta'} Ads CSV files</p>
                      <p className="text-slate-500 text-sm mt-1">Select multiple files (daily, monthly, or quarterly)</p>
                    </div>
                  )}
                </div>
              </div>
              
              {/* Parse Preview */}
              {bulkAdParsed && (
                <div className="mb-6">
                  <div className={`rounded-xl p-4 ${bulkAdParsed.error ? 'bg-rose-900/30 border border-rose-500/50' : 'bg-emerald-900/20 border border-emerald-500/30'}`}>
                    {bulkAdParsed.error ? (
                      <div className="flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 text-rose-400 flex-shrink-0" />
                        <div>
                          <p className="text-rose-400 font-medium">Parse Error</p>
                          <p className="text-rose-300/70 text-sm">{bulkAdParsed.error}</p>
                        </div>
                      </div>
                    ) : (
                      <>
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center gap-2">
                            <Check className="w-5 h-5 text-emerald-400" />
                            <span className="text-emerald-400 font-medium">Parsed Successfully</span>
                            {bulkAdParsed.fileCount > 1 && (
                              <span className="text-emerald-400/70 text-sm">({bulkAdParsed.fileCount} files)</span>
                            )}
                          </div>
                          <span className="text-slate-400 text-sm">
                            {bulkAdParsed.dailyData?.length || 0} days, {bulkAdParsed.weeklyData?.length || 0} weeks
                            {bulkAdParsed.monthlyData?.length > 0 && `, ${bulkAdParsed.monthlyData.length} periods`}
                          </span>
                        </div>
                        
                        {/* Show errors if any files failed */}
                        {bulkAdParsed.errors && bulkAdParsed.errors.length > 0 && (
                          <div className="bg-amber-900/20 border border-amber-500/30 rounded-lg p-3 mb-3">
                            <p className="text-amber-400 text-sm font-medium mb-1">âš ï¸ Some files had issues:</p>
                            <ul className="text-amber-300/70 text-xs space-y-0.5">
                              {bulkAdParsed.errors.map((err, i) => (
                                <li key={i}>{err}</li>
                              ))}
                            </ul>
                          </div>
                        )}
                        
                        {/* KPI Summary Cards */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                          <div className="bg-slate-800/50 rounded-lg p-2 text-center">
                            <p className="text-slate-500 text-xs">Total Spend</p>
                            <p className="text-white font-bold">{formatCurrency(bulkAdParsed.totalSpend || 0)}</p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-2 text-center">
                            <p className="text-slate-500 text-xs">Impressions</p>
                            <p className="text-white font-bold">{formatNumber(bulkAdParsed.totalImpressions || 0)}</p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-2 text-center">
                            <p className="text-slate-500 text-xs">Clicks</p>
                            <p className="text-white font-bold">{formatNumber(bulkAdParsed.totalClicks || 0)}</p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-2 text-center">
                            <p className="text-slate-500 text-xs">Conversions</p>
                            <p className="text-white font-bold">{formatNumber(bulkAdParsed.totalConversions || 0)}</p>
                          </div>
                        </div>
                        
                        {/* Performance Metrics */}
                        <div className="grid grid-cols-3 gap-2 mb-3">
                          <div className="bg-slate-800/50 rounded-lg p-2 text-center">
                            <p className="text-slate-500 text-xs">Avg CPC</p>
                            <p className={`font-bold ${(bulkAdParsed.avgCpc || 0) < 2 ? 'text-emerald-400' : 'text-amber-400'}`}>
                              {formatCurrency(bulkAdParsed.avgCpc || 0)}
                            </p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-2 text-center">
                            <p className="text-slate-500 text-xs">Avg CPA</p>
                            <p className={`font-bold ${(bulkAdParsed.avgCpa || 0) < 30 ? 'text-emerald-400' : 'text-amber-400'}`}>
                              {formatCurrency(bulkAdParsed.avgCpa || 0)}
                            </p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-2 text-center">
                            <p className="text-slate-500 text-xs">CTR</p>
                            <p className={`font-bold ${(bulkAdParsed.avgCtr || 0) > 2 ? 'text-emerald-400' : 'text-amber-400'}`}>
                              {(bulkAdParsed.avgCtr || 0).toFixed(2)}%
                            </p>
                          </div>
                        </div>
                        
                        {/* Summary by week or month */}
                        <div className="bg-slate-900/50 rounded-lg p-3 mb-3">
                          <p className="text-slate-400 text-xs uppercase mb-2">
                            {bulkAdParsed.isMonthlyData ? 'Monthly Data Preview' : 'Weekly Aggregation Preview'}
                          </p>
                          <div className="space-y-1 max-h-48 overflow-y-auto">
                            {bulkAdParsed.isMonthlyData ? (
                              bulkAdParsed.monthlyData?.map(m => {
                                // Check if weekly data exists for this month
                                const monthMatch = m.periodLabel.match(/^(\w{3})\s+(\d{4})$/);
                                let hasWeeklyData = false;
                                if (monthMatch) {
                                  const monthNames = { jan: 1, feb: 2, mar: 3, apr: 4, may: 5, jun: 6, jul: 7, aug: 8, sep: 9, oct: 10, nov: 11, dec: 12 };
                                  const monthNum = monthNames[monthMatch[1].toLowerCase()];
                                  const year = parseInt(monthMatch[2]);
                                  hasWeeklyData = Object.keys(allWeeksData).some(weekKey => {
                                    const weekDate = new Date(weekKey + 'T00:00:00');
                                    return weekDate.getFullYear() === year && weekDate.getMonth() + 1 === monthNum;
                                  });
                                }
                                return (
                                  <div key={m.periodLabel} className={`flex items-center justify-between text-sm ${hasWeeklyData ? 'opacity-50' : ''}`}>
                                    <div className="flex items-center gap-2">
                                      <span className="text-white">{m.periodLabel}</span>
                                      {hasWeeklyData ? (
                                        <span className="text-xs px-1.5 py-0.5 rounded bg-slate-500/20 text-slate-400">has weekly data</span>
                                      ) : allPeriodsData[m.periodLabel] ? (
                                        <span className="text-xs px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-400">exists</span>
                                      ) : null}
                                    </div>
                                    <div className="flex items-center gap-3">
                                      <span className="text-slate-400 text-xs">{formatNumber(m.clicks || 0)} clicks</span>
                                      <span className={`font-medium ${hasWeeklyData ? 'text-slate-500 line-through' : bulkAdPlatform === 'google' ? 'text-red-400' : 'text-blue-400'}`}>{formatCurrency(m.spend)}</span>
                                    </div>
                                  </div>
                                );
                              })
                            ) : (
                              bulkAdParsed.weeklyData?.map(w => (
                                <div key={w.weekEnding} className="flex items-center justify-between text-sm">
                                  <div className="flex items-center gap-2">
                                    <span className="text-white">Week ending {new Date(w.weekEnding + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                                    {allWeeksData[w.weekEnding] && (
                                      <span className="text-xs px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-400">exists</span>
                                    )}
                                  </div>
                                  <div className="flex items-center gap-3">
                                    <span className="text-slate-400 text-xs">{formatNumber(w.clicks || 0)} clicks</span>
                                    <span className={`font-medium ${bulkAdPlatform === 'google' ? 'text-red-400' : 'text-blue-400'}`}>{formatCurrency(w.spend)}</span>
                                  </div>
                                </div>
                              ))
                            )}
                          </div>
                        </div>
                        
                        <div className="flex items-center justify-between text-sm mt-1">
                          <span className="text-slate-400">Date range:</span>
                          <span className="text-slate-300">{bulkAdParsed.dateRange}</span>
                        </div>
                        
                        {bulkAdParsed.isMonthlyData && bulkAdParsed.monthsWithExistingData > 0 && (
                          <p className="text-amber-400 text-xs mt-3 flex items-center gap-1">
                            <AlertTriangle className="w-3 h-3" />
                            {bulkAdParsed.monthsWithExistingData} month(s) have existing data â€” will be updated
                          </p>
                        )}
                        {!bulkAdParsed.isMonthlyData && bulkAdParsed.weeksWithExistingData > 0 && (
                          <p className="text-amber-400 text-xs mt-3 flex items-center gap-1">
                            <AlertTriangle className="w-3 h-3" />
                            {bulkAdParsed.weeksWithExistingData} week(s) have existing data â€” will be updated
                          </p>
                        )}
                      </>
                    )}
                  </div>
                </div>
              )}
              
              {/* How it works */}
              <div className="bg-slate-900/50 rounded-xl p-4 mb-6">
                <h3 className="text-slate-300 font-medium mb-2 flex items-center gap-2">
                  <HelpCircle className="w-4 h-4" />How it works
                </h3>
                <ul className="text-slate-400 text-sm space-y-1">
                  <li>â€¢ Daily ad spend is aggregated into weeks (ending Sunday)</li>
                  <li>â€¢ Monthly ad data is stored by period (e.g., "Apr 2024")</li>
                  <li>â€¢ Existing {bulkAdPlatform === 'google' ? 'Google' : 'Meta'} ad spend will be overwritten (not duplicated)</li>
                  <li>â€¢ If no data exists for that period, it will be created</li>
                </ul>
              </div>
              
              <button 
                onClick={() => processBulkAdUpload(bulkAdParsed, bulkAdPlatform)} 
                disabled={isProcessing || !bulkAdParsed || bulkAdParsed.error || (!bulkAdParsed.weeklyData?.length && !bulkAdParsed.monthlyData?.length)} 
                className="w-full bg-gradient-to-r from-blue-600 to-violet-600 hover:from-blue-500 hover:to-violet-500 disabled:from-slate-700 disabled:to-slate-700 text-white font-semibold py-4 rounded-xl"
              >
                {isProcessing ? 'Processing...' : bulkAdParsed?.isMonthlyData 
                  ? `Update ${bulkAdParsed?.monthlyData?.length || 0} Month(s) with ${bulkAdPlatform === 'google' ? 'Google' : 'Meta'} Ad Spend`
                  : `Update ${bulkAdParsed?.weeklyData?.length || 0} Week(s) with ${bulkAdPlatform === 'google' ? 'Google' : 'Meta'} Ad Spend`
                }
              </button>
            </div>
          )}
          
          {/* Inventory Upload */}
          {uploadTab === 'inventory' && (
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
              <h2 className="text-lg font-semibold text-white mb-1">Inventory Upload</h2>
              <p className="text-slate-400 text-sm mb-6">Track stock levels and get reorder alerts</p>
              
              <div className="mb-6">
                <label className="block text-sm font-medium text-slate-300 mb-2">Snapshot Date <span className="text-rose-400">*</span></label>
                <input type="date" value={invSnapshotDate} onChange={(e) => setInvSnapshotDate(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white" />
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <FileBox type="amazon" label="Amazon FBA Inventory" desc="Inventory health report" req isInv />
                <FileBox type="threepl" label="3PL Inventory" desc="Products export (optional - use Shopify Sync instead)" isInv />
              </div>
              
              <button onClick={processInventory} disabled={isProcessing || !invFiles.amazon || !invSnapshotDate} className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 disabled:from-slate-700 disabled:to-slate-700 text-white font-semibold py-4 rounded-xl">{isProcessing ? 'Processing...' : 'Process Inventory'}</button>
            </div>
          )}
          
          {/* Amazon Forecast Upload */}
          {uploadTab === 'forecast' && (
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
              <h2 className="text-lg font-semibold text-white mb-1">Amazon Forecast Upload</h2>
              <p className="text-slate-400 text-sm mb-4">Upload Amazon's projected sales to compare against actual results</p>
              
              {/* Upload Schedule Summary */}
              <div className="bg-gradient-to-r from-purple-900/30 to-indigo-900/30 rounded-xl border border-purple-500/30 p-4 mb-6">
                <h3 className="text-purple-300 font-semibold mb-3 flex items-center gap-2">
                  <Clock className="w-4 h-4" />
                  ðŸ“… Your Upload Schedule
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  {['7day', '30day', '60day'].map(type => {
                    const status = dataStatus.forecastStatus[type];
                    const isExpired = status.status === 'expired';
                    const isExpiring = status.status === 'expiring';
                    const isMissing = status.status === 'missing';
                    const isActive = status.status === 'active';
                    
                    return (
                      <div key={type} className={`rounded-lg p-3 ${
                        isExpired ? 'bg-rose-900/40 border border-rose-500/50' :
                        isExpiring ? 'bg-amber-900/40 border border-amber-500/50' :
                        isMissing ? 'bg-slate-700/50 border border-slate-600/50' :
                        'bg-emerald-900/30 border border-emerald-500/30'
                      }`}>
                        <div className="flex items-center justify-between mb-1">
                          <span className="font-medium text-white">{status.type}</span>
                          {isExpired && <span className="text-xs bg-rose-500/30 text-rose-300 px-2 py-0.5 rounded">UPLOAD NOW</span>}
                          {isExpiring && <span className="text-xs bg-amber-500/30 text-amber-300 px-2 py-0.5 rounded">{status.daysUntilExpiry}d left</span>}
                          {isActive && <span className="text-xs bg-emerald-500/30 text-emerald-300 px-2 py-0.5 rounded">{status.daysUntilExpiry}d left</span>}
                          {isMissing && <span className="text-xs bg-slate-500/30 text-slate-300 px-2 py-0.5 rounded">Not set</span>}
                        </div>
                        <p className="text-xs text-slate-400">
                          {status.lastUpload 
                            ? `Last: ${new Date(status.lastUpload).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} (${status.daysSinceUpload}d ago)`
                            : 'Never uploaded'}
                        </p>
                      </div>
                    );
                  })}
                </div>
                <p className="text-xs text-slate-400 mt-3">
                  ðŸ’¡ <strong className="text-slate-300">Workflow:</strong> Upload 7-day weekly, 30-day monthly, 60-day every 2 months â†’ Upload daily sales â†’ System learns and improves predictions
                </p>
              </div>
              
              {/* Forecast Date Ranges for each type */}
              {(() => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const formatShort = (d) => d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
                
                // Calculate date ranges for each forecast type
                const get7DayRange = () => {
                  const start = new Date(today);
                  start.setDate(start.getDate() + 1); // Tomorrow
                  const end = new Date(start);
                  end.setDate(end.getDate() + 6); // 7 days from tomorrow
                  return { start, end, days: 7 };
                };
                
                const get30DayRange = () => {
                  const start = new Date(today);
                  start.setDate(start.getDate() + 1); // Tomorrow
                  const end = new Date(start);
                  end.setDate(end.getDate() + 29); // 30 days from tomorrow
                  return { start, end, days: 30 };
                };
                
                const get60DayRange = () => {
                  const start = new Date(today);
                  start.setDate(start.getDate() + 1); // Tomorrow
                  const end = new Date(start);
                  end.setDate(end.getDate() + 59); // 60 days from tomorrow
                  return { start, end, days: 60 };
                };
                
                const ranges = {
                  '7day': get7DayRange(),
                  '30day': get30DayRange(),
                  '60day': get60DayRange(),
                };
                
                // Calculate days until each forecast needs refresh
                const getDaysUntilRefresh = (type) => {
                  const lastUpload = forecastMeta.lastUploads?.[type];
                  if (!lastUpload) return null;
                  const uploadDate = new Date(lastUpload);
                  const daysSince = Math.floor((today - uploadDate) / (1000 * 60 * 60 * 24));
                  const refreshDays = type === '7day' ? 7 : type === '30day' ? 30 : 60;
                  return refreshDays - daysSince;
                };
                
                const selectedRange = files.forecastType ? ranges[files.forecastType] : null;
                
                return (
                  <div className="bg-orange-900/20 border border-orange-500/30 rounded-xl p-4 mb-6">
                    <h3 className="text-orange-300 font-semibold mb-3 flex items-center gap-2">
                      <TrendingUp className="w-4 h-4" />
                      Amazon Forecast Date Ranges
                    </h3>
                    <p className="text-slate-400 text-sm mb-4">Select a forecast type below, then use these date ranges in Amazon Seller Central</p>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                      {/* 7-Day Forecast */}
                      <div className={`rounded-lg p-3 cursor-pointer transition-all ${files.forecastType === '7day' ? 'bg-amber-600/30 border-2 border-amber-500' : 'bg-slate-800/50 border border-slate-700 hover:border-slate-500'}`}
                        onClick={() => files.amazonForecast && setFiles(p => ({ ...p, forecastType: '7day' }))}>
                        <div className="flex items-center justify-between mb-2">
                          <p className="text-amber-400 font-medium">ðŸ“… 7-Day Forecast</p>
                          {forecastMeta.lastUploads?.['7day'] && (
                            <span className={`text-xs px-2 py-0.5 rounded ${getDaysUntilRefresh('7day') <= 0 ? 'bg-rose-500/30 text-rose-300' : getDaysUntilRefresh('7day') <= 2 ? 'bg-amber-500/30 text-amber-300' : 'bg-emerald-500/30 text-emerald-300'}`}>
                              {getDaysUntilRefresh('7day') <= 0 ? 'Due now!' : `${getDaysUntilRefresh('7day')}d left`}
                            </span>
                          )}
                        </div>
                        <p className="text-white font-mono text-sm">{formatShort(ranges['7day'].start)}</p>
                        <p className="text-white font-mono text-sm">â†’ {formatShort(ranges['7day'].end)}</p>
                        <p className="text-slate-500 text-xs mt-1">Refresh every 7 days</p>
                      </div>
                      
                      {/* 30-Day Forecast */}
                      <div className={`rounded-lg p-3 cursor-pointer transition-all ${files.forecastType === '30day' ? 'bg-amber-600/30 border-2 border-amber-500' : 'bg-slate-800/50 border border-slate-700 hover:border-slate-500'}`}
                        onClick={() => files.amazonForecast && setFiles(p => ({ ...p, forecastType: '30day' }))}>
                        <div className="flex items-center justify-between mb-2">
                          <p className="text-orange-400 font-medium">ðŸ“Š 30-Day Forecast</p>
                          {forecastMeta.lastUploads?.['30day'] && (
                            <span className={`text-xs px-2 py-0.5 rounded ${getDaysUntilRefresh('30day') <= 0 ? 'bg-rose-500/30 text-rose-300' : getDaysUntilRefresh('30day') <= 2 ? 'bg-amber-500/30 text-amber-300' : 'bg-emerald-500/30 text-emerald-300'}`}>
                              {getDaysUntilRefresh('30day') <= 0 ? 'Due now!' : `${getDaysUntilRefresh('30day')}d left`}
                            </span>
                          )}
                        </div>
                        <p className="text-white font-mono text-sm">{formatShort(ranges['30day'].start)}</p>
                        <p className="text-white font-mono text-sm">â†’ {formatShort(ranges['30day'].end)}</p>
                        <p className="text-slate-500 text-xs mt-1">Refresh every 30 days</p>
                      </div>
                      
                      {/* 60-Day Forecast */}
                      <div className={`rounded-lg p-3 cursor-pointer transition-all ${files.forecastType === '60day' ? 'bg-amber-600/30 border-2 border-amber-500' : 'bg-slate-800/50 border border-slate-700 hover:border-slate-500'}`}
                        onClick={() => files.amazonForecast && setFiles(p => ({ ...p, forecastType: '60day' }))}>
                        <div className="flex items-center justify-between mb-2">
                          <p className="text-red-400 font-medium">ðŸ“ˆ 60-Day Forecast</p>
                          {forecastMeta.lastUploads?.['60day'] && (
                            <span className={`text-xs px-2 py-0.5 rounded ${getDaysUntilRefresh('60day') <= 0 ? 'bg-rose-500/30 text-rose-300' : getDaysUntilRefresh('60day') <= 2 ? 'bg-amber-500/30 text-amber-300' : 'bg-emerald-500/30 text-emerald-300'}`}>
                              {getDaysUntilRefresh('60day') <= 0 ? 'Due now!' : `${getDaysUntilRefresh('60day')}d left`}
                            </span>
                          )}
                        </div>
                        <p className="text-white font-mono text-sm">{formatShort(ranges['60day'].start)}</p>
                        <p className="text-white font-mono text-sm">â†’ {formatShort(ranges['60day'].end)}</p>
                        <p className="text-slate-500 text-xs mt-1">Refresh every 60 days</p>
                      </div>
                    </div>
                    
                    {/* Selected forecast instructions */}
                    {selectedRange && (
                      <div className="bg-slate-900/50 rounded-lg p-3 mb-3">
                        <p className="text-emerald-400 font-medium mb-2">âœ“ Selected: {files.forecastType === '7day' ? '7-Day' : files.forecastType === '30day' ? '30-Day' : '60-Day'} Forecast</p>
                        <p className="text-white text-sm">
                          In Amazon Seller Central, set date range: <span className="font-mono text-amber-300">{formatShort(selectedRange.start)}</span> to <span className="font-mono text-amber-300">{formatShort(selectedRange.end)}</span>
                        </p>
                      </div>
                    )}
                    
                    <ol className="text-slate-300 text-sm space-y-1 list-decimal list-inside">
                      <li>Go to Seller Central â†’ Reports â†’ Business Reports â†’ <span className="text-orange-300">SKU Economics</span></li>
                      <li>Set the date range to the <span className="text-orange-300 font-medium">future dates</span> shown above</li>
                      <li>Amazon will show <span className="text-orange-300 font-medium">projected/forecasted</span> sales for those dates</li>
                      <li>Export as CSV and upload below</li>
                    </ol>
                  </div>
                );
              })()}
              
              <div className="mb-6">
                <label className="block text-sm font-medium text-slate-300 mb-2">Amazon Forecast CSV <span className="text-rose-400">*</span></label>
                <div className={`relative border-2 border-dashed rounded-xl p-6 transition-all ${files.amazonForecast ? 'border-amber-500/50 bg-amber-950/20' : 'border-slate-600 hover:border-slate-500 bg-slate-800/30'}`}>
                  <input 
                    key={`forecast-input-${forecastMeta.history?.length || 0}`}
                    type="file" 
                    accept=".csv" 
                    onChange={(e) => {
                      const file = e.target.files[0];
                      if (file) {
                        setFileNames(p => ({ ...p, amazonForecast: file.name }));
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                          const parsed = parseCSV(ev.target.result);
                          setFiles(p => ({ ...p, amazonForecast: parsed, forecastType: null }));
                        };
                        reader.readAsText(file);
                      }
                    }} 
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
                  />
                  <div className="flex flex-col items-center gap-2">
                    {files.amazonForecast ? <Check className="w-8 h-8 text-amber-400" /> : <Upload className="w-8 h-8 text-slate-400" />}
                    <p className={`font-medium ${files.amazonForecast ? 'text-amber-400' : 'text-white'}`}>
                      {files.amazonForecast ? fileNames.amazonForecast : 'Click to upload Amazon forecast CSV'}
                    </p>
                    {files.amazonForecast && (
                      <p className="text-slate-400 text-sm">{files.amazonForecast.length} SKUs found</p>
                    )}
                  </div>
                </div>
              </div>
              
              {/* Forecast Type Selection - shown if file uploaded but no type selected */}
              {files.amazonForecast && !files.forecastType && (
                <div className="mb-4 p-3 bg-amber-900/30 border border-amber-500/50 rounded-lg">
                  <p className="text-amber-300 text-sm flex items-center gap-2">
                    <AlertCircle className="w-4 h-4" />
                    Click one of the forecast cards above to select which type this is (7-Day, 30-Day, or 60-Day)
                  </p>
                </div>
              )}
              
              {/* Selected forecast confirmation */}
              {files.amazonForecast && files.forecastType && (
                <div className="mb-4 p-3 bg-emerald-900/30 border border-emerald-500/50 rounded-lg flex items-center justify-between">
                  <p className="text-emerald-300 text-sm flex items-center gap-2">
                    <Check className="w-4 h-4" />
                    Ready to upload: <span className="font-semibold">{files.forecastType === '7day' ? '7-Day' : files.forecastType === '30day' ? '30-Day' : '60-Day'}</span> forecast ({files.amazonForecast.length} SKUs)
                  </p>
                  <button onClick={() => setFiles(p => ({ ...p, forecastType: null }))} className="text-slate-400 hover:text-white text-xs">Change</button>
                </div>
              )}
              
              {/* Forecast Alerts */}
              {forecastAlerts.length > 0 && (
                <div className="mb-4 space-y-2">
                  {forecastAlerts.map((alert, i) => (
                    <div key={i} className={`flex items-center gap-2 p-3 rounded-lg text-sm ${
                      alert.severity === 'warning' ? 'bg-amber-900/30 border border-amber-500/50 text-amber-300' : 'bg-blue-900/30 border border-blue-500/50 text-blue-300'
                    }`}>
                      <AlertCircle className="w-4 h-4 flex-shrink-0" />
                      <span>{alert.message}</span>
                    </div>
                  ))}
                </div>
              )}
              
              <button onClick={() => {
                if (!files.amazonForecast) return;
                if (!files.forecastType) {
                  setToast({ message: 'Please select forecast type (7-Day, 30-Day, or 60-Day)', type: 'error' });
                  return;
                }
                const result = processAmazonForecast(files.amazonForecast);
                if (result) {
                  const forecastType = files.forecastType;
                  const now = new Date().toISOString();
                  
                  // Track this upload
                  const historyEntry = {
                    type: forecastType,
                    uploadedAt: now,
                    periodStart: result.type === 'monthly' ? result.period.startDate : result.forecast?.startDate,
                    periodEnd: result.type === 'monthly' ? result.period.endDate : result.forecast?.endDate,
                    totalSales: result.type === 'monthly' ? result.monthlyTotal.sales : result.forecast?.totals?.sales,
                    totalProceeds: result.type === 'monthly' ? result.monthlyTotal.proceeds : result.forecast?.totals?.proceeds,
                    accuracy: null, // Will be calculated when actuals come in
                  };
                  
                  setForecastMeta(prev => ({
                    lastUploads: { ...prev.lastUploads, [forecastType]: now },
                    history: [historyEntry, ...(prev.history || []).slice(0, 49)], // Keep last 50
                  }));
                  
                  if (result.type === 'monthly') {
                    // Monthly forecast - save each week separately
                    setAmazonForecasts(prev => ({ ...prev, ...result.forecasts }));
                    const weekCount = Object.keys(result.forecasts).length;
                    setToast({ message: `${forecastType} forecast split into ${weekCount} weekly forecasts (${formatCurrency(result.monthlyTotal.sales)} total)`, type: 'success' });
                  } else {
                    // Weekly forecast
                    setAmazonForecasts(prev => ({ ...prev, [result.forecast.weekEnding]: result.forecast }));
                    setToast({ message: `${forecastType} forecast saved for week ending ${result.forecast.weekEnding}`, type: 'success' });
                  }
                  setFiles(p => ({ ...p, amazonForecast: null, forecastType: null }));
                  setFileNames(p => ({ ...p, amazonForecast: '' }));
                } else {
                  setToast({ message: 'Could not parse forecast data', type: 'error' });
                }
              }} disabled={!files.amazonForecast || !files.forecastType} className="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white font-semibold py-4 rounded-xl mb-6">
                Save {files.forecastType ? (files.forecastType === '7day' ? '7-Day' : files.forecastType === '30day' ? '30-Day' : '60-Day') + ' ' : ''}Forecast
              </button>
              
              {/* Forecast Upload History */}
              {forecastMeta.lastUploads && (Object.values(forecastMeta.lastUploads).some(v => v)) && (
                <div className="bg-slate-800/50 rounded-xl p-4 mb-6">
                  <h3 className="text-sm font-semibold text-slate-300 uppercase mb-3">Last Uploads</h3>
                  <div className="grid grid-cols-3 gap-4 text-sm">
                    {['7day', '30day', '60day'].map(type => {
                      const lastUpload = forecastMeta.lastUploads?.[type];
                      const daysSince = lastUpload ? Math.floor((new Date() - new Date(lastUpload)) / (1000 * 60 * 60 * 24)) : null;
                      const isStale = (type === '7day' && daysSince >= 7) || (type === '30day' && daysSince >= 30) || (type === '60day' && daysSince >= 60);
                      return (
                        <div key={type} className={`p-3 rounded-lg ${isStale ? 'bg-amber-900/30 border border-amber-500/30' : 'bg-slate-700/50'}`}>
                          <p className="text-slate-400 text-xs uppercase">{type === '7day' ? '7-Day' : type === '30day' ? '30-Day' : '60-Day'}</p>
                          {lastUpload ? (
                            <>
                              <p className={`font-medium ${isStale ? 'text-amber-400' : 'text-white'}`}>{daysSince} days ago</p>
                              <p className="text-slate-500 text-xs">{new Date(lastUpload).toLocaleDateString()}</p>
                            </>
                          ) : (
                            <p className="text-slate-500">Never</p>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
              
              {/* Existing Forecasts */}
              {Object.keys(amazonForecasts).length > 0 && (
                <div className="border-t border-slate-700 pt-6">
                  <h3 className="text-sm font-semibold text-slate-300 uppercase mb-4">Saved Forecasts</h3>
                  <div className="space-y-2">
                    {Object.entries(amazonForecasts).sort((a, b) => b[0].localeCompare(a[0])).map(([weekKey, forecast]) => {
                      const hasActual = allWeeksData[weekKey];
                      const isPast = new Date(weekKey) < new Date();
                      const isFromMonthly = forecast.sourceType === '30-day-split';
                      return (
                        <div key={weekKey} className={`flex items-center justify-between p-3 rounded-xl ${hasActual ? 'bg-emerald-900/20 border border-emerald-500/30' : isPast ? 'bg-slate-700/30 border border-slate-600' : 'bg-amber-900/20 border border-amber-500/30'}`}>
                          <div>
                            <p className="text-white font-medium flex items-center gap-2">
                              Week ending {new Date(weekKey + 'T00:00:00').toLocaleDateString()}
                              {isFromMonthly && <span className="text-xs bg-violet-500/30 text-violet-300 px-2 py-0.5 rounded">from 30-day</span>}
                            </p>
                            <p className="text-slate-400 text-sm">
                              {formatCurrency(forecast.totals?.sales || 0)} projected â€¢ {forecast.skuCount || 0} SKUs
                              {isFromMonthly && forecast.monthlyTotal && ` â€¢ Part of ${formatCurrency(forecast.monthlyTotal.sales)} monthly`}
                            </p>
                          </div>
                          <div className="flex items-center gap-2">
                            {hasActual ? (
                              <span className="text-emerald-400 text-sm flex items-center gap-1"><Check className="w-4 h-4" />Has actuals</span>
                            ) : isPast ? (
                              <span className="text-slate-400 text-sm">Awaiting actuals</span>
                            ) : (
                              <span className="text-amber-400 text-sm">Upcoming</span>
                            )}
                            <button onClick={() => {
                              const updated = { ...amazonForecasts };
                              delete updated[weekKey];
                              setAmazonForecasts(updated);
                            }} className="p-1 hover:bg-slate-600 rounded text-slate-400 hover:text-rose-400">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
              
              {/* Forecast vs Actual Comparison */}
              {getAmazonForecastComparison.length > 0 && (
                <div className="border-t border-slate-700 pt-6 mt-6">
                  <h3 className="text-sm font-semibold text-slate-300 uppercase mb-4">Forecast Accuracy</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b border-slate-700">
                          <th className="text-left text-slate-400 py-2">Week</th>
                          <th className="text-right text-slate-400 py-2">Forecast</th>
                          <th className="text-right text-slate-400 py-2">Actual</th>
                          <th className="text-right text-slate-400 py-2">Variance</th>
                          <th className="text-right text-slate-400 py-2">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {getAmazonForecastComparison.map(c => (
                          <tr key={c.weekEnding} className="border-b border-slate-700/50">
                            <td className="py-2 text-white">{new Date(c.weekEnding + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
                            <td className="py-2 text-right text-slate-400">{formatCurrency(c.forecast.revenue)}</td>
                            <td className="py-2 text-right text-white font-medium">{formatCurrency(c.actual.revenue)}</td>
                            <td className={`py-2 text-right font-medium ${c.variance.revenuePercent >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                              {c.variance.revenuePercent >= 0 ? '+' : ''}{c.variance.revenuePercent.toFixed(1)}%
                            </td>
                            <td className="py-2 text-right">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${c.status === 'beat' ? 'bg-emerald-900/50 text-emerald-400' : 'bg-rose-900/50 text-rose-400'}`}>
                                {c.status === 'beat' ? 'â†‘ Beat' : 'â†“ Missed'}
                              </span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          )}
          
          {/* ============ SHOPIFY SYNC TAB ============ */}
          {uploadTab === 'shopify-sync' && (
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
              <h2 className="text-lg font-semibold text-white mb-1 flex items-center gap-2">
                <ShoppingBag className="w-5 h-5 text-green-400" />
                Shopify Sync
              </h2>
              <p className="text-slate-400 text-sm mb-6">Automatically import orders from your Shopify store</p>
              
              {/* Connection Status */}
              <div className={`rounded-xl p-4 mb-6 ${shopifyCredentials.connected ? 'bg-emerald-900/30 border border-emerald-500/30' : 'bg-slate-700/30 border border-slate-600'}`}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    {shopifyCredentials.connected ? (
                      <>
                        <div className="w-10 h-10 bg-emerald-500/20 rounded-full flex items-center justify-center">
                          <Check className="w-5 h-5 text-emerald-400" />
                        </div>
                        <div>
                          <p className="text-emerald-400 font-medium">Connected to Shopify</p>
                          <p className="text-slate-400 text-sm">{shopifyCredentials.storeUrl}</p>
                          {shopifyCredentials.lastSync && (
                            <p className="text-slate-500 text-xs">Last sync: {new Date(shopifyCredentials.lastSync).toLocaleString()}</p>
                          )}
                        </div>
                      </>
                    ) : (
                      <>
                        <div className="w-10 h-10 bg-slate-600/50 rounded-full flex items-center justify-center">
                          <ShoppingBag className="w-5 h-5 text-slate-400" />
                        </div>
                        <div>
                          <p className="text-slate-300 font-medium">Not Connected</p>
                          <p className="text-slate-500 text-sm">Set up your Shopify connection in Settings</p>
                        </div>
                      </>
                    )}
                  </div>
                  <button
                    onClick={() => setView('settings')}
                    className="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-sm text-white flex items-center gap-2"
                  >
                    <Settings className="w-4 h-4" />
                    {shopifyCredentials.connected ? 'Manage' : 'Connect'}
                  </button>
                </div>
              </div>
              
              {shopifyCredentials.connected ? (
                <>
                  {/* Sync Controls */}
                  <div className="bg-slate-900/50 rounded-xl p-4 mb-6">
                    <h3 className="text-white font-medium mb-4">Select Date Range to Sync</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div>
                        <label className="block text-slate-400 text-sm mb-2">Start Date</label>
                        <input
                          type="date"
                          value={shopifySyncRange.start}
                          onChange={(e) => {
                            const newStart = e.target.value;
                            setShopifySyncRange(p => ({ ...p, start: newStart }));
                            // Calculate missing days
                            if (newStart && shopifySyncRange.end) {
                              const start = new Date(newStart);
                              const end = new Date(shopifySyncRange.end);
                              const missing = [];
                              const existing = [];
                              for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                                const dateStr = d.toISOString().split('T')[0];
                                const hasShopifyData = allDaysData[dateStr]?.shopify?.revenue > 0;
                                if (hasShopifyData) {
                                  existing.push(dateStr);
                                } else {
                                  missing.push(dateStr);
                                }
                              }
                              setShopifySmartSync(p => ({ ...p, missingDays: missing, existingDays: existing }));
                            }
                          }}
                          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white"
                        />
                      </div>
                      <div>
                        <label className="block text-slate-400 text-sm mb-2">End Date</label>
                        <input
                          type="date"
                          value={shopifySyncRange.end}
                          onChange={(e) => {
                            const newEnd = e.target.value;
                            setShopifySyncRange(p => ({ ...p, end: newEnd }));
                            // Calculate missing days
                            if (shopifySyncRange.start && newEnd) {
                              const start = new Date(shopifySyncRange.start);
                              const end = new Date(newEnd);
                              const missing = [];
                              const existing = [];
                              for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                                const dateStr = d.toISOString().split('T')[0];
                                const hasShopifyData = allDaysData[dateStr]?.shopify?.revenue > 0;
                                if (hasShopifyData) {
                                  existing.push(dateStr);
                                } else {
                                  missing.push(dateStr);
                                }
                              }
                              setShopifySmartSync(p => ({ ...p, missingDays: missing, existingDays: existing }));
                            }
                          }}
                          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white"
                        />
                      </div>
                    </div>
                    
                    {/* Quick Select Buttons */}
                    <div className="flex flex-wrap gap-2 mb-4">
                      {[
                        { label: 'Last 7 Days', days: 7 },
                        { label: 'Last 14 Days', days: 14 },
                        { label: 'Last 30 Days', days: 30 },
                        { label: 'This Month', days: 'month' },
                        { label: 'Last Month', days: 'lastMonth' },
                      ].map(({ label, days }) => (
                        <button
                          key={label}
                          onClick={() => {
                            const end = new Date();
                            let start = new Date();
                            if (days === 'month') {
                              start = new Date(end.getFullYear(), end.getMonth(), 1);
                            } else if (days === 'lastMonth') {
                              start = new Date(end.getFullYear(), end.getMonth() - 1, 1);
                              end.setDate(0);
                            } else {
                              start.setDate(end.getDate() - days);
                            }
                            const startStr = start.toISOString().split('T')[0];
                            const endStr = end.toISOString().split('T')[0];
                            setShopifySyncRange({ start: startStr, end: endStr });
                            
                            // Calculate missing days
                            const missing = [];
                            const existing = [];
                            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                              const dateStr = d.toISOString().split('T')[0];
                              const hasShopifyData = allDaysData[dateStr]?.shopify?.revenue > 0;
                              if (hasShopifyData) {
                                existing.push(dateStr);
                              } else {
                                missing.push(dateStr);
                              }
                            }
                            setShopifySmartSync(p => ({ ...p, missingDays: missing, existingDays: existing }));
                          }}
                          className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300"
                        >
                          {label}
                        </button>
                      ))}
                      <button
                        onClick={() => {
                          // Find the full range of data (earliest to today)
                          const allDates = Object.keys(allDaysData).filter(d => /^\d{4}-\d{2}-\d{2}$/.test(d)).sort();
                          if (allDates.length === 0) {
                            // No data yet - default to last 30 days
                            const end = new Date();
                            const start = new Date();
                            start.setDate(end.getDate() - 30);
                            setShopifySyncRange({ start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] });
                            
                            const missing = [];
                            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                              missing.push(d.toISOString().split('T')[0]);
                            }
                            setShopifySmartSync(p => ({ ...p, missingDays: missing, existingDays: [] }));
                            return;
                          }
                          
                          const start = new Date(allDates[0]);
                          const end = new Date();
                          
                          // Calculate all missing days in the full range
                          const missing = [];
                          const existing = [];
                          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                            const dateStr = d.toISOString().split('T')[0];
                            const hasShopifyData = allDaysData[dateStr]?.shopify?.revenue > 0;
                            if (hasShopifyData) {
                              existing.push(dateStr);
                            } else {
                              missing.push(dateStr);
                            }
                          }
                          
                          setShopifySyncRange({ start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] });
                          setShopifySmartSync(p => ({ ...p, missingDays: missing, existingDays: existing }));
                          
                          if (missing.length === 0) {
                            setToast({ message: 'All days already have Shopify data!', type: 'success' });
                          } else {
                            setToast({ message: `Found ${missing.length} days missing Shopify data`, type: 'info' });
                          }
                        }}
                        className="px-3 py-1.5 bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 rounded-lg text-sm text-amber-300 flex items-center gap-1"
                      >
                        <Zap className="w-3 h-3" />
                        Find Missing
                      </button>
                    </div>
                    
                    {/* Smart Sync Panel */}
                    {shopifySyncRange.start && shopifySyncRange.end && (shopifySmartSync.missingDays.length > 0 || shopifySmartSync.existingDays.length > 0) && (
                      <div className="bg-slate-800/50 border border-slate-600/50 rounded-lg p-4 mb-4">
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="text-white font-medium flex items-center gap-2">
                            <Zap className="w-4 h-4 text-amber-400" />
                            Smart Sync
                          </h4>
                          <div className="flex items-center gap-3 text-sm">
                            <span className="text-emerald-400">{shopifySmartSync.existingDays.length} synced</span>
                            <span className="text-amber-400">{shopifySmartSync.missingDays.length} missing</span>
                          </div>
                        </div>
                        
                        <div className="flex items-center gap-3 mb-3">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={shopifySmartSync.enabled}
                              onChange={(e) => setShopifySmartSync(p => ({ ...p, enabled: e.target.checked }))}
                              className="w-4 h-4 rounded bg-slate-700 border-slate-500 text-emerald-500 focus:ring-emerald-500"
                            />
                            <span className="text-slate-300 text-sm">Only sync missing days</span>
                            <span className="text-slate-500 text-xs">(recommended)</span>
                          </label>
                        </div>
                        
                        {shopifySmartSync.enabled ? (
                          <p className="text-slate-400 text-xs">
                            Will sync <strong className="text-amber-400">{shopifySmartSync.missingDays.length}</strong> days, 
                            skip <strong className="text-emerald-400">{shopifySmartSync.existingDays.length}</strong> days that already have data.
                          </p>
                        ) : (
                          <p className="text-slate-400 text-xs">
                            Will re-sync <strong className="text-white">{shopifySmartSync.missingDays.length + shopifySmartSync.existingDays.length}</strong> days 
                            (overwrites {shopifySmartSync.existingDays.length} days with existing data).
                          </p>
                        )}
                      </div>
                    )}
                    
                    <div className="flex gap-3">
                      <button
                        onClick={async () => {
                          if (!shopifySyncRange.start || !shopifySyncRange.end) {
                            setToast({ message: 'Please select a date range', type: 'error' });
                            return;
                          }
                          setShopifySyncStatus({ loading: true, error: null, progress: 'Fetching preview...' });
                          try {
                            const res = await fetch('/api/shopify/sync', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                storeUrl: shopifyCredentials.storeUrl,
                                clientId: shopifyCredentials.clientId, clientSecret: shopifyCredentials.clientSecret,
                                startDate: shopifySyncRange.start,
                                endDate: shopifySyncRange.end,
                                preview: true,
                              }),
                            });
                            const data = await res.json();
                            if (data.error) throw new Error(data.error);
                            setShopifySyncPreview(data);
                            setShopifySyncStatus({ loading: false, error: null, progress: '' });
                          } catch (err) {
                            setShopifySyncStatus({ loading: false, error: err.message, progress: '' });
                          }
                        }}
                        disabled={shopifySyncStatus.loading || !shopifySyncRange.start || !shopifySyncRange.end}
                        className="px-4 py-2 bg-slate-600 hover:bg-slate-500 disabled:opacity-50 rounded-lg text-white flex items-center gap-2"
                      >
                        <Eye className="w-4 h-4" />
                        Preview
                      </button>
                      <button
                        onClick={async () => {
                          if (!shopifySyncRange.start || !shopifySyncRange.end) {
                            setToast({ message: 'Please select a date range', type: 'error' });
                            return;
                          }
                          
                          // Smart sync: check if there are days to sync
                          const daysToSync = shopifySmartSync.enabled ? shopifySmartSync.missingDays : [...shopifySmartSync.missingDays, ...shopifySmartSync.existingDays];
                          if (shopifySmartSync.enabled && shopifySmartSync.missingDays.length === 0) {
                            setToast({ message: 'All days in this range already have Shopify data. Uncheck "Only sync missing days" to re-sync.', type: 'info' });
                            return;
                          }
                          
                          const confirmMsg = shopifySmartSync.enabled 
                            ? `Sync ${shopifySmartSync.missingDays.length} missing days from Shopify?\n\n(Skipping ${shopifySmartSync.existingDays.length} days that already have data)`
                            : `Sync ALL ${daysToSync.length} days from ${shopifySyncRange.start} to ${shopifySyncRange.end}?\n\nThis will overwrite ${shopifySmartSync.existingDays.length} days with existing data.`;
                          
                          if (!confirm(confirmMsg)) return;
                          
                          setShopifySyncStatus({ loading: true, error: null, progress: 'Fetching orders from Shopify...' });
                          try {
                            const res = await fetch('/api/shopify/sync', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                storeUrl: shopifyCredentials.storeUrl,
                                clientId: shopifyCredentials.clientId, clientSecret: shopifyCredentials.clientSecret,
                                startDate: shopifySyncRange.start,
                                endDate: shopifySyncRange.end,
                                preview: false,
                              }),
                            });
                            const data = await res.json();
                            if (data.error) throw new Error(data.error);
                            
                            setShopifySyncStatus({ loading: true, error: null, progress: 'Processing orders...' });
                            
                            // Create set of days to include (smart sync filter)
                            const daysToInclude = new Set(daysToSync);
                            
                            // Merge daily data (only for selected days if smart sync enabled)
                            // IMPORTANT: Preserve all Amazon data, only add/update Shopify data
                            const updatedDays = { ...allDaysData };
                            let syncedDayCount = 0;
                            Object.entries(data.dailyData || {}).forEach(([dateKey, dayData]) => {
                              // Skip this day if smart sync is enabled and it's not in the missing days list
                              if (shopifySmartSync.enabled && !daysToInclude.has(dateKey)) {
                                return;
                              }
                              syncedDayCount++;
                              
                              const existing = updatedDays[dateKey] || {};
                              
                              // Preserve ALL existing Amazon data
                              const amazonData = existing.amazon || { revenue: 0, units: 0, orders: 0 };
                              const shopifyData = dayData.shopify || { revenue: 0, units: 0, orders: 0 };
                              
                              // Preserve existing ad data (from Meta/Google uploads)
                              const existingMetaSpend = existing.metaSpend || existing.shopify?.metaSpend || 0;
                              const existingGoogleSpend = existing.googleSpend || existing.shopify?.googleSpend || 0;
                              
                              // Merge ad data into shopify object for consistency
                              const mergedShopifyData = {
                                ...shopifyData,
                                metaSpend: existingMetaSpend,
                                metaAds: existingMetaSpend,
                                googleSpend: existingGoogleSpend,
                                googleAds: existingGoogleSpend,
                                adSpend: existingMetaSpend + existingGoogleSpend,
                              };
                              
                              // Recalculate profit with ad spend
                              if (mergedShopifyData.adSpend > 0) {
                                const grossProfit = (mergedShopifyData.revenue || 0) - (mergedShopifyData.cogs || 0) - (mergedShopifyData.threeplCosts || 0);
                                mergedShopifyData.netProfit = grossProfit - mergedShopifyData.adSpend;
                                mergedShopifyData.netMargin = mergedShopifyData.revenue > 0 ? (mergedShopifyData.netProfit / mergedShopifyData.revenue) * 100 : 0;
                                mergedShopifyData.roas = mergedShopifyData.adSpend > 0 ? mergedShopifyData.revenue / mergedShopifyData.adSpend : 0;
                              }
                              
                              updatedDays[dateKey] = {
                                ...existing,
                                // Keep Amazon exactly as-is
                                amazon: amazonData,
                                // Update Shopify with merged data including ads
                                shopify: mergedShopifyData,
                                // Recalculate total from both channels
                                total: {
                                  revenue: (amazonData.revenue || 0) + (mergedShopifyData.revenue || 0),
                                  units: (amazonData.units || 0) + (mergedShopifyData.units || 0),
                                  orders: (amazonData.orders || 0) + (mergedShopifyData.orders || 0),
                                },
                                // PRESERVE all existing ad data at top level
                                metaSpend: existingMetaSpend,
                                metaAds: existingMetaSpend,
                                metaImpressions: existing.metaImpressions,
                                metaClicks: existing.metaClicks,
                                metaCpc: existing.metaCpc,
                                metaCpa: existing.metaCpa,
                                metaConversions: existing.metaConversions,
                                metaPurchases: existing.metaPurchases,
                                googleSpend: existingGoogleSpend,
                                googleAds: existingGoogleSpend,
                                googleImpressions: existing.googleImpressions,
                                googleClicks: existing.googleClicks,
                                googleCpc: existing.googleCpc,
                                googleCpa: existing.googleCpa,
                                googleConversions: existing.googleConversions,
                                // Keep any other existing data
                                ads: existing.ads,
                                expenses: existing.expenses,
                                notes: existing.notes,
                              };
                            });
                            setAllDaysData(updatedDays);
                            // Save daily data to localStorage
                            try { localStorage.setItem('ecommerce_daily_sales_v1', JSON.stringify(updatedDays)); } catch(e) {}
                            
                            // Merge weekly data - PRESERVE existing ad data
                            const updatedWeeks = { ...allWeeksData };
                            Object.entries(data.weeklyData || {}).forEach(([weekKey, weekData]) => {
                              if (updatedWeeks[weekKey]) {
                                const existingWeek = updatedWeeks[weekKey];
                                const existingShopify = existingWeek.shopify || {};
                                
                                // Preserve existing ad data
                                const metaSpend = existingShopify.metaSpend || existingShopify.metaAds || 0;
                                const googleSpend = existingShopify.googleSpend || existingShopify.googleAds || 0;
                                const totalAds = metaSpend + googleSpend;
                                
                                // Merge shopify data, preserving ads
                                const mergedShopify = {
                                  ...weekData.shopify,
                                  metaSpend: metaSpend,
                                  metaAds: metaSpend,
                                  googleSpend: googleSpend,
                                  googleAds: googleSpend,
                                  adSpend: totalAds,
                                };
                                
                                // Recalculate profit with ad spend
                                if (totalAds > 0 && mergedShopify.revenue > 0) {
                                  const grossProfit = (mergedShopify.revenue || 0) - (mergedShopify.cogs || 0) - (mergedShopify.threeplCosts || 0);
                                  mergedShopify.netProfit = grossProfit - totalAds;
                                  mergedShopify.netMargin = mergedShopify.revenue > 0 ? (mergedShopify.netProfit / mergedShopify.revenue) * 100 : 0;
                                  mergedShopify.roas = totalAds > 0 ? mergedShopify.revenue / totalAds : 0;
                                }
                                
                                updatedWeeks[weekKey] = {
                                  ...existingWeek,
                                  shopify: mergedShopify,
                                  total: {
                                    ...existingWeek.total,
                                    revenue: (existingWeek.amazon?.revenue || 0) + (mergedShopify.revenue || 0),
                                    units: (existingWeek.amazon?.units || 0) + (mergedShopify.units || 0),
                                    adSpend: (existingWeek.amazon?.adSpend || 0) + totalAds,
                                    netProfit: (existingWeek.amazon?.netProfit || 0) + (mergedShopify.netProfit || 0),
                                  },
                                };
                              } else {
                                updatedWeeks[weekKey] = weekData;
                              }
                            });
                            setAllWeeksData(updatedWeeks);
                            save(updatedWeeks);
                            
                            const updatedCreds = { ...shopifyCredentials, lastSync: new Date().toISOString() };
                            setShopifyCredentials(updatedCreds);
                            
                            setShopifySyncStatus({ loading: false, error: null, progress: '' });
                            setShopifySyncPreview(null);
                            
                            // Reset smart sync state
                            setShopifySmartSync({ enabled: true, missingDays: [], existingDays: [] });
                            
                            const skippedCount = shopifySmartSync.enabled ? shopifySmartSync.existingDays.length : 0;
                            setToast({ 
                              message: `Synced ${data.orderCount} orders across ${syncedDayCount} days` + (skippedCount > 0 ? ` (skipped ${skippedCount} existing)` : ''), 
                              type: 'success' 
                            });
                          } catch (err) {
                            setShopifySyncStatus({ loading: false, error: err.message, progress: '' });
                          }
                        }}
                        disabled={shopifySyncStatus.loading || !shopifySyncRange.start || !shopifySyncRange.end}
                        className="px-6 py-2 bg-green-600 hover:bg-green-500 disabled:opacity-50 rounded-lg text-white font-medium flex items-center gap-2"
                      >
                        {shopifySyncStatus.loading ? (
                          <>
                            <Loader2 className="w-4 h-4 animate-spin" />
                            Syncing...
                          </>
                        ) : (
                          <>
                            <RefreshCw className="w-4 h-4" />
                            Sync Orders
                          </>
                        )}
                      </button>
                    </div>
                    
                    {shopifySyncStatus.progress && (
                      <p className="text-slate-400 text-sm mt-3 flex items-center gap-2">
                        <Loader2 className="w-4 h-4 animate-spin" />
                        {shopifySyncStatus.progress}
                      </p>
                    )}
                    {shopifySyncStatus.error && (
                      <p className="text-rose-400 text-sm mt-3 flex items-center gap-2">
                        <AlertCircle className="w-4 h-4" />
                        {shopifySyncStatus.error}
                      </p>
                    )}
                  </div>
                  
                  {/* Inventory Sync Section */}
                  <div className="bg-slate-900/50 rounded-xl p-4 mb-6">
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <h3 className="text-white font-medium flex items-center gap-2">
                          <Boxes className="w-5 h-5 text-emerald-400" />
                          Inventory Sync
                        </h3>
                        <p className="text-slate-400 text-sm">Pull current inventory levels from Shopify (includes 3PL)</p>
                      </div>
                      {shopifyCredentials.lastInventorySync && (
                        <span className="text-xs text-slate-500">
                          Last: {new Date(shopifyCredentials.lastInventorySync).toLocaleDateString()}
                        </span>
                      )}
                    </div>
                    
                    <div className="flex gap-3">
                      <button
                        onClick={async () => {
                          setShopifyInventoryStatus({ loading: true, error: null });
                          try {
                            const res = await fetch('/api/shopify/sync', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                storeUrl: shopifyCredentials.storeUrl,
                                clientId: shopifyCredentials.clientId, clientSecret: shopifyCredentials.clientSecret,
                                syncType: 'inventory',
                              }),
                            });
                            const data = await res.json();
                            if (data.error) throw new Error(data.error);
                            setShopifyInventoryPreview(data);
                            setShopifyInventoryStatus({ loading: false, error: null, lastSync: new Date().toISOString() });
                          } catch (err) {
                            setShopifyInventoryStatus({ loading: false, error: err.message });
                          }
                        }}
                        disabled={shopifyInventoryStatus.loading}
                        className="px-4 py-2 bg-slate-600 hover:bg-slate-500 disabled:opacity-50 rounded-lg text-white flex items-center gap-2"
                      >
                        <Eye className="w-4 h-4" />
                        Preview Inventory
                      </button>
                      <button
                        onClick={async () => {
                          if (!confirm('Sync inventory from Shopify? This will create a new inventory snapshot.')) return;
                          
                          setShopifyInventoryStatus({ loading: true, error: null });
                          try {
                            const res = await fetch('/api/shopify/sync', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                storeUrl: shopifyCredentials.storeUrl,
                                clientId: shopifyCredentials.clientId, clientSecret: shopifyCredentials.clientSecret,
                                syncType: 'inventory',
                              }),
                            });
                            const data = await res.json();
                            if (data.error) throw new Error(data.error);
                            
                            // Get existing inventory data to preserve Amazon quantities
                            const existingDates = Object.keys(invHistory).sort().reverse();
                            const existingSnapshot = existingDates.length > 0 ? invHistory[existingDates[0]] : null;
                            const existingItemsBySku = {};
                            if (existingSnapshot?.items) {
                              existingSnapshot.items.forEach(item => {
                                existingItemsBySku[item.sku] = item;
                              });
                            }
                            
                            // Create inventory snapshot - MERGE with existing data
                            const snapshotDate = data.date || new Date().toISOString().split('T')[0];
                            
                            // Build items with merged data
                            const mergedItems = data.items.map(item => {
                              const existing = existingItemsBySku[item.sku] || {};
                              // Use COGS if available, then Shopify cost, then existing cost
                              // savedCogs stores cost directly as number: savedCogs[sku] = 3.97
                              const cogsCost = typeof savedCogs[item.sku] === 'number' ? savedCogs[item.sku] : (savedCogs[item.sku]?.cost || 0);
                              const cost = cogsCost || item.cost || existing.cost || 0;
                              // Preserve Amazon quantities from existing data
                              const amazonQty = existing.amazonQty || 0;
                              const amazonInbound = existing.amazonInbound || 0;
                              const threeplQty = item.threeplQty || item.totalQty || 0;
                              const homeQty = item.homeQty || 0;
                              const totalQty = amazonQty + threeplQty + homeQty;
                              
                              return {
                                sku: item.sku,
                                name: savedProductNames[item.sku] || item.name || existing.name || item.sku,
                                asin: existing.asin || '',
                                amazonQty: amazonQty, // PRESERVED from existing
                                threeplQty: threeplQty, // FROM SHOPIFY
                                homeQty: homeQty, // FROM SHOPIFY
                                totalQty: totalQty,
                                cost: cost, // FROM COGS or Shopify
                                totalValue: totalQty * cost,
                                weeklyVel: existing.weeklyVel || 0,
                                daysOfSupply: existing.daysOfSupply || 999,
                                health: existing.health || 'unknown',
                                amazonInbound: amazonInbound, // PRESERVED
                                threeplInbound: existing.threeplInbound || 0,
                                locations: item.locations,
                                byLocation: item.byLocation,
                              };
                            });
                            
                            // Also include SKUs that exist in previous snapshot but not in Shopify
                            // (These might be Amazon-only products)
                            Object.entries(existingItemsBySku).forEach(([sku, existing]) => {
                              if (!mergedItems.find(i => i.sku === sku) && (existing.amazonQty > 0 || existing.amazonInbound > 0)) {
                                const cogsCost = typeof savedCogs[sku] === 'number' ? savedCogs[sku] : (savedCogs[sku]?.cost || 0);
                                const cost = cogsCost || existing.cost || 0;
                                mergedItems.push({
                                  ...existing,
                                  cost: cost,
                                  totalValue: (existing.amazonQty + (existing.threeplQty || 0)) * cost,
                                  threeplQty: 0, // Not in Shopify
                                  homeQty: 0,
                                  totalQty: existing.amazonQty + existing.amazonInbound,
                                });
                              }
                            });
                            
                            // Calculate summary totals
                            let totalUnits = 0, totalValue = 0, amazonUnits = 0, amazonValue = 0, threeplUnits = 0, threeplValue = 0;
                            mergedItems.forEach(item => {
                              totalUnits += item.totalQty || 0;
                              totalValue += item.totalValue || 0;
                              amazonUnits += item.amazonQty || 0;
                              amazonValue += (item.amazonQty || 0) * (item.cost || 0);
                              threeplUnits += item.threeplQty || 0;
                              threeplValue += (item.threeplQty || 0) * (item.cost || 0);
                            });
                            
                            const snapshot = {
                              date: snapshotDate,
                              createdAt: new Date().toISOString(),
                              velocitySource: 'Shopify inventory sync (merged)',
                              source: 'shopify-api-merged',
                              locations: data.locations,
                              summary: {
                                totalUnits,
                                totalValue,
                                amazonUnits,
                                amazonValue,
                                amazonInbound: existingSnapshot?.summary?.amazonInbound || 0,
                                threeplUnits,
                                threeplValue,
                                threeplInbound: existingSnapshot?.summary?.threeplInbound || 0,
                                skuCount: mergedItems.length,
                                critical: 0,
                                low: 0,
                                healthy: 0,
                                overstock: 0,
                              },
                              items: mergedItems.sort((a, b) => (b.totalValue || 0) - (a.totalValue || 0)),
                            };
                            
                            // Save to inventory history
                            const updated = { ...invHistory, [snapshotDate]: snapshot };
                            setInvHistory(updated);
                            saveInv(updated);
                            
                            // Update credentials with last sync time
                            setShopifyCredentials(p => ({ ...p, lastInventorySync: new Date().toISOString() }));
                            
                            setShopifyInventoryStatus({ loading: false, error: null, lastSync: new Date().toISOString() });
                            setShopifyInventoryPreview(null);
                            setToast({ 
                              message: `Synced ${data.summary.skuCount} SKUs, ${formatNumber(data.summary.totalUnits)} units from ${data.locations?.length || 0} locations`, 
                              type: 'success' 
                            });
                          } catch (err) {
                            setShopifyInventoryStatus({ loading: false, error: err.message });
                          }
                        }}
                        disabled={shopifyInventoryStatus.loading}
                        className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 rounded-lg text-white font-medium flex items-center gap-2"
                      >
                        {shopifyInventoryStatus.loading ? (
                          <>
                            <Loader2 className="w-4 h-4 animate-spin" />
                            Syncing...
                          </>
                        ) : (
                          <>
                            <Boxes className="w-4 h-4" />
                            Sync Inventory
                          </>
                        )}
                      </button>
                    </div>
                    
                    {shopifyInventoryStatus.error && (
                      <p className="text-rose-400 text-sm mt-3 flex items-center gap-2">
                        <AlertCircle className="w-4 h-4" />
                        {shopifyInventoryStatus.error}
                      </p>
                    )}
                    
                    {/* Inventory Preview */}
                    {shopifyInventoryPreview && (
                      <div className="mt-4 pt-4 border-t border-slate-700">
                        <h4 className="text-emerald-400 font-medium mb-3 flex items-center gap-2">
                          <Eye className="w-4 h-4" />
                          Inventory Preview
                        </h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                          <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                            <p className="text-xl font-bold text-white">{formatNumber(shopifyInventoryPreview.summary?.totalUnits || 0)}</p>
                            <p className="text-slate-400 text-xs">Total Units</p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                            <p className="text-xl font-bold text-emerald-400">{formatCurrency(shopifyInventoryPreview.summary?.totalValue || 0)}</p>
                            <p className="text-slate-400 text-xs">Total Value</p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                            <p className="text-xl font-bold text-white">{shopifyInventoryPreview.summary?.skuCount || 0}</p>
                            <p className="text-slate-400 text-xs">SKUs</p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                            <p className="text-xl font-bold text-white">{shopifyInventoryPreview.locations?.length || 0}</p>
                            <p className="text-slate-400 text-xs">Locations</p>
                          </div>
                        </div>
                        
                        {/* Location Breakdown */}
                        {shopifyInventoryPreview.locations && shopifyInventoryPreview.locations.length > 0 && (
                          <div className="mb-4">
                            <p className="text-slate-400 text-sm mb-2">Locations:</p>
                            <div className="flex flex-wrap gap-2">
                              {shopifyInventoryPreview.locations.map(loc => (
                                <span key={loc.id} className={`px-3 py-1 rounded-lg text-xs ${
                                  loc.type === '3pl' ? 'bg-violet-900/50 text-violet-300 border border-violet-500/30' :
                                  loc.type === 'home' ? 'bg-amber-900/50 text-amber-300 border border-amber-500/30' :
                                  'bg-slate-700 text-slate-300'
                                }`}>
                                  {loc.name}
                                  {loc.type === '3pl' && ' (3PL)'}
                                  {loc.type === 'home' && ' (Home)'}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        
                        {/* Top SKUs */}
                        {shopifyInventoryPreview.items && shopifyInventoryPreview.items.length > 0 && (
                          <div>
                            <p className="text-slate-400 text-sm mb-2">Top SKUs by Value:</p>
                            <div className="space-y-1 max-h-40 overflow-y-auto">
                              {shopifyInventoryPreview.items.slice(0, 8).map(item => (
                                <div key={item.sku} className="flex items-center justify-between text-xs bg-slate-800/30 rounded px-2 py-1">
                                  <span className="text-slate-300 truncate flex-1">{item.name}</span>
                                  <span className="text-white font-medium ml-2">{formatNumber(item.totalQty)}</span>
                                  <span className="text-emerald-400 ml-2">{formatCurrency(item.totalValue)}</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                    
                    <p className="text-slate-500 text-xs mt-3">
                      ðŸ’¡ Includes inventory from all Shopify locations (3PL, warehouse, etc). Amazon FBA inventory requires separate upload.
                    </p>
                  </div>
                  
                  {/* Product Catalog Sync Section */}
                  <div className="bg-slate-900/50 rounded-xl p-4 mb-6">
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <h3 className="text-white font-medium flex items-center gap-2">
                          <Package className="w-5 h-5 text-violet-400" />
                          Product Catalog Sync
                        </h3>
                        <p className="text-slate-400 text-sm">Sync SKU â†’ Product Name mappings from Shopify</p>
                      </div>
                      <span className="text-xs text-slate-500">
                        {Object.keys(savedProductNames).length} SKUs mapped
                      </span>
                    </div>
                    
                    <div className="flex gap-3">
                      <button
                        onClick={async () => {
                          setShopifySyncStatus(p => ({ ...p, loading: true, progress: 'Fetching product catalog...' }));
                          try {
                            const res = await fetch('/api/shopify/sync', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                storeUrl: shopifyCredentials.storeUrl,
                                clientId: shopifyCredentials.clientId, clientSecret: shopifyCredentials.clientSecret,
                                syncType: 'products',
                              }),
                            });
                            const data = await res.json();
                            if (data.error) throw new Error(data.error);
                            
                            // Merge with existing product names (SKU is the key!)
                            // Shopify names don't overwrite manually set names
                            const mergedNames = { ...savedProductNames };
                            let newCount = 0;
                            let updatedCount = 0;
                            
                            Object.entries(data.catalog || {}).forEach(([sku, product]) => {
                              if (!mergedNames[sku]) {
                                // New SKU - add it
                                mergedNames[sku] = product.name;
                                newCount++;
                              } else if (mergedNames[sku] === sku) {
                                // SKU exists but name is just the SKU itself - update it
                                mergedNames[sku] = product.name;
                                updatedCount++;
                              }
                              // Otherwise keep existing name (user may have customized it)
                            });
                            
                            setSavedProductNames(mergedNames);
                            localStorage.setItem(PRODUCT_NAMES_KEY, JSON.stringify(mergedNames));
                            
                            setShopifySyncStatus(p => ({ ...p, loading: false, progress: '' }));
                            setToast({ 
                              message: `Synced ${data.skuCount} SKUs (${newCount} new, ${updatedCount} updated)`, 
                              type: 'success' 
                            });
                          } catch (err) {
                            setShopifySyncStatus(p => ({ ...p, loading: false, error: err.message, progress: '' }));
                          }
                        }}
                        disabled={shopifySyncStatus.loading}
                        className="px-6 py-2 bg-violet-600 hover:bg-violet-500 disabled:opacity-50 rounded-lg text-white font-medium flex items-center gap-2"
                      >
                        {shopifySyncStatus.loading && shopifySyncStatus.progress?.includes('catalog') ? (
                          <>
                            <Loader2 className="w-4 h-4 animate-spin" />
                            Syncing...
                          </>
                        ) : (
                          <>
                            <Package className="w-4 h-4" />
                            Sync Product Names
                          </>
                        )}
                      </button>
                    </div>
                    
                    <div className="mt-3 p-3 bg-slate-800/50 rounded-lg">
                      <p className="text-slate-300 text-xs mb-2 font-medium">How SKU Matching Works:</p>
                      <ul className="text-slate-400 text-xs space-y-1">
                        <li>â€¢ <strong className="text-white">SKU is the primary key</strong> - matches across Amazon & Shopify</li>
                        <li>â€¢ Product names are display-only (can differ between platforms)</li>
                        <li>â€¢ Existing custom names you've set won't be overwritten</li>
                        <li>â€¢ SKUs without a match show as the raw SKU code</li>
                      </ul>
                    </div>
                  </div>
                  
                  {/* Preview Results */}
                  {shopifySyncPreview && (
                    <div className="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-4 mb-6">
                      <h3 className="text-emerald-400 font-medium mb-3 flex items-center gap-2">
                        <Eye className="w-4 h-4" />
                        Sync Preview
                      </h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div className="text-center">
                          <p className="text-2xl font-bold text-white">{shopifySyncPreview.orderCount}</p>
                          <p className="text-slate-400 text-sm">Orders</p>
                        </div>
                        <div className="text-center">
                          <p className="text-2xl font-bold text-emerald-400">{formatCurrency(shopifySyncPreview.totalRevenue)}</p>
                          <p className="text-slate-400 text-sm">Revenue</p>
                        </div>
                        <div className="text-center">
                          <p className="text-2xl font-bold text-white">{shopifySyncPreview.totalUnits}</p>
                          <p className="text-slate-400 text-sm">Units</p>
                        </div>
                        <div className="text-center">
                          <p className="text-2xl font-bold text-white">{shopifySyncPreview.uniqueDays}</p>
                          <p className="text-slate-400 text-sm">Days</p>
                        </div>
                      </div>
                      {shopifySyncPreview.skuBreakdown && shopifySyncPreview.skuBreakdown.length > 0 && (
                        <div className="border-t border-emerald-500/30 pt-3 mt-3">
                          <p className="text-slate-400 text-sm mb-2">Top SKUs:</p>
                          <div className="flex flex-wrap gap-2">
                            {shopifySyncPreview.skuBreakdown.slice(0, 5).map(sku => (
                              <span key={sku.sku} className="px-2 py-1 bg-slate-800 rounded text-xs text-slate-300">
                                {sku.sku}: {sku.units} units
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                      
                      {/* Tax Preview */}
                      {shopifySyncPreview.tax && (
                        <div className="border-t border-emerald-500/30 pt-3 mt-3">
                          <p className="text-slate-400 text-sm mb-2 flex items-center gap-2">
                            <DollarSign className="w-4 h-4" />
                            Sales Tax Summary:
                          </p>
                          <div className="grid grid-cols-2 gap-3 mb-3">
                            <div className="bg-slate-800/50 rounded-lg p-2 text-center">
                              <p className="text-lg font-semibold text-emerald-400">{formatCurrency(shopifySyncPreview.tax.totalCollected)}</p>
                              <p className="text-xs text-slate-400">Tax to Remit</p>
                            </div>
                            <div className="bg-slate-800/50 rounded-lg p-2 text-center">
                              <p className="text-lg font-semibold text-slate-300">{shopifySyncPreview.tax.byState?.length || 0}</p>
                              <p className="text-xs text-slate-400">States</p>
                            </div>
                          </div>
                          {shopifySyncPreview.tax.byState && shopifySyncPreview.tax.byState.length > 0 && (
                            <div className="space-y-1">
                              <p className="text-slate-500 text-xs uppercase">Tax by State:</p>
                              <div className="flex flex-wrap gap-2">
                                {shopifySyncPreview.tax.byState.slice(0, 8).map(state => (
                                  <span key={state.stateCode} className="px-2 py-1 bg-slate-800 rounded text-xs text-slate-300">
                                    {state.stateCode}: {formatCurrency(state.taxCollected)}
                                  </span>
                                ))}
                                {shopifySyncPreview.tax.byState.length > 8 && (
                                  <span className="px-2 py-1 text-xs text-slate-500">+{shopifySyncPreview.tax.byState.length - 8} more</span>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* What Gets Synced */}
                  <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                    <h3 className="text-blue-400 font-medium mb-3 flex items-center gap-2">
                      <HelpCircle className="w-4 h-4" />
                      What Gets Synced
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <p className="text-slate-300 text-sm font-medium mb-2">ðŸ“¦ Orders Sync:</p>
                        <ul className="text-slate-400 text-sm space-y-1">
                          <li className="flex items-start gap-2">
                            <Check className="w-3 h-3 text-emerald-400 mt-1 shrink-0" />
                            <span>Daily & weekly revenue</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <Check className="w-3 h-3 text-emerald-400 mt-1 shrink-0" />
                            <span>SKU-level units sold</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <Check className="w-3 h-3 text-emerald-400 mt-1 shrink-0" />
                            <span>Tax by state</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <Check className="w-3 h-3 text-emerald-400 mt-1 shrink-0" />
                            <span>Discounts applied</span>
                          </li>
                        </ul>
                      </div>
                      <div>
                        <p className="text-slate-300 text-sm font-medium mb-2">ðŸ“‹ Inventory Sync:</p>
                        <ul className="text-slate-400 text-sm space-y-1">
                          <li className="flex items-start gap-2">
                            <Check className="w-3 h-3 text-emerald-400 mt-1 shrink-0" />
                            <span>3PL stock levels</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <Check className="w-3 h-3 text-emerald-400 mt-1 shrink-0" />
                            <span>All Shopify locations</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <Check className="w-3 h-3 text-emerald-400 mt-1 shrink-0" />
                            <span>SKU/product details</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <Check className="w-3 h-3 text-emerald-400 mt-1 shrink-0" />
                            <span>Cost values</span>
                          </li>
                        </ul>
                      </div>
                    </div>
                    <div className="mt-3 pt-3 border-t border-blue-500/20">
                      <p className="text-blue-300 text-xs flex items-start gap-2">
                        <AlertCircle className="w-4 h-4 shrink-0 mt-0.5" />
                        <span><strong>Amazon inventory still requires manual upload</strong> since it's not in Shopify.</span>
                      </p>
                    </div>
                  </div>
                </>
              ) : (
                <div className="space-y-4">
                  <div className="bg-gradient-to-r from-green-900/30 to-emerald-900/30 rounded-xl border border-green-500/30 p-6">
                    <h3 className="text-green-400 font-semibold mb-4 flex items-center gap-2">
                      <Zap className="w-5 h-5" />
                      Quick Setup Guide (5 minutes)
                    </h3>
                    <ol className="space-y-4 text-slate-300">
                      <li className="flex gap-3">
                        <span className="w-6 h-6 rounded-full bg-green-600 text-white text-sm flex items-center justify-center shrink-0">1</span>
                        <div>
                          <p className="font-medium">Go to Shopify Admin</p>
                          <p className="text-slate-400 text-sm">Settings â†’ Apps and sales channels â†’ Develop apps</p>
                        </div>
                      </li>
                      <li className="flex gap-3">
                        <span className="w-6 h-6 rounded-full bg-green-600 text-white text-sm flex items-center justify-center shrink-0">2</span>
                        <div>
                          <p className="font-medium">Create a Custom App</p>
                          <p className="text-slate-400 text-sm">Click "Allow custom app development" if prompted, then "Create an app"</p>
                        </div>
                      </li>
                      <li className="flex gap-3">
                        <span className="w-6 h-6 rounded-full bg-green-600 text-white text-sm flex items-center justify-center shrink-0">3</span>
                        <div>
                          <p className="font-medium">Configure API Scopes</p>
                          <p className="text-slate-400 text-sm">Enable: <code className="bg-slate-800 px-1 rounded">read_orders</code>, <code className="bg-slate-800 px-1 rounded">read_products</code>, <code className="bg-slate-800 px-1 rounded">read_inventory</code>, <code className="bg-slate-800 px-1 rounded">read_locations</code></p>
                        </div>
                      </li>
                      <li className="flex gap-3">
                        <span className="w-6 h-6 rounded-full bg-green-600 text-white text-sm flex items-center justify-center shrink-0">4</span>
                        <div>
                          <p className="font-medium">Install & Get Token</p>
                          <p className="text-slate-400 text-sm">Click Install, then copy the Admin API access token</p>
                        </div>
                      </li>
                      <li className="flex gap-3">
                        <span className="w-6 h-6 rounded-full bg-green-600 text-white text-sm flex items-center justify-center shrink-0">5</span>
                        <div>
                          <p className="font-medium">Connect Here</p>
                          <p className="text-slate-400 text-sm">Go to Settings and enter your store URL + token</p>
                        </div>
                      </li>
                    </ol>
                    <button
                      onClick={() => setView('settings')}
                      className="mt-6 w-full py-3 bg-green-600 hover:bg-green-500 rounded-xl text-white font-semibold flex items-center justify-center gap-2"
                    >
                      <Settings className="w-5 h-5" />
                      Go to Settings to Connect
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}
          
          {/* Import/Export */}
          <div className="mt-6 flex gap-3 justify-center">
            <button onClick={exportAll} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white flex items-center gap-2"><Download className="w-4 h-4" />Export All Data</button>
            <label className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white flex items-center gap-2 cursor-pointer"><Upload className="w-4 h-4" />Import Data<input type="file" accept=".json" onChange={(e) => e.target.files[0] && importData(e.target.files[0])} className="hidden" /></label>
          </div>
        </div>
      </div>
    );
  }

  if (view === 'bulk') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-6">
        <div className="max-w-3xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <div className="text-center mb-8"><div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-amber-500 to-orange-600 mb-4"><Layers className="w-8 h-8 text-white" /></div><h1 className="text-3xl font-bold text-white mb-2">Bulk Import</h1><p className="text-slate-400">Auto-splits into weeks</p></div>
          <NavTabs />{dataBar}
          <div className="bg-amber-900/20 border border-amber-500/30 rounded-2xl p-5 mb-6"><h3 className="text-amber-400 font-semibold mb-2">How It Works</h3><ul className="text-slate-300 text-sm space-y-1"><li>â€¢ Upload Amazon with "End date" column</li><li>â€¢ Auto-groups by week ending Sunday</li><li>â€¢ Shopify distributed proportionally</li></ul></div>
          <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6 mb-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><FileBox type="amazon" label="Amazon Report" desc="Multi-week CSV" req /><FileBox type="shopify" label="Shopify Sales" desc="Matching period" req /></div>
          </div>
          {!hasCogs && <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4 mb-6"><p className="text-amber-400 font-semibold">COGS Required</p><p className="text-slate-300 text-sm">Click "COGS" button above first.</p></div>}
          {bulkImportResult && <div className="bg-emerald-900/20 border border-emerald-500/30 rounded-2xl p-5 mb-6"><h3 className="text-emerald-400 font-semibold mb-2">Import Complete!</h3><p className="text-slate-300">Created <span className="text-white font-bold">{bulkImportResult.weeksCreated}</span> weeks</p><p className="text-slate-400 text-sm">{bulkImportResult.dateRange}</p></div>}
          <button onClick={processBulkImport} disabled={isProcessing || !files.amazon || !files.shopify || !hasCogs} className="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 disabled:from-slate-700 disabled:to-slate-700 text-white font-semibold py-4 rounded-xl">{isProcessing ? 'Processing...' : 'Import & Split'}</button>
        </div>
      </div>
    );
  }

  if (view === 'custom-select') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-6">
        <div className="max-w-3xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <div className="text-center mb-8"><div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-cyan-500 to-blue-600 mb-4"><CalendarRange className="w-8 h-8 text-white" /></div><h1 className="text-3xl font-bold text-white mb-2">Custom Period</h1></div>
          <NavTabs />{dataBar}
          <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6 mb-6">
            <div className="grid grid-cols-2 gap-4">
              <div><label className="block text-sm text-slate-400 mb-2">Start</label><input type="date" value={customStartDate} onChange={(e) => setCustomStartDate(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white" /></div>
              <div><label className="block text-sm text-slate-400 mb-2">End</label><input type="date" value={customEndDate} onChange={(e) => setCustomEndDate(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white" /></div>
            </div>
          </div>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <button onClick={() => { const n = new Date(), s = new Date(n.getFullYear(), n.getMonth() - 1, 1), e = new Date(n.getFullYear(), n.getMonth(), 0); setCustomStartDate(s.toISOString().split('T')[0]); setCustomEndDate(e.toISOString().split('T')[0]); }} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white">Last Month</button>
            <button onClick={() => { const n = new Date(), s = new Date(n.getFullYear(), n.getMonth() - 3, 1), e = new Date(n.getFullYear(), n.getMonth(), 0); setCustomStartDate(s.toISOString().split('T')[0]); setCustomEndDate(e.toISOString().split('T')[0]); }} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white">Last Quarter</button>
            <button onClick={() => { const n = new Date(); setCustomStartDate(`${n.getFullYear()}-01-01`); setCustomEndDate(n.toISOString().split('T')[0]); }} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white">YTD</button>
            <button onClick={() => { const y = new Date().getFullYear() - 1; setCustomStartDate(`${y}-01-01`); setCustomEndDate(`${y}-12-31`); }} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white">Last Year</button>
          </div>
          <button onClick={processCustomPeriod} disabled={!customStartDate || !customEndDate} className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-slate-700 disabled:to-slate-700 text-white font-semibold py-4 rounded-xl">Analyze</button>
        </div>
      </div>
    );
  }

  if (view === 'custom' && customPeriodData) {
    const data = customPeriodData;
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <div><h1 className="text-2xl lg:text-3xl font-bold text-white">Custom Period</h1><p className="text-slate-400">{data.startDate} to {data.endDate} ({data.weeksIncluded} weeks)</p></div>
            <button onClick={() => setView('custom-select')} className="bg-cyan-700 hover:bg-cyan-600 text-white px-3 py-2 rounded-lg text-sm">Change</button>
          </div>
          <NavTabs />
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <MetricCard label="Total Revenue" value={formatCurrency(data.total.revenue)} icon={DollarSign} color="emerald" />
            <MetricCard label="Net Profit" value={formatCurrency(data.total.netProfit)} sub={`${formatPercent(data.total.netMargin)} margin`} icon={TrendingUp} color={data.total.netProfit >= 0 ? 'emerald' : 'rose'} />
            <MetricCard label="Avg Weekly Rev" value={formatCurrency(data.avgWeeklyRevenue)} icon={Calendar} color="cyan" />
            <MetricCard label="Avg Weekly Profit" value={formatCurrency(data.avgWeeklyProfit)} icon={TrendingUp} color="cyan" />
          </div>
          <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5 mb-8"><h3 className="text-sm font-semibold text-slate-400 uppercase mb-4">Weekly Trend</h3>
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {data.weeklyBreakdown.map((w) => { const max = Math.max(...data.weeklyBreakdown.map(x => x.revenue)) || 1; return (
                <div key={w.week} className="flex items-center gap-4">
                  <span className="w-20 text-xs text-slate-400">{new Date(w.week+'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                  <div className="flex-1 h-6 bg-slate-700 rounded overflow-hidden relative">
                    <div className={`h-full ${w.profit >= 0 ? 'bg-emerald-600' : 'bg-rose-600'}`} style={{ width: `${(w.revenue/max)*100}%` }} />
                    <div className="absolute inset-0 flex items-center justify-between px-2 text-xs"><span className="text-white">{formatCurrency(w.revenue)}</span><span className={w.profit >= 0 ? 'text-emerald-300' : 'text-rose-300'}>{formatCurrency(w.profit)}</span></div>
                  </div>
                </div>
              );})}
            </div>
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><ChannelCard title="Amazon" color="orange" data={data.amazon} isAmz /><ChannelCard title="Shopify" color="blue" data={data.shopify} /></div>
        </div>
      </div>
    );
  }

  // ==================== DAILY VIEW ====================
  if (view === 'daily' && selectedDay && allDaysData[selectedDay]) {
    const dayData = allDaysData[selectedDay];
    const daysWithSales = Object.keys(allDaysData).filter(k => hasDailySalesData(allDaysData[k])).sort().reverse();
    const idx = daysWithSales.indexOf(selectedDay);
    
    const amazon = dayData.amazon || {};
    const shopify = dayData.shopify || {};
    const total = dayData.total || {};
    
    // Get ads metrics from either shopify object or top-level dayData (bulk uploads store at top level)
    const googleSpend = shopify.googleSpend || dayData.googleSpend || 0;
    const metaSpend = shopify.metaSpend || dayData.metaSpend || 0;
    const googleImpressions = shopify.adsMetrics?.googleImpressions || dayData.googleImpressions || 0;
    const googleClicks = shopify.adsMetrics?.googleClicks || dayData.googleClicks || 0;
    const googleConversions = shopify.adsMetrics?.googleConversions || dayData.googleConversions || 0;
    const googleCPC = dayData.googleCpc || (googleClicks > 0 ? googleSpend / googleClicks : 0);
    const googleCPA = dayData.googleCpa || dayData.googleCostPerConv || (googleConversions > 0 ? googleSpend / googleConversions : 0);
    const metaImpressions = shopify.adsMetrics?.metaImpressions || dayData.metaImpressions || 0;
    const metaClicks = shopify.adsMetrics?.metaClicks || dayData.metaClicks || 0;
    const metaPurchases = shopify.adsMetrics?.metaPurchases || dayData.metaPurchases || dayData.metaConversions || 0;
    const metaCTR = dayData.metaCtr || (metaImpressions > 0 ? (metaClicks / metaImpressions) * 100 : 0);
    const metaCPC = dayData.metaCpc || (metaClicks > 0 ? metaSpend / metaClicks : 0);
    
    // Get 3PL costs from ledger first (exact day match), then try week ledger, then weekly data, then fallback
    const ledger3PLDay = get3PLForDay(threeplLedger, selectedDay);
    // Calculate the week key (Sunday) for this day
    const weekKey = getSunday(new Date(selectedDay + 'T12:00:00'));
    const ledger3PLWeek = !ledger3PLDay ? get3PLForWeek(threeplLedger, weekKey) : null;
    const weekData = allWeeksData[weekKey];
    
    // Use day data if available, otherwise prorate week data
    // NOTE: Storage is excluded from daily 3PL as it's a weekly/monthly aggregate charge
    let threeplCosts = 0;
    let threeplBreakdown = {};
    let threeplMetrics = {};
    
    if (ledger3PLDay && ledger3PLDay.metrics.totalCost > 0) {
      // Exact day match from ledger - exclude storage
      const storageExcluded = ledger3PLDay.breakdown.storage || 0;
      threeplCosts = ledger3PLDay.metrics.totalCost - storageExcluded;
      threeplBreakdown = { ...ledger3PLDay.breakdown, storage: 0 };
      threeplMetrics = { ...ledger3PLDay.metrics, totalCost: threeplCosts };
    } else if (ledger3PLWeek && ledger3PLWeek.metrics.totalCost > 0) {
      // Prorate from week ledger data - exclude storage
      const weekShopifyUnits = weekData?.shopify?.units || 0;
      const dayShopifyUnits = shopify.units || 0;
      const ratio = weekShopifyUnits > 0 && dayShopifyUnits > 0 
        ? dayShopifyUnits / weekShopifyUnits 
        : 1/7;
      
      // Calculate costs excluding storage
      const weekCostExStorage = ledger3PLWeek.metrics.totalCost - (ledger3PLWeek.breakdown.storage || 0);
      threeplCosts = weekCostExStorage * ratio;
      threeplBreakdown = {
        storage: 0, // Excluded from daily
        shipping: (ledger3PLWeek.breakdown.shipping || 0) * ratio,
        pickFees: (ledger3PLWeek.breakdown.pickFees || 0) * ratio,
        boxCharges: (ledger3PLWeek.breakdown.boxCharges || 0) * ratio,
        receiving: (ledger3PLWeek.breakdown.receiving || 0) * ratio,
        other: (ledger3PLWeek.breakdown.other || 0) * ratio,
      };
      threeplMetrics = {
        ...ledger3PLWeek.metrics,
        totalCost: threeplCosts,
        orderCount: Math.round(ledger3PLWeek.metrics.orderCount * ratio),
        totalUnits: Math.round(ledger3PLWeek.metrics.totalUnits * ratio),
        isProrated: true,
      };
    } else if (weekData?.shopify?.threeplCosts > 0) {
      // Use weekly processed data's 3PL costs (prorate by units) - exclude storage
      const weekShopifyUnits = weekData.shopify.units || 0;
      const dayShopifyUnits = shopify.units || 0;
      const ratio = weekShopifyUnits > 0 && dayShopifyUnits > 0 
        ? dayShopifyUnits / weekShopifyUnits 
        : 1/7;
      
      const weekThreepl = weekData.shopify;
      const weekStorage = weekThreepl.threeplBreakdown?.storage || 0;
      const weekCostExStorage = weekThreepl.threeplCosts - weekStorage;
      threeplCosts = weekCostExStorage * ratio;
      threeplBreakdown = weekThreepl.threeplBreakdown ? {
        storage: 0, // Excluded from daily
        shipping: (weekThreepl.threeplBreakdown.shipping || 0) * ratio,
        pickFees: (weekThreepl.threeplBreakdown.pickFees || 0) * ratio,
        boxCharges: (weekThreepl.threeplBreakdown.boxCharges || 0) * ratio,
        receiving: (weekThreepl.threeplBreakdown.receiving || 0) * ratio,
        other: (weekThreepl.threeplBreakdown.other || 0) * ratio,
      } : {};
      threeplMetrics = weekThreepl.threeplMetrics ? {
        ...weekThreepl.threeplMetrics,
        totalCost: threeplCosts,
        orderCount: Math.round((weekThreepl.threeplMetrics.orderCount || 0) * ratio),
        totalUnits: Math.round((weekThreepl.threeplMetrics.totalUnits || 0) * ratio),
        isProrated: true,
      } : { totalCost: threeplCosts, isProrated: true };
    } else {
      // Fallback to stored day data - also exclude storage
      const rawCost = shopify.threeplCosts || dayData.threeplCosts || 0;
      const rawBreakdown = shopify.threeplBreakdown || dayData.threeplBreakdown || {};
      const storageCost = rawBreakdown.storage || 0;
      threeplCosts = rawCost - storageCost;
      threeplBreakdown = { ...rawBreakdown, storage: 0 };
      threeplMetrics = shopify.threeplMetrics || dayData.threeplMetrics || {};
    }
    
    // Build proper data structures for ChannelCard component
    const amazonData = {
      revenue: amazon.revenue || 0,
      units: amazon.units || 0,
      netProfit: amazon.netProfit || amazon.netProceeds || 0,
      margin: amazon.margin || (amazon.revenue > 0 ? ((amazon.netProfit || amazon.netProceeds || 0) / amazon.revenue) * 100 : 0),
      cogs: amazon.cogs || 0,
      fees: amazon.fees || amazon.fbaFees || 0,
      adSpend: amazon.adSpend || 0,
      roas: amazon.roas || (amazon.adSpend > 0 ? amazon.revenue / amazon.adSpend : 0),
      aov: amazon.units > 0 ? amazon.revenue / amazon.units : 0,
      returns: amazon.returns || 0,
      returnRate: amazon.returnRate || 0,
      skuData: amazon.skuData || [],
    };
    
    const shopifyData = {
      revenue: shopify.revenue || 0,
      units: shopify.units || 0,
      netProfit: shopify.netProfit || 0,
      netMargin: shopify.netMargin || (shopify.revenue > 0 ? (shopify.netProfit / shopify.revenue) * 100 : 0),
      cogs: shopify.cogs || 0,
      threeplCosts: threeplCosts,
      threeplBreakdown: threeplBreakdown,
      threeplMetrics: threeplMetrics,
      adSpend: metaSpend + googleSpend,
      metaSpend: metaSpend,
      googleSpend: googleSpend,
      roas: (metaSpend + googleSpend) > 0 ? (shopify.revenue || 0) / (metaSpend + googleSpend) : 0,
      aov: shopify.units > 0 ? shopify.revenue / shopify.units : 0,
      discounts: shopify.discounts || 0,
      skuData: shopify.skuData || [],
    };
    
    const deleteDay = (dayKey) => {
      const data = allDaysData[dayKey];
      if (!data) return;
      
      const revenue = data.total?.revenue || 0;
      const dateStr = new Date(dayKey + 'T12:00:00').toLocaleDateString();
      
      // Delete immediately
      const updated = { ...allDaysData };
      delete updated[dayKey];
      setAllDaysData(updated);
      lsSet('ecommerce_daily_sales_v1', JSON.stringify(updated));
      queueCloudSave({ ...combinedData, dailySales: updated });
      
      // Store for undo
      const undoId = Date.now();
      const undoTimer = setTimeout(() => {
        setDeletedItems(prev => prev.filter(item => item.id !== undoId));
      }, 10000);
      
      setDeletedItems(prev => [...prev, { id: undoId, type: 'day', key: dayKey, data, undoTimer }]);
      setToast({ 
        message: `Deleted ${dateStr} ($${revenue.toFixed(0)} revenue)`, 
        type: 'warning',
        action: {
          label: 'Undo',
          onClick: () => {
            clearTimeout(undoTimer);
            const restored = { ...allDaysData, [dayKey]: data };
            setAllDaysData(restored);
            lsSet('ecommerce_daily_sales_v1', JSON.stringify(restored));
            queueCloudSave({ ...combinedData, dailySales: restored });
            setSelectedDay(dayKey);
            setDeletedItems(prev => prev.filter(item => item.id !== undoId));
            setToast({ message: `Restored ${dateStr}`, type: 'success' });
          }
        }
      });
      
      const remaining = Object.keys(updated).filter(k => hasDailySalesData(updated[k])).sort().reverse();
      if (remaining.length) setSelectedDay(remaining[0]);
      else { setView('dashboard'); setSelectedDay(null); }
    };
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <div className="flex items-center gap-4">
              {storeLogo && (
                <img src={storeLogo} alt="Store logo" className="w-12 h-12 object-contain rounded-xl bg-white p-1.5" />
              )}
              <div>
                <h1 className="text-2xl lg:text-3xl font-bold text-white">{storeName ? storeName + ' Dashboard' : 'Daily Performance'}</h1>
                <p className="text-slate-400">{new Date(selectedDay + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button onClick={() => deleteDay(selectedDay)} className="bg-rose-900/50 hover:bg-rose-800/50 border border-rose-600/50 text-rose-300 px-3 py-2 rounded-lg text-sm"><Trash2 className="w-4 h-4" /></button>
            </div>
          </div>
          
          <NavTabs />
          
          {/* Day Selector */}
          <div className="flex items-center gap-4 mb-6">
            <button onClick={() => idx < daysWithSales.length - 1 && setSelectedDay(daysWithSales[idx + 1])} disabled={idx >= daysWithSales.length - 1} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronLeft className="w-5 h-5" /></button>
            <select value={selectedDay} onChange={(e) => setSelectedDay(e.target.value)} className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">
              {daysWithSales.map(d => <option key={d} value={d}>{new Date(d + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}</option>)}
            </select>
            <button onClick={() => idx > 0 && setSelectedDay(daysWithSales[idx - 1])} disabled={idx <= 0} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronRight className="w-5 h-5" /></button>
          </div>
          
          {/* Top Metrics */}
          <div className="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <MetricCard label="Total Revenue" value={formatCurrency(total.revenue || 0)} icon={DollarSign} color="emerald" />
            <MetricCard label="Total Units" value={formatNumber(total.units || 0)} icon={Package} color="blue" />
            <MetricCard label="Net Profit" value={formatCurrency(total.netProfit || 0)} sub={`${formatPercent(total.netMargin || 0)} margin`} icon={TrendingUp} color={(total.netProfit || 0) >= 0 ? 'emerald' : 'rose'} />
            <MetricCard label="Ad Spend" value={formatCurrency(total.adSpend || 0)} sub={`${(total.roas || 0).toFixed(2)}x TACOS`} icon={BarChart3} color="violet" />
            <MetricCard label="COGS" value={formatCurrency(total.cogs || 0)} icon={ShoppingCart} color="amber" />
          </div>
          
          {/* Channel Split Bar */}
          <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5 mb-8">
            <h3 className="text-sm font-semibold text-slate-400 uppercase mb-4">Revenue by Channel</h3>
            <div className="h-4 bg-slate-700 rounded-full overflow-hidden flex mb-3">
              <div className="bg-orange-500 h-full" style={{ width: `${total.amazonShare || 0}%` }} />
              <div className="bg-blue-500 h-full" style={{ width: `${total.shopifyShare || 0}%` }} />
            </div>
            <div className="flex justify-between text-sm">
              <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-orange-500" /><span className="text-slate-300">Amazon</span><span className="text-white font-semibold">{formatPercent(total.amazonShare || 0)}</span></div>
              <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-blue-500" /><span className="text-slate-300">Shopify</span><span className="text-white font-semibold">{formatPercent(total.shopifyShare || 0)}</span></div>
            </div>
          </div>
          
          {/* Channel Cards */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <ChannelCard title="Amazon" color="orange" data={amazonData} isAmz showSkuTable />
            <ChannelCard title="Shopify" color="blue" data={shopifyData} showSkuTable />
          </div>
          
          {/* Google/Meta Ads Details */}
          {(googleSpend > 0 || googleImpressions > 0 || metaSpend > 0 || metaImpressions > 0) && (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
              {/* Google Ads */}
              {(googleSpend > 0 || googleImpressions > 0) && (
                <div className="bg-red-900/20 border border-red-500/30 rounded-2xl p-5">
                  <h3 className="text-lg font-semibold text-red-400 mb-4">Google Ads</h3>
                  <div className="grid grid-cols-3 gap-4 text-center">
                    <div><p className="text-slate-400 text-xs mb-1">Spend</p><p className="text-white text-lg font-semibold">{formatCurrency(googleSpend)}</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">Clicks</p><p className="text-white text-lg font-semibold">{formatNumber(googleClicks)}</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">Impressions</p><p className="text-white text-lg font-semibold">{formatNumber(googleImpressions)}</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">Conversions</p><p className="text-white text-lg font-semibold">{formatNumber(googleConversions)}</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">CPC</p><p className="text-white text-lg font-semibold">{formatCurrency(googleCPC)}</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">CPA</p><p className="text-white text-lg font-semibold">{formatCurrency(googleCPA)}</p></div>
                  </div>
                </div>
              )}
              
              {/* Meta Ads */}
              {(metaSpend > 0 || metaImpressions > 0) && (
                <div className="bg-indigo-900/20 border border-indigo-500/30 rounded-2xl p-5">
                  <h3 className="text-lg font-semibold text-indigo-400 mb-4">Meta Ads</h3>
                  <div className="grid grid-cols-3 gap-4 text-center">
                    <div><p className="text-slate-400 text-xs mb-1">Spend</p><p className="text-white text-lg font-semibold">{formatCurrency(metaSpend)}</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">Clicks</p><p className="text-white text-lg font-semibold">{formatNumber(metaClicks)}</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">Impressions</p><p className="text-white text-lg font-semibold">{formatNumber(metaImpressions)}</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">Purchases</p><p className="text-white text-lg font-semibold">{formatNumber(metaPurchases)}</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">CTR</p><p className="text-white text-lg font-semibold">{metaCTR.toFixed(2)}%</p></div>
                    <div><p className="text-slate-400 text-xs mb-1">CPC</p><p className="text-white text-lg font-semibold">{formatCurrency(metaCPC)}</p></div>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    );
  }

  if (view === 'weekly' && selectedWeek && allWeeksData[selectedWeek]) {
    const rawData = allWeeksData[selectedWeek], weeks = Object.keys(allWeeksData).sort().reverse(), idx = weeks.indexOf(selectedWeek);
    
    // Enhance Shopify data with 3PL from ledger if available
    const ledger3PL = get3PLForWeek(threeplLedger, selectedWeek);
    const enhancedShopify = { ...rawData.shopify };
    
    if (ledger3PL && ledger3PL.metrics.totalCost > 0) {
      // Use ledger data for 3PL costs
      enhancedShopify.threeplCosts = ledger3PL.metrics.totalCost;
      enhancedShopify.threeplBreakdown = ledger3PL.breakdown;
      enhancedShopify.threeplMetrics = ledger3PL.metrics;
      
      // Recalculate profit with new 3PL costs
      const oldThreePL = rawData.shopify?.threeplCosts || 0;
      const newThreePL = ledger3PL.metrics.totalCost;
      const profitAdjustment = oldThreePL - newThreePL; // Add back old, subtract new
      enhancedShopify.netProfit = (rawData.shopify?.netProfit || 0) + profitAdjustment;
      enhancedShopify.netMargin = enhancedShopify.revenue > 0 ? (enhancedShopify.netProfit / enhancedShopify.revenue) * 100 : 0;
    }
    
    // Create enhanced data object
    const data = {
      ...rawData,
      shopify: enhancedShopify,
      total: {
        ...rawData.total,
        netProfit: (rawData.amazon?.netProfit || rawData.amazon?.netProceeds || 0) + enhancedShopify.netProfit,
      }
    };
    data.total.netMargin = data.total.revenue > 0 ? (data.total.netProfit / data.total.revenue) * 100 : 0;
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          {/* Edit Ad Spend Modal */}
          {showEditAdSpend && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
              <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full">
                <h2 className="text-xl font-bold text-white mb-2">Edit Ad Spend</h2>
                <p className="text-slate-400 text-sm mb-4">Week ending {new Date(selectedWeek+'T00:00:00').toLocaleDateString()}</p>
                
                <div className="space-y-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2 flex items-center gap-2">
                      <span className="w-3 h-3 rounded-full bg-blue-500"></span>Meta Ads (Facebook/Instagram)
                    </label>
                    <div className="relative">
                      <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                      <input type="number" id="edit-ad-meta" defaultValue={editAdSpend.meta} placeholder="0.00" className="w-full bg-slate-900 border border-slate-600 rounded-xl pl-8 pr-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2 flex items-center gap-2">
                      <span className="w-3 h-3 rounded-full bg-red-500"></span>Google Ads
                    </label>
                    <div className="relative">
                      <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                      <input type="number" id="edit-ad-google" defaultValue={editAdSpend.google} placeholder="0.00" className="w-full bg-slate-900 border border-slate-600 rounded-xl pl-8 pr-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                    </div>
                  </div>
                </div>
                
                {/* Total Summary */}
                <div className="bg-slate-900/50 rounded-xl p-3 mb-6">
                  <div className="flex justify-between items-center">
                    <span className="text-slate-400">Total Ad Spend</span>
                    <span className="text-white font-bold text-lg">{formatCurrency((parseFloat(editAdSpend.meta) || 0) + (parseFloat(editAdSpend.google) || 0))}</span>
                  </div>
                </div>
                
                <p className="text-slate-500 text-xs mb-4">ðŸ’¡ Tip: Amazon ad spend is included automatically from SKU Economics report</p>
                
                <div className="flex gap-3">
                  <button onClick={() => {
                    const meta = document.getElementById('edit-ad-meta')?.value || '0';
                    const google = document.getElementById('edit-ad-google')?.value || '0';
                    updateWeekAdSpend(selectedWeek, meta, google);
                  }} className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-2 rounded-xl">Save</button>
                  <button onClick={() => setShowEditAdSpend(false)} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-xl">Cancel</button>
                </div>
              </div>
            </div>
          )}
          {/* Edit 3PL Costs Modal */}
          {showEdit3PL && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
              <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full">
                <h2 className="text-xl font-bold text-white mb-4">Edit 3PL / Fulfillment Costs</h2>
                <p className="text-slate-400 text-sm mb-4">Week ending {new Date(selectedWeek+'T00:00:00').toLocaleDateString()}</p>
                
                {/* Option 1: Upload 3PL File */}
                <div className="mb-4">
                  <label className="block text-sm font-medium text-slate-300 mb-2">Option 1: Upload 3PL Invoice</label>
                  <div className={`relative border-2 border-dashed rounded-xl p-4 ${reprocessFiles.threepl ? 'border-teal-400 bg-teal-950/30' : 'border-slate-600 bg-slate-800/30'}`}>
                    <input type="file" accept=".csv" onChange={(e) => {
                      const file = e.target.files[0];
                      if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                          const parsed = parseCSV(ev.target.result);
                          setReprocessFiles(p => ({ ...p, threepl: parsed }));
                          setReprocessFileNames(p => ({ ...p, threepl: file.name }));
                          // Auto-calculate cost from file
                          const threeplData = parse3PLData(parsed);
                          setEdit3PLCost(threeplData.metrics.totalCost.toString());
                        };
                        reader.readAsText(file);
                      }
                    }} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                    <div className="flex flex-col items-center gap-2">
                      {reprocessFiles.threepl ? <Check className="w-6 h-6 text-teal-400" /> : <Upload className="w-6 h-6 text-slate-400" />}
                      <span className={reprocessFiles.threepl ? 'text-teal-400 text-sm' : 'text-slate-400 text-sm'}>
                        {reprocessFileNames.threepl || 'Click to upload 3PL CSV'}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div className="flex items-center gap-3 mb-4">
                  <div className="flex-1 h-px bg-slate-700" />
                  <span className="text-slate-500 text-sm">OR</span>
                  <div className="flex-1 h-px bg-slate-700" />
                </div>
                
                {/* Option 2: Enter Amount Manually */}
                <div className="mb-6">
                  <label className="block text-sm font-medium text-slate-300 mb-2">Option 2: Enter Total Manually</label>
                  <input type="number" id="edit-3pl-cost" defaultValue={edit3PLCost} placeholder="0.00" className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                  <p className="text-slate-500 text-xs mt-2">Total fulfillment costs (shipping, pick & pack, storage, etc.)</p>
                </div>
                
                <div className="flex gap-3">
                  <button onClick={() => {
                    const cost = document.getElementById('edit-3pl-cost')?.value || '0';
                    updateWeek3PL(selectedWeek, cost);
                    setReprocessFiles(p => ({ ...p, threepl: null }));
                    setReprocessFileNames(p => ({ ...p, threepl: '' }));
                  }} className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-2 rounded-xl">Save</button>
                  <button onClick={() => {
                    setShowEdit3PL(false);
                    setReprocessFiles(p => ({ ...p, threepl: null }));
                    setReprocessFileNames(p => ({ ...p, threepl: '' }));
                  }} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-xl">Cancel</button>
                </div>
              </div>
            </div>
          )}
          {/* Reprocess Modal */}
          {showReprocess && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
              <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <h2 className="text-xl font-bold text-white mb-2">Re-process Week</h2>
                <p className="text-slate-400 text-sm mb-4">Week ending {new Date(selectedWeek+'T00:00:00').toLocaleDateString()} - Upload files to add SKU detail</p>
                <div className="space-y-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">Amazon Report <span className="text-rose-400">*</span></label>
                    <div className={`relative border-2 border-dashed rounded-xl p-3 ${reprocessFiles.amazon ? 'border-emerald-400 bg-emerald-950/30' : 'border-slate-600 bg-slate-800/30'}`}>
                      <input type="file" accept=".csv" onChange={(e) => handleReprocessFile('amazon', e.target.files[0])} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                      <div className="flex items-center gap-2">
                        {reprocessFiles.amazon ? <Check className="w-4 h-4 text-emerald-400" /> : <FileSpreadsheet className="w-4 h-4 text-slate-400" />}
                        <span className={reprocessFiles.amazon ? 'text-emerald-400 text-sm' : 'text-slate-400 text-sm'}>{reprocessFileNames.amazon || 'Click to upload'}</span>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">Shopify Sales <span className="text-rose-400">*</span></label>
                    <div className={`relative border-2 border-dashed rounded-xl p-3 ${reprocessFiles.shopify ? 'border-emerald-400 bg-emerald-950/30' : 'border-slate-600 bg-slate-800/30'}`}>
                      <input type="file" accept=".csv" onChange={(e) => handleReprocessFile('shopify', e.target.files[0])} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                      <div className="flex items-center gap-2">
                        {reprocessFiles.shopify ? <Check className="w-4 h-4 text-emerald-400" /> : <FileSpreadsheet className="w-4 h-4 text-slate-400" />}
                        <span className={reprocessFiles.shopify ? 'text-emerald-400 text-sm' : 'text-slate-400 text-sm'}>{reprocessFileNames.shopify || 'Click to upload'}</span>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">3PL Costs (Optional)</label>
                    <div className={`relative border-2 border-dashed rounded-xl p-3 ${reprocessFiles.threepl ? 'border-emerald-400 bg-emerald-950/30' : 'border-slate-600 bg-slate-800/30'}`}>
                      <input type="file" accept=".csv,.xlsx,.xls" onChange={(e) => handleReprocessFile('threepl', e.target.files[0])} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                      <div className="flex items-center gap-2">
                        {reprocessFiles.threepl ? <Check className="w-4 h-4 text-emerald-400" /> : <FileSpreadsheet className="w-4 h-4 text-slate-400" />}
                        <span className={reprocessFiles.threepl ? 'text-emerald-400 text-sm' : 'text-slate-400 text-sm'}>{reprocessFileNames.threepl || 'Click to upload (.csv or .xlsx)'}</span>
                      </div>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm text-slate-400 mb-2">Meta Ads</label><input type="number" id="reprocess-meta-ad" defaultValue={reprocessAdSpend.meta} placeholder="0.00" className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-violet-500" /></div>
                    <div><label className="block text-sm text-slate-400 mb-2">Google Ads</label><input type="number" id="reprocess-google-ad" defaultValue={reprocessAdSpend.google} placeholder="0.00" className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-violet-500" /></div>
                  </div>
                </div>
                <div className="flex gap-3">
                  <button onClick={() => {
                    const meta = document.getElementById('reprocess-meta-ad')?.value || '';
                    const google = document.getElementById('reprocess-google-ad')?.value || '';
                    setReprocessAdSpend({ meta, google });
                    setTimeout(() => reprocessWeek(selectedWeek), 10);
                  }} disabled={!reprocessFiles.amazon || !reprocessFiles.shopify} className="flex-1 bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 text-white font-semibold py-2 rounded-xl">Re-process</button>
                  <button onClick={() => { setShowReprocess(false); setReprocessFiles({ amazon: null, shopify: null, threepl: null }); setReprocessFileNames({ amazon: '', shopify: '', threepl: '' }); setReprocessAdSpend({ meta: '', google: '' }); }} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-xl">Cancel</button>
                </div>
              </div>
            </div>
          )}
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <div className="flex items-center gap-4">
              {storeLogo && (
                <img src={storeLogo} alt="Store logo" className="w-12 h-12 object-contain rounded-xl bg-white p-1.5" />
              )}
              <div><h1 className="text-2xl lg:text-3xl font-bold text-white">{storeName ? storeName + ' Dashboard' : 'Weekly Performance'}</h1><p className="text-slate-400">Week ending {new Date(selectedWeek+'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p></div>
            </div>
            <div className="flex gap-2">
              <button onClick={() => { setReprocessAdSpend({ meta: data.shopify.metaSpend || '', google: data.shopify.googleSpend || '' }); setShowReprocess(true); }} className="bg-violet-900/50 hover:bg-violet-800/50 border border-violet-600/50 text-violet-300 px-3 py-2 rounded-lg text-sm flex items-center gap-1"><RefreshCw className="w-4 h-4" />Re-process</button>
              <button onClick={() => { setEditAdSpend({ meta: data.shopify.metaSpend || '', google: data.shopify.googleSpend || '' }); setShowEditAdSpend(true); }} className="bg-blue-900/50 hover:bg-blue-800/50 border border-blue-600/50 text-blue-300 px-3 py-2 rounded-lg text-sm flex items-center gap-1"><DollarSign className="w-4 h-4" />Edit Ads</button>
              <button onClick={() => { setEdit3PLCost(data.shopify?.threeplCosts?.toString() || ''); setShowEdit3PL(true); }} className="bg-teal-900/50 hover:bg-teal-800/50 border border-teal-600/50 text-teal-300 px-3 py-2 rounded-lg text-sm flex items-center gap-1"><Truck className="w-4 h-4" />Edit 3PL</button>
              <button onClick={() => deleteWeek(selectedWeek)} className="bg-rose-900/50 hover:bg-rose-800/50 border border-rose-600/50 text-rose-300 px-3 py-2 rounded-lg text-sm"><Trash2 className="w-4 h-4" /></button>
            </div>
          </div>
          <NavTabs />
          <div className="flex items-center gap-4 mb-6">
            <button onClick={() => idx < weeks.length - 1 && setSelectedWeek(weeks[idx + 1])} disabled={idx >= weeks.length - 1} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronLeft className="w-5 h-5" /></button>
            <select value={selectedWeek} onChange={(e) => setSelectedWeek(e.target.value)} className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">{weeks.map(w => <option key={w} value={w}>{new Date(w+'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</option>)}</select>
            <button onClick={() => idx > 0 && setSelectedWeek(weeks[idx - 1])} disabled={idx <= 0} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronRight className="w-5 h-5" /></button>
          </div>
          <div className="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <MetricCard label="Total Revenue" value={formatCurrency(data.total.revenue)} icon={DollarSign} color="emerald" />
            <MetricCard label="Total Units" value={formatNumber(data.total.units)} icon={Package} color="blue" />
            <MetricCard label="Net Profit" value={formatCurrency(data.total.netProfit)} sub={`${formatPercent(data.total.netMargin)} margin`} icon={TrendingUp} color={data.total.netProfit >= 0 ? 'emerald' : 'rose'} />
            <MetricCard label="Ad Spend" value={formatCurrency(data.total.adSpend)} sub={`${(data.total.roas || 0).toFixed(2)}x TACOS`} icon={BarChart3} color="violet" />
            <MetricCard label="COGS" value={formatCurrency(data.total.cogs)} icon={ShoppingCart} color="amber" />
          </div>
          <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5 mb-8">
            <h3 className="text-sm font-semibold text-slate-400 uppercase mb-4">Revenue by Channel</h3>
            <div className="h-4 bg-slate-700 rounded-full overflow-hidden flex mb-3"><div className="bg-orange-500 h-full" style={{ width: `${data.total.amazonShare}%` }} /><div className="bg-blue-500 h-full" style={{ width: `${data.total.shopifyShare}%` }} /></div>
            <div className="flex justify-between text-sm"><div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-orange-500" /><span className="text-slate-300">Amazon</span><span className="text-white font-semibold">{formatPercent(data.total.amazonShare)}</span></div><div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-blue-500" /><span className="text-slate-300">Shopify</span><span className="text-white font-semibold">{formatPercent(data.total.shopifyShare)}</span></div></div>
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><ChannelCard title="Amazon" color="orange" data={data.amazon} isAmz showSkuTable /><ChannelCard title="Shopify" color="blue" data={data.shopify} showSkuTable /></div>
          
          {/* Week Notes */}
          <div className="mt-6 bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
            <h3 className="text-sm font-semibold text-slate-400 uppercase mb-3 flex items-center gap-2"><StickyNote className="w-4 h-4" />Week Notes</h3>
            <WeekNoteEditor weekKey={selectedWeek} />
          </div>
        </div>
      </div>
    );
  }

  if (view === 'monthly') {
    const months = getMonths(), data = selectedMonth ? getMonthlyData(selectedMonth) : null, idx = months.indexOf(selectedMonth);
    if (!data) return <div className="min-h-screen bg-slate-950 text-white p-6 flex items-center justify-center">No data</div>;
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <div className="mb-6"><h1 className="text-2xl lg:text-3xl font-bold text-white">Monthly Performance</h1><p className="text-slate-400">{new Date(selectedMonth+'-01T00:00:00').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} ({data.weeks.length} weeks)</p></div>
          <NavTabs />
          <div className="flex items-center gap-4 mb-6">
            <button onClick={() => idx < months.length - 1 && setSelectedMonth(months[idx + 1])} disabled={idx >= months.length - 1} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronLeft className="w-5 h-5" /></button>
            <select value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">{months.map(m => <option key={m} value={m}>{new Date(m+'-01T00:00:00').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</option>)}</select>
            <button onClick={() => idx > 0 && setSelectedMonth(months[idx - 1])} disabled={idx <= 0} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronRight className="w-5 h-5" /></button>
          </div>
          <div className="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <MetricCard label="Total Revenue" value={formatCurrency(data.total.revenue)} icon={DollarSign} color="emerald" />
            <MetricCard label="Total Units" value={formatNumber(data.total.units)} icon={Package} color="blue" />
            <MetricCard label="Net Profit" value={formatCurrency(data.total.netProfit)} sub={`${formatPercent(data.total.netMargin)} margin`} icon={TrendingUp} color={data.total.netProfit >= 0 ? 'emerald' : 'rose'} />
            <MetricCard label="Ad Spend" value={formatCurrency(data.total.adSpend)} icon={BarChart3} color="violet" />
            <MetricCard label="COGS" value={formatCurrency(data.total.cogs)} icon={ShoppingCart} color="amber" />
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><ChannelCard title="Amazon" color="orange" data={data.amazon} isAmz /><ChannelCard title="Shopify" color="blue" data={data.shopify} /></div>
        </div>
      </div>
    );
  }

  if (view === 'yearly') {
    const years = getYears(), data = selectedYear ? getYearlyData(selectedYear) : null, idx = years.indexOf(selectedYear);
    if (!data) return <div className="min-h-screen bg-slate-950 text-white p-6 flex items-center justify-center">No data</div>;
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <div className="mb-6"><h1 className="text-2xl lg:text-3xl font-bold text-white">Yearly Performance</h1><p className="text-slate-400">{selectedYear} ({data.weeks.length} weeks)</p></div>
          <NavTabs />
          <div className="flex items-center gap-4 mb-6">
            <button onClick={() => idx < years.length - 1 && setSelectedYear(years[idx + 1])} disabled={idx >= years.length - 1} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronLeft className="w-5 h-5" /></button>
            <select value={selectedYear} onChange={(e) => setSelectedYear(Number(e.target.value))} className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">{years.map(y => <option key={y} value={y}>{y}</option>)}</select>
            <button onClick={() => idx > 0 && setSelectedYear(years[idx - 1])} disabled={idx <= 0} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronRight className="w-5 h-5" /></button>
          </div>
          <div className="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <MetricCard label="Total Revenue" value={formatCurrency(data.total.revenue)} icon={DollarSign} color="emerald" />
            <MetricCard label="Total Units" value={formatNumber(data.total.units)} icon={Package} color="blue" />
            <MetricCard label="Net Profit" value={formatCurrency(data.total.netProfit)} sub={`${formatPercent(data.total.netMargin)} margin`} icon={TrendingUp} color={data.total.netProfit >= 0 ? 'emerald' : 'rose'} />
            <MetricCard label="Ad Spend" value={formatCurrency(data.total.adSpend)} icon={BarChart3} color="violet" />
            <MetricCard label="COGS" value={formatCurrency(data.total.cogs)} icon={ShoppingCart} color="amber" />
          </div>
          <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5 mb-8"><h3 className="text-sm font-semibold text-slate-400 uppercase mb-4">Monthly Breakdown</h3>
            <div className="space-y-3">{Object.entries(data.monthlyBreakdown).sort().map(([m, md]) => { const max = Math.max(...Object.values(data.monthlyBreakdown).map(x => x.revenue)) || 1; return (
              <div key={m} className="flex items-center gap-4">
                <span className="w-12 text-sm text-slate-400">{new Date(m+'-01T00:00:00').toLocaleDateString('en-US', { month: 'short' })}</span>
                <div className="flex-1 h-8 bg-slate-700 rounded-lg overflow-hidden relative">
                  <div className={`h-full ${md.netProfit >= 0 ? 'bg-emerald-600' : 'bg-rose-600'}`} style={{ width: `${(md.revenue/max)*100}%` }} />
                  <div className="absolute inset-0 flex items-center justify-between px-3"><span className="text-white text-sm font-medium">{formatCurrency(md.revenue)}</span><span className={`text-sm font-medium ${md.netProfit >= 0 ? 'text-emerald-300' : 'text-rose-300'}`}>{formatCurrency(md.netProfit)}</span></div>
                </div>
              </div>
            );})}</div>
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><ChannelCard title="Amazon" color="orange" data={data.amazon} isAmz /><ChannelCard title="Shopify" color="blue" data={data.shopify} /></div>
        </div>
      </div>
    );
  }

  // Period View
  if (view === 'period-view' && selectedPeriod && allPeriodsData[selectedPeriod]) {
    const data = allPeriodsData[selectedPeriod], periods = Object.keys(allPeriodsData).sort().reverse(), idx = periods.indexOf(selectedPeriod);
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          {/* Period Reprocess Modal */}
          {reprocessPeriod && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
              <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full">
                <h2 className="text-xl font-bold text-white mb-2">Update Period: {allPeriodsData[reprocessPeriod]?.label}</h2>
                <p className="text-slate-400 text-sm mb-4">Add or update 3PL costs and ad spend for this period</p>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-slate-300 mb-2">3PL Cost Files (click multiple times to add)</label>
                    <div className={`relative border-2 border-dashed rounded-xl p-4 ${periodFiles.threepl?.length > 0 ? 'border-emerald-400 bg-emerald-950/30' : 'border-slate-600 hover:border-slate-400 bg-slate-800/30'}`}>
                      <input type="file" accept=".csv,.xlsx,.xls" onChange={(e) => handlePeriodFile('threepl', e.target.files[0])} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                      <div className="text-center">
                        {periodFileNames.threepl?.length > 0 ? (
                          <div>
                            <p className="text-emerald-400 text-sm">{periodFileNames.threepl.length} file(s) selected</p>
                            {periodFileNames.threepl.map((n, i) => <p key={i} className="text-xs text-slate-400 truncate">â€¢ {n}</p>)}
                            <button onClick={(e) => { e.stopPropagation(); clearPeriod3PLFiles(); }} className="text-xs text-rose-400 mt-2">Clear all</button>
                          </div>
                        ) : (
                          <p className="text-slate-500 text-sm">Click to add 3PL files (.csv or .xlsx)</p>
                        )}
                      </div>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-slate-300 mb-1">Meta Ad Spend</label>
                      <input type="number" value={periodAdSpend.meta} onChange={(e) => setPeriodAdSpend(p => ({ ...p, meta: e.target.value }))} placeholder={String(allPeriodsData[reprocessPeriod]?.shopify?.metaSpend || 0)} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white" />
                    </div>
                    <div>
                      <label className="block text-sm text-slate-300 mb-1">Google Ad Spend</label>
                      <input type="number" value={periodAdSpend.google} onChange={(e) => setPeriodAdSpend(p => ({ ...p, google: e.target.value }))} placeholder={String(allPeriodsData[reprocessPeriod]?.shopify?.googleSpend || 0)} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white" />
                    </div>
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button onClick={() => {
                    const existing = allPeriodsData[reprocessPeriod];
                    if (!existing) return;
                    
                    // Use enhanced 3PL parser for full metrics
                    let newThreeplCost = existing.shopify?.threeplCosts || 0;
                    let newBreakdown = existing.shopify?.threeplBreakdown || { storage: 0, shipping: 0, pickFees: 0, boxCharges: 0, receiving: 0, other: 0 };
                    let newMetrics = existing.shopify?.threeplMetrics || null;
                    
                    if (periodFiles.threepl?.length > 0) {
                      const threeplData = parse3PLData(periodFiles.threepl);
                      newThreeplCost = threeplData.metrics.totalCost;
                      newBreakdown = threeplData.breakdown;
                      newMetrics = threeplData.metrics;
                    }
                    
                    // Update ad spend if provided
                    const newMeta = periodAdSpend.meta ? parseFloat(periodAdSpend.meta) : (existing.shopify?.metaSpend || 0);
                    const newGoogle = periodAdSpend.google ? parseFloat(periodAdSpend.google) : (existing.shopify?.googleSpend || 0);
                    const newShopAds = newMeta + newGoogle;
                    
                    // Recalculate profit
                    const shopRev = existing.shopify?.revenue || 0;
                    const shopCogs = existing.shopify?.cogs || 0;
                    const newShopProfit = shopRev - shopCogs - newThreeplCost - newShopAds;
                    const amzProfit = existing.amazon?.netProfit || 0;
                    const totalRev = existing.total?.revenue || 0;
                    const newTotalProfit = amzProfit + newShopProfit;
                    
                    const updated = {
                      ...allPeriodsData,
                      [reprocessPeriod]: {
                        ...existing,
                        shopify: {
                          ...existing.shopify,
                          threeplCosts: newThreeplCost,
                          threeplBreakdown: newBreakdown,
                          threeplMetrics: newMetrics,
                          metaSpend: newMeta,
                          googleSpend: newGoogle,
                          adSpend: newShopAds,
                          netProfit: newShopProfit,
                          netMargin: shopRev > 0 ? (newShopProfit / shopRev) * 100 : 0,
                        },
                        total: {
                          ...existing.total,
                          adSpend: (existing.amazon?.adSpend || 0) + newShopAds,
                          netProfit: newTotalProfit,
                          netMargin: totalRev > 0 ? (newTotalProfit / totalRev) * 100 : 0,
                        }
                      }
                    };
                    setAllPeriodsData(updated);
                    savePeriods(updated);
                    setReprocessPeriod(null);
                    setPeriodFiles(p => ({ ...p, threepl: [] }));
                    setPeriodFileNames(p => ({ ...p, threepl: [] }));
                    setPeriodAdSpend({ meta: '', google: '' });
                  }} className="flex-1 bg-teal-600 hover:bg-teal-500 text-white font-semibold py-2 rounded-xl">Update Period</button>
                  <button onClick={() => { setReprocessPeriod(null); clearPeriod3PLFiles(); setPeriodAdSpend({ meta: '', google: '' }); }} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-xl">Cancel</button>
                </div>
              </div>
            </div>
          )}
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <div><h1 className="text-2xl lg:text-3xl font-bold text-white">{data.label}</h1><p className="text-slate-400">Period Performance</p></div>
            <div className="flex gap-2">
              <button onClick={() => setReprocessPeriod(selectedPeriod)} className="bg-cyan-700 hover:bg-cyan-600 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-1"><RefreshCw className="w-4 h-4" />Update 3PL/Ads</button>
              <button onClick={() => { setUploadTab('period'); setView('upload'); }} className="bg-teal-700 hover:bg-teal-600 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-1"><Upload className="w-4 h-4" />New</button>
              <button onClick={() => deletePeriod(selectedPeriod)} className="bg-rose-900/50 hover:bg-rose-800/50 border border-rose-600/50 text-rose-300 px-3 py-2 rounded-lg text-sm"><Trash2 className="w-4 h-4" /></button>
            </div>
          </div>
          <NavTabs />
          {periods.length > 1 && (
            <div className="flex items-center gap-4 mb-6">
              <button onClick={() => idx < periods.length - 1 && setSelectedPeriod(periods[idx + 1])} disabled={idx >= periods.length - 1} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronLeft className="w-5 h-5" /></button>
              <select value={selectedPeriod} onChange={(e) => setSelectedPeriod(e.target.value)} className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">{periods.map(p => <option key={p} value={p}>{allPeriodsData[p]?.label || p}</option>)}</select>
              <button onClick={() => idx > 0 && setSelectedPeriod(periods[idx - 1])} disabled={idx <= 0} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronRight className="w-5 h-5" /></button>
            </div>
          )}
          <div className="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <MetricCard label="Total Revenue" value={formatCurrency(data.total.revenue)} icon={DollarSign} color="emerald" />
            <MetricCard label="Total Units" value={formatNumber(data.total.units)} icon={Package} color="blue" />
            <MetricCard label="Net Profit" value={formatCurrency(data.total.netProfit)} sub={`${formatPercent(data.total.netMargin)} margin`} icon={TrendingUp} color={data.total.netProfit >= 0 ? 'emerald' : 'rose'} />
            <MetricCard label="Ad Spend" value={formatCurrency(data.total.adSpend)} sub={`${(data.total.roas || 0).toFixed(2)}x TACOS`} icon={BarChart3} color="violet" />
            <MetricCard label="COGS" value={formatCurrency(data.total.cogs)} icon={ShoppingCart} color="amber" />
          </div>
          <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5 mb-6">
            <h3 className="text-sm font-semibold text-slate-400 uppercase mb-4">Revenue by Channel</h3>
            <div className="h-4 bg-slate-700 rounded-full overflow-hidden flex mb-3"><div className="bg-orange-500 h-full" style={{ width: `${data.total.amazonShare}%` }} /><div className="bg-blue-500 h-full" style={{ width: `${data.total.shopifyShare}%` }} /></div>
            <div className="flex justify-between text-sm"><div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-orange-500" /><span className="text-slate-300">Amazon</span><span className="text-white font-semibold">{formatPercent(data.total.amazonShare)}</span></div><div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-blue-500" /><span className="text-slate-300">Shopify</span><span className="text-white font-semibold">{formatPercent(data.total.shopifyShare)}</span></div></div>
          </div>
          
          {/* Period Analytics Quick Access Buttons */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <button onClick={() => setPeriodAnalyticsView(periodAnalyticsView === 'skus' ? null : 'skus')} className={`p-3 rounded-xl border text-left transition-all ${periodAnalyticsView === 'skus' ? 'bg-pink-600/20 border-pink-500/50' : 'bg-slate-800/50 border-slate-700 hover:border-slate-500'}`}>
              <Trophy className={`w-5 h-5 mb-1 ${periodAnalyticsView === 'skus' ? 'text-pink-400' : 'text-slate-400'}`} />
              <p className={`text-sm font-medium ${periodAnalyticsView === 'skus' ? 'text-pink-300' : 'text-white'}`}>SKU Rankings</p>
              <p className="text-xs text-slate-500">{(data.amazon?.skuData?.length || 0) + (data.shopify?.skuData?.length || 0)} products</p>
            </button>
            <button onClick={() => setPeriodAnalyticsView(periodAnalyticsView === 'profit' ? null : 'profit')} className={`p-3 rounded-xl border text-left transition-all ${periodAnalyticsView === 'profit' ? 'bg-emerald-600/20 border-emerald-500/50' : 'bg-slate-800/50 border-slate-700 hover:border-slate-500'}`}>
              <PieChart className={`w-5 h-5 mb-1 ${periodAnalyticsView === 'profit' ? 'text-emerald-400' : 'text-slate-400'}`} />
              <p className={`text-sm font-medium ${periodAnalyticsView === 'profit' ? 'text-emerald-300' : 'text-white'}`}>Profitability</p>
              <p className="text-xs text-slate-500">{formatPercent(data.total.netMargin)} margin</p>
            </button>
            <button onClick={() => setPeriodAnalyticsView(periodAnalyticsView === 'ads' ? null : 'ads')} className={`p-3 rounded-xl border text-left transition-all ${periodAnalyticsView === 'ads' ? 'bg-purple-600/20 border-purple-500/50' : 'bg-slate-800/50 border-slate-700 hover:border-slate-500'}`}>
              <Zap className={`w-5 h-5 mb-1 ${periodAnalyticsView === 'ads' ? 'text-purple-400' : 'text-slate-400'}`} />
              <p className={`text-sm font-medium ${periodAnalyticsView === 'ads' ? 'text-purple-300' : 'text-white'}`}>Ad Performance</p>
              <p className="text-xs text-slate-500">{formatCurrency(data.total.adSpend)} spent</p>
            </button>
            <button onClick={() => setPeriodAnalyticsView(periodAnalyticsView === '3pl' ? null : '3pl')} className={`p-3 rounded-xl border text-left transition-all ${periodAnalyticsView === '3pl' ? 'bg-blue-600/20 border-blue-500/50' : 'bg-slate-800/50 border-slate-700 hover:border-slate-500'}`}>
              <Truck className={`w-5 h-5 mb-1 ${periodAnalyticsView === '3pl' ? 'text-blue-400' : 'text-slate-400'}`} />
              <p className={`text-sm font-medium ${periodAnalyticsView === '3pl' ? 'text-blue-300' : 'text-white'}`}>3PL Costs</p>
              <p className="text-xs text-slate-500">{formatCurrency(data.shopify?.threeplCosts || 0)}</p>
            </button>
          </div>
          
          {/* SKU Rankings Panel */}
          {periodAnalyticsView === 'skus' && (
            <div className="bg-slate-800/50 rounded-2xl border border-pink-500/30 p-5 mb-6">
              <h3 className="text-lg font-semibold text-pink-400 mb-4 flex items-center gap-2"><Trophy className="w-5 h-5" />SKU Rankings - {data.label}</h3>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <h4 className="text-sm font-semibold text-orange-400 mb-3">Amazon Top SKUs</h4>
                  {data.amazon?.skuData?.length > 0 ? (
                    <div className="space-y-2 max-h-64 overflow-y-auto">{data.amazon.skuData.slice(0, 10).map((sku, i) => (<div key={sku.sku} className="flex items-center gap-3 p-2 bg-slate-900/50 rounded-lg"><span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${i === 0 ? 'bg-amber-500 text-black' : i === 1 ? 'bg-slate-400 text-black' : i === 2 ? 'bg-amber-700 text-white' : 'bg-slate-700 text-white'}`}>{i + 1}</span><div className="flex-1 min-w-0"><p className="text-white text-sm truncate">{sku.sku}</p><p className="text-slate-500 text-xs">{formatNumber(sku.unitsSold)} units</p></div><p className="text-emerald-400 font-semibold">{formatCurrency(sku.netSales)}</p></div>))}</div>
                  ) : <p className="text-slate-500 text-sm">No SKU data</p>}
                </div>
                <div>
                  <h4 className="text-sm font-semibold text-blue-400 mb-3">Shopify Top SKUs</h4>
                  {data.shopify?.skuData?.length > 0 ? (
                    <div className="space-y-2 max-h-64 overflow-y-auto">{data.shopify.skuData.slice(0, 10).map((sku, i) => (<div key={sku.sku} className="flex items-center gap-3 p-2 bg-slate-900/50 rounded-lg"><span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${i === 0 ? 'bg-amber-500 text-black' : i === 1 ? 'bg-slate-400 text-black' : i === 2 ? 'bg-amber-700 text-white' : 'bg-slate-700 text-white'}`}>{i + 1}</span><div className="flex-1 min-w-0"><p className="text-white text-sm truncate">{sku.sku}</p><p className="text-slate-500 text-xs">{formatNumber(sku.unitsSold)} units</p></div><p className="text-emerald-400 font-semibold">{formatCurrency(sku.netSales)}</p></div>))}</div>
                  ) : <p className="text-slate-500 text-sm">No SKU data</p>}
                </div>
              </div>
            </div>
          )}
          
          {/* Profitability Panel */}
          {periodAnalyticsView === 'profit' && (
            <div className="bg-slate-800/50 rounded-2xl border border-emerald-500/30 p-5 mb-6">
              <h3 className="text-lg font-semibold text-emerald-400 mb-4 flex items-center gap-2"><PieChart className="w-5 h-5" />Profitability - {data.label}</h3>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div><h4 className="text-sm font-semibold text-slate-300 mb-3">Profit Waterfall</h4><div className="space-y-2"><div className="flex justify-between items-center p-2 bg-emerald-900/30 rounded-lg"><span className="text-slate-300">Revenue</span><span className="text-emerald-400 font-semibold">{formatCurrency(data.total.revenue)}</span></div><div className="flex justify-between items-center p-2 bg-rose-900/30 rounded-lg"><span className="text-slate-300">âˆ’ COGS</span><span className="text-rose-400">({formatCurrency(data.total.cogs)})</span></div><div className="flex justify-between items-center p-2 bg-rose-900/30 rounded-lg"><span className="text-slate-300">âˆ’ Amazon Fees</span><span className="text-rose-400">({formatCurrency(data.amazon?.fees || 0)})</span></div><div className="flex justify-between items-center p-2 bg-rose-900/30 rounded-lg"><span className="text-slate-300">âˆ’ 3PL Costs</span><span className="text-rose-400">({formatCurrency(data.shopify?.threeplCosts || 0)})</span></div><div className="flex justify-between items-center p-2 bg-rose-900/30 rounded-lg"><span className="text-slate-300">âˆ’ Ad Spend</span><span className="text-rose-400">({formatCurrency(data.total.adSpend)})</span></div><div className="flex justify-between items-center p-2 bg-slate-700 rounded-lg border-2 border-emerald-500/50"><span className="text-white font-semibold">Net Profit</span><span className={`font-bold ${data.total.netProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(data.total.netProfit)}</span></div></div></div>
                <div><h4 className="text-sm font-semibold text-slate-300 mb-3">Cost Breakdown</h4><div className="space-y-3"><div><div className="flex justify-between text-sm mb-1"><span className="text-slate-400">COGS</span><span className="text-white">{formatPercent(data.total.revenue > 0 ? (data.total.cogs / data.total.revenue) * 100 : 0)}</span></div><div className="h-2 bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-amber-500" style={{ width: `${Math.min(100, data.total.revenue > 0 ? (data.total.cogs / data.total.revenue) * 100 : 0)}%` }} /></div></div><div><div className="flex justify-between text-sm mb-1"><span className="text-slate-400">Fees & Fulfillment</span><span className="text-white">{formatPercent(data.total.revenue > 0 ? (((data.amazon?.fees || 0) + (data.shopify?.threeplCosts || 0)) / data.total.revenue) * 100 : 0)}</span></div><div className="h-2 bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-blue-500" style={{ width: `${Math.min(100, data.total.revenue > 0 ? (((data.amazon?.fees || 0) + (data.shopify?.threeplCosts || 0)) / data.total.revenue) * 100 : 0)}%` }} /></div></div><div><div className="flex justify-between text-sm mb-1"><span className="text-slate-400">Advertising</span><span className="text-white">{formatPercent(data.total.revenue > 0 ? (data.total.adSpend / data.total.revenue) * 100 : 0)}</span></div><div className="h-2 bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-purple-500" style={{ width: `${Math.min(100, data.total.revenue > 0 ? (data.total.adSpend / data.total.revenue) * 100 : 0)}%` }} /></div></div><div><div className="flex justify-between text-sm mb-1"><span className="text-slate-400">Net Margin</span><span className={data.total.netMargin >= 0 ? 'text-emerald-400' : 'text-rose-400'}>{formatPercent(data.total.netMargin)}</span></div><div className="h-2 bg-slate-700 rounded-full overflow-hidden"><div className={`h-full ${data.total.netMargin >= 0 ? 'bg-emerald-500' : 'bg-rose-500'}`} style={{ width: `${Math.min(100, Math.abs(data.total.netMargin))}%` }} /></div></div></div></div>
              </div>
            </div>
          )}
          
          {/* Ads Panel */}
          {periodAnalyticsView === 'ads' && (
            <div className="bg-slate-800/50 rounded-2xl border border-purple-500/30 p-5 mb-6">
              <h3 className="text-lg font-semibold text-purple-400 mb-4 flex items-center gap-2"><Zap className="w-5 h-5" />Ad Performance - {data.label}</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"><div className="bg-slate-900/50 rounded-lg p-3"><p className="text-slate-500 text-xs">Total Ad Spend</p><p className="text-white text-xl font-bold">{formatCurrency(data.total.adSpend)}</p></div><div className="bg-slate-900/50 rounded-lg p-3"><p className="text-slate-500 text-xs">TACOS</p><p className={`text-xl font-bold ${data.total.revenue > 0 && (data.total.adSpend / data.total.revenue) * 100 <= 15 ? 'text-emerald-400' : 'text-amber-400'}`}>{data.total.revenue > 0 ? ((data.total.adSpend / data.total.revenue) * 100).toFixed(1) : 0}%</p></div><div className="bg-slate-900/50 rounded-lg p-3"><p className="text-slate-500 text-xs">Amazon Ads</p><p className="text-orange-400 text-xl font-bold">{formatCurrency(data.amazon?.adSpend || 0)}</p></div><div className="bg-slate-900/50 rounded-lg p-3"><p className="text-slate-500 text-xs">Shopify Ads</p><p className="text-blue-400 text-xl font-bold">{formatCurrency(data.shopify?.adSpend || 0)}</p></div></div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="bg-orange-900/20 rounded-lg p-4 border border-orange-500/30"><h4 className="text-orange-400 font-semibold mb-2">Amazon</h4><div className="space-y-1 text-sm"><div className="flex justify-between"><span className="text-slate-400">Sponsored Products</span><span className="text-white">{formatCurrency(data.amazon?.adSpend || 0)}</span></div><div className="flex justify-between"><span className="text-slate-400">TACOS</span><span className="text-white">{data.amazon?.revenue > 0 ? ((data.amazon.adSpend / data.amazon.revenue) * 100).toFixed(1) : 0}%</span></div></div></div><div className="bg-blue-900/20 rounded-lg p-4 border border-blue-500/30"><h4 className="text-blue-400 font-semibold mb-2">Shopify</h4><div className="space-y-1 text-sm"><div className="flex justify-between"><span className="text-slate-400">Meta Ads</span><span className="text-white">{formatCurrency(data.shopify?.metaSpend || 0)}</span></div><div className="flex justify-between"><span className="text-slate-400">Google Ads</span><span className="text-white">{formatCurrency(data.shopify?.googleSpend || 0)}</span></div><div className="flex justify-between"><span className="text-slate-400">TACOS</span><span className="text-white">{data.shopify?.revenue > 0 ? ((data.shopify.adSpend / data.shopify.revenue) * 100).toFixed(1) : 0}%</span></div></div></div></div>
            </div>
          )}
          
          {/* 3PL Panel */}
          {periodAnalyticsView === '3pl' && (
            <div className="bg-slate-800/50 rounded-2xl border border-blue-500/30 p-5 mb-6">
              <h3 className="text-lg font-semibold text-blue-400 mb-4 flex items-center gap-2"><Truck className="w-5 h-5" />3PL Fulfillment - {data.label}</h3>
              {data.shopify?.threeplCosts > 0 ? (<><div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"><div className="bg-slate-900/50 rounded-lg p-3"><p className="text-slate-500 text-xs">Total 3PL</p><p className="text-white text-xl font-bold">{formatCurrency(data.shopify.threeplCosts)}</p></div><div className="bg-slate-900/50 rounded-lg p-3"><p className="text-slate-500 text-xs">% of Revenue</p><p className="text-white text-xl font-bold">{data.shopify.revenue > 0 ? ((data.shopify.threeplCosts / data.shopify.revenue) * 100).toFixed(1) : 0}%</p></div>{data.shopify.threeplMetrics?.orderCount > 0 && (<><div className="bg-cyan-900/30 rounded-lg p-3 border border-cyan-500/30"><p className="text-cyan-400 text-xs">Orders</p><p className="text-cyan-300 text-xl font-bold">{formatNumber(data.shopify.threeplMetrics.orderCount)}</p></div><div className="bg-cyan-900/30 rounded-lg p-3 border border-cyan-500/30"><p className="text-cyan-400 text-xs">Avg Cost/Order</p><p className="text-cyan-300 text-xl font-bold">{formatCurrency(data.shopify.threeplMetrics.avgCostPerOrder)}</p></div></>)}</div>{data.shopify.threeplBreakdown && (<div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-4">{data.shopify.threeplBreakdown.shipping > 0 && <div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Shipping</p><p className="text-blue-400 font-semibold">{formatCurrency(data.shopify.threeplBreakdown.shipping)}</p></div>}{data.shopify.threeplBreakdown.pickFees > 0 && <div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Pick Fees</p><p className="text-emerald-400 font-semibold">{formatCurrency(data.shopify.threeplBreakdown.pickFees)}</p></div>}{data.shopify.threeplBreakdown.storage > 0 && <div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Storage</p><p className="text-violet-400 font-semibold">{formatCurrency(data.shopify.threeplBreakdown.storage)}</p></div>}{data.shopify.threeplBreakdown.boxCharges > 0 && <div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Packaging</p><p className="text-amber-400 font-semibold">{formatCurrency(data.shopify.threeplBreakdown.boxCharges)}</p></div>}{data.shopify.threeplBreakdown.receiving > 0 && <div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Receiving</p><p className="text-slate-300 font-semibold">{formatCurrency(data.shopify.threeplBreakdown.receiving)}</p></div>}{data.shopify.threeplBreakdown.other > 0 && <div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Other</p><p className="text-slate-300 font-semibold">{formatCurrency(data.shopify.threeplBreakdown.other)}</p></div>}</div>)}{data.shopify.threeplMetrics?.orderCount > 0 && (<div className="border-t border-slate-700 pt-4"><h4 className="text-sm font-semibold text-cyan-400 mb-3">ðŸ“¦ Order Metrics</h4><div className="grid grid-cols-2 md:grid-cols-4 gap-3"><div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Units Picked</p><p className="text-white font-semibold">{formatNumber(data.shopify.threeplMetrics.totalUnits)}</p></div><div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Avg Units/Order</p><p className="text-white font-semibold">{data.shopify.threeplMetrics.avgUnitsPerOrder?.toFixed(1) || 'â€”'}</p></div><div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Avg Ship Cost</p><p className="text-white font-semibold">{formatCurrency(data.shopify.threeplMetrics.avgShippingCost)}</p></div><div className="bg-slate-900/50 rounded-lg p-2"><p className="text-slate-500 text-xs">Avg Pick Cost</p><p className="text-white font-semibold">{formatCurrency(data.shopify.threeplMetrics.avgPickCost)}</p></div></div></div>)}</>) : (<div className="text-center py-6"><Truck className="w-12 h-12 text-slate-600 mx-auto mb-3" /><p className="text-slate-400">No 3PL data for this period</p><p className="text-slate-500 text-sm mt-1">Click "Update 3PL/Ads" to add 3PL cost files</p></div>)}
            </div>
          )}
          
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><ChannelCard title="Amazon" color="orange" data={data.amazon} isAmz showSkuTable /><ChannelCard title="Shopify" color="blue" data={data.shopify} showSkuTable /></div>
        </div>
      </div>
    );
  }

  // Inventory Dashboard View
  if (view === 'inventory' && selectedInvDate && invHistory[selectedInvDate]) {
    const dates = Object.keys(invHistory).sort().reverse();
    const data = invHistory[selectedInvDate];
    const idx = dates.indexOf(selectedInvDate);
    
    // Defensive defaults for summary
    const summary = data.summary || {
      totalUnits: 0, totalValue: 0, amazonUnits: 0, amazonValue: 0, 
      amazonInbound: 0, threeplUnits: 0, threeplValue: 0, threeplInbound: 0,
      critical: 0, low: 0, healthy: 0, overstock: 0, skuCount: 0
    };
    const items = data.items || [];
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <div><h1 className="text-2xl lg:text-3xl font-bold text-white">Inventory</h1><p className="text-slate-400">{new Date(selectedInvDate+'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p></div>
            <div className="flex gap-2">
              <button onClick={() => { setUploadTab('inventory'); setView('upload'); }} className="bg-emerald-700 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm"><RefreshCw className="w-4 h-4 inline mr-1" />New</button>
              <button onClick={() => deleteInv(selectedInvDate)} className="bg-rose-900/50 hover:bg-rose-800/50 text-rose-300 px-3 py-2 rounded-lg text-sm"><Trash2 className="w-4 h-4" /></button>
            </div>
          </div>
          <NavTabs />
          {dates.length > 1 && (
            <div className="flex items-center gap-4 mb-6">
              <button onClick={() => idx < dates.length - 1 && setSelectedInvDate(dates[idx + 1])} disabled={idx >= dates.length - 1} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronLeft className="w-5 h-5" /></button>
              <select value={selectedInvDate} onChange={(e) => setSelectedInvDate(e.target.value)} className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white">{dates.map(d => <option key={d} value={d}>{new Date(d+'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</option>)}</select>
              <button onClick={() => idx > 0 && setSelectedInvDate(dates[idx - 1])} disabled={idx <= 0} className="p-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 rounded-lg"><ChevronRight className="w-5 h-5" /></button>
            </div>
          )}
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <MetricCard label="Total Units" value={formatNumber(summary.totalUnits)} sub={summary.skuCount + ' SKUs'} icon={Package} color="blue" />
            <MetricCard label="Total Value" value={formatCurrency(summary.totalValue)} icon={DollarSign} color="emerald" />
            <MetricCard label="Amazon FBA" value={formatNumber(summary.amazonUnits)} sub={formatCurrency(summary.amazonValue)} icon={ShoppingCart} color="orange" />
            <MetricCard label="3PL" value={formatNumber(summary.threeplUnits)} sub={formatCurrency(summary.threeplValue)} icon={Boxes} color="violet" />
          </div>
          {data.velocitySource && <div className="bg-cyan-900/20 border border-cyan-500/30 rounded-xl p-3 mb-6"><p className="text-cyan-400 text-sm"><span className="font-semibold">Velocity:</span> {data.velocitySource}</p></div>}
          
          {/* Learning Status Banner */}
          {data.learningStatus?.correctionsApplied && (
            <div className="bg-purple-900/20 border border-purple-500/30 rounded-xl p-3 mb-6 flex items-center gap-3">
              <Brain className="w-5 h-5 text-purple-400" />
              <div className="flex-1">
                <p className="text-purple-300 text-sm font-medium">AI-Enhanced Predictions Active</p>
                <p className="text-slate-400 text-xs">
                  Velocity calculations adjusted using {data.learningStatus.samplesUsed} weeks of learned data ({data.learningStatus.confidence.toFixed(0)}% confidence)
                </p>
              </div>
              <div className="text-right">
                <p className="text-purple-300 text-xs">Correction Factor</p>
                <p className="text-white font-mono text-sm">{(forecastCorrections.overall?.units || 1).toFixed(2)}x</p>
              </div>
            </div>
          )}
          {!data.learningStatus?.correctionsApplied && forecastCorrections.samplesUsed > 0 && (
            <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-3 mb-6 flex items-center gap-3">
              <Brain className="w-5 h-5 text-amber-400" />
              <div className="flex-1">
                <p className="text-amber-300 text-sm font-medium">AI Learning in Progress</p>
                <p className="text-slate-400 text-xs">
                  {forecastCorrections.samplesUsed} samples collected â€¢ {forecastCorrections.confidence.toFixed(0)}% confidence (30% needed to activate)
                </p>
              </div>
            </div>
          )}
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div className="bg-rose-500/10 border border-rose-500/30 rounded-2xl p-4"><div className="flex items-center gap-2 mb-2"><AlertCircle className="w-5 h-5 text-rose-400" /><span className="text-rose-400 font-medium">Critical</span></div><p className="text-2xl font-bold text-white">{summary.critical}</p><p className="text-xs text-slate-400">&lt;14 days</p></div>
            <div className="bg-amber-500/10 border border-amber-500/30 rounded-2xl p-4"><div className="flex items-center gap-2 mb-2"><AlertTriangle className="w-5 h-5 text-amber-400" /><span className="text-amber-400 font-medium">Low</span></div><p className="text-2xl font-bold text-white">{summary.low}</p><p className="text-xs text-slate-400">14-30 days</p></div>
            <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-2xl p-4"><div className="flex items-center gap-2 mb-2"><CheckCircle className="w-5 h-5 text-emerald-400" /><span className="text-emerald-400 font-medium">Healthy</span></div><p className="text-2xl font-bold text-white">{summary.healthy}</p><p className="text-xs text-slate-400">30-90 days</p></div>
            <div className="bg-violet-500/10 border border-violet-500/30 rounded-2xl p-4"><div className="flex items-center gap-2 mb-2"><Clock className="w-5 h-5 text-violet-400" /><span className="text-violet-400 font-medium">Overstock</span></div><p className="text-2xl font-bold text-white">{summary.overstock}</p><p className="text-xs text-slate-400">&gt;90 days</p></div>
          </div>
          {/* Reorder Alert - Items with less than 120 days supply */}
          {(() => {
            const lowStock = items.filter(item => item.daysOfSupply !== 999 && item.daysOfSupply < 120 && item.daysOfSupply > 0);
            if (lowStock.length === 0) return null;
            const criticalItems = lowStock.filter(i => i.daysOfSupply < 30);
            const warningItems = lowStock.filter(i => i.daysOfSupply >= 30 && i.daysOfSupply < 60);
            const watchItems = lowStock.filter(i => i.daysOfSupply >= 60 && i.daysOfSupply < 120);
            return (
              <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4 mb-6">
                <div className="flex items-start gap-3">
                  <AlertTriangle className="w-6 h-6 text-amber-400 flex-shrink-0 mt-0.5" />
                  <div className="flex-1">
                    <h4 className="text-amber-400 font-semibold mb-1">ðŸ“¦ Reorder Alert: Less Than 120 Days Supply</h4>
                    <p className="text-slate-300 text-sm mb-3">
                      {lowStock.length} SKU{lowStock.length > 1 ? 's' : ''} running low on inventory
                      {criticalItems.length > 0 && <span className="text-rose-400 ml-2">({criticalItems.length} critical!)</span>}
                    </p>
                    <div className="bg-slate-900/50 rounded-lg p-3 max-h-48 overflow-y-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="text-slate-500 text-xs">
                            <th className="text-left pb-2">SKU</th>
                            <th className="text-right pb-2">Qty</th>
                            <th className="text-right pb-2">Velocity/wk</th>
                            <th className="text-right pb-2">Days Left</th>
                            <th className="text-left pb-2 pl-2">Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          {lowStock.sort((a, b) => a.daysOfSupply - b.daysOfSupply).slice(0, 15).map(item => (
                            <tr key={item.sku} className="border-t border-slate-700/50">
                              <td className="py-1.5 text-white max-w-[150px] truncate" title={item.name}>{item.sku}</td>
                              <td className="py-1.5 text-right text-white">{formatNumber(item.totalQty)}</td>
                              <td className="py-1.5 text-right text-slate-400">{item.weeklyVel.toFixed(1)}</td>
                              <td className={`py-1.5 text-right font-semibold ${item.daysOfSupply < 30 ? 'text-rose-400' : item.daysOfSupply < 60 ? 'text-amber-400' : 'text-yellow-400'}`}>{item.daysOfSupply}</td>
                              <td className="py-1.5 pl-2">
                                {item.daysOfSupply < 30 ? <span className="text-xs bg-rose-500/20 text-rose-400 px-1.5 py-0.5 rounded">CRITICAL</span> :
                                 item.daysOfSupply < 60 ? <span className="text-xs bg-amber-500/20 text-amber-400 px-1.5 py-0.5 rounded">ORDER NOW</span> :
                                 <span className="text-xs bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">WATCH</span>}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      {lowStock.length > 15 && <p className="text-slate-500 text-xs mt-2">+ {lowStock.length - 15} more...</p>}
                    </div>
                    <div className="flex gap-4 mt-3 text-xs">
                      <span className="flex items-center gap-1"><span className="w-2 h-2 bg-rose-500 rounded" />&lt;30 days: {criticalItems.length}</span>
                      <span className="flex items-center gap-1"><span className="w-2 h-2 bg-amber-500 rounded" />30-60 days: {warningItems.length}</span>
                      <span className="flex items-center gap-1"><span className="w-2 h-2 bg-yellow-500 rounded" />60-120 days: {watchItems.length}</span>
                    </div>
                  </div>
                </div>
              </div>
            );
          })()}
          <div className="bg-slate-800/50 rounded-2xl border border-slate-700 overflow-hidden">
            <div className="p-4 border-b border-slate-700"><h3 className="text-lg font-semibold text-white">Products ({items.length})</h3></div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-slate-900/50"><tr>
                  <th className="text-left text-xs font-medium text-slate-400 uppercase px-4 py-3">Product</th>
                  <th className="text-right text-xs font-medium text-slate-400 uppercase px-4 py-3">Amazon</th>
                  <th className="text-right text-xs font-medium text-slate-400 uppercase px-4 py-3">3PL</th>
                  <th className="text-right text-xs font-medium text-slate-400 uppercase px-4 py-3">Total</th>
                  <th className="text-right text-xs font-medium text-slate-400 uppercase px-4 py-3">Value</th>
                  <th className="text-right text-xs font-medium text-slate-400 uppercase px-4 py-3">Amz Vel</th>
                  <th className="text-right text-xs font-medium text-slate-400 uppercase px-4 py-3">Shop Vel</th>
                  <th className="text-right text-xs font-medium text-slate-400 uppercase px-4 py-3">Total Vel</th>
                  <th className="text-right text-xs font-medium text-slate-400 uppercase px-4 py-3">Days</th>
                  <th className="text-center text-xs font-medium text-slate-400 uppercase px-4 py-3">Status</th>
                </tr></thead>
                <tbody className="divide-y divide-slate-700/50">
                  {items.map((item) => (
                    <tr key={item.sku} className={`hover:bg-slate-700/30 ${item.health === 'critical' ? 'bg-rose-950/20' : item.health === 'low' ? 'bg-amber-950/20' : ''}`}>
                      <td className="px-4 py-3"><div className="max-w-xs"><p className="text-white text-sm font-medium truncate">{item.name}</p><p className="text-slate-500 text-xs">{item.sku}</p></div></td>
                      <td className="text-right px-4 py-3 text-white text-sm">{formatNumber(item.amazonQty)}</td>
                      <td className="text-right px-4 py-3 text-white text-sm">{formatNumber(item.threeplQty)}</td>
                      <td className="text-right px-4 py-3 text-white text-sm font-medium">{formatNumber(item.totalQty)}</td>
                      <td className="text-right px-4 py-3 text-white text-sm">{formatCurrency(item.totalValue)}</td>
                      <td className="text-right px-4 py-3 text-orange-400 text-sm">{(item.amzWeeklyVel || 0).toFixed(1)}</td>
                      <td className="text-right px-4 py-3 text-blue-400 text-sm">{(item.shopWeeklyVel || 0).toFixed(1)}</td>
                      <td className="text-right px-4 py-3 text-white text-sm font-medium">{item.weeklyVel.toFixed(1)}</td>
                      <td className="text-right px-4 py-3 text-white text-sm">{item.daysOfSupply === 999 ? 'â€”' : item.daysOfSupply}</td>
                      <td className="text-center px-4 py-3"><HealthBadge health={item.health} /></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
          
          {/* Smart Inventory Forecast Section */}
          <div className="mt-8 mb-8">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-xl font-bold text-white flex items-center gap-2">
                  <TrendingUp className="w-6 h-6 text-emerald-400" />
                  Smart Inventory Forecast
                </h2>
                <p className="text-slate-400 text-sm">AI-powered predictions using historical data, Amazon forecasts, and production pipeline</p>
              </div>
              <button 
                disabled={aiLoading}
                onClick={async () => {
                  setAiLoading(true);
                  
                  // Gather all the data for AI analysis
                  const inventoryItems = items;
                  const sortedWeeks = Object.keys(allWeeksData).sort();
                  const recentWeeks = sortedWeeks.slice(-12);
                  
                  // Build velocity history per SKU
                  const skuVelocityHistory = {};
                  recentWeeks.forEach(week => {
                    const weekData = allWeeksData[week];
                    [...(weekData?.amazon?.skus || []), ...(weekData?.shopify?.skus || [])].forEach(sku => {
                      if (!skuVelocityHistory[sku.sku]) skuVelocityHistory[sku.sku] = [];
                      skuVelocityHistory[sku.sku].push({ week, units: sku.units || 0 });
                    });
                  });
                  
                  // Get Amazon forecasts
                  const amazonForecastData = upcomingAmazonForecasts.length > 0 ? upcomingAmazonForecasts[0] : null;
                  
                  // Get production pipeline
                  const pendingProduction = productionPipeline.filter(p => p.status !== 'received');
                  
                  // Build context for AI
                  const analysisContext = {
                    currentInventory: inventoryItems.slice(0, 30).map(i => ({
                      sku: i.sku,
                      name: i.name,
                      totalQty: i.totalQty,
                      weeklyVelocity: i.weeklyVel,
                      daysOfSupply: i.daysOfSupply,
                      health: i.health
                    })),
                    velocityTrends: Object.entries(skuVelocityHistory).slice(0, 20).map(([sku, history]) => ({
                      sku,
                      avgVelocity: history.reduce((s, h) => s + h.units, 0) / Math.max(history.length, 1),
                      trend: history.length >= 4 ? (history.slice(-2).reduce((s, h) => s + h.units, 0) / 2) - (history.slice(0, 2).reduce((s, h) => s + h.units, 0) / 2) : 0
                    })),
                    amazonForecast: amazonForecastData ? {
                      weekEnding: amazonForecastData.weekEnding,
                      projectedUnits: amazonForecastData.totals?.units || amazonForecastData.totalUnits || 0,
                      projectedRevenue: amazonForecastData.totals?.sales || amazonForecastData.totalSales || 0,
                      topSkus: Object.entries(amazonForecastData.skus || {}).slice(0, 10).map(([sku, data]) => ({ sku, units: data?.units || 0 }))
                    } : null,
                    productionPipeline: pendingProduction.map(p => ({
                      sku: p.sku,
                      product: p.productName,
                      quantity: p.quantity,
                      expectedDate: p.expectedDate,
                      daysUntil: p.expectedDate ? Math.ceil((new Date(p.expectedDate) - new Date()) / (1000 * 60 * 60 * 24)) : null
                    })),
                    forecastAccuracy: getAmazonForecastComparison.length > 0 ? {
                      avgAccuracy: (100 - Math.abs(getAmazonForecastComparison.reduce((s, c) => s + c.variance.revenuePercent, 0) / getAmazonForecastComparison.length)).toFixed(1),
                      samples: getAmazonForecastComparison.length
                    } : null
                  };
                  
                  setAiInput('');
                  setShowAIChat(true);
                  setAiMessages(prev => [...prev, { 
                    role: 'user', 
                    content: `Analyze my inventory and provide a smart forecast. Here's my data:\n\n${JSON.stringify(analysisContext, null, 2)}\n\nPlease:\n1. Identify which SKUs are at risk of stockout\n2. Factor in the production pipeline timing\n3. Compare current velocity vs Amazon's forecast\n4. Give me a prioritized reorder recommendation\n5. Flag any SKUs where production won't arrive in time`
                  }]);
                  
                  // Trigger AI analysis
                  try {
                    const response = await fetch('/api/chat', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        messages: [{
                          role: 'user',
                          content: `You are an inventory planning expert. Analyze this e-commerce inventory data and provide actionable recommendations.

DATA:
${JSON.stringify(analysisContext, null, 2)}

Provide a concise analysis covering:
1. **Stockout Risk** - Which SKUs will run out first and when
2. **Production Timing** - Will incoming production arrive before stockouts?
3. **Velocity Analysis** - Are sales trending up/down? How does this compare to Amazon's forecast?
4. **Reorder Priority** - Ranked list of what to reorder first
5. **Specific Actions** - What should I do this week?

Be specific with SKU names and numbers. Use bullet points for clarity.`
                        }],
                        model: 'claude-sonnet-4-20250514',
                      })
                    });
                    const result = await response.json();
                    setAiMessages(prev => [...prev, { 
                      role: 'assistant', 
                      content: result.content?.[0]?.text || result.content || result.choices?.[0]?.message?.content || 'Unable to generate forecast analysis.'
                    }]);
                  } catch (err) {
                    console.error('AI Forecast Analysis error:', err);
                    setAiMessages(prev => [...prev, { 
                      role: 'assistant', 
                      content: 'Error generating forecast. Please try again.'
                    }]);
                  } finally {
                    setAiLoading(false);
                  }
                }}
                className={`px-4 py-2 rounded-lg text-sm text-white flex items-center gap-2 ${aiLoading ? 'bg-slate-600 cursor-not-allowed' : 'bg-emerald-600 hover:bg-emerald-500'}`}
              >
                {aiLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Zap className="w-4 h-4" />}
                {aiLoading ? 'Analyzing...' : 'Run AI Forecast Analysis'}
              </button>
            </div>
            
            {/* Forecast Data Sources */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              {/* Historical Velocity */}
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                <div className="flex items-center gap-2 mb-2">
                  <Clock className="w-5 h-5 text-blue-400" />
                  <span className="text-blue-400 font-medium text-sm">Historical Data</span>
                </div>
                <p className="text-2xl font-bold text-white">{Object.keys(allWeeksData).length} weeks</p>
                <p className="text-slate-400 text-xs">Sales velocity baseline</p>
              </div>
              
              {/* Amazon Forecast */}
              <div className={`rounded-xl border p-4 ${upcomingAmazonForecasts.length > 0 ? 'bg-orange-900/20 border-orange-500/30' : 'bg-slate-800/50 border-slate-700'}`}>
                <div className="flex items-center gap-2 mb-2">
                  <TrendingUp className="w-5 h-5 text-orange-400" />
                  <span className="text-orange-400 font-medium text-sm">Amazon Forecast</span>
                </div>
                {upcomingAmazonForecasts.length > 0 ? (
                  <>
                    <p className="text-2xl font-bold text-white">{formatNumber(upcomingAmazonForecasts[0].totals?.units || upcomingAmazonForecasts[0].totalUnits || 0)} units</p>
                    <p className="text-slate-400 text-xs">Projected next week</p>
                  </>
                ) : (
                  <>
                    <p className="text-slate-500 text-lg">Not uploaded</p>
                    <button onClick={() => { setUploadTab('forecast'); setView('upload'); }} className="text-orange-400 text-xs hover:underline">Upload forecast â†’</button>
                  </>
                )}
              </div>
              
              {/* Production Pipeline */}
              <div className={`rounded-xl border p-4 ${productionPipeline.filter(p => p.status !== 'received').length > 0 ? 'bg-cyan-900/20 border-cyan-500/30' : 'bg-slate-800/50 border-slate-700'}`}>
                <div className="flex items-center gap-2 mb-2">
                  <Truck className="w-5 h-5 text-cyan-400" />
                  <span className="text-cyan-400 font-medium text-sm">Incoming Production</span>
                </div>
                {productionPipeline.filter(p => p.status !== 'received').length > 0 ? (
                  <>
                    <p className="text-2xl font-bold text-white">{formatNumber(productionPipeline.filter(p => p.status !== 'received').reduce((s, p) => s + (p.quantity || 0), 0))} units</p>
                    <p className="text-slate-400 text-xs">{productionPipeline.filter(p => p.status !== 'received').length} orders pending</p>
                  </>
                ) : (
                  <>
                    <p className="text-slate-500 text-lg">None tracked</p>
                    <p className="text-slate-500 text-xs">Add production below</p>
                  </>
                )}
              </div>
              
              {/* Forecast Accuracy */}
              <div className={`rounded-xl border p-4 ${getAmazonForecastComparison.length > 0 ? 'bg-emerald-900/20 border-emerald-500/30' : 'bg-slate-800/50 border-slate-700'}`}>
                <div className="flex items-center gap-2 mb-2">
                  <Target className="w-5 h-5 text-emerald-400" />
                  <span className="text-emerald-400 font-medium text-sm">Forecast Accuracy</span>
                </div>
                {getAmazonForecastComparison.length > 0 ? (
                  <>
                    <p className="text-2xl font-bold text-white">
                      {(100 - Math.abs(getAmazonForecastComparison.reduce((s, c) => s + c.variance.revenuePercent, 0) / getAmazonForecastComparison.length)).toFixed(0)}%
                    </p>
                    <p className="text-slate-400 text-xs">Based on {getAmazonForecastComparison.length} weeks</p>
                  </>
                ) : (
                  <>
                    <p className="text-slate-500 text-lg">No data yet</p>
                    <p className="text-slate-500 text-xs">Upload actuals after forecasts</p>
                  </>
                )}
              </div>
            </div>
            
            {/* Critical Items Quick View */}
            {(() => {
              const criticalItems = items.filter(i => i.daysOfSupply < 30 && i.daysOfSupply !== 999 && i.daysOfSupply > 0);
              const incomingForCritical = criticalItems.map(item => {
                const incoming = productionPipeline.find(p => p.sku === item.sku && p.status !== 'received');
                return { ...item, incoming };
              });
              
              if (criticalItems.length === 0) return (
                <div className="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-4">
                  <div className="flex items-center gap-2">
                    <CheckCircle className="w-5 h-5 text-emerald-400" />
                    <span className="text-emerald-400 font-medium">All inventory levels healthy!</span>
                  </div>
                  <p className="text-slate-400 text-sm mt-1">No SKUs are critically low on stock.</p>
                </div>
              );
              
              return (
                <div className="bg-rose-900/20 border border-rose-500/30 rounded-xl p-4">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <AlertCircle className="w-5 h-5 text-rose-400" />
                      <span className="text-rose-400 font-semibold">Critical Stock Alert: {criticalItems.length} SKUs</span>
                    </div>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-slate-500 text-xs border-b border-slate-700">
                          <th className="text-left pb-2">SKU</th>
                          <th className="text-right pb-2">Stock</th>
                          <th className="text-right pb-2">Velocity/wk</th>
                          <th className="text-right pb-2">Days Left</th>
                          <th className="text-left pb-2 pl-3">Incoming Production</th>
                          <th className="text-left pb-2">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {incomingForCritical.sort((a, b) => a.daysOfSupply - b.daysOfSupply).slice(0, 10).map(item => {
                          const willArrive = item.incoming?.expectedDate ? Math.ceil((new Date(item.incoming.expectedDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                          const willStockOut = willArrive !== null && willArrive > item.daysOfSupply;
                          return (
                            <tr key={item.sku} className="border-t border-slate-700/50">
                              <td className="py-2 text-white font-mono">{item.sku}</td>
                              <td className="py-2 text-right text-white">{formatNumber(item.totalQty)}</td>
                              <td className="py-2 text-right text-slate-400">{item.weeklyVel.toFixed(1)}</td>
                              <td className="py-2 text-right text-rose-400 font-bold">{item.daysOfSupply}</td>
                              <td className="py-2 pl-3">
                                {item.incoming ? (
                                  <span className="text-cyan-400">
                                    {formatNumber(item.incoming.quantity)} units in {willArrive}d
                                  </span>
                                ) : (
                                  <span className="text-slate-500">None scheduled</span>
                                )}
                              </td>
                              <td className="py-2">
                                {item.incoming ? (
                                  willStockOut ? (
                                    <span className="text-xs bg-rose-500/20 text-rose-400 px-2 py-0.5 rounded">âš ï¸ Will stockout</span>
                                  ) : (
                                    <span className="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded">âœ“ Covered</span>
                                  )
                                ) : (
                                  <span className="text-xs bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded">Order now</span>
                                )}
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              );
            })()}
          </div>
          
          {/* Production Pipeline / Purchase Orders Section */}
          <div className="mt-8">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-xl font-bold text-white flex items-center gap-2">
                  <Truck className="w-6 h-6 text-cyan-400" />
                  Purchase Orders & Production
                </h2>
                <p className="text-slate-400 text-sm">Track open POs, payment terms, and incoming inventory</p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => { 
                  setProductionForm({ 
                    sku: '', productName: '', quantity: '', expectedDate: '', notes: '',
                    poNumber: '', vendor: '', unitCost: '', paymentTerms: '50-50', depositPercent: 50,
                    depositPaid: false, depositPaidDate: '', balancePaid: false, balancePaidDate: '', shipments: [],
                    depositNetDays: 0, balanceNetDays: 0, cureTimeDays: 0, lineItems: []
                  }); 
                  setEditingProduction(null); 
                  setShowAddProduction(true); 
                }} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm text-white flex items-center gap-2">
                  <Plus className="w-4 h-4" />Add Purchase Order
                </button>
              </div>
            </div>
            
            {/* AI Extract from File */}
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4 mb-4">
              <p className="text-slate-300 text-sm mb-3">ðŸ“„ Have a production order or PO? Upload it and AI will extract the data:</p>
              <div className="flex items-center gap-3">
                <label className={`flex-1 border-2 border-dashed rounded-xl p-4 cursor-pointer transition-all ${productionFile ? 'border-cyan-500/50 bg-cyan-950/20' : 'border-slate-600 hover:border-slate-500'}`}>
                  <input type="file" accept=".csv,.xlsx,.xls,.pdf,.txt" onChange={(e) => {
                    const file = e.target.files[0];
                    if (file) {
                      setProductionFileName(file.name);
                      const reader = new FileReader();
                      reader.onload = (ev) => setProductionFile(ev.target.result);
                      reader.readAsText(file);
                    }
                  }} className="hidden" />
                  <div className="flex items-center justify-center gap-2">
                    {productionFile ? <Check className="w-5 h-5 text-cyan-400" /> : <Upload className="w-5 h-5 text-slate-400" />}
                    <span className={productionFile ? 'text-cyan-400' : 'text-slate-400'}>{productionFile ? productionFileName : 'Upload PO, invoice, or CSV'}</span>
                  </div>
                </label>
                {productionFile && (
                  <button 
                    onClick={async () => {
                      if (!productionFile) return;
                      setExtractingProduction(true);
                      try {
                        const response = await fetch('/api/chat', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            messages: [{
                              role: 'user',
                              content: `Extract production/manufacturing order data from this document. Return ONLY a JSON array with objects containing: sku, productName, quantity (number), expectedDate (YYYY-MM-DD format), notes (optional). If you can't find a date, use empty string. If you can't find SKU, use the product name. Here's the document:\n\n${productionFile}`
                            }],
                            model: 'claude-sonnet-4-20250514',
                          })
                        });
                        const data = await response.json();
                        // Try to parse JSON from the response
                        const text = data.choices?.[0]?.message?.content || data.content || '';
                        const jsonMatch = text.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                          const extracted = JSON.parse(jsonMatch[0]);
                          if (Array.isArray(extracted) && extracted.length > 0) {
                            // Add each extracted item to pipeline
                            const newItems = extracted.map(item => ({
                              id: Date.now() + Math.random(),
                              sku: item.sku || '',
                              productName: item.productName || item.product_name || item.name || '',
                              quantity: parseInt(item.quantity) || 0,
                              expectedDate: item.expectedDate || item.expected_date || item.date || '',
                              notes: item.notes || '',
                              status: 'pending',
                              createdAt: new Date().toISOString()
                            }));
                            setProductionPipeline(prev => [...prev, ...newItems]);
                            setToast({ message: `Extracted ${newItems.length} production items`, type: 'success' });
                            setProductionFile(null);
                            setProductionFileName('');
                          } else {
                            setToast({ message: 'No production data found in file', type: 'error' });
                          }
                        } else {
                          setToast({ message: 'Could not parse production data', type: 'error' });
                        }
                      } catch (err) {
                        setToast({ message: 'Error extracting data: ' + err.message, type: 'error' });
                      }
                      setExtractingProduction(false);
                    }}
                    disabled={extractingProduction}
                    className="px-4 py-2 bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 rounded-lg text-sm text-white flex items-center gap-2"
                  >
                    {extractingProduction ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Zap className="w-4 h-4" />}
                    {extractingProduction ? 'Extracting...' : 'Extract with AI'}
                  </button>
                )}
              </div>
            </div>
            
            {/* Add/Edit Production Modal */}
            {showAddProduction && (
              <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 overflow-y-auto">
                <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-2xl w-full my-8">
                  <h3 className="text-lg font-semibold text-white mb-4">{editingProduction ? 'Edit Purchase Order' : 'Add Purchase Order'}</h3>
                  
                  {/* Product Preset - Quick Fill */}
                  <div className="bg-gradient-to-r from-cyan-900/30 to-blue-900/30 rounded-xl p-4 mb-4 border border-cyan-500/30">
                    <label className="block text-sm text-cyan-400 mb-2">Quick Fill â€” Product Type</label>
                    <select 
                      onChange={(e) => {
                        const preset = e.target.value;
                        if (preset === 'lip-balm') {
                          setProductionForm(p => ({ 
                            ...p, 
                            paymentTerms: '30-70-ship', 
                            depositPercent: 30,
                            depositNetDays: 30,
                            balanceNetDays: 60,
                            cureTimeDays: 0,
                          }));
                        } else if (preset === 'tallow-balm' || preset === 'deodorant') {
                          setProductionForm(p => ({ 
                            ...p, 
                            paymentTerms: '50-50', 
                            depositPercent: 50,
                            depositNetDays: 0,
                            balanceNetDays: 0,
                            cureTimeDays: 0,
                          }));
                        } else if (preset === 'soap') {
                          setProductionForm(p => ({ 
                            ...p, 
                            paymentTerms: '50-50', 
                            depositPercent: 50,
                            depositNetDays: 0,
                            balanceNetDays: 0,
                            cureTimeDays: 21, // 3 weeks default cure time
                          }));
                        }
                      }}
                      className="w-full bg-slate-800 border border-cyan-500/50 rounded-lg px-3 py-2 text-white"
                      defaultValue=""
                    >
                      <option value="" disabled>Select product type to auto-fill terms...</option>
                      <option value="lip-balm">ðŸ§´ Lip Balm â€” 30% deposit (Net 30), 70% on ship (Net 60)</option>
                      <option value="tallow-balm">ðŸ«™ Tallow Balm â€” 50/50, due immediately</option>
                      <option value="deodorant">ðŸ§´ Deodorant â€” 50/50, due immediately</option>
                      <option value="soap">ðŸ§¼ Soap â€” 50/50, due immediately + 3 week cure time</option>
                    </select>
                  </div>
                  
                  {/* Basic Info */}
                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div>
                      <label className="block text-sm text-slate-400 mb-1">PO Number</label>
                      <input type="text" value={productionForm.poNumber || ''} onChange={(e) => setProductionForm(p => ({ ...p, poNumber: e.target.value }))} placeholder="PO-2025-001" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white" />
                    </div>
                    <div>
                      <label className="block text-sm text-slate-400 mb-1">Vendor/Manufacturer</label>
                      <input type="text" value={productionForm.vendor || ''} onChange={(e) => setProductionForm(p => ({ ...p, vendor: e.target.value }))} placeholder="Manufacturer name" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white" />
                    </div>
                  </div>
                  
                  {/* Line Items - Multiple SKUs */}
                  <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="text-white font-medium">Line Items</h4>
                      <button
                        type="button"
                        onClick={() => setProductionForm(p => ({
                          ...p,
                          lineItems: [...(p.lineItems || []), { sku: '', productName: '', quantity: '', unitCost: '' }]
                        }))}
                        className="px-3 py-1 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-white text-sm flex items-center gap-1"
                      >
                        <Plus className="w-4 h-4" /> Add Item
                      </button>
                    </div>
                    
                    {/* Show legacy single item if no line items yet */}
                    {(!productionForm.lineItems || productionForm.lineItems.length === 0) && (
                      <div className="grid grid-cols-12 gap-2 mb-2">
                        <div className="col-span-2">
                          <label className="block text-xs text-slate-500 mb-1">SKU</label>
                          <input 
                            type="text" 
                            value={productionForm.sku} 
                            onChange={(e) => setProductionForm(p => ({ ...p, sku: e.target.value }))} 
                            placeholder="SKU" 
                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-white text-sm" 
                          />
                        </div>
                        <div className="col-span-4">
                          <label className="block text-xs text-slate-500 mb-1">Product Name</label>
                          <input 
                            type="text" 
                            value={productionForm.productName} 
                            onChange={(e) => setProductionForm(p => ({ ...p, productName: e.target.value }))} 
                            placeholder="Product description" 
                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-white text-sm" 
                          />
                        </div>
                        <div className="col-span-2">
                          <label className="block text-xs text-slate-500 mb-1">Qty</label>
                          <input 
                            type="number" 
                            value={productionForm.quantity} 
                            onChange={(e) => setProductionForm(p => ({ ...p, quantity: e.target.value }))} 
                            placeholder="1000" 
                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-white text-sm" 
                          />
                        </div>
                        <div className="col-span-2">
                          <label className="block text-xs text-slate-500 mb-1">Unit Cost</label>
                          <input 
                            type="number" 
                            step="0.01"
                            value={productionForm.unitCost} 
                            onChange={(e) => setProductionForm(p => ({ ...p, unitCost: e.target.value }))} 
                            placeholder="0.45" 
                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-white text-sm" 
                          />
                        </div>
                        <div className="col-span-2">
                          <label className="block text-xs text-slate-500 mb-1">Line Total</label>
                          <div className="bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-emerald-400 text-sm">
                            {formatCurrency((parseFloat(productionForm.quantity) || 0) * (parseFloat(productionForm.unitCost) || 0))}
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* Line items list */}
                    {(productionForm.lineItems || []).map((item, idx) => (
                      <div key={idx} className="grid grid-cols-12 gap-2 mb-2 items-end">
                        <div className="col-span-2">
                          {idx === 0 && <label className="block text-xs text-slate-500 mb-1">SKU</label>}
                          <input 
                            type="text" 
                            value={item.sku} 
                            onChange={(e) => {
                              const newItems = [...productionForm.lineItems];
                              newItems[idx] = { ...newItems[idx], sku: e.target.value };
                              setProductionForm(p => ({ ...p, lineItems: newItems }));
                            }} 
                            placeholder="SKU" 
                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-white text-sm" 
                          />
                        </div>
                        <div className="col-span-3">
                          {idx === 0 && <label className="block text-xs text-slate-500 mb-1">Product Name</label>}
                          <input 
                            type="text" 
                            value={item.productName} 
                            onChange={(e) => {
                              const newItems = [...productionForm.lineItems];
                              newItems[idx] = { ...newItems[idx], productName: e.target.value };
                              setProductionForm(p => ({ ...p, lineItems: newItems }));
                            }} 
                            placeholder="Product" 
                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-white text-sm" 
                          />
                        </div>
                        <div className="col-span-2">
                          {idx === 0 && <label className="block text-xs text-slate-500 mb-1">Qty</label>}
                          <input 
                            type="number" 
                            value={item.quantity} 
                            onChange={(e) => {
                              const newItems = [...productionForm.lineItems];
                              newItems[idx] = { ...newItems[idx], quantity: e.target.value };
                              setProductionForm(p => ({ ...p, lineItems: newItems }));
                            }} 
                            placeholder="1000" 
                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-white text-sm" 
                          />
                        </div>
                        <div className="col-span-2">
                          {idx === 0 && <label className="block text-xs text-slate-500 mb-1">Unit Cost</label>}
                          <input 
                            type="number" 
                            step="0.01"
                            value={item.unitCost} 
                            onChange={(e) => {
                              const newItems = [...productionForm.lineItems];
                              newItems[idx] = { ...newItems[idx], unitCost: e.target.value };
                              setProductionForm(p => ({ ...p, lineItems: newItems }));
                            }} 
                            placeholder="0.45" 
                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-white text-sm" 
                          />
                        </div>
                        <div className="col-span-2">
                          {idx === 0 && <label className="block text-xs text-slate-500 mb-1">Line Total</label>}
                          <div className="bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-emerald-400 text-sm">
                            {formatCurrency((parseFloat(item.quantity) || 0) * (parseFloat(item.unitCost) || 0))}
                          </div>
                        </div>
                        <div className="col-span-1">
                          {idx === 0 && <label className="block text-xs text-slate-500 mb-1">&nbsp;</label>}
                          <button
                            type="button"
                            onClick={() => {
                              const newItems = productionForm.lineItems.filter((_, i) => i !== idx);
                              setProductionForm(p => ({ ...p, lineItems: newItems }));
                            }}
                            className="p-1.5 text-slate-500 hover:text-rose-400"
                          >
                            <X className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    ))}
                    
                    {/* Total */}
                    <div className="flex justify-end mt-3 pt-3 border-t border-slate-700">
                      <div className="text-right">
                        <span className="text-slate-400 text-sm mr-4">Total PO Value:</span>
                        <span className="text-emerald-400 font-bold text-lg">
                          {formatCurrency(
                            ((productionForm.lineItems || []).length > 0 
                              ? productionForm.lineItems.reduce((sum, item) => sum + ((parseFloat(item.quantity) || 0) * (parseFloat(item.unitCost) || 0)), 0)
                              : (parseFloat(productionForm.quantity) || 0) * (parseFloat(productionForm.unitCost) || 0)
                            )
                          )}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Payment Terms */}
                  <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
                    <h4 className="text-white font-medium mb-3">Payment Terms</h4>
                    <div className="grid grid-cols-3 gap-4 mb-3">
                      <div>
                        <label className="block text-sm text-slate-400 mb-1">Payment Structure</label>
                        <select 
                          value={productionForm.paymentTerms || '50-50'} 
                          onChange={(e) => {
                            const terms = e.target.value;
                            let deposit = 50;
                            if (terms === '30-70-ship') deposit = 30;
                            else if (terms === 'net30') deposit = 0;
                            else if (terms === '100-upfront') deposit = 100;
                            setProductionForm(p => ({ ...p, paymentTerms: terms, depositPercent: deposit }));
                          }}
                          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"
                        >
                          <option value="30-70-ship">30% Deposit, 70% As Ships</option>
                          <option value="50-50">50% Deposit, 50% At Completion</option>
                          <option value="net30">Net 30 (Pay on Delivery)</option>
                          <option value="100-upfront">100% Upfront</option>
                          <option value="custom">Custom Terms</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-1">Deposit %</label>
                        <input 
                          type="number" 
                          value={productionForm.depositPercent || 50} 
                          onChange={(e) => setProductionForm(p => ({ ...p, depositPercent: parseInt(e.target.value) || 0 }))} 
                          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"
                          disabled={productionForm.paymentTerms !== 'custom'}
                        />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-1">Cure Time (days)</label>
                        <input 
                          type="number" 
                          value={productionForm.cureTimeDays || 0} 
                          onChange={(e) => setProductionForm(p => ({ ...p, cureTimeDays: parseInt(e.target.value) || 0 }))} 
                          placeholder="0"
                          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"
                        />
                        <p className="text-slate-500 text-xs mt-1">For soaps needing cure time</p>
                      </div>
                    </div>
                    
                    {/* Net Terms Row */}
                    <div className="grid grid-cols-2 gap-4 mb-3">
                      <div>
                        <label className="block text-sm text-slate-400 mb-1">Deposit Due (Net Days)</label>
                        <input 
                          type="number" 
                          value={productionForm.depositNetDays || 0} 
                          onChange={(e) => setProductionForm(p => ({ ...p, depositNetDays: parseInt(e.target.value) || 0 }))} 
                          placeholder="0 = immediately"
                          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"
                        />
                        <p className="text-slate-500 text-xs mt-1">{productionForm.depositNetDays > 0 ? `Due ${productionForm.depositNetDays} days after PO` : 'Due immediately'}</p>
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-1">Balance Due (Net Days)</label>
                        <input 
                          type="number" 
                          value={productionForm.balanceNetDays || 0} 
                          onChange={(e) => setProductionForm(p => ({ ...p, balanceNetDays: parseInt(e.target.value) || 0 }))} 
                          placeholder="0 = on shipment"
                          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"
                        />
                        <p className="text-slate-500 text-xs mt-1">{productionForm.balanceNetDays > 0 ? `Due ${productionForm.balanceNetDays} days after shipment` : 'Due on shipment/completion'}</p>
                      </div>
                    </div>
                    
                    {/* Payment Status */}
                    <div className="grid grid-cols-2 gap-4">
                      <div className="bg-slate-800 rounded-lg p-3">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-slate-400 text-sm">Deposit ({productionForm.depositPercent || 50}%)</span>
                          <span className="text-amber-400 font-medium">
                            {formatCurrency((parseFloat(productionForm.quantity) || 0) * (parseFloat(productionForm.unitCost) || 0) * ((productionForm.depositPercent || 50) / 100))}
                          </span>
                        </div>
                        <div className="flex items-center gap-3">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input 
                              type="checkbox" 
                              checked={productionForm.depositPaid || false}
                              onChange={(e) => setProductionForm(p => ({ ...p, depositPaid: e.target.checked, depositPaidDate: e.target.checked ? new Date().toISOString().split('T')[0] : '' }))}
                              className="w-4 h-4 rounded"
                            />
                            <span className="text-white text-sm">Paid</span>
                          </label>
                          {productionForm.depositPaid && (
                            <input 
                              type="date" 
                              value={productionForm.depositPaidDate || ''} 
                              onChange={(e) => setProductionForm(p => ({ ...p, depositPaidDate: e.target.value }))}
                              className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-white text-sm flex-1"
                            />
                          )}
                        </div>
                      </div>
                      <div className="bg-slate-800 rounded-lg p-3">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-slate-400 text-sm">Balance ({100 - (productionForm.depositPercent || 50)}%)</span>
                          <span className="text-rose-400 font-medium">
                            {formatCurrency((parseFloat(productionForm.quantity) || 0) * (parseFloat(productionForm.unitCost) || 0) * ((100 - (productionForm.depositPercent || 50)) / 100))}
                          </span>
                        </div>
                        {productionForm.paymentTerms !== '30-70-ship' ? (
                          <div className="flex items-center gap-3">
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input 
                                type="checkbox" 
                                checked={productionForm.balancePaid || false}
                                onChange={(e) => setProductionForm(p => ({ ...p, balancePaid: e.target.checked, balancePaidDate: e.target.checked ? new Date().toISOString().split('T')[0] : '' }))}
                                className="w-4 h-4 rounded"
                              />
                              <span className="text-white text-sm">Paid</span>
                            </label>
                            {productionForm.balancePaid && (
                              <input 
                                type="date" 
                                value={productionForm.balancePaidDate || ''} 
                                onChange={(e) => setProductionForm(p => ({ ...p, balancePaidDate: e.target.value }))}
                                className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-white text-sm flex-1"
                              />
                            )}
                          </div>
                        ) : (
                          <p className="text-slate-500 text-xs">Paid as units ship (tracked via shipments)</p>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  {/* Expected Date & Notes */}
                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div>
                      <label className="block text-sm text-slate-400 mb-1">Expected Completion Date</label>
                      <input type="date" value={productionForm.expectedDate} onChange={(e) => setProductionForm(p => ({ ...p, expectedDate: e.target.value }))} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white" />
                    </div>
                    <div>
                      <label className="block text-sm text-slate-400 mb-1">Notes</label>
                      <input type="text" value={productionForm.notes} onChange={(e) => setProductionForm(p => ({ ...p, notes: e.target.value }))} placeholder="Additional notes..." className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white" />
                    </div>
                  </div>
                  
                  <div className="flex gap-3 mt-6">
                    <button onClick={() => {
                      // Validate: need either single item or line items
                      const hasLineItems = productionForm.lineItems && productionForm.lineItems.length > 0;
                      const hasSingleItem = productionForm.sku || productionForm.productName;
                      
                      if (!hasLineItems && !hasSingleItem) {
                        setToast({ message: 'Add at least one item (SKU or Product Name)', type: 'error' });
                        return;
                      }
                      
                      // Calculate total from line items or single item
                      let totalValue = 0;
                      let totalQty = 0;
                      let lineItems = [];
                      
                      if (hasLineItems) {
                        lineItems = productionForm.lineItems.map(item => ({
                          sku: item.sku,
                          productName: item.productName,
                          quantity: parseInt(item.quantity) || 0,
                          unitCost: parseFloat(item.unitCost) || 0,
                        }));
                        totalValue = lineItems.reduce((sum, item) => sum + (item.quantity * item.unitCost), 0);
                        totalQty = lineItems.reduce((sum, item) => sum + item.quantity, 0);
                      } else {
                        totalQty = parseInt(productionForm.quantity) || 0;
                        totalValue = totalQty * (parseFloat(productionForm.unitCost) || 0);
                      }
                      
                      const poData = {
                        ...productionForm,
                        quantity: hasLineItems ? totalQty : (parseInt(productionForm.quantity) || 0),
                        unitCost: hasLineItems ? (totalQty > 0 ? totalValue / totalQty : 0) : (parseFloat(productionForm.unitCost) || 0),
                        depositPercent: parseInt(productionForm.depositPercent) || 50,
                        totalValue,
                        lineItems: hasLineItems ? lineItems : [],
                        shipments: productionForm.shipments || [],
                      };
                      if (editingProduction) {
                        setProductionPipeline(prev => prev.map(p => p.id === editingProduction ? { ...p, ...poData } : p));
                        setToast({ message: 'Purchase Order updated', type: 'success' });
                      } else {
                        const newItem = {
                          id: Date.now(),
                          ...poData,
                          status: 'pending',
                          createdAt: new Date().toISOString()
                        };
                        setProductionPipeline(prev => [...prev, newItem]);
                        setToast({ message: 'Purchase Order added', type: 'success' });
                      }
                      setShowAddProduction(false);
                      setEditingProduction(null);
                    }} className="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-semibold py-2 rounded-lg">
                      {editingProduction ? 'Save Changes' : 'Add Purchase Order'}
                    </button>
                    <button onClick={() => { setShowAddProduction(false); setEditingProduction(null); }} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-lg">Cancel</button>
                  </div>
                </div>
              </div>
            )}
            
            {/* Production Pipeline Table */}
            {productionPipeline.length > 0 ? (
              <div className="bg-slate-800/50 rounded-2xl border border-slate-700 overflow-hidden">
                {/* Cash Flow Summary */}
                {(() => {
                  const totalPOValue = productionPipeline.reduce((s, p) => s + (p.totalValue || (p.quantity * (p.unitCost || 0))), 0);
                  const totalDeposits = productionPipeline.reduce((s, p) => {
                    const value = p.totalValue || (p.quantity * (p.unitCost || 0));
                    const depositAmt = value * ((p.depositPercent || 50) / 100);
                    return s + (p.depositPaid ? depositAmt : 0);
                  }, 0);
                  const totalBalancePaid = productionPipeline.reduce((s, p) => {
                    if (p.paymentTerms === '30-70-ship') {
                      // For rolling payments, sum shipment payments
                      const shippedUnits = (p.shipments || []).reduce((su, sh) => su + (sh.units || 0), 0);
                      const shippedValue = shippedUnits * (p.unitCost || 0);
                      const balancePercent = (100 - (p.depositPercent || 30)) / 100;
                      return s + (shippedValue * balancePercent);
                    } else {
                      const value = p.totalValue || (p.quantity * (p.unitCost || 0));
                      const balanceAmt = value * ((100 - (p.depositPercent || 50)) / 100);
                      return s + (p.balancePaid ? balanceAmt : 0);
                    }
                  }, 0);
                  const totalPaid = totalDeposits + totalBalancePaid;
                  const totalOutstanding = totalPOValue - totalPaid;
                  const totalUnitsOrdered = productionPipeline.reduce((s, p) => s + (p.quantity || 0), 0);
                  const totalUnitsReceived = productionPipeline.reduce((s, p) => {
                    if (p.status === 'received') return s + (p.quantity || 0);
                    return s + (p.shipments || []).reduce((su, sh) => su + (sh.units || 0), 0);
                  }, 0);
                  
                  return (
                    <div className="bg-slate-900/50 p-4 border-b border-slate-700">
                      <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                        <div>
                          <p className="text-slate-500 text-xs">Total PO Value</p>
                          <p className="text-white font-bold">{formatCurrency(totalPOValue)}</p>
                        </div>
                        <div>
                          <p className="text-slate-500 text-xs">Paid to Date</p>
                          <p className="text-emerald-400 font-bold">{formatCurrency(totalPaid)}</p>
                        </div>
                        <div>
                          <p className="text-slate-500 text-xs">Outstanding</p>
                          <p className="text-rose-400 font-bold">{formatCurrency(totalOutstanding)}</p>
                        </div>
                        <div>
                          <p className="text-slate-500 text-xs">Units Ordered</p>
                          <p className="text-cyan-400 font-bold">{formatNumber(totalUnitsOrdered)}</p>
                        </div>
                        <div>
                          <p className="text-slate-500 text-xs">Units Received</p>
                          <p className="text-white font-bold">{formatNumber(totalUnitsReceived)}</p>
                        </div>
                      </div>
                    </div>
                  );
                })()}
                
                <table className="w-full">
                  <thead className="bg-slate-900/50">
                    <tr>
                      <th className="text-left px-4 py-3 text-slate-400 text-xs uppercase">PO / Product</th>
                      <th className="text-right px-4 py-3 text-slate-400 text-xs uppercase">Qty</th>
                      <th className="text-right px-4 py-3 text-slate-400 text-xs uppercase">Unit Cost</th>
                      <th className="text-right px-4 py-3 text-slate-400 text-xs uppercase">Total Value</th>
                      <th className="text-center px-4 py-3 text-slate-400 text-xs uppercase">Payment</th>
                      <th className="text-left px-4 py-3 text-slate-400 text-xs uppercase">Status</th>
                      <th className="text-center px-4 py-3 text-slate-400 text-xs uppercase">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {productionPipeline.sort((a, b) => new Date(a.expectedDate || '9999-12-31') - new Date(b.expectedDate || '9999-12-31')).map(item => {
                      const totalValue = item.totalValue || (item.quantity * (item.unitCost || 0));
                      const depositAmt = totalValue * ((item.depositPercent || 50) / 100);
                      const balanceAmt = totalValue - depositAmt;
                      const shippedUnits = (item.shipments || []).reduce((s, sh) => s + (sh.units || 0), 0);
                      const unitsRemaining = item.quantity - shippedUnits;
                      
                      // Calculate payment status
                      let paidAmt = item.depositPaid ? depositAmt : 0;
                      if (item.paymentTerms === '30-70-ship') {
                        paidAmt += shippedUnits * (item.unitCost || 0) * ((100 - (item.depositPercent || 30)) / 100);
                      } else if (item.balancePaid) {
                        paidAmt += balanceAmt;
                      }
                      const paidPercent = totalValue > 0 ? (paidAmt / totalValue * 100) : 0;
                      
                      // Calculate payment due dates based on Net terms
                      const poDate = item.createdAt ? new Date(item.createdAt) : new Date();
                      const depositNetDays = item.depositNetDays || 0;
                      const balanceNetDays = item.balanceNetDays || 0;
                      const depositDueDate = depositNetDays > 0 ? new Date(poDate.getTime() + depositNetDays * 24*60*60*1000) : null;
                      
                      // For balance due date, calculate from last shipment or expected date
                      const lastShipment = item.shipments?.length > 0 ? item.shipments[item.shipments.length - 1] : null;
                      const shipDate = lastShipment ? new Date(lastShipment.date) : (item.expectedDate ? new Date(item.expectedDate) : null);
                      const balanceDueDate = balanceNetDays > 0 && shipDate ? new Date(shipDate.getTime() + balanceNetDays * 24*60*60*1000) : null;
                      
                      // Calculate cure time (for soaps)
                      const cureTimeDays = item.cureTimeDays || 0;
                      let cureEndDate = null;
                      let cureRemaining = null;
                      if (cureTimeDays > 0 && item.status === 'received') {
                        // Assume cure starts when received - use last shipment date or today
                        const receiveDate = lastShipment ? new Date(lastShipment.date) : new Date();
                        cureEndDate = new Date(receiveDate.getTime() + cureTimeDays * 24*60*60*1000);
                        cureRemaining = Math.ceil((cureEndDate - new Date()) / (24*60*60*1000));
                      }
                      
                      // Check if deposit is overdue
                      const isDepositOverdue = !item.depositPaid && depositDueDate && new Date() > depositDueDate;
                      const daysUntilDepositDue = depositDueDate && !item.depositPaid ? Math.ceil((depositDueDate - new Date()) / (24*60*60*1000)) : null;
                      
                      return (
                        <tr key={item.id} className="border-t border-slate-700/50 hover:bg-slate-700/20">
                          <td className="px-4 py-3">
                            <div>
                              {/* Show line items if present, otherwise single product */}
                              {item.lineItems && item.lineItems.length > 0 ? (
                                <div>
                                  {item.lineItems.map((li, idx) => (
                                    <p key={idx} className="text-white text-sm">
                                      <span className="text-slate-500">{li.sku || 'â€”'}</span>
                                      {li.productName && <span className="ml-2">{li.productName}</span>}
                                      <span className="text-cyan-400 ml-2">Ã—{li.quantity}</span>
                                    </p>
                                  ))}
                                  {item.lineItems.length > 1 && (
                                    <p className="text-slate-500 text-xs mt-1">{item.lineItems.length} items</p>
                                  )}
                                </div>
                              ) : (
                                <p className="text-white font-medium">{item.productName || item.sku || 'â€”'}</p>
                              )}
                              <div className="flex flex-wrap gap-2 mt-1">
                                {item.poNumber && <span className="text-slate-500 text-xs">PO: {item.poNumber}</span>}
                                {item.vendor && <span className="text-slate-500 text-xs">â€¢ {item.vendor}</span>}
                                {/* Payment terms badge */}
                                {(depositNetDays > 0 || balanceNetDays > 0) && (
                                  <span className="text-amber-400/70 text-xs">
                                    Net {depositNetDays}/{balanceNetDays}
                                  </span>
                                )}
                                {/* Cure time badge */}
                                {cureTimeDays > 0 && (
                                  <span className={`text-xs px-1.5 py-0.5 rounded ${
                                    cureRemaining !== null 
                                      ? cureRemaining <= 0 
                                        ? 'bg-emerald-500/20 text-emerald-400' 
                                        : 'bg-amber-500/20 text-amber-400'
                                      : 'bg-slate-600 text-slate-400'
                                  }`}>
                                    ðŸ§¼ {cureRemaining !== null 
                                      ? cureRemaining <= 0 
                                        ? 'Cured âœ“' 
                                        : `${cureRemaining}d cure left`
                                      : `${cureTimeDays}d cure`}
                                  </span>
                                )}
                                {/* Deposit due alert */}
                                {isDepositOverdue && (
                                  <span className="text-xs px-1.5 py-0.5 rounded bg-rose-500/20 text-rose-400">
                                    âš ï¸ Deposit overdue!
                                  </span>
                                )}
                                {daysUntilDepositDue !== null && daysUntilDepositDue > 0 && daysUntilDepositDue <= 7 && (
                                  <span className="text-xs px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-400">
                                    Deposit due in {daysUntilDepositDue}d
                                  </span>
                                )}
                              </div>
                            </div>
                          </td>
                          <td className="px-4 py-3 text-right">
                            <p className="text-cyan-400 font-semibold">{formatNumber(item.quantity)}</p>
                            {shippedUnits > 0 && item.status !== 'received' && (
                              <p className="text-slate-500 text-xs">{formatNumber(shippedUnits)} shipped</p>
                            )}
                          </td>
                          <td className="px-4 py-3 text-right text-slate-300">{item.unitCost ? formatCurrency(item.unitCost) : 'â€”'}</td>
                          <td className="px-4 py-3 text-right text-white font-medium">{totalValue > 0 ? formatCurrency(totalValue) : 'â€”'}</td>
                          <td className="px-4 py-3">
                            {totalValue > 0 ? (
                              <div className="flex flex-col items-center">
                                <div className="w-full bg-slate-700 rounded-full h-2 mb-1">
                                  <div className="bg-emerald-500 h-2 rounded-full" style={{ width: `${Math.min(100, paidPercent)}%` }} />
                                </div>
                                <span className="text-xs text-slate-400">{paidPercent.toFixed(0)}% paid</span>
                              </div>
                            ) : (
                              <span className="text-slate-500 text-xs">No cost set</span>
                            )}
                          </td>
                          <td className="px-4 py-3">
                            <select 
                              value={item.status || 'pending'} 
                              onChange={(e) => setProductionPipeline(prev => prev.map(p => p.id === item.id ? { ...p, status: e.target.value } : p))}
                              className={`text-xs px-2 py-1 rounded-lg border-0 ${
                                item.status === 'received' ? 'bg-emerald-500/20 text-emerald-400' :
                                item.status === 'shipped' ? 'bg-blue-500/20 text-blue-400' :
                                item.status === 'in_production' ? 'bg-amber-500/20 text-amber-400' :
                                'bg-slate-700 text-slate-300'
                              }`}
                            >
                              <option value="pending">Pending</option>
                              <option value="in_production">In Production</option>
                              <option value="partial">Partial Ship</option>
                              <option value="shipped">Shipped</option>
                              <option value="received">Received</option>
                            </select>
                          </td>
                          <td className="px-4 py-3 text-center">
                            <div className="flex items-center justify-center gap-1">
                              {item.paymentTerms === '30-70-ship' && (
                                <button 
                                  onClick={() => { setShowAddShipment(item.id); setShipmentForm({ date: new Date().toISOString().split('T')[0], units: '', notes: '' }); }}
                                  className="p-1.5 hover:bg-cyan-900/50 rounded text-cyan-400 hover:text-cyan-300"
                                  title="Log Shipment"
                                >
                                  <Package className="w-4 h-4" />
                                </button>
                              )}
                              <button onClick={() => {
                                setProductionForm({
                                  sku: item.sku || '',
                                  productName: item.productName || '',
                                  quantity: item.quantity?.toString() || '',
                                  expectedDate: item.expectedDate || '',
                                  notes: item.notes || '',
                                  poNumber: item.poNumber || '',
                                  vendor: item.vendor || '',
                                  unitCost: item.unitCost?.toString() || '',
                                  paymentTerms: item.paymentTerms || '50-50',
                                  depositPercent: item.depositPercent || 50,
                                  depositPaid: item.depositPaid || false,
                                  depositPaidDate: item.depositPaidDate || '',
                                  balancePaid: item.balancePaid || false,
                                  balancePaidDate: item.balancePaidDate || '',
                                  shipments: item.shipments || [],
                                  depositNetDays: item.depositNetDays || 0,
                                  balanceNetDays: item.balanceNetDays || 0,
                                  cureTimeDays: item.cureTimeDays || 0,
                                  lineItems: item.lineItems || [],
                                });
                                setEditingProduction(item.id);
                                setShowAddProduction(true);
                              }} className="p-1.5 hover:bg-slate-700 rounded text-slate-400 hover:text-white">
                                <Settings className="w-4 h-4" />
                              </button>
                              <button onClick={() => {
                                if (confirm('Delete this purchase order?')) {
                                  setProductionPipeline(prev => prev.filter(p => p.id !== item.id));
                                  setToast({ message: 'Purchase order deleted', type: 'success' });
                                }
                              }} className="p-1.5 hover:bg-rose-900/50 rounded text-slate-400 hover:text-rose-400">
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                {/* Summary */}
                <div className="bg-slate-900/50 px-4 py-3 border-t border-slate-700">
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-slate-400">{productionPipeline.length} purchase orders</span>
                    <span className="text-cyan-400 font-semibold">{formatNumber(productionPipeline.reduce((s, p) => s + (p.quantity || 0), 0))} total units on order</span>
                  </div>
                </div>
              </div>
            ) : (
              <div className="bg-slate-800/30 rounded-2xl border border-dashed border-slate-600 p-8 text-center">
                <Truck className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                <p className="text-slate-400 mb-2">No purchase orders tracked</p>
                <p className="text-slate-500 text-sm">Add open POs to track incoming inventory and cash flow</p>
              </div>
            )}
            
            {/* Add Shipment Modal */}
            {showAddShipment && (() => {
              const po = productionPipeline.find(p => p.id === showAddShipment);
              if (!po) return null;
              const totalShipped = (po.shipments || []).reduce((s, sh) => s + (sh.units || 0), 0);
              const remaining = (po.quantity || 0) - totalShipped;
              const unitCost = po.unitCost || 0;
              const balancePercent = (100 - (po.depositPercent || 30)) / 100;
              
              return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                  <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full">
                    <h3 className="text-lg font-semibold text-white mb-2">Log Shipment</h3>
                    <p className="text-slate-400 text-sm mb-4">{po.productName || po.sku} â€” {formatNumber(remaining)} units remaining</p>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm text-slate-400 mb-1">Units Received</label>
                        <input 
                          type="number" 
                          value={shipmentForm.units} 
                          onChange={(e) => setShipmentForm(f => ({ ...f, units: e.target.value }))}
                          max={remaining}
                          placeholder={`Max: ${formatNumber(remaining)}`}
                          className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white"
                        />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-1">Date Received</label>
                        <input 
                          type="date" 
                          value={shipmentForm.date} 
                          onChange={(e) => setShipmentForm(f => ({ ...f, date: e.target.value }))}
                          className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white"
                        />
                      </div>
                      <div className="bg-slate-900/50 rounded-lg p-3">
                        <p className="text-slate-400 text-sm mb-1">Payment Due for This Shipment</p>
                        <p className="text-rose-400 font-bold text-lg">
                          {formatCurrency((parseInt(shipmentForm.units) || 0) * unitCost * balancePercent)}
                        </p>
                        <p className="text-slate-500 text-xs">{formatNumber(shipmentForm.units || 0)} units Ã— {formatCurrency(unitCost)} Ã— {(balancePercent * 100).toFixed(0)}%</p>
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-1">Notes (optional)</label>
                        <input 
                          type="text" 
                          value={shipmentForm.notes} 
                          onChange={(e) => setShipmentForm(f => ({ ...f, notes: e.target.value }))}
                          placeholder="Shipment tracking, notes..."
                          className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white"
                        />
                      </div>
                    </div>
                    
                    <div className="flex gap-3 mt-6">
                      <button 
                        onClick={() => {
                          const units = parseInt(shipmentForm.units) || 0;
                          if (units <= 0) {
                            setToast({ message: 'Enter units received', type: 'error' });
                            return;
                          }
                          if (units > remaining) {
                            setToast({ message: `Cannot exceed ${formatNumber(remaining)} remaining units`, type: 'error' });
                            return;
                          }
                          
                          const newShipment = {
                            id: Date.now(),
                            date: shipmentForm.date || new Date().toISOString().split('T')[0],
                            units: units,
                            amountPaid: units * unitCost * balancePercent,
                            notes: shipmentForm.notes,
                          };
                          
                          setProductionPipeline(prev => prev.map(p => {
                            if (p.id !== showAddShipment) return p;
                            const updatedShipments = [...(p.shipments || []), newShipment];
                            const totalShippedNow = updatedShipments.reduce((s, sh) => s + (sh.units || 0), 0);
                            const newStatus = totalShippedNow >= p.quantity ? 'received' : 'partial';
                            return { ...p, shipments: updatedShipments, status: newStatus };
                          }));
                          
                          setToast({ message: `Logged ${formatNumber(units)} units received`, type: 'success' });
                          setShowAddShipment(null);
                          setShipmentForm({ date: '', units: '', notes: '' });
                        }}
                        className="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-semibold py-2 rounded-lg"
                      >
                        Log Shipment
                      </button>
                      <button 
                        onClick={() => { setShowAddShipment(null); setShipmentForm({ date: '', units: '', notes: '' }); }}
                        className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-lg"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              );
            })()}
            
            {/* Inventory Planning Section */}
            {productionPipeline.length > 0 && (
              <div className="bg-gradient-to-r from-cyan-900/30 to-blue-900/30 rounded-xl border border-cyan-500/30 p-5 mt-6">
                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <Brain className="w-5 h-5 text-cyan-400" />
                  Inventory Planning & Reorder Timing
                </h3>
                
                {(() => {
                  // Calculate velocity for SKUs in POs
                  const sortedWeeks = Object.keys(allWeeksData).sort().slice(-8);
                  const skuVelocity = {};
                  
                  sortedWeeks.forEach(w => {
                    const shopify = allWeeksData[w]?.shopify?.skuData || [];
                    const amazon = allWeeksData[w]?.amazon?.skuData || [];
                    [...shopify, ...amazon].forEach(s => {
                      const sku = s.sku || s.msku;
                      if (!skuVelocity[sku]) skuVelocity[sku] = [];
                      skuVelocity[sku].push(s.unitsSold || s.units || 0);
                    });
                  });
                  
                  // Get current inventory
                  const latestInvKey = Object.keys(invHistory).sort().reverse()[0];
                  const currentInv = latestInvKey ? (invHistory[latestInvKey]?.items || []) : [];
                  const invBySku = {};
                  currentInv.forEach(item => { invBySku[item.sku] = item.totalQty || 0; });
                  
                  // Calculate for each PO's SKU
                  const poAnalysis = productionPipeline.filter(po => po.status !== 'received').map(po => {
                    const sku = po.sku;
                    const weeklyVel = skuVelocity[sku]?.length > 0 
                      ? skuVelocity[sku].reduce((s, u) => s + u, 0) / skuVelocity[sku].length 
                      : 0;
                    const currentStock = invBySku[sku] || 0;
                    const totalShipped = (po.shipments || []).reduce((s, sh) => s + (sh.units || 0), 0);
                    const incomingFromPO = (po.quantity || 0) - totalShipped;
                    const totalAvailable = currentStock + incomingFromPO;
                    const weeksOfSupply = weeklyVel > 0 ? totalAvailable / weeklyVel : Infinity;
                    const monthsOfSupply = weeksOfSupply / 4.33;
                    
                    // Calculate when to reorder for 6 months coverage
                    const targetMonths = 6;
                    const targetUnits = weeklyVel * 4.33 * targetMonths;
                    const unitsNeeded = Math.max(0, targetUnits - totalAvailable);
                    
                    return {
                      ...po,
                      weeklyVel,
                      currentStock,
                      incomingFromPO,
                      totalAvailable,
                      weeksOfSupply,
                      monthsOfSupply,
                      targetUnits,
                      unitsNeeded,
                    };
                  });
                  
                  return (
                    <div className="space-y-4">
                      {poAnalysis.map(po => (
                        <div key={po.id} className="bg-slate-800/50 rounded-lg p-4">
                          <div className="flex items-center justify-between mb-3">
                            <div>
                              <p className="text-white font-medium">{po.productName || po.sku}</p>
                              <p className="text-slate-500 text-xs">Velocity: {formatNumber(Math.round(po.weeklyVel))}/week â€¢ {formatNumber(Math.round(po.weeklyVel * 4.33))}/month</p>
                            </div>
                            <div className={`px-3 py-1 rounded-lg text-sm font-medium ${
                              po.monthsOfSupply >= 6 ? 'bg-emerald-500/20 text-emerald-400' :
                              po.monthsOfSupply >= 3 ? 'bg-amber-500/20 text-amber-400' :
                              'bg-rose-500/20 text-rose-400'
                            }`}>
                              {po.monthsOfSupply === Infinity ? 'âˆž' : po.monthsOfSupply.toFixed(1)} months supply
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-4 gap-3 text-sm">
                            <div>
                              <p className="text-slate-500 text-xs">Current Stock</p>
                              <p className="text-white font-medium">{formatNumber(po.currentStock)}</p>
                            </div>
                            <div>
                              <p className="text-slate-500 text-xs">Incoming (PO)</p>
                              <p className="text-cyan-400 font-medium">{formatNumber(po.incomingFromPO)}</p>
                            </div>
                            <div>
                              <p className="text-slate-500 text-xs">Total Available</p>
                              <p className="text-white font-medium">{formatNumber(po.totalAvailable)}</p>
                            </div>
                            <div>
                              <p className="text-slate-500 text-xs">Need for 6mo</p>
                              <p className={`font-medium ${po.unitsNeeded > 0 ? 'text-rose-400' : 'text-emerald-400'}`}>
                                {po.unitsNeeded > 0 ? formatNumber(Math.round(po.unitsNeeded)) : 'âœ“ Covered'}
                              </p>
                            </div>
                          </div>
                          
                          {po.unitsNeeded > 0 && po.unitCost > 0 && (
                            <div className="mt-3 pt-3 border-t border-slate-700">
                              <p className="text-slate-400 text-sm">
                                ðŸ’¡ <strong>Suggested Reorder:</strong> {formatNumber(Math.ceil(po.unitsNeeded / 1000) * 1000)} units 
                                @ {formatCurrency(po.unitCost)}/unit = <span className="text-amber-400 font-medium">{formatCurrency(Math.ceil(po.unitsNeeded / 1000) * 1000 * po.unitCost)}</span> PO value
                              </p>
                            </div>
                          )}
                        </div>
                      ))}
                      
                      {poAnalysis.length === 0 && (
                        <p className="text-slate-400 text-center py-4">All POs are fully received. Add new POs to see inventory planning.</p>
                      )}
                    </div>
                  );
                })()}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // ==================== TRENDS VIEW ====================
  if (view === 'trends') {
    // Apply date range filter
    const filterByDateRange = (dateKey) => {
      if (trendsDateRange.preset === 'all' || (!trendsDateRange.start && !trendsDateRange.end)) {
        return true;
      }
      const date = dateKey.substring(0, 10); // Handle both YYYY-MM-DD and YYYY-MM-DD with extra chars
      if (trendsDateRange.start && date < trendsDateRange.start) return false;
      if (trendsDateRange.end && date > trendsDateRange.end) return false;
      return true;
    };
    
    // Get all available data with date filtering
    const sortedWeeks = Object.keys(allWeeksData).filter(filterByDateRange).sort();
    const sortedPeriods = Object.keys(allPeriodsData).sort();
    
    // Categorize periods by type
    const monthlyPeriods = sortedPeriods.filter(p => {
      // Match formats like "january-2025", "2025-01", "January 2025"
      return /^(january|february|march|april|may|june|july|august|september|october|november|december)-?\d{4}$/i.test(p) ||
             /^\d{4}-\d{2}$/.test(p) ||
             /^[a-z]+-\d{4}$/i.test(p);
    });
    
    const quarterlyPeriods = sortedPeriods.filter(p => /q[1-4]/i.test(p));
    const yearlyPeriods = sortedPeriods.filter(p => /^\d{4}$/.test(p));
    
    // Build unified monthly data (from periods OR aggregated from weeks)
    const getMonthlyTrends = () => {
      const monthData = {};
      
      // First, add period data for months
      monthlyPeriods.forEach(p => {
        const data = allPeriodsData[p];
        // Normalize the key to YYYY-MM format
        let monthKey = p;
        const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
        monthNames.forEach((name, idx) => {
          if (p.toLowerCase().includes(name)) {
            const yearMatch = p.match(/\d{4}/);
            if (yearMatch) monthKey = `${yearMatch[0]}-${String(idx + 1).padStart(2, '0')}`;
          }
        });
        
        // Calculate profit using COGS lookup for period data
        const amazonProfit = data.amazon?.netProfit || 0;
        const shopifyRevenue = data.shopify?.revenue || 0;
        const shopifyUnits = data.shopify?.units || 0;
        
        // Calculate Shopify COGS from SKU data using savedCogs lookup
        let shopifyCogs = data.shopify?.cogs || 0;
        if (shopifyCogs === 0 && data.shopify?.skuData) {
          shopifyCogs = (data.shopify.skuData || []).reduce((sum, sku) => {
            const skuKey = sku.sku || sku.title || '';
            const unitCost = savedCogs[skuKey] || savedCogs[sku.title] || 0;
            return sum + (unitCost * (sku.unitsSold || sku.units || 0));
          }, 0);
        }
        
        const shopifyFees = data.shopify?.fees || 0;
        const shopifyShipping = data.shopify?.shipping || 0;
        const shopifyAdSpend = data.shopify?.adSpend || 0;
        const shopifyProfit = data.shopify?.netProfit || (shopifyRevenue - shopifyCogs - shopifyFees - shopifyShipping - shopifyAdSpend);
        const totalRevenue = data.total?.revenue || (data.amazon?.revenue || 0) + shopifyRevenue;
        const totalProfit = data.total?.netProfit || (amazonProfit + shopifyProfit);
        const totalMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
        
        monthData[monthKey] = {
          key: p,
          label: data.label || p,
          source: 'period',
          revenue: totalRevenue,
          profit: totalProfit,
          units: data.total?.units || (data.amazon?.units || 0) + shopifyUnits,
          margin: data.total?.netMargin || totalMargin,
          amazonRev: data.amazon?.revenue || 0,
          amazonProfit: amazonProfit,
          amazonUnits: data.amazon?.units || 0,
          shopifyRev: shopifyRevenue,
          shopifyProfit: shopifyProfit,
          shopifyUnits: shopifyUnits,
          adSpend: data.total?.adSpend || 0,
          roas: data.total?.roas || 0,
          skuData: [...(data.amazon?.skuData || []), ...(data.shopify?.skuData || [])],
        };
      });
      
      // Then aggregate weekly data for months not in periods
      sortedWeeks.forEach(w => {
        const monthKey = w.substring(0, 7);
        if (!monthData[monthKey]) {
          // Use T12:00:00 to avoid timezone issues
          const dateForLabel = new Date(monthKey + '-15T12:00:00');
          monthData[monthKey] = {
            key: monthKey,
            label: dateForLabel.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
            source: 'weekly',
            revenue: 0, profit: 0, units: 0, margin: 0,
            amazonRev: 0, amazonProfit: 0, amazonUnits: 0,
            shopifyRev: 0, shopifyProfit: 0, shopifyUnits: 0,
            adSpend: 0, roas: 0,
            skuData: [], weekCount: 0,
          };
        }
        if (monthData[monthKey].source === 'weekly') {
          const week = allWeeksData[w];
          
          // Calculate profit using COGS lookup for weekly aggregation
          const wkAmazonProfit = week.amazon?.netProfit || 0;
          const wkShopifyRev = week.shopify?.revenue || 0;
          const wkShopifyUnits = week.shopify?.units || 0;
          
          // Calculate Shopify COGS from SKU data
          let wkShopifyCogs = week.shopify?.cogs || 0;
          if (wkShopifyCogs === 0 && week.shopify?.skuData) {
            wkShopifyCogs = (week.shopify.skuData || []).reduce((sum, sku) => {
              const skuKey = sku.sku || sku.title || '';
              const unitCost = savedCogs[skuKey] || savedCogs[sku.title] || 0;
              return sum + (unitCost * (sku.unitsSold || sku.units || 0));
            }, 0);
          }
          
          const wkShopifyFees = week.shopify?.fees || 0;
          const wkShopifyShipping = week.shopify?.shipping || 0;
          const wkShopifyAdSpend = week.shopify?.adSpend || 0;
          const wkShopifyProfit = week.shopify?.netProfit || (wkShopifyRev - wkShopifyCogs - wkShopifyFees - wkShopifyShipping - wkShopifyAdSpend);
          const wkTotalProfit = week.total?.netProfit || (wkAmazonProfit + wkShopifyProfit);
          
          monthData[monthKey].revenue += week.total?.revenue || (week.amazon?.revenue || 0) + wkShopifyRev;
          monthData[monthKey].profit += wkTotalProfit;
          monthData[monthKey].units += week.total?.units || (week.amazon?.units || 0) + wkShopifyUnits;
          monthData[monthKey].amazonRev += week.amazon?.revenue || 0;
          monthData[monthKey].amazonProfit += wkAmazonProfit;
          monthData[monthKey].amazonUnits += week.amazon?.units || 0;
          monthData[monthKey].shopifyRev += wkShopifyRev;
          monthData[monthKey].shopifyProfit += wkShopifyProfit;
          monthData[monthKey].shopifyUnits += wkShopifyUnits;
          monthData[monthKey].adSpend += week.total?.adSpend || (week.amazon?.adSpend || 0) + wkShopifyAdSpend;
          monthData[monthKey].weekCount = (monthData[monthKey].weekCount || 0) + 1;
          // Aggregate SKU data
          const weekSkus = [...(week.amazon?.skuData || []), ...(week.shopify?.skuData || [])];
          monthData[monthKey].skuData.push(...weekSkus);
        }
      });
      
      // Calculate derived metrics
      Object.values(monthData).forEach(m => {
        if (m.source === 'weekly') {
          m.margin = m.revenue > 0 ? (m.profit / m.revenue) * 100 : 0;
          m.roas = m.adSpend > 0 ? m.revenue / m.adSpend : 0;
        }
      });
      
      // Filter out months with no revenue data
      return Object.entries(monthData)
        .filter(([k, v]) => v.revenue > 0)
        .sort((a, b) => a[0].localeCompare(b[0]));
    };
    
    // Build yearly data
    const getYearlyTrends = () => {
      const yearData = {};
      
      // Add yearly periods first
      yearlyPeriods.forEach(p => {
        const data = allPeriodsData[p];
        yearData[p] = {
          key: p,
          label: data.label || p,
          source: 'period',
          revenue: data.total?.revenue || 0,
          profit: data.total?.netProfit || 0,
          units: data.total?.units || 0,
          margin: data.total?.netMargin || 0,
          amazonRev: data.amazon?.revenue || 0,
          amazonProfit: data.amazon?.netProfit || 0,
          amazonUnits: data.amazon?.units || 0,
          shopifyRev: data.shopify?.revenue || 0,
          shopifyProfit: data.shopify?.netProfit || 0,
          shopifyUnits: data.shopify?.units || 0,
          adSpend: data.total?.adSpend || 0,
          roas: data.total?.roas || 0,
          skuData: [...(data.amazon?.skuData || []), ...(data.shopify?.skuData || [])],
        };
      });
      
      // Aggregate from quarters if available
      quarterlyPeriods.forEach(p => {
        const yearMatch = p.match(/\d{4}/);
        if (!yearMatch) return;
        const year = yearMatch[0];
        if (yearData[year]) return; // Already have yearly data
        
        if (!yearData[year]) {
          yearData[year] = {
            key: year, label: year, source: 'quarterly',
            revenue: 0, profit: 0, units: 0, 
            amazonRev: 0, amazonProfit: 0, amazonUnits: 0,
            shopifyRev: 0, shopifyProfit: 0, shopifyUnits: 0,
            adSpend: 0, skuData: [], quarterCount: 0,
          };
        }
        const data = allPeriodsData[p];
        yearData[year].revenue += data.total?.revenue || 0;
        yearData[year].profit += data.total?.netProfit || 0;
        yearData[year].units += data.total?.units || 0;
        yearData[year].amazonRev += data.amazon?.revenue || 0;
        yearData[year].amazonProfit += data.amazon?.netProfit || 0;
        yearData[year].amazonUnits += data.amazon?.units || 0;
        yearData[year].shopifyRev += data.shopify?.revenue || 0;
        yearData[year].shopifyProfit += data.shopify?.netProfit || 0;
        yearData[year].shopifyUnits += data.shopify?.units || 0;
        yearData[year].adSpend += data.total?.adSpend || 0;
        yearData[year].quarterCount++;
        yearData[year].skuData.push(...(data.amazon?.skuData || []), ...(data.shopify?.skuData || []));
      });
      
      // Calculate derived metrics
      Object.values(yearData).forEach(y => {
        y.margin = y.revenue > 0 ? (y.profit / y.revenue) * 100 : 0;
        y.roas = y.adSpend > 0 ? y.revenue / y.adSpend : 0;
      });
      
      // Filter out years with no revenue data
      return Object.entries(yearData)
        .filter(([k, v]) => v.revenue > 0)
        .sort((a, b) => a[0].localeCompare(b[0]));
    };
    
    // Get weekly data - filter out weeks with no meaningful revenue
    // Also include forecast data for comparison
    // Respect date range filter
    const weeksToShow = trendsDateRange.preset === 'all' ? 12 : 
                        trendsDateRange.preset === 'last30' ? 5 :
                        trendsDateRange.preset === 'last90' ? 13 :
                        sortedWeeks.length;
    
    const weeklyData = sortedWeeks.slice(-weeksToShow).map(w => {
      const week = allWeeksData[w];
      
      // Find forecast for this week from various sources
      let forecastRevenue = null;
      let forecastSource = null;
      
      // 1. Check Amazon forecasts
      const amazonForecast = amazonForecasts[w];
      if (amazonForecast) {
        forecastRevenue = amazonForecast.totals?.sales || amazonForecast.totals?.revenue || 0;
        forecastSource = 'amazon';
      }
      
      // 2. Check forecast accuracy history (has forecast vs actual)
      const accuracyRecord = forecastAccuracyHistory.records?.find(r => r.weekEnding === w);
      if (accuracyRecord && accuracyRecord.forecast?.revenue) {
        forecastRevenue = accuracyRecord.forecast.revenue;
        forecastSource = accuracyRecord.forecastSource || 'system';
      }
      
      // Calculate accuracy if we have both forecast and actual
      const actualRevenue = week.total?.revenue || (week.amazon?.revenue || 0) + (week.shopify?.revenue || 0);
      let accuracy = null;
      let variance = null;
      
      // Sanity check: if forecast is wildly off (>5x or <0.2x actual), ignore it
      if (forecastRevenue !== null && actualRevenue > 0) {
        const forecastRatio = forecastRevenue / actualRevenue;
        if (forecastRatio > 5 || forecastRatio < 0.2) {
          // Bad forecast data - ignore for accuracy calculation
          console.warn(`Ignoring suspicious forecast for ${w}: forecast $${forecastRevenue} vs actual $${actualRevenue}`);
          forecastRevenue = null;
          forecastSource = null;
        } else {
          variance = actualRevenue - forecastRevenue;
          accuracy = Math.max(-100, 100 - (Math.abs(variance) / actualRevenue * 100)); // Clamp to -100 min
        }
      }
      
      // Calculate profit using COGS lookup (same as rest of app)
      const amazonProfit = week.amazon?.netProfit || 0;
      const shopifyRevenue = week.shopify?.revenue || 0;
      const shopifyUnits = week.shopify?.units || 0;
      
      // Calculate Shopify COGS from SKU data using savedCogs lookup
      let shopifyCogs = week.shopify?.cogs || 0;
      if (shopifyCogs === 0 && week.shopify?.skuData) {
        shopifyCogs = (week.shopify.skuData || []).reduce((sum, sku) => {
          const skuKey = sku.sku || sku.title || '';
          const unitCost = savedCogs[skuKey] || savedCogs[sku.title] || 0;
          return sum + (unitCost * (sku.unitsSold || sku.units || 0));
        }, 0);
      }
      
      const shopifyFees = week.shopify?.fees || 0;
      const shopifyShipping = week.shopify?.shipping || 0;
      const shopifyAdSpend = week.shopify?.adSpend || 0;
      const shopifyProfit = week.shopify?.netProfit || (shopifyRevenue - shopifyCogs - shopifyFees - shopifyShipping - shopifyAdSpend);
      const totalProfit = week.total?.netProfit || (amazonProfit + shopifyProfit);
      const totalMargin = actualRevenue > 0 ? (totalProfit / actualRevenue) * 100 : 0;
      
      return {
        key: w,
        label: new Date(w + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        source: 'weekly',
        revenue: actualRevenue,
        profit: totalProfit,
        units: week.total?.units || (week.amazon?.units || 0) + shopifyUnits,
        margin: week.total?.netMargin || totalMargin,
        amazonRev: week.amazon?.revenue || 0,
        amazonProfit: amazonProfit,
        amazonUnits: week.amazon?.units || 0,
        shopifyRev: shopifyRevenue,
        shopifyProfit: shopifyProfit,
        shopifyUnits: shopifyUnits,
        adSpend: week.total?.adSpend || (week.amazon?.adSpend || 0) + shopifyAdSpend,
        roas: week.total?.roas || 0,
        skuData: [...(week.amazon?.skuData || []), ...(week.shopify?.skuData || [])],
        // Forecast data for comparison
        forecastRevenue,
        forecastSource,
        accuracy,
        variance,
      };
    }).filter(w => w.revenue > 0); // Only show weeks with actual sales data
    
    // GENERATE FUTURE PROJECTED WEEKS
    // Calculate average weekly revenue/profit/units from recent data
    const recentWeeks = weeklyData.slice(-4); // Last 4 weeks for trend
    const avgWeeklyRevenue = recentWeeks.length > 0 ? recentWeeks.reduce((s, w) => s + w.revenue, 0) / recentWeeks.length : 0;
    const avgWeeklyProfit = recentWeeks.length > 0 ? recentWeeks.reduce((s, w) => s + w.profit, 0) / recentWeeks.length : 0;
    const avgWeeklyUnits = recentWeeks.length > 0 ? recentWeeks.reduce((s, w) => s + w.units, 0) / recentWeeks.length : 0;
    const avgWeeklyMargin = avgWeeklyRevenue > 0 ? (avgWeeklyProfit / avgWeeklyRevenue) * 100 : 0;
    
    // Calculate week-over-week growth trend
    const growthRates = [];
    for (let i = 1; i < recentWeeks.length; i++) {
      if (recentWeeks[i-1].revenue > 0) {
        growthRates.push((recentWeeks[i].revenue - recentWeeks[i-1].revenue) / recentWeeks[i-1].revenue);
      }
    }
    const avgGrowth = growthRates.length > 0 ? growthRates.reduce((s, r) => s + r, 0) / growthRates.length : 0;
    
    // Generate next 8 projected weeks - USE AI FORECAST SYSTEM when available
    const lastWeekDate = weeklyData.length > 0 ? new Date(weeklyData[weeklyData.length - 1].key + 'T00:00:00') : new Date();
    const projectedWeeks = [];
    
    // Get AI forecast data if available
    const aiForecast = enhancedForecast || generateForecast;
    const aiWeeklyForecast = aiForecast?.weekly || [];
    
    // Sanity check: max reasonable forecast is 3x the average (to catch bad data)
    const maxReasonableForecast = avgWeeklyRevenue * 3;
    const minReasonableForecast = avgWeeklyRevenue * 0.1; // At least 10% of average
    
    for (let i = 1; i <= 8; i++) {
      const futureDate = new Date(lastWeekDate.getTime() + i * 7 * 24 * 60 * 60 * 1000);
      const weekKey = futureDate.toISOString().split('T')[0];
      
      // Priority 1: Use AI forecast for first 4 weeks
      const aiWeek = aiWeeklyForecast[i - 1];
      
      // Priority 2: Check Amazon forecasts (with sanity check)
      const amazonForecast = amazonForecasts[weekKey];
      let amazonRevenue = amazonForecast?.totals?.sales || amazonForecast?.totals?.revenue || null;
      
      // Sanity check: if Amazon forecast is wildly off, ignore it
      if (amazonRevenue && avgWeeklyRevenue > 0) {
        if (amazonRevenue > maxReasonableForecast || amazonRevenue < minReasonableForecast) {
          console.warn(`Ignoring suspicious Amazon forecast for ${weekKey}: $${amazonRevenue} (avg: $${avgWeeklyRevenue})`);
          amazonRevenue = null; // Ignore bad data
        }
      }
      
      // Priority 3: Fall back to trend calculation
      const growthMultiplier = Math.pow(1 + Math.max(-0.1, Math.min(0.1, avgGrowth)), i);
      const trendRevenue = Math.round(avgWeeklyRevenue * growthMultiplier);
      const trendProfit = Math.round(avgWeeklyProfit * growthMultiplier);
      const trendUnits = Math.round(avgWeeklyUnits * growthMultiplier);
      
      // Determine which forecast to use
      let projectedRevenue, projectedProfit, projectedUnits, forecastSource;
      
      if (aiWeek && i <= 4) {
        // Use AI forecast (includes Amazon blending if available)
        let aiRevenue = aiWeek.revenue || trendRevenue;
        // Sanity check AI forecast too
        if (aiRevenue > maxReasonableForecast) aiRevenue = trendRevenue;
        projectedRevenue = aiRevenue;
        projectedProfit = aiWeek.profit || trendProfit;
        projectedUnits = aiWeek.units || trendUnits;
        forecastSource = aiWeek.hasAmazonForecast ? 'ai-amazon' : 'ai-trend';
      } else if (amazonRevenue) {
        // Use direct Amazon forecast (already sanity checked)
        projectedRevenue = amazonRevenue;
        projectedProfit = trendProfit; // Estimate profit from trend
        projectedUnits = trendUnits;
        forecastSource = 'amazon';
      } else {
        // Use trend calculation
        projectedRevenue = trendRevenue;
        projectedProfit = trendProfit;
        projectedUnits = trendUnits;
        forecastSource = 'trend';
      }
      
      projectedWeeks.push({
        key: weekKey,
        label: futureDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        source: 'projected',
        isProjected: true,
        revenue: 0, // No actual yet
        profit: 0,
        units: 0,
        margin: 0,
        amazonRev: 0,
        shopifyRev: 0,
        // Projected values from AI forecast system
        projectedRevenue,
        projectedProfit,
        projectedUnits,
        projectedMargin: avgWeeklyMargin,
        forecastRevenue: projectedRevenue,
        forecastSource,
        aiConfidence: aiForecast?.confidence,
      });
    }
    
    // Combine actual + projected
    const weeklyDataWithProjections = [...weeklyData, ...projectedWeeks];
    
    // Get daily data filtered by date range
    const sortedDays = Object.keys(allDaysData)
      .filter(d => hasDailySalesData(allDaysData[d]) && filterByDateRange(d))
      .sort();
    
    // Determine how many days to show based on range
    const daysToShow = trendsDateRange.preset === 'all' ? 30 : 
                       trendsDateRange.preset === 'last30' ? 30 :
                       trendsDateRange.preset === 'last90' ? 90 :
                       sortedDays.length;
    
    const dailyData = sortedDays.slice(-daysToShow).map(d => {
      const day = allDaysData[d];
      
      // Calculate profit using COGS lookup (same as rest of app)
      const amazonProfit = day.amazon?.netProfit || 0;
      const shopifyRevenue = day.shopify?.revenue || 0;
      const shopifyUnits = day.shopify?.units || 0;
      
      // Calculate Shopify COGS from SKU data using savedCogs lookup
      let shopifyCogs = day.shopify?.cogs || 0;
      if (shopifyCogs === 0 && day.shopify?.skuData) {
        shopifyCogs = (day.shopify.skuData || []).reduce((sum, sku) => {
          const skuKey = sku.sku || sku.title || '';
          const unitCost = savedCogs[skuKey] || savedCogs[sku.title] || 0;
          return sum + (unitCost * (sku.unitsSold || sku.units || 0));
        }, 0);
      }
      
      const shopifyFees = day.shopify?.fees || 0;
      const shopifyShipping = day.shopify?.shipping || 0;
      const shopifyAdSpend = day.shopify?.adSpend || 0;
      const shopifyProfit = day.shopify?.netProfit || (shopifyRevenue - shopifyCogs - shopifyFees - shopifyShipping - shopifyAdSpend);
      
      const totalRevenue = day.total?.revenue || (day.amazon?.revenue || 0) + shopifyRevenue;
      const totalProfit = day.total?.netProfit || (amazonProfit + shopifyProfit);
      const totalMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
      
      return {
        key: d,
        label: new Date(d + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        source: 'daily',
        revenue: totalRevenue,
        profit: totalProfit,
        units: day.total?.units || (day.amazon?.units || 0) + shopifyUnits,
        margin: day.total?.netMargin || totalMargin,
        amazonRev: day.amazon?.revenue || 0,
        amazonProfit: amazonProfit,
        amazonUnits: day.amazon?.units || 0,
        shopifyRev: shopifyRevenue,
        shopifyProfit: shopifyProfit,
        shopifyUnits: shopifyUnits,
        adSpend: day.total?.adSpend || (day.amazon?.adSpend || 0) + shopifyAdSpend,
        roas: day.total?.roas || 0,
        skuData: [...(day.amazon?.skuData || []), ...(day.shopify?.skuData || [])],
      };
    });
    
    const monthlyTrends = getMonthlyTrends();
    const yearlyTrends = getYearlyTrends();
    
    // Add projected months - USE AI FORECAST SYSTEM when available
    const monthlyWithProjections = (() => {
      const monthlyData = monthlyTrends.map(([k, v]) => v);
      if (monthlyData.length === 0) return [];
      
      // Get AI forecast data
      const aiForecast = enhancedForecast || generateForecast;
      const aiMonthlyForecast = aiForecast?.monthly;
      const aiTrend = aiForecast?.trend;
      const aiConfidence = aiForecast?.confidence;
      
      // Calculate average monthly metrics from recent data (fallback)
      const recentMonths = monthlyData.slice(-3);
      const avgMonthlyRevenue = recentMonths.reduce((s, m) => s + m.revenue, 0) / recentMonths.length;
      const avgMonthlyProfit = recentMonths.reduce((s, m) => s + m.profit, 0) / recentMonths.length;
      const avgMonthlyUnits = recentMonths.reduce((s, m) => s + m.units, 0) / recentMonths.length;
      const avgMonthlyMargin = avgMonthlyRevenue > 0 ? (avgMonthlyProfit / avgMonthlyRevenue) * 100 : 0;
      
      // Calculate month-over-month growth trend from AI or calculate manually
      let monthlyGrowthRate = 0;
      if (aiTrend?.revenueChange) {
        // Convert weekly trend to monthly (roughly 4.33 weeks per month)
        monthlyGrowthRate = (aiTrend.revenueChange / 100) * 4.33;
      } else {
        // Calculate from recent months
        const growthRates = [];
        for (let i = 1; i < recentMonths.length; i++) {
          if (recentMonths[i-1].revenue > 0) {
            growthRates.push((recentMonths[i].revenue - recentMonths[i-1].revenue) / recentMonths[i-1].revenue);
          }
        }
        monthlyGrowthRate = growthRates.length > 0 ? growthRates.reduce((s, r) => s + r, 0) / growthRates.length : 0;
      }
      // Cap growth at Â±15% per month
      const cappedGrowth = Math.max(-0.15, Math.min(0.15, monthlyGrowthRate));
      
      // Generate next 6 projected months with AI-informed growth
      const lastMonth = monthlyData[monthlyData.length - 1];
      const lastDate = new Date(lastMonth.key + '-01');
      const projectedMonths = [];
      
      // Use AI monthly forecast for first month if available, then apply trend
      let baseRevenue = aiMonthlyForecast?.revenue ? aiMonthlyForecast.revenue / 4 : lastMonth.revenue || avgMonthlyRevenue;
      let baseProfit = aiMonthlyForecast?.profit ? aiMonthlyForecast.profit / 4 : lastMonth.profit || avgMonthlyProfit;
      let baseUnits = aiMonthlyForecast?.units ? aiMonthlyForecast.units / 4 : lastMonth.units || avgMonthlyUnits;
      
      // If we have AI forecast, use it for base values
      if (aiMonthlyForecast && aiMonthlyForecast.revenue > 0) {
        // AI forecast is for 4 weeks, so this is roughly a monthly value
        baseRevenue = aiMonthlyForecast.revenue;
        baseProfit = aiMonthlyForecast.profit;
        baseUnits = aiMonthlyForecast.units;
      }
      
      for (let i = 1; i <= 6; i++) {
        const futureDate = new Date(lastDate.getFullYear(), lastDate.getMonth() + i, 1);
        const monthKey = `${futureDate.getFullYear()}-${String(futureDate.getMonth() + 1).padStart(2, '0')}`;
        
        // Apply growth multiplier
        const growthMultiplier = Math.pow(1 + cappedGrowth, i);
        const projectedRevenue = Math.round(baseRevenue * growthMultiplier);
        const projectedProfit = Math.round(baseProfit * growthMultiplier);
        const projectedUnits = Math.round(baseUnits * growthMultiplier);
        
        projectedMonths.push({
          key: monthKey,
          label: futureDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
          source: 'projected',
          isProjected: true,
          revenue: 0,
          profit: 0,
          units: 0,
          margin: 0,
          projectedRevenue,
          projectedProfit,
          projectedUnits,
          projectedMargin: avgMonthlyMargin,
          forecastRevenue: projectedRevenue,
          forecastSource: aiMonthlyForecast ? 'ai-forecast' : 'trend',
          growthRate: cappedGrowth,
          aiConfidence,
        });
      }
      
      return [...monthlyData, ...projectedMonths];
    })();
    
    // Select data based on active tab with fallbacks
    let currentData = [];
    if (trendsTab === 'daily' && dailyData.length > 0) {
      currentData = dailyData;
    } else if (trendsTab === 'weekly' && weeklyDataWithProjections.length > 0) {
      currentData = weeklyDataWithProjections;
    } else if (trendsTab === 'monthly' && monthlyWithProjections.length > 0) {
      currentData = monthlyWithProjections;
    } else if (trendsTab === 'yearly' && yearlyTrends.length > 0) {
      currentData = yearlyTrends.map(([k, v]) => v);
    } else {
      // Fallback: use whatever data is available
      if (dailyData.length > 0) {
        currentData = dailyData;
      } else if (monthlyWithProjections.length > 0) {
        currentData = monthlyWithProjections;
      } else if (weeklyDataWithProjections.length > 0) {
        currentData = weeklyDataWithProjections;
      } else if (yearlyTrends.length > 0) {
        currentData = yearlyTrends.map(([k, v]) => v);
      }
    }
    
    // For stats cards, only use actual data (not projected)
    const actualData = currentData.filter(d => !d.isProjected);
    
    // When filtering by channel, find the latest period that has data for that channel
    const getLatestWithChannelData = () => {
      if (trendsChannel === 'combined') {
        return actualData[actualData.length - 1];
      }
      // Find the latest period with actual data for the selected channel
      for (let i = actualData.length - 1; i >= 0; i--) {
        const period = actualData[i];
        if (trendsChannel === 'amazon' && (period.amazonRev > 0 || period.amazonUnits > 0)) {
          return period;
        }
        if (trendsChannel === 'shopify' && (period.shopifyRev > 0 || period.shopifyUnits > 0)) {
          return period;
        }
      }
      return actualData[actualData.length - 1]; // Fallback
    };
    
    const getPreviousWithChannelData = (latestIdx) => {
      if (trendsChannel === 'combined') {
        return actualData[actualData.length - 2];
      }
      const latestIndex = actualData.findIndex(d => d === latestIdx);
      for (let i = latestIndex - 1; i >= 0; i--) {
        const period = actualData[i];
        if (trendsChannel === 'amazon' && (period.amazonRev > 0 || period.amazonUnits > 0)) {
          return period;
        }
        if (trendsChannel === 'shopify' && (period.shopifyRev > 0 || period.shopifyUnits > 0)) {
          return period;
        }
      }
      return null;
    };
    
    const latestPeriod = getLatestWithChannelData();
    const prevPeriod = getPreviousWithChannelData(latestPeriod);
    
    // Apply channel filter to data - defined here so rangeTotals can use it
    const getFilteredValue = (d, field) => {
      if (trendsChannel === 'amazon') {
        if (field === 'revenue') return d.amazonRev || 0;
        if (field === 'profit') return d.amazonProfit || 0;
        if (field === 'units') return d.amazonUnits || 0;
      } else if (trendsChannel === 'shopify') {
        if (field === 'revenue') return d.shopifyRev || 0;
        if (field === 'profit') return d.shopifyProfit || 0;
        if (field === 'units') return d.shopifyUnits || 0;
      }
      return d[field] || 0;
    };
    
    // Also calculate totals for the entire selected range (for the selected channel)
    const rangeTotals = actualData.reduce((acc, d) => {
      acc.revenue += getFilteredValue(d, 'revenue');
      acc.profit += getFilteredValue(d, 'profit');
      acc.units += getFilteredValue(d, 'units');
      return acc;
    }, { revenue: 0, profit: 0, units: 0 });
    
    const calcChange = (current, previous) => {
      if (!previous || previous === 0) return null;
      return ((current - previous) / previous) * 100;
    };
    
    const ChangeIndicator = ({ current, previous }) => {
      const change = calcChange(current, previous);
      if (change === null) return <span className="text-slate-500 text-sm">â€”</span>;
      const isPositive = change > 0;
      const isNeutral = Math.abs(change) < 0.5;
      const color = isNeutral ? 'text-slate-400' : isPositive ? 'text-emerald-400' : 'text-rose-400';
      const Icon = isNeutral ? Minus : isPositive ? ArrowUpRight : ArrowDownRight;
      return (
        <span className={`flex items-center gap-1 text-sm ${color}`}>
          <Icon className="w-4 h-4" />
          {Math.abs(change).toFixed(1)}%
        </span>
      );
    };
    
    // Find max values for chart scaling
    const maxRevenue = Math.max(...currentData.map(d => d.revenue || 0), 1);
    const maxProfit = Math.max(...currentData.map(d => Math.abs(d.profit || 0)), 1);
    
    // Aggregate SKU trends
    const getSkuTrends = () => {
      const skuMap = {};
      currentData.forEach((period, idx) => {
        (period.skuData || []).forEach(sku => {
          const key = sku.sku || sku.title || 'Unknown';
          if (!skuMap[key]) {
            skuMap[key] = { sku: key, name: sku.title || sku.productName || key, periods: [], totalUnits: 0, totalProfit: 0 };
          }
          const profit = sku.netProceeds || ((sku.netSales || 0) - (sku.cogs || 0));
          const units = sku.unitsSold || 0;
          const ppu = units > 0 ? profit / units : 0;
          skuMap[key].periods.push({ idx, units, profit, ppu });
          skuMap[key].totalUnits += units;
          skuMap[key].totalProfit += profit;
        });
      });
      
      return Object.values(skuMap)
        .filter(s => s.periods.length >= 2 && s.totalUnits >= 3)
        .map(s => {
          const avgPPU = s.totalUnits > 0 ? s.totalProfit / s.totalUnits : 0;
          const recentPeriods = s.periods.slice(-Math.ceil(s.periods.length / 2));
          const olderPeriods = s.periods.slice(0, Math.floor(s.periods.length / 2));
          const recentPPU = recentPeriods.length > 0 ? recentPeriods.reduce((sum, p) => sum + p.ppu, 0) / recentPeriods.length : 0;
          const olderPPU = olderPeriods.length > 0 ? olderPeriods.reduce((sum, p) => sum + p.ppu, 0) / olderPeriods.length : recentPPU;
          const trend = olderPPU !== 0 ? ((recentPPU - olderPPU) / Math.abs(olderPPU)) * 100 : 0;
          return { ...s, avgPPU, recentPPU, olderPPU, trend };
        })
        .sort((a, b) => a.trend - b.trend);
    };
    
    const skuTrends = getSkuTrends();
    const decliningSkus = skuTrends.filter(s => s.trend < -10).slice(0, 8);
    const improvingSkus = skuTrends.filter(s => s.trend > 10).sort((a, b) => b.trend - a.trend).slice(0, 8);
    
    const periodLabel = trendsTab === 'daily' ? 'Daily' : trendsTab === 'weekly' ? 'Weekly' : trendsTab === 'monthly' ? 'Monthly' : 'Yearly';
    const periodLabelShort = trendsTab === 'daily' ? 'Day' : trendsTab === 'weekly' ? 'Week' : trendsTab === 'monthly' ? 'Month' : 'Year';
    const dataAvailable = currentData.length > 0;

    return (
      <div className="min-h-screen bg-slate-950 p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <NavTabs />
          {dataBar}
          
          <div className="mb-6">
            <h1 className="text-2xl lg:text-3xl font-bold text-white mb-2">ðŸ“ˆ Trends Dashboard</h1>
            <p className="text-slate-400">Performance trends across different time periods</p>
          </div>
          
          {/* Time Period Tabs */}
          <div className="flex flex-wrap gap-2 mb-4">
            <button 
              onClick={() => setTrendsTab('daily')}
              className={`px-4 py-2 rounded-lg font-medium transition-all ${trendsTab === 'daily' ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
            >
              ðŸ• Daily ({sortedDays.length})
            </button>
            <button 
              onClick={() => setTrendsTab('weekly')}
              className={`px-4 py-2 rounded-lg font-medium transition-all ${trendsTab === 'weekly' ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
            >
              ðŸ“… Weekly ({sortedWeeks.length})
            </button>
            <button 
              onClick={() => setTrendsTab('monthly')}
              className={`px-4 py-2 rounded-lg font-medium transition-all ${trendsTab === 'monthly' ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
            >
              ðŸ“Š Monthly ({monthlyTrends.length})
            </button>
            <button 
              onClick={() => setTrendsTab('yearly')}
              className={`px-4 py-2 rounded-lg font-medium transition-all ${trendsTab === 'yearly' ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
            >
              ðŸ“† Yearly ({yearlyTrends.length})
            </button>
          </div>
          
          {/* Channel Filter */}
          <div className="flex flex-wrap gap-2 mb-4 items-center">
            <span className="text-slate-400 text-sm mr-2">Channel:</span>
            <button 
              onClick={() => setTrendsChannel('combined')}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${trendsChannel === 'combined' ? 'bg-violet-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
            >
              All Channels
            </button>
            <button 
              onClick={() => setTrendsChannel('amazon')}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${trendsChannel === 'amazon' ? 'bg-orange-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
            >
              ðŸ›’ Amazon
            </button>
            <button 
              onClick={() => setTrendsChannel('shopify')}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${trendsChannel === 'shopify' ? 'bg-green-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
            >
              ðŸ›ï¸ Shopify
            </button>
          </div>
          
          {/* Date Range Filter */}
          <div className="flex flex-wrap gap-2 mb-6 items-center bg-slate-800/50 rounded-lg p-3 border border-slate-700">
            <span className="text-slate-400 text-sm mr-2">ðŸ“… Date Range:</span>
            <button 
              onClick={() => setTrendsDateRange({ start: null, end: null, preset: 'all' })}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${trendsDateRange.preset === 'all' ? 'bg-cyan-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
            >
              All Time
            </button>
            <button 
              onClick={() => {
                const now = new Date();
                const start = `${now.getFullYear()}-01-01`;
                const end = `${now.getFullYear()}-12-31`;
                setTrendsDateRange({ start, end, preset: 'ytd' });
              }}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${trendsDateRange.preset === 'ytd' ? 'bg-cyan-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
            >
              {new Date().getFullYear()}
            </button>
            <button 
              onClick={() => {
                const lastYear = new Date().getFullYear() - 1;
                setTrendsDateRange({ start: `${lastYear}-01-01`, end: `${lastYear}-12-31`, preset: 'lastyear' });
              }}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${trendsDateRange.preset === 'lastyear' ? 'bg-cyan-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
            >
              {new Date().getFullYear() - 1}
            </button>
            <button 
              onClick={() => {
                const now = new Date();
                const end = now.toISOString().split('T')[0];
                const start = new Date(now.setDate(now.getDate() - 30)).toISOString().split('T')[0];
                setTrendsDateRange({ start, end, preset: 'last30' });
              }}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${trendsDateRange.preset === 'last30' ? 'bg-cyan-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
            >
              Last 30 Days
            </button>
            <button 
              onClick={() => {
                const now = new Date();
                const end = now.toISOString().split('T')[0];
                const start = new Date(now.setDate(now.getDate() - 90)).toISOString().split('T')[0];
                setTrendsDateRange({ start, end, preset: 'last90' });
              }}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${trendsDateRange.preset === 'last90' ? 'bg-cyan-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
            >
              Last 90 Days
            </button>
            
            {/* Custom Date Range */}
            <div className="flex items-center gap-2 ml-2 border-l border-slate-600 pl-3">
              <input 
                type="date" 
                value={trendsDateRange.start || ''} 
                onChange={(e) => setTrendsDateRange(prev => ({ ...prev, start: e.target.value, preset: 'custom' }))}
                className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white"
              />
              <span className="text-slate-500">to</span>
              <input 
                type="date" 
                value={trendsDateRange.end || ''} 
                onChange={(e) => setTrendsDateRange(prev => ({ ...prev, end: e.target.value, preset: 'custom' }))}
                className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white"
              />
            </div>
          </div>
          
          {!dataAvailable ? (
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-12 text-center">
              <Database className="w-16 h-16 text-slate-600 mx-auto mb-4" />
              <h3 className="text-xl font-semibold text-white mb-2">No {periodLabel} Data Available</h3>
              <p className="text-slate-400 mb-4">Upload {trendsTab} data to see trends</p>
              {trendsTab === 'daily' && (
                <button onClick={() => { setUploadTab('daily'); setView('upload'); }} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-white">
                  Upload Daily Data
                </button>
              )}
            </div>
          ) : (
            <>
              {/* Channel indicator */}
              {trendsChannel !== 'combined' && (
                <div className={`mb-4 px-4 py-2 rounded-lg inline-flex items-center gap-2 ${trendsChannel === 'amazon' ? 'bg-orange-900/30 border border-orange-500/30 text-orange-300' : 'bg-green-900/30 border border-green-500/30 text-green-300'}`}>
                  <span className="text-sm">Showing {trendsChannel === 'amazon' ? 'Amazon' : 'Shopify'} data only</span>
                  <button onClick={() => setTrendsChannel('combined')} className="text-xs underline opacity-70 hover:opacity-100">Show all</button>
                </div>
              )}
              
              {/* Summary Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                  <p className="text-slate-400 text-sm mb-1">
                    Revenue (Latest {periodLabelShort})
                    {latestPeriod?.label && <span className="text-slate-500 text-xs ml-1">â€¢ {latestPeriod.label}</span>}
                  </p>
                  <p className="text-2xl font-bold text-white">{formatCurrency(getFilteredValue(latestPeriod || {}, 'revenue'))}</p>
                  <div className="flex items-center justify-between mt-2">
                    <span className="text-slate-500 text-xs">vs previous</span>
                    <ChangeIndicator current={getFilteredValue(latestPeriod || {}, 'revenue')} previous={getFilteredValue(prevPeriod || {}, 'revenue')} />
                  </div>
                  {rangeTotals.revenue > 0 && actualData.length > 1 && (
                    <div className="mt-2 pt-2 border-t border-slate-700">
                      <span className="text-slate-500 text-xs">Range total ({actualData.length} {periodLabelShort.toLowerCase()}s): </span>
                      <span className="text-slate-300 text-xs font-medium">{formatCurrency(rangeTotals.revenue)}</span>
                    </div>
                  )}
                </div>
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                  <p className="text-slate-400 text-sm mb-1">Net Profit</p>
                  <p className={`text-2xl font-bold ${(getFilteredValue(latestPeriod || {}, 'profit')) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(getFilteredValue(latestPeriod || {}, 'profit'))}</p>
                  <div className="flex items-center justify-between mt-2">
                    <span className="text-slate-500 text-xs">vs previous</span>
                    <ChangeIndicator current={getFilteredValue(latestPeriod || {}, 'profit')} previous={getFilteredValue(prevPeriod || {}, 'profit')} />
                  </div>
                  {rangeTotals.profit !== 0 && actualData.length > 1 && (
                    <div className="mt-2 pt-2 border-t border-slate-700">
                      <span className="text-slate-500 text-xs">Range total: </span>
                      <span className={`text-xs font-medium ${rangeTotals.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(rangeTotals.profit)}</span>
                    </div>
                  )}
                </div>
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                  <p className="text-slate-400 text-sm mb-1">Units Sold</p>
                  <p className="text-2xl font-bold text-white">{formatNumber(getFilteredValue(latestPeriod || {}, 'units'))}</p>
                  <div className="flex items-center justify-between mt-2">
                    <span className="text-slate-500 text-xs">vs previous</span>
                    <ChangeIndicator current={getFilteredValue(latestPeriod || {}, 'units')} previous={getFilteredValue(prevPeriod || {}, 'units')} />
                  </div>
                  {rangeTotals.units > 0 && actualData.length > 1 && (
                    <div className="mt-2 pt-2 border-t border-slate-700">
                      <span className="text-slate-500 text-xs">Range total: </span>
                      <span className="text-slate-300 text-xs font-medium">{formatNumber(rangeTotals.units)}</span>
                    </div>
                  )}
                </div>
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                  <p className="text-slate-400 text-sm mb-1">Profit Margin</p>
                  {(() => {
                    const latestRev = getFilteredValue(latestPeriod || {}, 'revenue');
                    const latestProfit = getFilteredValue(latestPeriod || {}, 'profit');
                    const latestMargin = latestRev > 0 ? (latestProfit / latestRev) * 100 : 0;
                    const prevRev = getFilteredValue(prevPeriod || {}, 'revenue');
                    const prevProfit = getFilteredValue(prevPeriod || {}, 'profit');
                    const prevMargin = prevRev > 0 ? (prevProfit / prevRev) * 100 : 0;
                    const marginChange = latestMargin - prevMargin;
                    const rangeMargin = rangeTotals.revenue > 0 ? (rangeTotals.profit / rangeTotals.revenue) * 100 : 0;
                    return (
                      <>
                        <p className={`text-2xl font-bold ${latestMargin >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatPercent(latestMargin)}</p>
                        <div className="flex items-center justify-between mt-2">
                          <span className="text-slate-500 text-xs">vs previous</span>
                          {prevPeriod && <span className={`text-sm ${marginChange >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                            {marginChange >= 0 ? '+' : ''}{marginChange.toFixed(1)}pt
                          </span>}
                        </div>
                        {actualData.length > 1 && (
                          <div className="mt-2 pt-2 border-t border-slate-700">
                            <span className="text-slate-500 text-xs">Range avg: </span>
                            <span className={`text-xs font-medium ${rangeMargin >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatPercent(rangeMargin)}</span>
                          </div>
                        )}
                      </>
                    );
                  })()}
                </div>
              </div>
              
              {/* Revenue Trend Chart - Actual vs Forecast */}
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6 overflow-hidden">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-white">
                    {periodLabel} Revenue â€” Actual vs Forecast
                    {trendsChannel !== 'combined' && <span className="text-sm font-normal text-slate-400 ml-2">({trendsChannel === 'amazon' ? 'Amazon' : 'Shopify'})</span>}
                  </h3>
                  {/* Legend */}
                  <div className="flex items-center gap-4 text-xs">
                    <span className="flex items-center gap-1"><span className="w-3 h-3 bg-violet-500 rounded" />Actual</span>
                    <span className="flex items-center gap-1"><span className="w-3 h-3 bg-amber-500/60 rounded" />Forecast</span>
                    <span className="flex items-center gap-1"><span className="w-3 h-3 bg-amber-500/60 rounded" style={{ backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,0.2) 2px, rgba(0,0,0,0.2) 4px)' }} />Projected</span>
                  </div>
                </div>
                {(() => {
                  // Include forecast/projected values in max calculation for proper scaling
                  const allValues = currentData.flatMap(d => [
                    getFilteredValue(d, 'revenue'), 
                    d.forecastRevenue || 0,
                    d.projectedRevenue || 0
                  ]);
                  const chartMaxRevenue = Math.max(...allValues, 1);
                  const barMinWidth = currentData.length > 30 ? '4px' : currentData.length > 20 ? '8px' : '16px';
                  
                  // Calculate overall forecast accuracy (only for periods with actual data)
                  // Filter out outliers with extreme accuracy values (indicates bad forecast data)
                  const weeksWithForecasts = currentData.filter(d => 
                    d.forecastRevenue !== null && d.revenue > 0 && 
                    d.accuracy !== null && d.accuracy > -100 // Filter out extreme outliers
                  );
                  const avgAccuracy = weeksWithForecasts.length > 0 
                    ? Math.max(-100, Math.min(100, weeksWithForecasts.reduce((s, d) => s + (d.accuracy || 0), 0) / weeksWithForecasts.length))
                    : null;
                  
                  // Count projected periods
                  const projectedPeriods = currentData.filter(d => d.isProjected);
                  
                  return (
                    <>
                      {/* Accuracy Summary */}
                      {avgAccuracy !== null && (
                        <div className="flex items-center gap-4 mb-3 text-sm">
                          <span className="text-slate-400">
                            Forecast Accuracy: <span className={`font-medium ${avgAccuracy >= 90 ? 'text-emerald-400' : avgAccuracy >= 80 ? 'text-amber-400' : 'text-rose-400'}`}>
                              {avgAccuracy.toFixed(1)}%
                            </span>
                          </span>
                          <span className="text-slate-500">({weeksWithForecasts.length} periods with forecasts)</span>
                        </div>
                      )}
                      {projectedPeriods.length > 0 && (
                        <div className="flex items-center gap-4 mb-3 text-sm">
                          <span className="text-amber-400/80">
                            {projectedPeriods.some(p => p.forecastSource?.startsWith('ai')) 
                              ? `ðŸ¤– ${projectedPeriods.length} AI-projected periods` 
                              : `ðŸ“Š ${projectedPeriods.length} projected periods`}
                            {(enhancedForecast || generateForecast)?.confidence && 
                              <span className="text-violet-400 ml-2">({(enhancedForecast || generateForecast).confidence}% confidence)</span>
                            }
                          </span>
                        </div>
                      )}
                      
                      {/* Chart bars - stacked/grouped for forecast vs actual */}
                      <div className="relative flex items-end gap-1 h-48 bg-slate-900/30 rounded-lg p-3">
                        {currentData.length === 0 ? (
                          <p className="text-slate-500 text-center w-full self-center">No data available</p>
                        ) : currentData.map((d, i) => {
                          const actualValue = getFilteredValue(d, 'revenue');
                          const forecastValue = d.forecastRevenue || d.projectedRevenue || 0;
                          const isProjected = d.isProjected;
                          const actualHeight = chartMaxRevenue > 0 ? (actualValue / chartMaxRevenue) * 100 : 0;
                          const projectedHeight = chartMaxRevenue > 0 ? (forecastValue / chartMaxRevenue) * 100 : 0;
                          const isLatest = i === currentData.filter(x => !x.isProjected).length - 1;
                          const isClickable = trendsTab === 'daily' && d.key && !isProjected;
                          const hasForecast = forecastValue > 0;
                          const variance = hasForecast && actualValue > 0 ? actualValue - forecastValue : null;
                          const variancePct = hasForecast && forecastValue > 0 && actualValue > 0 ? ((variance / forecastValue) * 100) : null;
                          
                          return (
                            <div 
                              key={d.key || i} 
                              className={`flex-1 flex items-end justify-center group relative h-full ${isClickable ? 'cursor-pointer' : ''}`}
                              style={{ minWidth: barMinWidth, maxWidth: '60px' }}
                              onClick={() => isClickable && setViewingDayDetails(d.key)}
                            >
                              {/* Tooltip */}
                              <div className="absolute -top-16 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-700 text-white text-xs px-2 py-1.5 rounded whitespace-nowrap z-50 pointer-events-none shadow-lg">
                                <p className="font-medium">{d.label} {isProjected && <span className="text-amber-400">(Projected)</span>}</p>
                                {isProjected ? (
                                  <>
                                    <p className="text-amber-400">Projected: {formatCurrency(forecastValue)}</p>
                                    <p className="text-slate-400 text-[10px]">
                                      {d.forecastSource === 'ai-amazon' ? 'ðŸ¤– AI + Amazon forecast' :
                                       d.forecastSource === 'ai-trend' ? 'ðŸ¤– AI trend forecast' :
                                       d.forecastSource === 'ai-forecast' ? 'ðŸ¤– AI forecast model' :
                                       d.forecastSource === 'amazon' ? 'Amazon forecast' : 
                                       d.forecastSource === 'average' ? 'Based on average' :
                                       d.growthRate ? `${(d.growthRate * 100).toFixed(1)}% MoM trend` : 'Based on trend'}
                                    </p>
                                    {d.aiConfidence && <p className="text-violet-400 text-[10px]">{d.aiConfidence}% confidence</p>}
                                  </>
                                ) : (
                                  <>
                                    <p>Actual: {formatCurrency(actualValue)}</p>
                                    {hasForecast && (
                                      <>
                                        <p className="text-amber-400">Forecast: {formatCurrency(forecastValue)}</p>
                                        {variance !== null && (
                                          <p className={variance >= 0 ? 'text-emerald-400' : 'text-rose-400'}>
                                            {variance >= 0 ? 'â–²' : 'â–¼'} {formatCurrency(Math.abs(variance))} ({variancePct >= 0 ? '+' : ''}{variancePct?.toFixed(1)}%)
                                          </p>
                                        )}
                                      </>
                                    )}
                                  </>
                                )}
                                {isClickable && <span className="text-cyan-400 block text-center mt-1">Click for details</span>}
                              </div>
                              
                              {/* Bars container */}
                              <div className="w-full flex items-end justify-center gap-0.5 h-full">
                                {isProjected ? (
                                  /* Projected period - only show amber bar with striped pattern */
                                  <div 
                                    className="w-3/4 rounded-t transition-all relative z-10 bg-amber-500/60"
                                    style={{ 
                                      height: `${projectedHeight}%`, 
                                      minHeight: projectedHeight > 0 ? '4px' : '0',
                                      backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(0,0,0,0.1) 3px, rgba(0,0,0,0.1) 6px)'
                                    }}
                                  />
                                ) : (
                                  <>
                                    {/* Forecast bar (behind, wider, more transparent) */}
                                    {hasForecast && (
                                      <div 
                                        className="absolute bottom-0 w-full bg-amber-500/40 rounded-t"
                                        style={{ height: `${projectedHeight}%`, minHeight: projectedHeight > 0 ? '4px' : '0' }}
                                      />
                                    )}
                                    {/* Actual bar (front, narrower) */}
                                    <div 
                                      className={`w-3/4 rounded-t transition-all relative z-10 ${
                                        isLatest ? 'bg-violet-500' : 'bg-violet-500/80'
                                      } hover:bg-violet-400`}
                                      style={{ height: `${actualHeight}%`, minHeight: actualHeight > 0 ? '4px' : '0' }}
                                    />
                                  </>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                      {/* X-axis labels - outside chart area */}
                      <div className="flex gap-1 mt-1 px-3">
                        {currentData.length === 0 ? null : currentData.length <= 12 ? (
                          currentData.map((d, i) => (
                            <div key={d.key || i} className="flex-1 text-center" style={{ minWidth: barMinWidth, maxWidth: '60px' }}>
                              <span className="text-[10px] text-slate-500 truncate block">{d.label}</span>
                            </div>
                          ))
                        ) : (
                          /* Show all flex items but only first/last labels for alignment */
                          currentData.map((d, i) => (
                            <div key={d.key || i} className="flex-1 text-center" style={{ minWidth: barMinWidth, maxWidth: '60px' }}>
                              {(i === 0 || i === currentData.length - 1) && (
                                <span className="text-[10px] text-slate-500">{d.label}</span>
                              )}
                            </div>
                          ))
                        )}
                      </div>
                    </>
                  );
                })()}
              </div>
              
              {/* Forecast Accuracy History Panel - only show if we have forecast data */}
              {trendsTab === 'weekly' && currentData.some(d => d.forecastRevenue !== null) && (
                <div className="bg-gradient-to-r from-amber-900/20 to-orange-900/20 rounded-xl border border-amber-500/30 p-5 mb-6">
                  <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <Target className="w-5 h-5 text-amber-400" />
                    Forecast Accuracy History
                  </h3>
                  
                  {(() => {
                    const weeksWithForecasts = currentData.filter(d => d.forecastRevenue !== null && d.revenue > 0);
                    if (weeksWithForecasts.length === 0) return <p className="text-slate-400">No forecast data available yet.</p>;
                    
                    // Calculate stats
                    const accuracies = weeksWithForecasts.map(d => d.accuracy || 0);
                    const avgAccuracy = accuracies.reduce((s, a) => s + a, 0) / accuracies.length;
                    const variances = weeksWithForecasts.map(d => d.variance || 0);
                    const avgVariance = variances.reduce((s, v) => s + v, 0) / variances.length;
                    const bias = avgVariance > 0 ? 'under-forecasting' : avgVariance < 0 ? 'over-forecasting' : 'neutral';
                    
                    // Trend - compare recent vs older
                    const recentAccuracies = accuracies.slice(-3);
                    const olderAccuracies = accuracies.slice(0, -3);
                    const recentAvg = recentAccuracies.length > 0 ? recentAccuracies.reduce((s, a) => s + a, 0) / recentAccuracies.length : avgAccuracy;
                    const olderAvg = olderAccuracies.length > 0 ? olderAccuracies.reduce((s, a) => s + a, 0) / olderAccuracies.length : avgAccuracy;
                    const improving = recentAvg > olderAvg;
                    
                    return (
                      <>
                        {/* Stats Row */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                          <div className="bg-slate-800/50 rounded-lg p-3">
                            <p className="text-slate-400 text-xs mb-1">Average Accuracy</p>
                            <p className={`text-2xl font-bold ${avgAccuracy >= 90 ? 'text-emerald-400' : avgAccuracy >= 80 ? 'text-amber-400' : 'text-rose-400'}`}>
                              {avgAccuracy.toFixed(1)}%
                            </p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3">
                            <p className="text-slate-400 text-xs mb-1">Avg Variance</p>
                            <p className={`text-2xl font-bold ${avgVariance >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                              {avgVariance >= 0 ? '+' : ''}{formatCurrency(avgVariance)}
                            </p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3">
                            <p className="text-slate-400 text-xs mb-1">Bias Direction</p>
                            <p className={`text-lg font-bold ${bias === 'under-forecasting' ? 'text-emerald-400' : bias === 'over-forecasting' ? 'text-rose-400' : 'text-slate-400'}`}>
                              {bias === 'under-forecasting' ? 'ðŸ“ˆ Under' : bias === 'over-forecasting' ? 'ðŸ“‰ Over' : 'âš–ï¸ Neutral'}
                            </p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3">
                            <p className="text-slate-400 text-xs mb-1">Trend</p>
                            <p className={`text-lg font-bold ${improving ? 'text-emerald-400' : 'text-amber-400'}`}>
                              {improving ? 'ðŸ“ˆ Improving' : 'ðŸ“‰ Declining'}
                            </p>
                          </div>
                        </div>
                        
                        {/* History Table */}
                        <div className="overflow-x-auto max-h-48">
                          <table className="w-full text-sm">
                            <thead className="sticky top-0 bg-slate-800">
                              <tr className="border-b border-slate-700">
                                <th className="text-left text-slate-400 py-2 px-2">Week</th>
                                <th className="text-right text-slate-400 py-2 px-2">Forecast</th>
                                <th className="text-right text-slate-400 py-2 px-2">Actual</th>
                                <th className="text-right text-slate-400 py-2 px-2">Variance</th>
                                <th className="text-right text-slate-400 py-2 px-2">Accuracy</th>
                              </tr>
                            </thead>
                            <tbody>
                              {weeksWithForecasts.slice().reverse().map(d => (
                                <tr key={d.key} className="border-b border-slate-700/50">
                                  <td className="py-2 px-2 text-white">{d.label}</td>
                                  <td className="py-2 px-2 text-right text-amber-400">{formatCurrency(d.forecastRevenue)}</td>
                                  <td className="py-2 px-2 text-right text-violet-400">{formatCurrency(d.revenue)}</td>
                                  <td className={`py-2 px-2 text-right ${d.variance >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                    {d.variance >= 0 ? '+' : ''}{formatCurrency(d.variance)}
                                  </td>
                                  <td className={`py-2 px-2 text-right font-medium ${d.accuracy >= 90 ? 'text-emerald-400' : d.accuracy >= 80 ? 'text-amber-400' : 'text-rose-400'}`}>
                                    {d.accuracy?.toFixed(1)}%
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                        
                        <p className="text-slate-400 text-sm mt-3">
                          ðŸ’¡ <strong>Insight:</strong> {bias === 'under-forecasting' 
                            ? 'Forecasts are typically lower than actual â€” consider adjusting models upward or you\'re outperforming expectations!' 
                            : bias === 'over-forecasting' 
                              ? 'Forecasts are typically higher than actual â€” consider adjusting models downward or review what\'s impacting sales.'
                              : 'Forecasts are well-calibrated to actual results.'}
                        </p>
                      </>
                    );
                  })()}
                </div>
              )}
              
              {/* Profit & Margin Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* Profit Trend */}
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 overflow-hidden">
                  <h3 className="text-lg font-semibold text-white mb-4">
                    {periodLabel} Profit Trend
                    {trendsChannel !== 'combined' && <span className="text-sm font-normal text-slate-400 ml-2">({trendsChannel === 'amazon' ? 'Amazon' : 'Shopify'})</span>}
                  </h3>
                  {(() => {
                    const allProfitValues = currentData.flatMap(d => [
                      Math.abs(getFilteredValue(d, 'profit')),
                      Math.abs(d.projectedProfit || 0)
                    ]);
                    const chartMaxProfit = Math.max(...allProfitValues, 1);
                    const barMinWidth = currentData.length > 30 ? '4px' : currentData.length > 20 ? '8px' : '16px';
                    return (
                      <>
                        <div className="relative flex items-end gap-1 h-48 bg-slate-900/30 rounded-lg p-3">
                          {currentData.length === 0 ? (
                            <p className="text-slate-500 text-center w-full self-center">No data</p>
                          ) : currentData.map((d, i) => {
                            const actualProfit = getFilteredValue(d, 'profit');
                            const projectedProfit = d.projectedProfit || 0;
                            const isProjected = d.isProjected;
                            const displayValue = isProjected ? projectedProfit : actualProfit;
                            const height = chartMaxProfit > 0 ? (Math.abs(displayValue) / chartMaxProfit) * 100 : 0;
                            const isPositive = displayValue >= 0;
                            const isLatest = !isProjected && i === currentData.filter(x => !x.isProjected).length - 1;
                            const isClickable = trendsTab === 'daily' && d.key && !isProjected;
                            return (
                              <div 
                                key={d.key || i} 
                                className={`flex-1 flex items-end justify-center group relative h-full ${isClickable ? 'cursor-pointer' : ''}`}
                                style={{ minWidth: barMinWidth, maxWidth: '60px' }}
                                onClick={() => isClickable && setViewingDayDetails(d.key)}
                              >
                                <div className="absolute -top-12 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-700 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-50 pointer-events-none shadow-lg">
                                  {d.label} {isProjected && <span className="text-amber-400">(Projected)</span>}<br/>
                                  {isProjected ? <span className="text-amber-400">{formatCurrency(projectedProfit)}</span> : formatCurrency(actualProfit)}
                                  {isClickable && <span className="text-cyan-400 block text-center mt-1">Click for details</span>}
                                </div>
                                <div 
                                  className={`w-full rounded-t transition-all ${
                                    isProjected 
                                      ? (isPositive ? 'bg-emerald-500/50' : 'bg-rose-500/50')
                                      : isPositive 
                                        ? (isLatest ? 'bg-emerald-500' : 'bg-emerald-500/70') 
                                        : (isLatest ? 'bg-rose-500' : 'bg-rose-500/70')
                                  } ${!isProjected && 'hover:bg-emerald-400'}`}
                                  style={{ 
                                    height: `${height}%`, 
                                    minHeight: height > 0 ? '4px' : '0',
                                    ...(isProjected && { backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(0,0,0,0.1) 3px, rgba(0,0,0,0.1) 6px)' })
                                  }}
                                />
                              </div>
                            );
                          })}
                        </div>
                        {/* X-axis labels */}
                        <div className="flex gap-1 mt-1 px-3">
                          {currentData.length === 0 ? null : currentData.length <= 12 ? (
                            currentData.map((d, i) => (
                              <div key={d.key || i} className="flex-1 text-center" style={{ minWidth: barMinWidth, maxWidth: '60px' }}>
                                <span className="text-[10px] text-slate-500 truncate block">{d.label}</span>
                              </div>
                            ))
                          ) : (
                            /* Show all flex items but only first/last labels for alignment */
                            currentData.map((d, i) => (
                              <div key={d.key || i} className="flex-1 text-center" style={{ minWidth: barMinWidth, maxWidth: '60px' }}>
                                {(i === 0 || i === currentData.length - 1) && (
                                  <span className="text-[10px] text-slate-500">{d.label}</span>
                                )}
                              </div>
                            ))
                          )}
                        </div>
                      </>
                    );
                  })()}
                </div>
                
                {/* Margin Trend */}
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 overflow-hidden">
                  <h3 className="text-lg font-semibold text-white mb-4">{periodLabel} Margin Trend</h3>
                  {(() => {
                    // Calculate margin from filtered values, including projections
                    const marginData = currentData.map(d => {
                      if (d.isProjected) {
                        return d.projectedMargin || 0;
                      }
                      const rev = getFilteredValue(d, 'revenue');
                      const prof = getFilteredValue(d, 'profit');
                      return rev > 0 ? (prof / rev) * 100 : 0;
                    });
                    const maxMargin = Math.max(...marginData.map(Math.abs), 1);
                    const barMinWidth = currentData.length > 30 ? '4px' : currentData.length > 20 ? '8px' : '16px';
                    return (
                      <>
                        <div className="relative flex items-end gap-1 h-48 bg-slate-900/30 rounded-lg p-3">
                          {currentData.length === 0 ? (
                            <p className="text-slate-500 text-center w-full self-center">No data</p>
                          ) : currentData.map((d, i) => {
                            const margin = marginData[i];
                            const height = (Math.abs(margin) / maxMargin) * 100;
                            const isPositive = margin >= 0;
                            const isProjected = d.isProjected;
                            const isLatest = !isProjected && i === currentData.filter(x => !x.isProjected).length - 1;
                            const isClickable = trendsTab === 'daily' && d.key && !isProjected;
                            return (
                              <div 
                                key={d.key || i} 
                                className={`flex-1 flex items-end justify-center group relative h-full ${isClickable ? 'cursor-pointer' : ''}`}
                                style={{ minWidth: barMinWidth, maxWidth: '60px' }}
                                onClick={() => isClickable && setViewingDayDetails(d.key)}
                              >
                                <div className="absolute -top-12 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-700 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-50 pointer-events-none shadow-lg">
                                  {d.label} {isProjected && <span className="text-amber-400">(Projected)</span>}<br/>
                                  {isProjected ? <span className="text-amber-400">{formatPercent(margin)}</span> : formatPercent(margin)}
                                  {isClickable && <span className="text-cyan-400 block text-center mt-1">Click for details</span>}
                                </div>
                                <div 
                                  className={`w-full rounded-t transition-all ${
                                    isProjected 
                                      ? (isPositive ? 'bg-cyan-500/50' : 'bg-rose-500/50')
                                      : isPositive 
                                        ? (isLatest ? 'bg-cyan-500' : 'bg-cyan-500/70') 
                                        : (isLatest ? 'bg-rose-500' : 'bg-rose-500/70')
                                  } ${!isProjected && 'hover:bg-cyan-400'}`}
                                  style={{ 
                                    height: `${height}%`, 
                                    minHeight: height > 0 ? '4px' : '0',
                                    ...(isProjected && { backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(0,0,0,0.1) 3px, rgba(0,0,0,0.1) 6px)' })
                                  }}
                                />
                              </div>
                            );
                          })}
                        </div>
                        {/* X-axis labels */}
                        <div className="flex gap-1 mt-1 px-3">
                          {currentData.length === 0 ? null : currentData.length <= 12 ? (
                            currentData.map((d, i) => (
                              <div key={d.key || i} className="flex-1 text-center" style={{ minWidth: barMinWidth, maxWidth: '60px' }}>
                                <span className="text-[10px] text-slate-500 truncate block">{d.label}</span>
                              </div>
                            ))
                          ) : (
                            /* Show all flex items but only first/last labels for alignment */
                            currentData.map((d, i) => (
                              <div key={d.key || i} className="flex-1 text-center" style={{ minWidth: barMinWidth, maxWidth: '60px' }}>
                                {(i === 0 || i === currentData.length - 1) && (
                                  <span className="text-[10px] text-slate-500">{d.label}</span>
                                )}
                              </div>
                            ))
                          )}
                        </div>
                      </>
                    );
                  })()}
                </div>
              </div>
              
              {/* Profit Per Unit Trend */}
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6 overflow-hidden">
                <h3 className="text-lg font-semibold text-white mb-4">ðŸ’µ Profit Per Unit Trend</h3>
                {(() => {
                  // Calculate profit per unit from filtered values
                  const ppuData = currentData.map(d => {
                    const units = getFilteredValue(d, 'units');
                    const profit = getFilteredValue(d, 'profit');
                    return units > 0 ? profit / units : 0;
                  });
                  const maxPPU = Math.max(...ppuData.map(Math.abs), 1);
                  // Match Revenue Trend sizing
                  const barMinWidth = currentData.length > 30 ? '4px' : currentData.length > 20 ? '8px' : '16px';
                  return (
                    <>
                      <div className="relative flex items-end gap-1 h-48 bg-slate-900/30 rounded-lg p-3">
                        {currentData.length === 0 ? (
                          <p className="text-slate-500 text-center w-full self-center">No data</p>
                        ) : currentData.map((d, i) => {
                          const ppu = ppuData[i];
                          const height = maxPPU > 0 ? (Math.abs(ppu) / maxPPU) * 100 : 0;
                          const isPositive = ppu >= 0;
                          const isLatest = i === currentData.length - 1;
                          const isClickable = trendsTab === 'daily' && d.key;
                          return (
                            <div 
                              key={d.key || i} 
                              className={`flex-1 flex items-end justify-center group relative h-full ${isClickable ? 'cursor-pointer' : ''}`}
                              style={{ minWidth: barMinWidth, maxWidth: '60px' }}
                              onClick={() => isClickable && setViewingDayDetails(d.key)}
                            >
                              <div className="absolute -top-12 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-700 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-50 pointer-events-none shadow-lg">
                                {d.label}<br/>{formatCurrency(ppu)}/unit
                                {isClickable && <span className="text-cyan-400 block text-center mt-1">Click for details</span>}
                              </div>
                              <div 
                                className={`w-full rounded-t transition-all ${isPositive ? (isLatest ? 'bg-amber-500' : 'bg-amber-500/70') : (isLatest ? 'bg-rose-500' : 'bg-rose-500/70')} hover:bg-amber-400`}
                                style={{ height: `${height}%`, minHeight: height > 0 ? '4px' : '0' }}
                              />
                            </div>
                          );
                        })}
                      </div>
                      {/* X-axis labels */}
                      <div className="flex gap-1 mt-1 px-3">
                        {currentData.length === 0 ? null : currentData.length <= 12 ? (
                          currentData.map((d, i) => (
                            <div key={d.key || i} className="flex-1 text-center" style={{ minWidth: barMinWidth, maxWidth: '60px' }}>
                              <span className="text-[10px] text-slate-500 truncate block">{d.label}</span>
                            </div>
                          ))
                        ) : (
                          /* Show all flex items but only first/last labels for alignment */
                          currentData.map((d, i) => (
                            <div key={d.key || i} className="flex-1 text-center" style={{ minWidth: barMinWidth, maxWidth: '60px' }}>
                              {(i === 0 || i === currentData.length - 1) && (
                                <span className="text-[10px] text-slate-500">{d.label}</span>
                              )}
                            </div>
                          ))
                        )}
                      </div>
                      <div className="flex justify-between text-xs text-slate-500 mt-2 px-2">
                        <span>Avg: {formatCurrency(ppuData.reduce((a, b) => a + b, 0) / (ppuData.length || 1))}/unit</span>
                        <span>Latest: {formatCurrency(ppuData[ppuData.length - 1] || 0)}/unit</span>
                      </div>
                    </>
                  );
                })()}
              </div>
              
              {/* Data Table */}
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6">
                <h3 className="text-lg font-semibold text-white mb-4">{periodLabel} Summary</h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="border-b border-slate-700">
                        <th className="text-left text-slate-400 font-medium py-2">{periodLabel}</th>
                        <th className="text-right text-slate-400 font-medium py-2">Revenue</th>
                        <th className="text-right text-slate-400 font-medium py-2">Profit</th>
                        <th className="text-right text-slate-400 font-medium py-2">Units</th>
                        <th className="text-right text-slate-400 font-medium py-2">Margin</th>
                        <th className="text-right text-slate-400 font-medium py-2">$/Unit</th>
                        <th className="text-right text-slate-400 font-medium py-2">Source</th>
                      </tr>
                    </thead>
                    <tbody>
                      {currentData.slice().reverse().map((d, idx) => {
                        const prev = currentData[currentData.length - idx - 2];
                        // Use filtered values
                        const rev = getFilteredValue(d, 'revenue');
                        const profit = getFilteredValue(d, 'profit');
                        const units = getFilteredValue(d, 'units');
                        const margin = rev > 0 ? (profit / rev) * 100 : 0;
                        const ppu = units > 0 ? profit / units : 0;
                        
                        const prevRev = prev ? getFilteredValue(prev, 'revenue') : 0;
                        const prevProfit = prev ? getFilteredValue(prev, 'profit') : 0;
                        const prevUnits = prev ? getFilteredValue(prev, 'units') : 0;
                        const prevMargin = prevRev > 0 ? (prevProfit / prevRev) * 100 : 0;
                        const prevPPU = prevUnits > 0 ? prevProfit / prevUnits : null;
                        
                        const marginChange = prev ? margin - prevMargin : null;
                        const ppuChange = prevPPU !== null && prevPPU !== 0 ? ((ppu - prevPPU) / Math.abs(prevPPU)) * 100 : null;
                        return (
                          <tr key={d.key} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                            <td className="py-2 text-white font-medium">{d.label}</td>
                            <td className="py-2 text-right text-white">{formatCurrency(rev)}</td>
                            <td className={`py-2 text-right ${profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(profit)}</td>
                            <td className="py-2 text-right text-white">{formatNumber(units)}</td>
                            <td className={`py-2 text-right ${margin >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                              {formatPercent(margin)}
                              {marginChange !== null && <span className={`ml-1 text-xs ${marginChange >= 0 ? 'text-emerald-300' : 'text-rose-300'}`}>({marginChange >= 0 ? '+' : ''}{marginChange.toFixed(1)}pt)</span>}
                            </td>
                            <td className={`py-2 text-right ${ppu >= 0 ? 'text-amber-400' : 'text-rose-400'}`}>
                              {formatCurrency(ppu)}
                              {ppuChange !== null && <span className={`ml-1 text-xs ${ppuChange >= 0 ? 'text-emerald-300' : 'text-rose-300'}`}>({ppuChange >= 0 ? '+' : ''}{ppuChange.toFixed(1)}%)</span>}
                            </td>
                            <td className="py-2 text-right text-slate-500 text-xs">{d.source}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
              
              {/* SKU Profit/Unit Trends */}
              {(decliningSkus.length > 0 || improvingSkus.length > 0) && (
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                  <h3 className="text-lg font-semibold text-white mb-4">ðŸ” SKU Profit/Unit Trends</h3>
                  <p className="text-slate-400 text-sm mb-4">Comparing recent vs earlier {periodLabel.toLowerCase()}s to identify margin changes</p>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {decliningSkus.length > 0 && (
                      <div>
                        <h4 className="text-rose-400 font-medium mb-3 flex items-center gap-2">
                          <TrendingDown className="w-4 h-4" />âš ï¸ Margin Declining ({decliningSkus.length})
                        </h4>
                        <div className="space-y-2 max-h-80 overflow-y-auto">
                          {decliningSkus.map(sku => (
                            <div key={sku.sku} className="bg-rose-900/20 border border-rose-500/30 rounded-lg p-3">
                              <div className="flex justify-between items-start">
                                <div className="flex-1 min-w-0">
                                  <p className="text-white text-sm font-medium truncate">{sku.name}</p>
                                  <p className="text-slate-400 text-xs truncate">{sku.sku}</p>
                                </div>
                                <div className="text-right ml-2">
                                  <p className="text-rose-400 font-bold">{sku.trend.toFixed(1)}%</p>
                                </div>
                              </div>
                              <div className="flex justify-between mt-2 text-xs">
                                <span className="text-slate-400">Before: {formatCurrency(sku.olderPPU)}/unit</span>
                                <span className="text-rose-300">Now: {formatCurrency(sku.recentPPU)}/unit</span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {improvingSkus.length > 0 && (
                      <div>
                        <h4 className="text-emerald-400 font-medium mb-3 flex items-center gap-2">
                          <TrendingUp className="w-4 h-4" />âœ… Margin Improving ({improvingSkus.length})
                        </h4>
                        <div className="space-y-2 max-h-80 overflow-y-auto">
                          {improvingSkus.map(sku => (
                            <div key={sku.sku} className="bg-emerald-900/20 border border-emerald-500/30 rounded-lg p-3">
                              <div className="flex justify-between items-start">
                                <div className="flex-1 min-w-0">
                                  <p className="text-white text-sm font-medium truncate">{sku.name}</p>
                                  <p className="text-slate-400 text-xs truncate">{sku.sku}</p>
                                </div>
                                <div className="text-right ml-2">
                                  <p className="text-emerald-400 font-bold">+{sku.trend.toFixed(1)}%</p>
                                </div>
                              </div>
                              <div className="flex justify-between mt-2 text-xs">
                                <span className="text-slate-400">Before: {formatCurrency(sku.olderPPU)}/unit</span>
                                <span className="text-emerald-300">Now: {formatCurrency(sku.recentPPU)}/unit</span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </>
          )}
        </div>
      </div>
    );
  }

  // ==================== YEAR-OVER-YEAR VIEW ====================
  if (view === 'yoy') {
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const weekYears = [...new Set(sortedWeeks.map(w => w.substring(0, 4)))].sort();
    
    // Check for annual periods (labeled as "2024", "2025", etc.)
    const periodYears = Object.keys(allPeriodsData).filter(k => /^\d{4}$/.test(k)).sort();
    
    // Also extract years from monthly periods like "January 2025", "Feb 2024", "Dec '25", etc.
    const monthlyPeriodYears = [];
    Object.keys(allPeriodsData).forEach(k => {
      // Try 4-digit year first
      let match = k.match(/\b(20\d{2})\b/);
      if (match) {
        monthlyPeriodYears.push(match[1]);
      } else {
        // Try 2-digit year (e.g., '25 or -25)
        match = k.match(/[''\-](\d{2})$/);
        if (match) {
          const shortYear = match[1];
          const fullYear = shortYear >= '50' ? '19' + shortYear : '20' + shortYear;
          monthlyPeriodYears.push(fullYear);
        }
      }
    });
    
    const allYears = [...new Set([...weekYears, ...periodYears, ...monthlyPeriodYears])].sort();
    
    const currentYear = allYears[allYears.length - 1];
    const previousYear = allYears.length > 1 ? allYears[allYears.length - 2] : null;
    
    // Get year data - prioritize period data if available, otherwise use weekly
    const getYearData = (year) => {
      // Check if we have a period for this year
      if (allPeriodsData[year]) {
        const p = allPeriodsData[year];
        return {
          source: 'period',
          label: p.label,
          weeks: 0,
          revenue: p.total?.revenue || 0,
          profit: p.total?.netProfit || 0,
          units: p.total?.units || 0,
          amazonRev: p.amazon?.revenue || 0,
          shopifyRev: p.shopify?.revenue || 0,
          adSpend: p.total?.adSpend || 0,
          cogs: p.total?.cogs || 0,
        };
      }
      // Fall back to weekly data
      const yearWeeks = sortedWeeks.filter(w => w.startsWith(year));
      return {
        source: 'weekly',
        label: `${year} (${yearWeeks.length} weeks)`,
        weeks: yearWeeks.length,
        revenue: yearWeeks.reduce((sum, w) => sum + (allWeeksData[w].total?.revenue || 0), 0),
        profit: yearWeeks.reduce((sum, w) => sum + (allWeeksData[w].total?.netProfit || 0), 0),
        units: yearWeeks.reduce((sum, w) => sum + (allWeeksData[w].total?.units || 0), 0),
        amazonRev: yearWeeks.reduce((sum, w) => sum + (allWeeksData[w].amazon?.revenue || 0), 0),
        shopifyRev: yearWeeks.reduce((sum, w) => sum + (allWeeksData[w].shopify?.revenue || 0), 0),
        adSpend: yearWeeks.reduce((sum, w) => sum + (allWeeksData[w].total?.adSpend || 0), 0),
        cogs: yearWeeks.reduce((sum, w) => sum + (allWeeksData[w].total?.cogs || 0), 0),
      };
    };
    
    const currentYearData = currentYear ? getYearData(currentYear) : null;
    const previousYearData = previousYear ? getYearData(previousYear) : null;
    
    // Month-over-month YoY comparison - use EXACT same logic as Trends getMonthlyTrends
    // First build ALL monthly data same as Trends, then filter by year
    const buildAllMonthlyData = () => {
      const monthData = {};
      
      // Identify monthly periods same as Trends
      const monthlyPeriods = Object.keys(allPeriodsData).filter(p => {
        return /^(january|february|march|april|may|june|july|august|september|october|november|december)-?\d{4}$/i.test(p) ||
               /^\d{4}-\d{2}$/.test(p) ||
               /^[a-z]+-\d{4}$/i.test(p);
      });
      
      // First, add period data for months (EXACT copy from Trends)
      monthlyPeriods.forEach(p => {
        const data = allPeriodsData[p];
        let monthKey = p;
        const monthNamesList = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
        monthNamesList.forEach((name, idx) => {
          if (p.toLowerCase().includes(name)) {
            const yearMatch = p.match(/\d{4}/);
            if (yearMatch) monthKey = `${yearMatch[0]}-${String(idx + 1).padStart(2, '0')}`;
          }
        });
        
        monthData[monthKey] = {
          key: p,
          source: 'period',
          revenue: data.total?.revenue || 0,
          profit: data.total?.netProfit || 0,
          units: data.total?.units || 0,
        };
      });
      
      // Then aggregate weekly data for months not in periods (EXACT copy from Trends)
      sortedWeeks.forEach(w => {
        const monthKey = w.substring(0, 7); // "2025-01" format
        if (!monthData[monthKey]) {
          monthData[monthKey] = {
            key: monthKey,
            source: 'weekly',
            revenue: 0, profit: 0, units: 0,
          };
        }
        if (monthData[monthKey].source === 'weekly') {
          const week = allWeeksData[w];
          monthData[monthKey].revenue += week.total?.revenue || 0;
          monthData[monthKey].profit += week.total?.netProfit || 0;
          monthData[monthKey].units += week.total?.units || 0;
        }
      });
      
      return monthData;
    };
    
    const allMonthlyData = buildAllMonthlyData();
    
    // Now filter by year and convert to month-only keys ("01", "02", etc.)
    const getMonthlyByYear = (year) => {
      const months = {};
      Object.entries(allMonthlyData).forEach(([key, data]) => {
        if (key.startsWith(year)) {
          const month = key.substring(5, 7); // Extract "01" from "2025-01"
          months[month] = data;
        }
      });
      return months;
    };
    
    const currentMonths = currentYear ? getMonthlyByYear(currentYear) : {};
    const previousMonths = previousYear ? getMonthlyByYear(previousYear) : {};
    const allMonths = ['01','02','03','04','05','06','07','08','09','10','11','12'];
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    
    const hasMonthlyData = Object.keys(currentMonths).length > 0 || Object.keys(previousMonths).length > 0;
    
    const calcYoYChange = (current, previous) => {
      if (!previous || previous === 0) return null;
      return ((current - previous) / previous) * 100;
    };
    
    const YoYBadge = ({ change }) => {
      if (change === null) return <span className="text-slate-500">â€”</span>;
      const isPositive = change > 0;
      const color = isPositive ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400';
      const Icon = isPositive ? ArrowUpRight : ArrowDownRight;
      return (
        <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-sm ${color}`}>
          <Icon className="w-3 h-3" />
          {Math.abs(change).toFixed(1)}%
        </span>
      );
    };
    
    // Find max for chart
    const maxMonthlyRev = Math.max(
      ...allMonths.map(m => Math.max(currentMonths[m]?.revenue || 0, previousMonths[m]?.revenue || 0))
    );
    
    return (
      <div className="min-h-screen bg-slate-950 p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <NavTabs />
          {dataBar}
          
          <div className="mb-6">
            <h1 className="text-2xl lg:text-3xl font-bold text-white mb-2">ðŸ“… Year-over-Year Comparison</h1>
            <p className="text-slate-400">{previousYear && currentYear ? `Comparing ${currentYear} vs ${previousYear}` : (currentYear ? `${currentYear} data (add previous year data to compare)` : 'No data available - upload periods labeled as years (e.g., "2024", "2025")')}</p>
            {hasMonthlyData && (
              <p className="text-slate-500 text-xs mt-2">
                {Object.keys(currentMonths).length > 0 && `${currentYear}: ${Object.keys(currentMonths).map(m => monthNames[parseInt(m)-1]).join(', ')}`}
                {Object.keys(currentMonths).length > 0 && Object.keys(previousMonths).length > 0 && ' â€¢ '}
                {Object.keys(previousMonths).length > 0 && `${previousYear}: ${Object.keys(previousMonths).map(m => monthNames[parseInt(m)-1]).join(', ')}`}
              </p>
            )}
          </div>
          
          {!currentYearData && (
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-8 text-center">
              <p className="text-slate-400 mb-4">No year data found.</p>
              <p className="text-slate-500 text-sm">To see YoY comparisons:</p>
              <ul className="text-slate-500 text-sm mt-2 space-y-1">
                <li>â€¢ Upload weekly data with dates, OR</li>
                <li>â€¢ Create Periods labeled exactly as years (e.g., "2024", "2025")</li>
              </ul>
            </div>
          )}
          
          {currentYearData && (
          <>
          {/* Year Summary Cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            {/* Current Year */}
            <div className="bg-gradient-to-br from-violet-900/30 to-slate-800/50 rounded-xl border border-violet-500/30 p-5">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-violet-400">{currentYear}</h3>
                <span className="text-xs px-2 py-1 bg-violet-500/20 text-violet-300 rounded">{currentYearData.source === 'period' ? 'Period Data' : 'Weekly Data'}</span>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-slate-400 text-sm">Revenue</p>
                  <p className="text-2xl font-bold text-white">{formatCurrency(currentYearData.revenue)}</p>
                </div>
                <div>
                  <p className="text-slate-400 text-sm">Net Profit</p>
                  <p className={`text-2xl font-bold ${currentYearData.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(currentYearData.profit)}</p>
                </div>
                <div>
                  <p className="text-slate-400 text-sm">Units Sold</p>
                  <p className="text-xl font-bold text-white">{formatNumber(currentYearData.units)}</p>
                </div>
                <div>
                  <p className="text-slate-400 text-sm">Margin</p>
                  <p className={`text-xl font-bold ${currentYearData.revenue > 0 && (currentYearData.profit/currentYearData.revenue) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                    {formatPercent(currentYearData.revenue > 0 ? (currentYearData.profit/currentYearData.revenue)*100 : 0)}
                  </p>
                </div>
              </div>
              <p className="text-slate-500 text-sm mt-3">{currentYearData.source === 'period' ? currentYearData.label : `${currentYearData.weeks} weeks of data`}</p>
            </div>
            
            {/* Previous Year */}
            {previousYearData ? (
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-slate-400">{previousYear}</h3>
                  <span className="text-xs px-2 py-1 bg-slate-600 text-slate-300 rounded">{previousYearData.source === 'period' ? 'Period Data' : 'Weekly Data'}</span>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-slate-400 text-sm">Revenue</p>
                    <p className="text-2xl font-bold text-white">{formatCurrency(previousYearData.revenue)}</p>
                    <YoYBadge change={calcYoYChange(currentYearData.revenue, previousYearData.revenue)} />
                  </div>
                  <div>
                    <p className="text-slate-400 text-sm">Net Profit</p>
                    <p className={`text-2xl font-bold ${previousYearData.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(previousYearData.profit)}</p>
                    <YoYBadge change={calcYoYChange(currentYearData.profit, previousYearData.profit)} />
                  </div>
                  <div>
                    <p className="text-slate-400 text-sm">Units Sold</p>
                    <p className="text-xl font-bold text-white">{formatNumber(previousYearData.units)}</p>
                    <YoYBadge change={calcYoYChange(currentYearData.units, previousYearData.units)} />
                  </div>
                  <div>
                    <p className="text-slate-400 text-sm">Margin</p>
                    <p className={`text-xl font-bold ${previousYearData.revenue > 0 && (previousYearData.profit/previousYearData.revenue) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                      {formatPercent(previousYearData.revenue > 0 ? (previousYearData.profit/previousYearData.revenue)*100 : 0)}
                    </p>
                  </div>
                </div>
                <p className="text-slate-500 text-sm mt-3">{previousYearData.weeks} weeks of data</p>
              </div>
            ) : (
              <div className="bg-slate-800/30 rounded-xl border border-dashed border-slate-600 p-5 flex items-center justify-center">
                <p className="text-slate-500 text-center">Upload {parseInt(currentYear) - 1} data to enable YoY comparison</p>
              </div>
            )}
          </div>
          
          {/* Monthly YoY Chart - shows even with just current year data */}
          {hasMonthlyData && (
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6">
              <h3 className="text-lg font-semibold text-white mb-4">Monthly Revenue: {currentYear}{previousYear ? ` vs ${previousYear}` : ''}</h3>
              <div className="flex items-end gap-2" style={{ height: '250px' }}>
                {allMonths.map((m, i) => {
                  const currRev = currentMonths[m]?.revenue || 0;
                  const prevRev = previousMonths[m]?.revenue || 0;
                  // Calculate pixel heights (max 200px)
                  const maxBarHeight = 200;
                  const currHeight = maxMonthlyRev > 0 ? Math.round((currRev / maxMonthlyRev) * maxBarHeight) : 0;
                  const prevHeight = maxMonthlyRev > 0 ? Math.round((prevRev / maxMonthlyRev) * maxBarHeight) : 0;
                  return (
                    <div key={m} className="flex-1 flex flex-col items-center justify-end">
                      <div className="flex gap-0.5 items-end w-full justify-center" style={{ height: `${maxBarHeight}px` }}>
                        {previousYear && (
                          <div className="flex-1 flex items-end justify-center group relative">
                            <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-700 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-50 pointer-events-none shadow-lg">
                              {previousYear}: {formatCurrency(prevRev)}
                            </div>
                            <div 
                              className="w-full max-w-[30px] bg-slate-600 rounded-t transition-all hover:bg-slate-500" 
                              style={{ height: `${Math.max(prevHeight, prevRev > 0 ? 4 : 0)}px` }} 
                            />
                          </div>
                        )}
                        <div className={`${previousYear ? 'flex-1' : 'w-full'} flex items-end justify-center group relative`}>
                          <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-700 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-50 pointer-events-none shadow-lg">
                            {currentYear}: {formatCurrency(currRev)}
                          </div>
                          <div 
                            className="w-full max-w-[30px] bg-violet-500 rounded-t transition-all hover:bg-violet-400" 
                            style={{ height: `${Math.max(currHeight, currRev > 0 ? 4 : 0)}px` }} 
                          />
                        </div>
                      </div>
                      <span className="text-xs text-slate-400 mt-2">{monthNames[i]}</span>
                    </div>
                  );
                })}
              </div>
              <div className="flex gap-4 mt-3 text-sm justify-center">
                {previousYear && <span className="flex items-center gap-2"><span className="w-3 h-3 bg-slate-600 rounded" />{previousYear}</span>}
                <span className="flex items-center gap-2"><span className="w-3 h-3 bg-violet-500 rounded" />{currentYear}</span>
              </div>
            </div>
          )}
          
          {/* Monthly Comparison Table - uses weekly data + monthly periods */}
          {hasMonthlyData && (
          <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
            <h3 className="text-lg font-semibold text-white mb-4">Month-by-Month Breakdown</h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b border-slate-700">
                    <th className="text-left text-slate-400 font-medium py-2">Month</th>
                    <th className="text-right text-slate-400 font-medium py-2">{currentYear} Revenue</th>
                    {previousYear && <th className="text-right text-slate-400 font-medium py-2">{previousYear} Revenue</th>}
                    {previousYear && <th className="text-right text-slate-400 font-medium py-2">YoY Change</th>}
                    <th className="text-right text-slate-400 font-medium py-2">{currentYear} Profit</th>
                    {previousYear && <th className="text-right text-slate-400 font-medium py-2">{previousYear} Profit</th>}
                  </tr>
                </thead>
                <tbody>
                  {allMonths.map((m, i) => {
                    const curr = currentMonths[m] || { revenue: 0, profit: 0 };
                    const prev = previousMonths[m] || { revenue: 0, profit: 0 };
                    const hasData = curr.revenue > 0 || prev.revenue > 0;
                    if (!hasData) return null;
                    const change = calcYoYChange(curr.revenue, prev.revenue);
                    return (
                      <tr key={m} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                        <td className="py-2 text-white">{monthNames[i]}</td>
                        <td className="py-2 text-right text-white">{formatCurrency(curr.revenue)}</td>
                        {previousYear && <td className="py-2 text-right text-slate-400">{formatCurrency(prev.revenue)}</td>}
                        {previousYear && <td className="py-2 text-right"><YoYBadge change={change} /></td>}
                        <td className={`py-2 text-right ${curr.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(curr.profit)}</td>
                        {previousYear && <td className={`py-2 text-right ${prev.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(prev.profit)}</td>}
                      </tr>
                    );
                  })}
                </tbody>
                <tfoot className="border-t-2 border-slate-600">
                  <tr className="font-semibold">
                    <td className="py-2 text-white">Total</td>
                    <td className="py-2 text-right text-white">{formatCurrency(currentYearData.revenue)}</td>
                    {previousYear && <td className="py-2 text-right text-slate-400">{formatCurrency(previousYearData.revenue)}</td>}
                    {previousYear && <td className="py-2 text-right"><YoYBadge change={calcYoYChange(currentYearData.revenue, previousYearData.revenue)} /></td>}
                    <td className={`py-2 text-right ${currentYearData.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(currentYearData.profit)}</td>
                    {previousYear && <td className={`py-2 text-right ${previousYearData.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(previousYearData.profit)}</td>}
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          )}
          
          {!hasMonthlyData && (
            <div className="bg-slate-800/30 rounded-xl border border-dashed border-slate-600 p-6 text-center">
              <p className="text-slate-500">Monthly breakdown requires weekly data or monthly period uploads.</p>
              <p className="text-slate-600 text-sm mt-1">Upload periods like "January 2025" or "Jan 2025" to see monthly breakdowns.</p>
            </div>
          )}
          </>
          )}
        </div>
      </div>
    );
  }

  // ==================== 3PL ANALYTICS VIEW ====================
  if (view === '3pl') {
    const sortedWeeks = Object.keys(allWeeksData).sort();
    
    // Get all ledger data
    const ledgerOrders = Object.values(threeplLedger.orders || {});
    const ledgerWeeksSet = new Set(ledgerOrders.map(o => o.weekKey));
    const ledgerWeeksList = [...ledgerWeeksSet].sort();
    
    // Calculate date boundaries based on selected range
    const getDateBoundaries = () => {
      const today = new Date();
      let startDate, endDate = today;
      
      switch (threeplDateRange) {
        case 'week':
          startDate = new Date(today);
          startDate.setDate(today.getDate() - 7);
          break;
        case '4weeks':
          startDate = new Date(today);
          startDate.setDate(today.getDate() - 28);
          break;
        case 'month':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          break;
        case 'quarter':
          const quarter = Math.floor(today.getMonth() / 3);
          startDate = new Date(today.getFullYear(), quarter * 3, 1);
          break;
        case 'year':
          startDate = new Date(today.getFullYear(), 0, 1);
          break;
        case 'custom':
          startDate = threeplCustomStart ? new Date(threeplCustomStart) : new Date(0);
          endDate = threeplCustomEnd ? new Date(threeplCustomEnd) : today;
          break;
        case 'all':
        default:
          startDate = new Date(0);
          break;
      }
      
      return { 
        start: startDate.toISOString().split('T')[0], 
        end: endDate.toISOString().split('T')[0] 
      };
    };
    
    const dateBounds = getDateBoundaries();
    
    // Aggregate 3PL data by week - check BOTH weekly data AND ledger
    let weeklyData = sortedWeeks.map(w => {
      const week = allWeeksData[w];
      const weekMetrics = week.shopify?.threeplMetrics || {};
      const weekBreakdown = week.shopify?.threeplBreakdown || {};
      const weekCost = week.shopify?.threeplCosts || 0;
      
      // Also check ledger for this week's data
      const ledgerData = get3PLForWeek(threeplLedger, w);
      
      // Calculate values from weekly data
      const weekOrderCount = weekMetrics.orderCount || weekMetrics.firstPickCount || weekMetrics.shippingCount || 0;
      const weekAvgCost = weekMetrics.avgCostPerOrder || 
        (weekOrderCount > 0 ? (weekCost - (weekBreakdown.storage || 0)) / weekOrderCount : 0);
      
      // Calculate values from ledger data
      const ledgerOrderCount = ledgerData?.metrics?.orderCount || 0;
      const ledgerCost = ledgerData?.metrics?.totalCost || 0;
      const ledgerAvgCost = ledgerData?.metrics?.avgCostPerOrder || 0;
      
      // Use whichever source has data (prefer ledger if both have data)
      const hasLedgerData = ledgerCost > 0;
      const hasWeekData = weekCost > 0;
      
      const finalCost = hasLedgerData ? ledgerCost : weekCost;
      const finalOrderCount = hasLedgerData ? ledgerOrderCount : weekOrderCount;
      const finalAvgCost = hasLedgerData ? ledgerAvgCost : weekAvgCost;
      const finalBreakdown = hasLedgerData ? (ledgerData?.breakdown || {}) : weekBreakdown;
      const finalMetrics = hasLedgerData ? (ledgerData?.metrics || {}) : weekMetrics;
      
      // If we have cost but no avgCost, try to calculate from Shopify units as fallback
      let calculatedAvgCost = finalAvgCost;
      if (calculatedAvgCost === 0 && finalCost > 0) {
        const storage = finalBreakdown.storage || 0;
        const fulfillmentCost = finalCost - storage;
        if (finalOrderCount > 0) {
          calculatedAvgCost = fulfillmentCost / finalOrderCount;
        } else if (week.shopify?.units > 0) {
          // Last resort: use Shopify units as proxy for orders
          calculatedAvgCost = fulfillmentCost / week.shopify.units;
        }
      }
      
      return {
        week: w,
        type: 'week',
        label: new Date(w + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        totalCost: finalCost,
        orderCount: finalOrderCount,
        totalUnits: finalMetrics.totalUnits || finalMetrics.firstPickCount || 0,
        avgCostPerOrder: calculatedAvgCost,
        avgShippingCost: finalMetrics.avgShippingCost || 0,
        avgPickCost: finalMetrics.avgPickCost || 0,
        avgPackagingCost: finalMetrics.avgPackagingCost || 0,
        avgUnitsPerOrder: finalMetrics.avgUnitsPerOrder || 0,
        storage: finalBreakdown.storage || 0,
        shipping: finalBreakdown.shipping || 0,
        pickFees: finalBreakdown.pickFees || 0,
        boxCharges: finalBreakdown.boxCharges || 0,
        receiving: finalBreakdown.receiving || 0,
        revenue: week.shopify?.revenue || 0,
        fromLedger: hasLedgerData,
        carrierBreakdown: finalMetrics.carrierBreakdown || {},
        stateBreakdown: finalMetrics.stateBreakdown || {},
      };
    }).filter(d => d.totalCost > 0 || d.shipping > 0 || d.pickFees > 0 || d.storage > 0);
    
    // Get weeks from ledger that aren't in allWeeksData
    const ledgerWeeks = new Set(Object.values(threeplLedger.orders || {}).map(o => o.weekKey));
    const existingWeeks = new Set(sortedWeeks);
    const ledgerOnlyWeeks = [...ledgerWeeks].filter(w => !existingWeeks.has(w)).sort();
    
    // Add ledger-only weeks to weeklyData
    ledgerOnlyWeeks.forEach(w => {
      const ledgerData = get3PLForWeek(threeplLedger, w);
      if (ledgerData && ledgerData.metrics.totalCost > 0) {
        weeklyData.push({
          week: w,
          type: 'week',
          label: new Date(w + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          totalCost: ledgerData.metrics.totalCost,
          orderCount: ledgerData.metrics.orderCount || 0,
          totalUnits: ledgerData.metrics.totalUnits || 0,
          avgCostPerOrder: ledgerData.metrics.avgCostPerOrder || 0,
          avgShippingCost: ledgerData.metrics.avgShippingCost || 0,
          avgPickCost: ledgerData.metrics.avgPickCost || 0,
          avgPackagingCost: ledgerData.metrics.avgPackagingCost || 0,
          avgUnitsPerOrder: ledgerData.metrics.avgUnitsPerOrder || 0,
          storage: ledgerData.breakdown.storage || 0,
          shipping: ledgerData.breakdown.shipping || 0,
          pickFees: ledgerData.breakdown.pickFees || 0,
          boxCharges: ledgerData.breakdown.boxCharges || 0,
          receiving: ledgerData.breakdown.receiving || 0,
          revenue: 0,
          fromLedger: true,
          carrierBreakdown: ledgerData.metrics.carrierBreakdown || {},
          stateBreakdown: ledgerData.metrics.stateBreakdown || {},
        });
      }
    });
    
    // Sort weeklyData by week
    weeklyData.sort((a, b) => a.week.localeCompare(b.week));
    
    // Store all data before filtering for comparison
    const allWeeklyData = [...weeklyData];
    
    // Filter by date range
    weeklyData = weeklyData.filter(w => {
      return w.week >= dateBounds.start && w.week <= dateBounds.end;
    });
    
    // Also get Period 3PL data
    const periodData = Object.entries(allPeriodsData).map(([key, period]) => {
      const metrics = period.shopify?.threeplMetrics || {};
      const breakdown = period.shopify?.threeplBreakdown || {};
      const totalCost = period.shopify?.threeplCosts || 0;
      const orderCount = metrics.orderCount || 0;
      // Calculate avgCostPerOrder if not provided
      const avgCostPerOrder = metrics.avgCostPerOrder || 
        (orderCount > 0 ? (totalCost - (breakdown.storage || 0)) / orderCount : 
        (totalCost > 0 && period.shopify?.units > 0 ? totalCost / period.shopify.units : 0));
      return {
        period: key,
        type: 'period',
        label: period.label || key,
        totalCost,
        orderCount,
        totalUnits: metrics.totalUnits || 0,
        avgCostPerOrder,
        avgShippingCost: metrics.avgShippingCost || 0,
        avgPickCost: metrics.avgPickCost || 0,
        avgPackagingCost: metrics.avgPackagingCost || 0,
        avgUnitsPerOrder: metrics.avgUnitsPerOrder || 0,
        storage: breakdown.storage || 0,
        shipping: breakdown.shipping || 0,
        pickFees: breakdown.pickFees || 0,
        boxCharges: breakdown.boxCharges || 0,
        receiving: breakdown.receiving || 0,
        revenue: period.shopify?.revenue || 0,
      };
    }).filter(d => d.totalCost > 0);
    
    // Aggregate by month (weekly data only)
    const monthlyData = {};
    weeklyData.forEach(w => {
      const month = w.week.substring(0, 7);
      if (!monthlyData[month]) {
        monthlyData[month] = { 
          month, totalCost: 0, orderCount: 0, totalUnits: 0, 
          storage: 0, shipping: 0, pickFees: 0, boxCharges: 0, receiving: 0,
          revenue: 0, weeks: 0
        };
      }
      monthlyData[month].totalCost += w.totalCost;
      monthlyData[month].orderCount += w.orderCount;
      monthlyData[month].totalUnits += w.totalUnits;
      monthlyData[month].storage += w.storage;
      monthlyData[month].shipping += w.shipping;
      monthlyData[month].pickFees += w.pickFees;
      monthlyData[month].boxCharges += w.boxCharges;
      monthlyData[month].receiving += w.receiving;
      monthlyData[month].revenue += w.revenue;
      monthlyData[month].weeks += 1;
    });
    
    // Calculate averages for monthly data
    Object.values(monthlyData).forEach(m => {
      m.avgCostPerOrder = m.orderCount > 0 ? (m.totalCost - m.storage) / m.orderCount : 0;
      m.avgUnitsPerOrder = m.orderCount > 0 ? m.totalUnits / m.orderCount : 0;
      m.costAsPercentOfRevenue = m.revenue > 0 ? (m.totalCost / m.revenue) * 100 : 0;
    });
    
    const months = Object.values(monthlyData).sort((a, b) => a.month.localeCompare(b.month));
    
    // Totals for selected date range (not just last 4 weeks)
    const filteredTotals = weeklyData.reduce((acc, w) => ({
      totalCost: acc.totalCost + w.totalCost,
      orderCount: acc.orderCount + w.orderCount,
      totalUnits: acc.totalUnits + w.totalUnits,
      storage: acc.storage + w.storage,
      shipping: acc.shipping + w.shipping,
      pickFees: acc.pickFees + w.pickFees,
      boxCharges: acc.boxCharges + w.boxCharges,
      revenue: acc.revenue + w.revenue,
    }), { totalCost: 0, orderCount: 0, totalUnits: 0, storage: 0, shipping: 0, pickFees: 0, boxCharges: 0, revenue: 0 });
    
    filteredTotals.avgCostPerOrder = filteredTotals.orderCount > 0 ? (filteredTotals.totalCost - filteredTotals.storage) / filteredTotals.orderCount : 0;
    filteredTotals.avgUnitsPerOrder = filteredTotals.orderCount > 0 ? filteredTotals.totalUnits / filteredTotals.orderCount : 0;
    filteredTotals.costAsPercentOfRevenue = filteredTotals.revenue > 0 ? (filteredTotals.totalCost / filteredTotals.revenue) * 100 : 0;
    
    // Date range labels
    const rangeLabels = {
      'week': 'Last 7 Days',
      '4weeks': 'Last 4 Weeks',
      'month': 'This Month',
      'quarter': 'This Quarter',
      'year': 'This Year',
      'all': 'All Time',
      'custom': 'Custom Range',
    };
    
    // Find max for chart scaling
    const maxWeeklyCost = Math.max(...weeklyData.map(d => d.totalCost), 1);
    const maxMonthlyCost = Math.max(...months.map(d => d.totalCost), 1);
    
    // Use component-level state for time view toggle
    const timeView = threeplTimeView;
    const setTimeView = setThreeplTimeView;
    
    // Check if we have any 3PL data at all (use unfiltered data)
    const hasWeeklyData = allWeeklyData.length > 0;
    const hasPeriodData = periodData.length > 0;
    const hasLedgerData = Object.keys(threeplLedger.orders || {}).length > 0;
    
    if (!hasWeeklyData && !hasPeriodData && !hasLedgerData) {
      return (
        <div className="min-h-screen bg-slate-950 p-4 lg:p-6">
          <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
            <NavTabs />{dataBar}
            <div className="text-center py-12">
              <Truck className="w-16 h-16 text-slate-600 mx-auto mb-4" />
              <h2 className="text-xl font-bold text-white mb-2">No 3PL Data Yet</h2>
              <p className="text-slate-400 mb-4">Upload data with 3PL files to see fulfillment analytics</p>
              <button 
                onClick={() => setShow3PLBulkUpload(true)}
                className="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl text-white font-semibold flex items-center gap-2 mx-auto mb-4"
              >
                <Upload className="w-5 h-5" />
                Bulk Upload 3PL Files
              </button>
              <div className="text-slate-500 text-sm">
                <p>Upload multiple 3PL Excel files at once</p>
                <p>Supports .xlsx format from Packiyo â€¢ Auto-deduplication</p>
              </div>
            </div>
          </div>
        </div>
      );
    }
    
    // If only period data (no weekly and no ledger), show a different view
    if (!hasWeeklyData && hasPeriodData && !hasLedgerData) {
      return (
        <div className="min-h-screen bg-slate-950 p-4 lg:p-6">
          <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
            <NavTabs />{dataBar}
            
            <div className="mb-6">
              <div className="flex items-center justify-between mb-2">
                <h1 className="text-2xl lg:text-3xl font-bold text-white">ðŸšš 3PL Fulfillment Analytics</h1>
                <button 
                  onClick={() => setShow3PLBulkUpload(true)}
                  className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-medium flex items-center gap-2"
                >
                  <Upload className="w-4 h-4" />
                  Bulk Upload
                </button>
              </div>
              <p className="text-slate-400">Period-level 3PL data (upload weekly data for trend charts)</p>
            </div>
            
            {/* Period 3PL Summary */}
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6">
              <h3 className="text-lg font-semibold text-white mb-4">Period 3PL Summary</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b border-slate-700">
                      <th className="text-left text-slate-400 py-2">Period</th>
                      <th className="text-right text-slate-400 py-2">Total 3PL</th>
                      <th className="text-right text-slate-400 py-2">Orders</th>
                      <th className="text-right text-slate-400 py-2">Units</th>
                      <th className="text-right text-slate-400 py-2">Avg/Order</th>
                      <th className="text-right text-slate-400 py-2">Shipping</th>
                      <th className="text-right text-slate-400 py-2">Pick Fees</th>
                      <th className="text-right text-slate-400 py-2">Storage</th>
                      <th className="text-right text-slate-400 py-2">% of Revenue</th>
                    </tr>
                  </thead>
                  <tbody>
                    {periodData.map(d => {
                      const pctOfRev = d.revenue > 0 ? (d.totalCost / d.revenue) * 100 : 0;
                      return (
                        <tr key={d.period} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                          <td className="py-3 text-white font-medium">{d.label}</td>
                          <td className="py-3 text-right text-white font-semibold">{formatCurrency(d.totalCost)}</td>
                          <td className="py-3 text-right text-white">{d.orderCount > 0 ? formatNumber(d.orderCount) : 'â€”'}</td>
                          <td className="py-3 text-right text-white">{d.totalUnits > 0 ? formatNumber(d.totalUnits) : 'â€”'}</td>
                          <td className={`py-3 text-right font-semibold ${d.avgCostPerOrder > 0 ? (d.avgCostPerOrder <= 10 ? 'text-emerald-400' : d.avgCostPerOrder <= 15 ? 'text-amber-400' : 'text-rose-400') : 'text-slate-500'}`}>
                            {d.avgCostPerOrder > 0 ? formatCurrency(d.avgCostPerOrder) : 'â€”'}
                          </td>
                          <td className="py-3 text-right text-blue-400">{formatCurrency(d.shipping)}</td>
                          <td className="py-3 text-right text-emerald-400">{formatCurrency(d.pickFees)}</td>
                          <td className="py-3 text-right text-violet-400">{formatCurrency(d.storage)}</td>
                          <td className={`py-3 text-right ${pctOfRev <= 10 ? 'text-emerald-400' : pctOfRev <= 15 ? 'text-amber-400' : 'text-rose-400'}`}>
                            {pctOfRev.toFixed(1)}%
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
            
            <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
              <p className="text-blue-400 text-sm">ðŸ’¡ <strong>Tip:</strong> Upload weekly data with 3PL files to see trend charts, week-over-week comparisons, and more detailed analytics.</p>
            </div>
          </div>
        </div>
      );
    }
    
    return (
      <div className="min-h-screen bg-slate-950 p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <NavTabs />
          {dataBar}
          
          <div className="mb-6">
            <div className="flex items-center justify-between mb-2">
              <h1 className="text-2xl lg:text-3xl font-bold text-white">ðŸšš 3PL Fulfillment Analytics</h1>
              <button 
                onClick={() => setShow3PLBulkUpload(true)}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-medium flex items-center gap-2"
              >
                <Upload className="w-4 h-4" />
                Bulk Upload
              </button>
            </div>
            <p className="text-slate-400">Track shipping costs, order metrics, and fulfillment efficiency over time</p>
          </div>
          
          {/* Date Range Selector */}
          <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4 mb-6">
            <div className="flex flex-wrap items-center gap-3">
              <span className="text-slate-400 text-sm">Date Range:</span>
              <div className="flex flex-wrap gap-2">
                {['week', '4weeks', 'month', 'quarter', 'year', 'all'].map(range => (
                  <button
                    key={range}
                    onClick={() => setThreeplDateRange(range)}
                    className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                      threeplDateRange === range 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                    }`}
                  >
                    {rangeLabels[range]}
                  </button>
                ))}
                <button
                  onClick={() => setThreeplDateRange('custom')}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                    threeplDateRange === 'custom' 
                      ? 'bg-blue-600 text-white' 
                      : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                  }`}
                >
                  Custom
                </button>
              </div>
              {threeplDateRange === 'custom' && (
                <div className="flex items-center gap-2 ml-auto">
                  <input
                    type="date"
                    value={threeplCustomStart}
                    onChange={(e) => setThreeplCustomStart(e.target.value)}
                    className="bg-slate-900 border border-slate-600 rounded-lg px-3 py-1.5 text-white text-sm"
                  />
                  <span className="text-slate-500">to</span>
                  <input
                    type="date"
                    value={threeplCustomEnd}
                    onChange={(e) => setThreeplCustomEnd(e.target.value)}
                    className="bg-slate-900 border border-slate-600 rounded-lg px-3 py-1.5 text-white text-sm"
                  />
                </div>
              )}
            </div>
            {weeklyData.length === 0 && allWeeklyData.length > 0 && (
              <div className="mt-3 p-3 bg-amber-900/20 border border-amber-500/30 rounded-lg">
                <p className="text-amber-400 text-sm">âš ï¸ No 3PL data found for {rangeLabels[threeplDateRange]}. Try selecting a different date range.</p>
              </div>
            )}
          </div>
          
          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
            <div className="bg-gradient-to-br from-blue-900/30 to-slate-800/50 rounded-xl border border-blue-500/30 p-4">
              <p className="text-slate-400 text-sm">Total 3PL</p>
              <p className="text-2xl font-bold text-white">{formatCurrency(filteredTotals.totalCost)}</p>
              <p className="text-blue-400 text-xs">{filteredTotals.costAsPercentOfRevenue > 0 ? `${filteredTotals.costAsPercentOfRevenue.toFixed(1)}% of revenue` : `${weeklyData.length} weeks`}</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">Orders</p>
              <p className="text-2xl font-bold text-white">{formatNumber(filteredTotals.orderCount)}</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">Units Shipped</p>
              <p className="text-2xl font-bold text-white">{formatNumber(filteredTotals.totalUnits)}</p>
            </div>
            <div className="bg-cyan-900/30 rounded-xl border border-cyan-500/30 p-4">
              <p className="text-cyan-400 text-sm">Avg Cost/Order</p>
              <p className="text-2xl font-bold text-cyan-300">{formatCurrency(filteredTotals.avgCostPerOrder)}</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">Avg Units/Order</p>
              <p className="text-2xl font-bold text-white">{filteredTotals.avgUnitsPerOrder.toFixed(1)}</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">Storage</p>
              <p className="text-2xl font-bold text-white">{formatCurrency(filteredTotals.storage)}</p>
            </div>
          </div>
          
          {/* Time View Toggle */}
          <div className="flex gap-2 mb-4">
            <button onClick={() => setTimeView('weekly')} className={`px-4 py-2 rounded-lg text-sm font-medium ${timeView === 'weekly' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>Weekly</button>
            <button onClick={() => setTimeView('monthly')} className={`px-4 py-2 rounded-lg text-sm font-medium ${timeView === 'monthly' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>Monthly</button>
          </div>
          
          {/* Cost Trend Chart */}
          <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6 overflow-hidden">
            <h3 className="text-lg font-semibold text-white mb-4">
              {timeView === 'weekly' ? 'Weekly' : 'Monthly'} 3PL Costs
            </h3>
            <div className="relative flex items-end gap-1 h-48">
              {(timeView === 'weekly' ? weeklyData.slice(-12) : months.slice(-12)).map((d, i) => {
                const data = d;
                const height = timeView === 'weekly' 
                  ? (data.totalCost / maxWeeklyCost) * 100 
                  : (data.totalCost / maxMonthlyCost) * 100;
                const label = timeView === 'weekly' 
                  ? new Date(data.week + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                  : new Date(data.month + '-01T00:00:00').toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                return (
                  <div key={timeView === 'weekly' ? data.week : data.month} className="flex-1 flex flex-col items-center group relative">
                    <div className="absolute -top-14 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-700 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-50 pointer-events-none shadow-lg">
                      {label}<br/>
                      Total: {formatCurrency(data.totalCost)}<br/>
                      Orders: {formatNumber(data.orderCount)}<br/>
                      Avg/Order: {formatCurrency(data.avgCostPerOrder)}
                    </div>
                    <div className="w-full flex flex-col justify-end h-40">
                      {/* Stacked bar */}
                      <div className="w-full bg-violet-500 rounded-t" style={{ height: `${(data.storage / data.totalCost) * height}%` }} title="Storage" />
                      <div className="w-full bg-blue-500" style={{ height: `${(data.shipping / data.totalCost) * height}%` }} title="Shipping" />
                      <div className="w-full bg-emerald-500" style={{ height: `${(data.pickFees / data.totalCost) * height}%` }} title="Pick Fees" />
                      <div className="w-full bg-amber-500" style={{ height: `${(data.boxCharges / data.totalCost) * height}%` }} title="Packaging" />
                    </div>
                    <span className="text-[9px] text-slate-500 mt-1 truncate w-full text-center">{label}</span>
                  </div>
                );
              })}
            </div>
            <div className="flex gap-4 mt-3 text-xs justify-center flex-wrap">
              <span className="flex items-center gap-1"><span className="w-3 h-3 bg-violet-500 rounded" />Storage</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 bg-blue-500 rounded" />Shipping</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 bg-emerald-500 rounded" />Pick Fees</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 bg-amber-500 rounded" />Packaging</span>
            </div>
          </div>
          
          {/* 3PL Trend Charts */}
          {(() => {
            const chartData = (timeView === 'weekly' ? weeklyData : months).slice(-12);
            if (chartData.length < 2) return null;
            
            const getLabel = (d) => timeView === 'weekly' 
              ? new Date(d.week + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
              : new Date(d.month + '-01T00:00:00').toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            
            const TrendChart = ({ data, getValue, title, format = 'currency', colorFn = null, goodDirection = 'down', icon }) => {
              const values = data.map(d => getValue(d) || 0);
              const maxVal = Math.max(...values, 1);
              const avgVal = values.reduce((a, b) => a + b, 0) / values.length;
              const latestVal = values[values.length - 1];
              const prevVal = values[values.length - 2];
              const change = prevVal > 0 ? ((latestVal - prevVal) / prevVal) * 100 : 0;
              const isGood = goodDirection === 'down' ? change <= 0 : change >= 0;
              
              return (
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <p className="text-slate-400 text-sm">{title}</p>
                      <p className="text-white font-bold text-xl">
                        {format === 'currency' ? formatCurrency(latestVal) : format === 'percent' ? `${latestVal.toFixed(1)}%` : latestVal.toFixed(0)}
                      </p>
                    </div>
                    <div className="text-right">
                      {change !== 0 && (
                        <div className={`px-2 py-1 rounded text-xs font-medium ${isGood ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`}>
                          {change > 0 ? 'â†‘' : 'â†“'} {Math.abs(change).toFixed(1)}%
                        </div>
                      )}
                      <p className="text-slate-500 text-xs mt-1">vs last {timeView === 'weekly' ? 'week' : 'month'}</p>
                    </div>
                  </div>
                  <div className="relative flex items-end gap-1 h-20">
                    {data.map((d, i) => {
                      const val = getValue(d) || 0;
                      const height = maxVal > 0 ? (val / maxVal) * 100 : 0;
                      const isLatest = i === data.length - 1;
                      const defaultColor = 'bg-slate-500';
                      const color = colorFn ? colorFn(val) : defaultColor;
                      return (
                        <div key={i} className="flex-1 flex flex-col items-center group relative">
                          <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-900 border border-slate-700 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-50 shadow-lg pointer-events-none">
                            <p className="font-medium">{getLabel(d)}</p>
                            <p className="text-slate-300">{format === 'currency' ? formatCurrency(val) : format === 'percent' ? `${val.toFixed(1)}%` : val.toFixed(0)}</p>
                          </div>
                          <div 
                            className={`w-full rounded-t transition-all hover:opacity-80 ${isLatest ? color : color + '/60'}`} 
                            style={{ height: `${Math.max(height, 4)}%` }} 
                          />
                        </div>
                      );
                    })}
                  </div>
                  <div className="flex justify-between text-[10px] text-slate-500 mt-1 px-1">
                    <span>{getLabel(data[0])}</span>
                    <span>{getLabel(data[data.length - 1])}</span>
                  </div>
                  <div className="mt-2 pt-2 border-t border-slate-700/50 text-xs text-slate-500">
                    Avg: {format === 'currency' ? formatCurrency(avgVal) : format === 'percent' ? `${avgVal.toFixed(1)}%` : avgVal.toFixed(0)}
                  </div>
                </div>
              );
            };
            
            return (
              <div className="mb-6">
                <h3 className="text-lg font-semibold text-white mb-4">ðŸ“ˆ Cost Trends</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <TrendChart 
                    data={chartData} 
                    getValue={d => d.totalCost} 
                    title="Total 3PL Cost"
                    colorFn={v => 'bg-violet-500'}
                  />
                  <TrendChart 
                    data={chartData} 
                    getValue={d => d.avgCostPerOrder} 
                    title="Avg Cost Per Order"
                    colorFn={v => v <= 10 ? 'bg-emerald-500' : v <= 15 ? 'bg-amber-500' : 'bg-rose-500'}
                  />
                  <TrendChart 
                    data={chartData} 
                    getValue={d => d.revenue > 0 ? (d.totalCost / d.revenue) * 100 : 0} 
                    title="3PL as % of Revenue"
                    format="percent"
                    colorFn={v => v <= 10 ? 'bg-emerald-500' : v <= 15 ? 'bg-amber-500' : 'bg-rose-500'}
                  />
                  <TrendChart 
                    data={chartData} 
                    getValue={d => d.shipping} 
                    title="Shipping Costs"
                    colorFn={v => 'bg-blue-500'}
                  />
                  <TrendChart 
                    data={chartData} 
                    getValue={d => d.pickFees} 
                    title="Pick Fees"
                    colorFn={v => 'bg-cyan-500'}
                  />
                  <TrendChart 
                    data={chartData} 
                    getValue={d => d.storage} 
                    title="Storage Costs"
                    colorFn={v => 'bg-amber-500'}
                  />
                </div>
              </div>
            );
          })()}
          
          {/* Detailed Table */}
          <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
            <h3 className="text-lg font-semibold text-white mb-4">{timeView === 'weekly' ? 'Weekly' : 'Monthly'} Breakdown</h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b border-slate-700">
                    <th className="text-left text-slate-400 py-2">{timeView === 'weekly' ? 'Week' : 'Month'}</th>
                    <th className="text-right text-slate-400 py-2">Total</th>
                    <th className="text-right text-slate-400 py-2">Orders</th>
                    <th className="text-right text-slate-400 py-2">Units</th>
                    <th className="text-right text-slate-400 py-2">Avg/Order</th>
                    <th className="text-right text-slate-400 py-2">Shipping</th>
                    <th className="text-right text-slate-400 py-2">Pick Fees</th>
                    <th className="text-right text-slate-400 py-2">Packaging</th>
                    <th className="text-right text-slate-400 py-2">Storage</th>
                    <th className="text-right text-slate-400 py-2">% of Rev</th>
                  </tr>
                </thead>
                <tbody>
                  {(timeView === 'weekly' ? weeklyData.slice(-12).reverse() : months.slice(-12).reverse()).map(d => {
                    const pctOfRev = d.revenue > 0 ? (d.totalCost / d.revenue) * 100 : 0;
                    const label = timeView === 'weekly' 
                      ? new Date(d.week + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })

                      : new Date(d.month + '-01T00:00:00').toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    return (
                      <tr key={timeView === 'weekly' ? d.week : d.month} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                        <td className="py-2 text-white">{label}</td>
                        <td className="py-2 text-right text-white font-medium">{formatCurrency(d.totalCost)}</td>
                        <td className="py-2 text-right text-white">{formatNumber(d.orderCount)}</td>
                        <td className="py-2 text-right text-white">{formatNumber(d.totalUnits)}</td>
                        <td className={`py-2 text-right font-semibold ${d.avgCostPerOrder <= 10 ? 'text-emerald-400' : d.avgCostPerOrder <= 15 ? 'text-amber-400' : 'text-rose-400'}`}>{formatCurrency(d.avgCostPerOrder)}</td>
                        <td className="py-2 text-right text-blue-400">{formatCurrency(d.shipping)}</td>
                        <td className="py-2 text-right text-emerald-400">{formatCurrency(d.pickFees)}</td>
                        <td className="py-2 text-right text-amber-400">{formatCurrency(d.boxCharges)}</td>
                        <td className="py-2 text-right text-violet-400">{formatCurrency(d.storage)}</td>
                        <td className={`py-2 text-right ${pctOfRev <= 10 ? 'text-emerald-400' : pctOfRev <= 15 ? 'text-amber-400' : 'text-rose-400'}`}>{pctOfRev.toFixed(1)}%</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ==================== SKU RANKINGS VIEW ====================
  if (view === 'skus') {
    const allWeeks = Object.keys(allWeeksData).sort();
    const now = new Date();
    const currentYear = now.getFullYear();
    
    // Helper to get base SKU - keep full SKU since both channels use same format
    const getBaseSku = (sku) => sku;
    
    // Aggregate SKU data
    const skuAggregates = {};
    const skuRecentData = {};
    const skuOlderData = {};
    const skuWeeklyData = {};
    
    // Helper function to add SKU data to aggregates
    const addSkuData = (skuList, channel, isRecent, isOlder, periodKey) => {
      (skuList || []).forEach(s => {
        const baseSku = getBaseSku(s.sku);
        const weekProfit = channel === 'Amazon' 
          ? (s.netProceeds || 0)  // Amazon: netProceeds is profit
          : (s.netSales || 0) - (s.cogs || 0);  // Shopify: revenue - COGS
        
        if (!skuAggregates[baseSku]) {
          skuAggregates[baseSku] = { 
            sku: baseSku, 
            name: savedProductNames[s.sku] || savedProductNames[baseSku] || s.name, 
            channels: [], 
            units: 0, 
            revenue: 0, 
            profit: 0, 
            cogs: 0, 
            weeks: 0 
          };
        }
        if (!skuAggregates[baseSku].channels.includes(channel)) {
          skuAggregates[baseSku].channels.push(channel);
        }
        skuAggregates[baseSku].units += s.unitsSold || 0;
        skuAggregates[baseSku].revenue += s.netSales || 0;
        skuAggregates[baseSku].cogs += s.cogs || 0;
        skuAggregates[baseSku].profit += weekProfit;
        skuAggregates[baseSku].weeks += 1;
        
        // Track weekly/period data for trends
        if (periodKey) {
          if (!skuWeeklyData[baseSku]) {
            skuWeeklyData[baseSku] = { 
              sku: baseSku, 
              name: savedProductNames[s.sku] || savedProductNames[baseSku] || s.name, 
              channel, 
              weeks: {} 
            };
          }
          if (!skuWeeklyData[baseSku].weeks[periodKey]) {
            skuWeeklyData[baseSku].weeks[periodKey] = { units: 0, revenue: 0, profit: 0, fees: 0 };
          }
          skuWeeklyData[baseSku].weeks[periodKey].units += s.unitsSold || 0;
          skuWeeklyData[baseSku].weeks[periodKey].revenue += s.netSales || 0;
          skuWeeklyData[baseSku].weeks[periodKey].profit += weekProfit;
        }
        
        if (isRecent) {
          if (!skuRecentData[baseSku]) skuRecentData[baseSku] = { units: 0, revenue: 0, profit: 0 };
          skuRecentData[baseSku].units += s.unitsSold || 0;
          skuRecentData[baseSku].revenue += s.netSales || 0;
          skuRecentData[baseSku].profit += weekProfit;
        }
        if (isOlder) {
          if (!skuOlderData[baseSku]) skuOlderData[baseSku] = { units: 0, revenue: 0, profit: 0 };
          skuOlderData[baseSku].units += s.unitsSold || 0;
          skuOlderData[baseSku].revenue += s.netSales || 0;
          skuOlderData[baseSku].profit += weekProfit;
        }
      });
    };
    
    // Determine which data sources to use based on date range
    let sortedWeeks = [];
    let periodsUsed = [];
    let dataSourceLabel = '';
    
    // Only use 2026 weekly data (user confirmed no weekly data before 2026)
    const weeks2026 = allWeeks.filter(w => w.startsWith('2026'));
    
    if (skuDateRange === '4weeks') {
      sortedWeeks = weeks2026.slice(-4);
      dataSourceLabel = `Last 4 Weeks`;
    } else if (skuDateRange === 'ytd') {
      // YTD = 2026 weekly data only
      sortedWeeks = weeks2026;
      dataSourceLabel = `2026 Year to Date`;
    } else if (skuDateRange === '2025') {
      // 2025 = Monthly periods only (no weekly data for 2025)
      sortedWeeks = [];
      const monthlyPeriods = [
        'january-2025', 'february-2025', 'march-2025', 'april-2025', 'may-2025', 'june-2025',
        'july-2025', 'august-2025', 'september-2025', 'october-2025', 'november-2025', 'december-2025'
      ];
      monthlyPeriods.forEach(pKey => {
        if (allPeriodsData[pKey] && allPeriodsData[pKey].total?.revenue > 0) {
          periodsUsed.push(pKey);
        }
      });
      dataSourceLabel = `2025 (${periodsUsed.length} months)`;
    } else if (skuDateRange === '2024') {
      // 2024 = Quarterly periods only
      sortedWeeks = [];
      const quarterlyPeriods = ['q2-2024', 'q3-2024', 'q4-2024'];
      quarterlyPeriods.forEach(pKey => {
        if (allPeriodsData[pKey] && allPeriodsData[pKey].total?.revenue > 0) {
          periodsUsed.push(pKey);
        }
      });
      dataSourceLabel = `2024 (${periodsUsed.length} quarters)`;
    } else {
      // ALL TIME: 2026 weekly + 2025 monthly + 2024 quarterly (no overlap)
      sortedWeeks = weeks2026; // Only 2026 weekly data
      
      // Add quarterly 2024 data
      const quarterlyPeriods = ['q2-2024', 'q3-2024', 'q4-2024'];
      quarterlyPeriods.forEach(pKey => {
        if (allPeriodsData[pKey] && allPeriodsData[pKey].total?.revenue > 0) {
          periodsUsed.push(pKey);
        }
      });
      
      // Add monthly 2025 data (all 12 months)
      const monthlyPeriods = [
        'january-2025', 'february-2025', 'march-2025', 'april-2025', 'may-2025', 'june-2025',
        'july-2025', 'august-2025', 'september-2025', 'october-2025', 'november-2025', 'december-2025'
      ];
      monthlyPeriods.forEach(pKey => {
        if (allPeriodsData[pKey] && allPeriodsData[pKey].total?.revenue > 0) {
          periodsUsed.push(pKey);
        }
      });
      
      dataSourceLabel = `All Time`;
    }
    
    const recentWeeks = sortedWeeks.slice(-4);
    const olderWeeks = sortedWeeks.slice(-8, -4);
    
    // Process weekly data
    sortedWeeks.forEach(w => {
      const week = allWeeksData[w];
      if (!week) return;
      const isRecent = recentWeeks.includes(w);
      const isOlder = olderWeeks.includes(w);
      
      addSkuData(week.amazon?.skuData, 'Amazon', isRecent, isOlder, w);
      addSkuData(week.shopify?.skuData, 'Shopify', isRecent, isOlder, w);
    });
    
    // Process period data (for All Time only)
    periodsUsed.forEach(pKey => {
      const period = allPeriodsData[pKey];
      if (!period) return;
      // Period data is older, use for comparison baseline
      addSkuData(period.amazon?.skuData, 'Amazon', false, true, pKey);
      addSkuData(period.shopify?.skuData, 'Shopify', false, true, pKey);
    });
    
    // Get period label for display
    const getPeriodLabel = () => {
      if (sortedWeeks.length > 0) {
        const dateRange = `${sortedWeeks[0]} to ${sortedWeeks[sortedWeeks.length - 1]}`;
        if (periodsUsed.length > 0) {
          return `${dataSourceLabel} â€¢ Weeks: ${dateRange}, Periods: Q2-Q4 2024 + Monthly 2025`;
        }
        return `${dataSourceLabel} â€¢ ${dateRange}`;
      }
      return dataSourceLabel;
    };
    
    // Calculate profit per unit trends (recent 4 weeks vs prior 4 weeks)
    const skuProfitTrends = Object.entries(skuWeeklyData)
      .filter(([key, data]) => Object.keys(data.weeks).length >= 2)
      .map(([key, data]) => {
        const weekDates = Object.keys(data.weeks).sort();
        const recentWeekDates = weekDates.slice(-4);
        const olderWeekDates = weekDates.slice(-8, -4);
        
        // Calculate averages for recent and older periods
        let recentUnits = 0, recentProfit = 0, recentFees = 0;
        let olderUnits = 0, olderProfit = 0, olderFees = 0;
        
        recentWeekDates.forEach(w => {
          const d = data.weeks[w];
          recentUnits += d.units || 0;
          recentProfit += d.profit || 0;
          recentFees += d.fees || 0;
        });
        
        olderWeekDates.forEach(w => {
          const d = data.weeks[w];
          olderUnits += d.units || 0;
          olderProfit += d.profit || 0;
          olderFees += d.fees || 0;
        });
        
        const recentPPU = recentUnits > 0 ? recentProfit / recentUnits : 0;
        const olderPPU = olderUnits > 0 ? olderProfit / olderUnits : 0;
        const recentFPU = recentUnits > 0 ? recentFees / recentUnits : 0;
        const olderFPU = olderUnits > 0 ? olderFees / olderUnits : 0;
        
        const ppuChange = recentPPU - olderPPU;
        const ppuChangePercent = olderPPU !== 0 ? (ppuChange / Math.abs(olderPPU)) * 100 : 0;
        const fpuChange = recentFPU - olderFPU;
        
        return {
          sku: data.sku,
          name: savedProductNames[data.sku] || data.name,
          channel: data.channel,
          weeklyData: weekDates.slice(-8).map(w => ({ week: w, ...data.weeks[w] })),
          recentPPU,
          olderPPU,
          ppuChange,
          ppuChangePercent,
          recentFPU,
          olderFPU,
          fpuChange,
          recentUnits,
          olderUnits,
          totalUnits: recentUnits + olderUnits,
        };
      })
      .filter(s => s.totalUnits >= 5) // Only SKUs with meaningful volume
      .sort((a, b) => a.ppuChange - b.ppuChange); // Sort by biggest decline first
    
    // Only include SKUs that have data in BOTH periods (older AND recent) to show accurate trends
    const decliningProfitability = skuProfitTrends.filter(s => s.ppuChange < -0.5 && s.olderUnits > 0 && s.recentUnits > 0).slice(0, 10);
    const improvingProfitability = skuProfitTrends.filter(s => s.ppuChange > 0.5 && s.olderUnits > 0 && s.recentUnits > 0).sort((a, b) => b.ppuChange - a.ppuChange).slice(0, 10);
    
    const allSkus = Object.values(skuAggregates).map(s => ({
      ...s,
      channel: s.channels?.join(' + ') || 'Unknown',
      profitPerUnit: s.units > 0 ? s.profit / s.units : 0,
      margin: s.revenue > 0 ? (s.profit / s.revenue) * 100 : 0,
    }));
    const topByRevenue = [...allSkus].sort((a, b) => b.revenue - a.revenue).slice(0, 10);
    const topByUnits = [...allSkus].sort((a, b) => b.units - a.units).slice(0, 10);
    const topByProfit = [...allSkus].sort((a, b) => b.profit - a.profit).slice(0, 10);
    const topByProfitPerUnit = [...allSkus].filter(s => s.units >= 5).sort((a, b) => b.profitPerUnit - a.profitPerUnit).slice(0, 10);
    
    // Calculate growth rates - use baseSku directly now
    const skusWithGrowth = allSkus.map(s => {
      const recent = skuRecentData[s.sku]?.revenue || 0;
      const older = skuOlderData[s.sku]?.revenue || 0;
      const growth = older > 0 ? ((recent - older) / older) * 100 : (recent > 0 ? 100 : 0);
      return { ...s, recentRev: recent, olderRev: older, growth };
    }).filter(s => s.recentRev > 0 || s.olderRev > 0);
    
    const risingStars = [...skusWithGrowth].filter(s => s.growth > 0 && s.recentRev > 50).sort((a, b) => b.growth - a.growth).slice(0, 5);
    const declining = [...skusWithGrowth].filter(s => s.growth < -10 && s.olderRev > 50).sort((a, b) => a.growth - b.growth).slice(0, 5);
    
    // Dead stock (in inventory but no recent sales)
    const invData = selectedInvDate ? invHistory[selectedInvDate] : null;
    const deadStock = invData ? invData.items.filter(item => {
      const hasStock = item.totalQty > 0;
      const noRecentSales = !skuRecentData[item.sku] && !skuRecentData['shop_' + item.sku];
      return hasStock && noRecentSales;
    }).slice(0, 10) : [];
    
    const SkuTable = ({ data, title, icon, color, showProfit = false, showGrowth = false, showProfitPerUnit = false }) => (
      <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
        <h3 className={`text-lg font-semibold ${color} mb-4 flex items-center gap-2`}>{icon}{title}</h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="border-b border-slate-700">
                <th className="text-left text-slate-400 font-medium py-2">#</th>
                <th className="text-left text-slate-400 font-medium py-2">Product</th>
                <th className="text-left text-slate-400 font-medium py-2">Channel</th>
                <th className="text-right text-slate-400 font-medium py-2">Revenue</th>
                <th className="text-right text-slate-400 font-medium py-2">Units</th>
                {showProfit && <th className="text-right text-slate-400 font-medium py-2">Profit</th>}
                {showProfitPerUnit && <th className="text-right text-slate-400 font-medium py-2">$/Unit</th>}
                {showProfitPerUnit && <th className="text-right text-slate-400 font-medium py-2">Margin</th>}
                {showGrowth && <th className="text-right text-slate-400 font-medium py-2">Growth</th>}
              </tr>
            </thead>
            <tbody>
              {data.map((s, i) => (
                <tr key={s.sku + s.channel + i} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                  <td className="py-2 text-slate-500">{i + 1}</td>
                  <td className="py-2"><div className="max-w-[200px] truncate text-white" title={savedProductNames[s.sku] || s.name || s.sku}>{savedProductNames[s.sku] || s.name || s.sku}</div></td>
                  <td className="py-2"><span className={`text-xs px-2 py-0.5 rounded ${s.channel === 'Amazon' ? 'bg-orange-500/20 text-orange-400' : s.channel === 'Amazon + Shopify' ? 'bg-purple-500/20 text-purple-400' : 'bg-green-500/20 text-green-400'}`}>{s.channel}</span></td>
                  <td className="py-2 text-right text-white">{formatCurrency(s.revenue)}</td>
                  <td className="py-2 text-right text-white">{formatNumber(s.units)}</td>
                  {showProfit && <td className={`py-2 text-right ${s.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(s.profit)}</td>}
                  {showProfitPerUnit && <td className={`py-2 text-right ${s.profitPerUnit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(s.profitPerUnit)}</td>}
                  {showProfitPerUnit && <td className={`py-2 text-right ${s.margin >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{s.margin.toFixed(1)}%</td>}
                  {showGrowth && <td className={`py-2 text-right ${s.growth >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{s.growth > 0 ? '+' : ''}{s.growth.toFixed(0)}%</td>}
                </tr>
              ))}
              {data.length === 0 && <tr><td colSpan={showProfit ? 6 : showProfitPerUnit ? 8 : showGrowth ? 6 : 5} className="py-4 text-center text-slate-500">No data available</td></tr>}
            </tbody>
          </table>
        </div>
      </div>
    );
    
    return (
      <div className="min-h-screen bg-slate-950 p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <NavTabs />
          {dataBar}
          
          <div className="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h1 className="text-2xl lg:text-3xl font-bold text-white mb-1">ðŸ† SKU Performance Rankings</h1>
              <p className="text-slate-400 text-sm">Identify your best sellers, most profitable products, and trends â€” <span className="text-white font-medium">{getPeriodLabel()}</span></p>
            </div>
            <div className="flex flex-wrap gap-2">
              {[
                { key: '4weeks', label: '4 Weeks' },
                { key: 'ytd', label: '2026 YTD' },
                { key: '2025', label: '2025' },
                { key: '2024', label: '2024' },
                { key: 'all', label: 'All Time' },
              ].map(r => (
                <button
                  key={r.key}
                  onClick={() => setSkuDateRange(r.key)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    skuDateRange === r.key 
                      ? 'bg-amber-600 text-white' 
                      : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                  }`}
                >
                  {r.label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Summary Stats */}
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4 text-center">
              <p className="text-3xl font-bold text-white">{allSkus.length}</p>
              <p className="text-slate-400 text-sm">Products with Sales</p>
              <p className="text-slate-500 text-xs mt-1">
                {sortedWeeks.length > 0 && periodsUsed.length > 0 
                  ? `${sortedWeeks.length} weeks + ${periodsUsed.length} periods`
                  : sortedWeeks.length > 0 
                    ? `${sortedWeeks.length} weeks`
                    : `${periodsUsed.length} periods`
                }
              </p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4 text-center">
              <p className="text-3xl font-bold text-emerald-400">{formatCurrency(allSkus.reduce((s, x) => s + x.revenue, 0))}</p>
              <p className="text-slate-400 text-sm">Total Revenue</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4 text-center">
              <p className="text-3xl font-bold text-white">{formatNumber(allSkus.reduce((s, x) => s + x.units, 0))}</p>
              <p className="text-slate-400 text-sm">Total Units</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4 text-center">
              <p className="text-3xl font-bold text-amber-400">{formatCurrency(allSkus.reduce((s, x) => s + x.profit, 0))}</p>
              <p className="text-slate-400 text-sm">Total Profit</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4 text-center">
              <p className="text-3xl font-bold text-violet-400">
                {formatCurrency(allSkus.reduce((s, x) => s + x.units, 0) > 0 
                  ? allSkus.reduce((s, x) => s + x.profit, 0) / allSkus.reduce((s, x) => s + x.units, 0) 
                  : 0)}
              </p>
              <p className="text-slate-400 text-sm">Avg $/Unit Profit</p>
            </div>
          </div>
          
          {/* Profit Per Unit Trends - Compact Design */}
          {(decliningProfitability.length > 0 || improvingProfitability.length > 0) && (
            <div className="mb-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
              {/* Declining */}
              {decliningProfitability.length > 0 && (
                <div className="bg-rose-900/10 border border-rose-500/20 rounded-xl p-4">
                  <h3 className="text-sm font-semibold text-rose-400 mb-3 flex items-center gap-2">
                    <AlertTriangle className="w-4 h-4" />
                    Declining Profit/Unit ({decliningProfitability.length})
                  </h3>
                  <div className="space-y-2">
                    {decliningProfitability.slice(0, 5).map(s => (
                      <div key={s.sku} className="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-0">
                        <div className="flex-1 min-w-0">
                          <p className="text-white text-sm font-medium truncate" title={s.name || s.sku}>{s.name || s.sku}</p>
                          <p className="text-slate-500 text-xs">{s.totalUnits} units</p>
                        </div>
                        <div className="text-right ml-3">
                          <p className="text-rose-400 font-bold">{formatCurrency(s.ppuChange)}/unit</p>
                          <p className="text-slate-500 text-xs">{formatCurrency(s.olderPPU)} â†’ {formatCurrency(s.recentPPU)}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                  {decliningProfitability.length > 5 && (
                    <p className="text-slate-500 text-xs mt-2 text-center">+{decliningProfitability.length - 5} more</p>
                  )}
                </div>
              )}
              
              {/* Improving */}
              {improvingProfitability.length > 0 && (
                <div className="bg-emerald-900/10 border border-emerald-500/20 rounded-xl p-4">
                  <h3 className="text-sm font-semibold text-emerald-400 mb-3 flex items-center gap-2">
                    <TrendingUp className="w-4 h-4" />
                    Improving Profit/Unit ({improvingProfitability.length})
                  </h3>
                  <div className="space-y-2">
                    {improvingProfitability.slice(0, 5).map(s => (
                      <div key={s.sku} className="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-0">
                        <div className="flex-1 min-w-0">
                          <p className="text-white text-sm font-medium truncate" title={s.name || s.sku}>{s.name || s.sku}</p>
                          <p className="text-slate-500 text-xs">{s.totalUnits} units</p>
                        </div>
                        <div className="text-right ml-3">
                          <p className="text-emerald-400 font-bold">+{formatCurrency(s.ppuChange)}/unit</p>
                          <p className="text-slate-500 text-xs">{formatCurrency(s.olderPPU)} â†’ {formatCurrency(s.recentPPU)}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                  {improvingProfitability.length > 5 && (
                    <p className="text-slate-500 text-xs mt-2 text-center">+{improvingProfitability.length - 5} more</p>
                  )}
                </div>
              )}
            </div>
          )}
          
          {/* Top Tables */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <SkuTable data={topByRevenue} title="Top 10 by Revenue" icon={<DollarSign className="w-5 h-5" />} color="text-emerald-400" showProfitPerUnit />
            <SkuTable data={topByUnits} title="Top 10 by Units" icon={<Package className="w-5 h-5" />} color="text-blue-400" showProfitPerUnit />
          </div>
          
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <SkuTable data={topByProfit} title="Top 10 Total Profit" icon={<Award className="w-5 h-5" />} color="text-amber-400" showProfit showProfitPerUnit />
            <SkuTable data={topByProfitPerUnit} title="Top 10 Best $/Unit" icon={<Zap className="w-5 h-5" />} color="text-violet-400" showProfitPerUnit />
          </div>
          
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <SkuTable data={risingStars} title="Rising Stars (4wk growth)" icon={<Flame className="w-5 h-5" />} color="text-orange-400" showGrowth showProfitPerUnit />
            <SkuTable data={declining} title="Watch List (Declining)" icon={<TrendingDown className="w-5 h-5" />} color="text-rose-400" showGrowth showProfitPerUnit />
          </div>
          
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {deadStock.length > 0 && (
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                <h3 className="text-lg font-semibold text-slate-400 mb-4 flex items-center gap-2"><Snowflake className="w-5 h-5" />Dead Stock (No Recent Sales)</h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead><tr className="border-b border-slate-700"><th className="text-left text-slate-400 py-2">SKU</th><th className="text-right text-slate-400 py-2">Qty</th><th className="text-right text-slate-400 py-2">Value</th></tr></thead>
                    <tbody>
                      {deadStock.map(s => (
                        <tr key={s.sku} className="border-b border-slate-700/50"><td className="py-2 text-white">{s.sku}</td><td className="py-2 text-right text-white">{formatNumber(s.totalQty)}</td><td className="py-2 text-right text-slate-400">{formatCurrency(s.totalValue)}</td></tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // ==================== ANALYTICS VIEW (Forecast & Compare) ====================
  if (view === 'analytics') {
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const sortedPeriods = Object.keys(allPeriodsData).sort();
    
    // Build SKU data for forecasting - from weekly data
    const skuWeeklyTotals = {};
    sortedWeeks.forEach(w => {
      const week = allWeeksData[w];
      [...(week.amazon?.skuData || []), ...(week.shopify?.skuData || [])].forEach(s => {
        const key = s.sku;
        if (!skuWeeklyTotals[key]) skuWeeklyTotals[key] = { sku: s.sku, name: s.name || '', weeks: {}, source: 'weekly' };
        if (!skuWeeklyTotals[key].weeks[w]) skuWeeklyTotals[key].weeks[w] = { units: 0, revenue: 0, profit: 0 };
        skuWeeklyTotals[key].weeks[w].units += s.unitsSold || 0;
        skuWeeklyTotals[key].weeks[w].revenue += s.netSales || 0;
        const profit = s.netProceeds !== undefined ? s.netProceeds : (s.netSales || 0) - (s.cogs || 0);
        skuWeeklyTotals[key].weeks[w].profit += profit;
      });
    });
    
    // Also pull SKU data from periods if no weekly data
    const skuPeriodTotals = {};
    sortedPeriods.forEach(p => {
      const period = allPeriodsData[p];
      [...(period.amazon?.skuData || []), ...(period.shopify?.skuData || [])].forEach(s => {
        const key = s.sku;
        if (!skuPeriodTotals[key]) {
          skuPeriodTotals[key] = { 
            sku: s.sku, 
            name: s.name || '', 
            totalUnits: 0, 
            totalRevenue: 0, 
            totalProfit: 0,
            periods: [],
            source: 'period'
          };
        }
        skuPeriodTotals[key].totalUnits += s.unitsSold || 0;
        skuPeriodTotals[key].totalRevenue += s.netSales || 0;
        const profit = s.netProceeds !== undefined ? s.netProceeds : (s.netSales || 0) - (s.cogs || 0);
        skuPeriodTotals[key].totalProfit += profit;
        skuPeriodTotals[key].periods.push(p);
      });
    });
    
    // Combine: prefer weekly data, fall back to period data
    const allSkuData = { ...skuWeeklyTotals };
    Object.entries(skuPeriodTotals).forEach(([sku, data]) => {
      if (!allSkuData[sku]) {
        allSkuData[sku] = {
          sku: data.sku,
          name: data.name,
          weeks: { 'period-avg': { units: data.totalUnits, revenue: data.totalRevenue, profit: data.totalProfit } },
          source: 'period',
          totalFromPeriods: { units: data.totalUnits, revenue: data.totalRevenue, profit: data.totalProfit },
        };
      }
    });
    
    // Generate SKU-level forecasts
    const skuForecasts = Object.values(allSkuData).map(sku => {
      const weekDates = Object.keys(sku.weeks).sort().filter(w => w !== 'period-avg');
      
      // If from period data only, use period totals
      if (sku.source === 'period' && sku.totalFromPeriods) {
        return {
          ...sku,
          totalRevenue: sku.totalFromPeriods.revenue,
          totalUnits: sku.totalFromPeriods.units,
          weeksActive: 0,
          periodsActive: sku.totalFromPeriods ? 1 : 0,
          forecast: {
            nextMonthRevenue: sku.totalFromPeriods.revenue / 3, // Rough monthly estimate
            nextMonthUnits: Math.round(sku.totalFromPeriods.units / 3),
            nextMonthProfit: sku.totalFromPeriods.profit / 3,
            trend: 'flat',
            avgWeeklyRevenue: sku.totalFromPeriods.revenue / 12, // Rough weekly estimate
            source: 'period',
          }
        };
      }
      
      // Need at least 1 week of data for basic stats
      if (weekDates.length < 1) return { ...sku, forecast: null };
      
      const revenues = weekDates.map(w => sku.weeks[w]?.revenue || 0);
      const units = weekDates.map(w => sku.weeks[w]?.units || 0);
      const profits = weekDates.map(w => sku.weeks[w]?.profit || 0);
      
      const totalRevenue = revenues.reduce((s, v) => s + v, 0);
      const totalUnits = units.reduce((s, v) => s + v, 0);
      const totalProfit = profits.reduce((s, v) => s + v, 0);
      
      // If less than 4 weeks, just use averages
      if (weekDates.length < 4) {
        const avgRevenue = totalRevenue / weekDates.length;
        const avgUnits = totalUnits / weekDates.length;
        const avgProfit = totalProfit / weekDates.length;
        return {
          ...sku,
          totalRevenue,
          totalUnits,
          weeksActive: weekDates.length,
          forecast: {
            nextMonthRevenue: avgRevenue * 4,
            nextMonthUnits: Math.round(avgUnits * 4),
            nextMonthProfit: avgProfit * 4,
            trend: 'flat',
            avgWeeklyRevenue: avgRevenue,
            source: 'weekly-avg',
          }
        };
      }
      
      // 4+ weeks: use linear regression
      const recentWeeks = weekDates.slice(-8);
      const recentRevenues = recentWeeks.map(w => sku.weeks[w]?.revenue || 0);
      const recentUnits = recentWeeks.map(w => sku.weeks[w]?.units || 0);
      const recentProfits = recentWeeks.map(w => sku.weeks[w]?.profit || 0);
      
      // Simple linear regression
      const calcTrend = (data) => {
        const n = data.length;
        if (n === 0) return { slope: 0, intercept: 0, avg: 0 };
        const sumX = data.reduce((s, _, i) => s + i, 0);
        const sumY = data.reduce((s, v) => s + v, 0);
        const sumXY = data.reduce((s, v, i) => s + i * v, 0);
        const sumX2 = data.reduce((s, _, i) => s + i * i, 0);
        const denom = n * sumX2 - sumX * sumX;
        const slope = denom !== 0 ? (n * sumXY - sumX * sumY) / denom : 0;
        const intercept = (sumY - slope * sumX) / n;
        return { slope, intercept, avg: sumY / n };
      };
      
      const revTrend = calcTrend(recentRevenues);
      const unitTrend = calcTrend(recentUnits);
      const profTrend = calcTrend(recentProfits);
      
      const n = recentRevenues.length;
      const nextMonthRev = [0, 1, 2, 3].reduce((sum, i) => sum + Math.max(0, revTrend.intercept + revTrend.slope * (n + i)), 0);
      const nextMonthUnits = [0, 1, 2, 3].reduce((sum, i) => sum + Math.max(0, unitTrend.intercept + unitTrend.slope * (n + i)), 0);
      const nextMonthProfit = [0, 1, 2, 3].reduce((sum, i) => sum + profTrend.intercept + profTrend.slope * (n + i), 0);
      
      return {
        ...sku,
        totalRevenue,
        totalUnits,
        weeksActive: weekDates.length,
        forecast: {
          nextMonthRevenue: nextMonthRev,
          nextMonthUnits: Math.round(nextMonthUnits),
          nextMonthProfit: nextMonthProfit,
          trend: revTrend.slope > 0 ? 'up' : revTrend.slope < 0 ? 'down' : 'flat',
          avgWeeklyRevenue: revTrend.avg,
          source: 'weekly-trend',
        }
      };
    }).filter(s => s.totalRevenue > 0 || s.totalUnits > 0).sort((a, b) => b.totalRevenue - a.totalRevenue);
    
    // Week comparison data
    const weekCompareData = selectedWeeksToCompare.map(w => {
      const data = allWeeksData[w];
      if (!data) return null;
      return {
        week: w,
        revenue: data.total?.revenue || 0,
        profit: data.total?.netProfit || 0,
        units: data.total?.units || 0,
        adSpend: data.total?.adSpend || 0,
        cogs: data.total?.cogs || 0,
        amazonRev: data.amazon?.revenue || 0,
        shopifyRev: data.shopify?.revenue || 0,
        margin: data.total?.revenue ? (data.total.netProfit / data.total.revenue * 100) : 0,
      };
    }).filter(Boolean);
    
    // SKU comparison data  
    const skuCompareData = selectedSkusToCompare.map(sku => {
      const data = allSkuData[sku];
      if (!data) return null;
      
      // Handle period-only data
      if (data.totalFromPeriods) {
        return {
          sku: data.sku,
          name: data.name,
          units: data.totalFromPeriods.units,
          revenue: data.totalFromPeriods.revenue,
          profit: data.totalFromPeriods.profit,
          profitPerUnit: data.totalFromPeriods.units > 0 ? data.totalFromPeriods.profit / data.totalFromPeriods.units : 0,
          margin: data.totalFromPeriods.revenue > 0 ? (data.totalFromPeriods.profit / data.totalFromPeriods.revenue * 100) : 0,
          weeksActive: 0,
          source: 'period',
        };
      }
      
      const totals = Object.values(data.weeks).reduce((acc, w) => ({
        units: acc.units + w.units,
        revenue: acc.revenue + w.revenue,
        profit: acc.profit + w.profit,
      }), { units: 0, revenue: 0, profit: 0 });
      return {
        sku: data.sku,
        name: data.name,
        ...totals,
        profitPerUnit: totals.units > 0 ? totals.profit / totals.units : 0,
        margin: totals.revenue > 0 ? (totals.profit / totals.revenue * 100) : 0,
        weeksActive: Object.keys(data.weeks).filter(w => w !== 'period-avg').length,
        source: 'weekly',
      };
    }).filter(Boolean);
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          
          <div className="mb-6">
            <h1 className="text-2xl lg:text-3xl font-bold text-white">Analytics & Forecasting</h1>
            <p className="text-slate-400">Predict future performance and compare metrics</p>
          </div>
          
          <NavTabs />
          
          {/* Analytics Sub-tabs */}
          <div className="flex flex-wrap gap-2 mb-6 p-1 bg-slate-800/50 rounded-xl w-fit">
            <button onClick={() => setAnalyticsTab('forecast')} className={`px-4 py-2 rounded-lg text-sm font-medium ${analyticsTab === 'forecast' ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <TrendingUp className="w-4 h-4 inline mr-1" />Total Forecast
            </button>
            <button onClick={() => setAnalyticsTab('amazon-accuracy')} className={`px-4 py-2 rounded-lg text-sm font-medium ${analyticsTab === 'amazon-accuracy' ? 'bg-orange-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <Brain className="w-4 h-4 inline mr-1" />AI Learning
            </button>
            <button onClick={() => setAnalyticsTab('sku-forecast')} className={`px-4 py-2 rounded-lg text-sm font-medium ${analyticsTab === 'sku-forecast' ? 'bg-pink-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <Package className="w-4 h-4 inline mr-1" />SKU Forecast
            </button>
            <button onClick={() => setAnalyticsTab('compare-weeks')} className={`px-4 py-2 rounded-lg text-sm font-medium ${analyticsTab === 'compare-weeks' ? 'bg-violet-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <GitCompare className="w-4 h-4 inline mr-1" />Compare Weeks
            </button>
            <button onClick={() => setAnalyticsTab('compare-skus')} className={`px-4 py-2 rounded-lg text-sm font-medium ${analyticsTab === 'compare-skus' ? 'bg-amber-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
              <Trophy className="w-4 h-4 inline mr-1" />Compare SKUs
            </button>
          </div>
          
          {/* AMAZON FORECAST ACCURACY TAB */}
          {analyticsTab === 'amazon-accuracy' && (
            <div className="space-y-6">
              {forecastAccuracyMetrics ? (
                <>
                  {/* Accuracy Summary Cards */}
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="bg-gradient-to-br from-orange-900/40 to-amber-900/20 rounded-2xl border border-orange-500/30 p-5">
                      <p className="text-orange-400 text-sm font-medium mb-1">Overall Accuracy</p>
                      <p className="text-3xl font-bold text-white">{forecastAccuracyMetrics.avgAccuracy.toFixed(1)}%</p>
                      <p className="text-slate-400 text-xs mt-1">Based on {forecastAccuracyMetrics.totalWeeks} weeks</p>
                    </div>
                    <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
                      <p className="text-slate-400 text-sm font-medium mb-1">Beat / Missed</p>
                      <p className="text-2xl font-bold">
                        <span className="text-emerald-400">{forecastAccuracyMetrics.beatCount}</span>
                        <span className="text-slate-500 mx-2">/</span>
                        <span className="text-rose-400">{forecastAccuracyMetrics.missedCount}</span>
                      </p>
                      <p className="text-slate-400 text-xs mt-1">Win rate: {((forecastAccuracyMetrics.beatCount / forecastAccuracyMetrics.totalWeeks) * 100).toFixed(0)}%</p>
                    </div>
                    <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
                      <p className="text-slate-400 text-sm font-medium mb-1">Avg Revenue Variance</p>
                      <p className={`text-2xl font-bold ${forecastAccuracyMetrics.avgRevenueVariance >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                        {forecastAccuracyMetrics.avgRevenueVariance >= 0 ? '+' : ''}{forecastAccuracyMetrics.avgRevenueVariance.toFixed(1)}%
                      </p>
                      <p className="text-slate-400 text-xs mt-1">{forecastAccuracyMetrics.avgRevenueVariance >= 0 ? 'Above' : 'Below'} forecast on average</p>
                    </div>
                    <div className={`rounded-2xl border p-5 ${forecastAccuracyMetrics.accuracyTrend >= 0 ? 'bg-emerald-900/20 border-emerald-500/30' : 'bg-rose-900/20 border-rose-500/30'}`}>
                      <p className={`text-sm font-medium mb-1 ${forecastAccuracyMetrics.accuracyTrend >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>Accuracy Trend</p>
                      <p className="text-2xl font-bold text-white flex items-center gap-2">
                        {forecastAccuracyMetrics.accuracyTrend >= 0 ? <TrendingUp className="w-6 h-6 text-emerald-400" /> : <TrendingDown className="w-6 h-6 text-rose-400" />}
                        {forecastAccuracyMetrics.accuracyTrend >= 0 ? '+' : ''}{forecastAccuracyMetrics.accuracyTrend.toFixed(1)}%
                      </p>
                      <p className="text-slate-400 text-xs mt-1">{forecastAccuracyMetrics.accuracyTrend >= 0 ? 'Improving' : 'Declining'} vs prior period</p>
                    </div>
                  </div>
                  
                  {/* Bias Analysis */}
                  <div className={`rounded-xl border p-4 ${
                    forecastAccuracyMetrics.bias === 'over' ? 'bg-amber-900/20 border-amber-500/30' :
                    forecastAccuracyMetrics.bias === 'under' ? 'bg-emerald-900/20 border-emerald-500/30' :
                    'bg-slate-800/50 border-slate-700'
                  }`}>
                    <h3 className="font-semibold text-white mb-2 flex items-center gap-2">
                      <AlertCircle className="w-5 h-5" />
                      Forecast Bias Analysis
                    </h3>
                    <p className="text-slate-300">{forecastAccuracyMetrics.biasDescription}</p>
                    {forecastAccuracyMetrics.bias !== 'neutral' && (
                      <p className="text-slate-400 text-sm mt-2">
                        ðŸ’¡ Tip: {forecastAccuracyMetrics.bias === 'over' 
                          ? 'Consider multiplying Amazon forecasts by 0.9-0.95 for more realistic expectations.'
                          : 'Amazon may be conservative - you can expect to beat forecasts more often than not.'}
                      </p>
                    )}
                  </div>
                  
                  {/* Week-by-Week Comparison Table */}
                  <div className="bg-slate-800/50 rounded-2xl border border-slate-700 overflow-hidden">
                    <div className="p-4 border-b border-slate-700">
                      <h3 className="font-semibold text-white">Week-by-Week Comparison</h3>
                      <p className="text-slate-400 text-sm">Forecast vs Actual for each week {getAmazonForecastComparison.some(c => c.matchType === 'fuzzy') && '(includes fuzzy matches)'}</p>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-slate-900/50">
                          <tr>
                            <th className="text-left px-4 py-3 text-slate-400 text-xs uppercase">Week</th>
                            <th className="text-right px-4 py-3 text-slate-400 text-xs uppercase">Forecast</th>
                            <th className="text-right px-4 py-3 text-slate-400 text-xs uppercase">Actual</th>
                            <th className="text-right px-4 py-3 text-slate-400 text-xs uppercase">Variance</th>
                            <th className="text-right px-4 py-3 text-slate-400 text-xs uppercase">Accuracy</th>
                            <th className="text-center px-4 py-3 text-slate-400 text-xs uppercase">Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          {getAmazonForecastComparison.map(comp => (
                            <tr key={comp.weekEnding} className="border-t border-slate-700/50 hover:bg-slate-700/20">
                              <td className="px-4 py-3 text-white">
                                {new Date(comp.weekEnding + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                {comp.matchType === 'fuzzy' && <span className="text-amber-400 text-xs ml-1">~</span>}
                              </td>
                              <td className="px-4 py-3 text-right text-orange-400">{formatCurrency(comp.forecast.revenue)}</td>
                              <td className="px-4 py-3 text-right text-white font-medium">{formatCurrency(comp.actual.revenue)}</td>
                              <td className={`px-4 py-3 text-right font-medium ${comp.variance.revenuePercent >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                {comp.variance.revenuePercent >= 0 ? '+' : ''}{comp.variance.revenuePercent.toFixed(1)}%
                              </td>
                              <td className={`px-4 py-3 text-right ${comp.accuracy >= 90 ? 'text-emerald-400' : comp.accuracy >= 80 ? 'text-amber-400' : 'text-rose-400'}`}>
                                {comp.accuracy.toFixed(1)}%
                              </td>
                              <td className="px-4 py-3 text-center">
                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${comp.status === 'beat' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`}>
                                  {comp.status === 'beat' ? 'âœ“ Beat' : 'âœ— Missed'}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                  
                  {/* ML Insights Panel */}
                  {mlTrainingData && (
                    <div className="bg-gradient-to-r from-violet-900/30 to-indigo-900/30 rounded-2xl border border-violet-500/30 p-5">
                      <h3 className="font-semibold text-white mb-3 flex items-center gap-2">
                        <Zap className="w-5 h-5 text-violet-400" />
                        Machine Learning Insights
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                        <div>
                          <p className="text-slate-400">Training Samples</p>
                          <p className="text-white font-semibold text-lg">{mlTrainingData.summary.totalSamples}</p>
                        </div>
                        <div>
                          <p className="text-slate-400">Amazon Bias</p>
                          <p className={`font-semibold text-lg ${mlTrainingData.summary.bias > 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                            {mlTrainingData.summary.bias > 0 ? 'Under-forecasts' : 'Over-forecasts'} by {Math.abs(mlTrainingData.summary.bias).toFixed(1)}%
                          </p>
                        </div>
                        <div>
                          <p className="text-slate-400">Suggested Multiplier</p>
                          <p className="text-violet-400 font-semibold text-lg">{mlTrainingData.summary.correctionFactor.toFixed(3)}x</p>
                        </div>
                        <div>
                          <p className="text-slate-400">Prediction Variance</p>
                          <p className="text-white font-semibold text-lg">Â±{mlTrainingData.summary.stdDev.toFixed(1)}%</p>
                        </div>
                      </div>
                      <p className="text-slate-500 text-xs mt-3">
                        ðŸ’¡ Apply the multiplier to Amazon's forecast for a corrected prediction: Forecast Ã— {mlTrainingData.summary.correctionFactor.toFixed(3)} = Adjusted Forecast
                      </p>
                    </div>
                  )}
                </>
              ) : (
                /* Show pending forecasts even when no matches yet */
                <div className="space-y-6">
                  {pendingForecasts.length > 0 && (
                    <div className="bg-amber-900/20 rounded-2xl border border-amber-500/30 p-5">
                      <h3 className="font-semibold text-white mb-3 flex items-center gap-2">
                        <Clock className="w-5 h-5 text-amber-400" />
                        Pending Forecasts ({pendingForecasts.length})
                      </h3>
                      <p className="text-slate-400 text-sm mb-4">These forecasts are waiting for matching actual data</p>
                      <div className="space-y-2">
                        {pendingForecasts.map(pf => (
                          <div key={pf.weekEnding} className="flex items-center justify-between bg-slate-800/50 rounded-lg p-3">
                            <div>
                              <p className="text-white font-medium">Week ending {new Date(pf.weekEnding + 'T00:00:00').toLocaleDateString()}</p>
                              <p className="text-slate-400 text-sm">{formatCurrency(pf.forecast.totals?.sales || pf.forecast.totalSales || 0)} forecasted â€¢ {pf.forecast.skuCount || 0} SKUs</p>
                            </div>
                            <div className="text-right">
                              {pf.isPast ? (
                                <span className="text-rose-400 text-sm">â³ Awaiting actual data</span>
                              ) : (
                                <span className="text-amber-400 text-sm">{pf.daysUntil} days until week ends</span>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  <div className="bg-slate-800/30 rounded-2xl border border-dashed border-slate-600 p-8 text-center">
                    <Target className="w-12 h-12 text-slate-600 mx-auto mb-4" />
                    <h3 className="text-xl font-semibold text-white mb-2">No Matching Forecast & Actual Data Yet</h3>
                    <p className="text-slate-400 mb-4">Upload actual weekly data for a forecasted week to see accuracy analysis</p>
                    <p className="text-slate-500 text-sm mb-4">Fuzzy matching enabled: weeks within 3 days will match automatically</p>
                  
                    {/* Debug info */}
                    <div className="bg-slate-900/50 rounded-xl p-4 text-left max-w-lg mx-auto mb-4">
                      <p className="text-slate-500 text-xs uppercase mb-3">Data Matching Status</p>
                      <p className="text-slate-400 text-xs mb-3">Your 7-day, 30-day, and 60-day forecasts are automatically split into weekly buckets for tracking accuracy.</p>
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <p className="text-orange-400 font-medium mb-2">Forecast Weeks (from uploads):</p>
                          {Object.keys(amazonForecasts).length > 0 ? (
                            <ul className="text-slate-400 space-y-1">
                              {Object.keys(amazonForecasts).sort().slice(0, 6).map(k => (
                                <li key={k} className="text-xs">{k}</li>
                              ))}
                              {Object.keys(amazonForecasts).length > 6 && (
                                <li className="text-slate-500 text-xs">+{Object.keys(amazonForecasts).length - 6} more</li>
                              )}
                            </ul>
                          ) : <p className="text-slate-500">None - upload 7/30/60 day forecast</p>}
                        </div>
                        <div>
                          <p className="text-blue-400 font-medium mb-2">Actual Weeks (uploaded):</p>
                          {Object.keys(allWeeksData).length > 0 ? (
                            <ul className="text-slate-400 space-y-1">
                              {Object.keys(allWeeksData).sort().reverse().slice(0, 6).map(k => (
                                <li key={k} className="text-xs">{k}</li>
                              ))}
                            </ul>
                          ) : <p className="text-slate-500">None</p>}
                        </div>
                      </div>
                      <p className="text-slate-500 text-xs mt-3 border-t border-slate-700 pt-3">
                        ðŸ’¡ When a forecast week matches an actual week, accuracy is calculated automatically.
                      </p>
                    </div>
                  
                    <div className="flex gap-3 justify-center">
                      <button onClick={() => { setUploadTab('forecast'); setView('upload'); }} className="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg text-white">
                        Upload Forecast
                      </button>
                      <button onClick={() => { setUploadTab('weekly'); setView('upload'); }} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white">
                        Upload Weekly Data
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
          
          {/* TOTAL FORECAST TAB */}
          {analyticsTab === 'forecast' && (aiForecasts?.salesForecast || generateForecast) && (
            <div className="space-y-6">
              {/* AI Forecast from Dashboard (Multi-Signal) - Preferred */}
              {aiForecasts?.salesForecast?.next4Weeks?.[0] && (
                <>
                  <div className="bg-gradient-to-br from-purple-900/30 to-indigo-900/20 rounded-xl border border-purple-500/30 p-4 mb-2">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <Brain className="w-5 h-5 text-purple-400" />
                        <span className="text-purple-300 font-medium">Multi-Signal AI Forecast</span>
                      </div>
                      <button 
                        onClick={generateAIForecasts}
                        disabled={aiForecastLoading}
                        className="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1"
                      >
                        {aiForecastLoading ? <Loader2 className="w-3 h-3 animate-spin" /> : <RefreshCw className="w-3 h-3" />}
                        {aiForecastLoading ? 'Analyzing...' : 'Refresh'}
                      </button>
                    </div>
                    {aiForecasts.calculatedSignals && (
                      <div className="mt-2 flex gap-4 text-xs text-slate-400">
                        <span>ðŸ“Š Daily avg: {formatCurrency(aiForecasts.calculatedSignals.dailyAvg7)}/day</span>
                        <span>ðŸ“ˆ Momentum: {aiForecasts.calculatedSignals.momentum > 0 ? '+' : ''}{aiForecasts.calculatedSignals.momentum?.toFixed(1)}%</span>
                        {aiForecasts.dataPoints?.amazonForecastWeeks > 0 && (
                          <span>ðŸ›’ Amazon: {aiForecasts.dataPoints.amazonForecastWeeks} weeks</span>
                        )}
                      </div>
                    )}
                  </div>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="bg-gradient-to-br from-emerald-900/40 to-emerald-800/20 rounded-2xl border border-emerald-500/30 p-6">
                      <p className="text-emerald-400 text-sm font-medium mb-1">Next Week Prediction</p>
                      <p className="text-3xl font-bold text-white">{formatCurrency(aiForecasts.salesForecast.next4Weeks[0].predictedRevenue || 0)}</p>
                      <p className="text-slate-400 text-sm mt-1">
                        {aiForecasts.salesForecast.next4Weeks[0].confidence} confidence
                      </p>
                    </div>
                    <div className={`rounded-2xl border p-6 ${(aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0) >= 0 ? 'bg-gradient-to-br from-blue-900/40 to-blue-800/20 border-blue-500/30' : 'bg-gradient-to-br from-rose-900/40 to-rose-800/20 border-rose-500/30'}`}>
                      <p className={`text-sm font-medium mb-1 ${(aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0) >= 0 ? 'text-blue-400' : 'text-rose-400'}`}>Next Week Profit</p>
                      <p className="text-3xl font-bold text-white">{formatCurrency(aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0)}</p>
                      {goals.weeklyProfit > 0 && (
                        <p className={`text-sm mt-1 ${(aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0) >= goals.weeklyProfit ? 'text-emerald-400' : 'text-amber-400'}`}>
                          {(aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0) >= goals.weeklyProfit ? 'âœ“ On track' : `${formatCurrency(goals.weeklyProfit - (aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0))} below goal`}
                        </p>
                      )}
                    </div>
                    <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
                      <p className="text-slate-400 text-sm font-medium mb-1">Next Week Units</p>
                      <p className="text-3xl font-bold text-white">{formatNumber(aiForecasts.salesForecast.next4Weeks[0].predictedUnits || 0)}</p>
                      <p className="text-slate-500 text-sm mt-1">Daily avg: {formatNumber(Math.round((aiForecasts.salesForecast.next4Weeks[0].predictedUnits || 0) / 7))}/day</p>
                    </div>
                  </div>
                  
                  <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
                    <h3 className="text-lg font-semibold text-white mb-4">4-Week Projections</h3>
                    <div className="grid grid-cols-4 gap-4">
                      {aiForecasts.salesForecast.next4Weeks.map((w, i) => (
                        <div key={i} className="bg-slate-900/50 rounded-xl p-4 text-center">
                          <p className="text-slate-500 text-sm mb-2">Week {i + 1}</p>
                          <p className="text-xl font-bold text-white">{formatCurrency(w.predictedRevenue || 0)}</p>
                          <p className={`text-sm ${(w.predictedProfit || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(w.predictedProfit || 0)} profit</p>
                          <p className="text-slate-500 text-xs mt-1">{w.predictedUnits || 0} units</p>
                          <p className="text-purple-400 text-xs mt-1">{w.confidence}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  <p className="text-slate-500 text-sm text-center">
                    Multi-signal forecast using daily trends, weekly patterns, momentum analysis
                    {aiForecasts.dataPoints?.amazonForecastWeeks > 0 && ` + ${aiForecasts.dataPoints.amazonForecastWeeks} Amazon forecast weeks`}
                  </p>
                </>
              )}
              
              {/* Fallback to generateForecast if no aiForecasts */}
              {!aiForecasts?.salesForecast?.next4Weeks?.[0] && generateForecast && (
                <>
                  {/* Learning Status Banner */}
                  {enhancedForecast && (
                    <div className={`rounded-xl p-4 flex items-center justify-between ${enhancedForecast.corrected ? 'bg-purple-900/30 border border-purple-500/30' : 'bg-slate-800/50 border border-slate-700'}`}>
                      <div className="flex items-center gap-3">
                        <Brain className={`w-5 h-5 ${enhancedForecast.corrected ? 'text-purple-400' : 'text-slate-400'}`} />
                        <div>
                          <p className={`font-medium ${enhancedForecast.corrected ? 'text-purple-300' : 'text-slate-300'}`}>
                            AI Self-Learning: {enhancedForecast.corrected ? 'ACTIVE' : 'Training'}
                          </p>
                          <p className="text-xs text-slate-400">{enhancedForecast.correctionNote}</p>
                        </div>
                      </div>
                      {enhancedForecast.learningStatus && (
                        <div className="text-right text-xs">
                          <p className="text-slate-400">{enhancedForecast.learningStatus.samples} samples</p>
                          <p className={enhancedForecast.corrected ? 'text-purple-400' : 'text-slate-500'}>{enhancedForecast.learningStatus.confidence.toFixed(0)}% confidence</p>
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* Generate AI Forecast Button */}
                  <div className="bg-purple-900/20 border border-purple-500/30 rounded-xl p-4 flex items-center justify-between">
                    <div>
                      <p className="text-purple-300 font-medium">Upgrade to Multi-Signal AI Forecast</p>
                      <p className="text-slate-400 text-sm">Get more accurate predictions using daily data, momentum, and Amazon forecasts</p>
                    </div>
                    <button 
                      onClick={generateAIForecasts}
                      disabled={aiForecastLoading}
                      className="px-4 py-2 bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 rounded-lg text-white text-sm flex items-center gap-2"
                    >
                      {aiForecastLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Brain className="w-4 h-4" />}
                      {aiForecastLoading ? 'Analyzing...' : 'Generate AI Forecast'}
                    </button>
                  </div>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="bg-gradient-to-br from-emerald-900/40 to-emerald-800/20 rounded-2xl border border-emerald-500/30 p-6">
                      <p className="text-emerald-400 text-sm font-medium mb-1">Projected Monthly Revenue</p>
                      <p className="text-3xl font-bold text-white">{formatCurrency((enhancedForecast || generateForecast).monthly.revenue)}</p>
                      {enhancedForecast?.corrected && enhancedForecast.originalMonthly && (
                        <p className="text-xs text-slate-500 mt-1">
                          Original: {formatCurrency(enhancedForecast.originalMonthly.revenue)} â†’ Corrected
                        </p>
                      )}
                      <p className={`text-sm mt-1 flex items-center gap-1 ${generateForecast.trend.revenue === 'up' ? 'text-emerald-400' : generateForecast.trend.revenue === 'down' ? 'text-rose-400' : 'text-slate-400'}`}>
                        {generateForecast.trend.revenue === 'up' ? <TrendingUp className="w-4 h-4" /> : generateForecast.trend.revenue === 'down' ? <TrendingDown className="w-4 h-4" /> : <Minus className="w-4 h-4" />}
                        {generateForecast.trend.revenueChange > 0 ? '+' : ''}{generateForecast.trend.revenueChange.toFixed(1)}% weekly trend
                      </p>
                    </div>
                    <div className={`rounded-2xl border p-6 ${(enhancedForecast || generateForecast).monthly.profit >= 0 ? 'bg-gradient-to-br from-blue-900/40 to-blue-800/20 border-blue-500/30' : 'bg-gradient-to-br from-rose-900/40 to-rose-800/20 border-rose-500/30'}`}>
                      <p className={`text-sm font-medium mb-1 ${(enhancedForecast || generateForecast).monthly.profit >= 0 ? 'text-blue-400' : 'text-rose-400'}`}>Projected Monthly Profit</p>
                      <p className="text-3xl font-bold text-white">{formatCurrency((enhancedForecast || generateForecast).monthly.profit)}</p>
                      {goals.monthlyProfit > 0 && (
                        <p className={`text-sm mt-1 ${(enhancedForecast || generateForecast).monthly.profit >= goals.monthlyProfit ? 'text-emerald-400' : 'text-amber-400'}`}>
                          {(enhancedForecast || generateForecast).monthly.profit >= goals.monthlyProfit ? 'âœ“ On track for goal' : `${formatCurrency(goals.monthlyProfit - (enhancedForecast || generateForecast).monthly.profit)} below goal`}
                        </p>
                      )}
                    </div>
                    <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
                      <p className="text-slate-400 text-sm font-medium mb-1">Projected Monthly Units</p>
                      <p className="text-3xl font-bold text-white">{formatNumber((enhancedForecast || generateForecast).monthly.units)}</p>
                      <p className="text-slate-500 text-sm mt-1">Confidence: {generateForecast.confidence}%</p>
                    </div>
                  </div>
                  
                  <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
                    <h3 className="text-lg font-semibold text-white mb-4">Weekly Projections</h3>
                    <div className="grid grid-cols-4 gap-4">
                      {(enhancedForecast || generateForecast).weekly.map((w, i) => (
                        <div key={i} className="bg-slate-900/50 rounded-xl p-4 text-center">
                          <p className="text-slate-500 text-sm mb-2">{w.week}</p>
                          <p className="text-xl font-bold text-white">{formatCurrency(w.revenue)}</p>
                          <p className={`text-sm ${w.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(w.profit)} profit</p>
                          <p className="text-slate-500 text-xs mt-1">{w.units} units</p>
                          {w.correctionApplied && (
                            <p className="text-purple-400 text-xs mt-1">âœ¨ AI-corrected</p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  <p className="text-slate-500 text-sm text-center">
                    Based on {generateForecast.basedOn} weeks of historical data
                    {generateForecast.amazonBlended && ' + Amazon forecast data'}
                    {generateForecast.periodsAvailable > 0 && ` + ${generateForecast.periodsAvailable} historical periods for seasonality`}
                    {generateForecast.seasonalityApplied && ` (${((generateForecast.seasonalityApplied - 1) * 100).toFixed(0)}% YoY adjustment)`}
                    {enhancedForecast?.corrected && ' + AI self-learning corrections'}
                  </p>
                </>
              )}
            </div>
          )}
          
          {analyticsTab === 'forecast' && !generateForecast && !aiForecasts?.salesForecast && (
            <div className="bg-slate-800/30 rounded-2xl border border-dashed border-slate-600 p-12 text-center">
              <TrendingUp className="w-12 h-12 text-slate-600 mx-auto mb-4" />
              <p className="text-slate-400 text-lg">Need data for forecasting</p>
              <p className="text-slate-500 text-sm mt-2">Upload at least 4 weeks of data or 7+ days of daily data</p>
              <button 
                onClick={generateAIForecasts}
                disabled={aiForecastLoading || (Object.keys(allWeeksData).length < 2 && Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).length < 7)}
                className="mt-4 px-4 py-2 bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 disabled:text-slate-500 rounded-lg text-white text-sm flex items-center gap-2 mx-auto"
              >
                {aiForecastLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Brain className="w-4 h-4" />}
                {aiForecastLoading ? 'Analyzing...' : 'Generate AI Forecast'}
              </button>
            </div>
          )}
          
          {/* SKU FORECAST TAB */}
          {analyticsTab === 'sku-forecast' && (
            <div className="space-y-6">
              <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <TrendingUp className="w-5 h-5 text-emerald-400" />
                  SKU-Level Forecast (Next Month)
                </h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="border-b border-slate-700">
                        <th className="text-left text-slate-400 font-medium py-2">SKU</th>
                        <th className="text-left text-slate-400 font-medium py-2">Product</th>
                        <th className="text-right text-slate-400 font-medium py-2">Avg/Week</th>
                        <th className="text-right text-slate-400 font-medium py-2">Trend</th>
                        <th className="text-right text-slate-400 font-medium py-2">Proj. Revenue</th>
                        <th className="text-right text-slate-400 font-medium py-2">Proj. Units</th>
                        <th className="text-right text-slate-400 font-medium py-2">Proj. Profit</th>
                      </tr>
                    </thead>
                    <tbody>
                      {skuForecasts.slice(0, 20).map((s, i) => (
                        <tr key={s.sku} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                          <td className="py-3 text-white font-mono text-xs">{s.sku}</td>
                          <td className="py-3 text-slate-300 max-w-[200px] truncate">{s.name || 'â€”'}</td>
                          <td className="py-3 text-right text-white">{s.forecast ? formatCurrency(s.forecast.avgWeeklyRevenue) : 'â€”'}</td>
                          <td className="py-3 text-right">
                            {s.forecast ? (
                              <span className={`flex items-center justify-end gap-1 ${s.forecast.trend === 'up' ? 'text-emerald-400' : s.forecast.trend === 'down' ? 'text-rose-400' : 'text-slate-400'}`}>
                                {s.forecast.trend === 'up' ? <TrendingUp className="w-4 h-4" /> : s.forecast.trend === 'down' ? <TrendingDown className="w-4 h-4" /> : <Minus className="w-4 h-4" />}
                                {s.forecast.trend}
                              </span>
                            ) : 'â€”'}
                          </td>
                          <td className="py-3 text-right text-emerald-400 font-medium">{s.forecast ? formatCurrency(s.forecast.nextMonthRevenue) : 'â€”'}</td>
                          <td className="py-3 text-right text-white">{s.forecast ? formatNumber(s.forecast.nextMonthUnits) : 'â€”'}</td>
                          <td className={`py-3 text-right font-medium ${s.forecast?.nextMonthProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                            {s.forecast ? formatCurrency(s.forecast.nextMonthProfit) : 'â€”'}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="border-t-2 border-slate-600">
                      <tr className="font-semibold">
                        <td colSpan="4" className="py-3 text-white">Total (Top 20 SKUs)</td>
                        <td className="py-3 text-right text-emerald-400">{formatCurrency(skuForecasts.slice(0, 20).reduce((s, x) => s + (x.forecast?.nextMonthRevenue || 0), 0))}</td>
                        <td className="py-3 text-right text-white">{formatNumber(skuForecasts.slice(0, 20).reduce((s, x) => s + (x.forecast?.nextMonthUnits || 0), 0))}</td>
                        <td className="py-3 text-right text-emerald-400">{formatCurrency(skuForecasts.slice(0, 20).reduce((s, x) => s + (x.forecast?.nextMonthProfit || 0), 0))}</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
          )}
          
          {/* COMPARE WEEKS TAB */}
          {analyticsTab === 'compare-weeks' && (
            <div className="space-y-6">
              <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
                <h3 className="text-lg font-semibold text-white mb-4">Select Weeks to Compare (up to 4)</h3>
                <div className="flex flex-wrap gap-2 mb-4">
                  {sortedWeeks.slice().reverse().slice(0, 12).map(w => {
                    const isSelected = selectedWeeksToCompare.includes(w);
                    return (
                      <button key={w} onClick={() => {
                        if (isSelected) setSelectedWeeksToCompare(prev => prev.filter(x => x !== w));
                        else if (selectedWeeksToCompare.length < 4) setSelectedWeeksToCompare(prev => [...prev, w]);
                      }} className={`px-3 py-2 rounded-lg text-sm ${isSelected ? 'bg-violet-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>
                        {new Date(w + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        {isSelected && <Check className="w-4 h-4 inline ml-1" />}
                      </button>
                    );
                  })}
                </div>
                {selectedWeeksToCompare.length > 0 && (
                  <button onClick={() => setSelectedWeeksToCompare([])} className="text-sm text-slate-400 hover:text-white">Clear selection</button>
                )}
              </div>
              
              {weekCompareData.length >= 2 && (
                <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6 overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="border-b border-slate-700">
                        <th className="text-left text-slate-400 font-medium py-2">Metric</th>
                        {weekCompareData.map(w => (
                          <th key={w.week} className="text-right text-white font-medium py-2">
                            {new Date(w.week + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                          </th>
                        ))}
                        {weekCompareData.length === 2 && <th className="text-right text-slate-400 font-medium py-2">Difference</th>}
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-700/50">
                      {[
                        { key: 'revenue', label: 'Revenue', format: formatCurrency, color: 'text-white' },
                        { key: 'profit', label: 'Profit', format: formatCurrency, color: 'profit' },
                        { key: 'units', label: 'Units', format: formatNumber, color: 'text-white' },
                        { key: 'margin', label: 'Margin', format: v => v.toFixed(1) + '%', color: 'text-white' },
                        { key: 'adSpend', label: 'Ad Spend', format: formatCurrency, color: 'text-violet-400' },
                        { key: 'amazonRev', label: 'Amazon', format: formatCurrency, color: 'text-orange-400' },
                        { key: 'shopifyRev', label: 'Shopify', format: formatCurrency, color: 'text-blue-400' },
                      ].map(metric => (
                        <tr key={metric.key}>
                          <td className="py-3 text-slate-400">{metric.label}</td>
                          {weekCompareData.map(w => (
                            <td key={w.week} className={`py-3 text-right font-medium ${metric.color === 'profit' ? (w[metric.key] >= 0 ? 'text-emerald-400' : 'text-rose-400') : metric.color}`}>
                              {metric.format(w[metric.key])}
                            </td>
                          ))}
                          {weekCompareData.length === 2 && (
                            <td className={`py-3 text-right font-medium ${weekCompareData[1][metric.key] >= weekCompareData[0][metric.key] ? 'text-emerald-400' : 'text-rose-400'}`}>
                              {weekCompareData[1][metric.key] >= weekCompareData[0][metric.key] ? '+' : ''}
                              {metric.key === 'margin' 
                                ? (weekCompareData[1][metric.key] - weekCompareData[0][metric.key]).toFixed(1) + '%'
                                : metric.format(weekCompareData[1][metric.key] - weekCompareData[0][metric.key])}
                            </td>
                          )}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
              
              {weekCompareData.length < 2 && (
                <div className="bg-slate-800/30 rounded-2xl border border-dashed border-slate-600 p-12 text-center">
                  <GitCompare className="w-12 h-12 text-slate-600 mx-auto mb-4" />
                  <p className="text-slate-400 text-lg">Select at least 2 weeks to compare</p>
                </div>
              )}
            </div>
          )}
          
          {/* COMPARE SKUS TAB */}
          {analyticsTab === 'compare-skus' && (
            <div className="space-y-6">
              <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6">
                <h3 className="text-lg font-semibold text-white mb-4">Select SKUs to Compare (up to 5)</h3>
                <div className="max-h-64 overflow-y-auto space-y-1">
                  {skuForecasts.slice(0, 50).map(s => {
                    const isSelected = selectedSkusToCompare.includes(s.sku);
                    return (
                      <button key={s.sku} onClick={() => {
                        if (isSelected) setSelectedSkusToCompare(prev => prev.filter(x => x !== s.sku));
                        else if (selectedSkusToCompare.length < 5) setSelectedSkusToCompare(prev => [...prev, s.sku]);
                      }} className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm ${isSelected ? 'bg-amber-600/30 border border-amber-500/50' : 'bg-slate-700/50 hover:bg-slate-600/50'}`}>
                        <span className="flex items-center gap-2">
                          {isSelected && <Check className="w-4 h-4 text-amber-400" />}
                          <span className="font-mono text-xs text-slate-400">{s.sku}</span>
                          <span className="text-white truncate max-w-[200px]">{s.name || 'Unknown'}</span>
                        </span>
                        <span className="text-emerald-400">{formatCurrency(s.totalRevenue)}</span>
                      </button>
                    );
                  })}
                </div>
                {selectedSkusToCompare.length > 0 && (
                  <button onClick={() => setSelectedSkusToCompare([])} className="mt-2 text-sm text-slate-400 hover:text-white">Clear selection</button>
                )}
              </div>
              
              {skuCompareData.length >= 2 && (
                <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6 overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="border-b border-slate-700">
                        <th className="text-left text-slate-400 font-medium py-2">Metric</th>
                        {skuCompareData.map(s => (
                          <th key={s.sku} className="text-right text-white font-medium py-2 max-w-[120px]">
                            <span className="block font-mono text-xs text-slate-400">{s.sku}</span>
                            <span className="block truncate text-sm">{s.name || 'Unknown'}</span>
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-700/50">
                      {[
                        { key: 'revenue', label: 'Total Revenue', format: formatCurrency },
                        { key: 'profit', label: 'Total Profit', format: formatCurrency, isProfit: true },
                        { key: 'units', label: 'Total Units', format: formatNumber },
                        { key: 'profitPerUnit', label: 'Profit/Unit', format: formatCurrency, isProfit: true },
                        { key: 'margin', label: 'Margin %', format: v => v.toFixed(1) + '%' },
                        { key: 'weeksActive', label: 'Weeks Active', format: v => v },
                      ].map(metric => (
                        <tr key={metric.key}>
                          <td className="py-3 text-slate-400">{metric.label}</td>
                          {skuCompareData.map(s => {
                            const maxVal = Math.max(...skuCompareData.map(x => x[metric.key]));
                            const isMax = s[metric.key] === maxVal && maxVal > 0;
                            return (
                              <td key={s.sku} className={`py-3 text-right font-medium ${metric.isProfit ? (s[metric.key] >= 0 ? 'text-emerald-400' : 'text-rose-400') : 'text-white'} ${isMax ? 'bg-emerald-900/20' : ''}`}>
                                {metric.format(s[metric.key])}
                                {isMax && <Trophy className="w-3 h-3 inline ml-1 text-amber-400" />}
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
              
              {skuCompareData.length < 2 && (
                <div className="bg-slate-800/30 rounded-2xl border border-dashed border-slate-600 p-12 text-center">
                  <Trophy className="w-12 h-12 text-slate-600 mx-auto mb-4" />
                  <p className="text-slate-400 text-lg">Select at least 2 SKUs to compare</p>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    );
  }

  // ==================== PROFITABILITY VIEW ====================
  if (view === 'profitability') {
    // Period tabs: weekly, monthly, quarterly, ytd
    const profitPeriod = trendsTab === 'daily' ? 'weekly' : trendsTab; // 'weekly' | 'monthly' | 'quarterly' | 'yearly'
    
    const sortedWeeks = Object.keys(allWeeksData).filter(w => {
      const data = allWeeksData[w];
      return (data.total?.revenue || 0) > 0;
    }).sort();
    const sortedPeriods = Object.keys(allPeriodsData).sort();
    
    // Categorize periods - flexible matching for various formats
    const monthlyPeriods = sortedPeriods.filter(p => {
      if (/^(january|february|march|april|may|june|july|august|september|october|november|december)[\s\-]*['']?\d{2,4}$/i.test(p)) return true;
      if (/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[\s\-]*['']?\d{2,4}$/i.test(p)) return true;
      if (/^\d{4}-\d{2}$/.test(p)) return true;
      return false;
    }).sort((a, b) => {
      // Sort by extracted year and month
      const getYearMonth = (p) => {
        const yearMatch = p.match(/(20\d{2})/);
        const year = yearMatch ? yearMatch[1] : '2025';
        const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
        const monthMatch = p.toLowerCase().match(/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/);
        const month = monthMatch ? String(monthNames.indexOf(monthMatch[1]) + 1).padStart(2, '0') : '01';
        return `${year}-${month}`;
      };
      return getYearMonth(a).localeCompare(getYearMonth(b));
    });
    const quarterlyPeriods = sortedPeriods.filter(p => /q[1-4]/i.test(p)).sort();
    const yearlyPeriods = sortedPeriods.filter(p => /^\d{4}$/.test(p)).sort();
    
    // Get 3PL costs for a date range - uses ledger data structure
    const get3PLCostsForPeriod = (startDate, endDate) => {
      if (!threeplLedger?.orders) return 0;
      let total = 0;
      Object.entries(threeplLedger.orders).forEach(([orderId, order]) => {
        const orderDate = order.shipmentDate || order.orderDate || order.weekKey;
        if (orderDate && orderDate >= startDate && orderDate <= endDate) {
          // Charges are stored in order.charges object
          const charges = order.charges || {};
          total += (charges.shipping || order.shipping || 0);
          total += (charges.firstPick || 0) + (charges.additionalPick || 0);
          total += (charges.box || charges.packaging || order.packagingFees || 0);
          total += (charges.storage || order.storageFees || 0);
          total += (charges.reBoxing || 0) + (charges.fbaForwarding || 0);
          total += (order.otherFees || charges.other || 0);
        }
      });
      
      // Also check summaryCharges (storage, receiving, etc.)
      Object.values(threeplLedger.summaryCharges || {}).forEach(charge => {
        const chargeDate = charge.weekKey || charge.date;
        if (chargeDate && chargeDate >= startDate && chargeDate <= endDate) {
          total += charge.amount || 0;
        }
      });
      
      return total;
    };
    
    // Get 3PL costs for a specific week key using existing function
    const getWeek3PLCosts = (weekKey) => {
      const ledger3PL = get3PLForWeek(threeplLedger, weekKey);
      return ledger3PL?.metrics?.totalCost || 0;
    };
    
    // Helper to get data from either weekly or period source
    const getData = (key) => {
      if (allWeeksData[key]) return allWeeksData[key];
      if (allPeriodsData[key]) return allPeriodsData[key];
      return null;
    };
    
    // Get single period data based on selected tab
    let currentPeriodKey = '';
    let currentPeriodLabel = '';
    let priorPeriodKey = '';
    let priorPeriodLabel = '';
    let trendPeriods = []; // For margin trend chart
    let trendPeriodType = 'week';
    
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth(); // 0-indexed
    const currentQuarter = Math.floor(currentMonth / 3) + 1;
    
    if (profitPeriod === 'monthly' && monthlyPeriods.length > 0) {
      // Selected month (default to most recent if -1)
      const idx = profitPeriodIndex === -1 ? monthlyPeriods.length - 1 : Math.min(profitPeriodIndex, monthlyPeriods.length - 1);
      currentPeriodKey = monthlyPeriods[idx];
      currentPeriodLabel = currentPeriodKey;
      priorPeriodKey = idx > 0 ? monthlyPeriods[idx - 1] : '';
      priorPeriodLabel = priorPeriodKey;
      trendPeriods = monthlyPeriods.slice(-8);
      trendPeriodType = 'month';
    } else if (profitPeriod === 'quarterly' && quarterlyPeriods.length > 0) {
      // Selected quarter
      const idx = profitPeriodIndex === -1 ? quarterlyPeriods.length - 1 : Math.min(profitPeriodIndex, quarterlyPeriods.length - 1);
      currentPeriodKey = quarterlyPeriods[idx];
      currentPeriodLabel = currentPeriodKey;
      priorPeriodKey = idx > 0 ? quarterlyPeriods[idx - 1] : '';
      priorPeriodLabel = priorPeriodKey;
      trendPeriods = quarterlyPeriods.slice(-4);
      trendPeriodType = 'quarter';
    } else if (profitPeriod === 'yearly') {
      // YTD - aggregate all weeks from current year
      const ytdWeeks = sortedWeeks.filter(w => w.startsWith(String(currentYear)));
      currentPeriodKey = 'ytd';
      currentPeriodLabel = `${currentYear} Year-to-Date`;
      // Prior year same period for comparison
      const priorYtdWeeks = sortedWeeks.filter(w => w.startsWith(String(currentYear - 1)));
      priorPeriodKey = 'prior_ytd';
      priorPeriodLabel = `${currentYear - 1} Same Period`;
      trendPeriods = monthlyPeriods.length > 0 ? monthlyPeriods.slice(-12) : sortedWeeks.slice(-12);
      trendPeriodType = monthlyPeriods.length > 0 ? 'month' : 'week';
    } else {
      // Weekly - selected week (default to most recent if -1)
      const idx = profitPeriodIndex === -1 ? sortedWeeks.length - 1 : Math.min(profitPeriodIndex, sortedWeeks.length - 1);
      currentPeriodKey = sortedWeeks[idx] || '';
      currentPeriodLabel = currentPeriodKey ? `Week of ${new Date(currentPeriodKey + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}` : 'No data';
      priorPeriodKey = idx > 0 ? sortedWeeks[idx - 1] : '';
      priorPeriodLabel = priorPeriodKey ? `Week of ${new Date(priorPeriodKey + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}` : '';
      trendPeriods = sortedWeeks.slice(-8);
      trendPeriodType = 'week';
    }
    
    // Get totals for current period
    const totals = { revenue: 0, cogs: 0, amazonFees: 0, threeplCosts: 0, adSpend: 0, profit: 0, units: 0, returns: 0 };
    
    if (profitPeriod === 'yearly') {
      // YTD aggregation
      const ytdWeeks = sortedWeeks.filter(w => w.startsWith(String(currentYear)));
      ytdWeeks.forEach(w => {
        const data = allWeeksData[w];
        if (!data) return;
        totals.revenue += data.total?.revenue || 0;
        totals.cogs += data.total?.cogs || 0;
        totals.amazonFees += data.amazon?.fees || 0;
        // Get 3PL from weekly data OR ledger (whichever has data)
        const weeklyThreepl = data.shopify?.threeplCosts || 0;
        const ledgerThreepl = getWeek3PLCosts(w);
        totals.threeplCosts += Math.max(weeklyThreepl, ledgerThreepl);
        totals.adSpend += data.total?.adSpend || 0;
        totals.profit += data.total?.netProfit || 0;
        totals.units += data.total?.units || 0;
        totals.returns += data.amazon?.returns || 0;
      });
    } else {
      // Single period
      const data = getData(currentPeriodKey);
      if (data) {
        totals.revenue = data.total?.revenue || 0;
        totals.cogs = data.total?.cogs || 0;
        totals.amazonFees = data.amazon?.fees || 0;
        // Get 3PL from data OR ledger
        totals.threeplCosts = data.shopify?.threeplCosts || 0;
        totals.adSpend = data.total?.adSpend || 0;
        totals.profit = data.total?.netProfit || 0;
        totals.units = data.total?.units || 0;
        totals.returns = data.amazon?.returns || 0;
        
        // Add 3PL costs from ledger for weekly periods if not in weekly data
        if (profitPeriod === 'weekly' && currentPeriodKey) {
          const ledgerThreepl = getWeek3PLCosts(currentPeriodKey);
          // Use ledger data if it's higher (meaning we have ledger data)
          if (ledgerThreepl > totals.threeplCosts) {
            totals.threeplCosts = ledgerThreepl;
          }
        }
        
        // For monthly periods, sum up weekly ledger data
        if (profitPeriod === 'monthly' && currentPeriodKey) {
          // Find weeks that fall in this month
          const monthMatch = currentPeriodKey.toLowerCase().match(/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/);
          const yearMatch = currentPeriodKey.match(/(20\d{2})/);
          if (monthMatch && yearMatch) {
            const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            const month = monthNames.indexOf(monthMatch[1]);
            const year = parseInt(yearMatch[1]);
            const monthWeeks = sortedWeeks.filter(w => {
              const wDate = new Date(w + 'T00:00:00');
              return wDate.getFullYear() === year && wDate.getMonth() === month;
            });
            let ledgerTotal = 0;
            monthWeeks.forEach(w => {
              ledgerTotal += getWeek3PLCosts(w);
            });
            if (ledgerTotal > totals.threeplCosts) {
              totals.threeplCosts = ledgerTotal;
            }
          }
        }
      }
    }
    
    // Get prior period totals for comparison
    const priorTotals = { revenue: 0, cogs: 0, amazonFees: 0, threeplCosts: 0, adSpend: 0, profit: 0, units: 0, returns: 0 };
    if (profitPeriod === 'yearly') {
      // Prior YTD
      const currentDayOfYear = Math.floor((new Date() - new Date(currentYear, 0, 0)) / (1000 * 60 * 60 * 24));
      const priorYtdEnd = new Date(currentYear - 1, 0, currentDayOfYear);
      const priorYtdWeeks = sortedWeeks.filter(w => {
        const wDate = new Date(w);
        return wDate.getFullYear() === currentYear - 1 && wDate <= priorYtdEnd;
      });
      priorYtdWeeks.forEach(w => {
        const data = allWeeksData[w];
        if (!data) return;
        priorTotals.revenue += data.total?.revenue || 0;
        priorTotals.cogs += data.total?.cogs || 0;
        priorTotals.amazonFees += data.amazon?.fees || 0;
        // Get 3PL from weekly data OR ledger
        const weeklyThreepl = data.shopify?.threeplCosts || 0;
        const ledgerThreepl = getWeek3PLCosts(w);
        priorTotals.threeplCosts += Math.max(weeklyThreepl, ledgerThreepl);
        priorTotals.adSpend += data.total?.adSpend || 0;
        priorTotals.profit += data.total?.netProfit || 0;
      });
    } else if (priorPeriodKey) {
      const priorData = getData(priorPeriodKey);
      if (priorData) {
        priorTotals.revenue = priorData.total?.revenue || 0;
        priorTotals.cogs = priorData.total?.cogs || 0;
        priorTotals.amazonFees = priorData.amazon?.fees || 0;
        priorTotals.threeplCosts = priorData.shopify?.threeplCosts || 0;
        priorTotals.adSpend = priorData.total?.adSpend || 0;
        priorTotals.profit = priorData.total?.netProfit || 0;
        
        // Add ledger data for prior week if needed
        if (profitPeriod === 'weekly') {
          const ledgerThreepl = getWeek3PLCosts(priorPeriodKey);
          if (ledgerThreepl > priorTotals.threeplCosts) {
            priorTotals.threeplCosts = ledgerThreepl;
          }
        }
      }
    }
    
    const weeklyBreakdown = [];
    
    // Calculate percentages
    const pcts = {
      cogs: totals.revenue > 0 ? (totals.cogs / totals.revenue) * 100 : 0,
      amazonFees: totals.revenue > 0 ? (totals.amazonFees / totals.revenue) * 100 : 0,
      threeplCosts: totals.revenue > 0 ? (totals.threeplCosts / totals.revenue) * 100 : 0,
      adSpend: totals.revenue > 0 ? (totals.adSpend / totals.revenue) * 100 : 0,
      profit: totals.revenue > 0 ? (totals.profit / totals.revenue) * 100 : 0,
    };
    
    // Prior period percentages
    const priorPcts = {
      cogs: priorTotals.revenue > 0 ? (priorTotals.cogs / priorTotals.revenue) * 100 : 0,
      profit: priorTotals.revenue > 0 ? (priorTotals.profit / priorTotals.revenue) * 100 : 0,
      adSpend: priorTotals.revenue > 0 ? (priorTotals.adSpend / priorTotals.revenue) * 100 : 0,
    };
    
    // Calculate key metrics
    const avgOrderValue = totals.units > 0 ? totals.revenue / totals.units : 0;
    const profitPerUnit = totals.units > 0 ? totals.profit / totals.units : 0;
    const returnRate = (totals.units + totals.returns) > 0 ? (totals.returns / (totals.units + totals.returns)) * 100 : 0;
    const grossMargin = totals.revenue > 0 ? ((totals.revenue - totals.cogs) / totals.revenue) * 100 : 0;
    const operatingMargin = totals.revenue > 0 ? ((totals.revenue - totals.cogs - totals.amazonFees - totals.threeplCosts) / totals.revenue) * 100 : 0;
    
    // Identify biggest cost driver
    const costDrivers = [
      { name: 'COGS', value: totals.cogs, pct: pcts.cogs },
      { name: 'Amazon Fees', value: totals.amazonFees, pct: pcts.amazonFees },
      { name: '3PL Costs', value: totals.threeplCosts, pct: pcts.threeplCosts },
      { name: 'Ad Spend', value: totals.adSpend, pct: pcts.adSpend },
    ].sort((a, b) => b.value - a.value);
    
    // Build margin trends data from trendPeriods
    const marginTrends = trendPeriods.map(p => {
      const data = getData(p);
      if (!data) return null;
      const rev = data.total?.revenue || 1;
      const profit = data.total?.netProfit || 0;
      return {
        period: p,
        label: trendPeriodType === 'week' 
          ? new Date(p + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
          : p.replace(/\s*\d{4}$/, '').slice(0, 3),
        revenue: data.total?.revenue || 0,
        profit: profit,
        margin: (profit / rev) * 100,
        cogsPct: ((data.total?.cogs || 0) / rev) * 100,
        adsPct: ((data.total?.adSpend || 0) / rev) * 100,
        feesPct: (((data.amazon?.fees || 0) + (data.shopify?.threeplCosts || 0)) / rev) * 100,
      };
    }).filter(Boolean);
    
    // SKU-level profitability for current period
    const skuProfitability = [];
    const currentData = getData(currentPeriodKey);
    if (currentData) {
      [...(currentData.amazon?.skuData || []), ...(currentData.shopify?.skuData || [])].forEach(s => {
        const profit = s.netProceeds !== undefined ? s.netProceeds : (s.netSales || 0) - (s.cogs || 0);
        const revenue = s.netSales || 0;
        skuProfitability.push({ sku: s.sku, name: s.name || '', revenue, profit, units: s.unitsSold || 0 });
      });
    } else if (profitPeriod === 'yearly') {
      // For YTD, aggregate all SKUs from current year
      const ytdWeeks = sortedWeeks.filter(w => w.startsWith(String(currentYear)));
      ytdWeeks.forEach(w => {
        const data = allWeeksData[w];
        if (!data) return;
        [...(data.amazon?.skuData || []), ...(data.shopify?.skuData || [])].forEach(s => {
          const existing = skuProfitability.find(x => x.sku === s.sku);
          const profit = s.netProceeds !== undefined ? s.netProceeds : (s.netSales || 0) - (s.cogs || 0);
          const revenue = s.netSales || 0;
          if (existing) {
            existing.revenue += revenue;
            existing.profit += profit;
            existing.units += s.unitsSold || 0;
          } else {
            skuProfitability.push({ sku: s.sku, name: s.name || '', revenue, profit, units: s.unitsSold || 0 });
          }
        });
      });
    }
    
    // Calculate margin and sort
    const skuWithMargins = skuProfitability.map(s => ({
      ...s,
      margin: s.revenue > 0 ? (s.profit / s.revenue) * 100 : 0,
      profitPerUnit: s.units > 0 ? s.profit / s.units : 0,
    })).filter(s => s.revenue > 100); // Filter out tiny SKUs
    
    const topProfitSkus = [...skuWithMargins].sort((a, b) => b.profit - a.profit).slice(0, 5);
    const worstMarginSkus = [...skuWithMargins].sort((a, b) => a.margin - b.margin).slice(0, 5);
    const bestMarginSkus = [...skuWithMargins].sort((a, b) => b.margin - a.margin).slice(0, 5);
    
    // Waterfall segments
    const waterfall = [
      { label: 'Revenue', value: totals.revenue, color: 'bg-violet-500', running: totals.revenue },
      { label: 'COGS', value: -totals.cogs, color: 'bg-rose-500', running: totals.revenue - totals.cogs },
      { label: 'Amazon Fees', value: -totals.amazonFees, color: 'bg-orange-500', running: totals.revenue - totals.cogs - totals.amazonFees },
      { label: '3PL Costs', value: -totals.threeplCosts, color: 'bg-blue-500', running: totals.revenue - totals.cogs - totals.amazonFees - totals.threeplCosts },
      { label: 'Ad Spend', value: -totals.adSpend, color: 'bg-purple-500', running: totals.revenue - totals.cogs - totals.amazonFees - totals.threeplCosts - totals.adSpend },
      { label: 'Net Profit', value: totals.profit, color: totals.profit >= 0 ? 'bg-emerald-500' : 'bg-rose-500', running: totals.profit },
    ];
    
    const maxVal = Math.max(totals.revenue, Math.abs(totals.profit));
    
    // Cost trends over time (kept for backward compatibility)
    const costTrends = sortedWeeks.slice(-12).map(w => {
      const week = allWeeksData[w];
      const rev = week.total?.revenue || 1;
      return {
        week: w,
        revenue: week.total?.revenue || 0,
        cogsPct: ((week.total?.cogs || 0) / rev) * 100,
        adsPct: ((week.total?.adSpend || 0) / rev) * 100,
        feesPct: (((week.amazon?.fees || 0) + (week.shopify?.threeplCosts || 0)) / rev) * 100,
        margin: ((week.total?.netProfit || 0) / rev) * 100,
      };
    });
    
    return (
      <div className="min-h-screen bg-slate-950 p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <NavTabs />
          {dataBar}
          
          <div className="mb-6">
            <h1 className="text-2xl lg:text-3xl font-bold text-white mb-2">ðŸ’° Profitability Deep Dive</h1>
            <p className="text-slate-400">
              {profitPeriod === 'yearly' 
                ? currentPeriodLabel 
                : `${currentPeriodLabel}${priorPeriodLabel ? ` vs ${priorPeriodLabel}` : ''}`}
            </p>
          </div>
          
          {/* Time Period Tabs */}
          <div className="flex flex-wrap gap-2 mb-4">
            <button 
              onClick={() => { setTrendsTab('weekly'); setProfitPeriodIndex(-1); }}
              className={`px-4 py-2 rounded-lg font-medium transition-all ${profitPeriod === 'weekly' ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
            >
              ðŸ“… Weekly
            </button>
            <button 
              onClick={() => { setTrendsTab('monthly'); setProfitPeriodIndex(-1); }}
              className={`px-4 py-2 rounded-lg font-medium transition-all ${profitPeriod === 'monthly' ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
              disabled={monthlyPeriods.length === 0}
            >
              ðŸ“Š Monthly {monthlyPeriods.length === 0 && '(No data)'}
            </button>
            <button 
              onClick={() => { setTrendsTab('quarterly'); setProfitPeriodIndex(-1); }}
              className={`px-4 py-2 rounded-lg font-medium transition-all ${profitPeriod === 'quarterly' ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
              disabled={quarterlyPeriods.length === 0}
            >
              ðŸ“ˆ Quarterly {quarterlyPeriods.length === 0 && '(No data)'}
            </button>
            <button 
              onClick={() => { setTrendsTab('yearly'); setProfitPeriodIndex(-1); }}
              className={`px-4 py-2 rounded-lg font-medium transition-all ${profitPeriod === 'yearly' ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
            >
              ðŸ“† YTD
            </button>
          </div>
          
          {/* Period Selector */}
          {profitPeriod !== 'yearly' && (
            <div className="flex flex-wrap gap-2 mb-6 items-center bg-slate-800/50 rounded-lg p-3 border border-slate-700">
              <span className="text-slate-400 text-sm mr-2">ðŸ“… Select Period:</span>
              <select
                value={(() => {
                  const periods = profitPeriod === 'weekly' ? sortedWeeks : profitPeriod === 'monthly' ? monthlyPeriods : quarterlyPeriods;
                  return profitPeriodIndex === -1 ? periods.length - 1 : profitPeriodIndex;
                })()}
                onChange={(e) => {
                  const periods = profitPeriod === 'weekly' ? sortedWeeks : profitPeriod === 'monthly' ? monthlyPeriods : quarterlyPeriods;
                  const idx = parseInt(e.target.value);
                  setProfitPeriodIndex(idx === periods.length - 1 ? -1 : idx);
                }}
                className="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm min-w-[200px]"
              >
                {profitPeriod === 'weekly' && [...sortedWeeks].reverse().map((w, reverseIdx) => {
                  const idx = sortedWeeks.length - 1 - reverseIdx;
                  return (
                    <option key={w} value={idx}>
                      Week of {new Date(w + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                    </option>
                  );
                })}
                {profitPeriod === 'monthly' && [...monthlyPeriods].reverse().map((p, reverseIdx) => {
                  const idx = monthlyPeriods.length - 1 - reverseIdx;
                  return <option key={p} value={idx}>{p}</option>;
                })}
                {profitPeriod === 'quarterly' && [...quarterlyPeriods].reverse().map((p, reverseIdx) => {
                  const idx = quarterlyPeriods.length - 1 - reverseIdx;
                  return <option key={p} value={idx}>{p}</option>;
                })}
              </select>
              
              {/* Quick navigation buttons */}
              <div className="flex gap-1 ml-2">
                <button
                  onClick={() => {
                    const periods = profitPeriod === 'weekly' ? sortedWeeks : profitPeriod === 'monthly' ? monthlyPeriods : quarterlyPeriods;
                    const currentIdx = profitPeriodIndex === -1 ? periods.length - 1 : profitPeriodIndex;
                    if (currentIdx > 0) setProfitPeriodIndex(currentIdx - 1);
                  }}
                  className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm"
                  title="Previous period"
                >
                  â† Prev
                </button>
                <button
                  onClick={() => {
                    const periods = profitPeriod === 'weekly' ? sortedWeeks : profitPeriod === 'monthly' ? monthlyPeriods : quarterlyPeriods;
                    const currentIdx = profitPeriodIndex === -1 ? periods.length - 1 : profitPeriodIndex;
                    if (currentIdx < periods.length - 1) setProfitPeriodIndex(currentIdx + 1);
                    else setProfitPeriodIndex(-1); // Go to latest
                  }}
                  className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm"
                  title="Next period"
                >
                  Next â†’
                </button>
                <button
                  onClick={() => setProfitPeriodIndex(-1)}
                  className={`px-2 py-1 rounded text-sm ${profitPeriodIndex === -1 ? 'bg-emerald-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}
                  title="Go to latest"
                >
                  Latest
                </button>
              </div>
            </div>
          )}
          
          {/* Key Insights Alert */}
          <div className="bg-gradient-to-r from-indigo-900/40 to-violet-900/40 border border-indigo-500/30 rounded-xl p-4 mb-6">
            <h3 className="text-indigo-300 font-semibold mb-2 flex items-center gap-2"><Zap className="w-4 h-4" />Key Insights</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div>
                <p className="text-slate-400">Biggest Cost Driver</p>
                <p className="text-white font-semibold">{costDrivers[0]?.name}: {costDrivers[0]?.pct.toFixed(1)}% of revenue</p>
              </div>
              <div>
                <p className="text-slate-400">Profit Per Unit</p>
                <p className={`font-semibold ${profitPerUnit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(profitPerUnit)}</p>
              </div>
              <div>
                <p className="text-slate-400">Margin vs Prior Period</p>
                <p className={`font-semibold flex items-center gap-1 ${pcts.profit >= priorPcts.profit ? 'text-emerald-400' : 'text-rose-400'}`}>
                  {priorPcts.profit > 0 ? (
                    <>
                      {pcts.profit >= priorPcts.profit ? <TrendingUp className="w-4 h-4" /> : <TrendingDown className="w-4 h-4" />}
                      {pcts.profit >= priorPcts.profit ? '+' : ''}{(pcts.profit - priorPcts.profit).toFixed(1)}%
                    </>
                  ) : (
                    <span className="text-slate-500">No prior data</span>
                  )}
                </p>
              </div>
            </div>
          </div>
          
          {/* Profit Waterfall - Compact Horizontal View */}
          <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-white">Profit Waterfall</h3>
              <span className="text-sm text-slate-400">{currentPeriodLabel}</span>
            </div>
            {/* Horizontal Bar Waterfall */}
            <div className="space-y-2">
              {waterfall.map((item, i) => {
                const widthPct = totals.revenue > 0 ? (Math.abs(item.value) / totals.revenue) * 100 : 0;
                const isExpense = item.value < 0;
                return (
                  <div key={item.label} className="flex items-center gap-3">
                    <div className="w-24 text-sm text-slate-400 text-right">{item.label}</div>
                    <div className="flex-1 h-8 bg-slate-900/50 rounded-lg overflow-hidden relative">
                      <div 
                        className={`h-full ${item.color} transition-all`}
                        style={{ width: `${Math.min(widthPct, 100)}%` }}
                      />
                      <span className="absolute inset-0 flex items-center px-3 text-sm font-medium text-white">
                        {isExpense ? '-' : ''}{formatCurrency(Math.abs(item.value))}
                        <span className="text-slate-400 text-xs ml-2">({widthPct.toFixed(1)}%)</span>
                      </span>
                    </div>
                  </div>
                );
              })}
            </div>
            {/* Summary */}
            <div className="mt-4 pt-4 border-t border-slate-700 flex items-center justify-between">
              <p className="text-slate-400 text-sm">For every <span className="text-white font-semibold">$1,000</span> in revenue:</p>
              <p className="text-lg font-bold">
                You keep <span className={pcts.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}>{formatCurrency(pcts.profit * 10)}</span>
              </p>
            </div>
          </div>
          
          {/* Margin Metrics Row */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">Gross Margin</p>
              <p className="text-2xl font-bold text-white">{grossMargin.toFixed(1)}%</p>
              <p className="text-slate-500 text-xs">Revenue - COGS</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">Operating Margin</p>
              <p className="text-2xl font-bold text-white">{operatingMargin.toFixed(1)}%</p>
              <p className="text-slate-500 text-xs">Before ad spend</p>
            </div>
            <div className="bg-gradient-to-br from-emerald-900/30 to-slate-800/50 rounded-xl border border-emerald-500/30 p-4">
              <p className="text-slate-400 text-sm">Net Margin</p>
              <p className={`text-2xl font-bold ${pcts.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{pcts.profit.toFixed(1)}%</p>
              <p className="text-slate-500 text-xs">After all costs</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">Return Rate</p>
              <p className={`text-2xl font-bold ${returnRate < 5 ? 'text-emerald-400' : returnRate < 10 ? 'text-amber-400' : 'text-rose-400'}`}>{returnRate.toFixed(1)}%</p>
              <p className="text-slate-500 text-xs">{totals.returns} returns</p>
            </div>
          </div>
          
          {/* Cost Breakdown Cards */}
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">COGS</p>
              <p className="text-xl font-bold text-white">{formatCurrency(totals.cogs)}</p>
              <p className="text-rose-400 text-sm">{pcts.cogs.toFixed(1)}% of revenue</p>
              {priorPcts.cogs > 0 && <p className={`text-xs ${pcts.cogs <= priorPcts.cogs ? 'text-emerald-400' : 'text-rose-400'}`}>{pcts.cogs <= priorPcts.cogs ? 'â†“' : 'â†‘'} vs prior</p>}
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">Amazon Fees</p>
              <p className="text-xl font-bold text-white">{formatCurrency(totals.amazonFees)}</p>
              <p className="text-orange-400 text-sm">{pcts.amazonFees.toFixed(1)}% of revenue</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">3PL Costs</p>
              <p className="text-xl font-bold text-white">{formatCurrency(totals.threeplCosts)}</p>
              <p className="text-blue-400 text-sm">{pcts.threeplCosts.toFixed(1)}% of revenue</p>
            </div>
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
              <p className="text-slate-400 text-sm">Ad Spend (TACOS)</p>
              <p className="text-xl font-bold text-white">{formatCurrency(totals.adSpend)}</p>
              <p className="text-purple-400 text-sm">{pcts.adSpend.toFixed(1)}% of revenue</p>
              {priorPcts.adSpend > 0 && <p className={`text-xs ${pcts.adSpend <= priorPcts.adSpend ? 'text-emerald-400' : 'text-rose-400'}`}>{pcts.adSpend <= priorPcts.adSpend ? 'â†“' : 'â†‘'} vs prior</p>}
            </div>
            <div className="bg-gradient-to-br from-emerald-900/30 to-slate-800/50 rounded-xl border border-emerald-500/30 p-4">
              <p className="text-slate-400 text-sm">Net Profit</p>
              <p className={`text-xl font-bold ${totals.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(totals.profit)}</p>
              <p className={`text-sm ${pcts.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{pcts.profit.toFixed(1)}% margin</p>
            </div>
          </div>
          
          {/* Margin Trend Chart */}
          {marginTrends.length > 1 && (
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-white">Margin Trend</h3>
                <span className="text-sm text-slate-400">Last {marginTrends.length} {trendPeriodType}s</span>
              </div>
              <div className="h-48 flex items-end gap-2">
                {marginTrends.map((t, i) => {
                  const maxMargin = Math.max(...marginTrends.map(m => Math.abs(m.margin)), 50);
                  const height = Math.abs(t.margin) / maxMargin * 100;
                  const isPositive = t.margin >= 0;
                  const isLast = i === marginTrends.length - 1;
                  return (
                    <div key={t.period} className="flex-1 flex flex-col items-center group relative h-full">
                      <div className="absolute -top-16 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-900 border border-slate-700 text-white text-xs px-3 py-2 rounded whitespace-nowrap z-50 shadow-lg pointer-events-none">
                        <p className="font-medium">{t.period}</p>
                        <p className="text-slate-300">Revenue: {formatCurrency(t.revenue)}</p>
                        <p className={isPositive ? 'text-emerald-400' : 'text-rose-400'}>Margin: {t.margin.toFixed(1)}%</p>
                        <p className="text-rose-300">COGS: {t.cogsPct.toFixed(1)}%</p>
                        <p className="text-orange-300">Fees: {t.feesPct.toFixed(1)}%</p>
                        <p className="text-purple-300">Ads: {t.adsPct.toFixed(1)}%</p>
                      </div>
                      <div className="w-full flex-1 flex items-end">
                        <div 
                          className={`w-full rounded-t transition-all hover:opacity-80 ${isPositive ? (isLast ? 'bg-emerald-500' : 'bg-emerald-500/60') : (isLast ? 'bg-rose-500' : 'bg-rose-500/60')}`}
                          style={{ height: `${Math.max(height, 8)}%` }}
                        />
                      </div>
                      <div className="mt-2 text-center">
                        <span className="text-[10px] text-slate-500">{t.label}</span>
                        <p className={`text-xs font-medium ${isPositive ? 'text-emerald-400' : 'text-rose-400'}`}>{t.margin.toFixed(0)}%</p>
                      </div>
                    </div>
                  );
                })}
              </div>
              <div className="mt-4 pt-4 border-t border-slate-700 flex justify-between text-sm text-slate-400">
                <span>Avg Margin: <span className={marginTrends.reduce((s, t) => s + t.margin, 0) / marginTrends.length >= 0 ? 'text-emerald-400' : 'text-rose-400'}>{(marginTrends.reduce((s, t) => s + t.margin, 0) / marginTrends.length).toFixed(1)}%</span></span>
                <span>Trend: {marginTrends.length >= 2 ? (
                  marginTrends[marginTrends.length - 1].margin > marginTrends[0].margin 
                    ? <span className="text-emerald-400">â†‘ Improving</span>
                    : marginTrends[marginTrends.length - 1].margin < marginTrends[0].margin
                    ? <span className="text-rose-400">â†“ Declining</span>
                    : <span className="text-slate-400">â†’ Stable</span>
                ) : '-'}</span>
              </div>
            </div>
          )}
          
          {/* SKU Profitability Insights */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            {/* Top Profit SKUs */}
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
              <h3 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                <Trophy className="w-5 h-5 text-amber-400" />Top Profit Generators
              </h3>
              <div className="space-y-2">
                {topProfitSkus.map((s, i) => (
                  <div key={s.sku} className="flex justify-between items-center text-sm">
                    <div className="flex items-center gap-2">
                      <span className="text-amber-400 font-bold">#{i+1}</span>
                      <span className="text-white truncate max-w-[120px]">{s.name || s.sku}</span>
                    </div>
                    <span className="text-emerald-400 font-semibold">{formatCurrency(s.profit)}</span>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Best Margin SKUs */}
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
              <h3 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                <TrendingUp className="w-5 h-5 text-emerald-400" />Best Margins
              </h3>
              <div className="space-y-2">
                {bestMarginSkus.map((s, i) => (
                  <div key={s.sku} className="flex justify-between items-center text-sm">
                    <span className="text-white truncate max-w-[150px]">{s.name || s.sku}</span>
                    <span className="text-emerald-400 font-semibold">{s.margin.toFixed(1)}%</span>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Worst Margin SKUs */}
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
              <h3 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                <AlertTriangle className="w-5 h-5 text-rose-400" />Margin Opportunities
              </h3>
              <div className="space-y-2">
                {worstMarginSkus.map((s, i) => (
                  <div key={s.sku} className="flex justify-between items-center text-sm">
                    <span className="text-white truncate max-w-[150px]">{s.name || s.sku}</span>
                    <span className={`font-semibold ${s.margin < 0 ? 'text-rose-400' : 'text-amber-400'}`}>{s.margin.toFixed(1)}%</span>
                  </div>
                ))}
              </div>
              <p className="text-slate-500 text-xs mt-2">Consider raising prices or cutting ad spend</p>
            </div>
          </div>
          
          {/* Weekly Breakdown Table */}
          <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6">
            <h3 className="text-lg font-semibold text-white mb-4">Weekly Breakdown</h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b border-slate-700">
                    <th className="text-left text-slate-400 py-2">Week</th>
                    <th className="text-right text-slate-400 py-2">Revenue</th>
                    <th className="text-right text-slate-400 py-2">COGS</th>
                    <th className="text-right text-slate-400 py-2">Fees</th>
                    <th className="text-right text-slate-400 py-2">3PL</th>
                    <th className="text-right text-slate-400 py-2">Ads</th>
                    <th className="text-right text-slate-400 py-2">Profit</th>
                    <th className="text-right text-slate-400 py-2">Margin</th>
                  </tr>
                </thead>
                <tbody>
                  {weeklyBreakdown.map(w => {
                    // Format the week label - handle both date strings and period labels
                    const formatWeekLabel = (weekKey) => {
                      // Check if it's a date format (YYYY-MM-DD)
                      if (/^\d{4}-\d{2}-\d{2}$/.test(weekKey)) {
                        return new Date(weekKey + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                      }
                      // Otherwise return as-is (it's a period label like "January 2025")
                      return weekKey;
                    };
                    return (
                    <tr key={w.week} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                      <td className="py-2 text-white">{formatWeekLabel(w.week)}</td>
                      <td className="py-2 text-right text-white">{formatCurrency(w.revenue)}</td>
                      <td className="py-2 text-right text-rose-400">{formatCurrency(w.cogs)}</td>
                      <td className="py-2 text-right text-orange-400">{formatCurrency(w.amazonFees)}</td>
                      <td className="py-2 text-right text-blue-400">{formatCurrency(w.threeplCosts)}</td>
                      <td className="py-2 text-right text-purple-400">{formatCurrency(w.adSpend)}</td>
                      <td className={`py-2 text-right font-semibold ${w.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(w.profit)}</td>
                      <td className={`py-2 text-right ${w.margin >= 20 ? 'text-emerald-400' : w.margin >= 10 ? 'text-amber-400' : 'text-rose-400'}`}>{w.margin.toFixed(1)}%</td>
                    </tr>
                    );
                  })}
                </tbody>
                <tfoot className="border-t-2 border-slate-600">
                  <tr className="font-semibold">
                    <td className="py-2 text-white">Total</td>
                    <td className="py-2 text-right text-white">{formatCurrency(totals.revenue)}</td>
                    <td className="py-2 text-right text-rose-400">{formatCurrency(totals.cogs)}</td>
                    <td className="py-2 text-right text-orange-400">{formatCurrency(totals.amazonFees)}</td>
                    <td className="py-2 text-right text-blue-400">{formatCurrency(totals.threeplCosts)}</td>
                    <td className="py-2 text-right text-purple-400">{formatCurrency(totals.adSpend)}</td>
                    <td className={`py-2 text-right ${totals.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(totals.profit)}</td>
                    <td className={`py-2 text-right ${pcts.profit >= 20 ? 'text-emerald-400' : pcts.profit >= 10 ? 'text-amber-400' : 'text-rose-400'}`}>{pcts.profit.toFixed(1)}%</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          
          {/* Cost % Trends Chart */}
          {costTrends.length >= 4 && (
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6">
              <h3 className="text-lg font-semibold text-white mb-4">Margin Trend Over Time ({costTrends.length} weeks)</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b border-slate-700">
                      <th className="text-left text-slate-400 py-2">Week</th>
                      <th className="text-right text-slate-400 py-2">Revenue</th>
                      <th className="text-right text-slate-400 py-2">COGS %</th>
                      <th className="text-right text-slate-400 py-2">Ads %</th>
                      <th className="text-right text-slate-400 py-2">Fees %</th>
                      <th className="text-right text-slate-400 py-2">Net Margin</th>
                    </tr>
                  </thead>
                  <tbody>
                    {costTrends.map(t => (
                      <tr key={t.week} className="border-b border-slate-700/50">
                        <td className="py-2 text-white">{new Date(t.week + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
                        <td className="py-2 text-right text-white">{formatCurrency(t.revenue)}</td>
                        <td className="py-2 text-right text-rose-400">{t.cogsPct.toFixed(1)}%</td>
                        <td className="py-2 text-right text-purple-400">{t.adsPct.toFixed(1)}%</td>
                        <td className="py-2 text-right text-orange-400">{t.feesPct.toFixed(1)}%</td>
                        <td className={`py-2 text-right font-semibold ${t.margin >= 20 ? 'text-emerald-400' : t.margin >= 10 ? 'text-amber-400' : t.margin >= 0 ? 'text-white' : 'text-rose-400'}`}>{t.margin.toFixed(1)}%</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
          
          {/* Break-even Analysis */}
          <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
            <h3 className="text-lg font-semibold text-white mb-4">Break-Even Analysis</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <p className="text-slate-400 text-sm mb-2">Your average costs are <span className="text-white font-semibold">{(100 - pcts.profit).toFixed(1)}%</span> of revenue</p>
                <p className="text-slate-400 text-sm mb-2">For every <span className="text-white font-semibold">$1,000</span> in revenue, you keep <span className={`font-semibold ${pcts.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(pcts.profit * 10)}</span></p>
                <p className="text-slate-400 text-sm mb-4">Average Order Value: <span className="text-white font-semibold">{formatCurrency(avgOrderValue)}</span></p>
                
                <div className="bg-slate-900/50 rounded-lg p-4">
                  <p className="text-white font-semibold mb-2">ðŸŽ¯ To increase margin by 5%:</p>
                  <ul className="text-slate-400 text-sm space-y-1">
                    <li>â€¢ Reduce COGS by {formatCurrency(totals.revenue * 0.05)} (negotiate suppliers)</li>
                    <li>â€¢ Cut ad spend by {((totals.adSpend * 0.05 / totals.revenue) * 100 / pcts.adSpend * 100).toFixed(0)}% (optimize targeting)</li>
                    <li>â€¢ Increase prices by ~{(5 / (100 - pcts.profit) * 100).toFixed(1)}%</li>
                  </ul>
                </div>
              </div>
              <div className="bg-slate-900/50 rounded-lg p-4">
                <p className="text-slate-500 text-xs uppercase mb-2">Revenue Breakdown</p>
                <div className="h-6 bg-slate-700 rounded-full overflow-hidden flex mb-2">
                  <div className="bg-rose-500 h-full" style={{ width: `${pcts.cogs}%` }} title={`COGS: ${pcts.cogs.toFixed(1)}%`} />
                  <div className="bg-orange-500 h-full" style={{ width: `${pcts.amazonFees}%` }} title={`Fees: ${pcts.amazonFees.toFixed(1)}%`} />
                  <div className="bg-blue-500 h-full" style={{ width: `${pcts.threeplCosts}%` }} title={`3PL: ${pcts.threeplCosts.toFixed(1)}%`} />
                  <div className="bg-purple-500 h-full" style={{ width: `${pcts.adSpend}%` }} title={`Ads: ${pcts.adSpend.toFixed(1)}%`} />
                  <div className={`${pcts.profit >= 0 ? 'bg-emerald-500' : 'bg-rose-600'} h-full`} style={{ width: `${Math.abs(pcts.profit)}%` }} />
                </div>
                <div className="flex flex-wrap gap-3 text-xs">
                  <span className="flex items-center gap-1"><span className="w-2 h-2 bg-rose-500 rounded" />COGS {pcts.cogs.toFixed(0)}%</span>
                  <span className="flex items-center gap-1"><span className="w-2 h-2 bg-orange-500 rounded" />Fees {pcts.amazonFees.toFixed(0)}%</span>
                  <span className="flex items-center gap-1"><span className="w-2 h-2 bg-blue-500 rounded" />3PL {pcts.threeplCosts.toFixed(0)}%</span>
                  <span className="flex items-center gap-1"><span className="w-2 h-2 bg-purple-500 rounded" />Ads {pcts.adSpend.toFixed(0)}%</span>
                  <span className="flex items-center gap-1"><span className={`w-2 h-2 ${pcts.profit >= 0 ? 'bg-emerald-500' : 'bg-rose-600'} rounded`} />Profit {pcts.profit.toFixed(0)}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }


  // ==================== FORECAST VIEW (Unified Forecasting System) ====================
  if (view === 'forecast') {
    // Modular AI Forecast System with Time Periods
    
    // Data availability
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const sortedDays = Object.keys(allDaysData).filter(d => hasDailySalesData(allDaysData[d])).sort();
    const activeWeeksCount = sortedWeeks.filter(w => (allWeeksData[w]?.total?.revenue || 0) > 100).length;
    const hasEnoughData = sortedWeeks.length >= 4 || sortedDays.length >= 14;
    
    // Learning stats
    const learningStats = {
      predictions: aiLearningHistory.predictions?.length || 0,
      withActuals: aiLearningHistory.predictions?.filter(p => p.actual !== undefined).length || 0,
      avgAccuracy: (() => {
        const withActuals = aiLearningHistory.predictions?.filter(p => p.accuracy?.revenueError !== undefined) || [];
        if (withActuals.length === 0) return null;
        const totalError = withActuals.reduce((sum, p) => sum + Math.abs(p.accuracy.revenueError || 0), 0);
        return 100 - (totalError / withActuals.length);
      })(),
    };
    
    return (
      <div className="min-h-screen bg-slate-950 p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <NavTabs />
          {dataBar}
          
          {/* Header */}
          <div className="mb-6">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
                  <Brain className="w-7 h-7 text-purple-400" />
                </div>
                <div>
                  <h1 className="text-2xl lg:text-3xl font-bold text-white">AI Forecast Center</h1>
                  <p className="text-slate-400">Specialized AI forecasts powered by Claude â€¢ Continuously learning from your data</p>
                </div>
              </div>
              
              {/* Learning Status */}
              <div className="bg-slate-800/50 rounded-xl px-4 py-2 border border-slate-700">
                <p className="text-slate-400 text-xs">AI Learning Status</p>
                <div className="flex items-center gap-3">
                  <span className="text-white font-medium">{learningStats.predictions} predictions</span>
                  <span className="text-slate-500">â€¢</span>
                  <span className="text-emerald-400">{learningStats.withActuals} verified</span>
                  {learningStats.avgAccuracy && (
                    <>
                      <span className="text-slate-500">â€¢</span>
                      <span className="text-cyan-400">{learningStats.avgAccuracy.toFixed(1)}% accurate</span>
                    </>
                  )}
                </div>
              </div>
            </div>
          </div>
          
          {/* Forecast Type Tabs */}
          <div className="flex flex-wrap gap-2 mb-6">
            <button onClick={() => setForecastTab('sales')} className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${forecastTab === 'sales' ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
              <TrendingUp className="w-4 h-4" />Sales Forecast
            </button>
            <button onClick={() => setForecastTab('amazon')} className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${forecastTab === 'amazon' ? 'bg-orange-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
              <Store className="w-4 h-4" />Amazon
            </button>
            <button onClick={() => setForecastTab('shopify')} className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${forecastTab === 'shopify' ? 'bg-green-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
              <ShoppingBag className="w-4 h-4" />Shopify
            </button>
            <button onClick={() => setForecastTab('inventory')} className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${forecastTab === 'inventory' ? 'bg-amber-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
              <Boxes className="w-4 h-4" />Inventory
            </button>
            <button onClick={() => setForecastTab('comparison')} className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${forecastTab === 'comparison' ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
              <BarChart3 className="w-4 h-4" />AI vs Amazon
            </button>
            <button onClick={() => setForecastTab('settings')} className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${forecastTab === 'settings' ? 'bg-slate-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
              <Settings className="w-4 h-4" />Settings
            </button>
          </div>
          
          {/* SALES FORECAST TAB */}
          {forecastTab === 'sales' && (
            <div className="space-y-6">
              {/* Time Period Selector */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                <div className="flex items-center justify-between flex-wrap gap-4">
                  <div>
                    <h3 className="text-white font-medium mb-1">Select Forecast Period</h3>
                    <p className="text-slate-400 text-sm">AI will predict total sales (Amazon + Shopify combined)</p>
                  </div>
                  <div className="flex gap-2">
                    {['tomorrow', 'week', 'month', 'quarter'].map(period => (
                      <button
                        key={period}
                        onClick={() => setForecastPeriod(period)}
                        className={`px-4 py-2 rounded-lg text-sm font-medium ${forecastPeriod === period ? 'bg-emerald-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                      >
                        {period === 'tomorrow' ? 'Tomorrow' : period === 'week' ? 'This Week' : period === 'month' ? 'This Month' : 'This Quarter'}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
              
              {/* Generate Button & Results */}
              <div className="bg-gradient-to-br from-emerald-900/30 via-slate-800 to-teal-900/20 rounded-2xl border border-emerald-500/30 p-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-xl font-semibold text-white">
                      {forecastPeriod === 'tomorrow' ? "Tomorrow's" : forecastPeriod === 'week' ? 'This Week' : forecastPeriod === 'month' ? 'This Month' : 'This Quarter'} Sales Forecast
                    </h3>
                    <p className="text-slate-400 text-sm">
                      {forecastPeriod === 'week' 
                        ? 'Multi-Signal AI forecast (synced with dashboard)'
                        : `AI prediction using ${activeWeeksCount} active weeks + ${sortedDays.length} days of sales data`}
                    </p>
                  </div>
                  {forecastPeriod === 'week' ? (
                    <button 
                      onClick={generateAIForecasts}
                      disabled={aiForecastLoading}
                      className="px-6 py-3 bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 disabled:cursor-not-allowed rounded-xl text-white font-medium flex items-center gap-2"
                    >
                      {aiForecastLoading ? (
                        <><Loader2 className="w-5 h-5 animate-spin" />Analyzing...</>
                      ) : (
                        <><Brain className="w-5 h-5" />Refresh Forecast</>
                      )}
                    </button>
                  ) : (
                    <button 
                      onClick={() => generateSalesForecastAI(forecastPeriod)}
                      disabled={aiForecastModule.loading === 'sales' || !hasEnoughData}
                      className="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 disabled:cursor-not-allowed rounded-xl text-white font-medium flex items-center gap-2"
                    >
                      {aiForecastModule.loading === 'sales' ? (
                        <><Loader2 className="w-5 h-5 animate-spin" />Analyzing...</>
                      ) : (
                        <><Zap className="w-5 h-5" />Generate Forecast</>
                      )}
                    </button>
                  )}
                </div>
                
                {!hasEnoughData && (
                  <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4 mb-4">
                    <p className="text-amber-400">Need at least 4 weeks or 14 days of sales data to generate forecasts.</p>
                  </div>
                )}
                
                {/* This Week - Always use Multi-Signal AI Forecast (same as dashboard) */}
                {forecastPeriod === 'week' && aiForecasts?.salesForecast?.next4Weeks?.[0] && (
                  <div className="space-y-4">
                    {/* Prediction Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-slate-700">
                        <p className="text-slate-400 text-sm mb-1">Expected Revenue</p>
                        <p className="text-3xl font-bold text-white">{formatCurrency(aiForecasts.salesForecast.next4Weeks[0].predictedRevenue || 0)}</p>
                        <p className="text-slate-500 text-xs mt-1">
                          Daily avg: {formatCurrency(aiForecasts.calculatedSignals?.dailyAvg7 || 0)}/day
                        </p>
                      </div>
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-slate-700">
                        <p className="text-slate-400 text-sm mb-1">Expected Profit</p>
                        <p className={`text-3xl font-bold ${(aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                          {formatCurrency(aiForecasts.salesForecast.next4Weeks[0].predictedProfit || 0)}
                        </p>
                        <p className="text-slate-500 text-xs mt-1">
                          {aiForecasts.salesForecast.next4Weeks[0].confidence} confidence
                        </p>
                      </div>
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-slate-700">
                        <p className="text-slate-400 text-sm mb-1">Expected Units</p>
                        <p className="text-3xl font-bold text-white">{formatNumber(aiForecasts.salesForecast.next4Weeks[0].predictedUnits || 0)}</p>
                        <p className="text-slate-500 text-xs mt-1">
                          ~{formatNumber(Math.round((aiForecasts.salesForecast.next4Weeks[0].predictedUnits || 0) / 7))}/day
                        </p>
                      </div>
                    </div>
                    
                    {/* Signals & Methodology */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-slate-800/50 rounded-xl p-4">
                        <div className="flex items-center gap-3 mb-2">
                          <span className={`px-3 py-1 rounded-lg text-sm font-medium ${
                            aiForecasts.salesForecast.next4Weeks[0].confidence === 'high' ? 'bg-emerald-500/20 text-emerald-400' :
                            aiForecasts.salesForecast.next4Weeks[0].confidence === 'medium' ? 'bg-amber-500/20 text-amber-400' :
                            'bg-slate-600 text-slate-300'
                          }`}>
                            {aiForecasts.salesForecast.next4Weeks[0].confidence} confidence
                          </span>
                          <span className={`px-3 py-1 rounded-lg text-sm ${
                            (aiForecasts.calculatedSignals?.momentum || 0) > 5 ? 'bg-emerald-500/20 text-emerald-400' :
                            (aiForecasts.calculatedSignals?.momentum || 0) < -5 ? 'bg-rose-500/20 text-rose-400' :
                            'bg-slate-600 text-slate-300'
                          }`}>
                            {(aiForecasts.calculatedSignals?.momentum || 0) > 5 ? 'â†‘ Upward momentum' : 
                             (aiForecasts.calculatedSignals?.momentum || 0) < -5 ? 'â†“ Downward momentum' : 'â†’ Stable'}
                          </span>
                        </div>
                        <p className="text-slate-300 text-sm">
                          Momentum: {aiForecasts.calculatedSignals?.momentum > 0 ? '+' : ''}{aiForecasts.calculatedSignals?.momentum?.toFixed(1)}% (last 7 days vs prior 7 days)
                        </p>
                      </div>
                      <div className="bg-slate-800/50 rounded-xl p-4">
                        <p className="text-slate-400 text-sm mb-2">Forecast Methodology</p>
                        <div className="flex flex-wrap gap-2">
                          <span className="px-2 py-1 bg-slate-700 text-slate-300 rounded text-xs">ðŸ“Š {aiForecasts.dataPoints?.dailyDays || aiForecasts.dataPoints?.daysAnalyzed || 0} days of daily data</span>
                          <span className="px-2 py-1 bg-slate-700 text-slate-300 rounded text-xs">ðŸ“… {aiForecasts.dataPoints?.weeklyWeeks || aiForecasts.dataPoints?.weeksAnalyzed || 0} weeks of weekly data</span>
                          {aiForecasts.dataPoints?.amazonForecastWeeks > 0 && (
                            <span className="px-2 py-1 bg-orange-700 text-orange-300 rounded text-xs">ðŸ›’ {aiForecasts.dataPoints.amazonForecastWeeks} Amazon forecasts</span>
                          )}
                        </div>
                        <p className="text-purple-400 text-xs mt-2">Weighted: 60% daily trends, 20% weekly, 20% Amazon (if available)</p>
                      </div>
                    </div>
                    
                    {/* 4-Week Outlook */}
                    <div className="bg-slate-800/50 rounded-xl p-4">
                      <p className="text-slate-400 text-sm mb-3">4-Week Outlook</p>
                      <div className="grid grid-cols-4 gap-3">
                        {aiForecasts.salesForecast.next4Weeks.map((w, i) => (
                          <div key={i} className={`text-center p-3 rounded-lg ${i === 0 ? 'bg-purple-900/30 border border-purple-500/30' : 'bg-slate-700/30'}`}>
                            <p className="text-slate-500 text-xs mb-1">Week {i + 1}</p>
                            <p className="text-white font-bold">{formatCurrency(w.predictedRevenue || 0)}</p>
                            <p className={`text-xs ${(w.predictedProfit || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                              {formatCurrency(w.predictedProfit || 0)}
                            </p>
                          </div>
                        ))}
                      </div>
                    </div>
                    
                    <p className="text-slate-500 text-xs text-right">
                      Last updated: {aiForecasts.generatedAt ? new Date(aiForecasts.generatedAt).toLocaleString() : 'â€”'}
                    </p>
                  </div>
                )}
                
                {/* This Week - No forecast yet */}
                {forecastPeriod === 'week' && !aiForecasts?.salesForecast?.next4Weeks?.[0] && !aiForecastLoading && hasEnoughData && (
                  <div className="text-center py-8">
                    <Brain className="w-12 h-12 text-purple-400/30 mx-auto mb-3" />
                    <p className="text-slate-400">Click "Refresh Forecast" to generate your weekly prediction</p>
                    <p className="text-slate-500 text-xs mt-2">Uses the same Multi-Signal AI as the dashboard widget</p>
                  </div>
                )}
                
                {/* Other periods (Tomorrow, Month, Quarter) - use generateSalesForecastAI */}
                {forecastPeriod !== 'week' && aiForecastModule.sales?.[forecastPeriod] && (
                  <div className="space-y-4">
                    {/* Prediction Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-slate-700">
                        <p className="text-slate-400 text-sm mb-1">Expected Revenue</p>
                        <p className="text-3xl font-bold text-white">{formatCurrency(aiForecastModule.sales[forecastPeriod].prediction?.revenue?.expected || 0)}</p>
                        <p className="text-slate-500 text-xs mt-1">
                          Range: {formatCurrency(aiForecastModule.sales[forecastPeriod].prediction?.revenue?.low || 0)} - {formatCurrency(aiForecastModule.sales[forecastPeriod].prediction?.revenue?.high || 0)}
                        </p>
                      </div>
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-slate-700">
                        <p className="text-slate-400 text-sm mb-1">Expected Profit</p>
                        <p className={`text-3xl font-bold ${(aiForecastModule.sales[forecastPeriod].prediction?.profit?.expected || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                          {formatCurrency(aiForecastModule.sales[forecastPeriod].prediction?.profit?.expected || 0)}
                        </p>
                        <p className="text-slate-500 text-xs mt-1">
                          Range: {formatCurrency(aiForecastModule.sales[forecastPeriod].prediction?.profit?.low || 0)} - {formatCurrency(aiForecastModule.sales[forecastPeriod].prediction?.profit?.high || 0)}
                        </p>
                      </div>
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-slate-700">
                        <p className="text-slate-400 text-sm mb-1">Expected Units</p>
                        <p className="text-3xl font-bold text-white">{formatNumber(aiForecastModule.sales[forecastPeriod].prediction?.units?.expected || 0)}</p>
                        <p className="text-slate-500 text-xs mt-1">
                          Range: {formatNumber(aiForecastModule.sales[forecastPeriod].prediction?.units?.low || 0)} - {formatNumber(aiForecastModule.sales[forecastPeriod].prediction?.units?.high || 0)}
                        </p>
                      </div>
                    </div>
                    
                    {/* Confidence & Insights */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-slate-800/50 rounded-xl p-4">
                        <div className="flex items-center gap-3 mb-2">
                          <span className={`px-3 py-1 rounded-lg text-sm font-medium ${
                            aiForecastModule.sales[forecastPeriod].confidence === 'high' ? 'bg-emerald-500/20 text-emerald-400' :
                            aiForecastModule.sales[forecastPeriod].confidence === 'medium' ? 'bg-amber-500/20 text-amber-400' :
                            'bg-slate-600 text-slate-300'
                          }`}>
                            {aiForecastModule.sales[forecastPeriod].confidence} confidence
                          </span>
                          <span className={`px-3 py-1 rounded-lg text-sm ${
                            aiForecastModule.sales[forecastPeriod].trend === 'up' ? 'bg-emerald-500/20 text-emerald-400' :
                            aiForecastModule.sales[forecastPeriod].trend === 'down' ? 'bg-rose-500/20 text-rose-400' :
                            'bg-slate-600 text-slate-300'
                          }`}>
                            {aiForecastModule.sales[forecastPeriod].trend === 'up' ? 'â†‘ Upward trend' : 
                             aiForecastModule.sales[forecastPeriod].trend === 'down' ? 'â†“ Downward trend' : 'â†’ Stable'}
                          </span>
                        </div>
                        <p className="text-slate-300 text-sm">{aiForecastModule.sales[forecastPeriod].reasoning}</p>
                      </div>
                      <div className="bg-slate-800/50 rounded-xl p-4">
                        <p className="text-slate-400 text-sm mb-2">Key Factors</p>
                        <div className="flex flex-wrap gap-2">
                          {(aiForecastModule.sales[forecastPeriod].factors || []).map((factor, i) => (
                            <span key={i} className="px-2 py-1 bg-slate-700 text-slate-300 rounded text-xs">{factor}</span>
                          ))}
                        </div>
                        {aiForecastModule.sales[forecastPeriod].dayOfWeekInsight && (
                          <p className="text-cyan-400 text-xs mt-2">{aiForecastModule.sales[forecastPeriod].dayOfWeekInsight}</p>
                        )}
                      </div>
                    </div>
                    
                    <p className="text-slate-500 text-xs text-right">Generated: {new Date(aiForecastModule.sales[forecastPeriod].generatedAt).toLocaleString()}</p>
                  </div>
                )}
                
                {/* Empty state for non-week periods */}
                {forecastPeriod !== 'week' && !aiForecastModule.sales?.[forecastPeriod] && !aiForecastModule.loading && hasEnoughData && (
                  <div className="text-center py-8">
                    <TrendingUp className="w-12 h-12 text-emerald-400/30 mx-auto mb-3" />
                    <p className="text-slate-400">Click "Generate Forecast" to get AI predictions for {forecastPeriod === 'tomorrow' ? "tomorrow's" : forecastPeriod === 'month' ? 'this month' : 'this quarter'} sales</p>
                  </div>
                )}
              </div>
            </div>
          )}
          
          {/* AMAZON CHANNEL TAB */}
          {forecastTab === 'amazon' && (
            <div className="space-y-6">
              <div className="bg-gradient-to-br from-orange-900/30 via-slate-800 to-amber-900/20 rounded-2xl border border-orange-500/30 p-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-xl font-semibold text-orange-400">Amazon Channel Forecast</h3>
                    <p className="text-slate-400 text-sm">AI prediction specifically for your Amazon marketplace performance</p>
                  </div>
                  <button 
                    onClick={() => generateChannelForecastAI('amazon')}
                    disabled={aiForecastModule.loading === 'amazon'}
                    className="px-6 py-3 bg-orange-600 hover:bg-orange-500 disabled:bg-slate-700 rounded-xl text-white font-medium flex items-center gap-2"
                  >
                    {aiForecastModule.loading === 'amazon' ? <><Loader2 className="w-5 h-5 animate-spin" />Analyzing...</> : <><Zap className="w-5 h-5" />Generate Amazon Forecast</>}
                  </button>
                </div>
                
                {aiForecastModule.amazon ? (
                  <div className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-orange-500/20">
                        <p className="text-slate-400 text-sm mb-1">Next Week Revenue</p>
                        <p className="text-2xl font-bold text-white">{formatCurrency(aiForecastModule.amazon.nextWeek?.revenue?.expected || 0)}</p>
                        <p className="text-slate-500 text-xs">Range: {formatCurrency(aiForecastModule.amazon.nextWeek?.revenue?.low || 0)} - {formatCurrency(aiForecastModule.amazon.nextWeek?.revenue?.high || 0)}</p>
                      </div>
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-orange-500/20">
                        <p className="text-slate-400 text-sm mb-1">Next Week Profit</p>
                        <p className={`text-2xl font-bold ${(aiForecastModule.amazon.nextWeek?.profit?.expected || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                          {formatCurrency(aiForecastModule.amazon.nextWeek?.profit?.expected || 0)}
                        </p>
                      </div>
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-orange-500/20">
                        <p className="text-slate-400 text-sm mb-1">Next Month Total</p>
                        <p className="text-2xl font-bold text-white">{formatCurrency(aiForecastModule.amazon.nextMonth?.revenue || 0)}</p>
                        <p className={`text-xs ${(aiForecastModule.amazon.nextMonth?.profit || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                          {formatCurrency(aiForecastModule.amazon.nextMonth?.profit || 0)} profit
                        </p>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-slate-800/50 rounded-xl p-4">
                        <p className="text-orange-400 font-medium mb-2">Channel Health: <span className={`${aiForecastModule.amazon.channelHealth === 'excellent' ? 'text-emerald-400' : aiForecastModule.amazon.channelHealth === 'good' ? 'text-cyan-400' : aiForecastModule.amazon.channelHealth === 'fair' ? 'text-amber-400' : 'text-rose-400'}`}>{aiForecastModule.amazon.channelHealth}</span></p>
                        <p className="text-slate-300 text-sm">{aiForecastModule.amazon.reasoning}</p>
                        {aiForecastModule.amazon.vsAmazonForecast && (
                          <p className="text-cyan-400 text-xs mt-2 border-t border-slate-700 pt-2">vs Amazon's Forecast: {aiForecastModule.amazon.vsAmazonForecast}</p>
                        )}
                      </div>
                      <div className="bg-slate-800/50 rounded-xl p-4">
                        <p className="text-slate-400 text-sm mb-2">Recommendations</p>
                        <ul className="space-y-1">
                          {(aiForecastModule.amazon.recommendations || []).map((rec, i) => (
                            <li key={i} className="text-slate-300 text-sm flex items-start gap-2">
                              <span className="text-orange-400">â€¢</span>{rec}
                            </li>
                          ))}
                        </ul>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <Store className="w-12 h-12 text-orange-400/30 mx-auto mb-3" />
                    <p className="text-slate-400">Generate an Amazon-specific forecast to see detailed channel predictions</p>
                  </div>
                )}
              </div>
            </div>
          )}
          
          {/* SHOPIFY CHANNEL TAB */}
          {forecastTab === 'shopify' && (
            <div className="space-y-6">
              <div className="bg-gradient-to-br from-green-900/30 via-slate-800 to-emerald-900/20 rounded-2xl border border-green-500/30 p-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-xl font-semibold text-green-400">Shopify/DTC Forecast</h3>
                    <p className="text-slate-400 text-sm">AI prediction specifically for your direct-to-consumer sales</p>
                  </div>
                  <button 
                    onClick={() => generateChannelForecastAI('shopify')}
                    disabled={aiForecastModule.loading === 'shopify'}
                    className="px-6 py-3 bg-green-600 hover:bg-green-500 disabled:bg-slate-700 rounded-xl text-white font-medium flex items-center gap-2"
                  >
                    {aiForecastModule.loading === 'shopify' ? <><Loader2 className="w-5 h-5 animate-spin" />Analyzing...</> : <><Zap className="w-5 h-5" />Generate Shopify Forecast</>}
                  </button>
                </div>
                
                {aiForecastModule.shopify ? (
                  <div className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-green-500/20">
                        <p className="text-slate-400 text-sm mb-1">Next Week Revenue</p>
                        <p className="text-2xl font-bold text-white">{formatCurrency(aiForecastModule.shopify.nextWeek?.revenue?.expected || 0)}</p>
                      </div>
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-green-500/20">
                        <p className="text-slate-400 text-sm mb-1">Next Week Profit</p>
                        <p className={`text-2xl font-bold ${(aiForecastModule.shopify.nextWeek?.profit?.expected || 0) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                          {formatCurrency(aiForecastModule.shopify.nextWeek?.profit?.expected || 0)}
                        </p>
                      </div>
                      <div className="bg-slate-800/70 rounded-xl p-4 border border-green-500/20">
                        <p className="text-slate-400 text-sm mb-1">Monthly Projection</p>
                        <p className="text-2xl font-bold text-white">{formatCurrency(aiForecastModule.shopify.nextMonth?.revenue || 0)}</p>
                      </div>
                    </div>
                    
                    <div className="bg-slate-800/50 rounded-xl p-4">
                      <p className="text-slate-300 text-sm">{aiForecastModule.shopify.reasoning}</p>
                      <div className="mt-3 flex flex-wrap gap-2">
                        {(aiForecastModule.shopify.insights || []).map((insight, i) => (
                          <span key={i} className="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs">{insight}</span>
                        ))}
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <ShoppingBag className="w-12 h-12 text-green-400/30 mx-auto mb-3" />
                    <p className="text-slate-400">Generate a Shopify-specific forecast to see detailed DTC predictions</p>
                  </div>
                )}
              </div>
            </div>
          )}
          
          {/* INVENTORY TAB */}
          {forecastTab === 'inventory' && (
            <div className="space-y-6">
              <div className="bg-gradient-to-br from-amber-900/30 via-slate-800 to-yellow-900/20 rounded-2xl border border-amber-500/30 p-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-xl font-semibold text-amber-400">Inventory Forecast & Reorder</h3>
                    <p className="text-slate-400 text-sm">AI analyzes stock levels, velocity, and lead times to recommend reorders</p>
                  </div>
                  <button 
                    onClick={generateInventoryAI}
                    disabled={aiForecastModule.loading === 'inventory'}
                    className="px-6 py-3 bg-amber-600 hover:bg-amber-500 disabled:bg-slate-700 rounded-xl text-white font-medium flex items-center gap-2"
                  >
                    {aiForecastModule.loading === 'inventory' ? <><Loader2 className="w-5 h-5 animate-spin" />Analyzing...</> : <><Zap className="w-5 h-5" />Analyze Inventory</>}
                  </button>
                </div>
                
                {/* Lead Time Settings Reminder */}
                <div className="bg-slate-800/50 rounded-lg p-3 mb-4 flex items-center justify-between">
                  <div>
                    <p className="text-slate-300 text-sm">Default Lead Time: <span className="text-amber-400 font-medium">{leadTimeSettings.defaultLeadTimeDays} days</span></p>
                    <p className="text-slate-500 text-xs">Buffer: {leadTimeSettings.reorderBuffer} days â€¢ {Object.keys(leadTimeSettings.skuLeadTimes || {}).length} SKU-specific settings</p>
                  </div>
                  <button onClick={() => setForecastTab('settings')} className="text-xs text-amber-400 hover:text-amber-300">Edit Settings â†’</button>
                </div>
                
                {aiForecastModule.inventory ? (
                  <div className="space-y-4">
                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="bg-rose-900/30 rounded-xl p-4 border border-rose-500/30">
                        <p className="text-rose-400 text-sm">Critical</p>
                        <p className="text-3xl font-bold text-white">{aiForecastModule.inventory.summary?.criticalCount || 0}</p>
                      </div>
                      <div className="bg-amber-900/30 rounded-xl p-4 border border-amber-500/30">
                        <p className="text-amber-400 text-sm">Need Reorder</p>
                        <p className="text-3xl font-bold text-white">{aiForecastModule.inventory.summary?.reorderCount || 0}</p>
                      </div>
                      <div className="bg-emerald-900/30 rounded-xl p-4 border border-emerald-500/30">
                        <p className="text-emerald-400 text-sm">Healthy</p>
                        <p className="text-3xl font-bold text-white">{aiForecastModule.inventory.summary?.healthyCount || 0}</p>
                      </div>
                      <div className="bg-slate-800 rounded-xl p-4 border border-slate-600">
                        <p className="text-slate-400 text-sm">Total Value</p>
                        <p className="text-2xl font-bold text-white">{formatCurrency(aiForecastModule.inventory.summary?.totalValue || 0)}</p>
                      </div>
                    </div>
                    
                    {/* Alerts */}
                    {aiForecastModule.inventory.alerts && aiForecastModule.inventory.alerts.length > 0 && (
                      <div className="bg-rose-900/20 border border-rose-500/30 rounded-xl p-4">
                        <h4 className="text-rose-400 font-medium mb-2 flex items-center gap-2"><AlertTriangle className="w-4 h-4" />Urgent Alerts</h4>
                        <ul className="space-y-1">
                          {aiForecastModule.inventory.alerts.map((alert, i) => (
                            <li key={i} className="text-white text-sm">â€¢ {alert}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {/* Recommendations */}
                    {aiForecastModule.inventory.recommendations && (
                      <div className="bg-slate-800/50 rounded-xl p-4">
                        <h4 className="text-white font-medium mb-3">Reorder Recommendations</h4>
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                          {aiForecastModule.inventory.recommendations.slice(0, 15).map((rec, i) => (
                            <div key={i} className={`p-3 rounded-lg ${
                              rec.urgency === 'critical' ? 'bg-rose-900/30 border border-rose-500/30' :
                              rec.urgency === 'reorder' ? 'bg-amber-900/30 border border-amber-500/30' :
                              rec.urgency === 'monitor' ? 'bg-cyan-900/20 border border-cyan-500/20' :
                              'bg-emerald-900/20 border border-emerald-500/20'
                            }`}>
                              <div className="flex items-center justify-between mb-1">
                                <span className="text-white font-medium">{savedProductNames[rec.sku] || rec.name || rec.sku}</span>
                                <span className={`text-xs px-2 py-1 rounded ${
                                  rec.urgency === 'critical' ? 'bg-rose-500 text-white' :
                                  rec.urgency === 'reorder' ? 'bg-amber-500 text-white' :
                                  rec.urgency === 'monitor' ? 'bg-cyan-500/50 text-cyan-100' :
                                  'bg-emerald-500/50 text-emerald-100'
                                }`}>{rec.urgency}</span>
                              </div>
                              <p className="text-slate-400 text-sm">{rec.action}</p>
                              <div className="flex flex-wrap gap-3 mt-2 text-xs">
                                <span className="text-slate-500">Stock: {rec.currentStock}</span>
                                <span className="text-slate-500">Velocity: {rec.weeklyVelocity?.toFixed(1)}/wk</span>
                                <span className="text-slate-500">DOS: {rec.daysOfSupply} days</span>
                                <span className="text-slate-500">Lead: {rec.leadTimeDays} days</span>
                                {rec.suggestedOrderQty && <span className="text-amber-400 font-medium">Order: {rec.suggestedOrderQty} units</span>}
                                {rec.stockoutDate && <span className="text-rose-400">Stockout: {rec.stockoutDate}</span>}
                              </div>
                              {rec.pendingProduction && (
                                <p className="text-cyan-400 text-xs mt-1">ðŸ“¦ {rec.pendingProduction} units arriving {rec.pendingArrivalDate}</p>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* Insights */}
                    {aiForecastModule.inventory.insights && (
                      <div className="bg-slate-800/30 rounded-xl p-4">
                        <p className="text-slate-300 text-sm">{aiForecastModule.inventory.insights}</p>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <Boxes className="w-12 h-12 text-amber-400/30 mx-auto mb-3" />
                    <p className="text-slate-400">Analyze your inventory to get AI-powered reorder recommendations</p>
                  </div>
                )}
              </div>
            </div>
          )}
          
          {/* COMPARISON TAB */}
          {forecastTab === 'comparison' && (
            <div className="space-y-6">
              <div className="bg-gradient-to-br from-cyan-900/30 via-slate-800 to-blue-900/20 rounded-2xl border border-cyan-500/30 p-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-xl font-semibold text-cyan-400">AI vs Amazon Forecast Comparison</h3>
                    <p className="text-slate-400 text-sm">Compare our AI predictions against Amazon's forecasts to see accuracy</p>
                  </div>
                  <button 
                    onClick={generateForecastComparisonAI}
                    disabled={aiForecastModule.loading === 'comparison'}
                    className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 disabled:bg-slate-700 rounded-xl text-white font-medium flex items-center gap-2"
                  >
                    {aiForecastModule.loading === 'comparison' ? <><Loader2 className="w-5 h-5 animate-spin" />Analyzing...</> : <><Zap className="w-5 h-5" />Compare Forecasts</>}
                  </button>
                </div>
                
                {aiForecastModule.comparison ? (
                  <div className="space-y-4">
                    {/* Accuracy Comparison */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-orange-900/20 border border-orange-500/30 rounded-xl p-4">
                        <h4 className="text-orange-400 font-medium mb-3">Amazon Forecast Accuracy</h4>
                        <div className="space-y-2">
                          <div className="flex justify-between">
                            <span className="text-slate-400">Avg Revenue Error</span>
                            <span className={`font-medium ${Math.abs(aiForecastModule.comparison.amazonAccuracy?.averageRevenueError || 0) < 15 ? 'text-emerald-400' : 'text-amber-400'}`}>
                              {(aiForecastModule.comparison.amazonAccuracy?.averageRevenueError || 0).toFixed(1)}%
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">Avg Units Error</span>
                            <span className="text-white font-medium">{(aiForecastModule.comparison.amazonAccuracy?.averageUnitsError || 0).toFixed(1)}%</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">Bias</span>
                            <span className="text-white">{aiForecastModule.comparison.amazonAccuracy?.bias}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">Consistency</span>
                            <span className="text-white">{aiForecastModule.comparison.amazonAccuracy?.consistency}</span>
                          </div>
                        </div>
                      </div>
                      
                      <div className="bg-purple-900/20 border border-purple-500/30 rounded-xl p-4">
                        <h4 className="text-purple-400 font-medium mb-3">Our AI Accuracy</h4>
                        <div className="space-y-2">
                          <div className="flex justify-between">
                            <span className="text-slate-400">Avg Error</span>
                            <span className="text-white font-medium">
                              {aiForecastModule.comparison.aiAccuracy?.averageError !== null 
                                ? `${aiForecastModule.comparison.aiAccuracy.averageError.toFixed(1)}%` 
                                : 'Learning...'}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">vs Amazon</span>
                            <span className={`font-medium ${
                              aiForecastModule.comparison.aiAccuracy?.improvement === 'better than Amazon' ? 'text-emerald-400' :
                              aiForecastModule.comparison.aiAccuracy?.improvement === 'similar' ? 'text-cyan-400' :
                              'text-amber-400'
                            }`}>
                              {aiForecastModule.comparison.aiAccuracy?.improvement}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Recommended Corrections */}
                    <div className="bg-slate-800/50 rounded-xl p-4">
                      <h4 className="text-white font-medium mb-3">Recommended Corrections (Apply to Amazon Forecasts)</h4>
                      <div className="grid grid-cols-3 gap-4">
                        <div>
                          <p className="text-slate-400 text-sm">Revenue Multiplier</p>
                          <p className="text-xl font-bold text-cyan-400">{(aiForecastModule.comparison.recommendedCorrection?.revenue || 1).toFixed(3)}x</p>
                        </div>
                        <div>
                          <p className="text-slate-400 text-sm">Units Multiplier</p>
                          <p className="text-xl font-bold text-cyan-400">{(aiForecastModule.comparison.recommendedCorrection?.units || 1).toFixed(3)}x</p>
                        </div>
                        <div>
                          <p className="text-slate-400 text-sm">Confidence</p>
                          <p className="text-xl font-bold text-white">{aiForecastModule.comparison.recommendedCorrection?.confidence || 0}%</p>
                        </div>
                      </div>
                    </div>
                    
                    {/* Patterns & Insights */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-slate-800/30 rounded-xl p-4">
                        <p className="text-slate-400 text-sm mb-2">Patterns Detected</p>
                        <ul className="space-y-1">
                          {(aiForecastModule.comparison.patterns || []).map((pattern, i) => (
                            <li key={i} className="text-slate-300 text-sm">â€¢ {pattern}</li>
                          ))}
                        </ul>
                      </div>
                      <div className="bg-slate-800/30 rounded-xl p-4">
                        <p className="text-slate-400 text-sm mb-2">Recommendations</p>
                        <ul className="space-y-1">
                          {(aiForecastModule.comparison.recommendations || []).map((rec, i) => (
                            <li key={i} className="text-slate-300 text-sm">â€¢ {rec}</li>
                          ))}
                        </ul>
                      </div>
                    </div>
                    
                    <div className="bg-slate-800/20 rounded-xl p-4">
                      <p className="text-slate-300 text-sm">{aiForecastModule.comparison.insights}</p>
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <BarChart3 className="w-12 h-12 text-cyan-400/30 mx-auto mb-3" />
                    <p className="text-slate-400">Compare our AI predictions against Amazon's forecasts to improve accuracy</p>
                  </div>
                )}
              </div>
            </div>
          )}
          
          {/* SETTINGS TAB */}
          {forecastTab === 'settings' && (
            <div className="space-y-6">
              <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                <h3 className="text-xl font-semibold text-white mb-4">Lead Time Settings</h3>
                <p className="text-slate-400 text-sm mb-6">Configure production lead times so AI can calculate accurate reorder points</p>
                
                {/* Default Lead Time */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">Default Lead Time (days)</label>
                    <input 
                      type="number"
                      value={leadTimeSettings.defaultLeadTimeDays}
                      onChange={(e) => setLeadTimeSettings(prev => ({ ...prev, defaultLeadTimeDays: parseInt(e.target.value) || 14 }))}
                      className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white"
                      min="1"
                    />
                    <p className="text-slate-500 text-xs mt-1">Average time from order to delivery for most products</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">Reorder Buffer (days)</label>
                    <input 
                      type="number"
                      value={leadTimeSettings.reorderBuffer}
                      onChange={(e) => setLeadTimeSettings(prev => ({ ...prev, reorderBuffer: parseInt(e.target.value) || 7 }))}
                      className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white"
                      min="0"
                    />
                    <p className="text-slate-500 text-xs mt-1">Extra safety margin added to lead time for reorder alerts</p>
                  </div>
                </div>
                
                {/* SKU-Specific Lead Times */}
                <div className="border-t border-slate-700 pt-6">
                  <h4 className="text-white font-medium mb-4">SKU-Specific Lead Times</h4>
                  <p className="text-slate-400 text-sm mb-4">Override default lead time for specific products (e.g., items shipped from overseas)</p>
                  
                  {Object.keys(leadTimeSettings.skuLeadTimes || {}).length > 0 && (
                    <div className="space-y-2 mb-4">
                      {Object.entries(leadTimeSettings.skuLeadTimes).map(([sku, days]) => (
                        <div key={sku} className="flex items-center justify-between bg-slate-900/50 rounded-lg p-3">
                          <div>
                            <span className="text-white font-medium">{savedProductNames[sku] || sku}</span>
                            <span className="text-slate-500 text-sm ml-2">({sku})</span>
                          </div>
                          <div className="flex items-center gap-3">
                            <span className="text-amber-400 font-medium">{days} days</span>
                            <button 
                              onClick={() => {
                                const updated = { ...leadTimeSettings.skuLeadTimes };
                                delete updated[sku];
                                setLeadTimeSettings(prev => ({ ...prev, skuLeadTimes: updated }));
                              }}
                              className="text-slate-500 hover:text-rose-400"
                            >
                              <X className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* Add New SKU Lead Time */}
                  <div className="bg-slate-900/50 rounded-xl p-4">
                    <p className="text-slate-400 text-sm mb-3">Add SKU-specific lead time:</p>
                    <div className="flex gap-3">
                      <select 
                        id="sku-lead-time-select"
                        className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"
                        defaultValue=""
                      >
                        <option value="">Select SKU...</option>
                        {Object.keys(savedCogs).filter(sku => !leadTimeSettings.skuLeadTimes?.[sku]).slice(0, 50).map(sku => (
                          <option key={sku} value={sku}>{savedProductNames[sku] || sku}</option>
                        ))}
                      </select>
                      <input 
                        type="number"
                        id="sku-lead-time-days"
                        placeholder="Days"
                        className="w-24 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"
                        min="1"
                      />
                      <button 
                        onClick={() => {
                          const select = document.getElementById('sku-lead-time-select');
                          const daysInput = document.getElementById('sku-lead-time-days');
                          if (select.value && daysInput.value) {
                            setLeadTimeSettings(prev => ({
                              ...prev,
                              skuLeadTimes: { ...prev.skuLeadTimes, [select.value]: parseInt(daysInput.value) }
                            }));
                            select.value = '';
                            daysInput.value = '';
                          }
                        }}
                        className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white"
                      >
                        Add
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Learning Data */}
              <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                <h3 className="text-xl font-semibold text-white mb-4">AI Learning Data</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                  <div className="bg-slate-900/50 rounded-xl p-4">
                    <p className="text-slate-400 text-sm">Total Predictions</p>
                    <p className="text-2xl font-bold text-white">{aiLearningHistory.predictions?.length || 0}</p>
                  </div>
                  <div className="bg-slate-900/50 rounded-xl p-4">
                    <p className="text-slate-400 text-sm">Verified with Actuals</p>
                    <p className="text-2xl font-bold text-emerald-400">{aiLearningHistory.predictions?.filter(p => p.actual !== undefined).length || 0}</p>
                  </div>
                  <div className="bg-slate-900/50 rounded-xl p-4">
                    <p className="text-slate-400 text-sm">Self-Learning Samples</p>
                    <p className="text-2xl font-bold text-cyan-400">{forecastCorrections.samplesUsed || 0}</p>
                  </div>
                  <div className="bg-slate-900/50 rounded-xl p-4">
                    <p className="text-slate-400 text-sm">Learning Confidence</p>
                    <p className="text-2xl font-bold text-purple-400">{(forecastCorrections.confidence || 0).toFixed(0)}%</p>
                  </div>
                </div>
                <p className="text-slate-500 text-sm">AI continuously learns from every upload. The more data you add, the more accurate predictions become.</p>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  if (view === 'ads') {
    const sortedWeeks = Object.keys(allWeeksData).sort();
    const sortedDays = Object.keys(allDaysData || {}).sort();
    const hasDailyData = sortedDays.length > 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Get available years from data
    const allDates = [...sortedWeeks, ...sortedDays];
    const availableYears = [...new Set(allDates.map(d => parseInt(d.substring(0, 4))))].sort((a, b) => b - a);
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const monthNamesShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    // Get weeks/days for selected year
    const weeksInYear = sortedWeeks.filter(w => w.startsWith(String(adsYear)));
    const daysInYear = sortedDays.filter(d => d.startsWith(String(adsYear)));
    const daysInMonth = sortedDays.filter(d => {
      const date = new Date(d + 'T00:00:00');
      return date.getFullYear() === adsYear && date.getMonth() === adsMonth;
    });
    
    // Initialize selected week if not set
    if (adsTimeTab === 'weekly' && !adsSelectedWeek && weeksInYear.length > 0) {
      setTimeout(() => setAdsSelectedWeek(weeksInYear[weeksInYear.length - 1]), 0);
    }
    
    // Helper to aggregate ad data from weeks
    const aggregateWeeklyData = (weeks) => {
      return weeks.reduce((acc, w) => {
        const week = allWeeksData[w];
        if (!week) return acc;
        const amzAds = week.amazon?.adSpend || 0;
        const amzRev = week.amazon?.revenue || 0;
        const metaAds = week.shopify?.metaAds || week.shopify?.metaSpend || 0;
        const googleAds = week.shopify?.googleAds || week.shopify?.googleSpend || 0;
        const shopifyAdSpend = week.shopify?.adSpend || 0;
        const shopAds = (metaAds + googleAds) > 0 ? (metaAds + googleAds) : shopifyAdSpend;
        const shopRev = week.shopify?.revenue || 0;
        const totalRev = week.total?.revenue || (amzRev + shopRev);
        return {
          amzAds: acc.amzAds + amzAds, amzRev: acc.amzRev + amzRev,
          metaAds: acc.metaAds + metaAds, googleAds: acc.googleAds + googleAds,
          shopAds: acc.shopAds + shopAds, shopRev: acc.shopRev + shopRev,
          totalAds: acc.totalAds + amzAds + shopAds, totalRev: acc.totalRev + totalRev,
          count: acc.count + 1,
        };
      }, { amzAds: 0, amzRev: 0, metaAds: 0, googleAds: 0, shopAds: 0, shopRev: 0, totalAds: 0, totalRev: 0, count: 0 });
    };
    
    // Helper to aggregate daily ad data
    const aggregateDailyData = (days) => {
      return days.reduce((acc, d) => {
        const day = allDaysData[d];
        if (!day) return acc;
        
        // Get ad spend from shopify object
        const googleAds = day.shopify?.googleSpend || day.googleSpend || day.googleAds || 0;
        const metaAds = day.shopify?.metaSpend || day.metaSpend || day.metaAds || 0;
        const amazonAds = day.amazon?.adSpend || 0;
        
        // Get detailed metrics from adsMetrics
        const adsMetrics = day.shopify?.adsMetrics || {};
        const googleImpressions = adsMetrics.googleImpressions || day.googleImpressions || 0;
        const metaImpressions = adsMetrics.metaImpressions || day.metaImpressions || 0;
        const googleClicks = adsMetrics.googleClicks || day.googleClicks || 0;
        const metaClicks = adsMetrics.metaClicks || day.metaClicks || 0;
        const googleConversions = adsMetrics.googleConversions || day.googleConversions || 0;
        const metaPurchases = adsMetrics.metaPurchases || day.metaConversions || 0;
        const metaPurchaseValue = adsMetrics.metaPurchaseValue || 0;
        const metaROAS = adsMetrics.metaROAS || 0;
        const googleCPC = adsMetrics.googleCPC || 0;
        const googleCostPerConv = adsMetrics.googleCostPerConv || 0;
        const metaCPC = adsMetrics.metaCPC || 0;
        const metaCPM = adsMetrics.metaCPM || 0;
        const metaCTR = adsMetrics.metaCTR || 0;
        
        // Get revenue for ROAS calculation
        const shopifyRev = day.shopify?.revenue || 0;
        const amazonRev = day.amazon?.revenue || 0;
        
        return {
          googleAds: acc.googleAds + googleAds, 
          metaAds: acc.metaAds + metaAds,
          amazonAds: acc.amazonAds + amazonAds,
          totalAds: acc.totalAds + googleAds + metaAds + amazonAds,
          googleImpressions: acc.googleImpressions + googleImpressions,
          metaImpressions: acc.metaImpressions + metaImpressions,
          totalImpressions: acc.totalImpressions + googleImpressions + metaImpressions,
          googleClicks: acc.googleClicks + googleClicks,
          metaClicks: acc.metaClicks + metaClicks,
          totalClicks: acc.totalClicks + googleClicks + metaClicks,
          googleConversions: acc.googleConversions + googleConversions,
          metaPurchases: acc.metaPurchases + metaPurchases,
          metaPurchaseValue: acc.metaPurchaseValue + metaPurchaseValue,
          shopifyRev: acc.shopifyRev + shopifyRev,
          amazonRev: acc.amazonRev + amazonRev,
          totalRev: acc.totalRev + shopifyRev + amazonRev,
          count: acc.count + 1,
          // Store for averaging later
          _googleCPCs: googleCPC > 0 ? [...(acc._googleCPCs || []), googleCPC] : (acc._googleCPCs || []),
          _metaCPCs: metaCPC > 0 ? [...(acc._metaCPCs || []), metaCPC] : (acc._metaCPCs || []),
          _metaCPMs: metaCPM > 0 ? [...(acc._metaCPMs || []), metaCPM] : (acc._metaCPMs || []),
        };
      }, { 
        googleAds: 0, metaAds: 0, amazonAds: 0, totalAds: 0, 
        googleImpressions: 0, metaImpressions: 0, totalImpressions: 0,
        googleClicks: 0, metaClicks: 0, totalClicks: 0,
        googleConversions: 0, metaPurchases: 0, metaPurchaseValue: 0,
        shopifyRev: 0, amazonRev: 0, totalRev: 0, count: 0,
        _googleCPCs: [], _metaCPCs: [], _metaCPMs: [],
      });
    };
    
    // Get weeks for selected period
    const getWeeksForPeriod = () => {
      switch (adsTimeTab) {
        case 'weekly': return adsSelectedWeek ? [adsSelectedWeek] : [];
        case 'monthly': {
          const monthStart = new Date(adsYear, adsMonth, 1);
          const monthEnd = new Date(adsYear, adsMonth + 1, 0);
          return sortedWeeks.filter(w => {
            const d = new Date(w + 'T00:00:00');
            return d >= monthStart && d <= monthEnd;
          });
        }
        case 'quarterly': {
          const qStart = new Date(adsYear, (adsQuarter - 1) * 3, 1);
          const qEnd = new Date(adsYear, adsQuarter * 3, 0);
          return sortedWeeks.filter(w => {
            const d = new Date(w + 'T00:00:00');
            return d >= qStart && d <= qEnd;
          });
        }
        case 'yearly': return weeksInYear;
        default: return weeksInYear.slice(-4);
      }
    };
    
    // Get comparison period
    const getComparisonWeeks = () => {
      switch (adsTimeTab) {
        case 'weekly': {
          if (!adsSelectedWeek) return [];
          const idx = weeksInYear.indexOf(adsSelectedWeek);
          return idx > 0 ? [weeksInYear[idx - 1]] : [];
        }
        case 'monthly': {
          const prevMonth = adsMonth === 0 ? 11 : adsMonth - 1;
          const prevYear = adsMonth === 0 ? adsYear - 1 : adsYear;
          const monthStart = new Date(prevYear, prevMonth, 1);
          const monthEnd = new Date(prevYear, prevMonth + 1, 0);
          return sortedWeeks.filter(w => {
            const d = new Date(w + 'T00:00:00');
            return d >= monthStart && d <= monthEnd;
          });
        }
        case 'quarterly': {
          const prevQ = adsQuarter === 1 ? 4 : adsQuarter - 1;
          const prevYear = adsQuarter === 1 ? adsYear - 1 : adsYear;
          const qStart = new Date(prevYear, (prevQ - 1) * 3, 1);
          const qEnd = new Date(prevYear, prevQ * 3, 0);
          return sortedWeeks.filter(w => {
            const d = new Date(w + 'T00:00:00');
            return d >= qStart && d <= qEnd;
          });
        }
        case 'yearly': return sortedWeeks.filter(w => w.startsWith(String(adsYear - 1)));
        default: return [];
      }
    };
    
    // Calculate aggregated data
    // Get days based on time tab selection - Daily=yesterday, Weekly=last 7 days, Monthly=last 30 days (from daysInMonth)
    const getDaysForPeriod = () => {
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      
      switch (adsTimeTab) {
        case 'daily': {
          // Yesterday only - get the most recent day with ad data
          const yesterday = new Date(now);
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
          // Return yesterday if we have data, otherwise the most recent day with any data
          if (sortedDays.includes(yesterdayStr)) {
            return [yesterdayStr];
          }
          // Fall back to most recent day with data
          const mostRecentWithAds = sortedDays.filter(d => {
            const day = allDaysData[d];
            return (day?.shopify?.googleSpend || day?.shopify?.metaSpend || day?.amazon?.adSpend || 0) > 0;
          }).slice(-1);
          return mostRecentWithAds.length > 0 ? mostRecentWithAds : sortedDays.slice(-1);
        }
        case 'weekly': {
          // Last 7 days
          const sevenDaysAgo = new Date(now);
          sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
          return sortedDays.filter(d => {
            const date = new Date(d + 'T00:00:00');
            return date >= sevenDaysAgo && date <= now;
          });
        }
        case 'monthly': {
          // Last 30 days OR selected month
          return daysInMonth;
        }
        default:
          return daysInMonth;
      }
    };
    
    const periodWeeks = getWeeksForPeriod();
    const periodDays = getDaysForPeriod();
    const weeklyTotals = aggregateWeeklyData(periodWeeks);
    const dailyTotals = aggregateDailyData(periodDays);
    const compWeeks = getComparisonWeeks();
    const compTotals = aggregateWeeklyData(compWeeks);
    
    // Use daily totals for daily/weekly tabs (since they use day-level data), weekly for others
    const useDailyData = adsTimeTab === 'daily' || adsTimeTab === 'weekly';
    const totals = useDailyData ? {
      ...dailyTotals, 
      amzAds: dailyTotals.amazonAds || 0, 
      amzRev: dailyTotals.amazonRev || 0, 
      shopAds: dailyTotals.googleAds + dailyTotals.metaAds, 
      shopRev: dailyTotals.shopifyRev || 0,
      totalRev: dailyTotals.totalRev || 0
    } : weeklyTotals;
    
    // Calculate metrics
    const shopifyAds = totals.metaAds + totals.googleAds;
    const totalTacos = totals.totalRev > 0 ? (totals.totalAds / totals.totalRev) * 100 : 0;
    const amzTacos = totals.amzRev > 0 ? (totals.amzAds / totals.amzRev) * 100 : 0;
    const shopTacos = totals.shopRev > 0 ? (shopifyAds / totals.shopRev) * 100 : 0;
    
    // Daily KPIs
    const cpc = dailyTotals.totalClicks > 0 ? dailyTotals.totalAds / dailyTotals.totalClicks : 0;
    const cpa = (dailyTotals.googleConversions + dailyTotals.metaPurchases) > 0 ? dailyTotals.totalAds / (dailyTotals.googleConversions + dailyTotals.metaPurchases) : 0;
    const ctr = dailyTotals.totalImpressions > 0 ? (dailyTotals.totalClicks / dailyTotals.totalImpressions) * 100 : 0;
    
    // Comparison metrics
    const spendChange = compTotals.totalAds > 0 ? ((totals.totalAds - compTotals.totalAds) / compTotals.totalAds) * 100 : null;
    
    const tacosColor = (tacos) => tacos <= 15 ? 'text-emerald-400' : tacos <= 25 ? 'text-amber-400' : 'text-rose-400';
    
    // Build table data
    const weeklyTableData = periodWeeks.map(w => {
      const week = allWeeksData[w];
      const amzAds = week?.amazon?.adSpend || 0;
      const metaAds = week?.shopify?.metaAds || week?.shopify?.metaSpend || 0;
      const googleAds = week?.shopify?.googleAds || week?.shopify?.googleSpend || 0;
      const totalAds = amzAds + metaAds + googleAds;
      const totalRev = week?.total?.revenue || 0;
      return { week: w, amzAds, metaAds, googleAds, totalAds, totalRev, tacos: totalRev > 0 ? (totalAds / totalRev) * 100 : 0 };
    });
    
    // Build daily table data - use periodDays for daily/weekly tabs
    const dailyTableData = (useDailyData ? periodDays : daysInMonth).map(d => {
      const day = allDaysData[d];
      const googleAds = day?.shopify?.googleSpend || day?.googleSpend || day?.googleAds || 0;
      const metaAds = day?.shopify?.metaSpend || day?.metaSpend || day?.metaAds || 0;
      const amazonAds = day?.amazon?.adSpend || 0;
      const adsMetrics = day?.shopify?.adsMetrics || {};
      const googleImpressions = adsMetrics.googleImpressions || day?.googleImpressions || 0;
      const metaImpressions = adsMetrics.metaImpressions || day?.metaImpressions || 0;
      const googleClicks = adsMetrics.googleClicks || day?.googleClicks || 0;
      const metaClicks = adsMetrics.metaClicks || day?.metaClicks || 0;
      const googleConversions = adsMetrics.googleConversions || day?.googleConversions || 0;
      const metaPurchases = adsMetrics.metaPurchases || day?.metaConversions || 0;
      const metaPurchaseValue = adsMetrics.metaPurchaseValue || 0;
      const metaROAS = adsMetrics.metaROAS || 0;
      const shopifyRev = day?.shopify?.revenue || 0;
      const amazonRev = day?.amazon?.revenue || 0;
      return { 
        date: d, 
        googleAds, metaAds, amazonAds,
        totalAds: googleAds + metaAds + amazonAds, 
        googleImpressions, metaImpressions,
        impressions: googleImpressions + metaImpressions, 
        googleClicks, metaClicks,
        clicks: googleClicks + metaClicks, 
        googleConversions, metaPurchases,
        conversions: googleConversions + metaPurchases,
        metaPurchaseValue, metaROAS,
        shopifyRev, amazonRev,
        totalRev: shopifyRev + amazonRev,
      };
    });
    
    // Labels
    const getPeriodLabel = () => {
      switch (adsTimeTab) {
        case 'daily': {
          // Show "Yesterday" or the actual date if different
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
          if (periodDays.length === 1 && periodDays[0] === yesterdayStr) {
            return 'Yesterday';
          } else if (periodDays.length === 1) {
            return new Date(periodDays[0] + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
          }
          return `${monthNames[adsMonth]} ${adsYear} - Daily`;
        }
        case 'weekly': return `Last 7 Days (${periodDays.length} days with data)`;
        case 'monthly': return `${monthNames[adsMonth]} ${adsYear}`;
        case 'quarterly': return `Q${adsQuarter} ${adsYear}`;
        case 'yearly': return `${adsYear} Full Year`;
        default: return '';
      }
    };
    
    const getCompLabel = () => {
      switch (adsTimeTab) {
        case 'weekly': return compWeeks.length > 0 ? 'vs prev week' : '';
        case 'monthly': {
          const pm = adsMonth === 0 ? 11 : adsMonth - 1;
          const py = adsMonth === 0 ? adsYear - 1 : adsYear;
          return `vs ${monthNamesShort[pm]} ${py}`;
        }
        case 'quarterly': {
          const pq = adsQuarter === 1 ? 4 : adsQuarter - 1;
          const py = adsQuarter === 1 ? adsYear - 1 : adsYear;
          return `vs Q${pq} ${py}`;
        }
        case 'yearly': return `vs ${adsYear - 1}`;
        default: return '';
      }
    };
    
    // Navigation
    const goToPrev = () => {
      if (adsTimeTab === 'daily' || adsTimeTab === 'monthly') {
        if (adsMonth === 0) { setAdsMonth(11); setAdsYear(adsYear - 1); }
        else setAdsMonth(adsMonth - 1);
      } else if (adsTimeTab === 'weekly') {
        const idx = weeksInYear.indexOf(adsSelectedWeek);
        if (idx > 0) setAdsSelectedWeek(weeksInYear[idx - 1]);
        else {
          const prevYearWeeks = sortedWeeks.filter(w => w.startsWith(String(adsYear - 1)));
          if (prevYearWeeks.length > 0) { setAdsYear(adsYear - 1); setAdsSelectedWeek(prevYearWeeks[prevYearWeeks.length - 1]); }
        }
      } else if (adsTimeTab === 'quarterly') {
        if (adsQuarter === 1) { setAdsQuarter(4); setAdsYear(adsYear - 1); } else setAdsQuarter(adsQuarter - 1);
      } else if (adsTimeTab === 'yearly') { setAdsYear(adsYear - 1); }
    };
    
    const goToNext = () => {
      if (adsTimeTab === 'daily' || adsTimeTab === 'monthly') {
        if (adsMonth === 11) { setAdsMonth(0); setAdsYear(adsYear + 1); }
        else setAdsMonth(adsMonth + 1);
      } else if (adsTimeTab === 'weekly') {
        const idx = weeksInYear.indexOf(adsSelectedWeek);
        if (idx < weeksInYear.length - 1) setAdsSelectedWeek(weeksInYear[idx + 1]);
        else {
          const nextYearWeeks = sortedWeeks.filter(w => w.startsWith(String(adsYear + 1)));
          if (nextYearWeeks.length > 0) { setAdsYear(adsYear + 1); setAdsSelectedWeek(nextYearWeeks[0]); }
        }
      } else if (adsTimeTab === 'quarterly') {
        if (adsQuarter === 4) { setAdsQuarter(1); setAdsYear(adsYear + 1); } else setAdsQuarter(adsQuarter + 1);
      } else if (adsTimeTab === 'yearly') { setAdsYear(adsYear + 1); }
    };
    
    // Months with data
    const monthsWithData = [...new Set([...sortedWeeks, ...sortedDays].filter(d => d.startsWith(String(adsYear))).map(d => new Date(d + 'T00:00:00').getMonth()))].sort((a, b) => a - b);
    
    // Amazon Campaign data processing
    const campaignData = amazonCampaigns.campaigns || [];
    const campaignSummary = amazonCampaigns.summary || {};
    const hasCampaignData = campaignData.length > 0;
    
    // Filter and sort campaigns
    const filteredCampaigns = campaignData.filter(c => {
      if (amazonCampaignFilter.status !== 'all' && c.state !== amazonCampaignFilter.status) return false;
      if (amazonCampaignFilter.type !== 'all' && c.type !== amazonCampaignFilter.type && !(amazonCampaignFilter.type === 'SB' && c.type === 'SB2')) return false;
      if (amazonCampaignFilter.search && !c.name.toLowerCase().includes(amazonCampaignFilter.search.toLowerCase())) return false;
      return true;
    }).sort((a, b) => {
      const dir = amazonCampaignSort.dir === 'asc' ? 1 : -1;
      const field = amazonCampaignSort.field;
      if (typeof a[field] === 'string') return dir * a[field].localeCompare(b[field]);
      return dir * ((a[field] || 0) - (b[field] || 0));
    });
    
    // Handle Amazon campaign file upload
    const handleAmazonCampaignUpload = (file) => {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const result = parseAmazonCampaignCSV(e.target.result);
        if (result.error) {
          setToast({ message: result.error, type: 'error' });
        } else {
          saveAmazonCampaigns(result.campaigns, result.summary);
          setToast({ message: `Imported ${result.campaigns.length} Amazon campaigns`, type: 'success' });
        }
      };
      reader.readAsText(file);
    };
    
    // Get top/bottom performers
    const topPerformers = [...campaignData].filter(c => c.state === 'ENABLED' && c.roas > 0).sort((a, b) => b.roas - a.roas).slice(0, 5);
    const bottomPerformers = [...campaignData].filter(c => c.state === 'ENABLED' && c.spend > 100).sort((a, b) => a.roas - b.roas).slice(0, 5);
    
    return (
      <div className="min-h-screen bg-slate-950 p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          <NavTabs />
          {dataBar}
          
          <div className="mb-6">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div>
                <h1 className="text-2xl lg:text-3xl font-bold text-white mb-2">âš¡ Ad Performance Analytics</h1>
                <p className="text-slate-400">Track TACOS, ad spend efficiency, and channel performance â€¢ {sortedDays.length} days, {sortedWeeks.length} weeks of data</p>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={() => setShowAdsAIChat(true)} className="px-4 py-2 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-500 hover:to-amber-500 rounded-lg text-white flex items-center gap-2">
                  <Zap className="w-4 h-4" />AI Insights
                </button>
                <button onClick={() => setShowAdsBulkUpload(true)} className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white flex items-center gap-2">
                  <Upload className="w-4 h-4" />Bulk Upload
                </button>
              </div>
            </div>
          </div>
          
          {/* AI Ads Insights Chat Panel */}
          {showAdsAIChat && (
            <div className="fixed bottom-4 right-4 z-50 w-96 max-w-[calc(100vw-2rem)]">
              <div className="bg-slate-800 rounded-2xl border border-orange-500/50 shadow-2xl overflow-hidden">
                <div className="bg-gradient-to-r from-orange-600 to-amber-600 p-4 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                      <Zap className="w-5 h-5 text-white" />
                    </div>
                    <div>
                      <h3 className="text-white font-semibold">AI Ads Analyst</h3>
                      <p className="text-white/70 text-xs">Ask about your ad performance</p>
                    </div>
                  </div>
                  <button onClick={() => setShowAdsAIChat(false)} className="p-2 hover:bg-white/20 rounded-lg text-white">
                    <X className="w-5 h-5" />
                  </button>
                </div>
                
                <div className="h-80 overflow-y-auto p-4 space-y-4">
                  {adsAiMessages.length === 0 && (
                    <div className="text-center text-slate-400 py-4">
                      <Zap className="w-12 h-12 mx-auto mb-3 opacity-50" />
                      <p className="text-sm mb-4">Ask me about your advertising performance!</p>
                      <div className="space-y-2 text-left">
                        <button onClick={() => setAdsAiInput("Which ad channel is most efficient?")} className="block w-full px-3 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-xs text-slate-300">ðŸ’¡ "Which ad channel is most efficient?"</button>
                        <button onClick={() => setAdsAiInput("What campaigns should I pause?")} className="block w-full px-3 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-xs text-slate-300">ðŸ’¡ "What campaigns should I pause?"</button>
                        <button onClick={() => setAdsAiInput("How is my Google Ads CPC trending?")} className="block w-full px-3 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-xs text-slate-300">ðŸ’¡ "How is my Google Ads CPC trending?"</button>
                        <button onClick={() => setAdsAiInput("Give me a full ads performance summary")} className="block w-full px-3 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-xs text-slate-300">ðŸ’¡ "Give me a full ads performance summary"</button>
                      </div>
                    </div>
                  )}
                  {adsAiMessages.map((msg, i) => (
                    <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[85%] rounded-2xl px-4 py-2 ${msg.role === 'user' ? 'bg-orange-600 text-white' : 'bg-slate-700 text-slate-200'}`}>
                        <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
                      </div>
                    </div>
                  ))}
                  {adsAiLoading && (
                    <div className="flex justify-start">
                      <div className="bg-slate-700 rounded-2xl px-4 py-3">
                        <div className="flex gap-1">
                          <div className="w-2 h-2 bg-orange-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
                          <div className="w-2 h-2 bg-orange-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
                          <div className="w-2 h-2 bg-orange-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                
                <div className="p-4 border-t border-slate-700">
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={adsAiInput}
                      onChange={(e) => setAdsAiInput(e.target.value)}
                      onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); sendAdsAIMessage(); } }}
                      placeholder="Ask about your ads..."
                      className="flex-1 bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white text-sm focus:outline-none focus:border-orange-500"
                      autoComplete="off"
                    />
                    <button onClick={sendAdsAIMessage} disabled={!adsAiInput.trim() || adsAiLoading} className="px-4 py-2 bg-orange-600 hover:bg-orange-500 disabled:opacity-50 rounded-xl text-white">
                      <Send className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {/* View Mode Toggle */}
          <div className="flex gap-2 mb-4">
            <button onClick={() => setAdsViewMode('performance')} className={`px-4 py-2 rounded-lg font-medium text-sm transition-all ${adsViewMode === 'performance' ? 'bg-gradient-to-r from-blue-600 to-violet-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
              ðŸ“Š Spend Performance
            </button>
            <button onClick={() => setAdsViewMode('campaigns')} className={`px-4 py-2 rounded-lg font-medium text-sm transition-all ${adsViewMode === 'campaigns' ? 'bg-gradient-to-r from-orange-600 to-amber-600 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
              ðŸŽ¯ Amazon Campaigns {hasCampaignData && <span className="ml-1 px-1.5 py-0.5 bg-white/20 rounded text-xs">{campaignData.length}</span>}
            </button>
          </div>
          
          {/* Amazon Campaigns View */}
          {adsViewMode === 'campaigns' && (
            <div>
              {/* Campaign Upload & Summary */}
              {!hasCampaignData ? (
                <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-8 text-center mb-6">
                  <div className="w-16 h-16 bg-orange-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <ShoppingBag className="w-8 h-8 text-orange-400" />
                  </div>
                  <h3 className="text-xl font-semibold text-white mb-2">Upload Amazon Campaign Data</h3>
                  <p className="text-slate-400 mb-4 max-w-md mx-auto">Upload your Amazon Ads campaign report to analyze ROAS, ACOS, and identify top performers</p>
                  <label className="inline-flex items-center gap-2 px-6 py-3 bg-orange-600 hover:bg-orange-500 rounded-xl text-white font-medium cursor-pointer">
                    <Upload className="w-5 h-5" />
                    Upload Campaign CSV
                    <input type="file" accept=".csv" className="hidden" onChange={(e) => handleAmazonCampaignUpload(e.target.files[0])} />
                  </label>
                  <p className="text-slate-500 text-sm mt-3">Export from Amazon Ads â†’ Campaigns â†’ Download Report</p>
                </div>
              ) : (
                <>
                  {/* Last Updated & Refresh */}
                  <div className="flex items-center justify-between mb-4">
                    <div className="text-slate-400 text-sm">
                      Last updated: {new Date(amazonCampaigns.lastUpdated).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' })}
                      {(() => {
                        const daysSince = Math.floor((new Date() - new Date(amazonCampaigns.lastUpdated)) / (1000 * 60 * 60 * 24));
                        if (daysSince >= 7) return <span className="text-amber-400 ml-2">âš ï¸ {daysSince} days old - refresh recommended</span>;
                        return null;
                      })()}
                    </div>
                    <label className="flex items-center gap-2 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-sm cursor-pointer">
                      <RefreshCw className="w-4 h-4" />
                      Refresh Data
                      <input type="file" accept=".csv" className="hidden" onChange={(e) => handleAmazonCampaignUpload(e.target.files[0])} />
                    </label>
                  </div>
                  
                  {/* Summary Cards */}
                  <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
                    <div className="bg-gradient-to-br from-orange-900/30 to-slate-800/50 rounded-xl border border-orange-500/30 p-4">
                      <p className="text-slate-400 text-xs uppercase">Total Spend</p>
                      <p className="text-2xl font-bold text-white">{formatCurrency(campaignSummary.totalSpend || 0)}</p>
                    </div>
                    <div className="bg-gradient-to-br from-emerald-900/30 to-slate-800/50 rounded-xl border border-emerald-500/30 p-4">
                      <p className="text-slate-400 text-xs uppercase">Total Sales</p>
                      <p className="text-2xl font-bold text-emerald-400">{formatCurrency(campaignSummary.totalSales || 0)}</p>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                      <p className="text-slate-400 text-xs uppercase">ROAS</p>
                      <p className={`text-2xl font-bold ${(campaignSummary.roas || 0) >= 3 ? 'text-emerald-400' : (campaignSummary.roas || 0) >= 2 ? 'text-amber-400' : 'text-rose-400'}`}>{(campaignSummary.roas || 0).toFixed(2)}x</p>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                      <p className="text-slate-400 text-xs uppercase">ACOS</p>
                      <p className={`text-2xl font-bold ${(campaignSummary.acos || 0) <= 25 ? 'text-emerald-400' : (campaignSummary.acos || 0) <= 35 ? 'text-amber-400' : 'text-rose-400'}`}>{(campaignSummary.acos || 0).toFixed(1)}%</p>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                      <p className="text-slate-400 text-xs uppercase">Orders</p>
                      <p className="text-2xl font-bold text-white">{(campaignSummary.totalOrders || 0).toLocaleString()}</p>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                      <p className="text-slate-400 text-xs uppercase">Conv Rate</p>
                      <p className="text-2xl font-bold text-white">{(campaignSummary.convRate || 0).toFixed(1)}%</p>
                    </div>
                  </div>
                  
                  {/* Week-over-Week Comparison */}
                  {amazonCampaigns.history?.length > 1 && (
                    <div className="bg-gradient-to-br from-violet-900/20 to-slate-800/50 rounded-xl border border-violet-500/30 p-5 mb-6">
                      <h3 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                        <TrendingUp className="w-5 h-5 text-violet-400" />
                        Week-over-Week Trend
                        <span className="text-sm font-normal text-slate-400 ml-2">({amazonCampaigns.history.length} weeks tracked)</span>
                      </h3>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b border-slate-700">
                              <th className="text-left text-slate-400 py-2">Week</th>
                              <th className="text-right text-slate-400 py-2">Spend</th>
                              <th className="text-right text-slate-400 py-2">Sales</th>
                              <th className="text-right text-slate-400 py-2">Orders</th>
                              <th className="text-right text-slate-400 py-2">ROAS</th>
                              <th className="text-right text-slate-400 py-2">ACOS</th>
                            </tr>
                          </thead>
                          <tbody>
                            {amazonCampaigns.history.slice(0, 8).map((h, i) => {
                              const prior = amazonCampaigns.history[i + 1];
                              const spendChange = prior?.summary?.totalSpend > 0 ? ((h.summary.totalSpend - prior.summary.totalSpend) / prior.summary.totalSpend * 100) : null;
                              const salesChange = prior?.summary?.totalSales > 0 ? ((h.summary.totalSales - prior.summary.totalSales) / prior.summary.totalSales * 100) : null;
                              return (
                                <tr key={h.weekKey} className={`border-b border-slate-700/50 ${i === 0 ? 'bg-violet-900/20' : ''}`}>
                                  <td className="py-2 text-white">
                                    {new Date(h.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                    {i === 0 && <span className="ml-2 text-xs text-violet-400">(latest)</span>}
                                  </td>
                                  <td className="py-2 text-right text-white">
                                    {formatCurrency(h.summary.totalSpend)}
                                    {spendChange !== null && <span className={`ml-1 text-xs ${spendChange <= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>({spendChange >= 0 ? '+' : ''}{spendChange.toFixed(0)}%)</span>}
                                  </td>
                                  <td className="py-2 text-right text-emerald-400">
                                    {formatCurrency(h.summary.totalSales)}
                                    {salesChange !== null && <span className={`ml-1 text-xs ${salesChange >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>({salesChange >= 0 ? '+' : ''}{salesChange.toFixed(0)}%)</span>}
                                  </td>
                                  <td className="py-2 text-right text-white">{(h.summary.totalOrders || 0).toLocaleString()}</td>
                                  <td className={`py-2 text-right font-medium ${h.summary.roas >= 3 ? 'text-emerald-400' : h.summary.roas >= 2 ? 'text-amber-400' : 'text-rose-400'}`}>{h.summary.roas.toFixed(2)}x</td>
                                  <td className={`py-2 text-right ${h.summary.acos <= 25 ? 'text-emerald-400' : h.summary.acos <= 35 ? 'text-amber-400' : 'text-rose-400'}`}>{h.summary.acos.toFixed(1)}%</td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                  
                  {/* Campaign Type Breakdown */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    {[
                      { type: 'SP', label: 'Sponsored Products', color: 'blue', campaigns: campaignSummary.byType?.SP || [] },
                      { type: 'SB', label: 'Sponsored Brands', color: 'purple', campaigns: campaignSummary.byType?.SB || [] },
                      { type: 'SD', label: 'Sponsored Display', color: 'teal', campaigns: campaignSummary.byType?.SD || [] },
                    ].map(({ type, label, color, campaigns: typeCampaigns }) => {
                      const spend = typeCampaigns.reduce((s, c) => s + c.spend, 0);
                      const sales = typeCampaigns.reduce((s, c) => s + c.sales, 0);
                      const roas = spend > 0 ? sales / spend : 0;
                      return (
                        <div key={type} className={`bg-slate-800/50 rounded-xl border border-slate-700 p-4`}>
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="text-white font-medium">{label}</h4>
                            <span className={`px-2 py-0.5 rounded text-xs bg-${color}-500/20 text-${color}-400`}>{typeCampaigns.length} campaigns</span>
                          </div>
                          <div className="grid grid-cols-3 gap-2 text-sm">
                            <div><p className="text-slate-500 text-xs">Spend</p><p className="text-white font-medium">{formatCurrency(spend)}</p></div>
                            <div><p className="text-slate-500 text-xs">Sales</p><p className="text-white font-medium">{formatCurrency(sales)}</p></div>
                            <div><p className="text-slate-500 text-xs">ROAS</p><p className={`font-medium ${roas >= 3 ? 'text-emerald-400' : roas >= 2 ? 'text-amber-400' : 'text-rose-400'}`}>{roas.toFixed(2)}x</p></div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* Top & Bottom Performers */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div className="bg-slate-800/50 rounded-xl border border-emerald-500/30 p-5">
                      <h3 className="text-lg font-semibold text-emerald-400 mb-3 flex items-center gap-2"><Trophy className="w-5 h-5" />Top Performers (by ROAS)</h3>
                      <div className="space-y-2">
                        {topPerformers.map((c, i) => (
                          <div key={c.id} className="flex items-center justify-between p-2 bg-slate-900/50 rounded-lg">
                            <div className="flex-1 min-w-0">
                              <p className="text-white text-sm truncate">{c.name}</p>
                              <p className="text-slate-500 text-xs">{formatCurrency(c.spend)} spent</p>
                            </div>
                            <div className="text-right ml-2">
                              <p className="text-emerald-400 font-bold">{c.roas.toFixed(2)}x</p>
                              <p className="text-slate-500 text-xs">{formatCurrency(c.sales)}</p>
                            </div>
                          </div>
                        ))}
                        {topPerformers.length === 0 && <p className="text-slate-500 text-sm">No enabled campaigns with sales</p>}
                      </div>
                    </div>
                    
                    <div className="bg-slate-800/50 rounded-xl border border-rose-500/30 p-5">
                      <h3 className="text-lg font-semibold text-rose-400 mb-3 flex items-center gap-2"><AlertTriangle className="w-5 h-5" />Needs Attention (Low ROAS)</h3>
                      <div className="space-y-2">
                        {bottomPerformers.map((c, i) => (
                          <div key={c.id} className="flex items-center justify-between p-2 bg-slate-900/50 rounded-lg">
                            <div className="flex-1 min-w-0">
                              <p className="text-white text-sm truncate">{c.name}</p>
                              <p className="text-slate-500 text-xs">{formatCurrency(c.spend)} spent</p>
                            </div>
                            <div className="text-right ml-2">
                              <p className="text-rose-400 font-bold">{c.roas.toFixed(2)}x</p>
                              <p className="text-slate-500 text-xs">ACOS: {c.acos.toFixed(0)}%</p>
                            </div>
                          </div>
                        ))}
                        {bottomPerformers.length === 0 && <p className="text-slate-500 text-sm">No underperforming campaigns</p>}
                      </div>
                    </div>
                  </div>
                  
                  {/* Campaign Table */}
                  <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                    <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
                      <h3 className="text-lg font-semibold text-white">All Campaigns ({filteredCampaigns.length})</h3>
                      <div className="flex flex-wrap items-center gap-2">
                        <select value={amazonCampaignFilter.status} onChange={(e) => setAmazonCampaignFilter(f => ({...f, status: e.target.value}))} className="bg-slate-700 border border-slate-600 rounded-lg px-2 py-1 text-white text-sm">
                          <option value="all">All Status</option>
                          <option value="ENABLED">Enabled</option>
                          <option value="PAUSED">Paused</option>
                        </select>
                        <select value={amazonCampaignFilter.type} onChange={(e) => setAmazonCampaignFilter(f => ({...f, type: e.target.value}))} className="bg-slate-700 border border-slate-600 rounded-lg px-2 py-1 text-white text-sm">
                          <option value="all">All Types</option>
                          <option value="SP">SP</option>
                          <option value="SB">SB</option>
                          <option value="SD">SD</option>
                        </select>
                        <input type="text" placeholder="Search..." value={amazonCampaignFilter.search} onChange={(e) => setAmazonCampaignFilter(f => ({...f, search: e.target.value}))} className="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1 text-white text-sm w-40" />
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="border-b border-slate-700">
                            {[
                              { field: 'name', label: 'Campaign' },
                              { field: 'type', label: 'Type' },
                              { field: 'state', label: 'Status' },
                              { field: 'spend', label: 'Spend' },
                              { field: 'sales', label: 'Sales' },
                              { field: 'orders', label: 'Orders' },
                              { field: 'roas', label: 'ROAS' },
                              { field: 'acos', label: 'ACOS' },
                            ].map(col => (
                              <th key={col.field} onClick={() => setAmazonCampaignSort(s => ({ field: col.field, dir: s.field === col.field && s.dir === 'desc' ? 'asc' : 'desc' }))} className={`text-left text-slate-400 py-2 px-2 cursor-pointer hover:text-white ${col.field !== 'name' ? 'text-right' : ''}`}>
                                {col.label} {amazonCampaignSort.field === col.field && (amazonCampaignSort.dir === 'desc' ? 'â†“' : 'â†‘')}
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {filteredCampaigns.slice(0, 50).map(c => (
                            <tr key={c.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                              <td className="py-2 px-2 text-white max-w-xs truncate" title={c.name}>{c.name}</td>
                              <td className="py-2 px-2 text-right"><span className={`px-1.5 py-0.5 rounded text-xs ${c.type === 'SP' ? 'bg-blue-500/20 text-blue-400' : c.type === 'SD' ? 'bg-teal-500/20 text-teal-400' : 'bg-purple-500/20 text-purple-400'}`}>{c.type}</span></td>
                              <td className="py-2 px-2 text-right"><span className={`px-1.5 py-0.5 rounded text-xs ${c.state === 'ENABLED' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-500/20 text-slate-400'}`}>{c.state === 'ENABLED' ? 'Active' : 'Paused'}</span></td>
                              <td className="py-2 px-2 text-right text-white">{formatCurrency(c.spend)}</td>
                              <td className="py-2 px-2 text-right text-emerald-400">{formatCurrency(c.sales)}</td>
                              <td className="py-2 px-2 text-right text-white">{c.orders.toLocaleString()}</td>
                              <td className={`py-2 px-2 text-right font-medium ${c.roas >= 3 ? 'text-emerald-400' : c.roas >= 2 ? 'text-amber-400' : 'text-rose-400'}`}>{c.roas.toFixed(2)}x</td>
                              <td className={`py-2 px-2 text-right ${c.acos <= 25 ? 'text-emerald-400' : c.acos <= 35 ? 'text-amber-400' : 'text-rose-400'}`}>{c.acos.toFixed(1)}%</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      {filteredCampaigns.length > 50 && <p className="text-slate-500 text-sm mt-2 text-center">Showing 50 of {filteredCampaigns.length} campaigns</p>}
                    </div>
                  </div>
                </>
              )}
            </div>
          )}
          
          {/* Performance View (existing content) */}
          {adsViewMode === 'performance' && (
            <>
          {/* Time Period Tabs */}
          <div className="flex gap-2 mb-4 p-1 bg-slate-800/50 rounded-xl overflow-x-auto">
            <button onClick={() => setAdsTimeTab('daily')} disabled={!hasDailyData} className={`flex-1 min-w-fit px-4 py-2.5 rounded-lg font-medium text-sm transition-all ${adsTimeTab === 'daily' ? 'bg-cyan-600 text-white' : 'text-slate-300 hover:bg-slate-700 disabled:opacity-40'}`}>
              Daily {!hasDailyData && '(no data)'}
            </button>
            {['weekly', 'monthly', 'quarterly', 'yearly'].map(tab => (
              <button key={tab} onClick={() => setAdsTimeTab(tab)} className={`flex-1 min-w-fit px-4 py-2.5 rounded-lg font-medium text-sm transition-all capitalize ${adsTimeTab === tab ? (tab === 'weekly' ? 'bg-violet-600' : tab === 'monthly' ? 'bg-blue-600' : tab === 'quarterly' ? 'bg-teal-600' : 'bg-amber-600') + ' text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
                {tab}
              </button>
            ))}
          </div>
          
          {/* Selectors Row */}
          <div className="flex flex-wrap items-center gap-3 mb-6">
            <div className="flex items-center gap-2">
              <span className="text-slate-400 text-sm">Year:</span>
              <select value={adsYear} onChange={(e) => setAdsYear(parseInt(e.target.value))} className="bg-slate-800 border border-slate-600 rounded-lg px-3 py-1.5 text-white text-sm">
                {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
              </select>
            </div>
            
            {(adsTimeTab === 'monthly') && (
              <div className="flex items-center gap-2">
                <span className="text-slate-400 text-sm">Month:</span>
                <select value={adsMonth} onChange={(e) => setAdsMonth(parseInt(e.target.value))} className="bg-slate-800 border border-slate-600 rounded-lg px-3 py-1.5 text-white text-sm">
                  {monthNames.map((m, i) => <option key={i} value={i} disabled={!monthsWithData.includes(i)}>{m}</option>)}
                </select>
              </div>
            )}
            
            {adsTimeTab === 'quarterly' && (
              <div className="flex items-center gap-2">
                <span className="text-slate-400 text-sm">Quarter:</span>
                <select value={adsQuarter} onChange={(e) => setAdsQuarter(parseInt(e.target.value))} className="bg-slate-800 border border-slate-600 rounded-lg px-3 py-1.5 text-white text-sm">
                  {[1, 2, 3, 4].map(q => <option key={q} value={q}>Q{q}</option>)}
                </select>
              </div>
            )}
            
            <div className="flex items-center gap-1 ml-auto">
              <button onClick={goToPrev} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white"><ChevronLeft className="w-4 h-4" /></button>
              <button onClick={goToNext} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white"><ChevronRight className="w-4 h-4" /></button>
            </div>
          </div>
          
          {/* Period Header */}
          <div className="mb-4 flex items-center justify-between">
            <h2 className="text-xl font-bold text-white">{getPeriodLabel()}</h2>
            <span className="text-slate-400 text-sm">
              {useDailyData 
                ? `${periodDays.length} day${periodDays.length !== 1 ? 's' : ''}` 
                : `${periodWeeks.length} week${periodWeeks.length !== 1 ? 's' : ''}`}
            </span>
          </div>
          
          {/* KPI Cards */}
          {useDailyData ? (
            <>
            {/* Main KPI Row */}
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-4">
              <div className="bg-gradient-to-br from-purple-900/30 to-slate-800/50 rounded-xl border border-purple-500/30 p-4">
                <p className="text-slate-400 text-xs uppercase">Total Spend</p>
                <p className="text-2xl font-bold text-white">{formatCurrency(dailyTotals.totalAds)}</p>
                <p className="text-purple-400 text-xs mt-1">{periodDays.length} day{periodDays.length !== 1 ? 's' : ''}</p>
              </div>
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                <p className="text-slate-400 text-xs uppercase">Impressions</p>
                <p className="text-2xl font-bold text-white">{formatNumber(dailyTotals.totalImpressions)}</p>
              </div>
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                <p className="text-slate-400 text-xs uppercase">Clicks</p>
                <p className="text-2xl font-bold text-white">{formatNumber(dailyTotals.totalClicks)}</p>
                <p className="text-slate-500 text-xs mt-1">CTR: {ctr.toFixed(2)}%</p>
              </div>
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                <p className="text-slate-400 text-xs uppercase">Conversions</p>
                <p className="text-2xl font-bold text-white">{formatNumber(dailyTotals.googleConversions + dailyTotals.metaPurchases)}</p>
              </div>
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                <p className="text-slate-400 text-xs uppercase">Avg CPC</p>
                <p className={`text-2xl font-bold ${cpc < 1.50 ? 'text-emerald-400' : cpc < 2.50 ? 'text-amber-400' : 'text-rose-400'}`}>{formatCurrency(cpc)}</p>
              </div>
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                <p className="text-slate-400 text-xs uppercase">Revenue</p>
                <p className="text-2xl font-bold text-emerald-400">{formatCurrency(dailyTotals.totalRev)}</p>
                <p className="text-slate-500 text-xs mt-1">ROAS: {dailyTotals.totalAds > 0 ? (dailyTotals.totalRev / dailyTotals.totalAds).toFixed(2) : 'â€”'}x</p>
              </div>
            </div>
            
            {/* Platform Breakdown Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              {/* Google Ads Card */}
              <div className="bg-gradient-to-br from-red-900/20 to-slate-800/50 rounded-xl border border-red-500/30 p-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="text-red-400 font-semibold flex items-center gap-2">
                    <span className="w-3 h-3 rounded-full bg-red-500" />Google Ads
                  </h4>
                  <span className="text-white font-bold">{formatCurrency(dailyTotals.googleAds)}</span>
                </div>
                <div className="grid grid-cols-3 gap-2 text-xs">
                  <div><p className="text-slate-500">Impr</p><p className="text-white">{formatNumber(dailyTotals.googleImpressions)}</p></div>
                  <div><p className="text-slate-500">Clicks</p><p className="text-white">{formatNumber(dailyTotals.googleClicks)}</p></div>
                  <div><p className="text-slate-500">Conv</p><p className="text-emerald-400">{dailyTotals.googleConversions}</p></div>
                </div>
                {dailyTotals.googleAds > 0 && (
                  <div className="mt-2 pt-2 border-t border-slate-700/50 flex justify-between text-xs">
                    <span className="text-slate-500">CPC: {formatCurrency(dailyTotals.googleClicks > 0 ? dailyTotals.googleAds / dailyTotals.googleClicks : 0)}</span>
                    <span className="text-slate-500">CPA: {formatCurrency(dailyTotals.googleConversions > 0 ? dailyTotals.googleAds / dailyTotals.googleConversions : 0)}</span>
                  </div>
                )}
              </div>
              
              {/* Meta Ads Card */}
              <div className="bg-gradient-to-br from-blue-900/20 to-slate-800/50 rounded-xl border border-blue-500/30 p-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="text-blue-400 font-semibold flex items-center gap-2">
                    <span className="w-3 h-3 rounded-full bg-blue-500" />Meta Ads
                  </h4>
                  <span className="text-white font-bold">{formatCurrency(dailyTotals.metaAds)}</span>
                </div>
                <div className="grid grid-cols-3 gap-2 text-xs">
                  <div><p className="text-slate-500">Impr</p><p className="text-white">{formatNumber(dailyTotals.metaImpressions)}</p></div>
                  <div><p className="text-slate-500">Clicks</p><p className="text-white">{formatNumber(dailyTotals.metaClicks)}</p></div>
                  <div><p className="text-slate-500">Purchases</p><p className="text-emerald-400">{dailyTotals.metaPurchases}</p></div>
                </div>
                {dailyTotals.metaAds > 0 && (
                  <div className="mt-2 pt-2 border-t border-slate-700/50 flex justify-between text-xs">
                    <span className="text-slate-500">ROAS: {dailyTotals.metaPurchaseValue > 0 ? (dailyTotals.metaPurchaseValue / dailyTotals.metaAds).toFixed(2) : 'â€”'}x</span>
                    <span className="text-emerald-400">Sales: {formatCurrency(dailyTotals.metaPurchaseValue)}</span>
                  </div>
                )}
              </div>
              
              {/* Amazon Ads Card */}
              <div className="bg-gradient-to-br from-orange-900/20 to-slate-800/50 rounded-xl border border-orange-500/30 p-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="text-orange-400 font-semibold flex items-center gap-2">
                    <span className="w-3 h-3 rounded-full bg-orange-500" />Amazon PPC
                  </h4>
                  <span className="text-white font-bold">{formatCurrency(dailyTotals.amazonAds)}</span>
                </div>
                <div className="grid grid-cols-3 gap-2 text-xs">
                  <div><p className="text-slate-500">Revenue</p><p className="text-white">{formatCurrency(dailyTotals.amazonRev)}</p></div>
                  <div><p className="text-slate-500">ACOS</p><p className={`${dailyTotals.amazonRev > 0 ? (dailyTotals.amazonAds / dailyTotals.amazonRev * 100 <= 25 ? 'text-emerald-400' : 'text-amber-400') : 'text-slate-500'}`}>{dailyTotals.amazonRev > 0 ? (dailyTotals.amazonAds / dailyTotals.amazonRev * 100).toFixed(1) + '%' : 'â€”'}</p></div>
                  <div><p className="text-slate-500">ROAS</p><p className={`${dailyTotals.amazonAds > 0 ? (dailyTotals.amazonRev / dailyTotals.amazonAds >= 3 ? 'text-emerald-400' : 'text-amber-400') : 'text-slate-500'}`}>{dailyTotals.amazonAds > 0 ? (dailyTotals.amazonRev / dailyTotals.amazonAds).toFixed(2) + 'x' : 'â€”'}</p></div>
                </div>
                {!dailyTotals.amazonAds && (
                  <p className="mt-2 text-slate-500 text-xs">Amazon ads data coming soon</p>
                )}
              </div>
            </div>
            </>
          ) : (
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <div className="bg-gradient-to-br from-purple-900/30 to-slate-800/50 rounded-xl border border-purple-500/30 p-4">
                <p className="text-slate-400 text-sm">Total Ad Spend</p>
                <p className="text-2xl font-bold text-white">{formatCurrency(totals.totalAds)}</p>
                {spendChange !== null && <p className={`text-xs flex items-center gap-1 mt-1 ${spendChange <= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{spendChange >= 0 ? <ArrowUpRight className="w-3 h-3" /> : <ArrowDownRight className="w-3 h-3" />}{Math.abs(spendChange).toFixed(1)}% {getCompLabel()}</p>}
              </div>
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                <p className="text-slate-400 text-sm">Overall TACOS</p>
                <p className={`text-2xl font-bold ${tacosColor(totalTacos)}`}>{totalTacos > 0 ? totalTacos.toFixed(1) : 'â€”'}%</p>
              </div>
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                <p className="text-slate-400 text-sm">Amazon TACOS</p>
                <p className={`text-2xl font-bold ${tacosColor(amzTacos)}`}>{amzTacos > 0 ? amzTacos.toFixed(1) : 'â€”'}%</p>
                <p className="text-orange-400 text-xs mt-1">{formatCurrency(totals.amzAds)} spent</p>
              </div>
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                <p className="text-slate-400 text-sm">Shopify TACOS</p>
                <p className={`text-2xl font-bold ${tacosColor(shopTacos)}`}>{shopTacos > 0 ? shopTacos.toFixed(1) : 'â€”'}%</p>
                <p className="text-blue-400 text-xs mt-1">{formatCurrency(shopifyAds)} spent</p>
              </div>
            </div>
          )}
          
          {/* Channel Breakdown (non-daily) */}
          {adsTimeTab !== 'daily' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                <h3 className="text-lg font-semibold text-white mb-4">Shopify Ad Spend</h3>
                <div className="space-y-3">
                  <div className="flex justify-between items-center"><span className="text-red-400 flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-red-500" />Google Ads</span><span className="text-white font-semibold">{formatCurrency(totals.googleAds)}</span></div>
                  <div className="h-2 bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-red-500" style={{ width: `${shopifyAds > 0 ? (totals.googleAds / shopifyAds) * 100 : 0}%` }} /></div>
                  <div className="flex justify-between items-center"><span className="text-blue-400 flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-blue-500" />Meta Ads</span><span className="text-white font-semibold">{formatCurrency(totals.metaAds)}</span></div>
                  <div className="h-2 bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-blue-500" style={{ width: `${shopifyAds > 0 ? (totals.metaAds / shopifyAds) * 100 : 0}%` }} /></div>
                  <div className="pt-3 border-t border-slate-700 flex justify-between"><span className="text-slate-400">Total</span><span className="text-white font-bold">{formatCurrency(shopifyAds)}</span></div>
                </div>
              </div>
              <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                <h3 className="text-lg font-semibold text-white mb-4">Amazon PPC</h3>
                <div className="space-y-3">
                  <div className="flex justify-between items-center"><span className="text-orange-400">Ad Spend</span><span className="text-white font-semibold">{formatCurrency(totals.amzAds)}</span></div>
                  <div className="flex justify-between items-center"><span className="text-slate-400">Revenue</span><span className="text-white">{formatCurrency(totals.amzRev)}</span></div>
                  <div className="flex justify-between items-center"><span className="text-slate-400">ACOS</span><span className={`font-semibold ${tacosColor(amzTacos)}`}>{amzTacos > 0 ? amzTacos.toFixed(1) : 'â€”'}%</span></div>
                </div>
              </div>
            </div>
          )}
          
          {/* Daily Table */}
          {useDailyData && dailyTableData.length > 0 && (
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-white">{adsTimeTab === 'daily' ? 'Daily Details' : 'Last 7 Days Breakdown'}</h3>
                <button onClick={() => setShowAdsBulkUpload(true)} className="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 rounded-lg text-sm text-white flex items-center gap-1">
                  <Upload className="w-4 h-4" />Import Ads
                </button>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead><tr className="border-b border-slate-700">
                    <th className="text-left text-slate-400 py-2">Date</th>
                    <th className="text-right text-slate-400 py-2">Google</th>
                    <th className="text-right text-slate-400 py-2">Meta</th>
                    <th className="text-right text-slate-400 py-2">Amazon</th>
                    <th className="text-right text-slate-400 py-2">Total</th>
                    <th className="text-right text-slate-400 py-2">Impr</th>
                    <th className="text-right text-slate-400 py-2">Clicks</th>
                    <th className="text-right text-slate-400 py-2">Conv</th>
                    <th className="text-right text-slate-400 py-2">Revenue</th>
                    <th className="text-right text-slate-400 py-2">ROAS</th>
                  </tr></thead>
                  <tbody>
                    {dailyTableData.slice().reverse().map(d => {
                      const roas = d.totalAds > 0 ? d.totalRev / d.totalAds : 0;
                      return (
                      <tr key={d.date} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                        <td className="py-2 text-white">{new Date(d.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</td>
                        <td className="py-2 text-right text-red-400">{formatCurrency(d.googleAds)}</td>
                        <td className="py-2 text-right text-blue-400">{formatCurrency(d.metaAds)}</td>
                        <td className="py-2 text-right text-orange-400">{formatCurrency(d.amazonAds)}</td>
                        <td className="py-2 text-right text-white font-medium">{formatCurrency(d.totalAds)}</td>
                        <td className="py-2 text-right text-slate-400">{formatNumber(d.impressions)}</td>
                        <td className="py-2 text-right text-slate-300">{formatNumber(d.clicks)}</td>
                        <td className="py-2 text-right text-emerald-400">{d.conversions}</td>
                        <td className="py-2 text-right text-white">{formatCurrency(d.totalRev)}</td>
                        <td className={`py-2 text-right font-medium ${roas >= 3 ? 'text-emerald-400' : roas >= 2 ? 'text-amber-400' : roas > 0 ? 'text-rose-400' : 'text-slate-500'}`}>{roas > 0 ? roas.toFixed(2) + 'x' : 'â€”'}</td>
                      </tr>
                    );})}
                  </tbody>
                  <tfoot><tr className="border-t-2 border-slate-600 font-semibold">
                    <td className="py-2 text-white">Total</td>
                    <td className="py-2 text-right text-red-400">{formatCurrency(dailyTotals.googleAds)}</td>
                    <td className="py-2 text-right text-blue-400">{formatCurrency(dailyTotals.metaAds)}</td>
                    <td className="py-2 text-right text-orange-400">{formatCurrency(dailyTotals.amazonAds)}</td>
                    <td className="py-2 text-right text-white">{formatCurrency(dailyTotals.totalAds)}</td>
                    <td className="py-2 text-right text-slate-400">{formatNumber(dailyTotals.totalImpressions)}</td>
                    <td className="py-2 text-right text-slate-300">{formatNumber(dailyTotals.totalClicks)}</td>
                    <td className="py-2 text-right text-emerald-400">{dailyTotals.googleConversions + dailyTotals.metaPurchases}</td>
                    <td className="py-2 text-right text-white">{formatCurrency(dailyTotals.totalRev)}</td>
                    <td className={`py-2 text-right font-medium ${dailyTotals.totalAds > 0 && dailyTotals.totalRev / dailyTotals.totalAds >= 3 ? 'text-emerald-400' : 'text-amber-400'}`}>{dailyTotals.totalAds > 0 ? (dailyTotals.totalRev / dailyTotals.totalAds).toFixed(2) + 'x' : 'â€”'}</td>
                  </tr></tfoot>
                </table>
              </div>
            </div>
          )}
          
          {/* Weekly Table (for monthly/quarterly/yearly) */}
          {!useDailyData && weeklyTableData.length > 0 && (
            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
              <h3 className="text-lg font-semibold text-white mb-4">Weekly Breakdown</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead><tr className="border-b border-slate-700"><th className="text-left text-slate-400 py-2">Week Ending</th><th className="text-right text-slate-400 py-2">Amazon</th><th className="text-right text-slate-400 py-2">Google</th><th className="text-right text-slate-400 py-2">Meta</th><th className="text-right text-slate-400 py-2">Total Ads</th><th className="text-right text-slate-400 py-2">Revenue</th><th className="text-right text-slate-400 py-2">TACOS</th></tr></thead>
                  <tbody>
                    {weeklyTableData.slice().reverse().map(w => (
                      <tr key={w.week} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                        <td className="py-2 text-white">{new Date(w.week + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td className="py-2 text-right text-orange-400">{formatCurrency(w.amzAds)}</td>
                        <td className="py-2 text-right text-red-400">{formatCurrency(w.googleAds)}</td>
                        <td className="py-2 text-right text-blue-400">{formatCurrency(w.metaAds)}</td>
                        <td className="py-2 text-right text-white font-medium">{formatCurrency(w.totalAds)}</td>
                        <td className="py-2 text-right text-white">{formatCurrency(w.totalRev)}</td>
                        <td className={`py-2 text-right font-semibold ${tacosColor(w.tacos)}`}>{w.tacos > 0 ? w.tacos.toFixed(1) : 'â€”'}%</td>
                      </tr>
                    ))}
                  </tbody>
                  <tfoot><tr className="border-t-2 border-slate-600 font-semibold"><td className="py-2 text-white">Total</td><td className="py-2 text-right text-orange-400">{formatCurrency(totals.amzAds)}</td><td className="py-2 text-right text-red-400">{formatCurrency(totals.googleAds)}</td><td className="py-2 text-right text-blue-400">{formatCurrency(totals.metaAds)}</td><td className="py-2 text-right text-white">{formatCurrency(totals.totalAds)}</td><td className="py-2 text-right text-white">{formatCurrency(totals.totalRev)}</td><td className={`py-2 text-right ${tacosColor(totalTacos)}`}>{totalTacos > 0 ? totalTacos.toFixed(1) : 'â€”'}%</td></tr></tfoot>
                </table>
              </div>
            </div>
          )}
          
          {/* Empty state */}
          {((useDailyData && dailyTableData.length === 0) || (!useDailyData && weeklyTableData.length === 0)) && (
            <div className="text-center py-12 bg-slate-800/30 rounded-2xl border border-slate-700">
              <DollarSign className="w-12 h-12 text-slate-600 mx-auto mb-4" />
              <p className="text-slate-400 mb-4">No ad data for {getPeriodLabel()}</p>
              <button onClick={() => setShowAdsBulkUpload(true)} className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white flex items-center gap-2 mx-auto">
                <Upload className="w-4 h-4" />Upload Ad Spend Data
              </button>
            </div>
          )}
            </>
          )}
        </div>
      </div>
    );
  }

  // ==================== SALES TAX VIEW ====================
  if (view === 'sales-tax') {
    const { nexusStates, filingHistory, hiddenStates } = salesTaxConfig;
    
    // Get states with nexus sorted by next due date
    const nexusStatesList = Object.entries(nexusStates || {})
      .filter(([code, config]) => config.hasNexus)
      .map(([code, config]) => ({
        code,
        ...US_STATES_TAX_INFO[code],
        ...config,
        nextDue: getNextDueDate(config.frequency || 'monthly', code)
      }))
      .sort((a, b) => a.nextDue - b.nextDue);
    
    // Calculate upcoming due items
    const now = new Date();
    const sevenDays = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    const thirtyDays = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
    
    const overdue = nexusStatesList.filter(s => s.nextDue < now);
    const dueSoon = nexusStatesList.filter(s => s.nextDue >= now && s.nextDue <= sevenDays);
    const upcoming = nexusStatesList.filter(s => s.nextDue > sevenDays && s.nextDue <= thirtyDays);
    
    // Handle tax report file upload
    const handleTaxReportUpload = (file, stateCode) => {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = parseCSV(e.target.result);
        const parsed = parseShopifyTaxReport(data, stateCode);
        setParsedTaxReport(parsed);
        setTaxReportFileName(file.name);
      };
      reader.readAsText(file);
    };
    
    // Toggle nexus for a state
    const toggleNexus = (stateCode) => {
      const updated = { ...salesTaxConfig };
      if (!updated.nexusStates) updated.nexusStates = {};
      if (!updated.nexusStates[stateCode]) {
        updated.nexusStates[stateCode] = { hasNexus: true, frequency: 'monthly', registrationId: '', customFilings: [], notes: '' };
      } else {
        updated.nexusStates[stateCode].hasNexus = !updated.nexusStates[stateCode].hasNexus;
      }
      saveSalesTax(updated);
    };
    
    // Toggle hidden state
    const toggleHideState = (stateCode) => {
      const updated = { ...salesTaxConfig };
      if (!updated.hiddenStates) updated.hiddenStates = [];
      if (updated.hiddenStates.includes(stateCode)) {
        updated.hiddenStates = updated.hiddenStates.filter(s => s !== stateCode);
      } else {
        updated.hiddenStates = [...updated.hiddenStates, stateCode];
      }
      saveSalesTax(updated);
    };
    
    // Update state config
    const updateStateConfig = (stateCode, field, value) => {
      const updated = { ...salesTaxConfig };
      if (!updated.nexusStates) updated.nexusStates = {};
      if (!updated.nexusStates[stateCode]) {
        updated.nexusStates[stateCode] = { hasNexus: false, frequency: 'monthly', registrationId: '', customFilings: [], notes: '' };
      }
      updated.nexusStates[stateCode][field] = value;
      saveSalesTax(updated);
    };
    
    // Add custom filing to a state
    const addCustomFiling = (stateCode, filing) => {
      const updated = { ...salesTaxConfig };
      if (!updated.nexusStates[stateCode].customFilings) {
        updated.nexusStates[stateCode].customFilings = [];
      }
      updated.nexusStates[stateCode].customFilings.push(filing);
      saveSalesTax(updated);
    };
    
    // Remove custom filing
    const removeCustomFiling = (stateCode, index) => {
      const updated = { ...salesTaxConfig };
      updated.nexusStates[stateCode].customFilings.splice(index, 1);
      saveSalesTax(updated);
    };
    
    // Mark filing as complete
    const markFilingComplete = (stateCode, periodKey, data) => {
      const updated = { ...salesTaxConfig };
      if (!updated.filingHistory[stateCode]) {
        updated.filingHistory[stateCode] = {};
      }
      updated.filingHistory[stateCode][periodKey] = {
        filed: true,
        filedDate: new Date().toISOString(),
        ...data
      };
      saveSalesTax(updated);
      setParsedTaxReport(null);
      setTaxReportFileName('');
    };
    
    // State configuration modal
    const StateConfigModal = () => {
      if (!showTaxStateConfig || !taxConfigState) return null;
      const stateInfo = US_STATES_TAX_INFO[taxConfigState];
      const config = (nexusStates || {})[taxConfigState] || { hasNexus: false, frequency: 'monthly', registrationId: '', customFilings: [], notes: '' };
      
      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-2xl w-full my-8">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-xl font-bold text-white">{stateInfo?.name || taxConfigState}</h2>
                <p className="text-slate-400 text-sm">Configure sales tax settings</p>
              </div>
              <button onClick={() => { setShowTaxStateConfig(false); setTaxConfigState(null); }} className="p-2 hover:bg-slate-700 rounded-lg"><Trash2 className="w-5 h-5 text-slate-400" /></button>
            </div>
            
            {/* Basic Info */}
            <div className="space-y-4 mb-6">
              <div className="flex items-center justify-between p-3 bg-slate-900/50 rounded-xl">
                <span className="text-white">Nexus Established</span>
                <button onClick={() => toggleNexus(taxConfigState)} className={`w-12 h-6 rounded-full transition-all ${config.hasNexus ? 'bg-emerald-500' : 'bg-slate-600'}`}>
                  <div className={`w-5 h-5 bg-white rounded-full transition-transform ${config.hasNexus ? 'translate-x-6' : 'translate-x-0.5'}`} />
                </button>
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 mb-2">Filing Frequency</label>
                <select value={config.frequency || 'monthly'} onChange={(e) => updateStateConfig(taxConfigState, 'frequency', e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white">
                  <option value="monthly">Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="semi-annual">Semi-Annual</option>
                  <option value="annual">Annual</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 mb-2">State Registration / Account ID</label>
                <input type="text" value={taxFormRegistrationId} onChange={(e) => setTaxFormRegistrationId(e.target.value)} onBlur={(e) => updateStateConfig(taxConfigState, 'registrationId', e.target.value)} placeholder="e.g., 12-345678-9" className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white" />
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 mb-2">Tax Portal URL</label>
                <div className="flex gap-2">
                  <input 
                    type="url" 
                    defaultValue={config.portalUrl || STATE_FILING_FORMATS[taxConfigState]?.website || ''} 
                    onBlur={(e) => updateStateConfig(taxConfigState, 'portalUrl', e.target.value)} 
                    placeholder="https://state-tax-portal.gov..." 
                    className="flex-1 bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white" 
                  />
                  {(config.portalUrl || STATE_FILING_FORMATS[taxConfigState]?.website) && (
                    <button
                      onClick={() => window.open(config.portalUrl || STATE_FILING_FORMATS[taxConfigState]?.website, '_blank')}
                      className="px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl text-white font-medium"
                    >
                      ðŸ”— Open
                    </button>
                  )}
                </div>
                <p className="text-xs text-slate-500 mt-1">Add your custom login URL or use the default state portal</p>
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 mb-2">Notes</label>
                <textarea value={taxFormNotes} onChange={(e) => setTaxFormNotes(e.target.value)} onBlur={(e) => updateStateConfig(taxConfigState, 'notes', e.target.value)} placeholder="Any notes about this state's requirements..." rows={2} className="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white" />
              </div>
            </div>
            
            {/* State Info */}
            {stateInfo && (
              <div className="bg-slate-900/50 rounded-xl p-4 mb-6">
                <h4 className="text-sm font-semibold text-slate-300 mb-3">State Tax Information</h4>
                <div className="grid grid-cols-2 gap-3 text-sm mb-3">
                  <div className="bg-slate-800/50 rounded-lg p-2">
                    <span className="text-slate-500 text-xs">Base State Rate</span>
                    <p className="text-white font-semibold">{(stateInfo.stateRate * 100).toFixed(2)}%</p>
                  </div>
                  <div className="bg-slate-800/50 rounded-lg p-2">
                    <span className="text-slate-500 text-xs">Filing Types</span>
                    <p className="text-white font-semibold capitalize">{stateInfo.filingTypes?.join(', ') || 'N/A'}</p>
                  </div>
                </div>
                
                {/* Economic Nexus Thresholds */}
                {stateInfo.nexusThreshold && (
                  <div className="bg-violet-900/20 border border-violet-500/30 rounded-lg p-3 mb-3">
                    <h5 className="text-violet-400 text-xs font-semibold mb-2">Economic Nexus Threshold</h5>
                    <div className="flex gap-4 text-sm">
                      {stateInfo.nexusThreshold.sales && (
                        <div>
                          <span className="text-slate-400">Sales:</span>
                          <span className="text-white ml-1 font-semibold">{formatCurrency(stateInfo.nexusThreshold.sales)}</span>
                        </div>
                      )}
                      {stateInfo.nexusThreshold.transactions && (
                        <div>
                          <span className="text-slate-400">Transactions:</span>
                          <span className="text-white ml-1 font-semibold">{stateInfo.nexusThreshold.transactions}+</span>
                        </div>
                      )}
                    </div>
                  </div>
                )}
                
                {/* Features */}
                <div className="flex flex-wrap gap-2 mb-2">
                  {stateInfo.marketplaceFacilitator && (
                    <span className="px-2 py-1 bg-emerald-900/30 border border-emerald-500/30 rounded text-xs text-emerald-400">Marketplace Facilitator Law</span>
                  )}
                  {stateInfo.sst && (
                    <span className="px-2 py-1 bg-blue-900/30 border border-blue-500/30 rounded text-xs text-blue-400">SST Member</span>
                  )}
                </div>
                
                {stateInfo.note && (
                  <div className="flex items-start gap-2 text-amber-400 text-xs mt-2">
                    <AlertTriangle className="w-4 h-4 flex-shrink-0 mt-0.5" />
                    <span>{stateInfo.note}</span>
                  </div>
                )}
              </div>
            )}
            
            {/* Custom Filings */}
            <div className="mb-6">
              <h4 className="text-sm font-semibold text-slate-300 mb-3">Additional Filings (LLC Fees, Annual Reports, etc.)</h4>
              
              {config.customFilings?.length > 0 && (
                <div className="space-y-2 mb-4">
                  {config.customFilings.map((f, i) => (
                    <div key={i} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg">
                      <div>
                        <span className="text-white">{f.name}</span>
                        <span className="text-slate-500 text-sm ml-2">({f.frequency}, due {f.dueMonth}/{f.dueDay})</span>
                        {f.amount && <span className="text-emerald-400 text-sm ml-2">{formatCurrency(parseFloat(f.amount))}</span>}
                      </div>
                      <button onClick={() => removeCustomFiling(taxConfigState, i)} className="text-rose-400 hover:text-rose-300"><Trash2 className="w-4 h-4" /></button>
                    </div>
                  ))}
                </div>
              )}
              
              <div className="grid grid-cols-2 gap-3 mb-3">
                <input type="text" value={newCustomFiling.name} onChange={(e) => setNewCustomFiling(p => ({ ...p, name: e.target.value }))} placeholder="Filing name (e.g., LLC Annual Fee)" className="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm" />
                <select value={newCustomFiling.frequency} onChange={(e) => setNewCustomFiling(p => ({ ...p, frequency: e.target.value }))} className="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm">
                  <option value="annual">Annual</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="monthly">Monthly</option>
                </select>
                <div className="flex gap-2">
                  <input type="number" value={newCustomFiling.dueMonth} onChange={(e) => setNewCustomFiling(p => ({ ...p, dueMonth: e.target.value }))} placeholder="Month" min="1" max="12" className="w-1/2 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm" />
                  <input type="number" value={newCustomFiling.dueDay} onChange={(e) => setNewCustomFiling(p => ({ ...p, dueDay: e.target.value }))} placeholder="Day" min="1" max="31" className="w-1/2 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm" />
                </div>
                <input type="number" value={newCustomFiling.amount} onChange={(e) => setNewCustomFiling(p => ({ ...p, amount: e.target.value }))} placeholder="Amount ($)" className="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm" />
              </div>
              <button onClick={() => { if (newCustomFiling.name) { addCustomFiling(taxConfigState, newCustomFiling); setNewCustomFiling({ name: '', frequency: 'annual', dueMonth: 0, dueDay: 15, amount: '' }); }}} disabled={!newCustomFiling.name} className="w-full py-2 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 rounded-lg text-sm text-white">Add Filing</button>
            </div>
            
            <div className="flex gap-3">
              <button onClick={() => toggleHideState(taxConfigState)} className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white">{hiddenStates.includes(taxConfigState) ? 'Unhide State' : 'Hide State'}</button>
              <button onClick={() => { setShowTaxStateConfig(false); setTaxConfigState(null); }} className="flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-sm text-white font-semibold">Done</button>
            </div>
          </div>
        </div>
      );
    };
    
    // Filing detail modal with report upload
    const FilingDetailModal = () => {
      if (!selectedTaxState) return null;
      const stateInfo = US_STATES_TAX_INFO[selectedTaxState];
      const config = (nexusStates || {})[selectedTaxState] || {};
      const nextDue = getNextDueDate(config.frequency || 'monthly', selectedTaxState);
      const periodKey = config.frequency === 'monthly' 
        ? `${nextDue.getFullYear()}-${String(nextDue.getMonth()).padStart(2, '0')}`
        : config.frequency === 'quarterly'
        ? `${nextDue.getFullYear()}-Q${Math.ceil((nextDue.getMonth() + 1) / 3)}`
        : `${nextDue.getFullYear()}`;
      
      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-xl font-bold text-white">{stateInfo?.name} - Sales Tax Filing</h2>
                <p className="text-slate-400 text-sm">Due: {nextDue.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
              </div>
              <button onClick={() => { setSelectedTaxState(null); setParsedTaxReport(null); setTaxReportFileName(''); }} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400">âœ•</button>
            </div>
            
            {/* Upload Tax Report */}
            <div className="mb-6">
              <h3 className="text-sm font-semibold text-slate-300 mb-3">Upload Shopify Tax Report</h3>
              <div className={`relative border-2 border-dashed rounded-xl p-6 ${taxReportFileName ? 'border-emerald-500/50 bg-emerald-950/20' : 'border-slate-600 hover:border-slate-500 bg-slate-800/30'}`}>
                <input type="file" accept=".csv" onChange={(e) => handleTaxReportUpload(e.target.files[0], selectedTaxState)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                <div className="text-center">
                  {taxReportFileName ? (
                    <><Check className="w-8 h-8 text-emerald-400 mx-auto mb-2" /><p className="text-emerald-400">{taxReportFileName}</p></>
                  ) : (
                    <><Upload className="w-8 h-8 text-slate-400 mx-auto mb-2" /><p className="text-slate-400">Drop Shopify tax report CSV or click to upload</p><p className="text-slate-500 text-xs mt-1">Analytics â†’ Reports â†’ Taxes â†’ Export by jurisdiction</p></>
                  )}
                </div>
              </div>
            </div>
            
            {/* Parsed Report */}
            {parsedTaxReport && (
              <div className="mb-6">
                <h3 className="text-sm font-semibold text-slate-300 mb-3">Tax Report Summary</h3>
                
                {/* Summary Cards */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                  <div className="bg-slate-900/50 rounded-xl p-4">
                    <p className="text-slate-400 text-xs">Total Sales</p>
                    <p className="text-xl font-bold text-white">{formatCurrency(parsedTaxReport.totalSales)}</p>
                  </div>
                  <div className="bg-slate-900/50 rounded-xl p-4">
                    <p className="text-slate-400 text-xs">Taxable Sales</p>
                    <p className="text-xl font-bold text-emerald-400">{formatCurrency(parsedTaxReport.totalTaxableSales)}</p>
                  </div>
                  <div className="bg-slate-900/50 rounded-xl p-4">
                    <p className="text-slate-400 text-xs">Exempt Sales</p>
                    <p className="text-xl font-bold text-slate-300">{formatCurrency(parsedTaxReport.totalExemptSales)}</p>
                  </div>
                  <div className="bg-rose-900/30 border border-rose-500/30 rounded-xl p-4">
                    <p className="text-rose-400 text-xs">Tax Collected</p>
                    <p className="text-xl font-bold text-white">{formatCurrency(parsedTaxReport.totalTaxCollected)}</p>
                  </div>
                </div>
                
                {/* Tax Breakdown by Type */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                  <div className="bg-violet-900/20 border border-violet-500/30 rounded-lg p-3">
                    <p className="text-violet-400 text-xs">State Tax</p>
                    <p className="text-lg font-semibold text-white">{formatCurrency(parsedTaxReport.stateTax)}</p>
                  </div>
                  <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3">
                    <p className="text-blue-400 text-xs">County Tax</p>
                    <p className="text-lg font-semibold text-white">{formatCurrency(parsedTaxReport.countyTax)}</p>
                  </div>
                  <div className="bg-teal-900/20 border border-teal-500/30 rounded-lg p-3">
                    <p className="text-teal-400 text-xs">City Tax</p>
                    <p className="text-lg font-semibold text-white">{formatCurrency(parsedTaxReport.cityTax)}</p>
                  </div>
                  <div className="bg-amber-900/20 border border-amber-500/30 rounded-lg p-3">
                    <p className="text-amber-400 text-xs">Special Tax</p>
                    <p className="text-lg font-semibold text-white">{formatCurrency(parsedTaxReport.specialTax)}</p>
                  </div>
                </div>
                
                {/* Jurisdiction Details */}
                <div className="bg-slate-900/50 rounded-xl overflow-hidden">
                  <div className="p-3 border-b border-slate-700">
                    <h4 className="text-sm font-semibold text-slate-300">Jurisdiction Breakdown</h4>
                  </div>
                  <div className="max-h-64 overflow-y-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-800 sticky top-0">
                        <tr>
                          <th className="text-left p-2 text-slate-400">Jurisdiction</th>
                          <th className="text-left p-2 text-slate-400">Type</th>
                          <th className="text-right p-2 text-slate-400">Rate</th>
                          <th className="text-right p-2 text-slate-400">Taxable</th>
                          <th className="text-right p-2 text-slate-400">Tax Due</th>
                        </tr>
                      </thead>
                      <tbody>
                        {parsedTaxReport.jurisdictions.map((j, i) => (
                          <tr key={i} className="border-b border-slate-700/50">
                            <td className="p-2 text-white">{j.name}{j.county && <span className="text-slate-500 text-xs ml-1">({j.county})</span>}</td>
                            <td className="p-2 capitalize text-slate-400">{j.type}</td>
                            <td className="p-2 text-right text-slate-300">{(j.rate * 100).toFixed(3)}%</td>
                            <td className="p-2 text-right text-slate-300">{formatCurrency(j.taxableSales)}</td>
                            <td className="p-2 text-right font-semibold text-emerald-400">{formatCurrency(j.taxAmount)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}
            
            {/* Filing Confirmation */}
            <div className="border-t border-slate-700 pt-6">
              <h3 className="text-sm font-semibold text-slate-300 mb-3">Mark as Filed</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <label className="block text-xs text-slate-400 mb-1">Confirmation Number</label>
                  <input type="text" value={taxFilingConfirmNum} onChange={(e) => setTaxFilingConfirmNum(e.target.value)} placeholder="State confirmation #" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm" />
                </div>
                <div>
                  <label className="block text-xs text-slate-400 mb-1">Amount Paid</label>
                  <input type="number" value={taxFilingPaidAmount} onChange={(e) => setTaxFilingPaidAmount(e.target.value)} placeholder={parsedTaxReport ? parsedTaxReport.totalTaxCollected.toFixed(2) : '0.00'} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm" />
                </div>
                <div>
                  <label className="block text-xs text-slate-400 mb-1">Notes</label>
                  <input type="text" value={taxFilingNotes} onChange={(e) => setTaxFilingNotes(e.target.value)} placeholder="Any notes..." className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm" />
                </div>
              </div>
              <button 
                onClick={() => markFilingComplete(selectedTaxState, periodKey, { 
                  confirmationNum: taxFilingConfirmNum, 
                  amount: parseFloat(taxFilingPaidAmount) || parsedTaxReport?.totalTaxCollected || 0,
                  notes: taxFilingNotes,
                  reportData: parsedTaxReport 
                })}
                className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-semibold text-white"
              >
                <Check className="w-5 h-5 inline mr-2" />Mark as Filed & Paid
              </button>
            </div>
          </div>
        </div>
      );
    };
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-7xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal /><StateConfigModal /><FilingDetailModal />
          
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <div>
              <h1 className="text-2xl lg:text-3xl font-bold text-white">Sales Tax Management</h1>
              <p className="text-slate-400">Track nexus, filings, and compliance across states</p>
            </div>
            <div className="flex items-center gap-3">
              <span className="text-slate-400 text-sm">{Object.values(nexusStates).filter(s => s.hasNexus).length} states with nexus</span>
            </div>
          </div>
          
          <NavTabs />
          
          {/* Alerts */}
          {(overdue.length > 0 || dueSoon.length > 0) && (
            <div className="mb-6 space-y-2">
              {overdue.map(s => (
                <div key={s.code} className="flex items-center justify-between p-3 bg-rose-900/30 border border-rose-500/50 rounded-xl">
                  <div className="flex items-center gap-3">
                    <AlertTriangle className="w-5 h-5 text-rose-400" />
                    <span className="text-rose-300"><strong>{s.name}</strong> filing is overdue! Was due {s.nextDue.toLocaleDateString()}</span>
                  </div>
                  <button onClick={() => setSelectedTaxState(s.code)} className="px-3 py-1 bg-rose-600 hover:bg-rose-500 rounded-lg text-sm text-white">File Now</button>
                </div>
              ))}
              {dueSoon.map(s => (
                <div key={s.code} className="flex items-center justify-between p-3 bg-amber-900/30 border border-amber-500/50 rounded-xl">
                  <div className="flex items-center gap-3">
                    <Clock className="w-5 h-5 text-amber-400" />
                    <span className="text-amber-300"><strong>{s.name}</strong> due in {Math.ceil((s.nextDue - now) / (1000 * 60 * 60 * 24))} days ({s.nextDue.toLocaleDateString()})</span>
                  </div>
                  <button onClick={() => setSelectedTaxState(s.code)} className="px-3 py-1 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm text-white">File</button>
                </div>
              ))}
            </div>
          )}
          
          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
              <p className="text-slate-400 text-sm">States with Nexus</p>
              <p className="text-3xl font-bold text-white">{nexusStatesList.length}</p>
            </div>
            <div className="bg-rose-900/20 border border-rose-500/30 rounded-2xl p-5">
              <p className="text-rose-400 text-sm">Overdue</p>
              <p className="text-3xl font-bold text-rose-400">{overdue.length}</p>
            </div>
            <div className="bg-amber-900/20 border border-amber-500/30 rounded-2xl p-5">
              <p className="text-amber-400 text-sm">Due Within 7 Days</p>
              <p className="text-3xl font-bold text-amber-400">{dueSoon.length}</p>
            </div>
            <div className="bg-emerald-900/20 border border-emerald-500/30 rounded-2xl p-5">
              <p className="text-emerald-400 text-sm">Upcoming (30 days)</p>
              <p className="text-3xl font-bold text-emerald-400">{upcoming.length}</p>
            </div>
          </div>
          
          {/* Shopify Tax Calculator */}
          {(() => {
            // Calculate date range based on period selection
            const getDateRange = () => {
              const [year, periodNum] = taxPeriodValue.split('-').map(Number);
              let start, end;
              
              if (taxPeriodType === 'month') {
                start = new Date(year, periodNum - 1, 1);
                end = new Date(year, periodNum, 0);
              } else if (taxPeriodType === 'quarter') {
                const quarterStart = (periodNum - 1) * 3;
                start = new Date(year, quarterStart, 1);
                end = new Date(year, quarterStart + 3, 0);
              } else if (taxPeriodType === 'semiannual') {
                const halfStart = (periodNum - 1) * 6;
                start = new Date(year, halfStart, 1);
                end = new Date(year, halfStart + 6, 0);
              } else { // annual
                start = new Date(year, 0, 1);
                end = new Date(year, 11, 31);
              }
              
              return { start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] };
            };
            
            // Aggregate tax by state from daily data
            const calculateTaxByState = () => {
              const { start, end } = getDateRange();
              const taxByStateMap = {};
              let totalTax = 0;
              let shopPayExcluded = 0;
              let daysWithData = 0;
              
              Object.entries(allDaysData).forEach(([dateKey, dayData]) => {
                if (dateKey >= start && dateKey <= end && dayData.shopify?.taxByState) {
                  daysWithData++;
                  Object.entries(dayData.shopify.taxByState).forEach(([stateCode, stateTax]) => {
                    if (!taxByStateMap[stateCode]) {
                      taxByStateMap[stateCode] = { 
                        tax: 0, 
                        sales: 0,  // Item sales only
                        shipping: 0,  // Shipping charges
                        orders: 0,
                        shopPayTax: 0,
                        shopPaySales: 0,
                        shopPayShipping: 0,
                        shopPayOrders: 0,
                        jurisdictions: {}  // Jurisdiction-level breakdown
                      };
                    }
                    // Handle both old format (number) and new format (object)
                    if (typeof stateTax === 'number') {
                      taxByStateMap[stateCode].tax += stateTax;
                    } else {
                      taxByStateMap[stateCode].tax += stateTax.tax || 0;
                      taxByStateMap[stateCode].sales += stateTax.sales || 0;
                      taxByStateMap[stateCode].shipping += stateTax.shipping || 0;
                      taxByStateMap[stateCode].orders += stateTax.orders || 0;
                      // Shop Pay breakdown
                      taxByStateMap[stateCode].shopPayTax += stateTax.shopPayTax || 0;
                      taxByStateMap[stateCode].shopPaySales += stateTax.shopPaySales || 0;
                      taxByStateMap[stateCode].shopPayShipping += stateTax.shopPayShipping || 0;
                      taxByStateMap[stateCode].shopPayOrders += stateTax.shopPayOrders || 0;
                      
                      // Aggregate jurisdiction data
                      if (stateTax.jurisdictions) {
                        Object.entries(stateTax.jurisdictions).forEach(([jurisdiction, jData]) => {
                          if (!taxByStateMap[stateCode].jurisdictions[jurisdiction]) {
                            taxByStateMap[stateCode].jurisdictions[jurisdiction] = {
                              tax: 0, sales: 0, orders: 0, rate: jData.rate || 0
                            };
                          }
                          taxByStateMap[stateCode].jurisdictions[jurisdiction].tax += jData.tax || 0;
                          taxByStateMap[stateCode].jurisdictions[jurisdiction].sales += jData.sales || 0;
                          taxByStateMap[stateCode].jurisdictions[jurisdiction].orders += jData.orders || 0;
                        });
                      }
                    }
                  });
                  totalTax += dayData.shopify.taxTotal || 0;
                  shopPayExcluded += dayData.shopify.shopPayTaxExcluded || 0;
                }
              });
              
              return {
                byState: Object.entries(taxByStateMap)
                  .map(([code, data]) => {
                    const stateInfo = US_STATES_TAX_INFO[code];
                    const shippingTaxable = stateInfo?.shippingTaxable || false;
                    
                    // Calculate taxable sales based on whether state taxes shipping
                    const itemSales = data.sales + data.shopPaySales;
                    const totalShipping = data.shipping + data.shopPayShipping;
                    const taxableSales = shippingTaxable ? (itemSales + totalShipping) : itemSales;
                    
                    return { 
                      stateCode: code, 
                      stateName: stateInfo?.name || code,
                      shippingTaxable,
                      // Sales breakdown
                      itemSales: itemSales,
                      shipping: totalShipping,
                      // Total taxable sales (includes shipping if state taxes it)
                      totalSales: taxableSales,
                      totalOrders: data.orders + data.shopPayOrders,
                      totalTax: data.tax + data.shopPayTax,
                      // What YOU owe (non-Shop Pay only)
                      taxOwed: data.tax,
                      salesYouOwe: shippingTaxable ? (data.sales + data.shipping) : data.sales,
                      ordersYouOwe: data.orders,
                      // Shop Pay (Shopify remits this)
                      shopPayTax: data.shopPayTax,
                      shopPaySales: data.shopPaySales,
                      shopPayOrders: data.shopPayOrders,
                      // Jurisdiction breakdown for county/city level reporting
                      jurisdictions: Object.entries(data.jurisdictions || {})
                        .map(([name, jData]) => ({
                          name,
                          tax: jData.tax,
                          sales: jData.sales,
                          orders: jData.orders,
                          rate: jData.rate
                        }))
                        .filter(j => j.tax > 0 || j.sales > 0)
                        .sort((a, b) => b.tax - a.tax),
                      // Raw data
                      ...data 
                    };
                  })
                  .sort((a, b) => b.totalSales - a.totalSales), // Sort by total sales
                totalTax,
                shopPayExcluded,
                daysWithData,
                // Calculate totals for Shop Pay
                totalShopPayOrders: Object.values(taxByStateMap).reduce((sum, d) => sum + d.shopPayOrders, 0),
                totalShopPaySales: Object.values(taxByStateMap).reduce((sum, d) => sum + d.shopPaySales, 0),
              };
            };
            
            const taxData = calculateTaxByState();
            const hasShopifyTaxData = taxData.daysWithData > 0;
            
            // Period options based on type
            const getPeriodOptions = () => {
              const currentYear = new Date().getFullYear();
              const options = [];
              
              if (taxPeriodType === 'month') {
                for (let y = currentYear; y >= currentYear - 1; y--) {
                  for (let m = 12; m >= 1; m--) {
                    if (y === currentYear && m > new Date().getMonth() + 1) continue;
                    options.push({ value: `${y}-${String(m).padStart(2, '0')}`, label: `${new Date(y, m - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}` });
                  }
                }
              } else if (taxPeriodType === 'quarter') {
                for (let y = currentYear; y >= currentYear - 1; y--) {
                  for (let q = 4; q >= 1; q--) {
                    if (y === currentYear && q > Math.ceil((new Date().getMonth() + 1) / 3)) continue;
                    options.push({ value: `${y}-${q}`, label: `Q${q} ${y}` });
                  }
                }
              } else if (taxPeriodType === 'semiannual') {
                for (let y = currentYear; y >= currentYear - 1; y--) {
                  for (let h = 2; h >= 1; h--) {
                    if (y === currentYear && h === 2 && new Date().getMonth() < 6) continue;
                    options.push({ value: `${y}-${h}`, label: `${h === 1 ? 'H1' : 'H2'} ${y} (${h === 1 ? 'Jan-Jun' : 'Jul-Dec'})` });
                  }
                }
              } else {
                for (let y = currentYear; y >= currentYear - 2; y--) {
                  options.push({ value: `${y}-1`, label: `${y}` });
                }
              }
              
              return options;
            };
            
            return (
              <div className="mb-6 bg-gradient-to-r from-green-900/20 to-emerald-900/20 border border-green-500/30 rounded-2xl p-5">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                  <div>
                    <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                      <ShoppingBag className="w-5 h-5 text-green-400" />
                      Shopify Tax Calculator
                    </h3>
                    <p className="text-slate-400 text-sm">Tax collected from synced Shopify orders</p>
                  </div>
                  <div className="flex items-center gap-2">
                    <select
                      value={taxPeriodType}
                      onChange={(e) => {
                        setTaxPeriodType(e.target.value);
                        // Reset to first option of new type
                        const currentYear = new Date().getFullYear();
                        if (e.target.value === 'month') {
                          setTaxPeriodValue(`${currentYear}-${String(new Date().getMonth() + 1).padStart(2, '0')}`);
                        } else if (e.target.value === 'quarter') {
                          setTaxPeriodValue(`${currentYear}-${Math.ceil((new Date().getMonth() + 1) / 3)}`);
                        } else if (e.target.value === 'semiannual') {
                          setTaxPeriodValue(`${currentYear}-${new Date().getMonth() < 6 ? 1 : 2}`);
                        } else {
                          setTaxPeriodValue(`${currentYear}-1`);
                        }
                      }}
                      className="bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white"
                    >
                      <option value="month">Monthly</option>
                      <option value="quarter">Quarterly</option>
                      <option value="semiannual">Semi-Annual</option>
                      <option value="annual">Annual</option>
                    </select>
                    <select
                      value={taxPeriodValue}
                      onChange={(e) => setTaxPeriodValue(e.target.value)}
                      className="bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white"
                    >
                      {getPeriodOptions().map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                  </div>
                </div>
                
                {hasShopifyTaxData ? (
                  <>
                    {/* Main Summary Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                      <div className="bg-gradient-to-br from-rose-600/30 to-rose-900/30 border-2 border-rose-500/50 rounded-xl p-4 text-center">
                        <p className="text-xs text-rose-300 font-semibold uppercase tracking-wide mb-1">ðŸ’° YOU OWE</p>
                        <p className="text-3xl font-bold text-rose-400">{formatCurrency(taxData.totalTax)}</p>
                        <p className="text-rose-300/70 text-xs mt-1">Tax to remit this period</p>
                      </div>
                      <div className="bg-slate-800/50 rounded-xl p-4 text-center">
                        <p className="text-xs text-slate-400 font-semibold uppercase tracking-wide mb-1">Total Collected</p>
                        <p className="text-2xl font-bold text-white">{formatCurrency(taxData.totalTax + taxData.shopPayExcluded)}</p>
                        <p className="text-slate-500 text-xs mt-1">from all orders</p>
                      </div>
                      <div className="bg-slate-800/50 rounded-xl p-4 text-center">
                        <p className="text-xs text-slate-400 font-semibold uppercase tracking-wide mb-1">States</p>
                        <p className="text-2xl font-bold text-white">{taxData.byState.length}</p>
                        <p className="text-slate-500 text-xs mt-1">with sales this period</p>
                      </div>
                      <div className="bg-slate-800/50 rounded-xl p-4 text-center">
                        <p className="text-xs text-slate-400 font-semibold uppercase tracking-wide mb-1">Days Synced</p>
                        <p className="text-2xl font-bold text-white">{taxData.daysWithData}</p>
                        <p className="text-slate-500 text-xs mt-1">in selected period</p>
                      </div>
                    </div>
                    
                    {/* States Where You Owe Tax */}
                    {taxData.byState.filter(s => s.tax > 0).length > 0 && (
                      <div className="bg-rose-900/20 border border-rose-500/30 rounded-xl p-4 mb-4">
                        <h4 className="text-rose-400 font-semibold mb-3 flex items-center gap-2">
                          <AlertCircle className="w-5 h-5" />
                          States Where You Owe Tax
                        </h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                          {taxData.byState.filter(s => s.tax > 0).map(state => {
                            const hasNexus = nexusStates[state.stateCode]?.hasNexus;
                            return (
                              <div key={state.stateCode} className={`p-3 rounded-lg ${hasNexus ? 'bg-rose-800/30 border border-rose-500/50' : 'bg-slate-800/50 border border-slate-600/50'}`}>
                                <div className="flex items-center justify-between mb-1">
                                  <span className="text-white font-bold">{state.stateCode}</span>
                                  {hasNexus && <span className="text-xs bg-rose-600 text-white px-1.5 py-0.5 rounded">NEXUS</span>}
                                </div>
                                <p className="text-xl font-bold text-rose-400">{formatCurrency(state.tax)}</p>
                                <p className="text-slate-500 text-xs">{state.orders} orders â€¢ {formatCurrency(state.sales)} sales</p>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                    
                    {/* NEXUS States Quick Actions - Your Filing Obligations */}
                    {(() => {
                      const nexusStatesWithData = taxData.byState.filter(s => nexusStates[s.stateCode]?.hasNexus);
                      const totalNexusTaxOwed = nexusStatesWithData.reduce((s, st) => s + (st.taxOwed || st.tax || 0), 0);
                      const periodKey = taxPeriodType === 'month' ? taxPeriodValue : `${taxPeriodValue.split('-')[0]}-Q${taxPeriodValue.split('-')[1]}`;
                      const unfiledStates = nexusStatesWithData.filter(s => !salesTaxConfig.filingHistory?.[s.stateCode]?.[periodKey]?.filed);
                      const filedStates = nexusStatesWithData.filter(s => salesTaxConfig.filingHistory?.[s.stateCode]?.[periodKey]?.filed);
                      
                      // Helper: Check if filing is due for this period based on frequency
                      const isFilingDueForPeriod = (stateCode) => {
                        const config = nexusStates[stateCode] || {};
                        const frequency = config.frequency || 'monthly';
                        const [year, period] = taxPeriodValue.split('-');
                        const periodMonth = parseInt(period);
                        
                        if (taxPeriodType === 'month') {
                          if (frequency === 'monthly') return true;
                          if (frequency === 'quarterly') {
                            // Q1: Mar, Q2: Jun, Q3: Sep, Q4: Dec
                            return [3, 6, 9, 12].includes(periodMonth);
                          }
                          if (frequency === 'semi-annual') {
                            // H1: Jun, H2: Dec
                            return [6, 12].includes(periodMonth);
                          }
                          if (frequency === 'annual') {
                            return periodMonth === 12;
                          }
                        }
                        return true; // Default to due
                      };
                      
                      // Filter to only states with filings due this period
                      const statesDueThisPeriod = unfiledStates.filter(s => isFilingDueForPeriod(s.stateCode));
                      const statesNotDueYet = unfiledStates.filter(s => !isFilingDueForPeriod(s.stateCode));
                      
                      // Helper to download a single state's filing
                      const downloadStateFiling = (state) => {
                        const { start, end } = getDateRange();
                        // Use taxPeriodValue directly to avoid timezone issues
                        let periodLabel;
                        if (taxPeriodType === 'month') {
                          const [year, month] = taxPeriodValue.split('-');
                          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                          periodLabel = `${monthNames[parseInt(month) - 1]}-${year}`;
                        } else {
                          periodLabel = taxPeriodValue;
                        }
                        const stateInfo = US_STATES_TAX_INFO[state.stateCode];
                        const filingFormat = STATE_FILING_FORMATS[state.stateCode] || STATE_FILING_FORMATS.DEFAULT;
                        const calculated = filingFormat.calculate(state, stateInfo);
                        
                        let csv = `${stateInfo?.name || state.stateCode} Sales Tax Return\n`;
                        csv += `Period: ${periodLabel}\n`;
                        csv += `Form: ${filingFormat.formName}\n`;
                        csv += `Generated: ${new Date().toLocaleDateString()}\n`;
                        csv += `\nVERIFY: Compare with Shopify Admin > Analytics > Reports > Taxes\n\n`;
                        csv += `Field,Value,Notes\n`;
                        
                        filingFormat.fields.forEach(field => {
                          const val = calculated[field.key];
                          const formattedVal = typeof val === 'number' ? val.toFixed(2) : (val || '');
                          csv += `"${field.name}",${formattedVal},"${field.description || ''}"\n`;
                        });
                        
                        csv += `\nState Tax Rate,${((stateInfo?.stateRate || 0) * 100).toFixed(2)}%\n`;
                        csv += `Orders,${state.totalOrders || state.orders || 0}\n`;
                        
                        if (filingFormat.note) csv += `\nNote:,"${filingFormat.note}"\n`;
                        
                        const portalUrl = nexusStates[state.stateCode]?.portalUrl || STATE_FILING_FORMATS[state.stateCode]?.website;
                        if (portalUrl) csv += `\nFile Online:,${portalUrl}\n`;
                        
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${state.stateCode}-SalesTax-${periodLabel}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                      };
                      
                      // Get portal URL for a state (custom > default)
                      const getPortalUrl = (stateCode) => {
                        return nexusStates[stateCode]?.portalUrl || STATE_FILING_FORMATS[stateCode]?.website || null;
                      };
                      
                      if (nexusStatesWithData.length === 0) return null;
                      
                      return (
                        <div className="bg-gradient-to-r from-rose-900/30 to-violet-900/30 border border-rose-500/30 rounded-xl p-4 mb-6">
                          <div className="flex justify-between items-start mb-4">
                            <div>
                              <h4 className="text-lg font-bold text-white flex items-center gap-2">
                                ðŸ›ï¸ Your Filing Obligations
                              </h4>
                              <p className="text-slate-400 text-sm">
                                {statesDueThisPeriod.length > 0 
                                  ? `${statesDueThisPeriod.length} state${statesDueThisPeriod.length > 1 ? 's' : ''} due for ${taxPeriodValue}`
                                  : unfiledStates.length > 0 
                                    ? 'No filings due this period'
                                    : 'All filings complete! âœ“'}
                              </p>
                            </div>
                            <div className="text-right">
                              <p className="text-xs text-slate-400">Total You Owe</p>
                              <p className="text-2xl font-bold text-rose-400">{formatCurrency(totalNexusTaxOwed)}</p>
                            </div>
                          </div>
                          
                          {/* States DUE This Period */}
                          {statesDueThisPeriod.length > 0 && (
                            <>
                              <p className="text-xs text-rose-400 mb-2 font-semibold">âš ï¸ DUE THIS PERIOD:</p>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                {statesDueThisPeriod.map(state => {
                                  const stateInfo = US_STATES_TAX_INFO[state.stateCode];
                                  const config = nexusStates[state.stateCode] || {};
                                  const portalUrl = getPortalUrl(state.stateCode);
                                  return (
                                    <div key={state.stateCode} className="bg-slate-800/80 rounded-lg p-3 border border-rose-500/50">
                                      <div className="flex justify-between items-center mb-1">
                                        <div>
                                          <span className="font-bold text-white">{state.stateName}</span>
                                          <span className="text-xs text-slate-500 ml-2">({config.frequency || 'monthly'})</span>
                                        </div>
                                        <span className="text-rose-400 font-bold">{formatCurrency(state.taxOwed || state.tax || 0)}</span>
                                      </div>
                                      <div className="flex gap-2 mt-2">
                                        <button
                                          onClick={() => downloadStateFiling(state)}
                                          className="text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-2 py-1.5 rounded font-medium"
                                          title="Download filing data"
                                        >
                                          â¬‡ï¸ Export
                                        </button>
                                        <button
                                          onClick={() => setFilingDetailState({ stateCode: state.stateCode, data: state })}
                                          className="text-xs bg-violet-600 hover:bg-violet-500 text-white px-2 py-1.5 rounded font-medium"
                                        >
                                          ðŸ“‹ Details
                                        </button>
                                        {portalUrl && (
                                          <button
                                            onClick={() => window.open(portalUrl, '_blank')}
                                            className="text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1.5 rounded font-medium"
                                            title={`Open ${state.stateCode} tax portal`}
                                          >
                                            ðŸ”— File Online
                                          </button>
                                        )}
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </>
                          )}
                          
                          {/* States NOT Due Yet (accumulating) */}
                          {statesNotDueYet.length > 0 && (
                            <div className="mb-4">
                              <p className="text-xs text-amber-400 mb-2">ðŸ“… Accumulating (not due yet):</p>
                              <div className="flex flex-wrap gap-2">
                                {statesNotDueYet.map(state => {
                                  const config = nexusStates[state.stateCode] || {};
                                  return (
                                    <div key={state.stateCode} className="text-xs bg-amber-900/30 text-amber-300 px-2 py-1 rounded border border-amber-500/30 flex items-center gap-2">
                                      <span>{state.stateCode}: {formatCurrency(state.taxOwed || state.tax || 0)}</span>
                                      <span className="text-amber-500">({config.frequency || 'monthly'})</span>
                                      <button
                                        onClick={() => downloadStateFiling(state)}
                                        className="hover:text-amber-200"
                                        title="Download anyway"
                                      >
                                        â¬‡ï¸
                                      </button>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          )}
                          
                          {/* Filed States */}
                          {filedStates.length > 0 && (
                            <div className="mb-4">
                              <p className="text-xs text-emerald-400 mb-2">âœ“ Filed this period:</p>
                              <div className="flex flex-wrap gap-2">
                                {filedStates.map(state => (
                                  <span key={state.stateCode} className="text-xs bg-emerald-900/50 text-emerald-300 px-2 py-1 rounded border border-emerald-500/30">
                                    {state.stateCode} â€¢ {formatCurrency(salesTaxConfig.filingHistory?.[state.stateCode]?.[periodKey]?.amount || state.taxOwed || 0)}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Download All DUE States Button */}
                          {statesDueThisPeriod.length > 0 && (
                            <button
                              onClick={async () => {
                                for (const state of statesDueThisPeriod) {
                                  downloadStateFiling(state);
                                  await new Promise(resolve => setTimeout(resolve, 300));
                                }
                                setToast({ message: `Downloaded ${statesDueThisPeriod.length} state filings`, type: 'success' });
                              }}
                              className="w-full px-4 py-3 bg-gradient-to-r from-violet-600 to-rose-600 hover:from-violet-500 hover:to-rose-500 rounded-lg text-white font-bold flex items-center justify-center gap-2"
                            >
                              <Download className="w-5 h-5" />
                              Download All Due Filings ({statesDueThisPeriod.length} files)
                            </button>
                          )}
                        </div>
                      );
                    })()}
                    
                    {taxData.byState.length > 0 && (
                      <>
                        <div className="flex justify-between items-center mb-2">
                          <h4 className="text-white font-medium">All States with Sales</h4>
                          <button
                            onClick={() => {
                              // Export tax data as CSV for filing
                              const { start, end } = getDateRange();
                              // Use taxPeriodValue directly to avoid timezone issues
                              let periodLabel;
                              if (taxPeriodType === 'month') {
                                const [year, month] = taxPeriodValue.split('-');
                                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                                periodLabel = `${monthNames[parseInt(month) - 1]} ${year}`;
                              } else if (taxPeriodType === 'quarter') {
                                periodLabel = `Q${taxPeriodValue.split('-')[1]} ${taxPeriodValue.split('-')[0]}`;
                              } else if (taxPeriodType === 'semiannual') {
                                periodLabel = `${taxPeriodValue.split('-')[1] === '1' ? 'H1' : 'H2'} ${taxPeriodValue.split('-')[0]}`;
                              } else {
                                periodLabel = taxPeriodValue.split('-')[0];
                              }
                              
                              // Create CSV with all fields states typically need
                              let csv = 'State,State Code,Item Sales,Shipping,Taxable Sales,Total Tax,Tax You Owe,Shipping Taxable,Total Orders,Has Nexus,Period,Start Date,End Date\n';
                              taxData.byState.forEach(state => {
                                const hasNexus = nexusStates[state.stateCode]?.hasNexus ? 'Yes' : 'No';
                                const itemSales = state.itemSales || state.sales || 0;
                                const shipping = state.shipping || 0;
                                const taxableSales = state.totalSales || state.sales || 0;
                                const totalTax = state.totalTax || state.tax || 0;
                                const taxOwed = state.taxOwed || state.tax || 0;
                                const shippingTaxable = state.shippingTaxable ? 'Yes' : 'No';
                                const totalOrders = state.totalOrders || state.orders || 0;
                                csv += `"${state.stateName}",${state.stateCode},${itemSales.toFixed(2)},${shipping.toFixed(2)},${taxableSales.toFixed(2)},${totalTax.toFixed(2)},${taxOwed.toFixed(2)},${shippingTaxable},${totalOrders},${hasNexus},"${periodLabel}",${start},${end}\n`;
                              });
                              const grandTotalItemSales = taxData.byState.reduce((s, st) => s + (st.itemSales || st.sales || 0), 0);
                              const grandTotalShipping = taxData.byState.reduce((s, st) => s + (st.shipping || 0), 0);
                              const grandTotalTaxableSales = taxData.byState.reduce((s, st) => s + (st.totalSales || st.sales || 0), 0);
                              const grandTotalTax = taxData.byState.reduce((s, st) => s + (st.totalTax || st.tax || 0), 0);
                              const grandTotalOrders = taxData.byState.reduce((s, st) => s + (st.totalOrders || st.orders || 0), 0);
                              csv += `"TOTAL",,${grandTotalItemSales.toFixed(2)},${grandTotalShipping.toFixed(2)},${grandTotalTaxableSales.toFixed(2)},${grandTotalTax.toFixed(2)},${taxData.totalTax.toFixed(2)},,${grandTotalOrders},,"${periodLabel}",${start},${end}\n`;
                              csv += '\n"Item Sales = Product sales only (excludes shipping)"\n';
                              csv += '"Taxable Sales = Item Sales + Shipping (if shipping is taxable in that state)"\n';
                              csv += '"Tax You Owe = What you need to file and pay yourself"\n';
                              
                              const blob = new Blob([csv], { type: 'text/csv' });
                              const url = URL.createObjectURL(blob);
                              const a = document.createElement('a');
                              a.href = url;
                              a.download = `sales-tax-${periodLabel.replace(/\s+/g, '-')}.csv`;
                              a.click();
                              URL.revokeObjectURL(url);
                            }}
                            className="px-3 py-1.5 bg-emerald-600/30 hover:bg-emerald-600/50 border border-emerald-500/50 rounded-lg text-sm text-emerald-300 flex items-center gap-1"
                          >
                            <Download className="w-4 h-4" />
                            Export for Filing
                          </button>
                        </div>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b border-slate-700">
                              <th className="text-left text-slate-400 py-2 px-2">State</th>
                              <th className="text-right text-slate-400 py-2 px-2">
                                <span title="Includes shipping if taxable in that state">Taxable Sales</span>
                              </th>
                              <th className="text-right text-slate-400 py-2 px-2">Total Tax</th>
                              <th className="text-right text-slate-400 py-2 px-2">
                                <span className="text-rose-400">YOU OWE</span>
                              </th>
                              <th className="text-right text-slate-400 py-2 px-2">Orders</th>
                              <th className="text-center text-slate-400 py-2 px-2">Status</th>
                              <th className="text-center text-slate-400 py-2 px-2">Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            {taxData.byState.map(state => {
                              const hasNexus = nexusStates[state.stateCode]?.hasNexus;
                              const owes = state.taxOwed > 0;
                              return (
                                <tr key={state.stateCode} className={`border-b border-slate-700/50 ${owes && hasNexus ? 'bg-rose-900/20' : 'hover:bg-slate-800/50'}`}>
                                  <td className="py-2 px-2">
                                    <span className="text-white font-medium">{state.stateName}</span>
                                    <span className="text-slate-500 ml-2 text-xs">{state.stateCode}</span>
                                    {state.shippingTaxable && (
                                      <span className="ml-1 text-xs text-cyan-400" title="Shipping is taxable in this state">ðŸ“¦</span>
                                    )}
                                  </td>
                                  <td className="py-2 px-2 text-right text-slate-300">
                                    <span title={state.shippingTaxable ? `Items: ${formatCurrency(state.itemSales || 0)} + Ship: ${formatCurrency(state.shipping || 0)}` : `Items only (shipping exempt)`}>
                                      {formatCurrency(state.totalSales || state.sales || 0)}
                                    </span>
                                  </td>
                                  <td className="py-2 px-2 text-right text-slate-400">{formatCurrency(state.totalTax || state.tax || 0)}</td>
                                  <td className={`py-2 px-2 text-right font-bold ${owes ? 'text-rose-400' : 'text-slate-500'}`}>
                                    {owes ? formatCurrency(state.taxOwed || state.tax) : 'â€”'}
                                  </td>
                                  <td className="py-2 px-2 text-right text-slate-400">{state.totalOrders || state.orders || 0}</td>
                                  <td className="py-2 px-2 text-center">
                                    {hasNexus ? (
                                      <span className="text-xs bg-rose-600/80 text-white px-2 py-0.5 rounded font-medium">NEXUS</span>
                                    ) : owes ? (
                                      <button
                                        onClick={() => toggleNexus(state.stateCode)}
                                        className="text-xs text-amber-400 hover:text-amber-300"
                                      >
                                        + Add Nexus
                                      </button>
                                    ) : (
                                      <span className="text-xs text-slate-600">No tax</span>
                                    )}
                                  </td>
                                  <td className="py-2 px-2 text-center">
                                    {hasNexus && (
                                      <button
                                        onClick={() => setFilingDetailState({ stateCode: state.stateCode, data: state })}
                                        className="text-xs bg-violet-600 hover:bg-violet-500 text-white px-2 py-1 rounded font-medium"
                                      >
                                        ðŸ“‹ File
                                      </button>
                                    )}
                                  </td>
                                </tr>
                              );
                            })}
                          </tbody>
                          <tfoot>
                            <tr className="border-t-2 border-rose-500/50 bg-rose-900/10">
                              <td className="py-3 px-2 font-bold text-white">TOTAL</td>
                              <td className="py-3 px-2 text-right text-slate-300 font-medium">{formatCurrency(taxData.byState.reduce((s, st) => s + (st.totalSales || st.sales || 0), 0))}</td>
                              <td className="py-3 px-2 text-right text-slate-400">{formatCurrency(taxData.byState.reduce((s, st) => s + (st.totalTax || st.tax || 0), 0))}</td>
                              <td className="py-3 px-2 text-right font-bold text-xl text-rose-400">{formatCurrency(taxData.totalTax)}</td>
                              <td className="py-3 px-2 text-right text-slate-400">{taxData.byState.reduce((s, st) => s + (st.totalOrders || st.orders || 0), 0)}</td>
                              <td></td>
                              <td></td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                        <div className="mt-4 p-3 bg-slate-800/50 rounded-lg">
                          <p className="text-slate-400 text-xs">
                            ðŸ’¡ <strong className="text-rose-300">YOU OWE</strong> = Tax you must file and pay.
                            <span className="ml-2">ðŸ“¦ = Shipping is taxable in that state (included in Taxable Sales).</span>
                            <span className="ml-2">Click <strong className="text-violet-300">ðŸ“‹ File</strong> on NEXUS states for state-specific filing format.</span>
                          </p>
                        </div>
                        
                        {/* State Filing Detail Modal */}
                        {filingDetailState && (() => {
                          const stateCode = filingDetailState.stateCode;
                          const stateData = filingDetailState.data;
                          const stateInfo = US_STATES_TAX_INFO[stateCode];
                          const filingFormat = STATE_FILING_FORMATS[stateCode] || STATE_FILING_FORMATS.DEFAULT;
                          const calculated = filingFormat.calculate(stateData, stateInfo);
                          const periodKey = taxPeriodType === 'month' ? taxPeriodValue : `${taxPeriodValue.split('-')[0]}-Q${taxPeriodValue.split('-')[1]}`;
                          const alreadyFiled = salesTaxConfig.filingHistory?.[stateCode]?.[periodKey]?.filed;
                          
                          return (
                            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                              <div className="bg-slate-800 rounded-xl border border-slate-600 p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
                                <div className="flex items-center justify-between mb-4">
                                  <div>
                                    <h3 className="text-xl font-bold text-white">{stateInfo?.name || stateCode} Sales Tax Filing</h3>
                                    <p className="text-sm text-slate-400">{filingFormat.formName}</p>
                                  </div>
                                  <button onClick={() => setFilingDetailState(null)} className="p-2 hover:bg-slate-700 rounded-lg">
                                    <X className="w-5 h-5 text-slate-400" />
                                  </button>
                                </div>
                                
                                {/* Already Filed Banner */}
                                {alreadyFiled && (
                                  <div className="bg-emerald-900/30 border border-emerald-500/30 rounded-lg p-3 mb-4 flex items-center gap-2">
                                    <CheckCircle className="w-5 h-5 text-emerald-400" />
                                    <div>
                                      <p className="text-emerald-400 font-medium">Filed & Paid</p>
                                      <p className="text-emerald-300/70 text-xs">
                                        {salesTaxConfig.filingHistory[stateCode][periodKey].filedDate 
                                          ? `Filed on ${new Date(salesTaxConfig.filingHistory[stateCode][periodKey].filedDate).toLocaleDateString()}`
                                          : 'Marked as complete'}
                                        {salesTaxConfig.filingHistory[stateCode][periodKey].amount > 0 && 
                                          ` â€¢ ${formatCurrency(salesTaxConfig.filingHistory[stateCode][periodKey].amount)} paid`}
                                      </p>
                                    </div>
                                  </div>
                                )}
                                
                                {/* Portal URL - Custom or Default with Edit option */}
                                {(() => {
                                  const portalUrl = nexusStates[stateCode]?.portalUrl || filingFormat.website;
                                  const isEditing = editingPortalUrl === stateCode;
                                  
                                  return (
                                    <div className="mb-4">
                                      {!isEditing ? (
                                        <div className="flex gap-2">
                                          {portalUrl && (
                                            <button 
                                              onClick={() => window.open(portalUrl, '_blank')}
                                              className="flex-1 flex items-center justify-center gap-2 text-sm bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-medium"
                                            >
                                              <ArrowUpRight className="w-4 h-4" />
                                              Open {stateInfo?.name} Tax Portal
                                            </button>
                                          )}
                                          <button 
                                            onClick={() => {
                                              setEditPortalUrlValue(portalUrl || '');
                                              setEditingPortalUrl(stateCode);
                                            }}
                                            className="px-3 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg text-sm"
                                            title="Edit portal URL"
                                          >
                                            âœï¸
                                          </button>
                                        </div>
                                      ) : (
                                        <div className="space-y-2">
                                          <label className="text-xs text-slate-400">Tax Portal URL:</label>
                                          <div className="flex gap-2">
                                            <input
                                              type="url"
                                              value={editPortalUrlValue}
                                              onChange={(e) => setEditPortalUrlValue(e.target.value)}
                                              placeholder="https://..."
                                              className="flex-1 px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm"
                                            />
                                            <button
                                              onClick={() => {
                                                // Save custom URL to nexusStates
                                                const updated = {
                                                  ...nexusStates,
                                                  [stateCode]: {
                                                    ...nexusStates[stateCode],
                                                    portalUrl: editPortalUrlValue || null
                                                  }
                                                };
                                                setNexusStates(updated);
                                                localStorage.setItem('nexusStates', JSON.stringify(updated));
                                                setEditingPortalUrl(null);
                                              }}
                                              className="px-3 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm"
                                            >
                                              Save
                                            </button>
                                            <button
                                              onClick={() => setEditingPortalUrl(null)}
                                              className="px-3 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm"
                                            >
                                              Cancel
                                            </button>
                                          </div>
                                          {filingFormat.website && filingFormat.website !== editPortalUrlValue && (
                                            <p className="text-xs text-slate-500">
                                              Default: <button 
                                                onClick={() => setEditPortalUrlValue(filingFormat.website)}
                                                className="text-blue-400 hover:underline"
                                              >{filingFormat.website}</button>
                                            </p>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                  );
                                })()}
                                
                                {/* Filing fields */}
                                <div className="bg-slate-900 rounded-lg p-4 mb-4">
                                  <h4 className="text-sm font-semibold text-slate-300 mb-3">ðŸ“ Fields for Your Return</h4>
                                  <div className="space-y-3">
                                    {filingFormat.fields.map(field => (
                                      <div key={field.key} className="flex justify-between items-center border-b border-slate-700 pb-2">
                                        <div>
                                          <p className="text-white font-medium">{field.name}</p>
                                          <p className="text-xs text-slate-500">{field.description}</p>
                                        </div>
                                        <p className="text-lg font-bold text-emerald-400">
                                          {typeof calculated[field.key] === 'number' 
                                            ? formatCurrency(calculated[field.key])
                                            : calculated[field.key] || 'â€”'}
                                        </p>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                                
                                {/* Jurisdiction Breakdown - for states requiring county/city reporting */}
                                {stateData.jurisdictions && stateData.jurisdictions.length > 0 && (
                                  <div className="bg-slate-900 rounded-lg p-4 mb-4">
                                    <div className="flex items-center justify-between mb-3">
                                      <h4 className="text-sm font-semibold text-slate-300">
                                        ðŸ“ {filingFormat.requiresJurisdictions ? `${filingFormat.jurisdictionType || 'Jurisdiction'} Breakdown` : 'Tax by Jurisdiction'}
                                        {filingFormat.requiresJurisdictions && (
                                          <span className="ml-2 text-xs bg-amber-600/30 text-amber-300 px-2 py-0.5 rounded">Required for Filing</span>
                                        )}
                                      </h4>
                                      <button
                                        onClick={() => {
                                          // Export jurisdiction-level CSV
                                          const { start, end } = getDateRange();
                                          let csv = 'Jurisdiction,Tax Rate,Taxable Sales,Tax Collected,Orders\n';
                                          stateData.jurisdictions.forEach(j => {
                                            csv += `"${j.name}",${((j.rate || 0) * 100).toFixed(3)}%,${(j.sales || 0).toFixed(2)},${(j.tax || 0).toFixed(2)},${j.orders || 0}\n`;
                                          });
                                          csv += `\n"TOTAL",,${(stateData.totalSales || 0).toFixed(2)},${(stateData.taxOwed || 0).toFixed(2)},${stateData.totalOrders || 0}\n`;
                                          csv += `\n"State: ${stateInfo?.name || stateCode}"\n`;
                                          csv += `"Period: ${taxPeriodValue}"\n`;
                                          csv += `"Date Range: ${start} to ${end}"\n`;
                                          
                                          const blob = new Blob([csv], { type: 'text/csv' });
                                          const url = URL.createObjectURL(blob);
                                          const a = document.createElement('a');
                                          a.href = url;
                                          a.download = `${stateCode}-jurisdiction-breakdown-${taxPeriodValue}.csv`;
                                          a.click();
                                          URL.revokeObjectURL(url);
                                        }}
                                        className="text-xs bg-emerald-600/30 hover:bg-emerald-600/50 text-emerald-300 px-2 py-1 rounded flex items-center gap-1"
                                      >
                                        <Download className="w-3 h-3" />
                                        Export CSV
                                      </button>
                                    </div>
                                    <div className="max-h-48 overflow-y-auto">
                                      <table className="w-full text-sm">
                                        <thead className="sticky top-0 bg-slate-900">
                                          <tr className="text-slate-400 text-xs">
                                            <th className="text-left py-1">Jurisdiction</th>
                                            <th className="text-right py-1">Rate</th>
                                            <th className="text-right py-1">Sales</th>
                                            <th className="text-right py-1">Tax</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {stateData.jurisdictions.map((j, idx) => (
                                            <tr key={idx} className="border-t border-slate-800">
                                              <td className="py-1.5 text-white">{j.name}</td>
                                              <td className="py-1.5 text-right text-slate-400">{((j.rate || 0) * 100).toFixed(2)}%</td>
                                              <td className="py-1.5 text-right text-slate-300">{formatCurrency(j.sales || 0)}</td>
                                              <td className="py-1.5 text-right text-emerald-400">{formatCurrency(j.tax || 0)}</td>
                                            </tr>
                                          ))}
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                )}
                                
                                {/* Note about jurisdiction requirements */}
                                {filingFormat.requiresJurisdictions && (!stateData.jurisdictions || stateData.jurisdictions.length === 0) && (
                                  <div className="bg-amber-900/20 border border-amber-500/30 rounded-lg p-3 mb-4">
                                    <p className="text-amber-300 text-sm">
                                      âš ï¸ <strong>{stateInfo?.name}</strong> requires {filingFormat.jurisdictionType || 'jurisdiction'}-level breakdown, 
                                      but no jurisdiction data is available. Re-sync your Shopify data to capture tax jurisdiction details, 
                                      or manually check Shopify's tax report.
                                    </p>
                                  </div>
                                )}
                                
                                {filingFormat.note && (
                                  <div className="bg-amber-900/20 border border-amber-500/30 rounded-lg p-3 mb-4">
                                    <p className="text-amber-300 text-sm">âš ï¸ {filingFormat.note}</p>
                                  </div>
                                )}
                                
                                {/* Verify with Shopify */}
                                <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3 mb-4">
                                  <p className="text-blue-300 text-sm">
                                    ðŸ’¡ <strong>Verify:</strong> Cross-check these numbers with Shopify Admin â†’ Analytics â†’ Reports â†’ Taxes. 
                                    Look for "{stateInfo?.name} Sales Tax" report for this period.
                                  </p>
                                </div>
                                
                                {/* State-specific info */}
                                <div className="bg-slate-700/50 rounded-lg p-3 mb-4 text-sm">
                                  <div className="grid grid-cols-2 gap-2">
                                    <div><span className="text-slate-400">State Rate:</span> <span className="text-white">{((stateInfo?.stateRate || 0) * 100).toFixed(2)}%</span></div>
                                    <div><span className="text-slate-400">SST Member:</span> <span className="text-white">{stateInfo?.sst ? 'Yes' : 'No'}</span></div>
                                    <div><span className="text-slate-400">Marketplace:</span> <span className="text-white">{stateInfo?.marketplaceFacilitator ? 'Yes' : 'No'}</span></div>
                                    <div><span className="text-slate-400">Period:</span> <span className="text-white">{taxPeriodValue}</span></div>
                                  </div>
                                </div>
                                
                                {/* Mark as Paid Section */}
                                {!alreadyFiled && (stateData.taxOwed > 0 || stateData.tax > 0) && (
                                  <div className="bg-slate-900 rounded-lg p-4 mb-4">
                                    <h4 className="text-sm font-semibold text-slate-300 mb-3">âœ… Mark as Filed & Paid</h4>
                                    <div className="space-y-3">
                                      <div>
                                        <label className="block text-xs text-slate-400 mb-1">Amount Paid</label>
                                        <input
                                          type="number"
                                          step="0.01"
                                          id={`filing-amount-${stateCode}`}
                                          defaultValue={(stateData.taxOwed || stateData.tax || 0).toFixed(2)}
                                          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"
                                        />
                                      </div>
                                      <div>
                                        <label className="block text-xs text-slate-400 mb-1">Confirmation # (optional)</label>
                                        <input
                                          type="text"
                                          id={`filing-confirm-${stateCode}`}
                                          placeholder="e.g., 12345678"
                                          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"
                                        />
                                      </div>
                                      <button
                                        onClick={() => {
                                          const amount = parseFloat(document.getElementById(`filing-amount-${stateCode}`).value) || 0;
                                          const confirmNum = document.getElementById(`filing-confirm-${stateCode}`).value || '';
                                          markFilingComplete(stateCode, periodKey, {
                                            amount,
                                            confirmationNum: confirmNum,
                                            reportData: {
                                              grossSales: stateData.totalSales || stateData.sales,
                                              taxCollected: stateData.taxOwed || stateData.tax,
                                              orders: stateData.totalOrders || stateData.orders,
                                              period: taxPeriodValue,
                                            }
                                          });
                                          setToast({ message: `${stateInfo?.name} tax marked as filed for ${taxPeriodValue}`, type: 'success' });
                                          setFilingDetailState(null);
                                        }}
                                        className="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white font-medium"
                                      >
                                        âœ“ Mark as Filed & Paid
                                      </button>
                                    </div>
                                  </div>
                                )}
                                
                                {/* Export button */}
                                <div className="flex gap-3">
                                  <button
                                    onClick={() => {
                                      // Generate state-specific CSV
                                      let csv = `${stateInfo?.name} Sales Tax Filing - ${taxPeriodValue}\n`;
                                      csv += `Form: ${filingFormat.formName}\n\n`;
                                      csv += `Field,Value\n`;
                                      filingFormat.fields.forEach(field => {
                                        const val = calculated[field.key];
                                        csv += `"${field.name}",${typeof val === 'number' ? val.toFixed(2) : val || ''}\n`;
                                      });
                                      csv += `\nState Rate,${((stateInfo?.stateRate || 0) * 100).toFixed(2)}%\n`;
                                      csv += `Period,${taxPeriodValue}\n`;
                                      
                                      const blob = new Blob([csv], { type: 'text/csv' });
                                      const url = URL.createObjectURL(blob);
                                      const a = document.createElement('a');
                                      a.href = url;
                                      a.download = `${stateCode}-sales-tax-${taxPeriodValue}.csv`;
                                      a.click();
                                      URL.revokeObjectURL(url);
                                    }}
                                    className="flex-1 px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white font-medium flex items-center justify-center gap-2"
                                  >
                                    <Download className="w-4 h-4" />
                                    Export {stateCode} Data
                                  </button>
                                  <button
                                    onClick={() => setFilingDetailState(null)}
                                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300"
                                  >
                                    Close
                                  </button>
                                </div>
                              </div>
                            </div>
                          );
                        })()}
                      </>
                    )}
                  </>
                ) : (
                  <div className="text-center py-6">
                    <ShoppingBag className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                    <p className="text-slate-400">No Shopify tax data for this period</p>
                    <p className="text-slate-500 text-sm mb-4">Sync Shopify orders to see tax breakdown by state</p>
                    <button
                      onClick={() => { setUploadTab('shopify-sync'); setView('upload'); }}
                      className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm text-white"
                    >
                      Sync Shopify
                    </button>
                  </div>
                )}
              </div>
            );
          })()}
          
          {/* Main Content Grid */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Nexus States List */}
            <div className="lg:col-span-2 bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-white">Your Nexus States</h3>
                <select value={taxFilterStatus} onChange={(e) => setTaxFilterStatus(e.target.value)} className="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm text-white">
                  <option value="all">All States</option>
                  <option value="due">Overdue</option>
                  <option value="upcoming">Due Soon</option>
                </select>
              </div>
              
              {nexusStatesList.length === 0 ? (
                <div className="text-center py-8">
                  <DollarSign className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                  <p className="text-slate-400">No nexus states configured</p>
                  <p className="text-slate-500 text-sm">Add states from the list on the right</p>
                </div>
              ) : (
                <div className="space-y-2">
                  {nexusStatesList
                    .filter(s => taxFilterStatus === 'all' || (taxFilterStatus === 'due' && s.nextDue < now) || (taxFilterStatus === 'upcoming' && s.nextDue >= now && s.nextDue <= sevenDays))
                    .map(state => {
                      const isOverdue = state.nextDue < now;
                      const isDueSoon = state.nextDue >= now && state.nextDue <= sevenDays;
                      return (
                        <div key={state.code} className={`flex items-center justify-between p-4 rounded-xl transition-all ${isOverdue ? 'bg-rose-900/20 border border-rose-500/30' : isDueSoon ? 'bg-amber-900/20 border border-amber-500/30' : 'bg-slate-900/50 hover:bg-slate-700/50'}`}>
                          <div className="flex items-center gap-4">
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-sm font-bold ${isOverdue ? 'bg-rose-600' : isDueSoon ? 'bg-amber-600' : 'bg-slate-700'}`}>{state.code}</div>
                            <div>
                              <p className="text-white font-medium">{state.name}</p>
                              <p className="text-slate-400 text-sm capitalize">{state.frequency} filing â€¢ {state.registrationId || 'No ID set'}</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-3">
                            <div className="text-right">
                              <p className={`text-sm font-medium ${isOverdue ? 'text-rose-400' : isDueSoon ? 'text-amber-400' : 'text-slate-300'}`}>
                                {isOverdue ? 'Overdue' : `Due ${state.nextDue.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`}
                              </p>
                              <p className="text-slate-500 text-xs">{Math.ceil((state.nextDue - now) / (1000 * 60 * 60 * 24))} days</p>
                            </div>
                            <button onClick={() => setSelectedTaxState(state.code)} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg" title="File/Upload Report"><Upload className="w-4 h-4" /></button>
                            <button onClick={() => setViewingStateHistory(state.code)} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg" title="View History"><FileText className="w-4 h-4" /></button>
                            <button onClick={() => { setTaxConfigState(state.code); setShowTaxStateConfig(true); }} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg" title="Settings"><Settings className="w-4 h-4" /></button>
                          </div>
                        </div>
                      );
                    })}
                </div>
              )}
            </div>
            
            {/* State Selector */}
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-white">Add States</h3>
                <button onClick={() => setShowHiddenStates(!showHiddenStates)} className="text-xs text-slate-400 hover:text-slate-300">{showHiddenStates ? 'Hide' : 'Show'} Hidden ({(hiddenStates || []).length})</button>
              </div>
              
              <div className="space-y-1 max-h-[500px] overflow-y-auto">
                {Object.entries(US_STATES_TAX_INFO)
                  .filter(([code]) => !(hiddenStates || []).includes(code) || showHiddenStates)
                  .filter(([code]) => !nexusStates[code]?.hasNexus)
                  .sort(([, a], [, b]) => a.name.localeCompare(b.name))
                  .map(([code, info]) => (
                    <div key={code} className={`flex items-center justify-between p-2 rounded-lg hover:bg-slate-700/50 ${hiddenStates.includes(code) ? 'opacity-50' : ''}`}>
                      <div className="flex items-center gap-2">
                        <span className="text-xs font-mono text-slate-500 w-6">{code}</span>
                        <span className="text-white text-sm">{info.name}</span>
                        {!info.hasStateTax && <span className="text-xs text-emerald-400">(No tax)</span>}
                      </div>
                      <div className="flex items-center gap-1">
                        {info.hasStateTax && (
                          <button onClick={() => toggleNexus(code)} className="px-2 py-1 bg-emerald-600/30 hover:bg-emerald-600/50 border border-emerald-500/50 rounded text-xs text-emerald-300">+ Add</button>
                        )}
                        <button onClick={() => toggleHideState(code)} className="p-1 text-slate-500 hover:text-slate-300"><Eye className="w-3 h-3" /></button>
                      </div>
                    </div>
                  ))}
              </div>
            </div>
          </div>
          
          {/* Filing History */}
          {Object.keys(filingHistory || {}).length > 0 && (
            <div className="mt-6 bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-white">Filing History</h3>
                <div className="flex items-center gap-2">
                  <select 
                    value={viewingStateHistory || 'all'} 
                    onChange={(e) => setViewingStateHistory(e.target.value === 'all' ? null : e.target.value)} 
                    className="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm text-white"
                  >
                    <option value="all">All States</option>
                    {Object.keys(filingHistory || {}).sort().map(code => (
                      <option key={code} value={code}>{US_STATES_TAX_INFO[code]?.name || code}</option>
                    ))}
                  </select>
                </div>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b border-slate-700">
                      <th className="text-left p-3 text-slate-400">State</th>
                      <th className="text-left p-3 text-slate-400">Period</th>
                      <th className="text-right p-3 text-slate-400">Amount Paid</th>
                      <th className="text-left p-3 text-slate-400">Confirmation #</th>
                      <th className="text-left p-3 text-slate-400">Filed Date</th>
                      <th className="text-left p-3 text-slate-400">Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.entries(filingHistory || {})
                      .filter(([stateCode]) => !viewingStateHistory || stateCode === viewingStateHistory)
                      .flatMap(([stateCode, periods]) => 
                        Object.entries(periods || {})
                          .sort(([a], [b]) => b.localeCompare(a))
                          .map(([period, data]) => (
                            <tr key={`${stateCode}-${period}`} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                              <td className="p-3">
                                <div className="flex items-center gap-2">
                                  <span className="w-8 h-8 bg-slate-700 rounded flex items-center justify-center text-xs font-bold text-white">{stateCode}</span>
                                  <span className="text-white">{US_STATES_TAX_INFO[stateCode]?.name || stateCode}</span>
                                </div>
                              </td>
                              <td className="p-3 text-slate-300">{period}</td>
                              <td className="p-3 text-right text-emerald-400 font-semibold">{formatCurrency(data.amount || 0)}</td>
                              <td className="p-3 text-slate-400 font-mono text-xs">{data.taxFilingConfirmNumationNum || data.confirmationNum || '-'}</td>
                              <td className="p-3 text-slate-400">{data.filedDate ? new Date(data.filedDate).toLocaleDateString() : '-'}</td>
                              <td className="p-3 text-slate-500 text-xs max-w-[200px] truncate">{data.notes || '-'}</td>
                            </tr>
                          ))
                      )}
                  </tbody>
                </table>
              </div>
              {/* Totals by State */}
              <div className="mt-4 pt-4 border-t border-slate-700">
                <h4 className="text-sm font-semibold text-slate-300 mb-3">Total Paid by State</h4>
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                  {Object.entries(filingHistory || {}).map(([stateCode, periods]) => {
                    const total = Object.values(periods || {}).reduce((sum, p) => sum + (p.amount || 0), 0);
                    const count = Object.keys(periods || {}).length;
                    return (
                      <div key={stateCode} className="bg-slate-900/50 rounded-lg p-3">
                        <div className="flex items-center justify-between mb-1">
                          <span className="text-xs font-bold text-slate-400">{stateCode}</span>
                          <span className="text-xs text-slate-500">{count} filings</span>
                        </div>
                        <p className="text-lg font-bold text-emerald-400">{formatCurrency(total)}</p>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}
          
          {/* Economic Nexus Reference Guide */}
          <div className="mt-6 bg-slate-800/50 rounded-2xl border border-slate-700 p-5">
            <h3 className="text-lg font-semibold text-white mb-2">Economic Nexus Quick Reference</h3>
            <p className="text-slate-400 text-sm mb-4">Remote seller thresholds that trigger sales tax collection requirements (post-Wayfair)</p>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
              {/* High Threshold States */}
              <div className="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-4">
                <h4 className="text-emerald-400 font-semibold mb-2 flex items-center gap-2"><Check className="w-4 h-4" />High Threshold ($500K+)</h4>
                <div className="text-sm text-slate-300 space-y-1">
                  <p><span className="text-white font-medium">California:</span> $500K sales</p>
                  <p><span className="text-white font-medium">New York:</span> $500K + 100 transactions</p>
                  <p><span className="text-white font-medium">Texas:</span> $500K sales</p>
                </div>
              </div>
              
              {/* Standard Threshold States */}
              <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 className="text-blue-400 font-semibold mb-2 flex items-center gap-2"><AlertTriangle className="w-4 h-4" />Standard Threshold ($100K)</h4>
                <p className="text-slate-400 text-sm">Most states: $100K sales OR 200 transactions (some states removed transaction threshold)</p>
              </div>
              
              {/* Special Cases */}
              <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4">
                <h4 className="text-amber-400 font-semibold mb-2 flex items-center gap-2"><AlertTriangle className="w-4 h-4" />Special Requirements</h4>
                <div className="text-sm text-slate-300 space-y-1">
                  <p><span className="text-white font-medium">Colorado:</span> Home-rule cities separate</p>
                  <p><span className="text-white font-medium">Louisiana:</span> Parish filing required</p>
                  <p><span className="text-white font-medium">Alaska:</span> Local only (ARSSTC)</p>
                </div>
              </div>
            </div>
            
            {/* SST Member States */}
            <div className="bg-slate-900/50 rounded-xl p-4">
              <h4 className="text-slate-300 font-semibold mb-2">Streamlined Sales Tax (SST) Member States</h4>
              <p className="text-slate-500 text-xs mb-2">These states offer simplified registration and filing through the SST system</p>
              <div className="flex flex-wrap gap-2">
                {Object.entries(US_STATES_TAX_INFO)
                  .filter(([, info]) => info.sst)
                  .map(([code]) => (
                    <span key={code} className="px-2 py-1 bg-slate-700 rounded text-xs text-slate-300">{code}</span>
                  ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ==================== BANKING VIEW ====================
  if (view === 'banking') {
    const now = new Date();
    const sortedTxns = [...(bankingData.transactions || [])].sort((a, b) => b.date.localeCompare(a.date));
    const categories = bankingData.categories || {};
    const accounts = bankingData.accounts || {};
    const monthlySnapshots = bankingData.monthlySnapshots || {};
    
    // Calculate date filter
    const getDateFilter = () => {
      const today = new Date();
      switch (bankingDateRange) {
        case 'week': return new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        case 'month': return new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        case 'quarter': return new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1).toISOString().split('T')[0];
        case 'ytd': return `${today.getFullYear()}-01-01`;
        case 'year': return new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        default: return '1900-01-01';
      }
    };
    const dateFilter = getDateFilter();
    const filteredTxns = sortedTxns.filter(t => t.date >= dateFilter);
    
    // Calculate totals
    const totalIncome = filteredTxns.filter(t => t.isIncome).reduce((s, t) => s + t.amount, 0);
    const totalExpenses = filteredTxns.filter(t => t.isExpense).reduce((s, t) => s + t.amount, 0);
    const netCashFlow = totalIncome - totalExpenses;
    
    // Group by category for filtered transactions
    const expensesByCategory = {};
    const incomeByCategory = {};
    filteredTxns.forEach(t => {
      if (t.isExpense) {
        if (!expensesByCategory[t.topCategory]) expensesByCategory[t.topCategory] = 0;
        expensesByCategory[t.topCategory] += t.amount;
      } else if (t.isIncome) {
        if (!incomeByCategory[t.topCategory]) incomeByCategory[t.topCategory] = 0;
        incomeByCategory[t.topCategory] += t.amount;
      }
    });
    
    // Sort categories by amount - ALL categories for detailed tabs
    const topExpenseCategories = Object.entries(expensesByCategory).sort((a, b) => b[1] - a[1]);
    const topIncomeCategories = Object.entries(incomeByCategory).sort((a, b) => b[1] - a[1]);
    
    // ==================== RECURRING EXPENSE DETECTION ====================
    // Detect recurring expenses by looking for same vendor + similar amount across multiple months
    // AND by looking for exact same dollar amounts appearing in multiple months
    const detectRecurringExpenses = () => {
      // APPROACH 1: Group all expenses by vendor (from description) and track monthly occurrences
      const vendorPatterns = {};
      
      // APPROACH 2: Group by exact dollar amount to catch recurring charges
      const amountPatterns = {};
      
      // Process all expenses
      sortedTxns.filter(t => t.isExpense && t.amount > 10).forEach(t => {
        // Extract vendor from description (first part before common separators)
        const desc = (t.description || '').toUpperCase();
        const vendor = desc.split(/\s+(PAYMENT|AUTOPAY|ACH|DEBIT|BILL|#|\d{4,})/)[0].trim().substring(0, 40);
        const month = t.date.substring(0, 7); // YYYY-MM
        
        // Track by vendor
        if (vendor && vendor.length >= 3) {
          const key = vendor;
          if (!vendorPatterns[key]) {
            vendorPatterns[key] = {
              vendor: vendor,
              category: t.topCategory,
              months: {},
              amounts: [],
              descriptions: new Set(),
              txnIds: [],
            };
          }
          
          if (!vendorPatterns[key].months[month]) {
            vendorPatterns[key].months[month] = { total: 0, count: 0, amounts: [] };
          }
          vendorPatterns[key].months[month].total += t.amount;
          vendorPatterns[key].months[month].count++;
          vendorPatterns[key].months[month].amounts.push(t.amount);
          vendorPatterns[key].amounts.push(t.amount);
          vendorPatterns[key].descriptions.add(t.description?.substring(0, 50));
          vendorPatterns[key].txnIds.push(t.id);
        }
        
        // Track by exact amount (for subscriptions that may have different descriptions)
        const amountKey = t.amount.toFixed(2);
        if (!amountPatterns[amountKey]) {
          amountPatterns[amountKey] = {
            amount: t.amount,
            months: {},
            vendors: new Set(),
            descriptions: new Set(),
            category: t.topCategory,
            txnIds: [],
          };
        }
        if (!amountPatterns[amountKey].months[month]) {
          amountPatterns[amountKey].months[month] = { count: 0, dates: [] };
        }
        amountPatterns[amountKey].months[month].count++;
        amountPatterns[amountKey].months[month].dates.push(t.date);
        amountPatterns[amountKey].vendors.add(vendor || 'Unknown');
        amountPatterns[amountKey].descriptions.add(t.description?.substring(0, 50));
        amountPatterns[amountKey].txnIds.push(t.id);
      });
      
      // Analyze patterns
      const recurring = [];
      const allMonths = [...new Set(sortedTxns.map(t => t.date.substring(0, 7)))].sort();
      const recentMonths = allMonths.slice(-6); // Look at last 6 months
      const usedKeys = new Set(); // Prevent duplicates
      
      // VENDOR-BASED DETECTION (original approach)
      Object.entries(vendorPatterns).forEach(([key, pattern]) => {
        const monthsWithCharges = Object.keys(pattern.months).filter(m => recentMonths.includes(m));
        if (monthsWithCharges.length < 2) return; // Need at least 2 months
        
        // Calculate typical monthly amount (median to avoid outliers)
        const monthlyAmounts = monthsWithCharges.map(m => pattern.months[m].total).sort((a, b) => a - b);
        const medianAmount = monthlyAmounts[Math.floor(monthlyAmounts.length / 2)];
        
        // Check consistency - amounts should be within 30% of median (relaxed from 20%)
        const isConsistent = monthlyAmounts.every(a => Math.abs(a - medianAmount) / medianAmount < 0.3);
        
        // Calculate average amount
        const avgAmount = monthlyAmounts.reduce((s, a) => s + a, 0) / monthlyAmounts.length;
        
        // Include if appears in 2+ months with any amount > $25
        if (avgAmount >= 25 && monthsWithCharges.length >= 2) {
          const isConfirmed = confirmedRecurring[key]?.confirmed;
          const isIgnored = confirmedRecurring[key]?.ignored || confirmedRecurring[key]?.notRecurring;
          
          usedKeys.add(key);
          recurring.push({
            key,
            vendor: pattern.vendor,
            category: pattern.category,
            monthlyAmount: Math.round(avgAmount),
            frequency: monthsWithCharges.length,
            totalMonths: recentMonths.length,
            consistency: isConsistent ? 'high' : 'medium',
            description: [...pattern.descriptions][0] || pattern.vendor,
            confirmed: isConfirmed || false,
            ignored: isIgnored || false,
            annualCost: Math.round(avgAmount * 12),
            detectionType: 'vendor',
          });
        }
      });
      
      // EXACT AMOUNT DETECTION (new approach for subscriptions with varying descriptions)
      Object.entries(amountPatterns).forEach(([amountKey, pattern]) => {
        const monthsWithCharges = Object.keys(pattern.months).filter(m => recentMonths.includes(m));
        if (monthsWithCharges.length < 2) return; // Need at least 2 months
        
        // Skip small amounts
        if (pattern.amount < 10) return;
        
        // Check if this is truly recurring (same amount, appears once per month typically)
        const avgChargesPerMonth = monthsWithCharges.reduce((s, m) => s + pattern.months[m].count, 0) / monthsWithCharges.length;
        
        // Only flag if it's roughly once per month (1-2 charges) and appears consistently
        if (avgChargesPerMonth > 3) return; // Too many charges, probably not a subscription
        
        // Create a unique key combining amount and first vendor
        const vendorList = [...pattern.vendors];
        const primaryVendor = vendorList[0] || 'Unknown';
        const key = `AMOUNT_${amountKey}_${primaryVendor.substring(0, 10)}`;
        
        // Skip if we already have this from vendor detection
        if (usedKeys.has(primaryVendor)) return;
        
        const isConfirmed = confirmedRecurring[key]?.confirmed;
        const isIgnored = confirmedRecurring[key]?.ignored || confirmedRecurring[key]?.notRecurring;
        
        recurring.push({
          key,
          vendor: vendorList.length > 1 ? `${primaryVendor} (+${vendorList.length - 1} more)` : primaryVendor,
          category: pattern.category,
          monthlyAmount: Math.round(pattern.amount),
          frequency: monthsWithCharges.length,
          totalMonths: recentMonths.length,
          consistency: 'exact', // Exact same amount
          description: [...pattern.descriptions][0] || `$${pattern.amount.toFixed(2)} charge`,
          confirmed: isConfirmed || false,
          ignored: isIgnored || false,
          annualCost: Math.round(pattern.amount * 12),
          detectionType: 'amount',
        });
      });
      
      // ADD MANUALLY FLAGGED TRANSACTIONS as recurring
      Object.entries(confirmedRecurring).forEach(([key, data]) => {
        if (data.flaggedFromTxn && data.confirmed && !data.manual) {
          // This was flagged from a transaction
          recurring.push({
            key,
            vendor: data.vendor || key,
            category: data.category || 'Flagged',
            monthlyAmount: data.amount || 0,
            frequency: 12, // Assume monthly
            totalMonths: 12,
            consistency: 'flagged',
            description: data.description || data.vendor,
            confirmed: true,
            ignored: false,
            annualCost: (data.amount || 0) * 12,
            detectionType: 'flagged',
          });
        }
      });
      
      // Sort by annual cost
      return recurring.sort((a, b) => b.annualCost - a.annualCost);
    };
    
    const detectedRecurring = detectRecurringExpenses();
    
    // Get manually added recurring expenses
    const manualRecurring = Object.entries(confirmedRecurring)
      .filter(([_, data]) => data.manual && data.confirmed)
      .map(([key, data]) => ({
        key,
        vendor: data.vendor,
        category: data.category,
        monthlyAmount: data.amount,
        annualCost: (data.amount || 0) * 12,
        frequency: 12,
        totalMonths: 12,
        consistency: 'high',
        description: data.notes || data.vendor,
        confirmed: true,
        manual: true,
      }));
    
    const confirmedRecurringList = [
      ...detectedRecurring.filter(r => r.confirmed && r.monthlyAmount > 0),
      ...manualRecurring.filter(r => r.monthlyAmount > 0),
    ];
    const pendingRecurringList = detectedRecurring.filter(r => !r.confirmed && !r.ignored && r.monthlyAmount > 0);
    const totalMonthlyRecurring = confirmedRecurringList.reduce((s, r) => s + (r.monthlyAmount || 0), 0);
    const totalAnnualRecurring = totalMonthlyRecurring * 12;
    
    // Calculate EOY projection using recurring expenses
    const today = new Date();
    const currentMonth = today.getMonth(); // 0-11
    const remainingMonths = 12 - currentMonth - 1; // Months left in year (not counting current)
    const projectedRecurringCosts = totalMonthlyRecurring * remainingMonths;
    
    // Get period label for headers
    const getPeriodLabel = () => {
      switch (bankingDateRange) {
        case 'week': return 'Last 7 Days';
        case 'month': return 'This Month';
        case 'quarter': return 'This Quarter';
        case 'ytd': return 'Year to Date';
        case 'year': return 'Last 12 Months';
        default: return 'All Time';
      }
    };
    const periodLabel = getPeriodLabel();
    
    // Check if data is stale
    const isDataStale = !bankingData.lastUpload || 
      new Date().toDateString() !== new Date(bankingData.lastUpload).toDateString();
    
    // Monthly trend data
    const monthKeys = Object.keys(monthlySnapshots).sort().slice(-12);
    
    // Handle file upload
    const handleBankingUpload = async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      
      setBankingProcessing(true);
      try {
        const content = await file.text();
        // Pass existing category overrides to parser
        const parsed = parseQBOTransactions(content, bankingData.categoryOverrides || {});
        
        if (parsed.transactions.length === 0) {
          setToast({ message: 'No transactions found in file', type: 'error' });
          setBankingProcessing(false);
          return;
        }
        
        // Smart merge: deduplicate transactions based on ID
        let mergedTransactions = parsed.transactions;
        let newCount = parsed.transactions.length;
        let duplicateCount = 0;
        
        if (bankingData.transactions?.length > 0) {
          const existingIds = new Set(bankingData.transactions.map(t => t.id));
          const newTxns = parsed.transactions.filter(t => !existingIds.has(t.id));
          duplicateCount = parsed.transactions.length - newTxns.length;
          
          // Merge: keep existing transactions, add only new ones
          // Sort by date to maintain chronological order
          mergedTransactions = [...bankingData.transactions, ...newTxns]
            .sort((a, b) => b.date.localeCompare(a.date));
          newCount = newTxns.length;
        }
        
        // Recalculate all aggregates from merged transactions
        const accounts = {};
        const categories = {};
        const monthlySnapshots = {};
        
        // Track net change from new transactions for each account
        const newTxnNetByAccount = {};
        
        mergedTransactions.forEach(txn => {
          // Account aggregates
          if (!accounts[txn.account]) {
            // Start with existing balance if we have prior data, otherwise use parsed balance
            const existingBalance = bankingData.accounts?.[txn.account]?.balance;
            const existingInitialBalance = bankingData.accounts?.[txn.account]?.initialBalance;
            accounts[txn.account] = { 
              name: txn.account, 
              type: txn.accountType, 
              transactions: 0, 
              totalIn: 0, 
              totalOut: 0,
              // Preserve initial balance if set, or use existing balance as starting point
              initialBalance: existingInitialBalance ?? existingBalance ?? 0,
              balance: existingBalance ?? parsed.accounts[txn.account]?.balance ?? 0,
            };
          }
          accounts[txn.account].transactions++;
          if (txn.isIncome) accounts[txn.account].totalIn += txn.amount;
          if (txn.isExpense) accounts[txn.account].totalOut += txn.amount;
          
          // Category aggregates
          const cat = txn.topCategory || 'Uncategorized';
          if (!categories[cat]) categories[cat] = { totalIn: 0, totalOut: 0, count: 0, subcategories: {} };
          categories[cat].count++;
          if (txn.isIncome) categories[cat].totalIn += txn.amount;
          if (txn.isExpense) categories[cat].totalOut += txn.amount;
          
          // Monthly snapshots
          const month = txn.date.substring(0, 7);
          if (!monthlySnapshots[month]) monthlySnapshots[month] = { income: 0, expenses: 0, net: 0, transactions: 0 };
          monthlySnapshots[month].transactions++;
          if (txn.isIncome) {
            monthlySnapshots[month].income += txn.amount;
            monthlySnapshots[month].net += txn.amount;
          }
          if (txn.isExpense) {
            monthlySnapshots[month].expenses += txn.amount;
            monthlySnapshots[month].net -= txn.amount;
          }
        });
        
        // Update account balances properly:
        // - If balance was manually set, preserve it and add net of new transactions
        // - If we had existing data, add the NET of new transactions to existing balance
        // - If this is first upload, use parsed balance from QBO
        if (bankingData.transactions?.length > 0 && newCount > 0) {
          // Calculate net change from NEW transactions only
          const newTxns = parsed.transactions.filter(t => !new Set(bankingData.transactions.map(bt => bt.id)).has(t.id));
          const netByAccount = {};
          newTxns.forEach(txn => {
            if (!netByAccount[txn.account]) netByAccount[txn.account] = 0;
            if (txn.isIncome) netByAccount[txn.account] += txn.amount;
            if (txn.isExpense) netByAccount[txn.account] -= txn.amount;
          });
          
          // Apply net change to existing balances
          Object.entries(netByAccount).forEach(([acctName, netChange]) => {
            if (accounts[acctName]) {
              const existingBal = bankingData.accounts?.[acctName]?.balance || 0;
              const wasManuallySet = bankingData.accounts?.[acctName]?.balanceManuallySet;
              accounts[acctName].balance = existingBal + netChange;
              // Preserve manual set flag
              if (wasManuallySet) {
                accounts[acctName].balanceManuallySet = true;
                accounts[acctName].balanceSetDate = bankingData.accounts[acctName].balanceSetDate;
              }
            }
          });
        } else {
          // First upload - use parsed balances (net of transactions in report)
          // User may need to set initial balance manually
          Object.entries(parsed.accounts).forEach(([name, acct]) => {
            if (accounts[name]) {
              accounts[name].balance = acct.balance || 0;
            }
          });
        }
        
        // Calculate date range
        const dates = mergedTransactions.map(t => t.date).sort();
        const dateRange = { 
          start: dates[0], 
          end: dates[dates.length - 1] 
        };
        
        const newBankingData = {
          transactions: mergedTransactions,
          accounts,
          categories,
          monthlySnapshots,
          dateRange,
          transactionCount: mergedTransactions.length,
          lastUpload: new Date().toISOString(),
          categoryOverrides: bankingData.categoryOverrides || {},
          settings: bankingData.settings,
        };
        
        setBankingData(newBankingData);
        localStorage.setItem('ecommerce_banking_v1', JSON.stringify(newBankingData));
        queueCloudSave({ ...combinedData, bankingData: newBankingData });
        
        const message = duplicateCount > 0 
          ? `Added ${newCount} new transactions (${duplicateCount} duplicates skipped). Total: ${mergedTransactions.length}`
          : `Imported ${newCount} transactions from ${dateRange.start} to ${dateRange.end}`;
        setToast({ message, type: 'success' });
      } catch (err) {
        setToast({ message: 'Error parsing file: ' + err.message, type: 'error' });
      }
      setBankingProcessing(false);
      e.target.value = '';
    };
    
    // Handle category override for a transaction
    const handleCategoryChange = (txnId, newCategory) => {
      const newOverrides = { ...bankingData.categoryOverrides, [txnId]: newCategory };
      const newBankingData = {
        ...bankingData,
        categoryOverrides: newOverrides,
      };
      // Re-parse to update category stats (ideally we'd just update the transaction, but this ensures consistency)
      // For now just update the override and let next upload recalculate
      setBankingData(newBankingData);
      localStorage.setItem('ecommerce_banking_v1', JSON.stringify(newBankingData));
      queueCloudSave({ ...combinedData, bankingData: newBankingData });
      setToast({ message: 'Category updated', type: 'success' });
    };
    
    return (
      <div className={`min-h-screen ${theme === 'light' ? 'bg-gray-100' : 'bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900'}`}>
        <NavTabs />
        <div className="max-w-7xl mx-auto px-4 py-6">
          <Toast />{aiChatUI}{aiChatButton}
          {/* Header */}
          <div className="flex flex-wrap items-center justify-between gap-4 mb-6">
            <div>
              <h1 className="text-2xl lg:text-3xl font-bold text-white flex items-center gap-3">
                <Landmark className="w-8 h-8 text-green-400" />
                Banking & Cash Flow
              </h1>
              <p className="text-slate-400 mt-1">
                {bankingData.lastUpload 
                  ? `Last updated: ${new Date(bankingData.lastUpload).toLocaleString()}`
                  : 'Upload your QBO transaction export to get started'}
                {bankingData.transactions?.length > 0 && ` â€¢ ${bankingData.transactions.length} transactions`}
              </p>
            </div>
            
            <div className="flex items-center gap-3">
              {/* Stale Data Alert */}
              {isDataStale && bankingData.transactions?.length > 0 && (
                <div className="px-3 py-2 bg-amber-500/20 border border-amber-500/50 rounded-lg text-amber-300 text-sm flex items-center gap-2">
                  <AlertTriangle className="w-4 h-4" />
                  Banking data not uploaded today
                </div>
              )}
              
              {/* Upload Button */}
              <label className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-white font-medium cursor-pointer flex items-center gap-2 transition-colors">
                <Upload className="w-4 h-4" />
                {bankingProcessing ? 'Processing...' : 'Upload QBO Export'}
                <input type="file" accept=".csv" onChange={handleBankingUpload} className="hidden" disabled={bankingProcessing} />
              </label>
            </div>
          </div>
          
          {/* Date Range Selector */}
          <div className="flex flex-wrap items-center gap-2 mb-6">
            {[
              { key: 'week', label: 'Last 7 Days' },
              { key: 'month', label: 'This Month' },
              { key: 'quarter', label: 'This Quarter' },
              { key: 'ytd', label: 'Year to Date' },
              { key: 'year', label: 'Last 12 Months' },
              { key: 'all', label: 'All Time' },
            ].map(r => (
              <button
                key={r.key}
                onClick={() => setBankingDateRange(r.key)}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                  bankingDateRange === r.key 
                    ? 'bg-green-600 text-white' 
                    : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                }`}
              >
                {r.label}
              </button>
            ))}
          </div>
          
          {bankingData.transactions?.length === 0 ? (
            /* Empty State */
            <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-12 text-center">
              <Landmark className="w-16 h-16 text-slate-600 mx-auto mb-4" />
              <h2 className="text-xl font-semibold text-white mb-2">No Banking Data Yet</h2>
              <p className="text-slate-400 mb-6 max-w-md mx-auto">
                Upload your QuickBooks Online Transaction Detail by Account report to analyze your cash flow, expenses, and profitability.
              </p>
              <label className="px-6 py-3 bg-green-600 hover:bg-green-500 rounded-xl text-white font-medium cursor-pointer inline-flex items-center gap-2 transition-colors">
                <Upload className="w-5 h-5" />
                Upload QBO Export (.csv)
                <input type="file" accept=".csv" onChange={handleBankingUpload} className="hidden" />
              </label>
            </div>
          ) : (
            <>
              {/* Key Metrics */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div className="bg-gradient-to-br from-emerald-900/40 to-emerald-800/20 rounded-xl border border-emerald-500/30 p-5">
                  <p className="text-emerald-400 text-sm font-medium mb-1">Total Income</p>
                  <p className="text-2xl font-bold text-white">{formatCurrency(totalIncome)}</p>
                  <p className="text-slate-400 text-xs mt-1">{filteredTxns.filter(t => t.isIncome).length} deposits</p>
                </div>
                <div className="bg-gradient-to-br from-rose-900/40 to-rose-800/20 rounded-xl border border-rose-500/30 p-5">
                  <p className="text-rose-400 text-sm font-medium mb-1">Total Expenses</p>
                  <p className="text-2xl font-bold text-white">{formatCurrency(totalExpenses)}</p>
                  <p className="text-slate-400 text-xs mt-1">{filteredTxns.filter(t => t.isExpense).length} expenses</p>
                </div>
                <div className={`bg-gradient-to-br ${netCashFlow >= 0 ? 'from-blue-900/40 to-blue-800/20 border-blue-500/30' : 'from-amber-900/40 to-amber-800/20 border-amber-500/30'} rounded-xl border p-5`}>
                  <p className={`${netCashFlow >= 0 ? 'text-blue-400' : 'text-amber-400'} text-sm font-medium mb-1`}>Net Cash Flow</p>
                  <p className="text-2xl font-bold text-white">{formatCurrency(netCashFlow)}</p>
                  <p className="text-slate-400 text-xs mt-1">{((netCashFlow / (totalIncome || 1)) * 100).toFixed(1)}% margin</p>
                </div>
                <div className="bg-gradient-to-br from-violet-900/40 to-violet-800/20 rounded-xl border border-violet-500/30 p-5">
                  <p className="text-violet-400 text-sm font-medium mb-1">Avg Monthly Profit</p>
                  <p className="text-2xl font-bold text-white">
                    {formatCurrency(monthKeys.length > 0 ? monthKeys.reduce((s, m) => s + (monthlySnapshots[m]?.net || 0), 0) / monthKeys.length : 0)}
                  </p>
                  <p className="text-slate-400 text-xs mt-1">Last {monthKeys.length} months</p>
                </div>
              </div>
              
              {/* Account Balances - CFO Summary */}
              {Object.keys(bankingData.accounts || {}).length > 0 && (() => {
                // Filter to only show real bank accounts (more flexible pattern matching)
                const realAccts = Object.entries(bankingData.accounts).filter(([name, acct]) => {
                  // Skip if name looks corrupted (has quotes or is super long)
                  if (name.includes('"')) return false;
                  if (name.length > 100) return false;
                  // Skip if balance is undefined, NaN, or zero (likely junk)
                  if (acct.balance === undefined || isNaN(acct.balance)) return false;
                  if (Math.abs(acct.balance) < 0.01) return false; // Skip $0 balances
                  // Skip if name looks like a transaction description (has commas before account pattern)
                  if (name.includes(',') && !/\(\d{4}\)/.test(name)) return false;
                  // Skip if name contains common transaction words
                  const lower = name.toLowerCase();
                  if (lower.includes('water') || lower.includes('filter') || lower.includes('purchase')) return false;
                  // Accept accounts that have a balance and reasonable name
                  // Look for patterns like: account number in parens, or common bank terms
                  const looksLikeAccount = (
                    /\(\d{4}\)/.test(name) || // Has (1234) pattern
                    (lower.includes('checking') && !name.includes(',')) ||
                    (lower.includes('savings') && !name.includes(',')) ||
                    (lower.includes('operations') && !name.includes(',')) ||
                    (lower.includes('card') && /\(\d{4}\)/.test(name)) || // Card with account number
                    (lower.includes('credit') && /\(\d{4}\)/.test(name)) ||
                    lower.includes('amex') ||
                    lower.includes('chase') ||
                    lower.includes('bank') ||
                    lower.includes('capital') ||
                    acct.type === 'credit_card' // Explicitly marked as credit card
                  );
                  return looksLikeAccount;
                });
                const checkingAccts = realAccts.filter(([_, a]) => a.type !== 'credit_card');
                const creditAccts = realAccts.filter(([_, a]) => a.type === 'credit_card');
                const totalCash = checkingAccts.reduce((s, [_, a]) => s + (a.balance || 0), 0);
                const totalDebt = creditAccts.reduce((s, [_, a]) => s + (a.balance || 0), 0);
                const netPosition = totalCash - totalDebt;
                
                if (realAccts.length === 0) return null;
                
                return (
                  <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 mb-6">
                    {/* Summary Row */}
                    <div className="grid grid-cols-3 gap-4 mb-4 pb-4 border-b border-slate-700">
                      <div className="text-center">
                        <p className="text-emerald-400 text-xs font-medium mb-1">ðŸ’µ Cash Available</p>
                        <p className="text-2xl font-bold text-emerald-400">{formatCurrency(totalCash)}</p>
                      </div>
                      <div className="text-center">
                        <p className="text-rose-400 text-xs font-medium mb-1">ðŸ’³ Credit Card Debt</p>
                        <p className="text-2xl font-bold text-rose-400">{formatCurrency(totalDebt)}</p>
                      </div>
                      <div className="text-center">
                        <p className="text-slate-400 text-xs font-medium mb-1">ðŸ“Š Net Position</p>
                        <p className={`text-2xl font-bold ${netPosition >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(netPosition)}</p>
                      </div>
                    </div>
                    
                    {/* Individual Accounts */}
                    <div className="space-y-2">
                      {realAccts.map(([name, acct]) => {
                        const isCard = acct.type === 'credit_card';
                        const balance = acct.balance || 0;
                        const shortName = name.split('(')[0].trim();
                        return (
                          <div key={name} className="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-0">
                            <div className="flex items-center gap-2">
                              {isCard ? <CreditCard className="w-4 h-4 text-rose-400" /> : <Wallet className="w-4 h-4 text-emerald-400" />}
                              <span className="text-white text-sm">{shortName}</span>
                              <span className="text-slate-500 text-xs">({acct.transactions} txns)</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className={`font-bold ${isCard ? 'text-rose-400' : 'text-emerald-400'}`}>
                                {formatCurrency(balance)}
                              </span>
                              <button
                                onClick={() => setEditingAccountBalance({ name, balance: Math.abs(balance), isCard })}
                                className="p-1 text-slate-500 hover:text-white hover:bg-slate-700 rounded transition-colors"
                                title="Edit balance"
                              >
                                <Settings className="w-3.5 h-3.5" />
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    <p className="text-xs text-slate-500 mt-3 text-center">
                      Click âš™ï¸ to manually correct balances â€¢ Re-upload QBO for latest transactions
                    </p>
                  </div>
                );
              })()}
              
              {/* Tabs */}
              <div className="flex gap-2 mb-6 border-b border-slate-700 pb-2 overflow-x-auto">
                {[
                  { key: 'overview', label: 'Overview', icon: BarChart3 },
                  { key: 'cfo', label: 'CFO Dashboard', icon: Target },
                  { key: 'cards', label: 'Credit Cards', icon: CreditCard },
                  { key: 'recurring', label: 'Recurring', icon: RefreshCw },
                  { key: 'expenses', label: 'Expenses', icon: TrendingDown },
                  { key: 'income', label: 'Income', icon: Wallet },
                  { key: 'trends', label: 'Trends', icon: TrendingUp },
                  { key: 'transactions', label: 'Transactions', icon: FileText },
                ].map(tab => (
                  <button
                    key={tab.key}
                    onClick={() => { setBankingTab(tab.key); setBankingDrilldown(null); }}
                    className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors whitespace-nowrap ${
                      bankingTab === tab.key 
                        ? 'bg-green-600 text-white' 
                        : 'text-slate-400 hover:text-white hover:bg-slate-700'
                    }`}
                  >
                    <tab.icon className="w-4 h-4" />
                    {tab.label}
                  </button>
                ))}
              </div>
              
              {/* Overview Tab */}
              {bankingTab === 'overview' && (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Top Expenses */}
                  <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                    <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                      <CreditCard className="w-5 h-5 text-rose-400" />
                      Top Expenses â€” {periodLabel}
                    </h3>
                    <div className="space-y-3">
                      {topExpenseCategories.length === 0 ? (
                        <p className="text-slate-500 text-sm">No expenses in this period</p>
                      ) : topExpenseCategories.slice(0, 8).map(([cat, amount], i) => (
                        <div 
                          key={cat} 
                          className="flex items-center gap-3 cursor-pointer hover:bg-slate-700/30 rounded-lg p-1 -mx-1 transition-colors"
                          onClick={() => { setBankingTab('expenses'); setBankingDrilldown({ category: cat, type: 'expense' }); }}
                        >
                          <div className="w-6 text-slate-500 text-sm">{i + 1}</div>
                          <div className="flex-1">
                            <div className="flex justify-between text-sm mb-1">
                              <span className="text-white truncate flex items-center gap-1">
                                {cat}
                                <ChevronRight className="w-3 h-3 text-slate-500" />
                              </span>
                              <span className="text-rose-400 font-medium">{formatCurrency(amount)}</span>
                            </div>
                            <div className="w-full h-1.5 bg-slate-700 rounded-full overflow-hidden">
                              <div 
                                className="h-full bg-rose-500/70 rounded-full"
                                style={{ width: `${(amount / (topExpenseCategories[0]?.[1] || 1)) * 100}%` }}
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {/* Top Income */}
                  <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                    <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                      <Wallet className="w-5 h-5 text-emerald-400" />
                      Top Income â€” {periodLabel}
                    </h3>
                    <div className="space-y-3">
                      {topIncomeCategories.length === 0 ? (
                        <p className="text-slate-500 text-sm">No income in this period</p>
                      ) : topIncomeCategories.slice(0, 8).map(([cat, amount], i) => (
                        <div 
                          key={cat} 
                          className="flex items-center gap-3 cursor-pointer hover:bg-slate-700/30 rounded-lg p-1 -mx-1 transition-colors"
                          onClick={() => { setBankingTab('income'); setBankingDrilldown({ category: cat, type: 'income' }); }}
                        >
                          <div className="w-6 text-slate-500 text-sm">{i + 1}</div>
                          <div className="flex-1">
                            <div className="flex justify-between text-sm mb-1">
                              <span className="text-white truncate flex items-center gap-1">
                                {cat}
                                <ChevronRight className="w-3 h-3 text-slate-500" />
                              </span>
                              <span className="text-emerald-400 font-medium">{formatCurrency(amount)}</span>
                            </div>
                            <div className="w-full h-1.5 bg-slate-700 rounded-full overflow-hidden">
                              <div 
                                className="h-full bg-emerald-500/70 rounded-full"
                                style={{ width: `${(amount / (topIncomeCategories[0]?.[1] || 1)) * 100}%` }}
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {/* Monthly Cash Flow Chart */}
                  <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5 lg:col-span-2">
                    <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                      <TrendingUp className="w-5 h-5 text-blue-400" />
                      Monthly Cash Flow Trend
                    </h3>
                    {monthKeys.length > 0 && (() => {
                      const maxVal = Math.max(...monthKeys.map(m => Math.max(monthlySnapshots[m]?.income || 0, monthlySnapshots[m]?.expenses || 0)), 1);
                      return (
                        <>
                          <div className="flex items-end gap-1 h-48">
                            {monthKeys.map((m, i) => {
                              const snap = monthlySnapshots[m];
                              const incomeHeight = ((snap?.income || 0) / maxVal) * 100;
                              const expenseHeight = ((snap?.expenses || 0) / maxVal) * 100;
                              return (
                                <div key={m} className="flex-1 flex flex-col items-center group relative">
                                  <div className="absolute -top-12 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-700 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-50 shadow-lg">
                                    {new Date(m + '-01').toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}<br/>
                                    In: {formatCurrency(snap?.income || 0)}<br/>
                                    Out: {formatCurrency(snap?.expenses || 0)}<br/>
                                    Net: <span className={snap?.net >= 0 ? 'text-emerald-400' : 'text-rose-400'}>{formatCurrency(snap?.net || 0)}</span>
                                  </div>
                                  <div className="w-full flex gap-0.5 items-end h-40">
                                    <div className="flex-1 bg-emerald-500/70 rounded-t transition-all" style={{ height: `${incomeHeight}%`, minHeight: incomeHeight > 0 ? '4px' : '0' }} />
                                    <div className="flex-1 bg-rose-500/70 rounded-t transition-all" style={{ height: `${expenseHeight}%`, minHeight: expenseHeight > 0 ? '4px' : '0' }} />
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                          <div className="flex gap-1 mt-2">
                            {monthKeys.map(m => (
                              <div key={m} className="flex-1 text-center text-[10px] text-slate-500">
                                {new Date(m + '-01').toLocaleDateString('en-US', { month: 'short' })}
                              </div>
                            ))}
                          </div>
                          <div className="flex justify-center gap-6 mt-3 text-xs">
                            <span className="flex items-center gap-2"><span className="w-3 h-3 bg-emerald-500 rounded" />Income</span>
                            <span className="flex items-center gap-2"><span className="w-3 h-3 bg-rose-500 rounded" />Expenses</span>
                          </div>
                        </>
                      );
                    })()}
                  </div>
                </div>
              )}
              
              {/* Recurring Expenses Tab */}
              {bankingTab === 'recurring' && (
                <div className="space-y-6">
                  {/* Header with Add Button */}
                  <div className="flex items-center justify-between">
                    <div className="bg-slate-800/30 rounded-lg p-3 text-sm text-slate-400 flex-1 mr-4">
                      {(() => {
                        const allMonths = [...new Set(sortedTxns.map(t => t.date.substring(0, 7)))].sort();
                        const expenseCount = sortedTxns.filter(t => t.isExpense).length;
                        return (
                          <>
                            ðŸ“Š Analyzing {expenseCount} expense transactions across {allMonths.length} months 
                            ({allMonths.length > 0 ? `${allMonths[0]} to ${allMonths[allMonths.length - 1]}` : 'no data'})
                            {detectedRecurring.length > 0 && ` â€¢ Found ${detectedRecurring.length} potential recurring expenses`}
                          </>
                        );
                      })()}
                    </div>
                    <button
                      onClick={() => { setRecurringForm({ vendor: '', category: '', amount: '', notes: '' }); setShowAddRecurring(true); }}
                      className="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white text-sm flex items-center gap-2"
                    >
                      <Plus className="w-4 h-4" />
                      Add Manual
                    </button>
                  </div>
                  
                  {/* Manual Add Recurring Modal */}
                  {showAddRecurring && (
                    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                      <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full">
                        <h3 className="text-lg font-semibold text-white mb-4">Add Recurring Expense</h3>
                        <p className="text-slate-400 text-sm mb-4">Manually add a recurring expense that wasn't auto-detected (e.g., agency retainers, subscriptions).</p>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm text-slate-400 mb-1">Vendor / Description</label>
                            <input 
                              type="text" 
                              value={recurringForm.vendor} 
                              onChange={(e) => setRecurringForm(f => ({ ...f, vendor: e.target.value }))}
                              placeholder="e.g., Marketing Agency, Software Subscription"
                              className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white"
                            />
                          </div>
                          <div>
                            <label className="block text-sm text-slate-400 mb-1">Category</label>
                            <select
                              value={recurringForm.category}
                              onChange={(e) => setRecurringForm(f => ({ ...f, category: e.target.value }))}
                              className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white"
                            >
                              <option value="">Select category...</option>
                              <option value="Marketing">Marketing</option>
                              <option value="Software & Subscriptions">Software & Subscriptions</option>
                              <option value="Professional Services">Professional Services</option>
                              <option value="Insurance">Insurance</option>
                              <option value="Utilities">Utilities</option>
                              <option value="Rent">Rent</option>
                              <option value="Payroll">Payroll</option>
                              <option value="Other">Other</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm text-slate-400 mb-1">Monthly Amount ($)</label>
                            <input 
                              type="number" 
                              value={recurringForm.amount} 
                              onChange={(e) => setRecurringForm(f => ({ ...f, amount: e.target.value }))}
                              placeholder="3000"
                              className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white"
                            />
                          </div>
                          <div>
                            <label className="block text-sm text-slate-400 mb-1">Notes (optional)</label>
                            <input 
                              type="text" 
                              value={recurringForm.notes} 
                              onChange={(e) => setRecurringForm(f => ({ ...f, notes: e.target.value }))}
                              placeholder="Any additional notes"
                              className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white"
                            />
                          </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                          <button
                            onClick={() => {
                              if (!recurringForm.vendor || !recurringForm.amount) {
                                setToast({ message: 'Vendor and amount are required', type: 'error' });
                                return;
                              }
                              const key = `MANUAL_${recurringForm.vendor.toUpperCase().replace(/\s+/g, '_')}`;
                              setConfirmedRecurring(prev => ({
                                ...prev,
                                [key]: {
                                  confirmed: true,
                                  manual: true,
                                  vendor: recurringForm.vendor,
                                  category: recurringForm.category || 'Other',
                                  amount: parseFloat(recurringForm.amount) || 0,
                                  notes: recurringForm.notes,
                                  addedAt: new Date().toISOString(),
                                }
                              }));
                              setToast({ message: 'Recurring expense added', type: 'success' });
                              setShowAddRecurring(false);
                            }}
                            className="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-semibold py-2 rounded-lg"
                          >
                            Add Recurring
                          </button>
                          <button 
                            onClick={() => setShowAddRecurring(false)}
                            className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 rounded-lg"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Summary Cards */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-gradient-to-br from-purple-900/40 to-purple-800/20 rounded-xl border border-purple-500/30 p-5">
                      <p className="text-purple-400 text-sm font-medium mb-1">Confirmed Monthly Recurring</p>
                      <p className="text-3xl font-bold text-white">{formatCurrency(totalMonthlyRecurring)}</p>
                      <p className="text-slate-400 text-sm mt-1">{confirmedRecurringList.length} recurring expenses</p>
                    </div>
                    <div className="bg-gradient-to-br from-rose-900/40 to-rose-800/20 rounded-xl border border-rose-500/30 p-5">
                      <p className="text-rose-400 text-sm font-medium mb-1">Annual Recurring Cost</p>
                      <p className="text-3xl font-bold text-white">{formatCurrency(totalAnnualRecurring)}</p>
                      <p className="text-slate-400 text-sm mt-1">Fixed costs per year</p>
                    </div>
                    <div className="bg-gradient-to-br from-amber-900/40 to-amber-800/20 rounded-xl border border-amber-500/30 p-5">
                      <p className="text-amber-400 text-sm font-medium mb-1">Remaining This Year</p>
                      <p className="text-3xl font-bold text-white">{formatCurrency(projectedRecurringCosts)}</p>
                      <p className="text-slate-400 text-sm mt-1">{remainingMonths} months Ã— {formatCurrency(totalMonthlyRecurring)}</p>
                    </div>
                  </div>
                  
                  {/* Pending Detection - Needs Confirmation */}
                  {pendingRecurringList.length > 0 && (
                    <div className="bg-slate-800/50 rounded-xl border border-amber-500/30 p-5">
                      <h3 className="text-lg font-semibold text-amber-400 mb-4 flex items-center gap-2">
                        <AlertTriangle className="w-5 h-5" />
                        Detected Recurring Expenses â€” Please Review
                      </h3>
                      <p className="text-slate-400 text-sm mb-4">
                        These expenses appear regularly in your banking data. Confirm which ones are truly recurring to improve EOY projections.
                      </p>
                      <div className="space-y-3">
                        {pendingRecurringList.map(item => (
                          <div key={item.key} className="bg-slate-700/50 rounded-lg p-4 flex items-center justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-3">
                                <p className="text-white font-medium">{item.vendor}</p>
                                <span className={`px-2 py-0.5 rounded text-xs ${
                                  item.consistency === 'high' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'
                                }`}>
                                  {item.consistency === 'high' ? 'Very Consistent' : 'Somewhat Consistent'}
                                </span>
                              </div>
                              <p className="text-slate-400 text-sm mt-1">{item.category} â€¢ Found in {item.frequency} of last {item.totalMonths} months</p>
                            </div>
                            <div className="text-right mr-4">
                              <p className="text-rose-400 font-bold">{formatCurrency(item.monthlyAmount)}/mo</p>
                              <p className="text-slate-500 text-xs">{formatCurrency(item.annualCost)}/year</p>
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={() => setConfirmedRecurring(prev => ({ ...prev, [item.key]: { confirmed: true, amount: item.monthlyAmount } }))}
                                className="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm"
                              >
                                Confirm
                              </button>
                              <button
                                onClick={() => setConfirmedRecurring(prev => ({ ...prev, [item.key]: { ignored: true } }))}
                                className="px-3 py-1.5 bg-slate-600 hover:bg-slate-500 rounded-lg text-white text-sm"
                              >
                                Ignore
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* No recurring detected message */}
                  {pendingRecurringList.length === 0 && confirmedRecurringList.length === 0 && (
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-6 text-center">
                      <RefreshCw className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                      <h3 className="text-lg font-semibold text-white mb-2">No Recurring Expenses Detected</h3>
                      <p className="text-slate-400 text-sm mb-4">
                        To detect recurring expenses, you need at least 2 months of banking data with similar charges appearing in multiple months.
                      </p>
                      <div className="text-slate-500 text-xs space-y-1">
                        <p>Detection criteria: Same vendor, $50+ average, appears in 2+ months of last 6</p>
                        <p>Make sure your QBO export includes multiple months of transaction history</p>
                      </div>
                    </div>
                  )}
                  
                  {/* Confirmed Recurring */}
                  <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                    <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                      <Check className="w-5 h-5 text-emerald-400" />
                      Confirmed Recurring Expenses
                    </h3>
                    {confirmedRecurringList.length > 0 ? (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b border-slate-700">
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Vendor</th>
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Category</th>
                              <th className="text-center text-slate-400 font-medium py-2 px-2">Source</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">Monthly</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">Annual</th>
                              <th className="text-center text-slate-400 font-medium py-2 px-2">Remove</th>
                            </tr>
                          </thead>
                          <tbody>
                            {confirmedRecurringList.map(item => (
                              <tr key={item.key} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                <td className="py-3 px-2 text-white">{item.vendor}</td>
                                <td className="py-3 px-2 text-slate-400">{item.category}</td>
                                <td className="py-3 px-2 text-center">
                                  {item.manual ? (
                                    <span className="px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs">Manual</span>
                                  ) : (
                                    <span className="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded text-xs">Auto-detected</span>
                                  )}
                                </td>
                                <td className="py-3 px-2 text-right text-rose-400 font-medium">{formatCurrency(item.monthlyAmount)}</td>
                                <td className="py-3 px-2 text-right text-slate-300">{formatCurrency(item.annualCost)}</td>
                                <td className="py-3 px-2 text-center">
                                  <button
                                    onClick={() => {
                                      if (item.manual) {
                                        // For manual items, completely remove
                                        setConfirmedRecurring(prev => {
                                          const updated = { ...prev };
                                          delete updated[item.key];
                                          return updated;
                                        });
                                      } else {
                                        // For auto-detected, mark as NOT recurring (ignored)
                                        setConfirmedRecurring(prev => ({
                                          ...prev,
                                          [item.key]: { ignored: true, notRecurring: true }
                                        }));
                                      }
                                      setToast({ message: 'Removed from recurring', type: 'success' });
                                    }}
                                    className="text-slate-500 hover:text-rose-400 p-1"
                                    title={item.manual ? "Delete" : "Mark as NOT recurring"}
                                  >
                                    <X className="w-4 h-4" />
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                          <tfoot>
                            <tr className="border-t-2 border-slate-600">
                              <td className="py-3 px-2 font-bold text-white" colSpan={3}>Total</td>
                              <td className="py-3 px-2 text-right font-bold text-rose-400">{formatCurrency(totalMonthlyRecurring)}</td>
                              <td className="py-3 px-2 text-right font-bold text-white">{formatCurrency(totalAnnualRecurring)}</td>
                              <td></td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    ) : (
                      <div className="text-center py-8">
                        <RefreshCw className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                        <p className="text-slate-400">No confirmed recurring expenses yet.</p>
                        <p className="text-slate-500 text-sm mt-1">Review the detected expenses above and confirm which ones recur monthly.</p>
                      </div>
                    )}
                  </div>
                  
                  {/* Marked as NOT Recurring - ability to undo */}
                  {(() => {
                    const ignoredItems = Object.entries(confirmedRecurring)
                      .filter(([_, data]) => data.ignored || data.notRecurring)
                      .map(([key, data]) => ({ key, ...data }));
                    
                    if (ignoredItems.length === 0) return null;
                    
                    return (
                      <div className="bg-slate-800/30 rounded-xl border border-slate-700/50 p-5">
                        <h3 className="text-md font-medium text-slate-400 mb-3 flex items-center gap-2">
                          <EyeOff className="w-4 h-4" />
                          Marked as NOT Recurring ({ignoredItems.length})
                        </h3>
                        <p className="text-slate-500 text-sm mb-3">These items were marked as not recurring and won't appear in detected expenses.</p>
                        <div className="flex flex-wrap gap-2">
                          {ignoredItems.map(item => (
                            <div key={item.key} className="bg-slate-700/50 rounded-lg px-3 py-2 flex items-center gap-2">
                              <span className="text-slate-400 text-sm">{item.key.replace(/^MANUAL_/, '').replace(/_/g, ' ')}</span>
                              <button
                                onClick={() => setConfirmedRecurring(prev => {
                                  const updated = { ...prev };
                                  delete updated[item.key];
                                  return updated;
                                })}
                                className="text-slate-500 hover:text-emerald-400 p-0.5"
                                title="Undo - allow detection again"
                              >
                                <RefreshCw className="w-3.5 h-3.5" />
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })()}
                  
                  {/* EOY Impact */}
                  <div className="bg-gradient-to-r from-purple-900/30 to-indigo-900/30 rounded-xl border border-purple-500/30 p-5">
                    <h3 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                      <Brain className="w-5 h-5 text-purple-400" />
                      EOY Profit Impact
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-slate-800/50 rounded-lg p-4">
                        <p className="text-slate-400 text-sm mb-1">Known Fixed Costs (Remaining)</p>
                        <p className="text-2xl font-bold text-rose-400">{formatCurrency(projectedRecurringCosts)}</p>
                        <p className="text-slate-500 text-xs mt-1">{remainingMonths} months of confirmed recurring</p>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-4">
                        <p className="text-slate-400 text-sm mb-1">Monthly Overhead Rate</p>
                        <p className="text-2xl font-bold text-white">{formatCurrency(totalMonthlyRecurring)}</p>
                        <p className="text-slate-500 text-xs mt-1">Before variable costs & COGS</p>
                      </div>
                    </div>
                    <p className="text-slate-400 text-sm mt-4">
                      ðŸ’¡ <strong>Tip:</strong> Your recurring expenses are predictable costs that will hit regardless of sales volume. 
                      Factor these in when setting monthly profit targets â€” you need to clear {formatCurrency(totalMonthlyRecurring)} in gross profit just to break even on fixed costs.
                    </p>
                  </div>
                </div>
              )}
              
              {/* Expenses Tab */}
              {bankingTab === 'expenses' && (
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                  {/* Drill-down view */}
                  {bankingDrilldown && bankingDrilldown.type === 'expense' ? (
                    <>
                      <div className="flex items-center justify-between mb-4">
                        <button 
                          onClick={() => setBankingDrilldown(null)}
                          className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors"
                        >
                          <ChevronLeft className="w-5 h-5" />
                          <span className="text-lg font-semibold text-white">{bankingDrilldown.category}</span>
                        </button>
                        <span className="text-rose-400 font-bold text-lg">
                          {formatCurrency(expensesByCategory[bankingDrilldown.category] || 0)}
                        </span>
                      </div>
                      <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table className="w-full text-sm">
                          <thead className="sticky top-0 bg-slate-800">
                            <tr className="border-b border-slate-700">
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Date</th>
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Description</th>
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Account</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">Amount</th>
                              <th className="text-center text-slate-400 font-medium py-2 px-2">Recurring</th>
                            </tr>
                          </thead>
                          <tbody>
                            {filteredTxns
                              .filter(t => t.isExpense && t.topCategory === bankingDrilldown.category)
                              .map((txn, i) => {
                                // Check if this transaction is flagged as recurring
                                const vendorKey = (txn.description || txn.name || '').toUpperCase().split(/\s+(PAYMENT|AUTOPAY|ACH|DEBIT|BILL|#|\d{4,})/)[0].trim().substring(0, 40);
                                const txnKey = `TXN_${vendorKey}_${txn.amount.toFixed(2)}`;
                                const isFlaggedRecurring = confirmedRecurring[txnKey]?.confirmed || confirmedRecurring[vendorKey]?.confirmed;
                                const isMarkedNotRecurring = confirmedRecurring[txnKey]?.notRecurring || confirmedRecurring[vendorKey]?.notRecurring;
                                
                                return (
                                  <tr key={txn.id || i} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                    <td className="py-2 px-2 text-slate-400 whitespace-nowrap">{txn.date}</td>
                                    <td className="py-2 px-2 text-white">{txn.name}</td>
                                    <td className="py-2 px-2 text-slate-400 text-xs">{txn.account?.split('(')[0]?.trim() || '-'}</td>
                                    <td className="py-2 px-2 text-right text-rose-400 font-medium">{formatCurrency(txn.amount)}</td>
                                    <td className="py-2 px-2 text-center">
                                      {isFlaggedRecurring ? (
                                        <span className="px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs">
                                          âœ“ Recurring
                                        </span>
                                      ) : isMarkedNotRecurring ? (
                                        <span className="text-slate-500 text-xs">Not recurring</span>
                                      ) : (
                                        <button
                                          onClick={() => {
                                            setConfirmedRecurring(prev => ({
                                              ...prev,
                                              [txnKey]: {
                                                confirmed: true,
                                                flaggedFromTxn: true,
                                                vendor: vendorKey,
                                                description: txn.name || txn.description,
                                                amount: txn.amount,
                                                category: txn.topCategory,
                                                flaggedAt: new Date().toISOString(),
                                              }
                                            }));
                                            setToast({ message: `"${vendorKey}" flagged as recurring ($${txn.amount.toFixed(2)}/mo)`, type: 'success' });
                                          }}
                                          className="px-2 py-0.5 bg-slate-700 hover:bg-purple-600 text-slate-400 hover:text-white rounded text-xs transition-colors"
                                          title="Flag this as a recurring monthly expense"
                                        >
                                          ðŸ” Flag
                                        </button>
                                      )}
                                    </td>
                                  </tr>
                                );
                              })}
                          </tbody>
                        </table>
                      </div>
                    </>
                  ) : (
                    <>
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-white">Expenses â€” {periodLabel}</h3>
                        <span className="text-slate-400 text-sm">{topExpenseCategories.length} categories â€¢ Click to drill down</span>
                      </div>
                      <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table className="w-full text-sm">
                          <thead className="sticky top-0 bg-slate-800">
                            <tr className="border-b border-slate-700">
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Category</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">Total</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">% of Expenses</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">Txns</th>
                            </tr>
                          </thead>
                          <tbody>
                            {topExpenseCategories.map(([cat, amount]) => {
                              const pct = (amount / totalExpenses) * 100;
                              const count = filteredTxns.filter(t => t.isExpense && t.topCategory === cat).length;
                              return (
                                <tr 
                                  key={cat} 
                                  className="border-b border-slate-700/50 hover:bg-slate-700/30 cursor-pointer"
                                  onClick={() => setBankingDrilldown({ category: cat, type: 'expense' })}
                                >
                                  <td className="py-2 px-2 text-white flex items-center gap-2">
                                    {cat}
                                    <ChevronRight className="w-4 h-4 text-slate-500" />
                                  </td>
                                  <td className="py-2 px-2 text-right text-rose-400 font-medium">{formatCurrency(amount)}</td>
                                  <td className="py-2 px-2 text-right">
                                    <div className="flex items-center justify-end gap-2">
                                      <div className="w-16 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                        <div className="h-full bg-rose-500" style={{ width: `${pct}%` }} />
                                      </div>
                                      <span className="text-slate-400 w-12 text-right">{pct.toFixed(1)}%</span>
                                    </div>
                                  </td>
                                  <td className="py-2 px-2 text-right text-slate-400">{count}</td>
                                </tr>
                              );
                            })}
                          </tbody>
                          <tfoot>
                            <tr className="border-t-2 border-slate-600">
                              <td className="py-2 px-2 font-bold text-white">Total</td>
                              <td className="py-2 px-2 text-right font-bold text-rose-400">{formatCurrency(totalExpenses)}</td>
                              <td className="py-2 px-2 text-right text-slate-400">100%</td>
                              <td className="py-2 px-2 text-right text-slate-400">{filteredTxns.filter(t => t.isExpense).length}</td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    </>
                  )}
                </div>
              )}
              
              {/* Income Tab */}
              {bankingTab === 'income' && (
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                  {/* Drill-down view */}
                  {bankingDrilldown && bankingDrilldown.type === 'income' ? (
                    <>
                      <div className="flex items-center justify-between mb-4">
                        <button 
                          onClick={() => setBankingDrilldown(null)}
                          className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors"
                        >
                          <ChevronLeft className="w-5 h-5" />
                          <span className="text-lg font-semibold text-white">{bankingDrilldown.category}</span>
                        </button>
                        <span className="text-emerald-400 font-bold text-lg">
                          {formatCurrency(incomeByCategory[bankingDrilldown.category] || 0)}
                        </span>
                      </div>
                      <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table className="w-full text-sm">
                          <thead className="sticky top-0 bg-slate-800">
                            <tr className="border-b border-slate-700">
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Date</th>
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Description</th>
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Account</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">Amount</th>
                            </tr>
                          </thead>
                          <tbody>
                            {filteredTxns
                              .filter(t => t.isIncome && t.topCategory === bankingDrilldown.category)
                              .map((txn, i) => (
                                <tr key={txn.id || i} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                  <td className="py-2 px-2 text-slate-400 whitespace-nowrap">{txn.date}</td>
                                  <td className="py-2 px-2 text-white">{txn.name}</td>
                                  <td className="py-2 px-2 text-slate-400 text-xs">{txn.account?.split('(')[0]?.trim() || '-'}</td>
                                  <td className="py-2 px-2 text-right text-emerald-400 font-medium">{formatCurrency(txn.amount)}</td>
                                </tr>
                              ))}
                          </tbody>
                        </table>
                      </div>
                    </>
                  ) : (
                    <>
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-white">Income â€” {periodLabel}</h3>
                        <span className="text-slate-400 text-sm">{topIncomeCategories.length} sources â€¢ Click to drill down</span>
                      </div>
                      <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table className="w-full text-sm">
                          <thead className="sticky top-0 bg-slate-800">
                            <tr className="border-b border-slate-700">
                              <th className="text-left text-slate-400 font-medium py-2 px-2">Category</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">Total</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">% of Income</th>
                              <th className="text-right text-slate-400 font-medium py-2 px-2">Txns</th>
                            </tr>
                          </thead>
                          <tbody>
                            {topIncomeCategories.map(([cat, amount]) => {
                              const pct = (amount / totalIncome) * 100;
                              const count = filteredTxns.filter(t => t.isIncome && t.topCategory === cat).length;
                              return (
                                <tr 
                                  key={cat} 
                                  className="border-b border-slate-700/50 hover:bg-slate-700/30 cursor-pointer"
                                  onClick={() => setBankingDrilldown({ category: cat, type: 'income' })}
                                >
                                  <td className="py-2 px-2 text-white flex items-center gap-2">
                                    {cat}
                                    <ChevronRight className="w-4 h-4 text-slate-500" />
                                  </td>
                                  <td className="py-2 px-2 text-right text-emerald-400 font-medium">{formatCurrency(amount)}</td>
                                  <td className="py-2 px-2 text-right">
                                    <div className="flex items-center justify-end gap-2">
                                      <div className="w-16 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                        <div className="h-full bg-emerald-500" style={{ width: `${pct}%` }} />
                                      </div>
                                      <span className="text-slate-400 w-12 text-right">{pct.toFixed(1)}%</span>
                                    </div>
                                  </td>
                                  <td className="py-2 px-2 text-right text-slate-400">{count}</td>
                                </tr>
                              );
                            })}
                          </tbody>
                          <tfoot>
                            <tr className="border-t-2 border-slate-600">
                              <td className="py-2 px-2 font-bold text-white">Total</td>
                              <td className="py-2 px-2 text-right font-bold text-emerald-400">{formatCurrency(totalIncome)}</td>
                              <td className="py-2 px-2 text-right text-slate-400">100%</td>
                              <td className="py-2 px-2 text-right text-slate-400">{filteredTxns.filter(t => t.isIncome).length}</td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    </>
                  )}
                </div>
              )}
              
              {/* Trends Tab */}
              {bankingTab === 'trends' && (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Monthly Cash Flow Chart */}
                  <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                    <h3 className="text-lg font-semibold text-white mb-2">Monthly Cash Flow</h3>
                    <p className="text-xs text-slate-500 mb-4">Income deposits minus expenses (not profit)</p>
                    {monthKeys.length > 0 && (() => {
                      const netValues = monthKeys.map(m => monthlySnapshots[m]?.net || 0);
                      const maxAbs = Math.max(...netValues.map(n => Math.abs(n)), 1000); // Min $1000 for scale
                      
                      return (
                        <div className="h-48">
                          <div className="flex items-end gap-1 h-full">
                            {monthKeys.map(m => {
                              const net = monthlySnapshots[m]?.net || 0;
                              const heightPct = Math.min((Math.abs(net) / maxAbs) * 100, 100);
                              const isPositive = net >= 0;
                              return (
                                <div key={m} className="flex-1 flex flex-col items-center group relative h-full justify-end">
                                  <div className="absolute -top-12 left-1/2 transform -translate-x-1/2 hidden group-hover:block bg-slate-900 text-white text-xs px-3 py-2 rounded-lg whitespace-nowrap z-50 shadow-xl border border-slate-600">
                                    <div className="font-medium">{new Date(m + '-01').toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</div>
                                    <div className={`text-sm ${isPositive ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(net)}</div>
                                  </div>
                                  <div 
                                    className={`w-full rounded-t transition-all hover:opacity-80 ${isPositive ? 'bg-emerald-500' : 'bg-rose-500'}`}
                                    style={{ height: `${Math.max(heightPct, 3)}%` }}
                                  />
                                  <span className="text-[9px] text-slate-500 mt-1 truncate w-full text-center">{new Date(m + '-01').toLocaleDateString('en-US', { month: 'short' })}</span>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                  
                  {/* Cash Flow Summary */}
                  <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                    <h3 className="text-lg font-semibold text-white mb-4">Cash Flow Summary</h3>
                    {(() => {
                      const currentYear = now.getFullYear();
                      const ytdMonths = monthKeys.filter(m => m.startsWith(String(currentYear)));
                      const ytdIncome = ytdMonths.reduce((s, m) => s + (monthlySnapshots[m]?.income || 0), 0);
                      const ytdExpenses = ytdMonths.reduce((s, m) => s + (monthlySnapshots[m]?.expenses || 0), 0);
                      const ytdNet = ytdIncome - ytdExpenses;
                      
                      // Get last year same period for comparison if available
                      const lastYear = currentYear - 1;
                      const lastYearMonths = monthKeys.filter(m => m.startsWith(String(lastYear)));
                      const lastYearSamePeriod = lastYearMonths.slice(0, ytdMonths.length);
                      const lastYearNet = lastYearSamePeriod.reduce((s, m) => s + (monthlySnapshots[m]?.net || 0), 0);
                      const yoyChange = lastYearNet !== 0 ? ((ytdNet - lastYearNet) / Math.abs(lastYearNet)) * 100 : 0;
                      
                      return (
                        <div className="space-y-4">
                          <div className="flex justify-between items-center p-3 bg-emerald-900/20 border border-emerald-500/30 rounded-lg">
                            <span className="text-emerald-400">YTD Income (Deposits)</span>
                            <span className="font-bold text-emerald-400">{formatCurrency(ytdIncome)}</span>
                          </div>
                          <div className="flex justify-between items-center p-3 bg-rose-900/20 border border-rose-500/30 rounded-lg">
                            <span className="text-rose-400">YTD Expenses</span>
                            <span className="font-bold text-rose-400">{formatCurrency(ytdExpenses)}</span>
                          </div>
                          <div className="flex justify-between items-center p-4 bg-slate-700/50 rounded-xl">
                            <span className="text-white font-medium">YTD Net Cash Flow</span>
                            <span className={`text-xl font-bold ${ytdNet >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(ytdNet)}</span>
                          </div>
                          {lastYearSamePeriod.length > 0 && lastYearNet !== 0 && (
                            <div className="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                              <span className="text-slate-400">vs Same Period Last Year</span>
                              <span className={`font-medium flex items-center gap-1 ${yoyChange >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                {yoyChange >= 0 ? <TrendingUp className="w-4 h-4" /> : <TrendingDown className="w-4 h-4" />}
                                {yoyChange >= 0 ? '+' : ''}{yoyChange.toFixed(1)}%
                              </span>
                            </div>
                          )}
                          <div className="p-3 bg-amber-900/20 border border-amber-500/30 rounded-lg">
                            <p className="text-amber-400 text-xs">
                              âš ï¸ <strong>Note:</strong> Cash flow â‰  profit. Income deposits include revenue minus marketplace fees, not COGS. 
                              For true profit analysis, see your Sales data.
                            </p>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                </div>
              )}
              
              {/* Transactions Tab */}
              {bankingTab === 'transactions' && (
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-semibold text-white">Transactions â€” {periodLabel}</h3>
                    <div className="flex items-center gap-3">
                      <span className="text-slate-400 text-sm">{filteredTxns.length} transactions</span>
                      {Object.keys(bankingData.categoryOverrides || {}).length > 0 && (
                        <span className="text-xs bg-violet-500/20 text-violet-300 px-2 py-1 rounded">
                          {Object.keys(bankingData.categoryOverrides).length} recategorized
                        </span>
                      )}
                    </div>
                  </div>
                  <p className="text-xs text-slate-500 mb-4">ðŸ’¡ Click any transaction to edit its category</p>
                  <div className="overflow-x-auto max-h-[600px] overflow-y-auto">
                    <table className="w-full text-sm">
                      <thead className="sticky top-0 bg-slate-800 z-10">
                        <tr className="border-b border-slate-700">
                          <th className="text-left text-slate-400 font-medium py-2 px-3">Date</th>
                          <th className="text-left text-slate-400 font-medium py-2 px-3">Vendor</th>
                          <th className="text-left text-slate-400 font-medium py-2 px-3">Category</th>
                          <th className="text-right text-slate-400 font-medium py-2 px-3">Amount</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredTxns.slice(0, 300).map((txn, i) => {
                          const hasOverride = bankingData.categoryOverrides?.[txn.id];
                          return (
                            <tr 
                              key={txn.id || i} 
                              onClick={() => setEditingTransaction(txn)}
                              className="border-b border-slate-700/50 hover:bg-slate-700/50 cursor-pointer transition-colors"
                            >
                              <td className="py-3 px-3 text-slate-400 whitespace-nowrap">{txn.dateDisplay}</td>
                              <td className="py-3 px-3">
                                <div className="text-white">{txn.vendor}</div>
                                <div className="text-slate-500 text-xs truncate max-w-[200px]">{txn.memo?.slice(0, 40) || ''}</div>
                              </td>
                              <td className="py-3 px-3">
                                <span className={`px-2 py-1 rounded text-xs ${hasOverride ? 'bg-violet-500/20 text-violet-300' : 'bg-slate-700 text-slate-300'}`}>
                                  {txn.topCategory}
                                </span>
                              </td>
                              <td className={`py-3 px-3 text-right font-medium whitespace-nowrap ${txn.isIncome ? 'text-emerald-400' : 'text-rose-400'}`}>
                                {txn.isIncome ? '+' : '-'}{formatCurrency(txn.amount)}
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                    {filteredTxns.length > 300 && (
                      <p className="text-center text-slate-500 py-4">Showing first 300 of {filteredTxns.length} transactions</p>
                    )}
                  </div>
                </div>
              )}
              
              {/* Transaction Edit Modal */}
              {editingTransaction && (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100] p-4" onClick={() => setEditingTransaction(null)}>
                  <div className="bg-slate-800 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                    <div className="p-6 border-b border-slate-700">
                      <div className="flex items-center justify-between">
                        <h2 className="text-xl font-bold text-white">Edit Transaction</h2>
                        <button onClick={() => setEditingTransaction(null)} className="text-slate-400 hover:text-white">
                          <X className="w-5 h-5" />
                        </button>
                      </div>
                    </div>
                    <div className="p-6 space-y-4">
                      {/* Transaction Details */}
                      <div className="bg-slate-900/50 rounded-lg p-4 space-y-2">
                        <div className="flex justify-between">
                          <span className="text-slate-400">Date</span>
                          <span className="text-white">{editingTransaction.dateDisplay}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-400">Vendor</span>
                          <span className="text-white">{editingTransaction.vendor}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-400">Amount</span>
                          <span className={editingTransaction.isIncome ? 'text-emerald-400 font-bold' : 'text-rose-400 font-bold'}>
                            {editingTransaction.isIncome ? '+' : '-'}{formatCurrency(editingTransaction.amount)}
                          </span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-400">Account</span>
                          <span className="text-white text-sm">{editingTransaction.account?.split('(')[0]}</span>
                        </div>
                        {editingTransaction.memo && (
                          <div className="pt-2 border-t border-slate-700">
                            <span className="text-slate-400 text-xs">Memo</span>
                            <p className="text-slate-300 text-sm mt-1">{editingTransaction.memo}</p>
                          </div>
                        )}
                      </div>
                      
                      {/* Category Edit */}
                      <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Category</label>
                        <input
                          type="text"
                          defaultValue={editingTransaction.category}
                          id="txn-category-input"
                          className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-violet-500"
                          placeholder="Enter category..."
                        />
                        <p className="text-xs text-slate-500 mt-2">Original: {editingTransaction.originalCategory || editingTransaction.category}</p>
                      </div>
                      
                      {/* Quick Categories */}
                      <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Quick Select</label>
                        <div className="flex flex-wrap gap-2">
                          {['Advertising & marketing', 'Cost of goods sold', 'Shipping & delivery', 'Office expenses', 'Software & subscriptions', 'Payroll expenses', 'Channel Sales', 'Sales'].map(cat => (
                            <button
                              key={cat}
                              onClick={() => {
                                document.getElementById('txn-category-input').value = cat;
                              }}
                              className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs text-slate-300"
                            >
                              {cat}
                            </button>
                          ))}
                        </div>
                      </div>
                    </div>
                    <div className="p-6 border-t border-slate-700 flex gap-3">
                      <button
                        onClick={() => setEditingTransaction(null)}
                        className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={() => {
                          const newCat = document.getElementById('txn-category-input').value;
                          if (newCat && newCat !== editingTransaction.category) {
                            handleCategoryChange(editingTransaction.id, newCat);
                          }
                          setEditingTransaction(null);
                        }}
                        className="flex-1 px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white font-medium"
                      >
                        Save Category
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Account Balance Edit Modal */}
              {editingAccountBalance && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                  <div className="bg-slate-800 rounded-xl border border-slate-600 p-6 max-w-md w-full">
                    <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                      {editingAccountBalance.isCard ? <CreditCard className="w-5 h-5 text-rose-400" /> : <Wallet className="w-5 h-5 text-emerald-400" />}
                      Edit Account Balance
                    </h3>
                    <p className="text-slate-400 text-sm mb-4">
                      {editingAccountBalance.name?.split('(')[0]?.trim()}
                    </p>
                    <div className="mb-4">
                      <label className="block text-sm text-slate-400 mb-1">
                        Current Balance {editingAccountBalance.isCard ? '(amount owed)' : '(available)'}
                      </label>
                      <div className="flex items-center gap-2">
                        <span className="text-slate-400">$</span>
                        <input
                          type="number"
                          step="0.01"
                          id="account-balance-input"
                          defaultValue={editingAccountBalance.balance.toFixed(2)}
                          className="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white"
                          placeholder="0.00"
                        />
                      </div>
                      <p className="text-xs text-slate-500 mt-2">
                        Enter the actual balance from your bank/card statement
                      </p>
                    </div>
                    <div className="flex gap-3">
                      <button
                        onClick={() => setEditingAccountBalance(null)}
                        className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={() => {
                          const newBalance = parseFloat(document.getElementById('account-balance-input').value) || 0;
                          // For credit cards, store as positive (debt owed)
                          const finalBalance = editingAccountBalance.isCard ? newBalance : newBalance;
                          
                          // Update bankingData with new balance
                          const updatedAccounts = { ...bankingData.accounts };
                          if (updatedAccounts[editingAccountBalance.name]) {
                            updatedAccounts[editingAccountBalance.name] = {
                              ...updatedAccounts[editingAccountBalance.name],
                              balance: finalBalance,
                              balanceManuallySet: true,
                              balanceSetDate: new Date().toISOString(),
                            };
                          }
                          
                          const newBankingData = {
                            ...bankingData,
                            accounts: updatedAccounts,
                          };
                          
                          setBankingData(newBankingData);
                          localStorage.setItem('ecommerce_banking_v1', JSON.stringify(newBankingData));
                          queueCloudSave({ ...combinedData, bankingData: newBankingData });
                          
                          setToast({ message: `Balance updated for ${editingAccountBalance.name.split('(')[0].trim()}`, type: 'success' });
                          setEditingAccountBalance(null);
                        }}
                        className="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white font-medium"
                      >
                        Save Balance
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* CFO Dashboard Tab */}
              {bankingTab === 'cfo' && (() => {
                // Calculate CFO metrics
                const currentMonth = now.toISOString().slice(0, 7);
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().slice(0, 7);
                const twoMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1).toISOString().slice(0, 7);
                
                const currentMonthData = monthlySnapshots[currentMonth] || { income: 0, expenses: 0, net: 0 };
                const lastMonthData = monthlySnapshots[lastMonth] || { income: 0, expenses: 0, net: 0 };
                const twoMonthsAgoData = monthlySnapshots[twoMonthsAgo] || { income: 0, expenses: 0, net: 0 };
                
                // Get COGS for this month
                const monthCOGS = expensesByCategory['Cost of goods sold'] || 0;
                const monthOpEx = currentMonthData.expenses - monthCOGS;
                
                // Operating metrics
                const operatingMargin = currentMonthData.income > 0 
                  ? (currentMonthData.net / currentMonthData.income * 100) 
                  : 0;
                  
                // Burn rate (avg monthly expenses over last 3 months)
                const last3Months = monthKeys.slice(-3);
                const avgMonthlyExpenses = last3Months.length > 0 
                  ? last3Months.reduce((s, m) => s + (monthlySnapshots[m]?.expenses || 0), 0) / last3Months.length 
                  : 0;
                
                // Net cash flow (avg monthly income - expenses over last 3 months)
                const avgMonthlyNet = last3Months.length > 0
                  ? last3Months.reduce((s, m) => s + (monthlySnapshots[m]?.net || 0), 0) / last3Months.length
                  : 0;
                
                // Runway calculation - for revenue-generating business, use NET cash flow
                const realAccts = Object.entries(bankingData.accounts || {}).filter(([name, _]) => 
                  /\(\d{4}\)\s*-\s*\d+$/.test(name) && !name.includes('"') && name.length <= 60
                );
                const totalCash = realAccts.filter(([_, a]) => a.type !== 'credit_card').reduce((s, [_, a]) => s + (a.balance || 0), 0);
                // If net cash flow is positive or zero, business is self-sustaining (infinite runway)
                // If net is negative, calculate how many months until cash runs out
                const runwayMonths = avgMonthlyNet >= 0 ? Infinity : totalCash / Math.abs(avgMonthlyNet);
                const isCashFlowPositive = avgMonthlyNet >= 0;
                
                // MoM growth
                const revenueMoM = lastMonthData.income > 0 
                  ? ((currentMonthData.income - lastMonthData.income) / lastMonthData.income * 100) 
                  : 0;
                const expenseMoM = lastMonthData.expenses > 0 
                  ? ((currentMonthData.expenses - lastMonthData.expenses) / lastMonthData.expenses * 100) 
                  : 0;
                
                // Expense efficiency (operating expenses / revenue)
                const opexRatio = currentMonthData.income > 0 
                  ? (monthOpEx / currentMonthData.income * 100) 
                  : 0;
                
                // YTD calculations from banking
                const currentYear = now.getFullYear();
                const ytdMonths = monthKeys.filter(m => m.startsWith(String(currentYear)));
                const ytdIncome = ytdMonths.reduce((s, m) => s + (monthlySnapshots[m]?.income || 0), 0);
                const ytdExpenses = ytdMonths.reduce((s, m) => s + (monthlySnapshots[m]?.expenses || 0), 0);
                const ytdCashFlow = ytdIncome - ytdExpenses;
                
                // Get actual sales profit data if available
                const sortedWeeks2026 = Object.keys(allWeeksData).filter(w => w.startsWith('2026')).sort();
                const actualYTDProfit = sortedWeeks2026.reduce((s, w) => s + (allWeeksData[w]?.total?.netProfit || 0), 0);
                const actualYTDRevenue = sortedWeeks2026.reduce((s, w) => s + (allWeeksData[w]?.total?.revenue || 0), 0);
                const weeksWithData = sortedWeeks2026.filter(w => (allWeeksData[w]?.total?.revenue || 0) > 0).length;
                
                // Use sales data for forecast if available, otherwise banking
                const hasActualSalesData = weeksWithData > 0;
                const monthsCompleted = ytdMonths.length || (weeksWithData > 0 ? Math.ceil(weeksWithData / 4.33) : 0);
                const monthsRemaining = 12 - Math.max(monthsCompleted, now.getMonth() + 1);
                
                // Calculate forecast based on best available data
                let forecastBasis, avgMonthlyProfit, linearProjection, trendProjection;
                
                // Get recurring expenses for deduction
                const recurringMonthlyExpenses = totalMonthlyRecurring || 0;
                const recurringCostsRemaining = recurringMonthlyExpenses * monthsRemaining;
                
                if (hasActualSalesData && actualYTDRevenue > 0) {
                  // Use actual sales profit data
                  forecastBasis = 'sales';
                  const avgWeeklyProfit = actualYTDProfit / Math.max(weeksWithData, 1);
                  avgMonthlyProfit = avgWeeklyProfit * 4.33;
                  // Deduct recurring expenses from projections
                  linearProjection = actualYTDProfit + (avgMonthlyProfit * monthsRemaining) - recurringCostsRemaining;
                  
                  // For trend, use last 4 weeks if available
                  const recentWeeks = sortedWeeks2026.slice(-4);
                  const recentProfit = recentWeeks.reduce((s, w) => s + (allWeeksData[w]?.total?.netProfit || 0), 0);
                  const recentAvgWeekly = recentProfit / Math.max(recentWeeks.length, 1);
                  const recentAvgMonthly = recentAvgWeekly * 4.33;
                  trendProjection = actualYTDProfit + (recentAvgMonthly * monthsRemaining) - recurringCostsRemaining;
                } else {
                  // Fall back to banking cash flow
                  forecastBasis = 'cashflow';
                  avgMonthlyProfit = ytdMonths.length > 0 ? ytdCashFlow / ytdMonths.length : 0;
                  // Deduct recurring expenses from projections
                  linearProjection = ytdCashFlow + (avgMonthlyProfit * monthsRemaining) - recurringCostsRemaining;
                  
                  // Trend using last 3 months
                  const recentMonths = ytdMonths.slice(-3);
                  const recentAvgNet = recentMonths.length > 0 
                    ? recentMonths.reduce((s, m) => s + (monthlySnapshots[m]?.net || 0), 0) / recentMonths.length 
                    : avgMonthlyProfit;
                  trendProjection = ytdCashFlow + (recentAvgNet * monthsRemaining) - recurringCostsRemaining;
                }
                
                // ==================== OPEN PO CASH FLOW ====================
                // Calculate outstanding PO payments
                const openPOs = productionPipeline.filter(po => po.status !== 'received');
                const poAnalysis = openPOs.map(po => {
                  const totalValue = po.totalValue || ((po.quantity || 0) * (po.unitCost || 0));
                  const depositPercent = po.depositPercent || 50;
                  const depositAmt = totalValue * (depositPercent / 100);
                  const balancePercent = (100 - depositPercent) / 100;
                  
                  // Calculate what's been paid
                  let paidSoFar = po.depositPaid ? depositAmt : 0;
                  
                  if (po.paymentTerms === '30-70-ship') {
                    // Rolling payments - sum shipment payments
                    const shippedUnits = (po.shipments || []).reduce((s, sh) => s + (sh.units || 0), 0);
                    paidSoFar += shippedUnits * (po.unitCost || 0) * balancePercent;
                  } else if (po.balancePaid) {
                    paidSoFar += totalValue * balancePercent;
                  }
                  
                  const outstanding = totalValue - paidSoFar;
                  const unitsRemaining = (po.quantity || 0) - (po.shipments || []).reduce((s, sh) => s + (sh.units || 0), 0);
                  
                  return {
                    ...po,
                    totalValue,
                    paidSoFar,
                    outstanding,
                    unitsRemaining,
                  };
                });
                
                const totalPOValue = poAnalysis.reduce((s, po) => s + po.totalValue, 0);
                const totalPOPaid = poAnalysis.reduce((s, po) => s + po.paidSoFar, 0);
                const totalPOOutstanding = poAnalysis.reduce((s, po) => s + po.outstanding, 0);
                
                // Projected COGS from open POs (when goods arrive and sell)
                const totalUnitsIncoming = poAnalysis.reduce((s, po) => s + po.unitsRemaining, 0);
                const avgUnitCost = totalUnitsIncoming > 0 
                  ? poAnalysis.reduce((s, po) => s + (po.unitsRemaining * (po.unitCost || 0)), 0) / totalUnitsIncoming 
                  : 0;
                
                // Tooltip component
                const KPICard = ({ label, value, subLabel, color, tooltip }) => (
                  <div className="bg-slate-700/50 rounded-lg p-4 relative group cursor-help">
                    <p className="text-slate-400 text-xs mb-1">{label}</p>
                    <p className={`text-2xl font-bold ${color}`}>{value}</p>
                    <p className="text-slate-500 text-xs">{subLabel}</p>
                    {tooltip && (
                      <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-72 p-3 bg-slate-900 border border-slate-600 rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none">
                        <p className="text-sm text-slate-200">{tooltip}</p>
                      </div>
                    )}
                  </div>
                );
                
                return (
                  <div className="space-y-6">
                    {/* Key Performance Indicators */}
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                      <h3 className="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                        <Target className="w-5 h-5 text-violet-400" />
                        Key Performance Indicators â€” {new Date(currentMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                      </h3>
                      <p className="text-slate-500 text-xs mb-4">Hover over each metric for detailed explanation</p>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <KPICard 
                          label="Operating Margin"
                          value={`${operatingMargin.toFixed(1)}%`}
                          subLabel="Net / Revenue"
                          color={operatingMargin >= 0 ? 'text-emerald-400' : 'text-rose-400'}
                          tooltip={`Your net cash flow (${formatCurrency(currentMonthData.net)}) divided by income (${formatCurrency(currentMonthData.income)}) = ${operatingMargin.toFixed(1)}%. This shows what percentage of revenue you keep after all expenses. A healthy e-commerce business typically aims for 15-30%.`}
                        />
                        <KPICard 
                          label="OpEx Ratio"
                          value={`${opexRatio.toFixed(1)}%`}
                          subLabel="Operating Exp / Revenue"
                          color={opexRatio <= 50 ? 'text-emerald-400' : opexRatio <= 70 ? 'text-amber-400' : 'text-rose-400'}
                          tooltip={`Operating expenses (${formatCurrency(monthOpEx)}) excluding COGS, divided by revenue (${formatCurrency(currentMonthData.income)}) = ${opexRatio.toFixed(1)}%. This measures operational efficiency. Lower is better â€” under 50% is excellent, 50-70% is acceptable, over 70% needs attention.`}
                        />
                        <KPICard 
                          label="Revenue MoM"
                          value={`${revenueMoM >= 0 ? '+' : ''}${revenueMoM.toFixed(1)}%`}
                          subLabel="vs Last Month"
                          color={revenueMoM >= 0 ? 'text-emerald-400' : 'text-rose-400'}
                          tooltip={`Revenue changed from ${formatCurrency(lastMonthData.income)} last month to ${formatCurrency(currentMonthData.income)} this month = ${revenueMoM >= 0 ? '+' : ''}${revenueMoM.toFixed(1)}% change. Consistent positive MoM growth indicates healthy business expansion.`}
                        />
                        <KPICard 
                          label="Cash Runway"
                          value={isCashFlowPositive ? 'Positive' : `${runwayMonths.toFixed(1)}mo`}
                          subLabel={isCashFlowPositive ? 'Net cash flow +' : 'At current burn'}
                          color={isCashFlowPositive ? 'text-emerald-400' : runwayMonths >= 6 ? 'text-emerald-400' : runwayMonths >= 3 ? 'text-amber-400' : 'text-rose-400'}
                          tooltip={isCashFlowPositive 
                            ? `Your business is cash flow positive! Average net: ${formatCurrency(avgMonthlyNet)}/month. You're generating more income than expenses, so runway is unlimited.`
                            : `With ${formatCurrency(totalCash)} cash and avg monthly net loss of ${formatCurrency(Math.abs(avgMonthlyNet))}, you have ${runwayMonths.toFixed(1)} months of runway. This factors in your revenue, not just expenses.`}
                        />
                      </div>
                    </div>
                    
                    {/* AI Profit Forecast */}
                    <div className="bg-gradient-to-r from-violet-900/30 to-indigo-900/30 rounded-xl border border-violet-500/30 p-5">
                      <h3 className="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                        <Brain className="w-5 h-5 text-violet-400" />
                        AI Year-End {forecastBasis === 'sales' ? 'Profit' : 'Cash Flow'} Forecast â€” {currentYear}
                      </h3>
                      <p className="text-slate-400 text-xs mb-4">
                        {forecastBasis === 'sales' 
                          ? `Based on ${weeksWithData} weeks of actual sales data with ${formatCurrency(actualYTDRevenue)} revenue`
                          : `Based on banking cash flow data (${ytdMonths.length} months). Upload sales data for profit-based forecasting.`}
                      </p>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div className="bg-slate-800/50 rounded-lg p-4">
                          <p className="text-slate-400 text-xs mb-1">YTD Actual {forecastBasis === 'sales' ? 'Profit' : 'Cash Flow'}</p>
                          <p className={`text-2xl font-bold ${(forecastBasis === 'sales' ? actualYTDProfit : ytdCashFlow) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                            {formatCurrency(forecastBasis === 'sales' ? actualYTDProfit : ytdCashFlow)}
                          </p>
                          <p className="text-slate-500 text-xs">
                            {forecastBasis === 'sales' ? `${weeksWithData} weeks` : `${ytdMonths.length} months`} completed
                          </p>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-4">
                          <p className="text-slate-400 text-xs mb-1">Linear Projection</p>
                          <p className={`text-2xl font-bold ${linearProjection >= 0 ? 'text-cyan-400' : 'text-rose-400'}`}>
                            {formatCurrency(linearProjection)}
                          </p>
                          <p className="text-slate-500 text-xs">
                            Avg {formatCurrency(avgMonthlyProfit)}/mo Ã— {12 - (forecastBasis === 'sales' ? Math.ceil(weeksWithData / 4.33) : ytdMonths.length)} remaining
                          </p>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-4 border border-violet-500/30">
                          <p className="text-violet-400 text-xs mb-1">ðŸ¤– AI Trend Forecast</p>
                          <p className={`text-2xl font-bold ${trendProjection >= 0 ? 'text-violet-400' : 'text-rose-400'}`}>
                            {formatCurrency(trendProjection)}
                          </p>
                          <p className="text-slate-500 text-xs">Weighted recent trends</p>
                        </div>
                      </div>
                      
                      {/* Recurring Expenses Deduction */}
                      {recurringMonthlyExpenses > 0 && (
                        <div className="bg-rose-900/20 border border-rose-500/30 rounded-lg p-3 mb-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                              <RefreshCw className="w-4 h-4 text-rose-400" />
                              <span className="text-rose-400 text-sm font-medium">Recurring Expenses Factored In</span>
                            </div>
                            <span className="text-rose-400 font-bold">-{formatCurrency(recurringCostsRemaining)}</span>
                          </div>
                          <p className="text-slate-500 text-xs mt-1">
                            {confirmedRecurringList.length} confirmed recurring Ã— {monthsRemaining} months remaining
                            ({formatCurrency(recurringMonthlyExpenses)}/mo)
                          </p>
                        </div>
                      )}
                      
                      <div className="bg-slate-800/30 rounded-lg p-3">
                        <p className="text-slate-400 text-sm">
                          <span className="text-violet-400 font-medium">ðŸ“Š Forecast Methodology:</span> 
                          {forecastBasis === 'sales' 
                            ? ` Using ${weeksWithData} weeks of actual sales profit data. Linear projection uses your average weekly profit (${formatCurrency(avgMonthlyProfit / 4.33)}) Ã— remaining weeks. AI Trend weights your last 4 weeks more heavily to capture recent momentum.`
                            : ` Using banking cash flow data. Linear projection extrapolates your average monthly net (${formatCurrency(avgMonthlyProfit)}). AI Trend weights recent 3 months higher to reflect current performance.`
                          }
                          {recurringMonthlyExpenses > 0 && ` ðŸ”„ Deducting ${formatCurrency(recurringCostsRemaining)} in confirmed recurring expenses (${monthsRemaining} months Ã— ${formatCurrency(recurringMonthlyExpenses)}/mo).`}
                          {trendProjection > linearProjection 
                            ? " ðŸ“ˆ Recent performance is trending above average!" 
                            : trendProjection < linearProjection 
                              ? " ðŸ“‰ Recent performance is below average â€” may need attention."
                              : ""}
                        </p>
                      </div>
                    </div>
                    
                    {/* Open PO Cash Flow */}
                    {openPOs.length > 0 && totalPOOutstanding > 0 && (
                      <div className="bg-gradient-to-r from-amber-900/30 to-orange-900/30 rounded-xl border border-amber-500/30 p-5">
                        <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                          <Package className="w-5 h-5 text-amber-400" />
                          Open Purchase Orders â€” Cash Flow Impact
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                          <div className="bg-slate-800/50 rounded-lg p-4">
                            <p className="text-slate-400 text-xs mb-1">Total PO Value</p>
                            <p className="text-2xl font-bold text-white">{formatCurrency(totalPOValue)}</p>
                            <p className="text-slate-500 text-xs">{openPOs.length} open POs</p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-4">
                            <p className="text-slate-400 text-xs mb-1">Paid to Date</p>
                            <p className="text-2xl font-bold text-emerald-400">{formatCurrency(totalPOPaid)}</p>
                            <p className="text-slate-500 text-xs">{totalPOValue > 0 ? ((totalPOPaid / totalPOValue * 100).toFixed(0)) : 0}% complete</p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-4 border border-rose-500/30">
                            <p className="text-rose-400 text-xs mb-1">Outstanding Balance</p>
                            <p className="text-2xl font-bold text-rose-400">{formatCurrency(totalPOOutstanding)}</p>
                            <p className="text-slate-500 text-xs">Payments still due</p>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-4">
                            <p className="text-slate-400 text-xs mb-1">Units Incoming</p>
                            <p className="text-2xl font-bold text-cyan-400">{formatNumber(totalUnitsIncoming)}</p>
                            <p className="text-slate-500 text-xs">@ avg {formatCurrency(avgUnitCost)}/unit</p>
                          </div>
                        </div>
                        
                        {/* Per-PO breakdown */}
                        <div className="space-y-2">
                          {poAnalysis.map(po => (
                            <div key={po.id} className="bg-slate-800/30 rounded-lg p-3 flex items-center justify-between">
                              <div className="flex-1">
                                <p className="text-white font-medium">{po.productName || po.sku}</p>
                                <p className="text-slate-500 text-xs">
                                  {po.paymentTerms === '30-70-ship' ? '30/70 rolling' : po.paymentTerms === '50-50' ? '50/50 at completion' : po.paymentTerms}
                                  {po.vendor && ` â€¢ ${po.vendor}`}
                                </p>
                              </div>
                              <div className="text-right">
                                <p className="text-rose-400 font-medium">{formatCurrency(po.outstanding)} due</p>
                                <p className="text-slate-500 text-xs">{formatNumber(po.unitsRemaining)} units remaining</p>
                              </div>
                            </div>
                          ))}
                        </div>
                        
                        <p className="text-slate-400 text-sm mt-4 pt-3 border-t border-slate-700">
                          ðŸ’¡ <strong>Cash Flow Note:</strong> Outstanding PO balance ({formatCurrency(totalPOOutstanding)}) represents future cash outflows as goods ship. 
                          Factor this into your cash reserves planning. When goods arrive and sell, the unit cost becomes COGS on your P&L.
                        </p>
                      </div>
                    )}
                    
                    {/* Cash Flow Analysis */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                        <h3 className="text-lg font-semibold text-white mb-4">Burn Rate Analysis</h3>
                        <div className="space-y-3">
                          <div className="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                            <span className="text-slate-400">Avg Monthly Expenses</span>
                            <span className="font-bold text-rose-400">{formatCurrency(avgMonthlyExpenses)}</span>
                          </div>
                          <div className="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                            <span className="text-slate-400">Expense Growth MoM</span>
                            <span className={`font-bold flex items-center gap-1 ${expenseMoM <= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                              {expenseMoM >= 0 ? '+' : ''}{expenseMoM.toFixed(1)}%
                            </span>
                          </div>
                          <div className="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                            <span className="text-slate-400">Cash Position</span>
                            <span className="font-bold text-emerald-400">{formatCurrency(totalCash)}</span>
                          </div>
                          <div className="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                            <span className="text-slate-400">Runway</span>
                            <span className={`font-bold ${runwayMonths >= 6 ? 'text-emerald-400' : runwayMonths >= 3 ? 'text-amber-400' : 'text-rose-400'}`}>
                              {runwayMonths === Infinity ? 'Profitable' : `${runwayMonths.toFixed(1)} months`}
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                        <h3 className="text-lg font-semibold text-white mb-4">Expense Breakdown (This Month)</h3>
                        <div className="space-y-2">
                          {topExpenseCategories.slice(0, 6).map(([cat, amount]) => {
                            const pct = totalExpenses > 0 ? (amount / totalExpenses * 100) : 0;
                            return (
                              <div key={cat} className="flex items-center gap-2">
                                <div className="flex-1">
                                  <div className="flex justify-between text-sm mb-1">
                                    <span className="text-slate-300 truncate">{cat}</span>
                                    <span className="text-slate-400">{formatCurrency(amount)}</span>
                                  </div>
                                  <div className="w-full h-1 bg-slate-700 rounded-full overflow-hidden">
                                    <div className="h-full bg-rose-500/60 rounded-full" style={{ width: `${pct}%` }} />
                                  </div>
                                </div>
                                <span className="text-slate-500 text-xs w-12 text-right">{pct.toFixed(0)}%</span>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}
              
              {/* Credit Cards Tab */}
              {bankingTab === 'cards' && (() => {
                // Get credit card accounts
                const realAccts = Object.entries(bankingData.accounts || {}).filter(([name, _]) => 
                  /\(\d{4}\)\s*-\s*\d+$/.test(name) && !name.includes('"') && name.length <= 60
                );
                const creditAccts = realAccts.filter(([_, a]) => a.type === 'credit_card');
                
                // Get credit card transactions grouped by card
                const cardTransactions = {};
                creditAccts.forEach(([name, _]) => {
                  cardTransactions[name] = sortedTxns.filter(t => t.account === name && t.isExpense);
                });
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Determine card type and calculate optimal payment dates
                const getCardAnalysis = (cardName, txns) => {
                  const nameLower = cardName.toLowerCase();
                  const isAmexPlatinum = nameLower.includes('platinum');
                  const isAmexPrime = nameLower.includes('prime') || nameLower.includes('amazon');
                  const isAmex = nameLower.includes('amex') || nameLower.includes('american express') || isAmexPlatinum || isAmexPrime;
                  
                  // Get charges from the CURRENT statement cycle only (not yet closed or just recently closed)
                  // Old charges from previous statement cycles are assumed to have been paid
                  const recentCharges = txns.filter(t => {
                    const txnDate = new Date(t.date + 'T12:00:00');
                    const daysSinceTxn = Math.floor((today - txnDate) / (1000 * 60 * 60 * 24));
                    // Only include charges from last 35 days (current statement cycle)
                    // Older charges are from previous statements which should have been paid
                    return daysSinceTxn >= 0 && daysSinceTxn < 35;
                  }).sort((a, b) => a.date.localeCompare(b.date));
                  
                  // Calculate payment schedule for each charge
                  // Amex Business cards typically have:
                  // - Statement closes on a fixed date each month (we'll estimate end of month)
                  // - Standard due date: 25 days after statement close
                  // - Amex Platinum "Please Pay By" is a suggestion; actual due is ~14 days later
                  
                  const chargeAnalysis = recentCharges.map(t => {
                    const txnDate = new Date(t.date + 'T12:00:00');
                    
                    // Determine which statement this charge will appear on
                    // If charge is in first 25 days of month, it's on that month's statement
                    // Otherwise it rolls to next month's statement
                    let statementMonth, statementYear;
                    if (txnDate.getDate() <= 25) {
                      statementMonth = txnDate.getMonth();
                      statementYear = txnDate.getFullYear();
                    } else {
                      statementMonth = txnDate.getMonth() + 1;
                      statementYear = txnDate.getFullYear();
                      if (statementMonth > 11) {
                        statementMonth = 0;
                        statementYear++;
                      }
                    }
                    
                    // Statement closes at end of the statement month
                    const statementCloseDate = new Date(statementYear, statementMonth + 1, 0);
                    statementCloseDate.setHours(23, 59, 59, 999);
                    
                    // Standard payment due: 25 days after statement close
                    const standardDueDate = new Date(statementCloseDate);
                    standardDueDate.setDate(standardDueDate.getDate() + 25);
                    standardDueDate.setHours(23, 59, 59, 999);
                    
                    // For Amex Platinum: "Please Pay By" is 25 days after close, but REAL due date is ~14 days later
                    // Total: 39 days after statement close
                    let realDueDate, optimalPayDate;
                    if (isAmexPlatinum) {
                      realDueDate = new Date(statementCloseDate);
                      realDueDate.setDate(realDueDate.getDate() + 39);
                      optimalPayDate = new Date(realDueDate);
                      optimalPayDate.setDate(optimalPayDate.getDate() - 5);
                    } else {
                      realDueDate = new Date(standardDueDate);
                      optimalPayDate = new Date(standardDueDate);
                      optimalPayDate.setDate(optimalPayDate.getDate() - 5);
                    }
                    
                    // Calculate days until due
                    const daysUntilDue = Math.ceil((realDueDate - today) / (1000 * 60 * 60 * 24));
                    const daysUntilOptimal = Math.ceil((optimalPayDate - today) / (1000 * 60 * 60 * 24));
                    
                    // Is this charge urgent? (due within 10 days)
                    const isUrgent = daysUntilDue <= 10 && daysUntilDue > -5;
                    // Only flag as past due if significantly overdue (5+ days) AND statement recently closed
                    // This avoids false positives from old charges that were already paid
                    const statementAge = Math.floor((today - statementCloseDate) / (1000 * 60 * 60 * 24));
                    const isPastDue = daysUntilDue < -5 && statementAge < 60;
                    
                    return {
                      ...t,
                      txnDate,
                      statementCloseDate,
                      standardDueDate,
                      realDueDate,
                      optimalPayDate,
                      daysUntilDue,
                      daysUntilOptimal,
                      isUrgent,
                      isPastDue,
                    };
                  });
                  
                  // Group charges by statement period
                  const statementGroups = {};
                  chargeAnalysis.forEach(c => {
                    const key = c.statementCloseDate.toISOString().slice(0, 7);
                    if (!statementGroups[key]) {
                      statementGroups[key] = {
                        statementCloseDate: c.statementCloseDate,
                        realDueDate: c.realDueDate,
                        optimalPayDate: c.optimalPayDate,
                        daysUntilDue: c.daysUntilDue,
                        charges: [],
                        total: 0,
                      };
                    }
                    statementGroups[key].charges.push(c);
                    statementGroups[key].total += c.amount;
                  });
                  
                  // Find next payment needed (soonest due date with unpaid charges)
                  const sortedStatements = Object.values(statementGroups).sort((a, b) => a.realDueDate - b.realDueDate);
                  const nextStatement = sortedStatements.find(s => s.daysUntilDue > -30); // Allow some past due
                  
                  // Urgent charges (due within 10 days)
                  const urgentCharges = chargeAnalysis.filter(c => c.isUrgent && !c.isPastDue);
                  const pastDueCharges = chargeAnalysis.filter(c => c.isPastDue);
                  
                  // Total balance from account
                  const balance = bankingData.accounts?.[cardName]?.balance || 0;
                  
                  return {
                    cardName,
                    isAmex,
                    isAmexPlatinum,
                    isAmexPrime,
                    balance,
                    charges: chargeAnalysis,
                    statementGroups: sortedStatements,
                    nextStatement,
                    urgentCharges,
                    pastDueCharges,
                    totalPending: recentCharges.reduce((s, t) => s + t.amount, 0),
                  };
                };
                
                const cardAnalyses = creditAccts.map(([name, _]) => getCardAnalysis(name, cardTransactions[name] || []));
                
                // Find any urgent payments across all cards
                const allUrgentCharges = cardAnalyses.flatMap(c => c.urgentCharges);
                const allPastDueCharges = cardAnalyses.flatMap(c => c.pastDueCharges);
                
                return (
                  <div className="space-y-6">
                    {/* Past Due Alert */}
                    {allPastDueCharges.length > 0 && (
                      <div className="bg-rose-900/30 border border-rose-500/50 rounded-xl p-4">
                        <h3 className="text-lg font-semibold text-rose-400 mb-2 flex items-center gap-2">
                          <AlertCircle className="w-5 h-5" />
                          Past Due Warning
                        </h3>
                        <p className="text-rose-200">
                          You have {allPastDueCharges.length} charges that may be past their due date.
                          Pay immediately to avoid late fees and interest.
                        </p>
                      </div>
                    )}
                    
                    {/* Payment Due Soon Alert */}
                    {allUrgentCharges.length > 0 && allPastDueCharges.length === 0 && (
                      <div className="bg-amber-900/30 border border-amber-500/50 rounded-xl p-4">
                        <h3 className="text-lg font-semibold text-amber-400 mb-2 flex items-center gap-2">
                          <AlertTriangle className="w-5 h-5" />
                          Payment Due Soon
                        </h3>
                        <p className="text-amber-200">
                          You have charges with payments due within 10 days.
                          Pay by the optimal dates below to avoid interest while maximizing your cash flow.
                        </p>
                      </div>
                    )}
                    
                    {/* Amex Card Rules Reference */}
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                      <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <HelpCircle className="w-5 h-5 text-cyan-400" />
                        Amex Business Card Payment Rules
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-slate-700/30 rounded-lg p-4 border-l-4 border-violet-500">
                          <h4 className="font-semibold text-violet-400 mb-2">ðŸ’³ Business Platinum</h4>
                          <ul className="text-sm text-slate-300 space-y-1">
                            <li>â€¢ Statement closes ~end of month</li>
                            <li>â€¢ "Please Pay By" = 25 days after close</li>
                            <li>â€¢ <span className="text-amber-400">Actual due date = ~39 days after close</span></li>
                            <li>â€¢ Pay in full by actual due date = no interest</li>
                            <li>â€¢ <span className="text-emerald-400">Strategy: Pay 5 days before actual due</span></li>
                          </ul>
                        </div>
                        <div className="bg-slate-700/30 rounded-lg p-4 border-l-4 border-amber-500">
                          <h4 className="font-semibold text-amber-400 mb-2">ðŸ“¦ Business Prime (Amazon)</h4>
                          <ul className="text-sm text-slate-300 space-y-1">
                            <li>â€¢ Statement closes ~end of month</li>
                            <li>â€¢ Due date = 25 days after statement close</li>
                            <li>â€¢ Optional: 90-day terms (forfeits 5% back)</li>
                            <li>â€¢ Pay in full by due date = no interest</li>
                            <li>â€¢ <span className="text-emerald-400">Strategy: Pay 5 days before due</span></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    
                    {/* Card-by-Card Analysis */}
                    {cardAnalyses.map(card => (
                      <div key={card.cardName} className="bg-slate-800/50 rounded-xl border border-slate-700 p-5">
                        <div className="flex items-center justify-between mb-4">
                          <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                            <CreditCard className={`w-5 h-5 ${card.isAmexPlatinum ? 'text-violet-400' : card.isAmexPrime ? 'text-amber-400' : 'text-cyan-400'}`} />
                            {card.cardName.split('(')[0].trim()}
                            {card.isAmexPlatinum && <span className="text-xs bg-violet-500/30 text-violet-300 px-2 py-0.5 rounded">Platinum</span>}
                            {card.isAmexPrime && <span className="text-xs bg-amber-500/30 text-amber-300 px-2 py-0.5 rounded">Prime</span>}
                          </h3>
                          <span className="text-rose-400 font-bold text-lg">{formatCurrency(card.balance)}</span>
                        </div>
                        
                        {/* Next Payment Due */}
                        {card.nextStatement && (
                          <div className={`mb-4 p-4 rounded-lg ${
                            card.nextStatement.daysUntilDue < 0 ? 'bg-rose-900/30 border border-rose-500/30' :
                            card.nextStatement.daysUntilDue <= 10 ? 'bg-amber-900/30 border border-amber-500/30' : 
                            'bg-emerald-900/20 border border-emerald-500/30'
                          }`}>
                            <div className="flex items-center justify-between">
                              <div>
                                <p className={`font-medium ${
                                  card.nextStatement.daysUntilDue < 0 ? 'text-rose-400' :
                                  card.nextStatement.daysUntilDue <= 10 ? 'text-amber-400' : 
                                  'text-emerald-400'
                                }`}>
                                  {card.nextStatement.daysUntilDue < 0 ? 'ðŸš¨ Check Statement - Payment May Be Due' :
                                   card.nextStatement.daysUntilDue <= 10 ? 'âš ï¸ Payment Window Open' : 
                                   'âœ“ On Track'}
                                </p>
                                <p className="text-sm text-slate-300 mt-1">
                                  Current Balance: <span className="font-bold text-white">{formatCurrency(Math.abs(card.balance))}</span>
                                  <span className="text-slate-500 text-xs ml-1">(from QBO)</span>
                                </p>
                                <p className="text-sm text-slate-300">
                                  Suggested Pay By: <span className="font-bold text-cyan-400">{card.nextStatement.optimalPayDate.toLocaleDateString()}</span>
                                  <span className="text-slate-500 ml-1">
                                    ({card.nextStatement.daysUntilDue - 5 > 0 ? `~${card.nextStatement.daysUntilDue - 5} days` : 'soon'})
                                  </span>
                                </p>
                              </div>
                              <div className="text-right">
                                <p className="text-slate-400 text-xs">Est. Due Date</p>
                                <p className={`font-bold text-lg ${card.nextStatement.daysUntilDue < 0 ? 'text-rose-400' : 'text-white'}`}>
                                  {card.nextStatement.realDueDate.toLocaleDateString()}
                                </p>
                                <p className="text-xs text-slate-500 mt-1">Verify w/ statement</p>
                              </div>
                            </div>
                            <p className="text-xs text-slate-500 mt-2 pt-2 border-t border-slate-700/50">
                              ðŸ’¡ Due dates are estimates based on typical {card.isAmex ? 'Amex' : 'credit card'} billing cycles. Always check your actual statement.
                            </p>
                          </div>
                        )}
                        
                        {/* Recent Charges Summary */}
                        {card.charges.length > 0 && (
                          <div className="space-y-3">
                            <h4 className="text-sm font-medium text-slate-400">Recent Activity (Last 35 Days)</h4>
                            <div className="bg-slate-700/30 rounded-lg p-3">
                              <div className="flex items-center justify-between mb-1">
                                <span className="text-slate-300 text-sm">{card.charges.length} charges tracked</span>
                                <span className="text-slate-400 text-sm">{formatCurrency(card.charges.reduce((s, c) => s + c.amount, 0))}</span>
                              </div>
                              <p className="text-xs text-slate-500">
                                Note: This is recent activity only, not your full statement balance
                              </p>
                            </div>
                          </div>
                        )}
                        
                        {card.charges.length === 0 && (
                          <p className="text-slate-500 text-sm">No recent charges found for this card in the last 60 days.</p>
                        )}
                      </div>
                    ))}
                    
                    {creditAccts.length === 0 && (
                      <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-8 text-center">
                        <CreditCard className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                        <p className="text-slate-400">No credit card accounts found in your banking data.</p>
                        <p className="text-slate-500 text-sm mt-1">Upload a QBO file that includes your credit card transactions.</p>
                      </div>
                    )}
                  </div>
                );
              })()}
            </>
          )}
        </div>
      </div>
    );
  }

  // ==================== SETTINGS VIEW ====================
  if (view === 'settings') {
    // Default settings structure
    const defaultSettings = {
      inventoryDaysOptimal: 60,
      inventoryDaysLow: 30,
      inventoryDaysCritical: 14,
      tacosOptimal: 15,
      tacosWarning: 25,
      tacosMax: 35,
      roasTarget: 3.0,
      marginTarget: 25,
      marginWarning: 15,
      modulesEnabled: {
        weeklyTracking: true,
        periodTracking: true,
        inventory: true,
        trends: true,
        yoy: true,
        skus: true,
        profitability: true,
        ads: true,
        threepl: true,
        salesTax: true,
      },
      dashboardDefaultRange: 'month',
      showWeeklyGoals: true,
      showMonthlyGoals: true,
      alertSalesTaxDays: 7,
      alertInventoryEnabled: true,
      alertGoalsEnabled: true,
      alertSalesTaxEnabled: true,
      currencySymbol: '$',
      dateFormat: 'US',
    };
    
    // Merge defaults with saved settings
    const currentLocalSettings = {
      ...defaultSettings,
      ...(localSettings || appSettings),
      modulesEnabled: {
        ...defaultSettings.modulesEnabled,
        ...((localSettings || appSettings)?.modulesEnabled || {}),
      }
    };
    
    const updateSetting = (path, value) => {
      setLocalSettings(prev => {
        const base = prev || appSettings || defaultSettings;
        const updated = JSON.parse(JSON.stringify({ ...defaultSettings, ...base })); // Deep clone with defaults
        const keys = path.split('.');
        let obj = updated;
        for (let i = 0; i < keys.length - 1; i++) {
          if (!obj[keys[i]]) obj[keys[i]] = {};
          obj = obj[keys[i]];
        }
        obj[keys[keys.length - 1]] = value;
        return updated;
      });
    };
    
    const handleSave = () => {
      saveSettings(currentLocalSettings);
      setShowSaveConfirm(true);
      setTimeout(() => setShowSaveConfirm(false), 2000);
    };
    
    const resetToDefaults = () => {
      setLocalSettings(defaultSettings);
      setShowResetConfirm(false);
    };
    
    const SettingSection = ({ title, children }) => (
      <div className="bg-slate-800/50 rounded-2xl border border-slate-700 p-6 mb-6">
        <h3 className="text-lg font-semibold text-white mb-4">{title}</h3>
        {children}
      </div>
    );
    
    const SettingRow = ({ label, desc, children }) => (
      <div className="flex items-center justify-between py-3 border-b border-slate-700/50 last:border-0">
        <div className="flex-1 pr-4">
          <p className="text-white font-medium">{label}</p>
          {desc && <p className="text-slate-400 text-sm">{desc}</p>}
        </div>
        <div className="flex-shrink-0">{children}</div>
      </div>
    );
    
    const Toggle = ({ checked, onChange }) => (
      <button onClick={() => onChange(!checked)} className={`w-12 h-6 rounded-full transition-all ${checked ? 'bg-emerald-500' : 'bg-slate-600'}`}>
        <div className={`w-5 h-5 bg-white rounded-full transition-transform ${checked ? 'translate-x-6' : 'translate-x-0.5'}`} />
      </button>
    );
    
    const NumberInput = ({ value, onChange, min, max, step = 1, suffix = '' }) => (
      <div className="flex items-center gap-2">
        <input type="number" value={value} onChange={(e) => onChange(parseFloat(e.target.value) || 0)} min={min} max={max} step={step} className="w-20 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-right" />
        {suffix && <span className="text-slate-400 text-sm">{suffix}</span>}
      </div>
    );
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white p-4 lg:p-6">
        <div className="max-w-4xl mx-auto"><Toast /><DayDetailsModal /><ValidationModal />{aiChatUI}{aiChatButton}{weeklyReportUI}<CogsManager /><ProductCatalogModal /><UploadHelpModal /><ForecastModal /><BreakEvenModal /><ExportModal /><ComparisonView /><InvoiceModal /><ThreePLBulkUploadModal /><AdsBulkUploadModal /><GoalsModal /><StoreSelectorModal />
          
          <div className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-2xl lg:text-3xl font-bold text-white">Settings</h1>
              <p className="text-slate-400">Customize your dashboard experience</p>
            </div>
            <button onClick={handleSave} className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-semibold text-white flex items-center gap-2"><Check className="w-5 h-5" />Save Changes</button>
          </div>
          
          <NavTabs />
          
          {/* Settings Tabs */}
          <div className="flex flex-wrap gap-1.5 sm:gap-2 mb-6 p-1 bg-slate-800/50 rounded-xl">
            {[
              { id: 'general', label: 'General', mobileLabel: 'ðŸª', icon: Store },
              { id: 'integrations', label: 'Integrations', mobileLabel: 'ðŸ”—', icon: RefreshCw },
              { id: 'thresholds', label: 'Thresholds', mobileLabel: 'ðŸ“Š', icon: Target },
              { id: 'display', label: 'Display', mobileLabel: 'ðŸŽ¨', icon: Eye },
              { id: 'data', label: 'Data', mobileLabel: 'ðŸ—„ï¸', icon: Database },
              { id: 'account', label: 'Account', mobileLabel: 'ðŸ‘¤', icon: User },
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setSettingsTab(tab.id)}
                className={`flex-1 min-w-[50px] sm:min-w-[90px] px-2 sm:px-4 py-2 sm:py-2.5 rounded-lg text-sm font-medium transition-all ${
                  settingsTab === tab.id 
                    ? 'bg-violet-600 text-white shadow-lg' 
                    : 'text-slate-400 hover:text-white hover:bg-slate-700/50'
                }`}
              >
                <span className="sm:hidden">{tab.mobileLabel}</span>
                <span className="hidden sm:inline">{tab.mobileLabel} {tab.label}</span>
              </button>
            ))}
          </div>
          
          {/* ========== GENERAL TAB ========== */}
          {settingsTab === 'general' && (
            <>
          {/* Store Management - For Cloud Users */}
          {session && (
            <SettingSection title="ðŸª Store Management">
              <p className="text-slate-400 text-sm mb-4">Manage multiple stores or rename your current store</p>
              
              {/* Current Store */}
              <div className="bg-slate-800/50 rounded-xl p-4 mb-4">
                <p className="text-slate-400 text-xs uppercase mb-2">Current Store</p>
                <div className="flex items-center gap-3">
                  <Store className="w-8 h-8 text-violet-400" />
                  <div className="flex-1">
                    <input 
                      key={`store-name-${activeStoreId}`}
                      defaultValue={storeName || stores.find(s => s.id === activeStoreId)?.name || ''} 
                      onBlur={(e) => {
                        const newName = e.target.value;
                        setStoreName(newName);
                        // Also update in stores array if it exists
                        if (stores.length > 0 && activeStoreId) {
                          const updated = stores.map(s => s.id === activeStoreId ? { ...s, name: newName } : s);
                          setStores(updated);
                        }
                      }}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          e.target.blur();
                        }
                      }}
                      className="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white w-full focus:outline-none focus:ring-2 focus:ring-violet-500"
                      placeholder="Enter store name"
                    />
                  </div>
                </div>
                <p className="text-slate-500 text-xs mt-2">Press Enter or click outside to save. This name appears in exports and reports.</p>
              </div>
              
              {/* All Stores */}
              {stores.length >= 1 && (
                <div className="space-y-2 mb-4">
                  <p className="text-slate-400 text-xs uppercase">
                    {stores.length > 1 ? 'Switch Store' : 'Your Store'}
                  </p>
                  {stores.map(store => (
                    <div key={store.id} className={`flex items-center justify-between p-3 rounded-xl border ${store.id === activeStoreId ? 'bg-violet-900/30 border-violet-500/50' : 'bg-slate-800/30 border-slate-700 hover:bg-slate-700/50'}`}>
                      <div className="flex items-center gap-3">
                        <Store className={`w-5 h-5 ${store.id === activeStoreId ? 'text-violet-400' : 'text-slate-500'}`} />
                        <span className={store.id === activeStoreId ? 'text-white font-medium' : 'text-slate-300'}>{store.name}</span>
                        {store.id === activeStoreId && <span className="text-xs text-violet-400 bg-violet-500/20 px-2 py-0.5 rounded">Active</span>}
                      </div>
                      <div className="flex items-center gap-2">
                        {store.id !== activeStoreId && (
                          <button 
                            onClick={() => switchStore(store.id)}
                            className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white"
                          >
                            Switch
                          </button>
                        )}
                        <button 
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            deleteStore(store.id);
                          }}
                          className="p-1.5 text-slate-400 hover:text-rose-400 hover:bg-rose-500/10 rounded-lg transition-colors"
                          title={stores.length === 1 ? "Delete and start fresh" : "Delete store"}
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
              
              {/* Create New Store */}
              <div className="flex gap-2">
                <input 
                  placeholder="New store name..."
                  className="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-violet-500"
                  id="new-store-name"
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && e.target.value.trim()) {
                      createStore(e.target.value.trim());
                      e.target.value = '';
                    }
                  }}
                />
                <button 
                  onClick={() => {
                    const input = document.getElementById('new-store-name');
                    if (input?.value?.trim()) {
                      createStore(input.value.trim());
                      input.value = '';
                    }
                  }}
                  className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white flex items-center gap-2"
                >
                  <Plus className="w-4 h-4" />Add Store
                </button>
              </div>
              <p className="text-slate-500 text-xs mt-2">Each store has separate data. Great for multiple brands or demo data.</p>
            </SettingSection>
          )}
          
          {/* Store Branding - Always visible in General tab */}
          <SettingSection title="ðŸª Store Branding">
            <SettingRow label="Store Name" desc="Displayed in the dashboard header">
              <input 
                type="text" 
                value={storeName} 
                onChange={(e) => setStoreName(e.target.value)} 
                placeholder="Your Store Name"
                className="w-48 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm"
              />
            </SettingRow>
            <SettingRow label="Store Logo" desc="Upload your logo (PNG, JPG - max 500KB)">
              <div className="flex items-center gap-3">
                {storeLogo && (
                  <img src={storeLogo} alt="Store logo" className="w-10 h-10 object-contain rounded-lg bg-white p-1" />
                )}
                <label className="px-3 py-2 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/50 rounded-lg text-sm text-violet-300 cursor-pointer flex items-center gap-2">
                  <Upload className="w-4 h-4" />{storeLogo ? 'Change' : 'Upload'}
                  <input 
                    type="file" 
                    accept="image/png,image/jpeg,image/jpg,image/webp"
                    onChange={(e) => {
                      const file = e.target.files[0];
                      if (file) {
                        if (file.size > 500 * 1024) {
                          setToast({ message: 'Logo must be under 500KB', type: 'error' });
                          return;
                        }
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                          setStoreLogo(ev.target.result);
                          setToast({ message: 'Logo uploaded successfully', type: 'success' });
                        };
                        reader.readAsDataURL(file);
                      }
                    }} 
                    className="hidden" 
                  />
                </label>
                {storeLogo && (
                  <button onClick={() => { setStoreLogo(null); setToast({ message: 'Logo removed', type: 'success' }); }} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300">
                    Remove
                  </button>
                )}
              </div>
            </SettingRow>
            <p className="text-slate-500 text-xs mt-3">Your logo will appear in the dashboard header next to your store name.</p>
          </SettingSection>
            </>
          )}
          
          {/* ========== INTEGRATIONS TAB ========== */}
          {settingsTab === 'integrations' && (
            <>
          {/* Shopify Connection */}
          <SettingSection title="ðŸ›’ Shopify Connection">
            <p className="text-slate-400 text-sm mb-4">Connect your Shopify store to automatically sync orders, inventory, and tax data</p>
            
            {shopifyCredentials.connected ? (
              <div className="space-y-4">
                <div className="bg-emerald-900/30 border border-emerald-500/30 rounded-xl p-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-emerald-500/20 rounded-full flex items-center justify-center">
                        <Check className="w-5 h-5 text-emerald-400" />
                      </div>
                      <div>
                        <p className="text-emerald-400 font-medium">Connected</p>
                        <p className="text-slate-400 text-sm">{shopifyCredentials.storeUrl}</p>
                      </div>
                    </div>
                    <button
                      onClick={() => {
                        if (confirm('Disconnect from Shopify? Your synced data will remain.')) {
                          setShopifyCredentials({ storeUrl: '', clientId: '', clientSecret: '', connected: false, lastSync: null });
                          setToast({ message: 'Shopify disconnected', type: 'success' });
                        }
                      }}
                      className="px-4 py-2 bg-rose-600/30 hover:bg-rose-600/50 border border-rose-500/50 rounded-lg text-sm text-rose-300"
                    >
                      Disconnect
                    </button>
                  </div>
                </div>
                <SettingRow label="Go to Sync" desc="Sync orders from your Shopify store">
                  <button
                    onClick={() => { setUploadTab('shopify-sync'); setView('upload'); }}
                    className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm text-white flex items-center gap-2"
                  >
                    <RefreshCw className="w-4 h-4" />Sync Now
                  </button>
                </SettingRow>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="bg-slate-900/50 rounded-xl p-4">
                  <div className="space-y-4">
                    <div>
                      <label className="block text-slate-300 text-sm font-medium mb-2">Store URL</label>
                      <input
                        type="text"
                        placeholder="your-store.myshopify.com"
                        value={shopifyCredentials.storeUrl}
                        onChange={(e) => setShopifyCredentials(p => ({ ...p, storeUrl: e.target.value }))}
                        className="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      <p className="text-slate-500 text-xs mt-1">Just the store name, e.g. "mystore.myshopify.com"</p>
                    </div>
                    <div>
                      <label className="block text-slate-300 text-sm font-medium mb-2">Client ID</label>
                      <input
                        type="text"
                        placeholder="Your app's Client ID"
                        value={shopifyCredentials.clientId}
                        onChange={(e) => setShopifyCredentials(p => ({ ...p, clientId: e.target.value }))}
                        className="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      <p className="text-slate-500 text-xs mt-1">From Dev Dashboard â†’ Your App â†’ Settings</p>
                    </div>
                    <div>
                      <label className="block text-slate-300 text-sm font-medium mb-2">Client Secret</label>
                      <input
                        type="password"
                        placeholder="Your app's Client Secret"
                        value={shopifyCredentials.clientSecret}
                        onChange={(e) => setShopifyCredentials(p => ({ ...p, clientSecret: e.target.value }))}
                        className="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      <p className="text-slate-500 text-xs mt-1">Keep this secret! Never share it.</p>
                    </div>
                    <button
                      onClick={async () => {
                        if (!shopifyCredentials.storeUrl || !shopifyCredentials.clientId || !shopifyCredentials.clientSecret) {
                          setToast({ message: 'Please enter store URL, Client ID, and Client Secret', type: 'error' });
                          return;
                        }
                        // Test connection
                        try {
                          const res = await fetch('/api/shopify/sync', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                              storeUrl: shopifyCredentials.storeUrl,
                              clientId: shopifyCredentials.clientId,
                              clientSecret: shopifyCredentials.clientSecret,
                              test: true,
                            }),
                          });
                          const data = await res.json();
                          if (data.error) throw new Error(data.error);
                          if (data.success) {
                            setShopifyCredentials(p => ({ ...p, connected: true }));
                            setToast({ message: `Connected to ${data.shopName || 'Shopify'}!`, type: 'success' });
                          }
                        } catch (err) {
                          setToast({ message: 'Connection failed: ' + err.message, type: 'error' });
                        }
                      }}
                      disabled={!shopifyCredentials.storeUrl || !shopifyCredentials.clientId || !shopifyCredentials.clientSecret}
                      className="w-full py-3 bg-green-600 hover:bg-green-500 disabled:opacity-50 disabled:hover:bg-green-600 rounded-xl text-white font-semibold flex items-center justify-center gap-2"
                    >
                      <ShoppingBag className="w-5 h-5" />
                      Test & Connect
                    </button>
                  </div>
                </div>
                
                <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                  <h4 className="text-blue-400 font-medium mb-2 flex items-center gap-2">
                    <HelpCircle className="w-4 h-4" />
                    How to get your credentials (Updated Jan 2026)
                  </h4>
                  <ol className="text-slate-300 text-sm space-y-2">
                    <li>1. Go to <a href="https://partners.shopify.com" target="_blank" className="text-blue-400 underline">Shopify Partners</a> â†’ Apps â†’ Create app</li>
                    <li>2. Or in your store: Settings â†’ Apps â†’ Develop apps â†’ Create app</li>
                    <li>3. Configure Admin API scopes: <code className="bg-slate-800 px-1 rounded">read_orders</code>, <code className="bg-slate-800 px-1 rounded">read_products</code>, <code className="bg-slate-800 px-1 rounded">read_inventory</code>, <code className="bg-slate-800 px-1 rounded">read_locations</code></li>
                    <li>4. Go to app Settings to find your <strong>Client ID</strong> and <strong>Client Secret</strong></li>
                    <li>5. Install the app on your store</li>
                  </ol>
                  <p className="text-slate-500 text-xs mt-3">Note: As of Jan 2026, Shopify uses OAuth. Tokens are generated automatically and refresh every 24 hours.</p>
                </div>
              </div>
            )}
          </SettingSection>
            </>
          )}
          
          {/* ========== THRESHOLDS TAB ========== */}
          {settingsTab === 'thresholds' && (
            <>
          {/* Inventory Thresholds */}
          <SettingSection title="ðŸ“¦ Inventory Thresholds">
            <p className="text-slate-400 text-sm mb-4">Define what stock levels trigger alerts</p>
            <SettingRow label="Optimal Days of Inventory" desc="Stock level considered healthy">
              <NumberInput value={currentLocalSettings.inventoryDaysOptimal} onChange={(v) => updateSetting('inventoryDaysOptimal', v)} min={1} max={365} suffix="days" />
            </SettingRow>
            <SettingRow label="Low Stock Threshold" desc="Triggers low stock warning">
              <NumberInput value={currentLocalSettings.inventoryDaysLow} onChange={(v) => updateSetting('inventoryDaysLow', v)} min={1} max={180} suffix="days" />
            </SettingRow>
            <SettingRow label="Critical Stock Threshold" desc="Triggers urgent reorder alert">
              <NumberInput value={currentLocalSettings.inventoryDaysCritical} onChange={(v) => updateSetting('inventoryDaysCritical', v)} min={1} max={60} suffix="days" />
            </SettingRow>
          </SettingSection>
          
          {/* Ad Performance */}
          <SettingSection title="ðŸ“Š Ad Performance (TACOS)">
            <p className="text-slate-400 text-sm mb-4">Total Advertising Cost of Sale thresholds</p>
            <SettingRow label="Optimal TACOS" desc="Ad spend % of revenue considered good">
              <NumberInput value={currentLocalSettings.tacosOptimal} onChange={(v) => updateSetting('tacosOptimal', v)} min={1} max={50} suffix="%" />
            </SettingRow>
            <SettingRow label="Warning TACOS" desc="Triggers yellow warning indicator">
              <NumberInput value={currentLocalSettings.tacosWarning} onChange={(v) => updateSetting('tacosWarning', v)} min={1} max={75} suffix="%" />
            </SettingRow>
            <SettingRow label="Maximum TACOS" desc="Triggers red alert indicator">
              <NumberInput value={currentLocalSettings.tacosMax} onChange={(v) => updateSetting('tacosMax', v)} min={1} max={100} suffix="%" />
            </SettingRow>
            <SettingRow label="Target ROAS" desc="Return on ad spend target">
              <NumberInput value={currentLocalSettings.roasTarget} onChange={(v) => updateSetting('roasTarget', v)} min={0.5} max={20} step={0.1} suffix="x" />
            </SettingRow>
          </SettingSection>
          
          {/* Profit Thresholds */}
          <SettingSection title="ðŸ’° Profit Thresholds">
            <SettingRow label="Target Net Margin" desc="Net profit margin goal">
              <NumberInput value={currentLocalSettings.marginTarget} onChange={(v) => updateSetting('marginTarget', v)} min={1} max={100} suffix="%" />
            </SettingRow>
            <SettingRow label="Margin Warning" desc="Below this triggers warning">
              <NumberInput value={currentLocalSettings.marginWarning} onChange={(v) => updateSetting('marginWarning', v)} min={1} max={50} suffix="%" />
            </SettingRow>
          </SettingSection>
          
          {/* Alert Preferences */}
          <SettingSection title="ðŸ”” Alert Preferences">
            <SettingRow label="Inventory Alerts" desc="Show low stock warnings on dashboard">
              <Toggle checked={currentLocalSettings.alertInventoryEnabled} onChange={(v) => updateSetting('alertInventoryEnabled', v)} />
            </SettingRow>
            <SettingRow label="Goals Alerts" desc="Show missed targets on dashboard">
              <Toggle checked={currentLocalSettings.alertGoalsEnabled} onChange={(v) => updateSetting('alertGoalsEnabled', v)} />
            </SettingRow>
            <SettingRow label="Sales Tax Alerts" desc="Show upcoming filing deadlines">
              <Toggle checked={currentLocalSettings.alertSalesTaxEnabled} onChange={(v) => updateSetting('alertSalesTaxEnabled', v)} />
            </SettingRow>
            <SettingRow label="Sales Tax Alert Days" desc="Days before deadline to show alert">
              <NumberInput value={currentLocalSettings.alertSalesTaxDays} onChange={(v) => updateSetting('alertSalesTaxDays', v)} min={1} max={30} suffix="days" />
            </SettingRow>
          </SettingSection>
            </>
          )}
          
          {/* ========== DISPLAY TAB ========== */}
          {settingsTab === 'display' && (
            <>
          {/* Module Visibility */}
          <SettingSection title="ðŸ“± Module Visibility">
            <p className="text-slate-400 text-sm mb-4">Show/hide sections to streamline your dashboard</p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8">
              <SettingRow label="Weekly Tracking">
                <Toggle checked={currentLocalSettings.modulesEnabled?.weeklyTracking !== false} onChange={(v) => updateSetting('modulesEnabled.weeklyTracking', v)} />
              </SettingRow>
              <SettingRow label="Period Tracking">
                <Toggle checked={currentLocalSettings.modulesEnabled?.periodTracking !== false} onChange={(v) => updateSetting('modulesEnabled.periodTracking', v)} />
              </SettingRow>
              <SettingRow label="Inventory">
                <Toggle checked={currentLocalSettings.modulesEnabled?.inventory !== false} onChange={(v) => updateSetting('modulesEnabled.inventory', v)} />
              </SettingRow>
              <SettingRow label="Trends Analytics">
                <Toggle checked={currentLocalSettings.modulesEnabled?.trends !== false} onChange={(v) => updateSetting('modulesEnabled.trends', v)} />
              </SettingRow>
              <SettingRow label="YoY Comparison">
                <Toggle checked={currentLocalSettings.modulesEnabled?.yoy !== false} onChange={(v) => updateSetting('modulesEnabled.yoy', v)} />
              </SettingRow>
              <SettingRow label="SKU Rankings">
                <Toggle checked={currentLocalSettings.modulesEnabled?.skus !== false} onChange={(v) => updateSetting('modulesEnabled.skus', v)} />
              </SettingRow>
              <SettingRow label="Profitability">
                <Toggle checked={currentLocalSettings.modulesEnabled?.profitability !== false} onChange={(v) => updateSetting('modulesEnabled.profitability', v)} />
              </SettingRow>
              <SettingRow label="Ads Analytics">
                <Toggle checked={currentLocalSettings.modulesEnabled?.ads !== false} onChange={(v) => updateSetting('modulesEnabled.ads', v)} />
              </SettingRow>
              <SettingRow label="3PL Analytics">
                <Toggle checked={currentLocalSettings.modulesEnabled?.threepl !== false} onChange={(v) => updateSetting('modulesEnabled.threepl', v)} />
              </SettingRow>
              <SettingRow label="Sales Tax">
                <Toggle checked={currentLocalSettings.modulesEnabled?.salesTax !== false} onChange={(v) => updateSetting('modulesEnabled.salesTax', v)} />
              </SettingRow>
            </div>
          </SettingSection>
          
          {/* Dashboard Preferences */}
          <SettingSection title="ðŸ  Dashboard Preferences">
            <SettingRow label="Default Time Range" desc="Initial view when loading dashboard">
              <select value={currentLocalSettings.dashboardDefaultRange || 'month'} onChange={(e) => updateSetting('dashboardDefaultRange', e.target.value)} className="bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white">
                <option value="week">Week</option>
                <option value="month">Month</option>
                <option value="quarter">Quarter</option>
                <option value="year">Year</option>
              </select>
            </SettingRow>
            <SettingRow label="Show Weekly Goals" desc="Display weekly targets on dashboard">
              <Toggle checked={currentLocalSettings.showWeeklyGoals !== false} onChange={(v) => updateSetting('showWeeklyGoals', v)} />
            </SettingRow>
            <SettingRow label="Show Monthly Goals" desc="Display monthly targets on dashboard">
              <Toggle checked={currentLocalSettings.showMonthlyGoals !== false} onChange={(v) => updateSetting('showMonthlyGoals', v)} />
            </SettingRow>
          </SettingSection>
          
          {/* Theme & Display (Feature 9) */}
          <SettingSection title="ðŸŽ¨ Theme & Display">
            <SettingRow label="Color Theme" desc="Customize accent colors">
              <div className="flex gap-2">
                {['violet', 'emerald', 'blue', 'rose', 'amber'].map(color => (
                  <button key={color} onClick={() => setTheme(p => ({...p, accent: color}))}
                    className={`w-8 h-8 rounded-full bg-${color}-500 ${theme.accent === color ? 'ring-2 ring-white ring-offset-2 ring-offset-slate-800' : ''}`} />
                ))}
              </div>
            </SettingRow>
            <SettingRow label="Mobile-Optimized View" desc="Simplified layout for small screens">
              <div className="flex items-center gap-2">
                <Toggle checked={isMobile} onChange={(val) => setIsMobile(val)} />
                <span className="text-slate-500 text-xs">(Auto-detected)</span>
              </div>
            </SettingRow>
          </SettingSection>
          
          {/* Notifications (Feature 4) */}
          <SettingSection title="ðŸ”” Notifications">
            <SettingRow label="Browser Notifications" desc="Get alerts for low stock and tax deadlines">
              {notificationsEnabled ? (
                <div className="flex items-center gap-2">
                  <Bell className="w-4 h-4 text-emerald-400" />
                  <span className="text-emerald-400 text-sm">Enabled</span>
                </div>
              ) : (
                <button onClick={requestNotifications} className="px-4 py-2 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/50 rounded-lg text-sm text-violet-300 flex items-center gap-2">
                  <Bell className="w-4 h-4" />Enable Notifications
                </button>
              )}
            </SettingRow>
            <SettingRow label="Sales Tax Alert Days" desc="Days before due date to show alert">
              <NumberInput value={currentLocalSettings.alertSalesTaxDays || 7} onChange={(v) => updateSetting('alertSalesTaxDays', v)} min={1} max={30} suffix="days" />
            </SettingRow>
          </SettingSection>
            </>
          )}
          
          {/* ========== ACCOUNT TAB ========== */}
          {settingsTab === 'account' && (
            <>
          {/* Account */}
          {supabase && session && (
            <SettingSection title="ðŸ‘¤ Account">
              <SettingRow label="Logged in as" desc={session.user?.email || 'Unknown'}>
                <span className="text-emerald-400 text-sm flex items-center gap-1"><Check className="w-4 h-4" />Connected</span>
              </SettingRow>
              <SettingRow label="Sign Out" desc="Log out of your account">
                <button onClick={handleLogout} className="px-4 py-2 bg-rose-600/30 hover:bg-rose-600/50 border border-rose-500/50 rounded-lg text-sm text-rose-300 flex items-center gap-2">
                  Sign Out
                </button>
              </SettingRow>
            </SettingSection>
          )}
            </>
          )}
          
          {/* ========== DATA TAB ========== */}
          {settingsTab === 'data' && (
            <>
          {/* Security & Privacy */}
          <SettingSection title="ðŸ”’ Security & Privacy">
            <div className="space-y-4">
              <div className="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-4">
                <p className="text-emerald-400 font-semibold mb-2">âœ… Your Data is Private</p>
                <p className="text-slate-300 text-sm">Each user account has completely separate data. Other users who sign up cannot see your data, and you cannot see theirs. This is enforced at the database level using Row Level Security (RLS).</p>
              </div>
              
              <div className="bg-slate-900/50 rounded-xl p-4">
                <p className="text-white font-medium mb-2">How Data Storage Works</p>
                <ul className="text-slate-400 text-sm space-y-2">
                  <li className="flex items-start gap-2">
                    <Cloud className="w-4 h-4 mt-0.5 text-blue-400 flex-shrink-0" />
                    <span><strong className="text-white">Cloud Sync (Logged In):</strong> Data syncs to Supabase and is accessible from any device when you log in with the same account.</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <Database className="w-4 h-4 mt-0.5 text-amber-400 flex-shrink-0" />
                    <span><strong className="text-white">Local Backup:</strong> Data is also stored in your browser's localStorage as a backup in case of connectivity issues.</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <Download className="w-4 h-4 mt-0.5 text-emerald-400 flex-shrink-0" />
                    <span><strong className="text-white">Manual Backups:</strong> Downloaded to your browser's default download folder (usually ~/Downloads). You can change this in your browser settings.</span>
                  </li>
                </ul>
              </div>
              
              {session && (
                <div className="bg-slate-900/50 rounded-xl p-4">
                  <p className="text-white font-medium mb-2">Logged in as</p>
                  <p className="text-slate-400 text-sm">{session.user?.email}</p>
                </div>
              )}
            </div>
          </SettingSection>
          
          {/* Data Management */}
          <SettingSection title="ðŸ—„ï¸ Data Management">
            <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4 mb-4">
              <p className="text-amber-400 font-semibold mb-1">ðŸ’¡ Backup Before Updates</p>
              <p className="text-slate-300 text-sm">Always export a backup before pushing app updates. Your data is stored in the browser - a full backup ensures you can restore everything.</p>
            </div>
            <SettingRow label="Full Backup" desc="Downloads ALL data: weeks, periods, inventory, forecasts, invoices, settings">
              <button onClick={exportAll} className="px-4 py-2 bg-emerald-600/30 hover:bg-emerald-600/50 border border-emerald-500/50 rounded-lg text-sm text-emerald-300 flex items-center gap-2"><Download className="w-4 h-4" />Export Full Backup</button>
            </SettingRow>
            <SettingRow label="Restore from Backup" desc="Import a previously exported JSON file">
              <label className="px-4 py-2 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/50 rounded-lg text-sm text-violet-300 flex items-center gap-2 cursor-pointer"><Upload className="w-4 h-4" />Import Backup<input type="file" accept=".json" onChange={(e) => e.target.files[0] && importData(e.target.files[0])} className="hidden" /></label>
            </SettingRow>
            
            {/* Bulk Import Section */}
            <div className="mt-4 pt-4 border-t border-slate-700">
              <h4 className="text-white font-medium mb-3 flex items-center gap-2"><Upload className="w-4 h-4 text-cyan-400" />Bulk Import Tools</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <button 
                  onClick={() => setShowAdsBulkUpload(true)}
                  className="p-3 bg-violet-900/30 hover:bg-violet-900/50 border border-violet-500/30 rounded-xl text-left flex items-center gap-3"
                >
                  <TrendingUp className="w-8 h-8 text-violet-400" />
                  <div>
                    <p className="text-white font-medium">Ads Data Upload</p>
                    <p className="text-slate-400 text-xs">Import Meta & Google Ads CSV exports</p>
                  </div>
                </button>
                <button 
                  onClick={() => setShow3PLBulkUpload(true)}
                  className="p-3 bg-blue-900/30 hover:bg-blue-900/50 border border-blue-500/30 rounded-xl text-left flex items-center gap-3"
                >
                  <Truck className="w-8 h-8 text-blue-400" />
                  <div>
                    <p className="text-white font-medium">3PL Bulk Upload</p>
                    <p className="text-slate-400 text-xs">Import Packiyo Excel files</p>
                  </div>
                </button>
              </div>
            </div>
            
            <div className="mt-4 p-3 bg-slate-900/50 rounded-lg">
              <p className="text-slate-400 text-xs mb-2">Backup includes:</p>
              <div className="grid grid-cols-2 gap-1 text-xs">
                <span className="text-slate-500">â€¢ {Object.keys(allDaysData).length} days of daily data</span>
                <span className="text-slate-500">â€¢ {Object.keys(allWeeksData).length} weeks of sales data</span>
                <span className="text-slate-500">â€¢ {Object.keys(allPeriodsData).length} period reports</span>
                <span className="text-slate-500">â€¢ {Object.keys(invHistory).length} inventory snapshots</span>
                <span className="text-slate-500">â€¢ {Object.keys(savedCogs).length} COGS entries</span>
                <span className="text-slate-500">â€¢ {Object.keys(amazonForecasts).length} Amazon forecasts</span>
                <span className="text-slate-500">â€¢ {invoices.length} invoices/bills</span>
                <span className="text-slate-500">â€¢ All settings & goals</span>
              </div>
            </div>
            
            {/* Delete Individual Data */}
            <div className="mt-6 pt-6 border-t border-slate-700">
              <h4 className="text-white font-medium mb-3 flex items-center gap-2"><Trash2 className="w-4 h-4 text-rose-400" />Delete Individual Records</h4>
              <p className="text-slate-400 text-sm mb-4">Remove specific days, weeks or periods from your data.</p>
              
              {/* Daily Data */}
              {Object.keys(allDaysData).length > 0 && (() => {
                const allDays = Object.keys(allDaysData);
                const withSales = allDays.filter(d => hasDailySalesData(allDaysData[d])).length;
                const adsOnly = allDays.length - withSales;
                return (
                <div className="mb-4">
                  <p className="text-slate-300 text-sm mb-2">Daily Data ({withSales} with sales, {adsOnly} ads-only)</p>
                  <div className="flex flex-wrap gap-2">
                    {allDays.sort().reverse().slice(0, 14).map(dayKey => {
                      const hasRealData = hasDailySalesData(allDaysData[dayKey]);
                      return (
                      <div key={dayKey} className={`flex items-center gap-1 rounded-lg px-2 py-1 ${hasRealData ? 'bg-cyan-900/30 border border-cyan-500/30' : 'bg-amber-900/20 border border-amber-500/20'}`}>
                        <span className={`text-xs ${hasRealData ? 'text-cyan-300' : 'text-amber-400/70'}`}>{new Date(dayKey + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}{!hasRealData && ' (ads)'}</span>
                        <button
                          onClick={() => {
                            if (confirm(`Delete ${dayKey}? This cannot be undone.`)) {
                              const updated = { ...allDaysData };
                              delete updated[dayKey];
                              setAllDaysData(updated);
                              lsSet('ecommerce_daily_sales_v1', JSON.stringify(updated));
                              queueCloudSave({ ...combinedData, dailySales: updated });
                              setToast({ message: 'Day deleted', type: 'success' });
                            }
                          }}
                          className="text-rose-400 hover:text-rose-300 p-0.5"
                        >
                          <X className="w-3 h-3" />
                        </button>
                      </div>
                    );})}
                    {allDays.length > 14 && <span className="text-slate-500 text-xs self-center">+{allDays.length - 14} more</span>}
                  </div>
                </div>
              );})()}
              
              {/* Weekly Data */}
              {Object.keys(allWeeksData).length > 0 && (
                <div className="mb-4">
                  <p className="text-slate-300 text-sm mb-2">Weekly Data ({Object.keys(allWeeksData).length} weeks)</p>
                  <div className="flex flex-wrap gap-2">
                    {Object.keys(allWeeksData).sort().reverse().map(weekKey => (
                      <div key={weekKey} className="flex items-center gap-1 bg-slate-700/50 rounded-lg px-2 py-1">
                        <span className="text-slate-300 text-xs">{new Date(weekKey + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                        <button
                          onClick={() => {
                            if (confirm(`Delete week ${weekKey}? This cannot be undone.`)) {
                              const updated = { ...allWeeksData };
                              delete updated[weekKey];
                              setAllWeeksData(updated);
                              save(updated);
                              setToast({ message: 'Week deleted', type: 'success' });
                            }
                          }}
                          className="text-rose-400 hover:text-rose-300 p-0.5"
                        >
                          <X className="w-3 h-3" />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* Period Data */}
              {Object.keys(allPeriodsData).length > 0 && (
                <div className="mb-4">
                  <p className="text-slate-300 text-sm mb-2">Period Data ({Object.keys(allPeriodsData).length} periods)</p>
                  
                  {/* Empty periods warning and bulk delete */}
                  {(() => {
                    const emptyPeriods = Object.keys(allPeriodsData).filter(k => {
                      const p = allPeriodsData[k];
                      return (p.total?.revenue || 0) === 0 || ((p.amazon?.skuData?.length || 0) + (p.shopify?.skuData?.length || 0)) === 0;
                    });
                    if (emptyPeriods.length > 0) {
                      return (
                        <div className="bg-amber-900/20 border border-amber-500/30 rounded-lg p-3 mb-3">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-amber-400 text-sm font-medium">âš ï¸ {emptyPeriods.length} Empty Period{emptyPeriods.length > 1 ? 's' : ''} Found</p>
                              <p className="text-slate-400 text-xs">{emptyPeriods.slice(0, 5).join(', ')}{emptyPeriods.length > 5 ? '...' : ''}</p>
                            </div>
                            <button
                              onClick={() => {
                                if (confirm(`Delete ${emptyPeriods.length} empty period(s)?\n\n${emptyPeriods.join(', ')}\n\nThis cannot be undone.`)) {
                                  const updated = { ...allPeriodsData };
                                  emptyPeriods.forEach(k => delete updated[k]);
                                  setAllPeriodsData(updated);
                                  savePeriods(updated);
                                  setToast({ message: `Deleted ${emptyPeriods.length} empty periods`, type: 'success' });
                                }
                              }}
                              className="px-3 py-1.5 bg-amber-600/30 hover:bg-amber-600/50 border border-amber-500/50 rounded-lg text-amber-300 text-xs font-medium"
                            >
                              Delete All Empty
                            </button>
                          </div>
                        </div>
                      );
                    }
                    return null;
                  })()}
                  
                  <div className="flex flex-wrap gap-2">
                    {Object.keys(allPeriodsData).sort().map(periodKey => {
                      const p = allPeriodsData[periodKey];
                      const isEmpty = (p.total?.revenue || 0) === 0;
                      const skuCount = (p.amazon?.skuData?.length || 0) + (p.shopify?.skuData?.length || 0);
                      return (
                      <div key={periodKey} className={`flex items-center gap-1 rounded-lg px-2 py-1 ${isEmpty ? 'bg-rose-900/30 border border-rose-500/30' : 'bg-slate-700/50'}`}>
                        <span className={`text-xs ${isEmpty ? 'text-rose-400' : 'text-slate-300'}`}>
                          {p.label || periodKey}
                          {isEmpty && ' âš ï¸'}
                          {!isEmpty && skuCount > 0 && <span className="text-slate-500 ml-1">({skuCount})</span>}
                        </span>
                        <button
                          onClick={() => {
                            if (confirm(`Delete period "${p.label || periodKey}"? This cannot be undone.`)) {
                              const updated = { ...allPeriodsData };
                              delete updated[periodKey];
                              setAllPeriodsData(updated);
                              savePeriods(updated);
                              setToast({ message: 'Period deleted', type: 'success' });
                            }
                          }}
                          className="text-rose-400 hover:text-rose-300 p-0.5"
                        >
                          <X className="w-3 h-3" />
                        </button>
                      </div>
                    );})}
                  </div>
                </div>
              )}
              
              {/* Inventory Data */}
              {Object.keys(invHistory).length > 0 && (
                <div className="mb-4">
                  <p className="text-slate-300 text-sm mb-2">Inventory Snapshots ({Object.keys(invHistory).length})</p>
                  <div className="flex flex-wrap gap-2">
                    {Object.keys(invHistory).sort().reverse().slice(0, 10).map(invKey => (
                      <div key={invKey} className="flex items-center gap-1 bg-slate-700/50 rounded-lg px-2 py-1">
                        <span className="text-slate-300 text-xs">{invKey}</span>
                        <button
                          onClick={() => {
                            if (confirm(`Delete inventory snapshot ${invKey}? This cannot be undone.`)) {
                              const updated = { ...invHistory };
                              delete updated[invKey];
                              setInvHistory(updated);
                              saveInv(updated);
                              setToast({ message: 'Inventory snapshot deleted', type: 'success' });
                            }
                          }}
                          className="text-rose-400 hover:text-rose-300 p-0.5"
                        >
                          <X className="w-3 h-3" />
                        </button>
                      </div>
                    ))}
                    {Object.keys(invHistory).length > 10 && <span className="text-slate-500 text-xs self-center">+{Object.keys(invHistory).length - 10} more</span>}
                  </div>
                </div>
              )}
            </div>
            <SettingRow label="Reset Settings Only" desc="Restore settings to defaults (keeps all data)">
              {showResetConfirm ? (
                <div className="flex gap-2">
                  <button onClick={resetToDefaults} className="px-3 py-2 bg-rose-600 hover:bg-rose-500 rounded-lg text-sm text-white">Confirm Reset</button>
                  <button onClick={() => setShowResetConfirm(false)} className="px-3 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-sm text-white">Cancel</button>
                </div>
              ) : (
                <button onClick={() => setShowResetConfirm(true)} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white">Reset Settings</button>
              )}
            </SettingRow>
          </SettingSection>
            </>
          )}
          
          {/* ========== DANGER ZONE - ACCOUNT TAB ========== */}
          {settingsTab === 'account' && (
            <>
          {/* Danger Zone */}
          {session && (
            <SettingSection title="âš ï¸ Danger Zone">
              <div className="bg-rose-900/20 border border-rose-500/30 rounded-xl p-4">
                <p className="text-rose-400 font-semibold mb-2">Delete All My Data</p>
                <p className="text-slate-300 text-sm mb-4">This will permanently delete all your data from the cloud. This action cannot be undone. We recommend exporting a backup first.</p>
                <button 
                  onClick={async () => {
                    if (!confirm('Are you sure you want to delete ALL your data? This cannot be undone!')) return;
                    if (!confirm('FINAL WARNING: All weeks, periods, inventory, forecasts, invoices, and settings will be permanently deleted. Continue?')) return;
                    try {
                      // Delete from Supabase
                      if (supabase && session?.user?.id) {
                        await supabase.from('app_data').delete().eq('user_id', session.user.id);
                      }
                      // Clear localStorage
                      localStorage.clear();
                      // Reset all state
                      setAllWeeksData({});
                      setAllPeriodsData({});
                      setInvHistory({});
                      setSavedCogs({});
                      setInvoices([]);
                      setAmazonForecasts({});
                      setWeekNotes({});
                      setGoals({ weeklyRevenue: 0, weeklyProfit: 0, monthlyRevenue: 0, monthlyProfit: 0 });
                      setStoreName('');
                      setStoreLogo(null);
                      setToast({ message: 'All data deleted successfully', type: 'success' });
                    } catch (err) {
                      setToast({ message: 'Error deleting data: ' + err.message, type: 'error' });
                    }
                  }}
                  className="px-4 py-2 bg-rose-600/30 hover:bg-rose-600/50 border border-rose-500/50 rounded-lg text-sm text-rose-300 flex items-center gap-2"
                >
                  <Trash2 className="w-4 h-4" />Delete All My Data
                </button>
              </div>
            </SettingSection>
          )}
            </>
          )}
          
          {/* About */}
          <div className="bg-slate-800/30 rounded-2xl border border-slate-700/50 p-6 text-center">
            <p className="text-slate-400 text-sm">E-Commerce Dashboard v5.0</p>
            <p className="text-slate-500 text-xs mt-1">Built for tracking Amazon & Shopify performance</p>
            <div className="flex justify-center gap-4 mt-4 text-xs text-slate-500">
              <span>{Object.keys(allWeeksData).length} weeks tracked</span>
              <span>â€¢</span>
              <span>{Object.keys(allPeriodsData).length} periods saved</span>
              <span>â€¢</span>
              <span>{Object.keys(savedCogs).length} SKUs configured</span>
            </div>
          </div>
          
        </div>
      </div>
    );
  }

  return <div className="min-h-screen bg-slate-950 text-white p-6 flex items-center justify-center"><div className="w-12 h-12 border-4 border-violet-500 border-t-transparent rounded-full animate-spin" /></div>;
}
